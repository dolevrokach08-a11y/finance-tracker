<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¼ ×ª×™×§ ×”×”×©×§×¢×•×ª ×©×œ×™</title>
    <style>
        /* Basic Reset & RTL */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 { 
            font-size: 3rem; 
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header p { 
            font-size: 1.2rem; 
            opacity: 0.9; 
        }
        
        /* Navigation Links */
        .nav-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            transition: transform 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
        }
        
        .summary-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .summary-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .summary-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .summary-card h3 { 
            font-size: 0.9rem; 
            opacity: 0.9; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .value { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 5px;
        }
        .summary-card .sub { 
            font-size: 0.85rem; 
            opacity: 0.8; 
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102,126,234,0.4); 
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(16,185,129,0.4); 
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        /* Holdings */
        .holdings-grid {
            display: grid;
            gap: 15px;
        }
        
        .holding-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .holding-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.1);
            transform: translateY(-2px);
        }
        
        .holding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .holding-header h4 {
            font-size: 1.2rem;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .holding-actions {
            display: flex;
            gap: 10px;
        }
        
        .holding-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 3px;
        }
        
        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }
        
        .detail-value.positive { color: #10b981; }
        .detail-value.negative { color: #ef4444; }
        
        /* Groups */
        .groups-list {
            display: grid;
            gap: 20px;
        }
        
        .group-card {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .group-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .group-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }
        
        .group-target {
            font-size: 0.9rem;
            color: #6b7280;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Progress Bars */
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 28px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.ok {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.under {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.over {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Investment Calculator */
        .calculator-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .calculator-header h3 {
            font-size: 1.5rem;
            color: #92400e;
        }
        
        .calc-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .calc-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }
        
        .calc-results.show {
            display: block;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calc-item:last-child {
            border-bottom: none;
        }
        
        .calc-symbol {
            font-weight: 600;
            color: #111827;
        }
        
        .calc-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999;
            font-weight: 600;
        }
        
        .notification.show { opacity: 1; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .summary-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .calc-input-group { flex-direction: column; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px;">
        <div style="font-size: 4em;">ğŸ’¼</div>
        <div style="color: white; font-size: 1.5em; font-weight: 600;">×˜×•×¢×Ÿ ×ª×™×§ ×”×©×§×¢×•×ª...</div>
        <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <div id="mainContent" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>ğŸ’¼ ×ª×™×§ ×”×”×©×§×¢×•×ª ×©×œ×™</h1>
            <p>××¢×§×‘ ×—×›× ××—×¨ ×”×ª×™×§ ×•××¢×¨×›×ª ×”××œ×¦×•×ª ××•×˜×•××˜×™×ª</p>
        </div>

        <!-- Navigation Links -->
        <div class="nav-links">
            <a href="××¢×§×‘_×›×¡×¤×™_FINAL.html" class="nav-link">ğŸ’° ×œ××¢×§×‘ ×›×¡×¤×™</a>
            <a href="#" class="nav-link">ğŸ“Š ×ª×™×§ ×”×©×§×¢×•×ª</a>
        </div>

        <div class="glass">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview', event)">ğŸ“Š ×¡×§×™×¨×”</button>
                <button class="tab-btn" onclick="showTab('calculator', event)">ğŸ§® ××—×©×‘×•×Ÿ ×”×©×§×¢×”</button>
                <button class="tab-btn" onclick="showTab('holdings', event)">ğŸ“ˆ ×× ×™×•×ª</button>
                <button class="tab-btn" onclick="showTab('bonds', event)">ğŸ’¼ ××’"×—</button>
                <button class="tab-btn" onclick="showTab('groups', event)">ğŸ¯ ×§×‘×•×¦×•×ª</button>
                <button class="tab-btn" onclick="showTab('history', event)">ğŸ“œ ×”×™×¡×˜×•×¨×™×”</button>
                <button class="tab-btn" onclick="showTab('capital', event)">ğŸ’° ×”×•×Ÿ ××§×•×¨×™</button>
                <button class="tab-btn" onclick="showTab('recommendations', event)">ğŸ’¡ ×”××œ×¦×•×ª</button>
                <button class="tab-btn" onclick="showTab('settings', event)">âš™ï¸ ×”×’×“×¨×•×ª</button>
            </div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <!-- Stocks Section -->
                <div class="glass" style="margin-bottom: 20px; background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #0ea5e9;">
                    <h3 style="margin-bottom: 15px; color: #0c4a6e;">ğŸ“ˆ ×× ×™×•×ª</h3>
                    <div class="summary-grid">
                        <div class="summary-card" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×©×•×•×™ × ×•×›×—×™</h3>
                            <div class="value" id="stocks-value">â‚ª0</div>
                            <div class="sub" id="stocks-value-original">$0 + â‚¬0</div>
                        </div>
                        
                        <div class="summary-card green" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×ª×©×•××” (×¨×•×•×— ×›×•×œ×œ)</h3>
                            <div class="value" id="stocks-return">+0%</div>
                            <div class="sub" id="stocks-return-amount">â‚ª0</div>
                        </div>
                        
                        <div class="summary-card" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×”×•×Ÿ ××§×•×¨×™</h3>
                            <div class="value" id="stocks-capital">â‚ª0</div>
                            <div class="sub">×”×•×©×§×¢ ×‘×× ×™×•×ª</div>
                        </div>
                    </div>
                </div>

                <!-- Bonds Section -->
                <div class="glass" style="margin-bottom: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
                    <h3 style="margin-bottom: 15px; color: #78350f;">ğŸ’¼ ××’"×—</h3>
                    <div class="summary-grid">
                        <div class="summary-card" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×©×•×•×™ × ×•×›×—×™</h3>
                            <div class="value" id="bonds-value">â‚ª0</div>
                            <div class="sub" id="bonds-count">0 ×§×¨× ×•×ª</div>
                        </div>
                        
                        <div class="summary-card green" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×ª×©×•××”</h3>
                            <div class="value" id="bonds-return">+0%</div>
                            <div class="sub" id="bonds-return-amount">â‚ª0</div>
                        </div>
                        
                        <div class="summary-card" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×¢×œ×•×ª ×§× ×™×™×”</h3>
                            <div class="value" id="bonds-cost">â‚ª0</div>
                            <div class="sub">×”×•×©×§×¢ ×‘××’"×—</div>
                        </div>
                    </div>
                </div>

                <!-- Total Portfolio Section -->
                <div class="glass" style="margin-bottom: 20px; background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border: 2px solid #8b5cf6;">
                    <h3 style="margin-bottom: 15px; color: #4c1d95;">ğŸ’° ×¡×”"×› ×ª×™×§ ×”×©×§×¢×•×ª</h3>
                    <div class="summary-grid">
                        <div class="summary-card" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×©×•×•×™ ×›×•×œ×œ</h3>
                            <div class="value" id="total-value">â‚ª0</div>
                            <div class="sub">×× ×™×•×ª + ××’"×—</div>
                        </div>
                        
                        <div class="summary-card green" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×ª×©×•××” ×›×•×œ×œ×ª</h3>
                            <div class="value" id="total-return">+0%</div>
                            <div class="sub" id="total-return-amount">â‚ª0</div>
                        </div>
                        
                        <div class="summary-card blue" style="background: white; color: #1f2937;">
                            <h3 style="color: #6b7280;">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</h3>
                            <div class="value" id="last-update-time">--:--</div>
                            <div class="sub" id="last-update-date">--/--/----</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">×”×ª×¤×œ×’×•×ª ×”×ª×™×§ (×™×¢×“ vs ×‘×¤×•×¢×œ)</h3>
                <div id="allocation-comparison"></div>

                <div class="chart-container">
                    <canvas id="portfolio-chart"></canvas>
                </div>

                <button onclick="refreshPrices()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    ğŸ”„ ×¨×¢× ×Ÿ ××—×™×¨×™ ×× ×™×•×ª
                </button>
                
                <button onclick="fixGroupIds()" class="btn btn-warning" style="width: 100%; margin-top: 10px;">
                    ğŸ”§ ×ª×§×Ÿ ×§×‘×•×¦×•×ª (×‘××™×“×” ×•××•×¦×’ "×œ× ×™×“×•×¢")
                </button>
            </div>

            <!-- Calculator Tab -->
            <div id="tab-calculator" class="tab-content">
                <div class="calculator-card">
                    <div class="calculator-header">
                        <span style="font-size: 2rem;">ğŸ§®</span>
                        <h3>××—×©×‘×•×Ÿ ×—×œ×•×§×ª ×”×©×§×¢×”</h3>
                    </div>
                    
                    <p style="color: #92400e; margin-bottom: 20px;">
                        ×”×–×Ÿ ×¡×›×•× ×©××ª×” ×¨×•×¦×” ×œ×”×©×§×™×¢ ×•×”××¢×¨×›×ª ×ª×—×©×‘ ×œ×š ××™×š ×œ×—×œ×§ ××•×ª×• ×‘×™×Ÿ ×”×× ×™×•×ª ×¢×œ ×¤×™ ×”×¤×¢×¨×™× ××”×™×¢×“
                    </p>

                    <div class="calc-input-group">
                        <div class="form-group" style="flex: 1;">
                            <label>×¡×›×•× ×œ×”×©×§×¢×” (â‚ª)</label>
                            <input type="number" id="invest-amount" placeholder="10000" step="100">
                        </div>
                        <button onclick="calculateInvestment()" class="btn btn-success">
                            âœ¨ ×—×©×‘ ×—×œ×•×§×”
                        </button>
                    </div>

                    <div id="calc-results" class="calc-results">
                        <h4 style="margin-bottom: 15px; color: #111827;">ğŸ’¡ ×”××œ×¦×ª ×—×œ×•×§×”:</h4>
                        <div id="calc-items"></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>×¡×”"×›:</span>
                                <span id="calc-total" style="color: #667eea; font-size: 1.2rem;">â‚ª0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">â„¹ï¸ ××™×š ×–×” ×¢×•×‘×“?</h4>
                    <ul style="color: #1e3a8a; line-height: 1.8;">
                        <li>×”××¢×¨×›×ª ××—×©×‘×ª ××ª ×”×¤×¢×¨ ×©×œ ×›×œ ×§×‘×•×¦×” ××”×™×¢×“ ×©×œ×”</li>
                        <li>×”×§×‘×•×¦×•×ª ×¢× ×”×¤×¢×¨ ×”×’×“×•×œ ×‘×™×•×ª×¨ ××§×‘×œ×•×ª ×™×•×ª×¨ ×›×¡×£</li>
                        <li>×‘×ª×•×š ×›×œ ×§×‘×•×¦×”, ×”×”×©×§×¢×” ××ª×—×œ×§×ª ×‘××•×¤×Ÿ ×©×•×•×” ×‘×™×Ÿ ×”×× ×™×•×ª</li>
                        <li>×–×” ×¢×•×–×¨ ×œ×š ×œ×©××•×¨ ×¢×œ ×”×ª××”×™×œ ×”×¨×¦×•×™ ×œ××•×¨×š ×–××Ÿ</li>
                    </ul>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div id="tab-holdings" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddHoldingForm()" class="btn btn-success">â• ×”×•×¡×£ ×”×—×–×§×”</button>
                    <button onclick="refreshPrices()" class="btn btn-primary">ğŸ”„ ×¨×¢× ×Ÿ ××—×™×¨×™×</button>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.5rem;">ğŸ‡®ğŸ‡±</span>
                        <div>
                            <strong style="color: #1e40af;">× ×™×™×¨×•×ª ×¢×¨×š ×™×©×¨××œ×™×™×:</strong>
                            <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 0.9rem;">
                                ×œ××¡×¤×¨×™ × ×™×™×¨×•×ª ×¢×¨×š ×™×©×¨××œ×™×™× (7 ×¡×¤×¨×•×ª, ×œ×“×•×’××: 1209220), <strong>×”×–×Ÿ ××ª ×”××¡×¤×¨</strong>. ×”××¢×¨×›×ª ×ª× ×¡×” ×œ×©××•×‘ ××—×™×¨×™× ××”×‘×•×¨×¡×”.
                            </p>
                            <div style="margin: 8px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <p style="margin: 0; color: #92400e; font-size: 0.85rem;">
                                    âš ï¸ <strong>×—×©×•×‘:</strong> ×©××™×‘×ª ××—×™×¨×™× ××•×˜×•××˜×™×ª ××”×‘×•×¨×¡×” ×”×™×©×¨××œ×™×ª ×œ× ×ª××™×“ ×¢×•×‘×“×ª (×‘×’×œ×œ ××’×‘×œ×•×ª ×˜×›× ×™×•×ª).
                                </p>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.85rem;">
                                ğŸ’¡ <strong>×”××œ×¦×”:</strong> 
                            </p>
                            <ol style="margin: 5px 0 0 20px; color: #1e3a8a; font-size: 0.85rem; line-height: 1.6;">
                                <li>×”×’×“×¨ <strong>"×˜×™×§×¨ ×—×œ×•×¤×™"</strong> (×× ×™×© - ×œ×“×•×’××: VWRL.L ×œ×ª×¢×•×“×ª ×¡×œ)</li>
                                <li>××• ×”×©×ª××© ×‘×›×¤×ª×•×¨ <strong>"ğŸ’° ××—×™×¨"</strong> ×œ×¢×“×›×Ÿ ×™×“× ×™×ª</li>
                                <li>×¢×“×›×Ÿ ××—×™×¨×™× ×™×“× ×™×ª ×<a href="https://www.tase.co.il" target="_blank" style="color: #667eea;">××ª×¨ ×”×‘×•×¨×¡×”</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="add-holding-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                    <h3 style="margin-bottom: 20px;">×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×¡×™××•×œ / ××¡' × ×™×™×¨ ×¢×¨×š (×œ××©×œ: AAPL, 1209220)</label>
                            <input type="text" id="new-symbol" placeholder="AAPL">
                            <small style="color: #6b7280; font-size: 0.8rem;">× ×™×™×¨×•×ª ×™×©×¨××œ×™×™×: ×”×–×Ÿ ××¡×¤×¨ × ×™×™×¨ ×¢×¨×š ×‘×Ÿ 7 ×¡×¤×¨×•×ª</small>
                        </div>
                        <div class="form-group">
                            <label>×˜×™×§×¨ ×—×œ×•×¤×™ (×’×™×‘×•×™ - ××•×¤×¦×™×•× ×œ×™)</label>
                            <input type="text" id="new-alt-ticker" placeholder="VWRL.L">
                            <small style="color: #6b7280; font-size: 0.8rem;">×’×™×‘×•×™ ×× ×”×©××™×‘×” ××”×‘×•×¨×¡×” ×”×™×©×¨××œ×™×ª ×œ× ×¢×•×‘×“×ª</small>
                        </div>
                        <div class="form-group">
                            <label>××¡×¤×¨ ×× ×™×•×ª</label>
                            <input type="number" id="new-shares" placeholder="10" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>××—×™×¨ ×§× ×™×™×” ×××•×¦×¢</label>
                            <input type="number" id="new-cost" placeholder="150.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>××˜×‘×¢</label>
                            <select id="new-currency">
                                <option value="ILS">â‚ª ×©×§×œ</option>
                                <option value="USD">$ ×“×•×œ×¨</option>
                                <option value="EUR">â‚¬ ×™×•×¨×•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>×§×‘×•×¦×”</label>
                            <select id="new-group"></select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addHolding()" class="btn btn-success">âœ… ×©××•×¨</button>
                        <button onclick="hideAddHoldingForm()" class="btn" style="background: #6b7280; color: white;">âŒ ×‘×™×˜×•×œ</button>
                    </div>
                </div>

                <div id="holdings-list" class="holdings-grid"></div>
            </div>

            <!-- Bonds Tab -->
            <div id="tab-bonds" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’¼ ×§×¨× ×•×ª ××’"×—</h3>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="showAddBondForm()" class="btn btn-success">â• ×”×•×¡×£ ×§×¨×Ÿ ××’"×—</button>
                </div>

                <!-- Add Bond Form -->
                <div id="add-bond-form" style="display: none; margin-bottom: 30px;" class="glass">
                    <h4 style="margin-bottom: 15px;">×”×•×¡×£/×¢×¨×•×š ×§×¨×Ÿ ××’"×—</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×©× ×”×§×¨×Ÿ</label>
                            <input type="text" id="bond-name" placeholder="××™×˜×‘ ×“×© ××’"×— ×§×•× ×¦×¨× ×™">
                        </div>
                        <div class="form-group">
                            <label>×›××•×ª ×™×—×™×“×•×ª</label>
                            <input type="number" id="bond-units" step="0.01" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label>××—×™×¨ ×§× ×™×™×” ×œ×™×—×™×“×” (â‚ª)</label>
                            <input type="number" id="bond-cost" step="0.01" placeholder="100.00">
                        </div>
                        <div class="form-group">
                            <label>××—×™×¨ × ×•×›×—×™ ×œ×™×—×™×“×” (â‚ª)</label>
                            <input type="number" id="bond-price" step="0.01" placeholder="103.50">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="saveBond()" class="btn btn-success">ğŸ’¾ ×©××•×¨</button>
                        <button onclick="hideAddBondForm()" class="btn" style="background: #6b7280;">×‘×™×˜×•×œ</button>
                    </div>
                </div>

                <!-- Bonds List -->
                <div id="bonds-list"></div>
            </div>

            <!-- Groups Tab -->
            <div id="tab-groups" class="tab-content">
                <h3 style="margin-bottom: 20px;">×§×‘×•×¦×•×ª ×”×”×©×§×¢×” ×©×œ×š</h3>
                <div id="groups-list" class="groups-list"></div>
            </div>

            <!-- Recommendations Tab -->
            <div id="tab-recommendations" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’¡ ×”××œ×¦×•×ª ×œ××™×–×•×Ÿ ×ª×™×§</h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ××›×™×¨×•×ª</h3>
                
                <div class="glass">
                    <h4 style="margin-bottom: 15px;">××›×™×¨×•×ª ×©×‘×•×¦×¢×•</h4>
                    <div id="sales-history-list"></div>
                </div>
            </div>

            <!-- Capital Tab -->
            <div id="tab-capital" class="tab-content">
                <h3 style="margin-bottom: 20px;">ğŸ’° ××¢×§×‘ ×”×•×Ÿ ××§×•×¨×™</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">×ª× ×•×¢×•×ª ×”×•×Ÿ</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        ×¨×©×•× ×›××Ÿ ×›×œ ×”×›× ×¡×ª ×›×¡×£ ×—×“×©×” ×œ×ª×™×§ ××• ××©×™×›×ª ×›×¡×£ ××”×ª×™×§
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="addCapitalMovement()" class="btn btn-success">â• ×”×•×¡×£ ×ª× ×•×¢×ª ×”×•×Ÿ</button>
                        <button onclick="showCalculateCapitalFromHoldings()" class="btn btn-primary">ğŸ§® ×—×©×‘ ××”×—×–×§×•×ª</button>
                    </div>
                    <div id="capital-movements-list" style="margin-top: 20px;"></div>
                </div>
                
                <div class="glass">
                    <h4 style="margin-bottom: 15px;">ğŸ“Š ×¡×™×›×•×</h4>
                    <div id="capital-summary"></div>
                </div>
            </div>

            <!-- Calculate Capital Modal -->
            <div id="calculate-capital-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">ğŸ§® ×—×©×‘ ×”×•×Ÿ ××§×•×¨×™ ××”×—×–×§×•×ª</h3>
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 0.9rem;">
                        ×‘×—×¨ ××ª ×”×—×–×§×•×ª ×©×ª×¨×¦×” ×œ×›×œ×•×œ ×‘×—×™×©×•×‘ ×”×”×•×Ÿ ×”××§×•×¨×™
                    </p>
                    
                    <div id="holdings-checkboxes" style="margin-bottom: 20px;"></div>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                        <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 5px;">×¡×”"×› ×”×•×Ÿ ××§×•×¨×™ × ×‘×—×¨:</div>
                        <div id="selected-capital-total" style="font-size: 1.8rem; font-weight: bold; color: #1e40af;">â‚ª0</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="hideCalculateCapitalModal()" class="btn" style="background: #6b7280;">×‘×™×˜×•×œ</button>
                        <button onclick="addCalculatedCapital()" class="btn btn-success">×”×•×¡×£ ×›×”×¤×§×“×”</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">âš™ï¸ ×”×’×“×¨×•×ª</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">ğŸ’± ×©×¢×¨×™ ×”××¨×”</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        ğŸ“ <strong>×¢×¨×•×š ××ª ×”×©×¢×¨×™× ×™×“× ×™×ª</strong> ××• × ×¡×” ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>×“×•×œ×¨ ($) ×œ×©×§×œ</label>
                            <input type="number" id="rate-usd" step="0.0001" value="3.7500" 
                                   placeholder="3.7500" 
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                        <div class="form-group">
                            <label>×™×•×¨×• (â‚¬) ×œ×©×§×œ</label>
                            <input type="number" id="rate-eur" step="0.0001" value="4.0500" 
                                   placeholder="4.0500"
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="tryAutoUpdateRates()" class="btn btn-primary">
                            ğŸ”„ ×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª
                        </button>
                        <button onclick="updateExchangeRates()" class="btn btn-success">
                            ğŸ’¾ ×©××•×¨ ×©×¢×¨×™×
                        </button>
                    </div>
                    <p style="color: #6b7280; margin-top: 10px; font-size: 0.8rem;">
                        ğŸ’¡ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×× ×¡×” ×œ××©×•×š ×©×¢×¨×™× ××”××™× ×˜×¨× ×˜. ×× ×–×” ×œ× ×¢×•×‘×“, ×¢×¨×•×š ×™×“× ×™×ª ×-<a href="https://www.boi.org.il/he/markets/exchangerates/" target="_blank" style="color: #667eea;">×‘× ×§ ×™×©×¨××œ</a>
                    </p>
                </div>

                <div class="glass">
                    <h4 style="margin-bottom: 15px;">ğŸ’¾ ×’×™×‘×•×™ ×•×©×—×–×•×¨</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportData()" class="btn btn-primary">ğŸ“¤ ×™×™×¦×•× × ×ª×•× ×™×</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End mainContent -->

    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Import
        import { auth, db, onAuthStateChanged, doc, setDoc, getDoc } from './firebase-config.js';

        // Check authentication
        let currentUser = null;
        let authChecked = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                if (!authChecked) {
                    authChecked = true;
                    init();
                }
            } else {
                console.log('No user, redirecting to login...');
                window.location.href = 'login.html';
            }
        });

        // ===========================================
        // DATA STRUCTURE - ENHANCED
        // ===========================================
        
        let editingHoldingId = null; // Track which holding is being edited
        
        let portfolio = {
            holdings: [
                {
                    id: 1760608097331,
                    symbol: "USSC.L",
                    shares: 154,
                    costBasis: 61.55,
                    currentPrice: 73.92,
                    currency: "USD",
                    groupId: 1,
                    altTicker: "",
                    lastUpdate: "2025-10-18T19:33:43.765Z",
                    purchases: [] // NEW: history of purchases
                },
                {
                    id: 1760646969798,
                    symbol: "1209220",
                    shares: 1868,
                    costBasis: 24.4045,
                    currentPrice: 119.56,
                    currency: "ILS",
                    groupId: 1,
                    altTicker: "VWRL.L",
                    lastUpdate: "2025-10-18T19:33:46.020Z",
                    purchases: []
                },
                {
                    id: 1760815197550,
                    symbol: "AVGS.L",
                    shares: 215,
                    costBasis: 22.146,
                    currentPrice: 22.345,
                    currency: "USD",
                    groupId: 1,
                    altTicker: "",
                    lastUpdate: "2025-10-18T19:33:46.239Z",
                    purchases: []
                }
            ],
            groups: [
                { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
            ],
            rates: { USD: 3.3062, EUR: 3.8619, GBP: 1.27 },
            // UPDATED: Bonds as array of funds
            bonds: [
                {
                    id: 1,
                    name: '××™×˜×‘ ×“×© ××’"×— ×§×•× ×¦×¨× ×™',
                    units: 500,
                    costBasis: 100,
                    currentPrice: 103.5,
                    lastUpdate: new Date().toISOString()
                }
            ],
            // NEW: Capital tracking - × ×ª×•× ×™ ×“×•×’××”
            capitalMovements: [
                {
                    id: 1,
                    date: new Date('2024-01-01').toISOString(),
                    amount: 50000,
                    type: 'deposit',
                    note: '×”×©×§×¢×” ×¨××©×•× ×™×ª'
                }
            ],
            // NEW: Sales history
            sales: [] // { id, date, symbol, shares, salePrice, costBasis, profit, currency }
        };

        let charts = {};

        // ===========================================
        // EXCHANGE RATES - AUTO UPDATE
        // ===========================================
        
        async function updateExchangeRates() {
            // ×¢×“×›×•×Ÿ ××”×©×“×•×ª ×‘×××©×§ (×¢×“×›×•×Ÿ ×™×“× ×™)
            const usdInput = document.getElementById('rate-usd');
            const eurInput = document.getElementById('rate-eur');
            
            const usdValue = parseFloat(usdInput.value);
            const eurValue = parseFloat(eurInput.value);
            
            if (!isNaN(usdValue) && usdValue > 0) {
                portfolio.rates.USD = usdValue;
            }
            if (!isNaN(eurValue) && eurValue > 0) {
                portfolio.rates.EUR = eurValue;
            }
            
            saveData();
            updateOverview();
            notify(`âœ… ×©×¢×¨×™× × ×©××¨×•! $1 = â‚ª${portfolio.rates.USD.toFixed(2)} | â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(2)}`);
        }
        
        async function tryAutoUpdateRates() {
            const notif = document.getElementById('notification');
            notif.textContent = 'ğŸ”„ ××•×©×š ×©×¢×¨×™× ××”××™× ×˜×¨× ×˜...';
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”„ Starting automatic exchange rate update...');
            console.log('Current rates before update:', { 
                USD: portfolio.rates.USD, 
                EUR: portfolio.rates.EUR 
            });
            
            try {
                const success = await autoUpdateExchangeRates();
                
                // Always hide the loading message
                notif.classList.remove('show');
                
                if (success) {
                    console.log('New rates after update:', { 
                        USD: portfolio.rates.USD, 
                        EUR: portfolio.rates.EUR 
                    });
                    console.log('âœ… Exchange rates updated successfully!');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    
                    updateOverview();
                    notify(`âœ… ×©×¢×¨×™× ×¢×•×“×›× ×•!\nğŸ’µ $1 = â‚ª${portfolio.rates.USD.toFixed(4)}\nğŸ’¶ â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                } else {
                    console.log('âŒ All API methods failed');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    notify('âš ï¸ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ × ×›×©×œ. ×¢×¨×•×š ×™×“× ×™×ª ××• × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error during exchange rate update:', error);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                notif.classList.remove('show');
                notify('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©×¢×¨×™×. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨', 'error');
            }
        }
        
        async function autoUpdateExchangeRates() {
            // × ×™×¡×™×•×Ÿ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×¢× ××¡×¤×¨ APIs (××•×¤×¦×™×•× ×œ×™ - ×œ× ×›×©×œ×•×Ÿ ×× × ×›×©×œ)
            console.log('ğŸ”„ Trying to auto-update exchange rates...');
            
            // × ×™×¡×™×•×Ÿ 1: Frankfurter API
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS,EUR');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š Frankfurter API response:', data);
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: 1 USD = X ILS and 1 USD = Y EUR
                        // We need: USD to ILS and EUR to ILS
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`ğŸ’µ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // If 1 USD = 3.75 ILS and 1 USD = 0.92 EUR
                        // Then 1 EUR = (1/0.92) USD = 1.087 USD
                        // So 1 EUR = 1.087 Ã— 3.75 = 4.08 ILS
                        // Formula: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`ğŸ’¶ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('âœ… Exchange rates updated via Frankfurter API');
                        console.log(`   Final rates: $1 = â‚ª${portfolio.rates.USD.toFixed(4)}, â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('âš ï¸ Frankfurter API failed:', error.message);
            }
            
            // × ×™×¡×™×•×Ÿ 2: ExchangeRate-API
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š ExchangeRate-API response (first 5 rates):', {
                        ILS: data.rates?.ILS,
                        EUR: data.rates?.EUR,
                        GBP: data.rates?.GBP,
                        JPY: data.rates?.JPY,
                        CNY: data.rates?.CNY
                    });
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: all rates relative to 1 USD
                        // 1 USD = X ILS, 1 USD = Y EUR
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`ğŸ’µ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // Same logic as above: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`ğŸ’¶ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('âœ… Exchange rates updated via ExchangeRate-API');
                        console.log(`   Final rates: $1 = â‚ª${portfolio.rates.USD.toFixed(4)}, â‚¬1 = â‚ª${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('âš ï¸ ExchangeRate-API failed:', error.message);
            }
            
            // × ×™×¡×™×•×Ÿ 3: ×”×•×¡×£ Bank of Israel API ×× ××¤×©×¨×™
            try {
                // Note: BOI API usually requires CORS proxy or backend
                // This is a fallback attempt
                const response = await fetch('https://www.boi.org.il/currency.xml');
                if (response.ok) {
                    const text = await response.text();
                    console.log('ğŸ“Š BOI XML received, parsing...');
                    // Parse XML for USD and EUR rates
                    // This is complex and might not work due to CORS
                }
            } catch (error) {
                console.log('âš ï¸ BOI API not accessible (CORS or network issue)');
            }
            
            console.log('â„¹ï¸ All auto-update methods failed - using manual rates');
            console.log('ğŸ’¡ You can update manually from: https://www.boi.org.il/he/markets/exchangerates/');
            return false;
        }

        // ===========================================
        // ISRAELI TASE (BORSE) API
        // ===========================================
        
        async function fetchTASEPrice(securityNumber) {
            console.log(`ğŸ‡®ğŸ‡± Israeli security detected: ${securityNumber}`);
            console.log(`âš ï¸ Due to CORS restrictions, automatic price fetching for Israeli securities is not possible from browser`);
            console.log(`ğŸ’¡ Please use the "ğŸ’° ××—×™×¨" button to update price manually`);
            
            // We can't fetch Israeli securities automatically due to CORS
            // All proxy services are blocked or unreliable
            // The only reliable way is manual update
            
            throw new Error(`ğŸ‡®ğŸ‡± × ×™×™×¨×•×ª ×¢×¨×š ×™×©×¨××œ×™×™× ×“×•×¨×©×™× ×¢×“×›×•×Ÿ ×™×“× ×™. ×œ×—×¥ ×¢×œ "ğŸ’° ××—×™×¨" ×œ×™×“ ×”×× ×™×”.`);
        }
        
        function isIsraeliSecurity(symbol) {
            // Israeli security numbers are 7 digits
            return /^\d{7}$/.test(symbol);
        }

        // ===========================================
        // ENHANCED API - WITH MULTIPLE FALLBACKS
        // ===========================================
        
        async function fetchStockPrice(symbol) {
            console.log(`ğŸ” Fetching price for: ${symbol}`);
            
            // First, check if this is an Israeli security
            if (isIsraeliSecurity(symbol)) {
                console.log('ğŸ‡®ğŸ‡± Detected Israeli security number, trying TASE first...');
                try {
                    const price = await fetchTASEPrice(symbol);
                    return price;
                } catch (e) {
                    console.log('âš ï¸ TASE fetch failed, will try alternatives if available');
                }
            }
            
            // × ×™×¡×•×™ 3 ×©×™×˜×•×ª ×©×•× ×•×ª
            const methods = [
                () => fetchYahooChart(symbol),
                () => fetchYahooQuote(symbol),
                () => fetchYahooV10(symbol)
            ];
            
            // × ×™×¡×™×•×Ÿ ×¢× ×”×¡×™××•×œ ×”××§×•×¨×™
            for (const method of methods) {
                try {
                    const price = await method();
                    if (price && price > 0) {
                        console.log(`âœ… Success: ${price}`);
                        return price;
                    }
                } catch (e) {
                    console.log(`âŒ Method failed: ${e.message}`);
                }
            }
            
            // × ×™×¡×™×•×Ÿ ×¢× ×¡×™××•×œ×™× ×—×œ×•×¤×™×™×
            const alternatives = getAlternativeSymbols(symbol);
            for (const alt of alternatives) {
                console.log(`ğŸ”„ Trying alternative: ${alt}`);
                for (const method of methods) {
                    try {
                        const price = await method.call(null, alt);
                        if (price && price > 0) {
                            console.log(`âœ… Success with alternative: ${price}`);
                            return price;
                        }
                    } catch (e) {
                        // ×©×§×˜, ×××©×™×›×™× ×”×œ××”
                    }
                }
            }
            
            throw new Error(`Could not fetch price for ${symbol}`);
        }
        
        async function fetchYahooChart(symbol) {
            // Using CORS proxy to bypass CORS restrictions
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooQuote(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteResponse?.result?.[0]?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooV10(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteSummary?.result?.[0]?.price?.regularMarketPrice?.raw;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        function getAlternativeSymbols(symbol) {
            const alternatives = [];
            if (symbol.endsWith('.L')) {
                alternatives.push(symbol.replace('.L', '.AS'));
            }
            if (symbol.endsWith('.AS')) {
                alternatives.push(symbol.replace('.AS', '.L'));
            }
            if (symbol.endsWith('.DE')) {
                alternatives.push(symbol.replace('.DE', '.AS'));
            }
            if (symbol.includes('.')) {
                alternatives.push(symbol.split('.')[0]);
            }
            return alternatives;
        }
        
        // ===========================================
        // FIX EXISTING DATA
        // ===========================================
        
        function fixGroupIds() {
            console.log('ğŸ”§ Starting to fix groupIds...');
            console.log('ğŸ“Š Holdings before fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            let fixedCount = 0;
            
            portfolio.holdings.forEach(holding => {
                const originalGroupId = holding.groupId;
                
                // If groupId is missing, undefined, null, or NaN
                if (!holding.groupId || isNaN(parseInt(holding.groupId))) {
                    console.log(`âš ï¸ ${holding.symbol}: Invalid groupId (${holding.groupId}), setting to 1`);
                    holding.groupId = 1;
                    fixedCount++;
                } else {
                    // Parse to ensure it's a number
                    const parsed = parseInt(holding.groupId);
                    if (parsed !== holding.groupId) {
                        console.log(`ğŸ”§ ${holding.symbol}: Converting groupId from ${holding.groupId} (${typeof holding.groupId}) to ${parsed}`);
                        holding.groupId = parsed;
                        fixedCount++;
                    }
                }
            });
            
            console.log('ğŸ“Š Holdings after fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            // Save the fixed data
            saveData();
            
            // Update displays
            updateOverview();
            renderHoldingsList();
            renderGroupsList();
            
            if (fixedCount > 0) {
                notify(`âœ… ×ª×•×§× ×• ${fixedCount} ×× ×™×•×ª. ×¨×¢× ×Ÿ ××ª ×”×“×£ ×× ×¢×“×™×™×Ÿ ×™×© ×‘×¢×™×•×ª.`);
            } else {
                notify(`â„¹ï¸ ×›×œ ×”×× ×™×•×ª ×›×‘×¨ ×ª×§×™× ×•×ª`);
            }
            
            console.log(`âœ… Fixed ${fixedCount} holdings`);
        }
        
        // ===========================================
        // REFRESH PRICES
        // ===========================================
        
        async function refreshPrices() {
            const notif = document.getElementById('notification');
            notif.textContent = 'ğŸ”„ ××¨×¢× ×Ÿ ××—×™×¨×™×... 0/' + portfolio.holdings.length;
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const manualUpdateNeeded = [];
            
            for (let i = 0; i < portfolio.holdings.length; i++) {
                const holding = portfolio.holdings[i];
                
                // Update progress
                notif.textContent = `ğŸ”„ ××¨×¢× ×Ÿ ××—×™×¨×™×... ${i + 1}/${portfolio.holdings.length} (${holding.symbol})`;
                
                try {
                    let price = null;
                    
                    // Strategy: Try Israeli TASE first if applicable, then altTicker, then main symbol
                    if (isIsraeliSecurity(holding.symbol)) {
                        // Try TASE for Israeli securities
                        try {
                            price = await fetchStockPrice(holding.symbol);
                            console.log(`âœ… ${holding.symbol}: â‚ª${price} (from TASE)`);
                        } catch (e) {
                            console.log(`âš ï¸ TASE failed for ${holding.symbol}: ${e.message}`);
                            // If TASE fails and there's an alternative ticker, try it
                            if (holding.altTicker) {
                                try {
                                    price = await fetchStockPrice(holding.altTicker);
                                    console.log(`âœ… ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${holding.altTicker})`);
                                } catch (e2) {
                                    console.log(`âš ï¸ Alt ticker also failed for ${holding.symbol}`);
                                    manualUpdateNeeded.push(holding.symbol);
                                    throw new Error('×¢×“×›×Ÿ ×™×“× ×™×ª');
                                }
                            } else {
                                manualUpdateNeeded.push(holding.symbol);
                                throw e; // Re-throw if no alternative
                            }
                        }
                    } else {
                        // For non-Israeli securities, use altTicker if available, otherwise main symbol
                        const tickerToUse = holding.altTicker || holding.symbol;
                        price = await fetchStockPrice(tickerToUse);
                        console.log(`âœ… ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${tickerToUse})`);
                    }
                    
                    holding.currentPrice = price;
                    holding.lastUpdate = new Date().toISOString();
                    successCount++;
                } catch (error) {
                    console.error(`âŒ Failed: ${holding.symbol}${holding.altTicker ? ` (alt: ${holding.altTicker})` : ''}`, error);
                    errorCount++;
                    errors.push(holding.symbol);
                }
                
                // ×”××ª× ×” ×§×¦×¨×” ×‘×™×Ÿ ×‘×§×©×•×ª
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            updateOverview();
            renderHoldingsList();
            
            // Hide loading notification
            notif.classList.remove('show');
            
            // Show final result
            if (errorCount === 0) {
                notify(`âœ… ${successCount} ××—×™×¨×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!`);
            } else if (successCount === 0) {
                notify(`âŒ ×›×œ ×”× ×™×¡×™×•× ×•×ª × ×›×©×œ×•. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜`, 'error');
            } else {
                let msg = `âš ï¸ ${successCount} ×”×¦×œ×™×—×•, ${errorCount} × ×›×©×œ×•`;
                if (manualUpdateNeeded.length > 0) {
                    msg += `\n\nğŸ‡®ğŸ‡± × ×™×™×¨×•×ª ×™×©×¨××œ×™×™× ×©×“×•×¨×©×™× ×¢×“×›×•×Ÿ ×™×“× ×™:\n${manualUpdateNeeded.join(', ')}\n\n×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "ğŸ’° ××—×™×¨" ×œ×™×“ ×”×× ×™×” ×œ×¢×“×›×Ÿ ×™×“× ×™×ª`;
                }
                notify(msg, 'warning');
            }
        }

        // ===========================================
        // INVESTMENT CALCULATOR
        // ===========================================
        
        function calculateInvestment() {
            const amount = parseFloat(document.getElementById('invest-amount').value);
            
            if (!amount || amount <= 0) {
                notify('âŒ ×”×–×Ÿ ×¡×›×•× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // ×—×™×©×•×‘ ×¡×˜×˜×•×¡ × ×•×›×—×™
            const totalValue = getTotalValueILS();
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const currentPercent = (groupValue / totalValue) * 100;
                const gap = group.target - currentPercent;
                
                return {
                    group,
                    currentPercent,
                    gap,
                    value: groupValue
                };
            });
            
            // ××™×•×Ÿ ×œ×¤×™ ×¤×¢×¨ (×”×›×™ ×—×¡×¨ ×§×•×“×)
            groupsStatus.sort((a, b) => b.gap - a.gap);
            
            // ×—×œ×•×§×” ×¤×¨×•×¤×•×¨×¦×™×•× ×œ×™×ª ×œ×¤×™ ×¤×¢×¨×™×
            const totalGap = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.gap), 0);
            
            const allocations = groupsStatus.map(status => {
                const proportion = totalGap > 0 ? Math.max(0, status.gap) / totalGap : 1 / groupsStatus.length;
                const allocatedAmount = amount * proportion;
                
                // ×—×œ×•×§×” ×©×•×•×” ×‘×ª×•×š ×”×§×‘×•×¦×”
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === status.group.id);
                const perHolding = groupHoldings.length > 0 ? allocatedAmount / groupHoldings.length : 0;
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: groupHoldings.map(h => ({
                        symbol: h.symbol,
                        amount: perHolding
                    }))
                };
            });
            
            // ×”×¦×’×ª ×ª×•×¦××•×ª
            displayCalculatorResults(allocations, amount);
        }
        
        function displayCalculatorResults(allocations, totalAmount) {
            const container = document.getElementById('calc-items');
            const resultsDiv = document.getElementById('calc-results');
            
            let html = '';
            let displayedTotal = 0;
            
            allocations.forEach(alloc => {
                if (alloc.amount > 0) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${alloc.group} - â‚ª${Math.round(alloc.amount).toLocaleString()}</div>`;
                    
                    alloc.holdings.forEach(holding => {
                        if (holding.amount > 0) {
                            html += `<div class="calc-item">`;
                            html += `<span class="calc-symbol">${holding.symbol}</span>`;
                            html += `<span class="calc-amount">â‚ª${Math.round(holding.amount).toLocaleString()}</span>`;
                            html += `</div>`;
                            displayedTotal += holding.amount;
                        }
                    });
                    
                    html += `</div>`;
                }
            });
            
            container.innerHTML = html;
            document.getElementById('calc-total').textContent = `â‚ª${Math.round(displayedTotal).toLocaleString()}`;
            resultsDiv.classList.add('show');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = 'notification show';
            
            // Remove all type classes first
            notif.classList.remove('error', 'warning');
            
            if (type === 'error') notif.classList.add('error');
            if (type === 'warning') notif.classList.add('warning');
            
            // Don't auto-hide for loading messages
            if (type === 'loading') {
                notif.style.background = '#3b82f6';
                return; // Stay visible
            }
            
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find the button by tab name
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach((btn, index) => {
                    if (btn.textContent.includes('×¡×§×™×¨×”') && tabName === 'overview') btn.classList.add('active');
                    if (btn.textContent.includes('××—×©×‘×•×Ÿ') && tabName === 'calculator') btn.classList.add('active');
                    if (btn.textContent.includes('×× ×™×•×ª') && tabName === 'holdings') btn.classList.add('active');
                    if (btn.textContent.includes('××’"×—') && tabName === 'bonds') btn.classList.add('active');
                    if (btn.textContent.includes('×§×‘×•×¦×•×ª') && tabName === 'groups') btn.classList.add('active');
                    if (btn.textContent.includes('×”×™×¡×˜×•×¨×™×”') && tabName === 'history') btn.classList.add('active');
                    if (btn.textContent.includes('×”×•×Ÿ') && tabName === 'capital') btn.classList.add('active');
                    if (btn.textContent.includes('×”××œ×¦×•×ª') && tabName === 'recommendations') btn.classList.add('active');
                    if (btn.textContent.includes('×”×’×“×¨×•×ª') && tabName === 'settings') btn.classList.add('active');
                });
            }
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'overview') updateOverview();
            if (tabName === 'holdings') renderHoldingsList();
            if (tabName === 'bonds') renderBondsList();
            if (tabName === 'groups') renderGroupsList();
            if (tabName === 'history') renderSalesHistory();
            if (tabName === 'capital') { renderCapitalMovements(); updateCapitalSummary(); }
            if (tabName === 'recommendations') renderRecommendations();
        }
        
        function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            if (currency === 'USD') return amount * portfolio.rates.USD;
            if (currency === 'EUR') return amount * portfolio.rates.EUR;
            return amount;
        }
        
        function getTotalValueILS() {
            return portfolio.holdings.reduce((sum, h) => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                return sum + convertToILS(value, h.currency);
            }, 0);
        }
        
        function getCurrencySymbol(currency) {
            const symbols = { ILS: 'â‚ª', USD: '$', EUR: 'â‚¬' };
            return symbols[currency] || currency;
        }

        // ===========================================
        // DATA MANAGEMENT - FIREBASE
        // ===========================================
        
        async function saveData() {
            if (!currentUser) {
                console.warn('No user logged in, cannot save');
                return;
            }
            
            try {
                // CRITICAL FIX: Always save with default groups
                const defaultGroups = [
                    { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                ];
                
                // Validate all holdings have valid groupId
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings = portfolio.holdings.map(h => {
                        const groupId = parseInt(h.groupId);
                        if (isNaN(groupId) || groupId <= 0) {
                            console.warn(`âš ï¸ Invalid groupId for ${h.symbol}, setting to 1`);
                            return { ...h, groupId: 1 };
                        }
                        return h;
                    });
                }
                
                // Always save with default groups
                const dataToSave = {
                    holdings: portfolio.holdings,
                    groups: defaultGroups,
                    rates: portfolio.rates,
                    bonds: portfolio.bonds,
                    capitalMovements: portfolio.capitalMovements || [],
                    sales: portfolio.sales || [],
                    lastModified: new Date().toISOString()
                };
                
                // Save to Firebase
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                await setDoc(userDocRef, dataToSave);
                console.log('âœ… Data saved to Firebase');
                
                // Also save to localStorage as backup
                localStorage.setItem('portfolio', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('âŒ Error saving data:', error);
                notify('âš ï¸ ×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×', 'error');
            }
        }
        
        async function loadData() {
            if (!currentUser) {
                console.warn('No user logged in, cannot load');
                return false;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const loaded = docSnap.data();
                    
                    const defaultGroups = [
                        { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            
                            const holding = {
                                ...h,
                                groupId: validGroupId,
                                purchases: h.purchases || []
                            };
                            console.log(`ğŸ“¦ Loaded: ${holding.symbol}, groupId: ${holding.groupId}`);
                            return holding;
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        // MIGRATION: Convert old bonds (number) to new bonds (array)
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : 
                               (typeof loaded.bonds === 'number' && loaded.bonds > 0) ? 
                               [{
                                   id: Date.now(),
                                   name: '×§×¨×Ÿ ××’"×— (×× ×ª×•× ×™× ×™×©× ×™×)',
                                   units: 1,
                                   costBasis: loaded.bonds,
                                   currentPrice: loaded.bonds,
                                   lastUpdate: new Date().toISOString()
                               }] : [],
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : []
                    };
                    
                    console.log('âœ… Data loaded from Firebase');
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('portfolio', JSON.stringify({
                        holdings: portfolio.holdings,
                        groups: defaultGroups,
                        rates: portfolio.rates,
                        bonds: portfolio.bonds,
                        capitalMovements: portfolio.capitalMovements,
                        sales: portfolio.sales
                    }));
                    
                    console.log('ğŸ“Š Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('No Firebase data, trying localStorage...');
                    return loadFromLocalStorage();
                }
            } catch (error) {
                console.error('âŒ Firebase load failed:', error);
                return loadFromLocalStorage();
            }
        }
                        bonds: portfolio.bonds,
                        capitalMovements: portfolio.capitalMovements,
                        sales: portfolio.sales
                    }));
                    
                    console.log('ğŸ“Š Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('No Firebase data, trying localStorage...');
                    return loadFromLocalStorage();
                }
            } catch (error) {
                console.error('âŒ Firebase load failed:', error);
                return loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('portfolio');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    const defaultGroups = [
                        { id: 1, name: '××“×“×™× ×¢×•×œ××™×™×', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '××§×˜×™×‘×™/×¡×™×›×•× ×™', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            
                            const holding = {
                                ...h,
                                groupId: validGroupId,
                                purchases: h.purchases || []
                            };
                            return holding;
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        // MIGRATION: Convert old bonds format (number) to new format (array)
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : 
                               (typeof loaded.bonds === 'number' && loaded.bonds > 0) ? 
                               [{
                                   id: Date.now(),
                                   name: '×§×¨×Ÿ ××’"×— (×× ×ª×•× ×™× ×™×©× ×™×)',
                                   units: 1,
                                   costBasis: loaded.bonds,
                                   currentPrice: loaded.bonds,
                                   lastUpdate: new Date().toISOString()
                               }] : [],
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : []
                    };
                    
                    console.log('âœ… Data loaded from localStorage');
                    console.log('ğŸ“Š Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('â„¹ï¸ No saved data, using defaults');
                    if (!Array.isArray(portfolio.holdings)) {
                        portfolio.holdings = [];
                    }
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                notify('âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×', 'error');
                portfolio.holdings = [];
                return false;
            }
        }

        // ===========================================
        // HOLDINGS MANAGEMENT - FIXED
        // ===========================================
        
        function showAddHoldingForm() {
            editingHoldingId = null; // Reset editing mode
            document.getElementById('add-holding-form').style.display = 'block';
            updateGroupSelect();
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('add-holding-form').style.display = 'none';
            editingHoldingId = null;
            
            // Clear form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-shares').value = '';
            document.getElementById('new-cost').value = '';
            document.getElementById('new-alt-ticker').value = '';
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '×”×•×¡×£ ×”×—×–×§×” ×—×“×©×”';
        }
        
        function updateGroupSelect() {
            const select = document.getElementById('new-group');
            if (!select) {
                console.error('âŒ Group select element not found');
                return;
            }
            select.innerHTML = portfolio.groups.map(g => 
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        }
        
        function addHolding() {
            console.log('ğŸ” Starting addHolding function...');
            console.log('ğŸ“ Step 1: Getting form elements');
            
            const symbolInput = document.getElementById('new-symbol');
            const sharesInput = document.getElementById('new-shares');
            const costInput = document.getElementById('new-cost');
            const currencySelect = document.getElementById('new-currency');
            const groupSelect = document.getElementById('new-group');
            
            // ×‘×“×™×§×” ×©×›×œ ×”××œ×× ×˜×™× ×§×™×™××™×
            console.log('ğŸ“ Step 2: Checking if elements exist', {
                symbolInput: !!symbolInput,
                sharesInput: !!sharesInput,
                costInput: !!costInput,
                currencySelect: !!currencySelect,
                groupSelect: !!groupSelect
            });
            
            if (!symbolInput || !sharesInput || !costInput || !currencySelect || !groupSelect) {
                console.error('âŒ One or more form elements not found');
                notify('âŒ ×©×’×™××” ×‘×˜×•×¤×¡ - ××œ×× ×˜ ×œ× × ××¦×', 'error');
                return;
            }
            
            console.log('ğŸ“ Step 3: Reading form values');
            const symbol = symbolInput.value.trim().toUpperCase();
            const sharesStr = sharesInput.value.trim();
            const costStr = costInput.value.trim();
            const currency = currencySelect.value;
            const groupId = parseInt(groupSelect.value);
            const altTicker = document.getElementById('new-alt-ticker')?.value.trim().toUpperCase() || '';
            
            console.log('ğŸ“‹ Form values:', { 
                symbol, 
                shares: sharesStr, 
                cost: costStr, 
                currency, 
                groupId,
                altTicker,
                raw: {
                    symbolRaw: symbolInput.value,
                    sharesRaw: sharesInput.value,
                    costRaw: costInput.value
                }
            });
            
            // ×‘×“×™×§×ª ×ª×§×™× ×•×ª - ×©×“×•×ª ×¨×™×§×™×
            console.log('ğŸ“ Step 4: Validating empty fields');
            if (!symbol || !sharesStr || !costStr) {
                console.error('âŒ Empty fields detected:', { symbol, sharesStr, costStr });
                notify('âŒ ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
                return;
            }
            
            // ×”××¨×” ×œ××¡×¤×¨×™×
            console.log('ğŸ“ Step 5: Converting to numbers');
            const shares = parseFloat(sharesStr);
            const cost = parseFloat(costStr);
            
            console.log('ğŸ”¢ Parsed numbers:', { shares, cost, isNaN_shares: isNaN(shares), isNaN_cost: isNaN(cost) });
            
            // ×‘×“×™×§×” ×©×”××¨×” ×”×¦×œ×™×—×”
            if (isNaN(shares) || isNaN(cost)) {
                console.error('âŒ NaN detected after parsing');
                notify('âŒ ×”×›××•×ª ×•×”××—×™×¨ ×—×™×™×‘×™× ×œ×”×™×•×ª ××¡×¤×¨×™×', 'error');
                return;
            }
            
            // ×‘×“×™×§×” ×©×”×¢×¨×›×™× ×—×™×•×‘×™×™×
            console.log('ğŸ“ Step 6: Validating positive numbers');
            if (shares <= 0 || cost <= 0) {
                console.error('âŒ Non-positive numbers:', { shares, cost });
                notify('âŒ ×”×›××•×ª ×•×”××—×™×¨ ×—×™×™×‘×™× ×œ×”×™×•×ª ×’×“×•×œ×™× ×××¤×¡', 'error');
                return;
            }
            
            // ×‘×“×™×§×” ×× ×× ×—× ×• ×‘××¦×‘ ×¢×¨×™×›×” ××• ×”×•×¡×¤×”
            if (editingHoldingId !== null) {
                // ××¦×‘ ×¢×¨×™×›×” - ×¢×“×›×Ÿ ×”×—×–×§×” ×§×™×™××ª
                console.log('ğŸ“ Step 7: Updating existing holding:', editingHoldingId);
                const holding = portfolio.holdings.find(h => h.id === editingHoldingId);
                if (holding) {
                    holding.symbol = symbol;
                    holding.shares = shares;
                    holding.costBasis = cost;
                    holding.currency = currency;
                    holding.groupId = groupId;
                    holding.altTicker = altTicker;
                    holding.lastUpdate = new Date().toISOString();
                    console.log('âœ… Holding updated:', holding);
                }
            } else {
                // ××¦×‘ ×”×•×¡×¤×” - ×¦×•×¨ ×”×—×–×§×” ×—×“×©×”
                console.log('ğŸ“ Step 7: Creating new holding object');
                const newHolding = {
                    id: Date.now(),
                    symbol,
                    shares,
                    costBasis: cost,
                    currentPrice: cost,
                    currency,
                    groupId,
                    altTicker: altTicker || '',
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('â• Adding holding:', newHolding);
                console.log('ğŸ“Š Current holdings before add:', portfolio.holdings.length);
                
                portfolio.holdings.push(newHolding);
                
                console.log('ğŸ“Š Current holdings after add:', portfolio.holdings.length);
            }
            
            console.log('ğŸ“ Step 8: Saving data');
            
            // ×©××™×¨×”
            saveData();
            
            console.log('ğŸ“ Step 9: Closing form and clearing inputs');
            
            // ×¡×’×™×¨×ª ×”×˜×•×¤×¡ ×•× ×™×§×•×™
            hideAddHoldingForm();
            symbolInput.value = '';
            sharesInput.value = '';
            costInput.value = '';
            
            console.log('ğŸ“ Step 10: Updating UI');
            
            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            renderHoldingsList();
            updateOverview();
            
            const actionText = editingHoldingId ? '×¢×•×“×›×Ÿ' : '× ×•×¡×£';
            notify(`âœ… ${symbol} ${actionText} ×‘×”×¦×œ×—×”!`);
            console.log('âœ… Holding saved successfully. Total holdings:', portfolio.holdings.length);
            console.log('âœ… addHolding function completed successfully');
        }
        
        function deleteHolding(id) {
            if (confirm('×”×× ×œ××—×•×§ ×”×—×–×§×” ×–×•?')) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
                saveData();
                renderHoldingsList();
                updateOverview();
                notify('âœ… ×”×—×–×§×” × ××—×§×”');
            }
        }
        
        function editHolding(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            // Set editing mode
            editingHoldingId = id;
            
            // Fill form with holding data
            document.getElementById('new-symbol').value = holding.symbol;
            document.getElementById('new-shares').value = holding.shares;
            document.getElementById('new-cost').value = holding.costBasis;
            document.getElementById('new-currency').value = holding.currency;
            document.getElementById('new-group').value = holding.groupId;
            document.getElementById('new-alt-ticker').value = holding.altTicker || '';
            
            // Change form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = `×¢×¨×•×š ×”×—×–×§×”: ${holding.symbol}`;
            
            // Show form
            document.getElementById('add-holding-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('add-holding-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updatePriceManually(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const newPrice = prompt(`×¢×“×›×Ÿ ××—×™×¨ ×¢×‘×•×¨ ${holding.symbol}\n\n××—×™×¨ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.currentPrice}\n\n×”×–×Ÿ ××—×™×¨ ×—×“×©:`, holding.currentPrice);
            
            if (newPrice === null) return; // User cancelled
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            holding.currentPrice = price;
            holding.lastUpdate = new Date().toISOString();
            saveData();
            renderHoldingsList();
            updateOverview();
            notify(`âœ… ××—×™×¨ ${holding.symbol} ×¢×•×“×›×Ÿ ×œ-${getCurrencySymbol(holding.currency)}${price}`);
        }
        
        // ===========================================
        // BONDS MANAGEMENT
        // ===========================================
        let editingBondId = null;
        
        function showAddBondForm() {
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideAddBondForm() {
            document.getElementById('add-bond-form').style.display = 'none';
            editingBondId = null;
            // Clear form
            document.getElementById('bond-name').value = '';
            document.getElementById('bond-units').value = '';
            document.getElementById('bond-cost').value = '';
            document.getElementById('bond-price').value = '';
        }
        
        function saveBond() {
            const name = document.getElementById('bond-name').value.trim();
            const units = parseFloat(document.getElementById('bond-units').value);
            const cost = parseFloat(document.getElementById('bond-cost').value);
            const price = parseFloat(document.getElementById('bond-price').value);
            
            if (!name || isNaN(units) || isNaN(cost) || isNaN(price)) {
                notify('âŒ ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
                return;
            }
            
            if (units <= 0 || cost <= 0 || price <= 0) {
                notify('âŒ ×›×œ ×”×¢×¨×›×™× ×—×™×™×‘×™× ×œ×”×™×•×ª ×—×™×•×‘×™×™×', 'error');
                return;
            }
            
            if (editingBondId !== null) {
                // Update existing
                const bond = portfolio.bonds.find(b => b.id === editingBondId);
                if (bond) {
                    bond.name = name;
                    bond.units = units;
                    bond.costBasis = cost;
                    bond.currentPrice = price;
                    bond.lastUpdate = new Date().toISOString();
                }
            } else {
                // Add new
                portfolio.bonds.push({
                    id: Date.now(),
                    name,
                    units,
                    costBasis: cost,
                    currentPrice: price,
                    lastUpdate: new Date().toISOString()
                });
            }
            
            saveData();
            renderBondsList();
            updateOverview();
            hideAddBondForm();
            notify(`âœ… ×§×¨×Ÿ ××’"×— ${editingBondId ? '×¢×•×“×›× ×”' : '× ×•×¡×¤×”'} ×‘×”×¦×œ×—×”!`);
        }
        
        function editBond(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            editingBondId = id;
            document.getElementById('bond-name').value = bond.name;
            document.getElementById('bond-units').value = bond.units;
            document.getElementById('bond-cost').value = bond.costBasis;
            document.getElementById('bond-price').value = bond.currentPrice;
            
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function deleteBond(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×§×¨×Ÿ ××’"×— ×–×•?')) return;
            
            portfolio.bonds = portfolio.bonds.filter(b => b.id !== id);
            saveData();
            renderBondsList();
            updateOverview();
            notify('âœ… ×§×¨×Ÿ ××’"×— × ××—×§×”');
        }
        
        function updateBondPrice(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            const newPrice = prompt(`×¢×“×›×Ÿ ××—×™×¨ ×¢×‘×•×¨ ${bond.name}\n\n××—×™×¨ × ×•×›×—×™: â‚ª${bond.currentPrice}\n\n×”×–×Ÿ ××—×™×¨ ×—×“×©:`, bond.currentPrice);
            
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            bond.currentPrice = price;
            bond.lastUpdate = new Date().toISOString();
            saveData();
            renderBondsList();
            updateOverview();
            notify(`âœ… ××—×™×¨ ${bond.name} ×¢×•×“×›×Ÿ ×œ-â‚ª${price}`);
        }
        
        function renderBondsList() {
            const container = document.getElementById('bonds-list');
            if (!container) return;
            
            if (!portfolio.bonds || portfolio.bonds.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">××™×Ÿ ×§×¨× ×•×ª ××’"×— ×¢×“×™×™×Ÿ. ×œ×—×¥ "×”×•×¡×£ ×§×¨×Ÿ ××’"×—" ×›×“×™ ×œ×”×ª×—×™×œ.</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 20px;">';
            
            portfolio.bonds.forEach(bond => {
                const totalCost = bond.units * bond.costBasis;
                const currentValue = bond.units * bond.currentPrice;
                const profit = currentValue - totalCost;
                const profitPercent = (profit / totalCost) * 100;
                
                html += `
                    <div class="glass" style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0;">${bond.name}</h4>
                                <div style="color: #6b7280; font-size: 0.9rem;">
                                    ${bond.units} ×™×—×™×“×•×ª Ã— â‚ª${bond.costBasis.toFixed(2)} = â‚ª${totalCost.toLocaleString()}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editBond(${bond.id})" class="btn btn-sm btn-primary" title="×¢×¨×•×š">âœï¸</button>
                                <button onclick="updateBondPrice(${bond.id})" class="btn btn-sm btn-success" title="×¢×“×›×Ÿ ××—×™×¨">ğŸ’°</button>
                                <button onclick="deleteBond(${bond.id})" class="btn btn-sm btn-danger" title="××—×§">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <div style="color: #6b7280; font-size: 0.85rem;">××—×™×¨ × ×•×›×—×™</div>
                                <div style="font-size: 1.1rem; font-weight: bold;">â‚ª${bond.currentPrice.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 0.85rem;">×©×•×•×™ × ×•×›×—×™</div>
                                <div style="font-size: 1.1rem; font-weight: bold;">â‚ª${Math.round(currentValue).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 0.85rem;">×ª×©×•××”</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: ${profit >= 0 ? '#10b981' : '#ef4444'};">
                                    ${profit >= 0 ? '+' : ''}â‚ª${Math.round(profit).toLocaleString()} (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add summary
            const totalBondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0);
            const totalBondsCost = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const totalBondsProfit = totalBondsValue - totalBondsCost;
            const totalBondsProfitPercent = totalBondsCost > 0 ? (totalBondsProfit / totalBondsCost) * 100 : 0;
            
            html += `
                <div class="glass" style="padding: 20px; margin-top: 20px; background: #f0f9ff; border: 2px solid #3b82f6;">
                    <h4 style="margin: 0 0 15px 0;">ğŸ“Š ×¡×™×›×•× ××’"×—</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <div style="color: #1e40af; font-size: 0.85rem;">×¡×”"×› ×”×©×§×¢×”</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">â‚ª${Math.round(totalBondsCost).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.85rem;">×©×•×•×™ × ×•×›×—×™</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">â‚ª${Math.round(totalBondsValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #065f46; font-size: 0.85rem;">×ª×©×•××” ×›×•×œ×œ×ª</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: ${totalBondsProfit >= 0 ? '#065f46' : '#991b1b'};">
                                ${totalBondsProfit >= 0 ? '+' : ''}â‚ª${Math.round(totalBondsProfit).toLocaleString()} (${totalBondsProfitPercent >= 0 ? '+' : ''}${totalBondsProfitPercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ===========================================
        // NEW: ADD SHARES TO EXISTING POSITION
        // ===========================================
        function showAddSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const shares = prompt(`×”×•×¡×£ ×× ×™×•×ª ×œ-${holding.symbol}\n\n×”×—×–×§×” × ×•×›×—×™×ª: ${holding.shares} ×× ×™×•×ª\n××—×™×¨ ×××•×¦×¢ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}\n\n×›××” ×× ×™×•×ª ×œ×”×•×¡×™×£?`);
            if (!shares) return;
            
            const sharesToAdd = parseFloat(shares);
            if (isNaN(sharesToAdd) || sharesToAdd <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            const price = prompt(`××—×™×¨ ×§× ×™×” ×œ×× ×™×”?`, holding.currentPrice);
            if (!price) return;
            
            const purchasePrice = parseFloat(price);
            if (isNaN(purchasePrice) || purchasePrice <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Calculate new average cost
            const oldTotal = holding.shares * holding.costBasis;
            const newTotal = sharesToAdd * purchasePrice;
            const newShares = holding.shares + sharesToAdd;
            const newAvgCost = (oldTotal + newTotal) / newShares;
            
            // Save purchase to history
            if (!holding.purchases) holding.purchases = [];
            holding.purchases.push({
                date: new Date().toISOString(),
                shares: sharesToAdd,
                price: purchasePrice,
                total: newTotal
            });
            
            // Update holding
            holding.shares = newShares;
            holding.costBasis = newAvgCost;
            holding.lastUpdate = new Date().toISOString();
            
            saveData();
            renderHoldingsList();
            updateOverview();
            notify(`âœ… × ×•×¡×¤×• ${sharesToAdd} ×× ×™×•×ª ×©×œ ${holding.symbol}\n××—×™×¨ ×××•×¦×¢ ×—×“×©: ${getCurrencySymbol(holding.currency)}${newAvgCost.toFixed(2)}`);
        }
        
        // ===========================================
        // NEW: SELL PARTIAL POSITION
        // ===========================================
        function showSellSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const shares = prompt(`××›×•×¨ ×× ×™×•×ª ×-${holding.symbol}\n\n×”×—×–×§×” × ×•×›×—×™×ª: ${holding.shares} ×× ×™×•×ª\n××—×™×¨ ×§× ×™×™×” ×××•×¦×¢: ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}\n××—×™×¨ × ×•×›×—×™: ${getCurrencySymbol(holding.currency)}${holding.currentPrice.toFixed(2)}\n\n×›××” ×× ×™×•×ª ×œ××›×•×¨?`);
            if (!shares) return;
            
            const sharesToSell = parseFloat(shares);
            if (isNaN(sharesToSell) || sharesToSell <= 0) {
                notify('âŒ ×›××•×ª ×œ× ×ª×§×™× ×”', 'error');
                return;
            }
            
            if (sharesToSell > holding.shares) {
                notify('âŒ ××™×Ÿ ××¡×¤×™×§ ×× ×™×•×ª ×œ××›×™×¨×”', 'error');
                return;
            }
            
            const price = prompt(`××—×™×¨ ××›×™×¨×” ×œ×× ×™×”?`, holding.currentPrice);
            if (!price) return;
            
            const salePrice = parseFloat(price);
            if (isNaN(salePrice) || salePrice <= 0) {
                notify('âŒ ××—×™×¨ ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            // Calculate profit/loss
            const profit = (salePrice - holding.costBasis) * sharesToSell;
            const profitPercent = ((salePrice - holding.costBasis) / holding.costBasis * 100).toFixed(2);
            
            // Save sale to history
            if (!portfolio.sales) portfolio.sales = [];
            portfolio.sales.push({
                id: Date.now(),
                date: new Date().toISOString(),
                symbol: holding.symbol,
                shares: sharesToSell,
                salePrice: salePrice,
                costBasis: holding.costBasis,
                profit: profit,
                profitPercent: profitPercent,
                currency: holding.currency
            });
            
            // Update holding (reduce shares, keep same cost basis)
            holding.shares -= sharesToSell;
            holding.lastUpdate = new Date().toISOString();
            
            // If sold all shares, remove holding
            if (holding.shares === 0) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            }
            
            saveData();
            renderHoldingsList();
            updateOverview();
            
            const profitText = profit >= 0 ? `×¨×•×•×—: +${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}` : `×”×¤×¡×“: ${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}`;
            notify(`âœ… × ××›×¨×• ${sharesToSell} ×× ×™×•×ª ×©×œ ${holding.symbol}\n${profitText} (${profitPercent}%)`);
        }
        
        // ===========================================
        // NEW: CAPITAL TRACKING
        // ===========================================
        function addCapitalMovement() {
            const amountStr = prompt('×”×›× ×¡ ×¡×›×•×:\n(×—×™×•×‘×™ ×œ×”×¤×§×“×”, ×©×œ×™×œ×™ ×œ××©×™×›×”)');
            if (!amountStr) return;
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount === 0) {
                notify('âŒ ×¡×›×•× ×œ× ×ª×§×™×Ÿ', 'error');
                return;
            }
            
            const note = prompt('×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™):') || '';
            
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amount,
                type: amount > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderCapitalMovements();
            updateOverview();
            
            const typeText = amount > 0 ? '×”×¤×§×“×”' : '××©×™×›×”';
            notify(`âœ… ${typeText} ×©×œ â‚ª${Math.abs(amount).toLocaleString()} × ×¨×©××”`);
        }
        
        function deleteCapitalMovement(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?')) return;
            
            portfolio.capitalMovements = portfolio.capitalMovements.filter(m => m.id !== id);
            saveData();
            renderCapitalMovements();
            updateOverview();
            notify('âœ… ×ª× ×•×¢×” × ××—×§×”');
        }
        
        function renderCapitalMovements() {
            const container = document.getElementById('capital-movements-list');
            if (!container) return;
            
            if (!portfolio.capitalMovements || portfolio.capitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×ª× ×•×¢×•×ª ×”×•×Ÿ</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×›×•×</th><th>×¡×•×’</th><th>×”×¢×¨×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.capitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+â‚ª${m.amount.toLocaleString()}` : `-â‚ª${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? '×”×¤×§×“×”' : '××©×™×›×”';
                
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #666;">${m.note || '-'}</td>
                    <td><button onclick="deleteCapitalMovement(${m.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">××—×§</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Add summary
            const totalCapital = portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                <strong>×¡×”"×› ×”×•×Ÿ ××§×•×¨×™: â‚ª${totalCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderSalesHistory() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            if (!portfolio.sales || portfolio.sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ××›×™×¨×•×ª</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px;">×ª××¨×™×š</th><th>×¡×™××•×œ</th><th>×›××•×ª</th><th>××—×™×¨ ××›×™×¨×”</th><th>××—×™×¨ ×§× ×™×™×”</th><th>×¨×•×•×—/×”×¤×¡×“</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.sales].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let totalRealized = 0;
            sorted.forEach(s => {
                const date = new Date(s.date).toLocaleDateString('he-IL');
                const color = s.profit >= 0 ? 'green' : 'red';
                const profitText = `${getCurrencySymbol(s.currency)}${s.profit.toFixed(2)} (${s.profitPercent}%)`;
                
                // Convert to ILS for total
                const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                totalRealized += s.profit * rate;
                
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${date}</td>
                    <td><strong>${s.symbol}</strong></td>
                    <td>${s.shares}</td>
                    <td>${getCurrencySymbol(s.currency)}${s.salePrice.toFixed(2)}</td>
                    <td>${getCurrencySymbol(s.currency)}${s.costBasis.toFixed(2)}</td>
                    <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                    <td><button onclick="deleteSale(${s.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ ××—×§</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Add summary
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                <strong>×¡×”"×› ×¨×•×•×— ×××•××©: â‚ª${totalRealized.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function deleteSale(id) {
            if (!confirm('×”×× ×œ××—×•×§ ××›×™×¨×” ×–×• ××”×”×™×¡×˜×•×¨×™×”?')) return;
            
            portfolio.sales = portfolio.sales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify('âœ… ××›×™×¨×” × ××—×§×” ××”×”×™×¡×˜×•×¨×™×”');
        }
        
        function updateCapitalSummary() {
            const container = document.getElementById('capital-summary');
            if (!container) return;
            
            // Calculate total original capital
            const totalCapital = portfolio.capitalMovements ? 
                portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            
            // Calculate current portfolio value
            const currentValue = getTotalValueILS();
            
            // Calculate total realized profit from sales
            const realizedProfit = portfolio.sales ?
                portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0) : 0;
            
            // Calculate unrealized profit
            const totalCost = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            const unrealizedProfit = currentValue - totalCost;
            
            // Total profit (realized + unrealized)
            const totalProfit = currentValue - totalCapital;
            const profitPercent = totalCapital > 0 ? (totalProfit / totalCapital * 100) : 0;
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 2px solid #3b82f6;">
                        <div style="color: #1e40af; font-size: 0.85rem; margin-bottom: 5px;">×”×•×Ÿ ××§×•×¨×™</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #1e40af;">â‚ª${totalCapital.toLocaleString()}</div>
                    </div>
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 2px solid #10b981;">
                        <div style="color: #065f46; font-size: 0.85rem; margin-bottom: 5px;">×©×•×•×™ × ×•×›×—×™</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #065f46;">â‚ª${Math.round(currentValue).toLocaleString()}</div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 2px solid #f59e0b;">
                        <div style="color: #92400e; font-size: 0.85rem; margin-bottom: 5px;">×¨×•×•×— ×××•××© (××›×™×¨×•×ª)</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #92400e;">â‚ª${Math.round(realizedProfit).toLocaleString()}</div>
                    </div>
                    <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border: 2px solid #6366f1;">
                        <div style="color: #3730a3; font-size: 0.85rem; margin-bottom: 5px;">×¨×•×•×— ×œ× ×××•××© (×”×—×–×§×•×ª)</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #3730a3;">â‚ª${Math.round(unrealizedProfit).toLocaleString()}</div>
                    </div>
                    <div style="background: ${totalProfit >= 0 ? '#dcfce7' : '#fee2e2'}; padding: 15px; border-radius: 8px; border: 2px solid ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">
                        <div style="color: ${totalProfit >= 0 ? '#065f46' : '#991b1b'}; font-size: 0.85rem; margin-bottom: 5px;">ğŸ’° ×¨×•×•×— ×›×•×œ×œ</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${totalProfit >= 0 ? '#065f46' : '#991b1b'};">
                            ${totalProfit >= 0 ? '+' : ''}â‚ª${Math.round(totalProfit).toLocaleString()} (${profitPercent.toFixed(1)}%)
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h4 style="margin-bottom: 10px; color: #374151; font-size: 0.95rem;">ğŸ“Š ×”×¡×‘×¨ ×—×™×©×•×‘ ×”×¨×•×•×— ×”×›×•×œ×œ:</h4>
                    <div style="font-size: 0.85rem; color: #6b7280; line-height: 1.6;">
                        <div style="margin-bottom: 8px;">
                            <strong>×¨×•×•×— ×›×•×œ×œ = ×©×•×•×™ ×ª×™×§ × ×•×›×—×™ - ×”×•×Ÿ ××§×•×¨×™</strong>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px; margin-top: 8px;">
                            <div style="margin-bottom: 5px;">×©×•×•×™ ×ª×™×§: â‚ª${Math.round(currentValue).toLocaleString()}</div>
                            <div style="margin-bottom: 5px;">×”×•×Ÿ ××§×•×¨×™: â‚ª${totalCapital.toLocaleString()}</div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-weight: bold; color: ${totalProfit >= 0 ? '#065f46' : '#991b1b'};">
                                = ${totalProfit >= 0 ? '+' : ''}â‚ª${Math.round(totalProfit).toLocaleString()}
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-right: 3px solid #f59e0b;">
                            ğŸ’¡ <strong>×—×©×•×‘:</strong> ×× ×”×©×§×¢×ª ××—×“×© ×¨×•×•×—×™× ×××›×™×¨×•×ª, ×”× × ×¡×¤×¨×™× ×‘×¨×•×•×— ×”×›×•×œ×œ ×‘×¦×•×¨×” × ×›×•× ×” (×œ× ×›×¤×•×œ)!
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ===========================================
        // CALCULATE CAPITAL FROM HOLDINGS
        // ===========================================
        let selectedHoldings = new Set();
        
        function showCalculateCapitalFromHoldings() {
            if (portfolio.holdings.length === 0) {
                notify('âŒ ××™×Ÿ ×”×—×–×§×•×ª ×‘×ª×™×§', 'error');
                return;
            }
            
            // Reset selection
            selectedHoldings = new Set(portfolio.holdings.map(h => h.id));
            
            // Render checkboxes
            renderHoldingsCheckboxes();
            
            // Show modal
            const modal = document.getElementById('calculate-capital-modal');
            modal.style.display = 'flex';
        }
        
        function hideCalculateCapitalModal() {
            document.getElementById('calculate-capital-modal').style.display = 'none';
        }
        
        function renderHoldingsCheckboxes() {
            const container = document.getElementById('holdings-checkboxes');
            if (!container) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            portfolio.holdings.forEach(h => {
                const cost = h.shares * h.costBasis;
                const costILS = convertToILS(cost, h.currency);
                const checked = selectedHoldings.has(h.id) ? 'checked' : '';
                
                html += `
                    <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid ${checked ? '#3b82f6' : '#e5e7eb'};">
                        <input type="checkbox" ${checked} onchange="toggleHoldingSelection(${h.id})" style="width: 20px; height: 20px; margin-left: 10px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 3px;">${h.symbol}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">
                                ${h.shares} ×× ×™×•×ª Ã— ${getCurrencySymbol(h.currency)}${h.costBasis.toFixed(2)} = 
                                <strong>${getCurrencySymbol(h.currency)}${cost.toFixed(2)}</strong>
                                ${h.currency !== 'ILS' ? ` (â‚ª${Math.round(costILS).toLocaleString()})` : ''}
                            </div>
                        </div>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            updateSelectedCapitalTotal();
        }
        
        function toggleHoldingSelection(id) {
            if (selectedHoldings.has(id)) {
                selectedHoldings.delete(id);
            } else {
                selectedHoldings.add(id);
            }
            renderHoldingsCheckboxes();
        }
        
        function updateSelectedCapitalTotal() {
            let total = 0;
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                }
            });
            
            const display = document.getElementById('selected-capital-total');
            if (display) {
                display.textContent = `â‚ª${Math.round(total).toLocaleString()}`;
            }
        }
        
        function addCalculatedCapital() {
            if (selectedHoldings.size === 0) {
                notify('âŒ ×‘×—×¨ ×œ×¤×—×•×ª ×”×—×–×§×” ××—×ª', 'error');
                return;
            }
            
            let total = 0;
            const selectedSymbols = [];
            
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                    selectedSymbols.push(holding.symbol);
                }
            });
            
            // Add as capital movement
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: Math.round(total),
                type: 'deposit',
                note: `×—×™×©×•×‘ ××•×˜×•××˜×™: ${selectedSymbols.join(', ')}`
            });
            
            saveData();
            renderCapitalMovements();
            updateCapitalSummary();
            hideCalculateCapitalModal();
            
            notify(`âœ… × ×•×¡×£ ×”×•×Ÿ ××§×•×¨×™: â‚ª${Math.round(total).toLocaleString()}`);
        }
        
        function renderHoldingsList() {
            const container = document.getElementById('holdings-list');
            
            if (!container) {
                console.error('âŒ Holdings list container not found');
                return;
            }
            
            console.log('ğŸ“Š Rendering holdings list. Total:', portfolio.holdings.length);
            
            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">××™×Ÿ ×”×—×–×§×•×ª ×¢×“×™×™×Ÿ</p>
                        <p>×œ×—×¥ ×¢×œ "×”×•×¡×£ ×”×—×–×§×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = portfolio.holdings.map(holding => {
                // CRITICAL: Ensure groupId comparison works with both string and number
                const holdingGroupId = parseInt(holding.groupId);
                const group = portfolio.groups.find(g => g.id === holdingGroupId);
                
                const currentValue = holding.shares * (holding.currentPrice || holding.costBasis);
                const costValue = holding.shares * holding.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                
                return `
                    <div class="holding-card">
                        <div class="holding-header">
                            <h4>
                                ${holding.symbol}
                                ${holding.altTicker ? `<span style="font-size: 0.75rem; color: #667eea; font-weight: normal;">â†’ ${holding.altTicker}</span>` : ''}
                                <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">
                                    â€¢ ${group ? group.name : '×œ× ×™×“×•×¢'}
                                </span>
                            </h4>
                            <div class="holding-actions">
                                <button onclick="showAddSharesForm(${holding.id})" class="btn btn-success btn-sm" title="×”×•×¡×£ ×× ×™×•×ª ×œ×”×—×–×§×”" style="background: #10b981;">
                                    â• ×”×•×¡×£
                                </button>
                                <button onclick="showSellSharesForm(${holding.id})" class="btn btn-sm" title="××›×•×¨ ×—×œ×§" style="background: #f59e0b; color: white;">
                                    ğŸ’¸ ××›×•×¨
                                </button>
                                <button onclick="editHolding(${holding.id})" class="btn btn-primary btn-sm" title="×¢×¨×•×š ×”×—×–×§×”">
                                    âœï¸ ×¢×¨×•×š
                                </button>
                                <button onclick="updatePriceManually(${holding.id})" class="btn btn-success btn-sm" title="×¢×“×›×Ÿ ××—×™×¨ ×™×“× ×™×ª">
                                    ğŸ’° ××—×™×¨
                                </button>
                                <button onclick="deleteHolding(${holding.id})" class="btn btn-danger btn-sm">
                                    ğŸ—‘ï¸ ××—×§
                                </button>
                            </div>
                        </div>
                        <div class="holding-details">
                            <div class="detail-item">
                                <div class="detail-label">×× ×™×•×ª</div>
                                <div class="detail-value">${holding.shares}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">××—×™×¨ ×§× ×™×™×”</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">××—×™×¨ × ×•×›×—×™</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${(holding.currentPrice || holding.costBasis).toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">×©×•×•×™</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${currentValue.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">×¨×•×•×—/×”×¤×¡×“</div>
                                <div class="detail-value ${profit >= 0 ? 'positive' : 'negative'}">
                                    ${profit >= 0 ? '+' : ''}${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}
                                    (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===========================================
        // OVERVIEW
        // ===========================================
        
        function updateOverview() {
            console.log('ğŸ”„ Starting updateOverview...');
            console.log('ğŸ“Š Total holdings:', portfolio.holdings.length);
            console.log('ğŸ“‹ Holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId })));
            
            // =============================================
            // STOCKS CALCULATION (×× ×™×•×ª)
            // =============================================
            const stocksValue = getTotalValueILS(); // ×©×•×•×™ ×× ×™×•×ª × ×•×›×—×™
            
            // Calculate total capital from capitalMovements (×”×•×Ÿ ××§×•×¨×™)
            const totalCapital = portfolio.capitalMovements ? 
                portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            
            // Stocks profit = current value - original capital (×¨×•×•×— ×›×•×œ×œ)
            const stocksProfit = stocksValue - totalCapital;
            const stocksProfitPercent = totalCapital > 0 ? (stocksProfit / totalCapital) * 100 : 0;
            
            // Update stocks section
            document.getElementById('stocks-value').textContent = `â‚ª${Math.round(stocksValue).toLocaleString()}`;
            
            const usdTotal = portfolio.holdings.filter(h => h.currency === 'USD')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            const eurTotal = portfolio.holdings.filter(h => h.currency === 'EUR')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            
            document.getElementById('stocks-value-original').textContent = 
                `$${Math.round(usdTotal).toLocaleString()} + â‚¬${Math.round(eurTotal).toLocaleString()}`;
            
            document.getElementById('stocks-return').textContent = 
                `${stocksProfit >= 0 ? '+' : ''}${stocksProfitPercent.toFixed(1)}%`;
            document.getElementById('stocks-return-amount').textContent = 
                `${stocksProfit >= 0 ? '+' : ''}â‚ª${Math.round(stocksProfit).toLocaleString()}`;
            
            document.getElementById('stocks-capital').textContent = 
                `â‚ª${Math.round(totalCapital).toLocaleString()}`;
            
            // =============================================
            // BONDS CALCULATION (××’"×—)
            // =============================================
            const bondsValue = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
            const bondsCost = Array.isArray(portfolio.bonds) ?
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0) : 0;
            const bondsProfit = bondsValue - bondsCost;
            const bondsProfitPercent = bondsCost > 0 ? (bondsProfit / bondsCost) * 100 : 0;
            const bondsCount = Array.isArray(portfolio.bonds) ? portfolio.bonds.length : 0;
            
            // Update bonds section
            document.getElementById('bonds-value').textContent = `â‚ª${Math.round(bondsValue).toLocaleString()}`;
            document.getElementById('bonds-count').textContent = `${bondsCount} ×§×¨× ×•×ª`;
            document.getElementById('bonds-return').textContent = 
                `${bondsProfit >= 0 ? '+' : ''}${bondsProfitPercent.toFixed(1)}%`;
            document.getElementById('bonds-return-amount').textContent = 
                `${bondsProfit >= 0 ? '+' : ''}â‚ª${Math.round(bondsProfit).toLocaleString()}`;
            document.getElementById('bonds-cost').textContent = 
                `â‚ª${Math.round(bondsCost).toLocaleString()}`;
            
            // =============================================
            // TOTAL PORTFOLIO (×¡×”"×› ×ª×™×§)
            // =============================================
            const totalValue = stocksValue + bondsValue;
            const totalProfit = stocksProfit + bondsProfit;
            const totalCost = totalCapital + bondsCost;
            const totalProfitPercent = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;
            
            // Update total section
            document.getElementById('total-value').textContent = `â‚ª${Math.round(totalValue).toLocaleString()}`;
            document.getElementById('total-return').textContent = 
                `${totalProfit >= 0 ? '+' : ''}${totalProfitPercent.toFixed(1)}%`;
            document.getElementById('total-return-amount').textContent = 
                `${totalProfit >= 0 ? '+' : ''}â‚ª${Math.round(totalProfit).toLocaleString()}`;
            
            // Update last update time
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('last-update-date').textContent = now.toLocaleDateString('he-IL');
            
            // Render allocation comparison
            renderAllocationComparison();
            
            // Render chart
            renderPortfolioChart();
        }
        
        function renderAllocationComparison() {
            const container = document.getElementById('allocation-comparison');
            const totalValue = getTotalValueILS();
            
            console.log('ğŸ“Š renderAllocationComparison - Total value:', totalValue);
            console.log('ğŸ“Š All holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId, groupIdType: typeof h.groupId })));
            
            const html = portfolio.groups.map(group => {
                // Handle both string and number groupId
                const groupHoldings = portfolio.holdings.filter(h => {
                    const holdingGroupId = parseInt(h.groupId);
                    return holdingGroupId === group.id;
                });
                
                console.log(`ğŸ“‚ Group ${group.name} (ID: ${group.id}):`, {
                    holdings: groupHoldings.length,
                    symbols: groupHoldings.map(h => h.symbol)
                });
                
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    const ilsValue = convertToILS(value, h.currency);
                    console.log(`  - ${h.symbol}: ${h.shares} Ã— ${h.currentPrice || h.costBasis} ${h.currency} = â‚ª${ilsValue.toFixed(2)}`);
                    return sum + ilsValue;
                }, 0);
                
                console.log(`  Total group value: â‚ª${groupValue.toFixed(2)}`);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = actualPercent - group.target;
                
                let statusBadge = '';
                let statusClass = '';
                if (Math.abs(diff) < 2) {
                    statusBadge = 'ğŸŸ¢ ×××•×–×Ÿ';
                    statusClass = 'ok';
                } else if (diff < 0) {
                    statusBadge = `ğŸŸ¡ ×—×¡×¨ ${Math.abs(diff).toFixed(1)}%`;
                    statusClass = 'under';
                } else {
                    statusBadge = `ğŸ”´ ×™×ª×¨ ${diff.toFixed(1)}%`;
                    statusClass = 'over';
                }
                
                // Build holdings breakdown HTML
                const holdingsHTML = groupHoldings.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #6b7280; margin-bottom: 10px;">
                            ğŸ“‹ ×× ×™×•×ª ×‘×§×‘×•×¦×” (${groupHoldings.length}):
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const ilsValue = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (ilsValue / totalValue * 100) : 0;
                                const profit = value - (h.shares * h.costBasis);
                                const profitPercent = (profit / (h.shares * h.costBasis)) * 100;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                                padding: 8px 12px; background: white; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: #111827;">${h.symbol}</span>
                                            ${h.altTicker ? `<span style="font-size: 0.7rem; color: #667eea;">â†’ ${h.altTicker}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="color: #6b7280;">
                                                â‚ª${Math.round(ilsValue).toLocaleString()}
                                            </span>
                                            <span style="color: ${profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 0.8rem;">
                                                ${profit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%
                                            </span>
                                            <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: #6b7280;">
                                                ${holdingPercent.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; text-align: center; font-size: 0.85rem; color: #92400e;">
                        âš ï¸ ××™×Ÿ ×× ×™×•×ª ×‘×§×‘×•×¦×” ×–×•
                    </div>
                `;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div class="group-target">×™×¢×“: ${group.target}%</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>×‘×¤×•×¢×œ: ${actualPercent.toFixed(1)}%</span>
                                    <span style="color: #6b7280; font-size: 0.85rem;">
                                        (â‚ª${Math.round(groupValue).toLocaleString()})
                                    </span>
                                </div>
                                <span class="status-badge ${statusClass}">${statusBadge}</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        ${holdingsHTML}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function renderPortfolioChart() {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            const totalValue = getTotalValueILS();
            const data = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                return groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
            });
            
            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: portfolio.groups.map(g => g.name),
                    datasets: [{
                        data: data,
                        backgroundColor: portfolio.groups.map(g => g.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `${context.label}: â‚ª${Math.round(value).toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===========================================
        // GROUPS
        // ===========================================
        
        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            const totalValue = getTotalValueILS();
            
            const html = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="group-target">×™×¢×“: ${group.target}% | ×‘×¤×•×¢×œ: ${actualPercent.toFixed(1)}%</div>
                                <button onclick="editGroup(${group.id})" class="btn btn-primary btn-sm" title="×¢×¨×•×š ×§×‘×•×¦×”">
                                    âœï¸ ×¢×¨×•×š
                                </button>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%; background: ${group.color}">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="group-holdings" style="margin-top: 15px; display: grid; gap: 10px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const valueILS = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (valueILS / totalValue * 100) : 0;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                                        <span style="font-weight: 600;">${h.symbol}</span>
                                        <span style="color: #6b7280;">
                                            â‚ª${Math.round(valueILS).toLocaleString()} (${holdingPercent.toFixed(1)}%)
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // RECOMMENDATIONS
        // ===========================================
        
        function editGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // ×©× ×”×§×‘×•×¦×”
            const newName = prompt(`×¢×¨×•×š ×©× ×§×‘×•×¦×”\n\n×©× × ×•×›×—×™: ${group.name}\n\n×”×–×Ÿ ×©× ×—×“×©:`, group.name);
            if (newName === null) return;
            if (newName.trim()) group.name = newName.trim();
            
            // ××—×•×– ×™×¢×“
            const newTarget = prompt(`×¢×¨×•×š ××—×•×– ×™×¢×“\n\n×™×¢×“ × ×•×›×—×™: ${group.target}%\n\n×”×–×Ÿ ×™×¢×“ ×—×“×© (0-100):`, group.target);
            if (newTarget === null) return;
            const targetNum = parseFloat(newTarget);
            if (!isNaN(targetNum) && targetNum >= 0 && targetNum <= 100) {
                group.target = targetNum;
            }
            
            // ×¦×‘×¢
            const newColor = prompt(`×¢×¨×•×š ×¦×‘×¢ ×§×‘×•×¦×”\n\n×¦×‘×¢ × ×•×›×—×™: ${group.color}\n\n×”×–×Ÿ ×§×•×“ ×¦×‘×¢ (HEX):`, group.color);
            if (newColor === null) return;
            if (newColor.trim()) group.color = newColor.trim();
            
            saveData();
            renderGroupsList();
            updateOverview();
            notify(`âœ… ×§×‘×•×¦×” "${group.name}" ×¢×•×“×›× ×”`);
        }
        
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            const totalValue = getTotalValueILS();
            
            const recommendations = [];
            
            portfolio.groups.forEach(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = group.target - actualPercent;
                
                if (Math.abs(diff) > 2) {
                    recommendations.push({
                        group: group.name,
                        diff: diff,
                        action: diff > 0 ? 'buy' : 'sell'
                    });
                }
            });
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ‰</div>
                        <h3 style="color: #10b981; margin-bottom: 10px;">×”×ª×™×§ ×××•×–×Ÿ ××¦×•×™×Ÿ!</h3>
                        <p style="color: #6b7280;">×›×œ ×”×§×‘×•×¦×•×ª ×§×¨×•×‘×•×ª ×œ×™×¢×“ ×©×œ×”×Ÿ</p>
                    </div>
                `;
                return;
            }
            
            const html = recommendations.map(rec => {
                const color = rec.action === 'buy' ? '#fef3c7' : '#fee2e2';
                const textColor = rec.action === 'buy' ? '#92400e' : '#991b1b';
                const icon = rec.action === 'buy' ? 'ğŸ’°' : 'ğŸ“‰';
                const actionText = rec.action === 'buy' ? '×§× ×”' : '××›×•×¨';
                
                return `
                    <div class="glass" style="background: ${color}; border: 2px solid ${textColor}40; margin-bottom: 15px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2rem;">${icon}</span>
                            <h4 style="color: ${textColor};">${actionText} ${rec.group}</h4>
                        </div>
                        <p style="color: ${textColor};">
                            ${rec.action === 'buy' 
                                ? `×”×§×‘×•×¦×” ×—×¡×¨×” ${Math.abs(rec.diff).toFixed(1)}% ××”×™×¢×“. ×‘×§× ×™×” ×”×‘××”, ×”×ª××§×“ ×‘×§×‘×•×¦×” ×–×•.`
                                : `×”×§×‘×•×¦×” ×¢×•×“×¤×ª ×‘-${Math.abs(rec.diff).toFixed(1)}%. ×©×§×•×œ ×œ×”×¤×¡×™×§ ×œ×”×©×§×™×¢ ×‘×” ×–×× ×™×ª.`
                            }
                        </p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        
        function saveBonds() {
            portfolio.bonds = parseFloat(document.getElementById('bonds-amount').value) || 0;
            saveData();
            updateOverview();
            notify('âœ… ××’"×— × ×©××¨');
        }
        
        function exportData() {
            const json = JSON.stringify(portfolio, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify('âœ… × ×ª×•× ×™× ×™×•×¦××•');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    portfolio = JSON.parse(e.target.result);
                    saveData();
                    updateOverview();
                    renderGroupsList();
                    renderHoldingsList();
                    notify('âœ… × ×ª×•× ×™× ×™×•×‘××•');
                } catch (error) {
                    notify('âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        window.onload = function() {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”§ VERSION: localStorage RE-ENABLED + Groups Fixed');
            console.log('   âœ… Fixed: localStorage now saves and loads correctly');
            console.log('   âœ… Fixed: Groups are ALWAYS default - never corrupted');
            console.log('   âœ… Fixed: All holdings now have valid groupId');
            console.log('   âœ… Fixed: "No group found" error eliminated');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸš€ Initializing portfolio...');
            console.log('ğŸ“¦ Portfolio data structure:', portfolio);
        }
        
        async function init() {
            await loadData();  // Load from Firebase/localStorage
            console.log('ğŸ“Š Loaded holdings:', portfolio.holdings.length);
            console.log('ğŸ“Š Groups:', portfolio.groups);
            
            updateOverview();
            updateGroupSelect();
            renderHoldingsList();
            
            // ×˜×¢×™× ×ª ×¢×¨×›×™× ×œ×”×’×“×¨×•×ª
            document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
            document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
            // Note: bonds is now an array of funds, handled in bonds tab
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            // × ×™×¡×™×•×Ÿ ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ (×¨×§×¢ - ×œ× ×—×•×¡×)
            autoUpdateExchangeRates().then(success => {
                if (success) {
                    updateOverview();
                    console.log('âœ… Auto-update successful');
                } else {
                    console.log('â„¹ï¸ Using manual rates');
                }
            });
            
            notify('ğŸ’¼ ××¢×¨×›×ª ××•×›× ×”');
            console.log('âœ… Portfolio initialized successfully');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“‹ Debug Info:');
            console.log('  - Holdings:', portfolio.holdings.length);
            console.log('  - Groups:', portfolio.groups.length);
            console.log('  - USD Rate:', portfolio.rates.USD);
            console.log('  - EUR Rate:', portfolio.rates.EUR);
            console.log('  - Bonds:', portfolio.bonds);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… To add a holding, click "×”×•×¡×£ ×”×—×–×§×”" and fill the form');
            console.log('âœ… To refresh prices, click "×¨×¢× ×Ÿ ××—×™×¨×™×"');
            console.log('âœ… To auto-update exchange rates, go to Settings and click "×¨×¢× ×Ÿ ××•×˜×•××˜×™×ª"');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        };
        
        // Expose functions to window for HTML onclick handlers
        window.showTab = showTab;
        window.addHolding = addHolding;
        window.editHolding = editHolding;
        window.deleteHolding = deleteHolding;
        window.updatePriceManually = updatePriceManually;
        window.showAddSharesForm = showAddSharesForm;
        window.showSellSharesForm = showSellSharesForm;
        window.addCapitalMovement = addCapitalMovement;
        window.deleteCapitalMovement = deleteCapitalMovement;
        window.deleteSale = deleteSale;
        window.showCalculateCapitalFromHoldings = showCalculateCapitalFromHoldings;
        window.hideCalculateCapitalModal = hideCalculateCapitalModal;
        window.toggleHoldingSelection = toggleHoldingSelection;
        window.addCalculatedCapital = addCalculatedCapital;
        window.showAddBondForm = showAddBondForm;
        window.hideAddBondForm = hideAddBondForm;
        window.saveBond = saveBond;
        window.editBond = editBond;
        window.deleteBond = deleteBond;
        window.updateBondPrice = updateBondPrice;
        window.refreshPrices = refreshPrices;
        window.showAddHoldingForm = showAddHoldingForm;
        window.hideAddHoldingForm = hideAddHoldingForm;
        window.calculateInvestment = calculateInvestment;
        window.editGroup = editGroup;
        window.fixGroupIds = fixGroupIds;
        window.updateExchangeRates = updateExchangeRates;
        window.tryAutoUpdateRates = tryAutoUpdateRates;
        window.exportData = exportData;
        window.importData = importData;
    </script>
</body>
</html>
