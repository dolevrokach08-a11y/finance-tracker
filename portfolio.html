<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Portfolio Tracker v52</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00f0ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Portfolio">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Google Fonts - Space Grotesk for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js - Fixed CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ==================== DARK FINTECH THEME ==================== */
        :root {
            /* Dark backgrounds */
            --bg-base: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a24;
            --bg-hover: #22222e;
            
            /* Accent - Neon Cyan */
            --accent: #00f5d4;
            --accent-dim: rgba(0, 245, 212, 0.15);
            --accent-glow: 0 0 20px rgba(0, 245, 212, 0.3);
            
            /* Text */
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            
            /* Status Colors */
            --profit: #00f5d4;
            --loss: #ff6b6b;
            --warning: #ffd93d;
            --info: #4dabf7;
            --success: #00f5d4;
            --danger: #ff6b6b;
            
            /* Borders */
            --border: rgba(255, 255, 255, 0.1);
            --border-accent: rgba(0, 245, 212, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
            
            /* Legacy mapping */
            --bg-primary: #12121a;
            --bg-secondary: #1a1a24;
            --bg-tertiary: #22222e;
            --bg-gradient-start: #6366f1;
            --bg-gradient-end: #8b5cf6;
            --card-bg: #12121a;
            --glass-bg: rgba(18, 18, 26, 0.95);
            --shadow-color: rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.4);
            
            /* Misc */
            --radius: 16px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-base: #f8f9fa;
            --bg-surface: #ffffff;
            --bg-elevated: #f1f3f5;
            --bg-hover: #e9ecef;
            
            --accent: #00b894;
            --accent-dim: rgba(0, 184, 148, 0.12);
            --accent-glow: 0 0 20px rgba(0, 184, 148, 0.2);
            
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a7a;
            --text-muted: #8b8ba0;
            
            --profit: #00b894;
            --loss: #e74c3c;
            --success: #00b894;
            --danger: #e74c3c;
            
            --border: rgba(0, 0, 0, 0.08);
            --border-accent: rgba(0, 184, 148, 0.3);
            --border-color: rgba(0, 0, 0, 0.08);
            
            --bg-primary: #ffffff;
            --bg-secondary: #f1f3f5;
            --bg-tertiary: #e9ecef;
            --card-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-color: rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.08);
        }
        
        /* ==================== BASIC RESET & RTL ==================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Heebo', 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-base);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Numbers - Monospace */
        .mono, .value, [data-value], .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: 'tnum';
        }
        
        /* ==================== LAYOUT ==================== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 220px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 20px 12px;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        
        .sidebar-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 32px;
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.9rem;
            font-family: inherit;
            width: 100%;
            text-align: right;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent-dim);
            color: var(--accent);
        }
        
        .nav-item i, .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        
        .nav-item.active i, .nav-item.active svg {
            opacity: 1;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .theme-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            font-family: inherit;
            text-align: right;
            transition: all 0.15s ease;
        }
        
        .theme-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 220px;
            padding: 24px 32px;
            min-height: 100vh;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-elevated);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .loading-text {
            color: var(--accent);
            margin-top: 24px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .loading-subtext {
            color: var(--text-muted);
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== CARDS ==================== */
        .glass, .card {
            background: var(--bg-surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .glass:hover, .card:hover {
            border-color: var(--border-accent);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        /* ==================== PAGE HEADER ==================== */
        .page-header {
            margin-bottom: 24px;
        }
        
        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        /* Hide old header */
        .header {
            display: none;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: absolute;
            top: 0;
            left: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(15deg);
        }
        
        /* ==================== NAVIGATION LINKS ==================== */
        .nav-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ==================== TABS (Hidden - using sidebar) ==================== */
        .tabs {
            display: none;
        }
        
        .tab-btn {
            display: none;
        }
        
        .tab-content { 
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active { display: block; }
        
        /* ==================== SUB-TABS ==================== */
        .sub-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            width: fit-content;
            border: 1px solid var(--border);
        }
        
        .sub-tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sub-tab-btn i, .sub-tab-btn svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        
        .sub-tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .sub-tab-btn:hover i {
            opacity: 1;
        }
        
        .sub-tab-btn.active {
            background: var(--accent-dim);
            color: var(--accent);
            font-weight: 600;
        }
        
        .sub-tab-btn.active i {
            opacity: 1;
        }
        
        .sub-tab-content {
            display: none;
        }
        
        .sub-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== ADDITIONAL MODERN ENHANCEMENTS ==================== */
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Selection styling */
        ::selection {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
        }
        
        /* Focus visible for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            letter-spacing: 0.3px;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.12);
            color: #059669;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.12);
            color: #dc2626;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.12);
            color: #d97706;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.12);
            color: #2563eb;
        }
        
        body.dark-mode .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        body.dark-mode .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        body.dark-mode .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }
        
        body.dark-mode .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 0.9rem;
        }
        
        /* Card hover effect */
        .card-interactive {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .card-interactive:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Stat change indicator */
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        /* ==================== SUMMARY CARDS ==================== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 20px 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            display: none;
        }
        
        .summary-card:hover {
            border-color: var(--border-accent);
        }
        
        .summary-card.green {
            border-color: var(--profit);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(0, 245, 212, 0.08) 100%);
        }
        
        .summary-card.green:hover {
            box-shadow: 0 0 20px rgba(0, 245, 212, 0.15);
        }
        
        .summary-card.purple {
            border-color: #a855f7;
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(168, 85, 247, 0.08) 100%);
        }
        
        .summary-card.blue {
            border-color: var(--info);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(77, 171, 247, 0.08) 100%);
        }
        
        .summary-card.orange {
            border-color: var(--warning);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(255, 217, 61, 0.08) 100%);
        }
        
        .summary-card h3 { 
            font-size: 0.75rem; 
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-card .value { 
            font-size: 1.6rem; 
            font-weight: 600; 
            margin-bottom: 4px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .summary-card .sub { 
            font-size: 0.8rem; 
            color: var(--text-secondary);
        }
        
        /* ==================== CHARTS CONTAINER ==================== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .chart-container {
            background: var(--glass-bg);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            height: 400px;
            border: 1px solid var(--border-color);
            transition: all 0.25s ease;
        }
        
        .chart-container:hover {
            box-shadow: 0 14px 44px var(--shadow-color);
        }
        
        .chart-container.large {
            grid-column: 1 / -1;
            height: 500px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        canvas {
            max-height: 100%;
        }
        
        /* ==================== FORMS ==================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 11px 14px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        .form-group input::placeholder {
            color: var(--text-muted);
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #0a0a0f;
            box-shadow: 0 2px 8px var(--accent-dim);
        }
        
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: var(--accent-glow);
        }
        
        .btn-success {
            background: var(--profit);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(0, 245, 212, 0.25);
        }
        
        .btn-success:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(0, 245, 212, 0.4);
        }
        
        .btn-danger {
            background: var(--loss);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.25);
        }
        
        .btn-danger:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(255, 107, 107, 0.4);
        }
        
        .btn-warning {
            background: var(--warning);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(255, 217, 61, 0.25);
        }
        
        .btn-warning:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(255, 217, 61, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: var(--radius-sm);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 10000;
            opacity: 0;
            transition: all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            border-right: 4px solid var(--accent);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success {
            background: rgba(0, 245, 212, 0.15);
            color: var(--profit);
            border-right-color: var(--profit);
        }
        
        .notification.error {
            background: rgba(255, 107, 107, 0.15);
            color: var(--loss);
            border-right-color: var(--loss);
        }
        
        .notification.warning {
            background: rgba(255, 217, 61, 0.15);
            color: var(--warning);
            border-right-color: var(--warning);
        }
        
        [data-theme="light"] .notification.success {
            background: #ecfdf5;
            color: #065f46;
        }
        
        [data-theme="light"] .notification.error {
            background: #fef2f2;
            color: #991b1b;
        }
        
        [data-theme="light"] .notification.warning {
            background: var(--bg-elevated);
            color: #92400e;
        }
        
        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .theme-toggle {
                top: -10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: 0;
                height: 350px;
            }
            
            .glass {
                padding: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-direction: column;
            }
            
            .nav-link {
                justify-content: center;
            }
        }
        
        /* ==================== TABLES ==================== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-surface);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        thead {
            background: var(--bg-elevated);
        }
        
        thead th {
            padding: 14px 16px;
            text-align: right;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
        
        tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        tbody tr {
            transition: background 0.15s ease;
        }
        
        tbody tr:hover {
            background: var(--bg-hover);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ==================== UTILITY CLASSES ==================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        
        /* Profit/Loss colors */
        .profit, .text-profit, .text-success, .positive { color: var(--profit) !important; }
        .loss, .text-loss, .text-danger, .negative { color: var(--loss) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-info { color: var(--info) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .text-secondary { color: var(--text-secondary) !important; }
        .text-primary { color: var(--text-primary) !important; }
        .text-accent { color: var(--accent) !important; }
        
        /* Font weights */
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        /* Font sizes */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        
        /* ==================== PULSE ANIMATION FOR LIVE DATA ==================== */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    
        .calculator-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .calculator-header h3 {
            margin: 0;
            color: #92400e;
            font-size: 1.5rem;
        }
        
        .calc-input-group {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
        }
        
        .calc-results {
            display: none;
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 20px;
        }
        
        .calc-results.active {
            display: block;
        }
        
        #calc-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-right: 4px solid #667eea;
        }
        
        .calc-item strong {
            color: #111827;
        }
        
        .calc-item span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Calculator card - Dark theme default */
        .calculator-card {
            background: var(--bg-elevated);
            border: 1px solid var(--warning);
        }
        
        .calculator-header h3 {
            color: var(--warning);
        }
        
        .calc-results {
            background: var(--bg-surface);
        }
        
        .calc-item {
            background: var(--bg-hover);
            border-right-color: var(--accent);
        }
        
        .calc-item strong {
            color: var(--text-primary);
        }
        
        /* Modals - Dark theme default */
        [id$="-modal"] > div,
        .modal-box {
            background: var(--bg-surface);
            color: var(--text-primary);
        }
        
        [id$="-modal"] h3 {
            color: var(--text-primary);
        }
        
        [id$="-modal"] label {
            color: var(--text-secondary);
        }
        
        .modal-header,
        .modal-footer {
            border-color: var(--border);
        }
        
        /* Light theme overrides */
        [data-theme="light"] .calculator-card {
            background: var(--bg-elevated);
            border-color: var(--warning);
        }
        
        [data-theme="light"] .calculator-header h3 {
            color: #92400e;
        }
        
        [data-theme="light"] .calc-results {
            background: var(--bg-surface);
        }
        
        [data-theme="light"] .calc-item {
            background: #f9fafb;
        }
        
        [data-theme="light"] .calc-item strong {
            color: #111827;
        }

        /* ==================== ALLOCATION COMPARISON - IMPROVED ==================== */
        .allocation-grid {
            display: grid;
            gap: 12px;
        }
        
        .allocation-row {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .allocation-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .allocation-main {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .allocation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .allocation-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .allocation-numbers {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .allocation-target {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .allocation-actual {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .allocation-actual.balanced { color: var(--profit); }
        .allocation-actual.under { color: var(--warning); }
        .allocation-actual.over { color: var(--loss); }
        
        .allocation-value {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .allocation-progress {
            position: relative;
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: visible;
        }
        
        .allocation-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .allocation-progress-fill.balanced { background: var(--profit); }
        .allocation-progress-fill.under { background: var(--warning); }
        .allocation-progress-fill.over { background: var(--loss); }
        
        .allocation-target-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        .allocation-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .allocation-status.balanced {
            background: rgba(16, 185, 129, 0.15);
            color: var(--profit);
        }
        
        .allocation-status.under {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .allocation-status.over {
            background: rgba(239, 68, 68, 0.15);
            color: var(--loss);
        }
        
        .allocation-status-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }
        
        .allocation-status-text {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .allocation-diff {
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            .allocation-row {
                grid-template-columns: 1fr;
            }
            
            .allocation-status {
                flex-direction: row;
                gap: 10px;
                justify-content: flex-start;
            }
            
            .allocation-numbers {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

    
        /* Snapshot Data Modal */
        #snapshot-data-modal .modal-content {
            direction: rtl;
            text-align: right;
        }
        #snapshot-data-modal input[type="number"] {
            text-align: left;
            direction: ltr;
        }
        #snapshot-data-modal table {
            border-collapse: collapse;
        }
        #snapshot-data-modal th, #snapshot-data-modal td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        /* ==================== MODERN MODAL STYLES ==================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-box {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Form styles inside modals */
        .modal-form-group {
            margin-bottom: 18px;
        }
        
        .modal-form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .modal-form-group input,
        .modal-form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .modal-form-group input:focus,
        .modal-form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* ==================== DARK MODE FIXES ==================== */
        /* Fix hardcoded light backgrounds */
        :root .glass[style*="fef3c7"],
        :root .glass[style*="fee2e2"],
        :root .glass[style*="d1fae5"],
        :root .glass[style*="fecaca"],
        :root .glass[style*="fde68a"],
        :root .glass[style*="a7f3d0"] {
            background: var(--bg-elevated) !important;
            border-color: var(--border) !important;
        }
        
        /* Fix inline colored text */
        [style*="color: var(--profit)"] { color: var(--profit) !important; }
        [style*="color: var(--loss)"] { color: var(--loss) !important; }
        [style*="color: var(--warning)"] { color: var(--warning) !important; }
        
        /* Fix allocation status colors */
        .allocation-status.balanced {
            background: var(--accent-dim);
            color: var(--profit);
        }
        
        .allocation-status.under {
            background: rgba(255, 217, 61, 0.15);
            color: var(--warning);
        }
        
        .allocation-status.over {
            background: rgba(255, 107, 107, 0.15);
            color: var(--loss);
        }
        
        /* Fix chart legends */
        .chart-legend, 
        canvas + div,
        [class*="legend"] {
            color: var(--text-primary) !important;
        }
        
        /* Fix currency legends */
        .currency-legend span,
        .chart-container span {
            color: var(--text-primary) !important;
        }
        
        /* Fix holding rows */
        .holding-row, .bond-row, tr {
            color: var(--text-primary);
        }
        
        /* Fix modal backgrounds */
        .modal-content {
            background: var(--bg-surface) !important;
            border: 1px solid var(--border);
        }
        
        /* Fix input fields */
        input, select, textarea {
            background: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        
        input::placeholder {
            color: var(--text-muted) !important;
        }
        
        /* Fix buttons with inline styles */
        button[style*="background: var(--loss)"] {
            background: var(--loss) !important;
        }
        
        button[style*="background: var(--warning)"] {
            background: var(--warning) !important;
        }
        
        button[style*="background: var(--profit)"] {
            background: var(--profit) !important;
        }
        
        /* Fix light mode overrides */
        [data-theme="light"] .glass[style*="fef3c7"],
        [data-theme="light"] .glass[style*="fee2e2"],
        [data-theme="light"] .glass[style*="d1fae5"] {
            /* Allow original colors in light mode */
            background: inherit !important;
            border-color: inherit !important;
        }
        
        /* ==================== SCROLLBAR ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 180px;
            }
            .main-content {
                margin-right: 180px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                top: auto;
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 8px 12px;
                border-left: none;
                border-top: 1px solid var(--border);
                overflow-x: auto;
            }
            
            .sidebar-logo { display: none; }
            
            .sidebar-nav {
                flex-direction: row;
                gap: 4px;
                overflow-x: auto;
            }
            
            .nav-item {
                padding: 8px 12px;
                flex-direction: column;
                gap: 2px;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            .sidebar-footer { display: none; }
            
            .main-content {
                margin-right: 0;
                padding: 16px;
                padding-bottom: 80px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">注 转拽 砖拽注转</div>
        <div class="loading-subtext"> 转...</div>
    </div>

    <!-- App Container -->
    <div id="mainContent" style="display: none;" class="app-container">
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-logo">
                <span style="font-size: 1.3rem;"></span>
                Portfolio
            </div>
            
            <div class="sidebar-nav">
                <button class="nav-item active" onclick="showTab('overview')">
                    <i data-lucide="layout-dashboard"></i>
                    <span>住</span>
                </button>
                <button class="nav-item" onclick="showTab('portfolio')">
                    <i data-lucide="briefcase"></i>
                    <span>转拽</span>
                </button>
                <button class="nav-item" onclick="showTab('performance')">
                    <i data-lucide="trending-up"></i>
                    <span>爪注</span>
                </button>
                <button class="nav-item" onclick="showTab('planning')">
                    <i data-lucide="calculator"></i>
                    <span>转</span>
                </button>
                <button class="nav-item" onclick="showTab('history')">
                    <i data-lucide="clock"></i>
                    <span>住专</span>
                </button>
                <button class="nav-item" onclick="showTab('settings')">
                    <i data-lucide="settings"></i>
                    <span>专转</span>
                </button>
            </div>
            
            <div class="sidebar-footer">
                <button class="theme-btn" onclick="toggleTheme()">
                    <span id="theme-icon">锔</span>
                    <span>爪 专</span>
                </button>
                <a href="finance.html" class="nav-item" style="margin-top: 8px; text-decoration: none;">
                    <i data-lucide="wallet"></i>
                    <span>注拽 住驻</span>
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Hidden old header -->
            <div class="header" style="display:none;"></div>
            <div class="nav-links" style="display:none;"></div>
            
            <!-- Main Glass Container -->
            <div class="glass">
                <!-- Hidden old tabs (for JS compatibility) -->
                <div class="tabs" style="display:none;">
                    <button class="tab-btn active" onclick="showTab('overview')">住</button>
                    <button class="tab-btn" onclick="showTab('portfolio')">转拽</button>
                    <button class="tab-btn" onclick="showTab('performance')">爪注</button>
                    <button class="tab-btn" onclick="showTab('planning')">转</button>
                    <button class="tab-btn" onclick="showTab('history')">住专</button>
                    <button class="tab-btn" onclick="showTab('settings')">专转</button>
                </div>

                <!-- Sub-Tabs Container (shown dynamically) -->
                <div id="sub-tabs-container" class="sub-tabs" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- ===== TAB: OVERVIEW ===== -->
                <div id="tab-overview" class="tab-content active">
                    <div class="page-header">
                        <h1> 住 转拽 砖拽注转</h1>
                        <p> 注 爪注 转砖转 砖</p>
                    </div>

                    <!-- Main TWR Hero Card -->
                    <div class="summary-grid">
                        <div class="summary-card purple">
                            <h3><i data-lucide="trending-up"></i> 转砖 转 (TWR)</h3>
                            <div class="value" id="main-twr-display">--</div>
                            <div class="sub" id="twr-breakdown">注...</div>
                            <div class="sub" id="twr-period-info" style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                                 转转 转拽
                            </div>
                        </div>

                        <div class="summary-card green">
                            <h3><i data-lucide="dollar-sign"></i> 专/驻住 </h3>
                            <div class="value" id="main-profit-display">0</div>
                            <div class="sub" id="overview-total-deposits">砖拽注: 0</div>
                        </div>

                        <div class="summary-card blue">
                            <h3><i data-lucide="wallet"></i> 砖 </h3>
                            <div class="value" id="total-value">0</div>
                            <div class="sub">住 + </div>
                        </div>
                    </div>

                    <!-- Asset Cards Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Stocks Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #0ea5e9; padding: 20px;">
                            <h3 style="color: #0c4a6e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i> 转
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">砖 </div>
                                <div style="font-size: 2rem; font-weight: bold; color: #0ea5e9;" id="stocks-value">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);" id="stocks-value-original">$0 + 0</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);">拽转</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-count">0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">砖拽注</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-capital">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bonds Card -->
                        <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                            <h3 style="color: #78350f; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="file-text" style="width: 24px; height: 24px;"></i> "
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">砖 </div>
                                <div style="font-size: 2rem; font-weight: bold; color: var(--warning);" id="bonds-value">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);" id="bonds-count">0 拽专转</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);">拽专转</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-count-num">0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">砖拽注</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-cost">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Total Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border: 2px solid #8b5cf6; padding: 20px;">
                            <h3 style="color: #4c1d95; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="wallet" style="width: 24px; height: 24px;"></i> 
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">砖 </div>
                                <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;" id="total-value-2">0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">住 + </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);"> </div>
                                    <div style="font-weight: 600; color: #4c1d95;" id="available-cash-overview">0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">注</div>
                                    <div style="font-weight: 600; color: #4c1d95; font-size: 0.75rem;" id="last-update-time">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Summary -->
                    <div class="glass" style="margin-bottom: 20px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="arrow-right-left"></i> 转专 
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">砖拽注转 转拽</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--profit);" id="total-deposits">0</div>
                            </div>
                            <div style="padding: 15px; background: #fef2f2; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">砖转 转拽</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--loss);" id="total-withdrawals">0</div>
                            </div>
                            <div style="padding: 15px; background: #f0fdf4; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;"> 驻</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;" id="available-cash-summary">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Allocation Comparison -->
                    <div class="glass" style="padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="target"></i> 转 注
                        </h3>
                        <div id="allocation-comparison"></div>
                    </div>

                    <!-- Current Allocation Chart -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="portfolio-chart"></canvas>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button onclick="refreshPrices()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                            <i data-lucide="refresh-cw"></i> 专注 专 转
                        </button>
                        
                        <button onclick="fixGroupIds()" class="btn btn-warning" style="flex: 1; min-width: 200px;">
                            <i data-lucide="wrench"></i> 转拽 拽爪转
                        </button>
                    </div>
                </div>

                <!-- ===== TAB: CHARTS (NEW!) ===== -->
                <div id="tab-charts" class="tab-content">
                    <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 25px;">
                         专驻 转拽
                    </h2>
                    
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem;">
                        注拽  专 爪注 转拽 砖 专 
                    </p>

                    <div class="charts-grid">
                        <!-- Portfolio Value Over Time -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="trending-up"></i>
                                转驻转转 注专 转拽 专 
                            </div>
                            <canvas id="value-over-time-chart"></canvas>
                        </div>

                        <!-- Size vs Return Scatter -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="scatter-chart"></i>
                                 驻爪  转砖
                            </div>
                            <canvas id="gain-loss-chart"></canvas>
                        </div>

                        <!-- Currency Distribution -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="pie-chart"></i>
                                转驻转 注转
                            </div>
                            <canvas id="currency-distribution-chart"></canvas>
                        </div>

                        <!-- Performance Comparison -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="activity"></i>
                                爪注 住转 拽住
                            </div>
                            <canvas id="performance-comparison-chart"></canvas>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                                 砖 转:   拽专  转 砖拽注 拽住 转 转专 住 砖驻拽转 转拽.
                            </div>
                        </div>
                    </div>
                </div>

<div id="tab-analysis" class="tab-content">
                <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 15px;">
                     转 转拽 砖 转拽
                </h2>
                
                <!-- Info Box -->
                <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-right: 4px solid #3b82f6;">
                    <div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.6;">
                         <strong>TWR vs MWR:</strong> 
                        TWR ( 住)  爪注 砖拽  砖驻注转 转 驻拽转. 
                        <strong>MWR</strong> ( ) 砖 转砖 砖转砖转 转 -  驻拽转 住祝 注 /专注.
                    </div>
                </div>

                <!-- KPI Cards Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Sharpe Ratio Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 0.85rem; color: #1e40af; font-weight: 600; margin-bottom: 10px;">Sharpe Ratio</div>
                            <div id="sharpe-ratio" style="font-size: 2.5rem; font-weight: bold; color: #2563eb; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                转砖  住<br>
                                <span style="color: #16a34a;"> 转专 </span>
                            </div>
                        </div>
                    </div>

                    <!-- Max Drawdown Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 0.85rem; color: #991b1b; font-weight: 600; margin-bottom: 10px;">Max Drawdown</div>
                            <div id="max-drawdown" style="font-size: 2.5rem; font-weight: bold; color: #dc2626; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                专 拽住转<br>
                                <span style="color: #16a34a;"> 拽专 -0% 转专 </span>
                            </div>
                        </div>
                    </div>

                    <!-- Volatility Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 10px;">Volatility</div>
                            <div id="volatility" style="font-size: 2.5rem; font-weight: bold; color: #d97706; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                住转 转拽 砖转转<br>
                                <span style="color: #16a34a;"> 驻转 转转</span>
                            </div>
                        </div>
                    </div>

                    <!-- Win Rate Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 0.85rem; color: #065f46; font-weight: 600; margin-bottom: 10px;">Win Rate</div>
                            <div id="win-rate" style="font-size: 2.5rem; font-weight: bold; color: #059669; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                 转 专<br>
                                <span style="color: #16a34a;"> 转专 </span>
                            </div>
                        </div>
                    </div>

                    <!-- MWR Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border: 2px solid #a855f7; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-size: 0.85rem; color: #6b21a8; font-weight: 600; margin-bottom: 10px;">MWR (IRR)</div>
                            <div id="mwr-value" style="font-size: 2.5rem; font-weight: bold; color: #9333ea; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                转砖 砖拽转 住祝<br>
                                <span style="color: #16a34a;"> timing</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Treemap Section -->
                <div class="glass" style="padding: 25px;">
                    <h3 style="text-align: center; color: var(--text-primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5rem;"></span>
                        <span>驻转 转拽 (Treemap)</span>
                    </h3>
                    <div style="text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 20px;">
                         = 砖拽 转拽 | 爪注 = 专/驻住
                    </div>
                    <div id="treemap-container" style="width: 100%; height: 500px; position: relative; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: #f9fafb;">
                        <!-- Treemap will be drawn here -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary);">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--profit); border-radius: 4px;"></div>
                            <span>专</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--text-muted); border-radius: 4px;"></div>
                            <span>专</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--loss); border-radius: 4px;"></div>
                            <span>驻住</span>
                        </div>
                    </div>
                </div>

            </div>



                <!-- ===== PLACEHOLDER FOR OTHER TABS ===== -->
                
<!-- Holdings Tab -->
            
<div id="tab-calculator" class="tab-content">
                <div class="calculator-card">
                    <div class="calculator-header">
                        <span style="font-size: 2rem;">М</span>
                        <h3>砖 拽转 砖拽注</h3>
                    </div>
                    
                    <p style="color: #92400e; margin-bottom: 20px;">
                         住 砖转 专爪 砖拽注 注专转 转砖   拽 转  转 注 驻 驻注专 注
                    </p>

                    <div class="calc-input-group">
                        <div class="form-group" style="flex: 1;">
                            <label>住 砖拽注 ()</label>
                            <input type="number" id="invest-amount" placeholder="10000" step="100">
                        </div>
                        <button onclick="console.log(' BUTTON CLICKED!'); try { calculateInvestment(); } catch(e) { console.error(' Error:', e); }" class="btn btn-success">
                             砖 拽
                        </button>
                    </div>

                    <div id="calc-results" class="calc-results">
                        <h4 style="margin-bottom: 15px; color: #111827;"> 爪转 拽:</h4>
                        <div id="calc-items"></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>住":</span>
                                <span id="calc-total" style="color: var(--accent); font-size: 1.2rem;">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">癸   注?</h4>
                    <ul style="color: #1e3a8a; line-height: 1.8;">
                        <li>注专转 砖转 转 驻注专 砖  拽爪 注 砖</li>
                        <li>拽爪转 注 驻注专  转专 拽转 转专 住祝</li>
                        <li>转  拽爪, 砖拽注 转拽转 驻 砖  转</li>
                        <li> 注专  砖专 注 转 专爪 专 </li>
                    </ul>
                </div>
            </div>

            
<div id="tab-holdings" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddHoldingForm()" class="btn btn-success"> 住祝 拽</button>
                    <button onclick="refreshPrices()" class="btn btn-primary"> 专注 专</button>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.5rem;"></span>
                        <div>
                            <strong style="color: #1e40af;">专转 注专 砖专:</strong>
                            <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 0.9rem;">
                                住驻专 专转 注专 砖专 (7 住驻专转, : 1209220), <strong> 转 住驻专</strong>. 注专转 转住 砖 专 专住.
                            </p>
                            <div style="margin: 8px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <p style="margin: 0; color: #92400e; font-size: 0.85rem;">
                                    锔 <strong>砖:</strong> 砖转 专 转 专住 砖专转  转 注转 ( 转 转).
                                </p>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.85rem;">
                                 <strong>爪:</strong> 
                            </p>
                            <ol style="margin: 5px 0 0 20px; color: #1e3a8a; font-size: 0.85rem; line-height: 1.6;">
                                <li>专 <strong>"拽专 驻"</strong> ( 砖 - : VWRL.L 转注转 住)</li>
                                <li> 砖转砖 驻转专 <strong>" 专"</strong> 注 转</li>
                                <li>注 专 转 <a href="https://www.tase.co.il" target="_blank" style="color: var(--accent);">转专 专住</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="add-holding-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                    <h3 style="margin-bottom: 20px;">住祝 拽 砖</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>住 / 住' 专 注专 (砖: AAPL, 1209220)</label>
                            <input type="text" id="new-symbol" placeholder="AAPL">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">专转 砖专:  住驻专 专 注专  7 住驻专转</small>
                        </div>
                        <div class="form-group">
                            <label>拽专 驻 ( - 驻爪)</label>
                            <input type="text" id="new-alt-ticker" placeholder="VWRL.L">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">  砖 专住 砖专转  注转</small>
                        </div>
                        <div class="form-group">
                            <label>住驻专 转</label>
                            <input type="number" id="new-shares" placeholder="10" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>专 拽 爪注</label>
                            <input type="number" id="new-cost" placeholder="150.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>注 (驻爪)</label>
                            <input type="number" id="new-commission" placeholder="0" step="0.01" value="0">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">注转 拽 - 转转住祝 专</small>
                        </div>
                        <div class="form-group">
                            <label>注</label>
                            <select id="new-currency">
                                <option value="ILS"> 砖拽</option>
                                <option value="USD">$ 专</option>
                                <option value="EUR"> 专</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label> 转专 拽</label>
                            <input type="date" id="new-purchase-date" style="direction: ltr;">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">砖专 专拽 转专 </small>
                        </div>
                        <div class="form-group">
                            <label>拽爪</label>
                            <select id="new-group"></select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addHolding()" class="btn btn-success"> 砖专</button>
                        <button onclick="hideAddHoldingForm()" class="btn" style="background: var(--text-muted); color: white;"> </button>
                    </div>
                </div>

                <div id="holdings-list" class="holdings-grid"></div>
            </div>

            <!-- Bonds Tab -->
            <div id="tab-bonds" class="tab-content">
                <h3 style="margin-bottom: 20px;"> 拽专转 "</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddBondForm()" class="btn btn-success"> 住祝 拽专 "</button>
                    <button onclick="refreshBondPrices()" class="btn btn-primary"> 专注 专</button>
                </div>

                <!-- Add Bond Form -->
                <div id="add-bond-form" style="display: none; margin-bottom: 30px;" class="glass">
                    <h4 style="margin-bottom: 15px;">住祝/注专 拽专 "</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>住驻专 专 注专 / 住</label>
                            <input type="text" id="bond-symbol" placeholder="1234567">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">专转 砖专:  住驻专 专 注专  7 住驻专转</small>
                        </div>
                        <div class="form-group">
                            <label>拽专 驻 ( - 驻爪)</label>
                            <input type="text" id="bond-alt-ticker" placeholder="BOND.TA">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">  砖 专住  注转</small>
                        </div>
                        <div class="form-group">
                            <label>转 转</label>
                            <input type="number" id="bond-units" step="0.001" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label>专 拽 </label>
                            <input type="number" id="bond-cost" step="0.01" placeholder="100.00">
                        </div>
                        <div class="form-group">
                            <label>注 (驻爪)</label>
                            <input type="number" id="bond-commission" step="0.01" placeholder="0" value="0">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">注转 拽 - 转转住祝 专</small>
                        </div>
                        <div class="form-group">
                            <label>转专 拽</label>
                            <input type="date" id="bond-purchase-date">
                        </div>
                        <div class="form-group">
                            <label>注</label>
                            <select id="bond-currency">
                                <option value="ILS"> 砖拽 (ILS)</option>
                                <option value="USD">$ 专 (USD)</option>
                                <option value="EUR"> 专 (EUR)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="saveBond()" class="btn btn-success"> 砖专</button>
                        <button onclick="hideAddBondForm()" class="btn" style="background: var(--text-muted);"></button>
                    </div>
                </div>

                <!-- Bonds List -->
                <div id="bonds-list"></div>
            </div>

            <!-- Groups Tab -->
            <div id="tab-groups" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">拽爪转 砖拽注 砖</h3>
                    <button onclick="addGroup()" class="btn btn-success" style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 1.2rem;">+</span> 住祝 拽爪
                    </button>
                </div>
                <div id="groups-list" class="groups-list"></div>
            </div>

            <!-- Recommendations Tab -->
            <div id="tab-recommendations" class="tab-content">
                <h3 style="margin-bottom: 20px;"> 爪转  转拽</h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <h3 style="margin-bottom: 20px;"> 住专转 注住拽转</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="filterTransactions('all')" class="btn btn-primary" id="filter-all"></button>
                    <button onclick="filterTransactions('deposits')" class="btn" id="filter-deposits">驻拽转</button>
                    <button onclick="filterTransactions('withdrawals')" class="btn" id="filter-withdrawals">砖转</button>
                    <button onclick="filterTransactions('purchases')" class="btn" id="filter-purchases">拽转</button>
                    <button onclick="filterTransactions('sales')" class="btn" id="filter-sales">专转</button>
                </div>
                
                <div class="glass">
                    <div id="transactions-list"></div>
                </div>
            </div>

            <!-- Capital Tab -->
            <!-- Cash Flow Tab -->
            <div id="tab-cashflow" class="tab-content">
                <h3 style="margin-bottom: 20px;"> 转专 住驻</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showDepositModal()" class="btn btn-success"> 驻拽</button>
                    <button onclick="showWithdrawalModal()" class="btn" style="background: var(--loss); color: white;"> 砖</button>
                </div>
                
                <!-- Cash Balances Container -->
                <div id="cash-balances-container"></div>
                
                <!-- Deposits -->
                <div class="glass" style="margin-bottom: 20px; background: var(--bg-elevated);">
                    <h4 style="margin-bottom: 15px; color: #065f46;"> 驻拽转</h4>
                    <div id="deposits-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: var(--bg-surface); border-radius: 8px; text-align: center;">
                        <strong style="color: var(--profit);">住" 驻拽转: <span id="total-deposits">0</span></strong>
                    </div>
                </div>
                
                <!-- Withdrawals -->
                <div class="glass" style="margin-bottom: 20px; background: var(--bg-elevated);">
                    <h4 style="margin-bottom: 15px; color: #7f1d1d;"> 砖转</h4>
                    <div id="withdrawals-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: var(--bg-surface); border-radius: 8px; text-align: center;">
                        <strong style="color: var(--loss);">住" 砖转: <span id="total-withdrawals">0</span></strong>
                    </div>
                </div>
                

            </div>
            
            <!-- Performance Tab -->
            <!-- Deposit Modal -->
            <div id="deposit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 驻拽 转拽</h3>
                    
                    <div class="form-group">
                        <label>住 驻拽 ()</label>
                        <input type="number" id="deposit-amount" placeholder="10000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 驻拽</label>
                        <input type="date" id="deposit-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>注专 (驻爪)</label>
                        <input type="text" id="deposit-note" placeholder="砖拽注 砖转">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideDepositModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitDeposit()" class="btn btn-success">砖专 驻拽</button>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Modal -->
            <div id="withdrawal-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 砖 转拽</h3>
                    
                    <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
                        <div style="font-size: 0.9rem; color: #1e40af;">  砖: <strong><span id="withdrawal-max">0</span></strong></div>
                    </div>
                    
                    <div class="form-group">
                        <label>住 砖 ()</label>
                        <input type="number" id="withdrawal-amount" placeholder="5000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 砖</label>
                        <input type="date" id="withdrawal-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>注专 (驻爪)</label>
                        <input type="text" id="withdrawal-note" placeholder="专">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideWithdrawalModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitWithdrawal()" class="btn" style="background: var(--loss); color: white;">砖专 砖</button>
                    </div>
                </div>
            </div>

            <!-- Add Bond Units Modal -->
            <div id="add-bond-units-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 住祝 转 "</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="add-bond-symbol"></strong><br>
                            转 转: <strong id="add-bond-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>转 转 住驻</label>
                        <input type="number" id="add-bond-quantity" placeholder="100" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>专 拽 </label>
                        <input type="number" id="add-bond-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>注 (驻爪)</label>
                        <input type="number" id="add-bond-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">注转 拽 - 转转住祝 专</small>
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 拽</label>
                        <input type="date" id="add-bond-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideAddBondUnitsModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitAddBondUnits()" class="btn btn-success"> 住祝 转</button>
                    </div>
                </div>
            </div>

            <!-- Sell Bond Units Modal -->
            <div id="sell-bond-units-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 专 转 "</h3>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="sell-bond-symbol"></strong><br>
                            转 转: <strong id="sell-bond-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>转 转 专</label>
                        <input type="number" id="sell-bond-quantity" placeholder="100" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>专 专 </label>
                        <input type="number" id="sell-bond-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 专</label>
                        <input type="date" id="sell-bond-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideSellBondUnitsModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitSellBondUnits()" class="btn" style="background: var(--warning); color: white;"> 专</button>
                    </div>
                </div>
            </div>

            <!-- Sell Shares Modal -->
            <div id="sell-shares-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 专 转</h3>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="sell-shares-symbol"></strong><br>
                            拽 转: <strong id="sell-shares-current"></strong><br>
                            专 爪注: <strong id="sell-shares-avg-cost"></strong><br>
                            专 : <strong id="sell-shares-current-price"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>转 转 专</label>
                        <input type="number" id="sell-shares-quantity" placeholder="10" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>专 专 </label>
                        <input type="number" id="sell-shares-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 专</label>
                        <input type="date" id="sell-shares-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label>注 (驻爪)</label>
                        <input type="number" id="sell-shares-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">注转 专 - 转驻转 转专</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideSellSharesModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitSellShares()" class="btn" style="background: var(--warning); color: white;"> 专</button>
                    </div>
                </div>
            </div>

            <!-- Add Shares Modal -->
            <div id="add-shares-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 住祝 转 驻爪 拽转</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="add-shares-symbol"></strong><br>
                            拽 转: <strong id="add-shares-current"></strong><br>
                            专 爪注: <strong id="add-shares-avg-cost"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>转 转 住驻</label>
                        <input type="number" id="add-shares-quantity" placeholder="10" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>专 拽 </label>
                        <input type="number" id="add-shares-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>注 (驻爪)</label>
                        <input type="number" id="add-shares-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">注转 拽 - 转转住祝 专</small>
                    </div>
                    
                    <div class="form-group">
                        <label> 转专 拽</label>
                        <input type="date" id="add-shares-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideAddSharesModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitAddShares()" class="btn btn-success"> 住祝 转</button>
                    </div>
                </div>
            </div>

            <!-- Edit Transaction Date Modal -->
            <div id="edit-date-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;"> 注专转 转专 注住拽</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            住 注住拽: <strong id="edit-date-type"></strong><br>
                            转专 : <strong id="edit-date-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>转专 砖</label>
                        <input type="date" id="edit-date-new" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideEditDateModal()" class="btn" style="background: var(--text-muted);"></button>
                        <button onclick="submitEditDate()" class="btn btn-success"> 砖专 砖</button>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">锔 专转</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;"> 砖注专 专</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                         <strong>注专 转 砖注专 转</strong>  住 专注 
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>专 ($) 砖拽</label>
                            <input type="number" id="rate-usd" step="0.0001" value="3.7500" 
                                   placeholder="3.7500" 
                                   style="background: var(--bg-elevated); border: 1px solid var(--border);">
                        </div>
                        <div class="form-group">
                            <label>专 () 砖拽</label>
                            <input type="number" id="rate-eur" step="0.0001" value="4.0500" 
                                   placeholder="4.0500"
                                   style="background: var(--bg-elevated); border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="tryAutoUpdateRates()" class="btn btn-primary">
                             专注 转
                        </button>
                        <button onclick="updateExchangeRates()" class="btn btn-success">
                             砖专 砖注专
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.8rem;">
                         专注  住 砖 砖注专 专.    注, 注专 转 -<a href="https://www.boi.org.il/he/markets/exchangerates/" target="_blank" style="color: var(--accent);">拽 砖专</a>
                    </p>
                </div>

                <div class="glass">
                    <h4 style="margin-bottom: 15px;">  砖专</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportData()" class="btn btn-primary"> 爪 转</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                              转
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
                
                <div class="glass" style="border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: var(--warning);"> 转拽 TWR</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                         TWR  注,   snapshots 砖. 抓  拽 snapshots 砖 爪专 砖.
                    </p>
                    <button onclick="fixSnapshots()" class="btn" style="background: var(--warning); color: white;">
                         转拽 Snapshots (驻住 专)
                    </button>
                </div>
                
                <div class="glass" style="border: 2px solid #8b5cf6;">
                    <h4 style="margin-bottom: 15px; color: #8b5cf6;">  砖 住专</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        <strong>驻转专 拽祝:</strong> 驻拽爪  注专转 注  驻注转 (驻拽转, 砖转, 拽转, 专转) 转 注 住祝 住专 专,  砖 转 -snapshots 砖  爪专 .
                        <br><br>
                         <strong>转 砖转砖?</strong>  转 转 砖, 住驻转 驻注转 驻专注,  砖砖 -转转 砖.
                    </p>
                    <button onclick="rebuildSnapshotsFromHistory()" class="btn" style="background: var(--accent); color: white;">
                          砖 住专转 驻注转
                    </button>
                </div>
                
                <div class="glass" style="border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: var(--loss);">锔 专 住</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        锔 <strong>驻注 转 驻!</strong> 拽转  转 转拽 爪转转 转  转, ", 驻拽转, 砖转 注住拽转.
                    </p>
                    <button onclick="deleteAllData()" class="btn" style="background: var(--loss); color: white;">
                        锔 拽 转  转
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End mainContent -->
<div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Import
        import { auth, db, onAuthStateChanged, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from './firebase-config.js';

        // Auth check
        let currentUser = null;
        let authChecked = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log(' User authenticated:', user.email);
                if (!authChecked) {
                    authChecked = true;
                    init();
                }
            } else {
                if (authChecked) {
                    window.location.href = '/index.html';
                } else {
                    setTimeout(() => {
                        if (!currentUser) window.location.href = '/index.html';
                    }, 2000);
                }
            }
        });

        // =========================================== 
        // DATA STRUCTURE - ENHANCED
        // ===========================================
        
        let editingHoldingId = null; // Track which holding is being edited
        
        
        //  转 转拽 拽住 - 2025-10-30T22:36:57.557729
        //  6 转/拽专转 | 2 "
        //  转专转: 36.90 + $27.08
        // [REMOVED] let portfolio = {} - 住专   专住 转 转 -IIFE
        // portfolio 注 -localStorage 注  loadData()
        let portfolio = {};  // 祝 loadData


        // ============================================
        // [DISABLED] FORCE SAVE - DO NOT OVERWRITE USER DATA
        // ============================================
        // 住拽专驻  砖转   专住 转 砖 砖转砖
        /*
        console.log(' 驻 砖专转 转 砖 -localStorage...');
        localStorage.setItem('portfolio', JSON.stringify(portfolio));
        console.log(' 转 砖 砖专 !');
        console.log('   - IBI 专转 转拽 (拽 -100)');
        console.log('   - 砖转 转拽 (拽 -100)');
        console.log('   - 砖转: ' + portfolio.withdrawals.length);
        console.log('   - 专转: ' + portfolio.sales.length);
        */


        let charts = {};

        // ===========================================
        // TWR ENHANCEMENT v45 - Multi-Currency Cash Tracking
        // ===========================================
        
        // 专转 注转
        const FEE_CONFIG = {
            USD: 5,    // $5 注住拽 专转
            EUR: 20,   // 20 注住拽 专
            ILS: 0,    //  注 砖拽转
            
            // 转 注 注 专转
            USD_FEE_SYMBOLS: ['USSC.L', 'MARA', 'LUMN', 'NVDA', 'AVGS.L'],
            
            // 转 注 注 专 (专拽 拽转!)
            EUR_FEE_SYMBOLS: ['ZPRX.DE', 'AVWS.DE'],
            
            // 转 砖拽 专砖 专  注
            FIRST_PURCHASE_FEE_INCLUDED: ['USSC.L']
        };

        // 驻转 注 驻 住
        const CURRENCY_MAP = {
            'USSC.L': 'USD', 'AVGS.L': 'USD',
            'AVWS.DE': 'EUR', 'ZPRX.DE': 'EUR',
            'NVDA': 'USD', 'MAGS': 'USD', 'IBIT': 'USD', 'ETHA': 'USD', 'TSLA': 'USD',
            'MARA': 'USD', 'NNE': 'USD', 'OKLO': 'USD', 'PLTR': 'USD', 'SFM': 'USD',
            'FLEX': 'USD', 'AMD': 'USD', 'APP': 'USD', 'AAPL': 'USD', 'GOOGL': 'USD',
            'TEM': 'USD', 'OPEN': 'USD', 'RKT': 'USD', 'LUMN': 'USD'
        };

        // " 转转 (专 )
        const REAL_BONDS = new Set(['5139522', '2310449']);

        /**
         * 拽转 注 住 驻 住
         */
        function getAssetCurrency(symbol) {
            if (!symbol) return 'ILS';
            if (/^\d{7}$/.test(symbol)) return 'ILS';
            return CURRENCY_MAP[symbol] || 'USD';
        }

        /**
         * 拽  住  " 转转
         */
        function isRealBond(symbol) {
            return REAL_BONDS.has(symbol);
        }

        /**
         * 砖 注 注住拽
         */
        function calculateFeeForTransaction(symbol, transactionType, purchaseCountForSymbol = 0) {
            const currency = getAssetCurrency(symbol);
            
            if (transactionType === 'sell') {
                return { fee: 0, feeCurrency: null };
            }
            
            if (symbol === 'USSC.L' && purchaseCountForSymbol === 0) {
                return { fee: 0, feeCurrency: null };
            }
            
            if (currency === 'USD' && FEE_CONFIG.USD_FEE_SYMBOLS.includes(symbol)) {
                return { fee: FEE_CONFIG.USD, feeCurrency: 'USD' };
            }
            if (currency === 'EUR' && FEE_CONFIG.EUR_FEE_SYMBOLS.includes(symbol)) {
                return { fee: FEE_CONFIG.EUR, feeCurrency: 'EUR' };
            }
            
            return { fee: 0, feeCurrency: null };
        }

        /**
         * 转  驻 注
         */
        function initializeCash() {
            if (!portfolio.cash || typeof portfolio.cash !== 'object') {
                portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            }
            if (portfolio.cash.EUR === undefined) {
                portfolio.cash.EUR = 0;
            }
        }

        /**
         * 拽转 住  砖拽
         */
        function getTotalCashILS(rates = null) {
            initializeCash();
            const r = rates || portfolio.rates;
            return (portfolio.cash.ILS || 0) + 
                   (portfolio.cash.USD || 0) * (r.USD || 3.6) + 
                   (portfolio.cash.EUR || 0) * (r.EUR || 4.0);
        }

        /**
         * 专 砖拽 驻 砖注专 转
         */
        
        // =============================================================================
        // TWR COMPLETE SYSTEM v3.0 - INSERTED
        // =============================================================================
        
        // =============================================================================
// TWR COMPLETE SYSTEM v3.0
// 注专转  砖 转砖 砖拽转 
// - 砖专转 注住拽转 注 拽专 
// - Modal 住祝 专 砖注专 注转 爪专转 snapshot
// - 砖 TWR 拽
// =============================================================================

// -----------------------------------------------------------------------------
// SNAPSHOT DATA MODAL - Modal 住祝 转
// -----------------------------------------------------------------------------

/**
 * Open modal to collect historical prices and rates for snapshot
 * @param {string} triggerType - 'deposit' or 'withdrawal'
 * @param {number} cashFlowILS - The cash flow amount in ILS
 * @param {string} date - The date for the snapshot
 * @param {string} note - Description
 * @param {Function} onComplete - Callback after snapshot created
 */

/**
 * Fill current prices in the modal (for when prices haven't changed much)
 */
async function fillCurrentPrices() {
    console.log(' Filling current prices...');
    notify(' 注 专 ...', 'info');
    
    const data = window._snapshotModalData;
    if (!data) return;
    
    try {
        // Refresh rates
        await loadRates();
        document.getElementById('snapshot-rate-usd').value = portfolio.rates?.USD?.toFixed(4) || '3.7';
        document.getElementById('snapshot-rate-eur').value = portfolio.rates?.EUR?.toFixed(4) || '4.0';
        
        // Fill holding prices
        for (let i = 0; i < data.activeHoldings.length; i++) {
            const h = data.activeHoldings[i];
            const input = document.getElementById(`snapshot-price-holding-${i}`);
            if (input) {
                // Try to get fresh price
                try {
                    const price = await fetchStockPrice(h.symbol);
                    if (price && price > 0) {
                        input.value = price.toFixed(2);
                        console.log(` ${h.symbol}: ${price}`);
                    }
                } catch (e) {
                    // Use current price from portfolio
                    input.value = h.currentPrice || h.costBasis || '';
                }
            }
        }
        
        // Fill bond prices
        for (let i = 0; i < data.activeBonds.length; i++) {
            const b = data.activeBonds[i];
            const input = document.getElementById(`snapshot-price-bond-${i}`);
            if (input) {
                try {
                    const price = await fetchBondPrice(b.symbol);
                    if (price && price > 0) {
                        input.value = price.toFixed(2);
                        console.log(` ${b.symbol}: ${price}`);
                    }
                } catch (e) {
                    input.value = b.currentPrice || b.costBasis || '';
                }
            }
        }
        
        // Recalculate total
        recalculateSnapshotValue();
        notify(' 专 注', 'success');
        
    } catch (error) {
        console.error('Error filling prices:', error);
        notify('锔 拽 专  注', 'warning');
    }
}

/**
 * Fetch daily prices from Firebase for a specific date
 * @param {string} date - Date in ISO format
 * @returns {Object|null} - Prices object or null if not found
 */
async function fetchDailyPricesFromFirebase(date) {
    try {
        const dateStr = new Date(date).toISOString().split('T')[0];
        console.log(` Fetching daily prices for ${dateStr}...`);
        
        const priceDocRef = doc(db, 'dailyPrices', dateStr);
        const priceDocSnap = await getDoc(priceDocRef);
        
        if (priceDocSnap.exists()) {
            const data = priceDocSnap.data();
            console.log(` Found prices for ${dateStr}:`, data.prices);
            return data.prices;
        } else {
            console.log(`锔 No prices found for ${dateStr}`);
            return null;
        }
    } catch (error) {
        console.error(' Error fetching daily prices:', error);
        return null;
    }
}

/**
 * Delete old daily prices from Firebase (before a given date)
 * @param {string} beforeDate - Delete prices before this date (inclusive)
 */
async function deleteOldDailyPrices(beforeDate) {
    try {
        const beforeDateStr = new Date(beforeDate).toISOString().split('T')[0];
        console.log(`锔 Deleting daily prices up to ${beforeDateStr}...`);
        
        const dailyPricesRef = collection(db, 'dailyPrices');
        const snapshot = await getDocs(dailyPricesRef);
        
        let deletedCount = 0;
        for (const docSnap of snapshot.docs) {
            const docDate = docSnap.id; // Document ID is the date string
            if (docDate <= beforeDateStr) {
                await deleteDoc(doc(db, 'dailyPrices', docDate));
                console.log(`   锔 Deleted ${docDate}`);
                deletedCount++;
            }
        }
        
        console.log(` Deleted ${deletedCount} old price records`);
        return deletedCount;
    } catch (error) {
        console.error(' Error deleting old daily prices:', error);
        return 0;
    }
}

/**
 * Fill snapshot modal with prices from dailyPrices
 * @param {Object} prices - Prices object from Firebase
 * @param {Array} activeHoldings - Active holdings at the date
 * @param {Array} activeBonds - Active bonds at the date
 */
function fillModalWithDailyPrices(prices, activeHoldings, activeBonds) {
    if (!prices) return;
    
    let filledCount = 0;
    
    // Fill holdings prices
    activeHoldings.forEach((h, i) => {
        const input = document.getElementById(`snapshot-price-holding-${i}`);
        if (input && prices[h.symbol]) {
            input.value = prices[h.symbol].price;
            input.style.backgroundColor = '#d1fae5'; // Light green to indicate auto-filled
            filledCount++;
            console.log(`    Filled ${h.symbol}: ${prices[h.symbol].price}`);
        }
    });
    
    // Fill bonds prices
    activeBonds.forEach((b, i) => {
        const input = document.getElementById(`snapshot-price-bond-${i}`);
        const symbol = b.symbol || b.securityNumber;
        if (input && symbol && prices[symbol]) {
            input.value = prices[symbol].price;
            input.style.backgroundColor = '#d1fae5';
            filledCount++;
            console.log(`    Filled ${symbol}: ${prices[symbol].price}`);
        }
    });
    
    if (filledCount > 0) {
        notify(` 注 ${filledCount} 专 转`, 'success');
        // Recalculate value after filling
        setTimeout(recalculateSnapshotValue, 100);
    }
}

function openSnapshotDataModal(triggerType, cashFlowILS, date, note, onComplete) {
    console.log(' openSnapshotDataModal called:', { triggerType, cashFlowILS, date, note });
    
    try {
        // Get active holdings at this date
        const activeHoldings = getActiveHoldingsAtDate(date);
        const activeBonds = getActiveBondsAtDate(date);
        console.log(' Active holdings:', activeHoldings.length, 'Active bonds:', activeBonds.length);
    
    // Create modal HTML
    const modalHTML = `
        <div id="snapshot-data-modal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999;">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3> 转 爪专转 Snapshot</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    ${triggerType === 'deposit' ? '驻拽' : '砖'}: ${Math.abs(cashFlowILS).toLocaleString()} | 
                    转专: ${new Date(date).toLocaleDateString('he-IL')}
                </p>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;"> 砖注专 注</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label>USD  ILS</label>
                            <input type="number" id="snapshot-rate-usd" step="0.01" placeholder="3.70" value="${portfolio.rates?.USD || 3.7}">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>EUR  ILS</label>
                            <input type="number" id="snapshot-rate-eur" step="0.01" placeholder="4.00" value="${portfolio.rates?.EUR || 4.0}">
                        </div>
                    </div>
                    <button onclick="fetchHistoricalRatesForModal('${date}')" class="btn" style="margin-top: 10px; background: var(--info);">
                          砖注专 转
                    </button>
                    <button onclick="fillCurrentPrices()" class="btn" style="margin-top: 10px; margin-right: 10px; background: var(--profit);">
                          专 
                    </button>
                </div>
                
                ${activeHoldings.length > 0 ? `
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;"> 专 转</h4>
                    <table style="width: 100%; font-size: 14px;">
                        <thead>
                            <tr style="text-align: right;">
                                <th>住</th>
                                <th>转</th>
                                <th>注</th>
                                <th>专</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeHoldings.map((h, i) => `
                                <tr>
                                    <td><strong>${h.symbol}</strong></td>
                                    <td>${h.shares}</td>
                                    <td>${h.currency}</td>
                                    <td>
                                        <input type="number" 
                                               id="snapshot-price-holding-${i}" 
                                               data-holding-id="${h.id}"
                                               data-currency="${h.currency}"
                                               step="0.01" 
                                               value="${h.currentPrice || h.costBasis || ''}"
                                               style="width: 80px;">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                
                ${activeBonds.length > 0 ? `
                <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;"> 专 "</h4>
                    <table style="width: 100%; font-size: 14px;">
                        <thead>
                            <tr style="text-align: right;">
                                <th>砖</th>
                                <th>转</th>
                                <th>注</th>
                                <th>专</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeBonds.map((b, i) => `
                                <tr>
                                    <td><strong>${b.symbol}</strong></td>
                                    <td>${b.units}</td>
                                    <td>${b.currency || 'ILS'}</td>
                                    <td>
                                        <input type="number" 
                                               id="snapshot-price-bond-${i}" 
                                               data-bond-id="${b.id}"
                                               data-currency="${b.currency || 'ILS'}"
                                               step="0.01" 
                                               value="${b.currentPrice || b.costBasis || ''}"
                                               style="width: 80px;">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                
                <div style="background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;"> </h4>
                    <div id="snapshot-cash-display">
                        ${Object.entries(portfolio.cash || {}).map(([curr, amount]) => 
                            amount !== 0 ? `<div>${curr}: ${amount.toLocaleString()}</div>` : ''
                        ).join('')}
                    </div>
                </div>
                
                <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0;"> 砖 砖: <span id="snapshot-calculated-value">0</span></h4>
                    <button onclick="recalculateSnapshotValue()" class="btn" style="margin-top: 10px; background: #6366f1;">
                         砖 砖
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="cancelSnapshotModal()" class="btn" style="background: var(--text-muted);"></button>
                    <button onclick="confirmSnapshotData()" class="btn btn-success"> 砖专 爪专转 Snapshot</button>
                </div>
            </div>
        </div>
    `;
    
    // Store callback and data for later use
    window._snapshotModalData = {
        triggerType,
        cashFlowILS,
        date,
        note,
        onComplete,
        activeHoldings,
        activeBonds
    };
    
    // Add modal to page
    const modalContainer = document.createElement('div');
    modalContainer.id = 'snapshot-modal-container';
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    console.log(' Modal added to page');
    
    // Calculate initial value
    setTimeout(recalculateSnapshotValue, 100);
    
    // Try to fetch prices from dailyPrices collection
    const dateStr = new Date(date).toISOString().split('T')[0];
    fetchDailyPricesFromFirebase(date).then(prices => {
        if (prices) {
            console.log(' Auto-filling prices from dailyPrices...');
            fillModalWithDailyPrices(prices, activeHoldings, activeBonds);
        } else {
            console.log('癸 No saved prices for this date, user will enter manually');
        }
    });
    } catch (error) {
        console.error(' Error in openSnapshotDataModal:', error);
        notify(' 砖 驻转转  转', 'error');
    }
}

/**
 * Get holdings that existed at a specific date
 */
function getActiveHoldingsAtDate(date) {
    if (!Array.isArray(portfolio.holdings)) return [];
    
    const targetDate = new Date(date);
    
    return portfolio.holdings.filter(h => {
        // If holding has purchaseDate, check if it was before target date
        if (h.purchaseDate) {
            return new Date(h.purchaseDate) <= targetDate;
        }
        // If no purchaseDate, assume it exists
        return true;
    });
}

/**
 * Get bonds that existed at a specific date
 */
function getActiveBondsAtDate(date) {
    if (!Array.isArray(portfolio.bonds)) return [];
    
    const targetDate = new Date(date);
    
    return portfolio.bonds.filter(b => {
        if (b.purchaseDate) {
            return new Date(b.purchaseDate) <= targetDate;
        }
        return true;
    });
}

/**
 * Fetch historical rates and populate modal
 */
async function fetchHistoricalRatesForModal(date) {
    try {
        const dateStr = new Date(date).toISOString().split('T')[0];
        const response = await fetch(`https://api.frankfurter.app/${dateStr}?from=ILS`);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.rates.USD) {
                document.getElementById('snapshot-rate-usd').value = (1 / data.rates.USD).toFixed(4);
            }
            if (data.rates.EUR) {
                document.getElementById('snapshot-rate-eur').value = (1 / data.rates.EUR).toFixed(4);
            }
            
            notify(' 砖注专  爪', 'success');
            recalculateSnapshotValue();
        } else {
            notify('锔  爪转  砖注专', 'error');
        }
    } catch (error) {
        console.error('Error fetching rates:', error);
        notify('锔 砖 转 砖注专', 'error');
    }
}

/**
 * Recalculate portfolio value based on modal inputs
 */
function recalculateSnapshotValue() {
    const data = window._snapshotModalData;
    if (!data) return;
    
    const rates = {
        USD: parseFloat(document.getElementById('snapshot-rate-usd').value) || 3.7,
        EUR: parseFloat(document.getElementById('snapshot-rate-eur').value) || 4.0,
        ILS: 1
    };
    
    let totalValue = 0;
    
    // Holdings
    data.activeHoldings.forEach((h, i) => {
        const priceInput = document.getElementById(`snapshot-price-holding-${i}`);
        if (priceInput) {
            const price = parseFloat(priceInput.value) || 0;
            const currency = h.currency || 'ILS';
            const valueInCurrency = h.shares * price;
            const valueInILS = currency === 'ILS' ? valueInCurrency : valueInCurrency * (rates[currency] || 1);
            totalValue += valueInILS;
        }
    });
    
    // Bonds
    data.activeBonds.forEach((b, i) => {
        const priceInput = document.getElementById(`snapshot-price-bond-${i}`);
        if (priceInput) {
            const price = parseFloat(priceInput.value) || 0;
            const currency = b.currency || 'ILS';
            const valueInCurrency = b.units * price;
            const valueInILS = currency === 'ILS' ? valueInCurrency : valueInCurrency * (rates[currency] || 1);
            totalValue += valueInILS;
        }
    });
    
    // Cash
    if (portfolio.cash) {
        for (const [currency, amount] of Object.entries(portfolio.cash)) {
            if (typeof amount === 'number') {
                totalValue += currency === 'ILS' ? amount : amount * (rates[currency] || 1);
            }
        }
    }
    
    document.getElementById('snapshot-calculated-value').textContent = `${Math.round(totalValue).toLocaleString()}`;
    
    return totalValue;
}

/**
 * Cancel snapshot modal
 */
function cancelSnapshotModal() {
    const container = document.getElementById('snapshot-modal-container');
    if (container) {
        container.remove();
    }
    window._snapshotModalData = null;
    notify(' ', 'info');
}

/**
 * Confirm and create snapshot
 */
function confirmSnapshotData() {
    console.log(' confirmSnapshotData called');
    const data = window._snapshotModalData;
    if (!data) {
        console.error(' No modal data found!');
        return;
    }
    console.log(' Modal data:', data);
    
    // Get rates
    const rates = {
        USD: parseFloat(document.getElementById('snapshot-rate-usd').value) || 3.7,
        EUR: parseFloat(document.getElementById('snapshot-rate-eur').value) || 4.0,
        ILS: 1
    };
    
    // Calculate final value
    const totalValue = recalculateSnapshotValue();
    
    // Create snapshot
    const snapshot = {
        id: Date.now(),
        date: data.date,
        value_before_flow: totalValue,
        cash_flow: data.cashFlowILS,
        exchange_rates: { ...rates },
        totalValue: totalValue + data.cashFlowILS,
        triggerType: data.triggerType,
        triggerNote: data.note
    };
    
    // Add to portfolio
    if (!Array.isArray(portfolio.snapshots)) {
        portfolio.snapshots = [];
    }
    portfolio.snapshots.push(snapshot);
    portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(' Snapshot created:', snapshot);
    
    // Close modal
    const container = document.getElementById('snapshot-modal-container');
    if (container) {
        container.remove();
    }
    
    // Callback
    if (data.onComplete) {
        data.onComplete(snapshot);
    }
    
    // Delete old daily prices (up to and including this snapshot date)
    const snapshotDateStr = new Date(data.date).toISOString().split('T')[0];
    deleteOldDailyPrices(snapshotDateStr).then(count => {
        if (count > 0) {
            console.log(`锔 Cleaned up ${count} old price records`);
        }
    });
    
    window._snapshotModalData = null;
    notify(' Snapshot 爪专 爪', 'success');
}

// -----------------------------------------------------------------------------
// TRANSACTION HANDLERS - 砖专 注 拽专 
// -----------------------------------------------------------------------------

/**
 * Handle deposit with snapshot modal
 */

/**
 * Handle automatic snapshot for today's date
 * Refreshes all prices and creates snapshot automatically
 */
async function handleAutomaticSnapshot(triggerType, cashFlowILS, date, note, onComplete) {
    console.log(' Automatic snapshot - refreshing prices...');
    notify(' 专注 专...', 'info');
    
    try {
        // 1. Refresh exchange rates
        await loadRates();
        console.log(' Exchange rates refreshed');
        
        // 2. Refresh stock prices
        if (portfolio.holdings && portfolio.holdings.length > 0) {
            for (const holding of portfolio.holdings) {
                try {
                    const price = await fetchStockPrice(holding.symbol);
                    if (price && price > 0) {
                        holding.currentPrice = price;
                        console.log(` ${holding.symbol}: ${price}`);
                    }
                } catch (e) {
                    console.warn(`锔 Could not refresh ${holding.symbol}`);
                }
            }
        }
        
        // 3. Refresh bond prices
        if (portfolio.bonds && portfolio.bonds.length > 0) {
            for (const bond of portfolio.bonds) {
                try {
                    const price = await fetchBondPrice(bond.symbol);
                    if (price && price > 0) {
                        bond.currentPrice = price;
                        console.log(` ${bond.symbol}: ${price}`);
                    }
                } catch (e) {
                    console.warn(`锔 Could not refresh ${bond.symbol}`);
                }
            }
        }
        
        // 4. Calculate current portfolio value
        const rates = {
            USD: portfolio.rates?.USD || 3.7,
            EUR: portfolio.rates?.EUR || 4.0,
            ILS: 1
        };
        
        let totalValue = 0;
        
        // Holdings value
        if (portfolio.holdings) {
            for (const h of portfolio.holdings) {
                const price = h.currentPrice || h.costBasis || 0;
                const value = (h.shares || 0) * price;
                const currency = h.currency || 'ILS';
                totalValue += currency === 'ILS' ? value : value * (rates[currency] || 1);
            }
        }
        
        // Bonds value
        if (portfolio.bonds) {
            for (const b of portfolio.bonds) {
                const price = b.currentPrice || b.costBasis || 0;
                const value = (b.units || 0) * price;
                const currency = b.currency || 'ILS';
                totalValue += currency === 'ILS' ? value : value * (rates[currency] || 1);
            }
        }
        
        // Cash value
        if (portfolio.cash) {
            for (const [currency, amount] of Object.entries(portfolio.cash)) {
                if (typeof amount === 'number') {
                    totalValue += currency === 'ILS' ? amount : amount * (rates[currency] || 1);
                }
            }
        }
        
        console.log(` Portfolio value: ${Math.round(totalValue).toLocaleString()}`);
        
        // 5. Create snapshot
        const snapshot = {
            id: Date.now(),
            date: date,
            value_before_flow: Math.round(totalValue),
            cash_flow: cashFlowILS,
            exchange_rates: { ...rates },
            totalValue: Math.round(totalValue) + cashFlowILS,
            triggerType: triggerType,
            triggerNote: note,
            automatic: true // Mark as automatic
        };
        
        if (!Array.isArray(portfolio.snapshots)) {
            portfolio.snapshots = [];
        }
        portfolio.snapshots.push(snapshot);
        portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        console.log(' Automatic snapshot created:', snapshot);
        notify(' Snapshot 爪专 转', 'success');
        
        // 6. Call completion callback
        if (onComplete) {
            onComplete(snapshot);
        }
        
    } catch (error) {
        console.error(' Error in automatic snapshot:', error);
        notify(' 砖 专注 专 - 住 转', 'error');
        
        // Fall back to manual modal
        openSnapshotDataModal(triggerType, cashFlowILS, date, note, onComplete);
    }
}

function handleDepositWithSnapshot(amount, date, note) {
    console.log(' handleDepositWithSnapshot called:', { amount, date, note });
    
    const depositDate = new Date(date + 'T12:00:00').toISOString();
    const today = new Date().toISOString().split('T')[0];
    const isToday = date === today;
    
    console.log(' Deposit date:', depositDate, '| Is today:', isToday);
    
    if (isToday) {
        // Today - automatic snapshot with current prices
        handleAutomaticSnapshot('deposit', amount, depositDate, note || '驻拽', () => {
            // Add deposit record
            if (!Array.isArray(portfolio.deposits)) {
                portfolio.deposits = [];
            }
            portfolio.deposits.push({
                id: Date.now(),
                date: depositDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) + amount;
            
            // Sort and save
            portfolio.deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(` Deposit completed: ${amount.toLocaleString()}`);
            notify(` 驻拽 砖专: ${amount.toLocaleString()}`, 'success');
        });
    } else {
        // Past date - manual modal
        openSnapshotDataModal('deposit', amount, depositDate, note || '驻拽', (snapshot) => {
            console.log(' Snapshot callback received:', snapshot);
            
            // Add deposit record
            if (!Array.isArray(portfolio.deposits)) {
                portfolio.deposits = [];
            }
            portfolio.deposits.push({
                id: Date.now(),
                date: depositDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) + amount;
            
            // Sort and save
            portfolio.deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(` Deposit completed: ${amount.toLocaleString()}`);
            notify(` 驻拽 砖专: ${amount.toLocaleString()}`, 'success');
        });
    }
}

/**
 * Handle withdrawal with snapshot modal
 */
function handleWithdrawalWithSnapshot(amount, date, note) {
    console.log(' handleWithdrawalWithSnapshot called:', { amount, date, note });
    
    const withdrawalDate = new Date(date + 'T12:00:00').toISOString();
    const today = new Date().toISOString().split('T')[0];
    const isToday = date === today;
    
    console.log(' Withdrawal date:', withdrawalDate, '| Is today:', isToday);
    
    if (isToday) {
        // Today - automatic snapshot with current prices
        handleAutomaticSnapshot('withdrawal', -amount, withdrawalDate, note || '砖', () => {
            // Add withdrawal record
            if (!Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals = [];
            }
            portfolio.withdrawals.push({
                id: Date.now(),
                date: withdrawalDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) - amount;
            
            // Sort and save
            portfolio.withdrawals.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(` Withdrawal completed: ${amount.toLocaleString()}`);
            notify(` 砖 砖专: ${amount.toLocaleString()}`, 'success');
        });
    } else {
        // Past date - manual modal
        openSnapshotDataModal('withdrawal', -amount, withdrawalDate, note || '砖', (snapshot) => {
            console.log(' Snapshot callback received:', snapshot);
            
            // Add withdrawal record
            if (!Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals = [];
            }
            portfolio.withdrawals.push({
                id: Date.now(),
                date: withdrawalDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) - amount;
            
            // Sort and save
            portfolio.withdrawals.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(` Withdrawal completed: ${amount.toLocaleString()}`);
            notify(` 砖 砖专: ${amount.toLocaleString()}`, 'success');
        });
    }
}


/**
 * Record purchase - ALWAYS in original currency
 */
function recordPurchaseInOriginalCurrency(symbol, shares, price, currency, date, fee = 0, assetType = 'stocks', assetId = null) {
    const purchaseDate = new Date(date + 'T12:00:00').toISOString();
    const totalAmount = shares * price + fee;
    
    if (!Array.isArray(portfolio.purchases)) {
        portfolio.purchases = [];
    }
    
    portfolio.purchases.push({
        id: Date.now(),
        date: purchaseDate,
        symbol: symbol,
        shares: shares,
        price: price,              // 专 注 拽专
        currency: currency,        // 注 拽专
        amount: totalAmount,       // 住 注 拽专
        fee: fee,
        assetType: assetType,
        assetId: assetId,
        note: `拽: ${shares}  ${getCurrencySymbol(currency)}${price}`
    });
    
    portfolio.purchases.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(` Purchase recorded: ${shares} ${symbol} @ ${currency}${price} (total: ${currency}${totalAmount})`);
}

/**
 * Record sale - ALWAYS in original currency
 */
function recordSaleInOriginalCurrency(symbol, shares, price, currency, date, fee = 0, assetType = 'stocks', assetId = null) {
    const saleDate = new Date(date + 'T12:00:00').toISOString();
    const totalAmount = shares * price - fee;
    
    if (!Array.isArray(portfolio.sales)) {
        portfolio.sales = [];
    }
    
    portfolio.sales.push({
        id: Date.now(),
        date: saleDate,
        symbol: symbol,
        shares: shares,
        price: price,              // 专 注 拽专
        currency: currency,        // 注 拽专
        amount: totalAmount,       // 住 注 拽专
        fee: fee,
        assetType: assetType,
        assetId: assetId,
        note: `专: ${shares}  ${getCurrencySymbol(currency)}${price}`
    });
    
    portfolio.sales.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(` Sale recorded: ${shares} ${symbol} @ ${currency}${price} (total: ${currency}${totalAmount})`);
}

/**
 * Record currency exchange
 */
function recordCurrencyExchange(fromCurrency, fromAmount, toCurrency, toAmount, date) {
    const exchangeDate = new Date(date + 'T12:00:00').toISOString();
    
    if (!Array.isArray(portfolio.exchanges)) {
        portfolio.exchanges = [];
    }
    
    portfolio.exchanges.push({
        id: Date.now(),
        date: exchangeDate,
        fromCurrency: fromCurrency,
        fromAmount: fromAmount,
        toCurrency: toCurrency,
        toAmount: toAmount,
        rate: toAmount / fromAmount,
        note: `专: ${fromAmount} ${fromCurrency}  ${toAmount} ${toCurrency}`
    });
    
    // Update cash
    if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
    portfolio.cash[fromCurrency] = (portfolio.cash[fromCurrency] || 0) - fromAmount;
    portfolio.cash[toCurrency] = (portfolio.cash[toCurrency] || 0) + toAmount;
    
    portfolio.exchanges.sort((a, b) => new Date(a.date) - new Date(b.date));
    saveData();
    
    console.log(` Exchange recorded: ${fromAmount} ${fromCurrency}  ${toAmount} ${toCurrency}`);
}

// -----------------------------------------------------------------------------
// TWR CALCULATION - 砖 转砖
// -----------------------------------------------------------------------------

/**
 * Calculate TWR from snapshots
 */
function calculateTWRv3() {
    if (!Array.isArray(portfolio.snapshots) || portfolio.snapshots.length === 0) {
        console.log('锔 No snapshots for TWR calculation');
        return null;
    }
    
    const snapshots = [...portfolio.snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(` Calculating TWR with ${snapshots.length} snapshots`);
    
    // Calculate periodic returns
    const periodicReturns = [];
    
    for (let i = 1; i < snapshots.length; i++) {
        const prev = snapshots[i - 1];
        const curr = snapshots[i];
        
        // Start value = previous value_before_flow + previous cash_flow
        const startValue = (prev.value_before_flow || 0) + (prev.cash_flow || 0);
        
        // End value = current value_before_flow
        const endValue = curr.value_before_flow || 0;
        
        if (startValue > 0 && !isNaN(endValue)) {
            const R = (endValue - startValue) / startValue;
            periodicReturns.push(1 + R);
            console.log(` Period ${i}: ${Math.round(startValue).toLocaleString()}  ${Math.round(endValue).toLocaleString()} = ${(R * 100).toFixed(2)}%`);
        }
    }
    
    // Base TWR
    const baseTWR = periodicReturns.length > 0
        ? periodicReturns.reduce((acc, r) => acc * r, 1) - 1
        : 0;
    
    // Live period
    const lastSnap = snapshots[snapshots.length - 1];
    const liveStart = (lastSnap.value_before_flow || 0) + (lastSnap.cash_flow || 0);
    const currentValue = getTotalPortfolioValue();
    
    let liveTWR = 0;
    if (liveStart > 0 && !isNaN(currentValue)) {
        liveTWR = (currentValue - liveStart) / liveStart;
        console.log(` Live: ${Math.round(liveStart).toLocaleString()}  ${Math.round(currentValue).toLocaleString()} = ${(liveTWR * 100).toFixed(2)}%`);
    }
    
    // Total TWR
    const totalTWR = (1 + baseTWR) * (1 + liveTWR) - 1;
    
    // Years for annualization
    const firstSnap = snapshots[0];
    const days = (new Date() - new Date(firstSnap.date)) / (1000 * 60 * 60 * 24);
    const years = days / 365.25;
    
    let annualized = null;
    if (years >= 1 && totalTWR > -1) {
        annualized = (Math.pow(1 + totalTWR, 1 / years) - 1) * 100;
    }
    
    console.log(` TWR: Base=${(baseTWR * 100).toFixed(2)}%, Live=${(liveTWR * 100).toFixed(2)}%, Total=${(totalTWR * 100).toFixed(2)}%`);
    
    return {
        total: totalTWR * 100,
        base: baseTWR * 100,
        live: liveTWR * 100,
        annualized,
        years,
        periods: periodicReturns.length + 1
    };
}

// -----------------------------------------------------------------------------
// UTILITY FUNCTIONS
// -----------------------------------------------------------------------------

// getCurrencySymbol already defined elsewhere



        // Expose functions globally for onclick handlers
        window.openSnapshotDataModal = openSnapshotDataModal;
        window.confirmSnapshotData = confirmSnapshotData;
        window.cancelSnapshotModal = cancelSnapshotModal;
        window.recalculateSnapshotValue = recalculateSnapshotValue;
        window.fetchHistoricalRatesForModal = fetchHistoricalRatesForModal;
        window.handleAutomaticSnapshot = handleAutomaticSnapshot;
        window.fillCurrentPrices = fillCurrentPrices;
        
        console.log(' TWR Complete System v3.0 loaded');

        
        // =============================================================================
        // END OF TWR SYSTEM v3.0
        // =============================================================================
        
        function convertToILSWithRates(amount, currency, rates) {
            if (currency === 'ILS') return amount;
            const rate = rates[currency] || portfolio.rates[currency] || 1;
            return amount * rate;
        }

        /**
         * 砖 砖 转
         */
        function calculateStocksValueILS(rates = null) {
            const r = rates || portfolio.rates;
            let total = 0;
            
            if (!Array.isArray(portfolio.holdings)) return 0;
            
            portfolio.holdings.forEach(h => {
                const price = h.currentPrice || h.costBasis || 0;
                const shares = h.shares || 0;
                const currency = h.currency || getAssetCurrency(h.symbol);
                
                // 砖 = 转  专 (转专 砖专 专 砖拽/专,  )
                const value = shares * price;
                
                total += convertToILSWithRates(value, currency, r);
            });
            
            return total;
        }

        /**
         * 砖 砖 "
         */
        function calculateBondsValueILS(rates = null) {
            const r = rates || portfolio.rates;
            let total = 0;
            
            if (!Array.isArray(portfolio.bonds)) return 0;
            
            portfolio.bonds.forEach(b => {
                const price = b.currentPrice || b.costBasis || 0;
                const units = b.units || 0;
                const currency = b.currency || 'ILS';
                
                // 砖 = 转  专 (转专 砖专 专 砖拽,  )
                const value = units * price;
                
                total += convertToILSWithRates(value, currency, r);
            });
            
            return total;
        }

        /**
         * 砖 砖 转拽  (砖驻专)
         */
        function getTotalPortfolioValueEnhanced(rates = null) {
            const stocksValue = calculateStocksValueILS(rates);
            const bondsValue = calculateBondsValueILS(rates);
            const cashValue = getTotalCashILS(rates);
            
            return stocksValue + bondsValue + cashValue;
        }

        /**
         * 砖 TWR 砖驻专
         */
        function calculateTWREnhanced() {
            if (!Array.isArray(portfolio.snapshots) || portfolio.snapshots.length === 0) {
                console.log('锔 No snapshots for TWR calculation');
                return null;
            }
            
            const snapshots = [...portfolio.snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log(` Calculating TWR with ${snapshots.length} snapshots`);
            
            if (snapshots.length === 1) {
                const lastSnapshot = snapshots[0];
                const startValue = (lastSnapshot.value_before_flow || lastSnapshot.totalValue || 0) + 
                                  (lastSnapshot.cash_flow || 0);
                const currentValue = getTotalPortfolioValueEnhanced();
                
                if (startValue === 0) return null;
                
                const rLive = (currentValue - startValue) / startValue;
                const days = (new Date() - new Date(lastSnapshot.date)) / (1000 * 60 * 60 * 24);
                const years = days / 365.25;
                
                return {
                    total: rLive * 100,
                    base: 0,
                    live: rLive * 100,
                    annualized: years >= 1 ? (Math.pow(1 + rLive, 1/years) - 1) * 100 : null,
                    years: years,
                    periods: 1
                };
            }
            
            const periodicReturns = [];
            
            for (let i = 1; i < snapshots.length; i++) {
                const prev = snapshots[i - 1];
                const curr = snapshots[i];
                
                const startValue = (prev.value_before_flow !== undefined ? prev.value_before_flow : prev.totalValue || 0) + 
                                  (prev.cash_flow || 0);
                const endValue = curr.value_before_flow !== undefined ? curr.value_before_flow : curr.totalValue || 0;
                
                if (startValue > 0 && !isNaN(startValue) && !isNaN(endValue)) {
                    const R_i = (endValue - startValue) / startValue;
                    periodicReturns.push(1 + R_i);
                    console.log(` Period ${i}: ${Math.round(startValue)}  ${Math.round(endValue)}, R=${(R_i*100).toFixed(2)}%`);
                }
            }
            
            const TWR_Base = periodicReturns.length > 0 
                ? periodicReturns.reduce((acc, factor) => acc * factor, 1) - 1 
                : 0;
            
            const lastSnapshot = snapshots[snapshots.length - 1];
            const startValueLive = (lastSnapshot.value_before_flow !== undefined ? lastSnapshot.value_before_flow : lastSnapshot.totalValue || 0) + 
                                  (lastSnapshot.cash_flow || 0);
            const currentValueLive = getTotalPortfolioValueEnhanced();
            
            let R_Live = 0;
            if (startValueLive > 0 && !isNaN(startValueLive) && !isNaN(currentValueLive)) {
                R_Live = (currentValueLive - startValueLive) / startValueLive;
                console.log(` Live: ${Math.round(startValueLive)}  ${Math.round(currentValueLive)}, R=${(R_Live*100).toFixed(2)}%`);
            }
            
            const TWR_Total = (1 + TWR_Base) * (1 + R_Live) - 1;
            
            const firstSnapshot = snapshots[0];
            const daysDiff = (new Date() - new Date(firstSnapshot.date)) / (1000 * 60 * 60 * 24);
            const years = daysDiff / 365.25;
            
            let annualized = null;
            if (years >= 1 && TWR_Total > -1) {
                annualized = (Math.pow(1 + TWR_Total, 1 / years) - 1) * 100;
            }
            
            console.log(` TWR: Base=${(TWR_Base*100).toFixed(2)}%, Live=${(R_Live*100).toFixed(2)}%, Total=${(TWR_Total*100).toFixed(2)}%`);
            
            return {
                total: TWR_Total * 100,
                base: TWR_Base * 100,
                live: R_Live * 100,
                annualized: annualized,
                years: years,
                periods: periodicReturns.length + 1
            };
        }

        /**
         * 转  砖 住专
         */
        function rebuildCashFromHistory() {
            console.log(' Rebuilding cash from history...');
            
            const allEvents = [];
            
            // 驻拽转
            if (Array.isArray(portfolio.deposits)) {
                portfolio.deposits.forEach(d => {
                    allEvents.push({
                        type: 'deposit',
                        date: new Date(d.date),
                        amount: d.amount || 0,
                        currency: d.currency || 'ILS'
                    });
                });
            }
            
            // 砖转
            if (Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals.forEach(w => {
                    allEvents.push({
                        type: 'withdrawal',
                        date: new Date(w.date),
                        amount: w.amount || 0,
                        currency: w.currency || 'ILS'
                    });
                });
            }
            
            // 拽转
            if (Array.isArray(portfolio.purchases)) {
                portfolio.purchases.forEach(p => {
                    // 砖砖 砖转 砖  拽
                    let currency = p.original_currency || getAssetCurrency(p.symbol);
                    let amount = p.original_amount;
                    let fee = p.fee || 0;
                    let feeCurrency = p.fee_currency || currency;
                    
                    //   original_amount - 住 砖专 -amount
                    if (!amount && p.amount) {
                        const rate = portfolio.rates[currency] || 1;
                        amount = p.amount / rate;
                    }
                    
                    allEvents.push({
                        type: 'purchase',
                        date: new Date(p.date),
                        symbol: p.symbol,
                        amount: amount || 0,
                        currency: currency,
                        fee: fee,
                        feeCurrency: feeCurrency
                    });
                });
            }
            
            // 专转
            if (Array.isArray(portfolio.sales)) {
                portfolio.sales.forEach(s => {
                    // 砖砖 砖转 砖  拽
                    let currency = s.original_currency || s.currency || getAssetCurrency(s.symbol);
                    let amount = s.original_amount;
                    
                    //   original_amount - 住 砖专
                    if (!amount) {
                        if (s.shares && s.salePrice) {
                            amount = s.shares * s.salePrice;
                        } else if (s.amount) {
                            const rate = portfolio.rates[currency] || 1;
                            amount = s.amount / rate;
                        }
                    }
                    
                    allEvents.push({
                        type: 'sale',
                        date: new Date(s.date),
                        symbol: s.symbol,
                        amount: amount || 0,
                        currency: currency
                    });
                });
            }
            
            // 专转 注
            if (Array.isArray(portfolio.currencyExchanges)) {
                portfolio.currencyExchanges.forEach(e => {
                    allEvents.push({
                        type: 'exchange',
                        date: new Date(e.date),
                        fromCurrency: e.fromCurrency,
                        fromAmount: e.fromAmount,
                        toCurrency: e.toCurrency,
                        toAmount: e.toAmount
                    });
                });
            }
            
            allEvents.sort((a, b) => a.date - b.date);
            
            const cash = { ILS: 0, USD: 0, EUR: 0 };
            const purchaseCountBySymbol = {};
            
            console.log(` Processing ${allEvents.length} events...`);
            
            allEvents.forEach((event, idx) => {
                switch (event.type) {
                    case 'deposit':
                        cash[event.currency] += event.amount;
                        console.log(` ${idx+1}. 驻拽: +${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'withdrawal':
                        cash[event.currency] -= event.amount;
                        console.log(` ${idx+1}. 砖: -${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'purchase':
                        const purchaseCount = purchaseCountBySymbol[event.symbol] || 0;
                        purchaseCountBySymbol[event.symbol] = purchaseCount + 1;
                        
                        // 砖 注 - 砖砖 注 注住拽  砖, 专转 砖
                        let fee = event.fee || 0;
                        let feeCurrency = event.feeCurrency || event.currency;
                        
                        if (!event.fee) {
                            //  注 砖专 - 砖 驻 
                            const feeCalc = calculateFeeForTransaction(event.symbol, 'buy', purchaseCount);
                            fee = feeCalc.fee;
                            feeCurrency = feeCalc.feeCurrency || event.currency;
                        }
                        
                        cash[event.currency] -= event.amount;
                        if (fee > 0 && feeCurrency) {
                            cash[feeCurrency] -= fee;
                        }
                        console.log(` ${idx+1}. 拽 ${event.symbol}: -${event.amount.toFixed(2)} ${event.currency}` + 
                                   (fee > 0 ? ` + 注 -${fee} ${feeCurrency}` : ''));
                        break;
                        
                    case 'sale':
                        cash[event.currency] += event.amount;
                        console.log(` ${idx+1}. 专 ${event.symbol}: +${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'exchange':
                        cash[event.fromCurrency] -= event.fromAmount;
                        cash[event.toCurrency] += event.toAmount;
                        console.log(` ${idx+1}. 专: -${event.fromAmount.toFixed(2)} ${event.fromCurrency}  +${event.toAmount.toFixed(2)} ${event.toCurrency}`);
                        break;
                }
            });
            
            portfolio.cash = { ...cash };
            
            console.log('');
            console.log(' Final cash balances:');
            console.log(`   ILS: ${cash.ILS.toFixed(2)}`);
            console.log(`   USD: $${cash.USD.toFixed(2)}`);
            console.log(`   EUR: ${cash.EUR.toFixed(2)}`);
            
            return cash;
        }

        // ===========================================
        // EXCHANGE RATES - AUTO UPDATE
        // ===========================================
        
        async function updateExchangeRates() {
            // 注 砖转 砖拽 (注 )
            const usdInput = document.getElementById('rate-usd');
            const eurInput = document.getElementById('rate-eur');
            
            const usdValue = parseFloat(usdInput.value);
            const eurValue = parseFloat(eurInput.value);
            
            if (!isNaN(usdValue) && usdValue > 0) {
                portfolio.rates.USD = usdValue;
            }
            if (!isNaN(eurValue) && eurValue > 0) {
                portfolio.rates.EUR = eurValue;
            }
            
            saveData();
            updateOverview();
            notify(` 砖注专 砖专! $1 = ${portfolio.rates.USD.toFixed(2)} | 1 = ${portfolio.rates.EUR.toFixed(2)}`);
        }
        
        async function tryAutoUpdateRates() {
            const notif = document.getElementById('notification');
            notif.textContent = ' 砖 砖注专 专...';
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            console.log('');
            console.log(' Starting automatic exchange rate update...');
            console.log('Current rates before update:', { 
                USD: portfolio.rates.USD, 
                EUR: portfolio.rates.EUR 
            });
            
            try {
                const success = await autoUpdateExchangeRates();
                
                // Always hide the loading message
                notif.classList.remove('show');
                
                if (success) {
                    console.log('New rates after update:', { 
                        USD: portfolio.rates.USD, 
                        EUR: portfolio.rates.EUR 
                    });
                    console.log(' Exchange rates updated successfully!');
                    console.log('');
                    
                    updateOverview();
                    notify(` 砖注专 注!\n $1 = ${portfolio.rates.USD.toFixed(4)}\n 1 = ${portfolio.rates.EUR.toFixed(4)}`);
                } else {
                    console.log(' All API methods failed');
                    console.log('');
                    notify('锔 注  砖. 注专 转  住 砖 专 转专', 'warning');
                }
            } catch (error) {
                console.error(' Error during exchange rate update:', error);
                console.log('');
                notif.classList.remove('show');
                notify(' 砖 注 砖注专. 住 砖 专 转专', 'error');
            }
        }
        
        async function autoUpdateExchangeRates() {
            // 住 注  注 住驻专 APIs (驻爪 -  砖  砖)
            console.log(' Trying to auto-update exchange rates...');
            
            // 住 1: Frankfurter API
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS,EUR');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(' Frankfurter API response:', data);
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: 1 USD = X ILS and 1 USD = Y EUR
                        // We need: USD to ILS and EUR to ILS
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(` USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // If 1 USD = 3.75 ILS and 1 USD = 0.92 EUR
                        // Then 1 EUR = (1/0.92) USD = 1.087 USD
                        // So 1 EUR = 1.087  3.75 = 4.08 ILS
                        // Formula: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(` EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log(' Exchange rates updated via Frankfurter API');
                        console.log(`   Final rates: $1 = ${portfolio.rates.USD.toFixed(4)}, 1 = ${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('锔 Frankfurter API failed:', error.message);
            }
            
            // 住 2: ExchangeRate-API
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(' ExchangeRate-API response (first 5 rates):', {
                        ILS: data.rates?.ILS,
                        EUR: data.rates?.EUR,
                        GBP: data.rates?.GBP,
                        JPY: data.rates?.JPY,
                        CNY: data.rates?.CNY
                    });
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: all rates relative to 1 USD
                        // 1 USD = X ILS, 1 USD = Y EUR
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(` USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // Same logic as above: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(` EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log(' Exchange rates updated via ExchangeRate-API');
                        console.log(`   Final rates: $1 = ${portfolio.rates.USD.toFixed(4)}, 1 = ${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('锔 ExchangeRate-API failed:', error.message);
            }
            
            // 住 3: 住祝 Bank of Israel API  驻砖专
            try {
                // Note: BOI API usually requires CORS proxy or backend
                // This is a fallback attempt
                const response = await fetch('https://www.boi.org.il/currency.xml');
                if (response.ok) {
                    const text = await response.text();
                    console.log(' BOI XML received, parsing...');
                    // Parse XML for USD and EUR rates
                    // This is complex and might not work due to CORS
                }
            } catch (error) {
                console.log('锔 BOI API not accessible (CORS or network issue)');
            }
            
            console.log('癸 All auto-update methods failed - using manual rates');
            console.log(' You can update manually from: https://www.boi.org.il/he/markets/exchangerates/');
            return false;
        }

        // ===========================================
        // CASH FLOW CORE FUNCTIONS
        // ===========================================
        
        // 砖  专 (implicit cash)
        function getImplicitCash(assetType = 'all') {
            let deposits = 0;
            let withdrawals = 0;
            let purchases = 0;
            let sales = 0;
            
            if (assetType === 'all' || assetType === 'stocks') {
                deposits += portfolio.deposits
                    .filter(d => !d.assetType || d.assetType === 'stocks')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => !w.assetType || w.assetType === 'stocks')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => !p.assetType || p.assetType === 'stocks')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => !s.assetType || s.assetType === 'stocks')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            if (assetType === 'all' || assetType === 'bonds') {
                deposits += portfolio.deposits
                    .filter(d => d.assetType === 'bonds')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => w.assetType === 'bonds')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => p.assetType === 'bonds')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => s.assetType === 'bonds')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            return deposits - withdrawals - purchases + sales;
        }
        
        //  NEW: Calculate cash by currency (for display in Cash Flow tab)
        function getCashByCurrency(currency) {
            let deposits = 0;
            let withdrawals = 0;
            let purchases = 0;
            let sales = 0;
            
            // Deposits in this currency
            deposits = portfolio.deposits
                .filter(d => d.currency === currency || (!d.currency && currency === 'ILS'))
                .reduce((sum, d) => sum + (d.amount || 0), 0);
            
            // Withdrawals in this currency
            withdrawals = portfolio.withdrawals
                .filter(w => w.currency === currency || (!w.currency && currency === 'ILS'))
                .reduce((sum, w) => sum + (w.amount || 0), 0);
            
            // Purchases in this currency (stocks + bonds)
            portfolio.holdings
                .filter(h => h.currency === currency)
                .forEach(h => {
                    purchases += h.shares * h.costBasis;
                });
            
            if (portfolio.bonds) {
                portfolio.bonds
                    .filter(b => (b.currency || 'ILS') === currency)
                    .forEach(b => {
                        purchases += b.units * b.costBasis;
                    });
            }
            
            // Sales in this currency
            sales = portfolio.sales
                .filter(s => s.currency === currency)
                .reduce((sum, s) => {
                    const amount = s.shares ? (s.shares * s.salePrice) : s.amount;
                    return sum + (amount || 0);
                }, 0);
            
            return deposits - withdrawals - purchases + sales;
        }
        
        // 砖 砖  砖 转拽
        function getTotalPortfolioValue() {
            const stocksValue = getTotalValueILS();
            const bondsValue = portfolio.bonds ? portfolio.bonds.reduce((sum, b) => {
                const value = b.units * b.currentPrice;
                return sum + convertToILS(value, b.currency || 'ILS');
            }, 0) : 0;
            
            //  FIX: Use portfolio.cash instead of getImplicitCash for accurate total
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            const cash = (portfolio.cash.ILS || 0) + 
                         convertToILS(portfolio.cash.USD || 0, 'USD') + 
                         convertToILS(portfolio.cash.EUR || 0, 'EUR');
            
            return stocksValue + bondsValue + cash;
        }
        
        // 砖 砖 转拽 驻 专 拽 (costBasis) - 砖砖 -snapshots
        function getTotalPortfolioValueAtCost() {
            let stocksValue = 0;
            portfolio.holdings.forEach(h => {
                const value = h.shares * h.costBasis;
                stocksValue += convertToILS(value, h.currency);
            });
            
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const cash = getImplicitCash('all');
            
            return stocksValue + bondsValue + cash;
        }
        
        // 爪专转 Snapshot (驻 驻拽/砖!)
        function createSnapshot(triggerType, triggerNote = '', cashFlow = 0, customDate = null) {
            const snapshot = {
                id: Date.now(),
                date: customDate || new Date().toISOString(),
                value_before_flow: getTotalPortfolioValue(), // 砖 转拽 驻 专转 
                cash_flow: cashFlow, // 住 驻拽 (+)  砖 (-)
                stocksValue: getTotalValueILS(),
                bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                implicitCash: getImplicitCash('all'),
                totalValue: getTotalPortfolioValue(),
                triggerType: triggerType, // 'deposit' or 'withdrawal'
                triggerNote: triggerNote
            };
            
            portfolio.snapshots.push(snapshot);
            
            // Sort snapshots by date after adding new one
            portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log(' Snapshot created:', snapshot);
            return snapshot;
        }
        
        // 砖 TWR 注 转 -Live TWR
        function calculateTWR(assetType = 'total') {
            // 砖砖 专住 砖驻专转
            return calculateTWREnhanced();
        }

        // ===========================================
        // ISRAELI TASE (BORSE) API
        // ===========================================
        
        async function fetchTASEPrice(securityNumber) {
            console.log(` Fetching Israeli security: ${securityNumber}`);
            
            // Strategy 1: Try TASE Official Site (BEST - real-time updates!)
            try {
                console.log(` Strategy 1: TASE Official Site (market.tase.co.il)...`);
                const taseUrl = `https://market.tase.co.il/he/market_data/security/${securityNumber}/major_data`;
                
                const response = await fetch(taseUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(` Got TASE HTML, length: ${html.length}`);
                    
                    // Look for "砖注专 专 (专转)" or similar
                    const patterns = [
                        // Pattern 1: "砖注专 专 (专转):" followed by number
                        /砖注专 专\s*\(专转\)[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: Just "砖注专 专" with number
                        /砖注专 专[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Data in structured format
                        /专转[):\s]*([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(` TASE Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // TASE shows in agorot - convert to shekels
                                if (price > 100) {
                                    console.log(` Converting from agorot: ${price}  ${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(` TASE Official: ${price.toFixed(2)} (real-time!)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`锔 No price found in TASE HTML (might be JS-rendered)`);
                }
            } catch (e) {
                console.log(`锔 TASE Official failed: ${e.message}`);
            }
            
            // Strategy 2: Try TheMarker (fallback - end of day prices)
            try {
                console.log(` Strategy 2: TheMarker (end-of-day prices)...`);
                const markerUrl = `https://finance.themarker.com/etf/${securityNumber}`;
                
                const response = await fetch(markerUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(` Got TheMarker HTML, length: ${html.length}`);
                    
                    // Look for SPECIFIC data cells/patterns
                    const patterns = [
                        // Pattern 1: "砖注专 专" followed by number (most specific!)
                        /砖注专 专[^\d]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: In table/data structure with pipe separator
                        /砖注专 专[^|]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Generic price keywords with clear separation
                        /(?:砖注专 专|专 |砖 )[\s\S]{0,50}?([0-9,]+\.?[0-9]*)/,
                        // Pattern 4: Fallback - price near beginning
                        /(?:专|砖注专)[\s:|\-]{1,10}([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(` TheMarker Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(` Converting from agorot: ${price}  ${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(` TheMarker: ${price.toFixed(2)} (end-of-day)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`锔 No valid price found in TheMarker HTML`);
                }
            } catch (e) {
                console.log(`锔 TheMarker failed: ${e.message}`);
            }
            
            // Strategy 3: Try Globes
            try {
                console.log(` Strategy 3: Globes...`);
                const globesUrl = `https://www.globes.co.il/portal/instrument.aspx?instrumentid=${securityNumber}`;
                
                const response = await fetch(globesUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(` Got Globes HTML, length: ${html.length}`);
                    
                    // Context-based patterns only
                    const patterns = [
                        /(?:砖注专|专|砖)[^\d]{0,30}(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/,
                        /class="[^"]*price[^"]*"[^>]*>(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1];
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(` Globes Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(` Converting from agorot: ${price}  ${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(` Globes: ${price.toFixed(2)}`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`锔 No valid price found in Globes HTML`);
                }
            } catch (e) {
                console.log(`锔 Globes failed: ${e.message}`);
            }
            
            // Strategy 4: Try Yahoo with .TA suffix
            try {
                console.log(` Strategy 4: Yahoo Finance .TA...`);
                let yahooPrice = await fetchYahooChart(`${securityNumber}.TA`);
                if (yahooPrice && yahooPrice > 0) {
                    if (yahooPrice > 100) {
                        console.log(` Converting from agorot: ${yahooPrice}  ${(yahooPrice/100).toFixed(2)}`);
                        yahooPrice = yahooPrice / 100;
                    }
                    console.log(` Yahoo .TA: ${yahooPrice.toFixed(2)}`);
                    return yahooPrice;
                }
            } catch (e) {
                console.log(`锔 Yahoo .TA failed: ${e.message}`);
            }
            
            // Strategy 5: Try alternative Yahoo formats
            try {
                console.log(` Strategy 5: Alternative Yahoo formats...`);
                const formats = [
                    `TLV:${securityNumber}`,
                    `TASE:${securityNumber}`,
                    `${securityNumber}.TASE`
                ];
                
                for (const format of formats) {
                    try {
                        let price = await fetchYahooChart(format);
                        if (price && price > 0) {
                            if (price > 100) {
                                price = price / 100;
                            }
                            console.log(` Yahoo ${format}: ${price.toFixed(2)}`);
                            return price;
                        }
                    } catch (e) {
                        // Silent - try next
                    }
                }
            } catch (e) {
                console.log(`锔 Alternative Yahoo formats failed`);
            }
            
            console.log(` All strategies failed for ${securityNumber}`);
            throw new Error(`  转 拽 专  注专 ${securityNumber}. 抓 " 专" 注 转.`);
        }
        
        function isIsraeliSecurity(symbol) {
            // Israeli security numbers are 7 digits
            return /^\d{7}$/.test(symbol);
        }

        // ===========================================
        // ENHANCED API - WITH MULTIPLE FALLBACKS
        // ===========================================
        
        async function fetchStockPrice(symbol) {
            console.log(` Fetching price for: ${symbol}`);
            
            // First, check if this is an Israeli security
            if (isIsraeliSecurity(symbol)) {
                console.log(' Detected Israeli security number, trying TASE first...');
                try {
                    const price = await fetchTASEPrice(symbol);
                    return price;
                } catch (e) {
                    console.log('锔 TASE fetch failed, will try alternatives if available');
                }
            }
            
            // 住 3 砖转 砖转
            const methods = [
                () => fetchYahooChart(symbol),
                () => fetchYahooQuote(symbol),
                () => fetchYahooV10(symbol)
            ];
            
            // 住 注 住 拽专
            for (const method of methods) {
                try {
                    const price = await method();
                    if (price && price > 0) {
                        console.log(` Success: ${price}`);
                        return price;
                    }
                } catch (e) {
                    console.log(` Method failed: ${e.message}`);
                }
            }
            
            // 住 注 住 驻
            const alternatives = getAlternativeSymbols(symbol);
            for (const alt of alternatives) {
                console.log(` Trying alternative: ${alt}`);
                for (const method of methods) {
                    try {
                        const price = await method.call(null, alt);
                        if (price && price > 0) {
                            console.log(` Success with alternative: ${price}`);
                            return price;
                        }
                    } catch (e) {
                        // 砖拽, 砖 
                    }
                }
            }
            
            throw new Error(`Could not fetch price for ${symbol}`);
        }
        
        async function fetchYahooChart(symbol) {
            // Using CORS proxy to bypass CORS restrictions
            const proxies = [
                `https://api.codetabs.com/v1/proxy?quest=`,
                `https://thingproxy.freeboard.io/fetch/`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
        }
        
        //  驻拽爪 砖: 砖 转砖转 拽住 "专转" -  砖拽注转 拽住 转 转专
        // 砖转 MWR:  驻拽 砖 转 转砖  注 , 砖拽 驻  驻拽
        async function calculateVirtualIndexReturn(symbol, deposits) {
            try {
                if (!deposits || deposits.length === 0) {
                    console.log(`锔 No deposits for virtual ${symbol} calculation`);
                    return null;
                }
                
                // 爪 转专 驻拽 专砖
                const sortedDeposits = [...deposits].sort((a, b) => new Date(a.date) - new Date(b.date));
                const firstDepositDate = new Date(sortedDeposits[0].date);
                
                // 砖祝 转  住专 砖 拽住 驻拽 专砖
                const start = Math.floor(firstDepositDate.getTime() / 1000);
                const end = Math.floor(Date.now() / 1000);
                
                const proxies = [
                    `https://api.codetabs.com/v1/proxy?quest=`,
                    `https://thingproxy.freeboard.io/fetch/`
                ];
                
                let priceHistory = null;
                let timestamps = null;
                
                for (const proxy of proxies) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${start}&period2=${end}&interval=1d`;
                        const response = await fetch(proxy + encodeURIComponent(url), { timeout: 8000 });
                        
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        const result = data.chart?.result?.[0];
                        
                        if (!result) continue;
                        
                        priceHistory = result.indicators?.quote?.[0]?.close;
                        timestamps = result.timestamp;
                        
                        if (priceHistory && timestamps && priceHistory.length > 0) {
                            console.log(` Fetched ${priceHistory.length} days of ${symbol} history`);
                            break;
                        }
                    } catch (e) {
                        console.log(`Failed to fetch ${symbol} history from ${proxy}:`, e.message);
                    }
                }
                
                if (!priceHistory || !timestamps) {
                    console.log(` Could not fetch ${symbol} history`);
                    return null;
                }
                
                // 驻拽爪转 注专: 爪 专 转专 住 (  拽专)
                function getPriceForDate(targetDate) {
                    const targetTime = new Date(targetDate).getTime() / 1000;
                    
                    // 爪 转 拽住  拽专
                    let closestIdx = 0;
                    let minDiff = Math.abs(timestamps[0] - targetTime);
                    
                    for (let i = 1; i < timestamps.length; i++) {
                        const diff = Math.abs(timestamps[i] - targetTime);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestIdx = i;
                        }
                    }
                    
                    // 爪 专 转拽 ( null)
                    let price = priceHistory[closestIdx];
                    if (price === null || price <= 0) {
                        // 驻砖 拽 专
                        for (let offset = 1; offset < 10; offset++) {
                            if (closestIdx + offset < priceHistory.length && priceHistory[closestIdx + offset] > 0) {
                                price = priceHistory[closestIdx + offset];
                                break;
                            }
                            if (closestIdx - offset >= 0 && priceHistory[closestIdx - offset] > 0) {
                                price = priceHistory[closestIdx - offset];
                                break;
                            }
                        }
                    }
                    
                    return price;
                }
                
                // 专  (专 转拽)
                const validPrices = priceHistory.filter(p => p !== null && p > 0);
                const currentPrice = validPrices[validPrices.length - 1];
                
                // 砖转 MWR:  驻拽, 砖 转 转砖  注 
                // 砖拽 驻  驻拽
                let weightedReturnSum = 0;
                let totalWeight = 0;
                
                for (const deposit of sortedDeposits) {
                    const priceAtDeposit = getPriceForDate(deposit.date);
                    
                    if (priceAtDeposit && priceAtDeposit > 0) {
                        // 转砖转 拽住  驻拽 注 
                        const returnSinceDeposit = (currentPrice - priceAtDeposit) / priceAtDeposit;
                        
                        // 砖拽 = 住 驻拽
                        weightedReturnSum += returnSinceDeposit * deposit.amount;
                        totalWeight += deposit.amount;
                        
                        console.log(` ${symbol} @ ${new Date(deposit.date).toLocaleDateString('he-IL')}: $${priceAtDeposit.toFixed(2)}  $${currentPrice.toFixed(2)} = ${(returnSinceDeposit * 100).toFixed(2)}% (weight: ${deposit.amount})`);
                    }
                }
                
                // 转砖 砖拽转
                const weightedReturn = totalWeight > 0 ? (weightedReturnSum / totalWeight) * 100 : 0;
                
                console.log(` Virtual ${symbol} MWR: ${weightedReturn.toFixed(2)}% (based on ${sortedDeposits.length} deposits)`);
                
                return weightedReturn;
                
            } catch (error) {
                console.error(` calculateVirtualIndexReturn failed for ${symbol}:`, error);
                return null;
            }
        }
        
        //  驻拽爪 砖: 砖驻转 转 住专
        async function fetchHistoricalReturn(symbol, startDate) {
            try {
                const start = Math.floor(new Date(startDate).getTime() / 1000);
                const end = Math.floor(Date.now() / 1000);
                
                const proxies = [
                    `https://api.codetabs.com/v1/proxy?quest=`,
                    `https://thingproxy.freeboard.io/fetch/`
                ];
                
                for (const proxy of proxies) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${start}&period2=${end}&interval=1d`;
                        const response = await fetch(proxy + encodeURIComponent(url), { timeout: 5000 });
                        
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        const quotes = data.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
                        
                        if (!quotes || quotes.length < 2) continue;
                        
                        // 专 专砖 专 (住 null values)
                        const validPrices = quotes.filter(p => p !== null && p > 0);
                        if (validPrices.length < 2) continue;
                        
                        const firstPrice = validPrices[0];
                        const lastPrice = validPrices[validPrices.length - 1];
                        
                        // 砖 转砖
                        const returnPct = ((lastPrice - firstPrice) / firstPrice) * 100;
                        
                        console.log(` ${symbol}: ${firstPrice.toFixed(2)}  ${lastPrice.toFixed(2)} = ${returnPct.toFixed(2)}%`);
                        return returnPct;
                        
                    } catch (e) {
                        console.log(`Failed to fetch ${symbol} from ${proxy}:`, e.message);
                    }
                }
                
                throw new Error(`Could not fetch historical data for ${symbol}`);
            } catch (error) {
                console.error(`fetchHistoricalReturn failed for ${symbol}:`, error);
                return null;
            }
        }
        
        //  驻拽爪: 爪转 转专 拽 专砖
        function getFirstPurchaseDate() {
            let firstDate = new Date();
            
            // 拽 转
            if (portfolio.holdings && portfolio.holdings.length > 0) {
                portfolio.holdings.forEach(h => {
                    if (h.purchaseDate) {
                        const date = new Date(h.purchaseDate);
                        if (date < firstDate) firstDate = date;
                    }
                });
            }
            
            // 拽 "
            if (portfolio.bonds && portfolio.bonds.length > 0) {
                portfolio.bonds.forEach(b => {
                    if (b.purchaseDate) {
                        const date = new Date(b.purchaseDate);
                        if (date < firstDate) firstDate = date;
                    }
                });
            }
            
            // 拽 驻拽转 (fallback)
            if (portfolio.deposits && portfolio.deposits.length > 0) {
                portfolio.deposits.forEach(d => {
                    const date = new Date(d.date);
                    if (date < firstDate) firstDate = date;
                });
            }
            
            return firstDate;
        }
        
        async function fetchYahooQuote(symbol) {
            const proxies = [
                `https://api.codetabs.com/v1/proxy?quest=`,
                `https://thingproxy.freeboard.io/fetch/`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteResponse?.result?.[0]?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooV10(symbol) {
            const proxies = [
                `https://api.codetabs.com/v1/proxy?quest=`,
                `https://thingproxy.freeboard.io/fetch/`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteSummary?.result?.[0]?.price?.regularMarketPrice?.raw;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        function getAlternativeSymbols(symbol) {
            const alternatives = [];
            if (symbol.endsWith('.L')) {
                alternatives.push(symbol.replace('.L', '.AS'));
            }
            if (symbol.endsWith('.AS')) {
                alternatives.push(symbol.replace('.AS', '.L'));
            }
            if (symbol.endsWith('.DE')) {
                alternatives.push(symbol.replace('.DE', '.AS'));
            }
            if (symbol.includes('.')) {
                alternatives.push(symbol.split('.')[0]);
            }
            return alternatives;
        }
        
        // ===========================================
        // FIX EXISTING DATA
        // ===========================================
        
        function fixGroupIds() {
            console.log(' Starting to fix groupIds...');
            console.log(' Holdings before fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            let fixedCount = 0;
            
            portfolio.holdings.forEach(holding => {
                const originalGroupId = holding.groupId;
                
                // If groupId is missing, undefined, null, or NaN
                if (!holding.groupId || isNaN(parseInt(holding.groupId))) {
                    console.log(`锔 ${holding.symbol}: Invalid groupId (${holding.groupId}), setting to 1`);
                    holding.groupId = 1;
                    fixedCount++;
                } else {
                    // Parse to ensure it's a number
                    const parsed = parseInt(holding.groupId);
                    if (parsed !== holding.groupId) {
                        console.log(` ${holding.symbol}: Converting groupId from ${holding.groupId} (${typeof holding.groupId}) to ${parsed}`);
                        holding.groupId = parsed;
                        fixedCount++;
                    }
                }
            });
            
            console.log(' Holdings after fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            // Save the fixed data
            saveData();
            
            // Update displays
            updateOverview();
            renderHoldingsList();
            renderGroupsList();
            
            if (fixedCount > 0) {
                notify(` 转拽 ${fixedCount} 转. 专注 转 祝  注 砖 注转.`);
            } else {
                notify(`癸  转 专 转拽转`);
            }
            
            console.log(` Fixed ${fixedCount} holdings`);
        }
        
        // ===========================================
        // REFRESH PRICES
        // ===========================================
        
        async function refreshPrices() {
            const notif = document.getElementById('notification');
            notif.textContent = ' 专注 专... 0/' + portfolio.holdings.length;
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            const errors = [];
            const manualUpdateNeeded = [];
            
            for (let i = 0; i < portfolio.holdings.length; i++) {
                const holding = portfolio.holdings[i];
                
                //  Skip manually updated prices!
                if (holding.isManualPrice) {
                    console.log(` Skipping ${holding.symbol} - manual price protected`);
                    skippedCount++;
                    continue;
                }
                
                // Update progress
                notif.textContent = ` 专注 专... ${i + 1}/${portfolio.holdings.length} (${holding.symbol})`;
                
                try {
                    let price = null;
                    
                    // Strategy: Try Israeli TASE first if applicable, then altTicker, then main symbol
                    if (isIsraeliSecurity(holding.symbol)) {
                        // Try TASE for Israeli securities
                        try {
                            price = await fetchStockPrice(holding.symbol);
                            console.log(` ${holding.symbol}: ${price} (from TASE)`);
                        } catch (e) {
                            console.log(`锔 TASE failed for ${holding.symbol}: ${e.message}`);
                            // If TASE fails and there's an alternative ticker, try it
                            if (holding.altTicker) {
                                try {
                                    price = await fetchStockPrice(holding.altTicker);
                                    console.log(` ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${holding.altTicker})`);
                                } catch (e2) {
                                    console.log(`锔 Alt ticker also failed for ${holding.symbol}`);
                                    manualUpdateNeeded.push(holding.symbol);
                                    throw new Error('注 转');
                                }
                            } else {
                                manualUpdateNeeded.push(holding.symbol);
                                throw e; // Re-throw if no alternative
                            }
                        }
                    } else {
                        // For non-Israeli securities, use altTicker if available, otherwise main symbol
                        const tickerToUse = holding.altTicker || holding.symbol;
                        price = await fetchStockPrice(tickerToUse);
                        console.log(` ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${tickerToUse})`);
                    }
                    
                    holding.currentPrice = price;
                    holding.lastUpdate = new Date().toISOString();
                    // Clear manual flag if automatic update succeeds
                    delete holding.isManualPrice;
                    successCount++;
                } catch (error) {
                    console.error(` Failed: ${holding.symbol}${holding.altTicker ? ` (alt: ${holding.altTicker})` : ''}`, error);
                    errorCount++;
                    errors.push(holding.symbol);
                }
                
                // 转 拽爪专  拽砖转
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            updateOverview();
            renderHoldingsList();
            
            // Hide loading notification
            notif.classList.remove('show');
            
            // Show final result
            let msg = '';
            if (skippedCount > 0) {
                msg = ` ${skippedCount} 转  (专  )\n`;
            }
            
            if (errorCount === 0) {
                notify(` ${successCount} 专 注 爪!\n${msg}`);
            } else if (successCount === 0 && skippedCount === 0) {
                notify(`  住转 砖. 拽 转 专 专`, 'error');
            } else {
                msg += `锔 ${successCount} 爪, ${errorCount} 砖`;
                if (manualUpdateNeeded.length > 0) {
                    msg += `\n\n 专转 砖专 砖专砖 注 :\n${manualUpdateNeeded.join(', ')}\n\n抓 注 驻转专 " 专"   注 转`;
                }
                notify(msg, 'warning');
            }
        }

        // ===========================================
        // INVESTMENT CALCULATOR
        // ===========================================
        
        function calculateInvestment() {
            console.log(' calculateInvestment STARTED!');
            console.log(' Function exists:', typeof calculateInvestment);
            console.log(' Window function exists:', typeof window.calculateInvestment);
            
            const inputElement = document.getElementById('invest-amount');
            console.log(' Input element:', inputElement);
            console.log(' Input value:', inputElement ? inputElement.value : 'ELEMENT NOT FOUND');
            
            const amount = parseFloat(document.getElementById('invest-amount').value);
            console.log(' Parsed amount:', amount);
            
            if (!amount || amount <= 0) {
                console.log(' Amount validation failed');
                notify('  住 转拽', 'error');
                return;
            }
            
            console.log(' Portfolio object:', portfolio);
            console.log(' Portfolio groups:', portfolio.groups);
            console.log(' Portfolio holdings:', portfolio.holdings);
            
            // Check if getTotalValueILS exists
            console.log(' getTotalValueILS function exists:', typeof getTotalValueILS);
            
            let currentTotalValue;
            try {
                currentTotalValue = getTotalValueILS();
                console.log(' Current total value:', currentTotalValue);
            } catch (e) {
                console.error(' Error in getTotalValueILS:', e);
                return;
            }
            
            // 砖 砖  (驻 专 !)
            // const currentTotalValue = getTotalValueILS();
            
            // Check if convertToILS exists
            console.log(' convertToILS function exists:', typeof convertToILS);
            
            // 砖 专 砖拽注 砖
            const futureTotal = currentTotalValue + amount;
            
            console.log(' Current value:', currentTotalValue);
            console.log(' Investment:', amount);
            console.log(' Future total:', futureTotal);
            
            // 砖   拽爪 爪专 转 专 砖拽注
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                
                // 砖  砖 拽爪 (驻 currentPrice!)
                const currentValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                //  拽爪 爪专 转 专 砖拽注
                const targetValue = futureTotal * (group.target / 100);
                
                //  住专 拽爪
                const needed = targetValue - currentValue;
                
                console.log(` ${group.name}:`);
                console.log(`  Current: ${Math.round(currentValue)}`);
                console.log(`  Target: ${Math.round(targetValue)} (${group.target}%)`);
                console.log(`  Needed: ${Math.round(needed)}`);
                
                return {
                    group,
                    currentValue,
                    targetValue,
                    needed,
                    holdings: groupHoldings
                };
            });
            
            // 砖 住  爪专 
            const totalNeeded = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.needed), 0);
            
            console.log(' Total needed (positive only):', totalNeeded);
            
            // 拽转 住祝
            const allocations = groupsStatus.map(status => {
                let allocatedAmount = 0;
                
                if (totalNeeded > 0) {
                    if (status.needed > 0) {
                        //  住 爪专  住 砖砖, 拽 驻专驻专爪转
                        if (totalNeeded > amount) {
                            allocatedAmount = amount * (status.needed / totalNeeded);
                        } else {
                            // 砖 住驻拽 住祝 , 转 拽爪 拽  砖 爪专
                            allocatedAmount = status.needed;
                        }
                    }
                } else {
                    //   爪专 ( /注), 拽 砖 砖
                    allocatedAmount = amount / groupsStatus.length;
                }
                
                // 拽 转 拽爪 - 驻 注 驻爪转  拽
                const positionTargets = status.group.positionTargets || {};
                const hasAnyTargets = Object.keys(positionTargets).length > 0;
                
                // 砖 砖 注转 砖 拽爪 (专 砖拽注)
                const futureGroupValue = status.currentValue + allocatedAmount;
                
                // 砖 拽爪  驻爪
                const holdingAllocations = [];
                
                if (hasAnyTargets) {
                    // 砖 注 - 砖 驻注专 注  驻爪
                    const positionStatus = status.holdings.map(h => {
                        const value = h.shares * (h.currentPrice || h.costBasis);
                        const currentValueILS = convertToILS(value, h.currency);
                        const target = positionTargets[h.symbol];
                        
                        if (target !== undefined) {
                            // 驻爪 注 注 - 砖  爪专 转 砖
                            const targetValue = futureGroupValue * (target / 100);
                            const needed = targetValue - currentValueILS;
                            return { 
                                symbol: h.symbol, 
                                currentValue: currentValueILS,
                                targetValue,
                                needed: Math.max(0, needed),  // 专拽 
                                hasTarget: true, 
                                target 
                            };
                        } else {
                            // 驻爪  注
                            return { 
                                symbol: h.symbol, 
                                currentValue: currentValueILS,
                                targetValue: null,
                                needed: 0, 
                                hasTarget: false, 
                                target: null 
                            };
                        }
                    });
                    
                    // 住 爪专 砖 驻爪转 注 注
                    const totalPositionNeeded = positionStatus.reduce((sum, p) => sum + p.needed, 0);
                    
                    //  砖专 驻爪转  注
                    const amountForTargeted = Math.min(totalPositionNeeded, allocatedAmount);
                    const amountForUntargeted = allocatedAmount - amountForTargeted;
                    const holdingsWithoutTargets = positionStatus.filter(p => !p.hasTarget);
                    
                    for (const pos of positionStatus) {
                        if (pos.hasTarget) {
                            // 驻爪 注 注 - 拽爪 驻 驻注专
                            let posAllocation = 0;
                            if (totalPositionNeeded > 0) {
                                if (totalPositionNeeded > allocatedAmount) {
                                    //  住驻拽 住祝 - 拽 驻专驻专爪转
                                    posAllocation = allocatedAmount * (pos.needed / totalPositionNeeded);
                                } else {
                                    // 砖 住驻拽 - 转 拽  砖爪专
                                    posAllocation = pos.needed;
                                }
                            }
                            holdingAllocations.push({
                                symbol: pos.symbol,
                                amount: posAllocation,
                                hasTarget: true,
                                target: pos.target
                            });
                        } else {
                            // 驻爪  注 - 拽 砖 砖专
                            const perUntargeted = holdingsWithoutTargets.length > 0 
                                ? amountForUntargeted / holdingsWithoutTargets.length 
                                : 0;
                            holdingAllocations.push({
                                symbol: pos.symbol,
                                amount: perUntargeted,
                                hasTarget: false,
                                target: null
                            });
                        }
                    }
                } else {
                    //  注 - 拽 砖 砖
                    const perHolding = status.holdings.length > 0 ? allocatedAmount / status.holdings.length : 0;
                    for (const h of status.holdings) {
                        holdingAllocations.push({
                            symbol: h.symbol,
                            amount: perHolding,
                            hasTarget: false,
                            target: null
                        });
                    }
                }
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: holdingAllocations
                };
            });
            
            // 爪转 转爪转
            displayCalculatorResults(allocations, amount);
        }
        
        function displayCalculatorResults(allocations, totalAmount) {
            console.log(' displayCalculatorResults called!');
            console.log(' Allocations:', allocations);
            console.log(' Total amount:', totalAmount);
            
            const container = document.getElementById('calc-items');
            const resultsDiv = document.getElementById('calc-results');
            
            console.log(' Container element:', container);
            console.log(' Results div:', resultsDiv);
            
            if (!container) {
                console.error(' calc-items container not found!');
                return;
            }
            
            if (!resultsDiv) {
                console.error(' calc-results div not found!');
                return;
            }
            
            let html = '';
            let displayedTotal = 0;
            
            console.log(' Processing allocations...');
            
            allocations.forEach((alloc, index) => {
                console.log(` Allocation ${index}:`, alloc);
                if (alloc.amount > 0) {
                    console.log(` Adding group: ${alloc.group} with amount: ${alloc.amount}`);
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">${alloc.group} - ${Math.round(alloc.amount).toLocaleString()}</div>`;
                    
                    alloc.holdings.forEach((holding, hIndex) => {
                        console.log(`   Holding ${hIndex}:`, holding);
                        if (holding.amount > 0) {
                            console.log(`   Adding holding: ${holding.symbol} with amount: ${holding.amount}`);
                            const targetBadge = holding.hasTarget 
                                ? `<span style="font-size: 0.75rem; color: var(--profit); margin-right: 5px;">(注 ${holding.target}%)</span>` 
                                : '';
                            html += `<div class="calc-item">`;
                            html += `<span class="calc-symbol">${holding.symbol} ${targetBadge}</span>`;
                            html += `<span class="calc-amount">${Math.round(holding.amount).toLocaleString()}</span>`;
                            html += `</div>`;
                            displayedTotal += holding.amount;
                        }
                    });
                    
                    html += `</div>`;
                } else {
                    console.log(`锔 Skipping group: ${alloc.group} (amount is ${alloc.amount})`);
                }
            });
            
            console.log('锔 Generated HTML:', html);
            console.log(' Displayed total:', displayedTotal);
            
            container.innerHTML = html;
            console.log(' HTML set to container');
            
            const totalElement = document.getElementById('calc-total');
            console.log('凤 Total element:', totalElement);
            
            if (totalElement) {
                totalElement.textContent = `${Math.round(displayedTotal).toLocaleString()}`;
                console.log(' Total set to:', totalElement.textContent);
            } else {
                console.error(' calc-total element not found!');
            }
            
            resultsDiv.classList.add('active');
            console.log('锔 Added "active" class to results div');
            console.log(' displayCalculatorResults completed!');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = 'notification show';
            
            // Remove all type classes first
            notif.classList.remove('error', 'warning');
            
            if (type === 'error') notif.classList.add('error');
            if (type === 'warning') notif.classList.add('warning');
            
            // Don't auto-hide for loading messages
            if (type === 'loading') {
                notif.style.background = '#3b82f6';
                return; // Stay visible
            }
            
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        // Tab configuration - maps main tabs to their sub-tabs
        const TAB_CONFIG = {
            'overview': { subTabs: null },
            'portfolio': { 
                subTabs: [
                    { id: 'holdings', label: '转', icon: 'briefcase' },
                    { id: 'bonds', label: '"', icon: 'file-text' },
                    { id: 'cashflow', label: '转专', icon: 'dollar-sign' }
                ],
                default: 'holdings'
            },
            'performance': {
                subTabs: [
                    { id: 'charts', label: '专驻', icon: 'trending-up' },
                    { id: 'analysis', label: '转', icon: 'microscope' }
                ],
                default: 'charts'
            },
            'planning': {
                subTabs: [
                    { id: 'calculator', label: '砖', icon: 'calculator' },
                    { id: 'groups', label: '拽爪转', icon: 'folder' }
                ],
                default: 'calculator'
            },
            'history': { subTabs: null },
            'settings': { subTabs: null }
        };
        
        // Track current state
        let currentMainTab = 'overview';
        let currentSubTab = null;
        
        function showTab(tabName, event) {
            const config = TAB_CONFIG[tabName];
            
            // Update sidebar nav items
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.classList.remove('active');
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    item.classList.add('active');
                }
            });
            
            // If this is a main tab with sub-tabs
            if (config && config.subTabs) {
                currentMainTab = tabName;
                currentSubTab = config.default;
                
                // Update main tab buttons (legacy)
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
                    const onclick = btn.getAttribute('onclick');
                    return onclick && onclick.includes(`'${tabName}'`);
                });
                if (mainTabBtn) mainTabBtn.classList.add('active');
                
                // Show sub-tabs bar
                renderSubTabs(config.subTabs, config.default);
                
                // Show the default sub-tab content
                showSubTabContent(config.default);
                
            } else if (TAB_CONFIG[tabName]) {
                // Simple tab without sub-tabs
                currentMainTab = tabName;
                currentSubTab = null;
                
                // Update main tab buttons (legacy)
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
                    const onclick = btn.getAttribute('onclick');
                    return onclick && onclick.includes(`'${tabName}'`);
                });
                if (mainTabBtn) mainTabBtn.classList.add('active');
                
                // Hide sub-tabs bar
                const subTabsContainer = document.getElementById('sub-tabs-container');
                if (subTabsContainer) subTabsContainer.style.display = 'none';
                
                // Hide all tab contents and show the requested one
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const tabElement = document.getElementById(`tab-${tabName}`);
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                
                // Run tab-specific functions
                runTabFunctions(tabName);
                
            } else {
                // This might be a sub-tab call directly
                showSubTab(tabName);
            }
        }
        
        function renderSubTabs(subTabs, activeId) {
            const container = document.getElementById('sub-tabs-container');
            if (!container) return;
            
            container.style.display = 'flex';
            container.innerHTML = subTabs.map(tab => `
                <button class="sub-tab-btn ${tab.id === activeId ? 'active' : ''}" 
                        onclick="showSubTab('${tab.id}')">
                    <i data-lucide="${tab.icon}"></i> ${tab.label}
                </button>
            `).join('');
            
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function showSubTab(subTabId) {
            currentSubTab = subTabId;
            
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.sub-tab-btn')).find(btn => {
                const onclick = btn.getAttribute('onclick');
                return onclick && onclick.includes(`'${subTabId}'`);
            });
            if (activeBtn) activeBtn.classList.add('active');
            
            // Show the sub-tab content
            showSubTabContent(subTabId);
        }
        
        function showSubTabContent(subTabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show the requested sub-tab content
            const tabElement = document.getElementById(`tab-${subTabId}`);
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                console.error('Sub-tab not found:', subTabId);
            }
            
            // Run tab-specific functions
            runTabFunctions(subTabId);
        }
        
        function runTabFunctions(tabName) {
            switch(tabName) {
                case 'overview':
                    updateOverview();
                    break;
                case 'holdings':
                    renderHoldingsList();
                    break;
                case 'bonds':
                    renderBondsList();
                    break;
                case 'cashflow':
                    if (typeof renderCashFlow === 'function') renderCashFlow();
                    break;
                case 'groups':
                    renderGroupsList();
                    break;
                case 'history':
                    renderAllTransactions();
                    break;
                case 'charts':
                    setTimeout(() => {
                        if (typeof createAdvancedCharts === 'function') {
                            createAdvancedCharts();
                        }
                    }, 100);
                    break;
                case 'analysis':
                    // Analysis tab functions if any
                    break;
                case 'calculator':
                    // Calculator doesn't need refresh
                    break;
                case 'capital':
                    renderCapitalMovements();
                    renderBondsCapitalMovements();
                    updateCapitalSummary();
                    break;
                case 'recommendations':
                    renderRecommendations();
                    break;
            }
        }
        
        // Expose tab functions globally for onclick handlers
        window.showTab = showTab;
        window.showSubTab = showSubTab;

        // Toggle Dark/Light Mode (Dark is default)
        function toggleTheme() {
            const html = document.documentElement;
            const isLight = html.getAttribute('data-theme') === 'light';
            
            if (isLight) {
                // Switch to dark
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                // Switch to light
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            
            // Update icon and text
            const themeIcon = document.getElementById('theme-icon');
            const themeBtn = document.querySelector('.theme-btn');
            if (themeIcon) {
                themeIcon.textContent = isLight ? '锔' : '';
            }
            if (themeBtn) {
                const textSpan = themeBtn.querySelector('span:last-child');
                if (textSpan) {
                    textSpan.textContent = isLight ? '爪 专' : '爪 ';
                }
            }
            
            // Recreate charts with new theme
            if (typeof createAdvancedCharts === 'function') {
                setTimeout(() => createAdvancedCharts(), 100);
            }
        }
        
        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.textContent = '';
                const themeBtn = document.querySelector('.theme-btn');
                if (themeBtn) {
                    const textSpan = themeBtn.querySelector('span:last-child');
                    if (textSpan) textSpan.textContent = '爪 ';
                }
            }
        }




        
        function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            if (currency === 'USD') return amount * portfolio.rates.USD;
            if (currency === 'EUR') return amount * portfolio.rates.EUR;
            return amount;
        }
        
        function getTotalValueILS() {
            return portfolio.holdings.reduce((sum, h) => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                return sum + convertToILS(value, h.currency);
            }, 0);
        }
        
        function getCurrencySymbol(currency) {
            const symbols = { ILS: '', USD: '$', EUR: '' };
            return symbols[currency] || currency;
        }

        // ===========================================
        // TWR (TIME-WEIGHTED RETURN) HELPERS
        // ===========================================
        
        function getBondsValue() {
            return Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
        }
        
        // ===========================================
        // DATA MANAGEMENT - FIREBASE
        // ===========================================
        
        async function saveData() {
            if (!currentUser) {
                console.log(' Waiting for authentication...');
                return;
            }
            
            try {
                const defaultGroups = [
                    { id: 1, name: ' 注', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '拽/住', target: 10, color: '#ef4444' }
                ];
                
                // Validate all holdings have valid groupId
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings = portfolio.holdings.map(h => {
                        const groupId = parseInt(h.groupId);
                        if (isNaN(groupId) || groupId <= 0) {
                            console.warn(`锔 Invalid groupId for ${h.symbol}, setting to 1`);
                            return { ...h, groupId: 1 };
                        }
                        return h;
                    });
                }
                
                const dataToSave = {
                    holdings: portfolio.holdings || [],
                    groups: portfolio.groups || defaultGroups,
                    rates: portfolio.rates || {},
                    bonds: portfolio.bonds || [],
                    deposits: portfolio.deposits || [],
                    withdrawals: portfolio.withdrawals || [],
                    purchases: portfolio.purchases || [],
                    sales: portfolio.sales || [],
                    snapshots: portfolio.snapshots || [],
                    cash: portfolio.cash || { ILS: 0, USD: 0, EUR: 0 },
                    transactions: portfolio.transactions || [],
                    capitalMovements: portfolio.capitalMovements || [],
                    bondsCapitalMovements: portfolio.bondsCapitalMovements || [],
                    bondsSales: portfolio.bondsSales || [],
                    portfolioSnapshots: portfolio.portfolioSnapshots || [],
                    cashFlows: portfolio.cashFlows || [],
                    lastModified: new Date().toISOString()
                };
                
                // Save to Firebase
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                await setDoc(userDocRef, dataToSave);
                console.log(' Data saved to Firebase');
                
                // Also save to localStorage as backup
                localStorage.setItem('portfolio', JSON.stringify(dataToSave));
            } catch (error) {
                console.error(' Error saving data:', error);
                notify('锔 砖 砖专转 转', 'error');
                
                // Fallback to localStorage
                try {
                    const dataToSave = {
                        holdings: portfolio.holdings || [],
                        groups: [
                            { id: 1, name: ' 注', target: 60, color: '#3b82f6' },
                            { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                            { id: 3, name: '拽/住', target: 10, color: '#ef4444' }
                        ],
                        rates: portfolio.rates || {},
                        bonds: portfolio.bonds || [],
                        deposits: portfolio.deposits || [],
                        withdrawals: portfolio.withdrawals || [],
                        purchases: portfolio.purchases || [],
                        sales: portfolio.sales || [],
                        snapshots: portfolio.snapshots || [],
                        cash: portfolio.cash || { ILS: 0, USD: 0, EUR: 0 }
                    };
                    localStorage.setItem('portfolio', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error(' localStorage fallback failed:', e);
                }
            }
        }
        
        async function loadData() {
            if (!currentUser) {
                console.log(' Waiting for authentication...');
                return false;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const loaded = docSnap.data();
                    
                    const defaultGroups = [
                        { id: 1, name: ' 注', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '拽/住', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            return {
                                ...h,
                                groupId: validGroupId
                            };
                        }) : [],
                        groups: Array.isArray(loaded.groups) && loaded.groups.length > 0 ? loaded.groups : defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : { USD: 3.7, EUR: 4.1 },
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : [],
                        deposits: Array.isArray(loaded.deposits) ? loaded.deposits : [],
                        withdrawals: Array.isArray(loaded.withdrawals) ? loaded.withdrawals : [],
                        purchases: Array.isArray(loaded.purchases) ? loaded.purchases : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : [],
                        snapshots: Array.isArray(loaded.snapshots) ? loaded.snapshots : [],
                        cash: loaded.cash && typeof loaded.cash === 'object' ? loaded.cash : { ILS: 0, USD: 0, EUR: 0 },
                        transactions: Array.isArray(loaded.transactions) ? loaded.transactions : [],
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        bondsCapitalMovements: Array.isArray(loaded.bondsCapitalMovements) ? loaded.bondsCapitalMovements : [],
                        bondsSales: Array.isArray(loaded.bondsSales) ? loaded.bondsSales : [],
                        portfolioSnapshots: Array.isArray(loaded.portfolioSnapshots) ? loaded.portfolioSnapshots : [],
                        cashFlows: Array.isArray(loaded.cashFlows) ? loaded.cashFlows : []
                    };
                    
                    // Run migration
                    migrateOldData();
                    
                    console.log(' Data loaded from Firebase');
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('portfolio', JSON.stringify(portfolio));
                    
                    return true;
                } else {
                    console.log('No Firebase data, trying localStorage...');
                    return loadFromLocalStorage();
                }
            } catch (error) {
                console.error(' Firebase load failed:', error);
                return loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('portfolio');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    const defaultGroups = [
                        { id: 1, name: ' 注', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '拽/住', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            return {
                                ...h,
                                groupId: validGroupId
                            };
                        }) : [],
                        groups: Array.isArray(loaded.groups) && loaded.groups.length > 0 ? loaded.groups : defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : 
                               (typeof loaded.bonds === 'number' && loaded.bonds > 0) ? 
                               [{
                                   id: Date.now(),
                                   name: '拽专 " (转 砖)',
                                   units: 1,
                                   costBasis: loaded.bonds,
                                   currentPrice: loaded.bonds,
                                   lastUpdate: new Date().toISOString()
                               }] : portfolio.bonds || [],
                        // New structure
                        deposits: Array.isArray(loaded.deposits) ? loaded.deposits : [],
                        withdrawals: Array.isArray(loaded.withdrawals) ? loaded.withdrawals : [],
                        purchases: Array.isArray(loaded.purchases) ? loaded.purchases : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : [],
                        snapshots: Array.isArray(loaded.snapshots) ? loaded.snapshots : [],
                        cash: loaded.cash && typeof loaded.cash === 'object' ? loaded.cash : { ILS: 0, USD: 0 },
                        // Old structure (for migration)
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        bondsCapitalMovements: Array.isArray(loaded.bondsCapitalMovements) ? loaded.bondsCapitalMovements : [],
                        bondsSales: Array.isArray(loaded.bondsSales) ? loaded.bondsSales : [],
                        portfolioSnapshots: Array.isArray(loaded.portfolioSnapshots) ? loaded.portfolioSnapshots : []
                    };
                    
                    // Run migration
                    migrateOldData();
                    
                    console.log(' Data loaded from localStorage');
                    console.log(' Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('癸 No saved data, using defaults');
                    if (!Array.isArray(portfolio.holdings)) {
                        portfolio.holdings = [];
                    }
                    return false;
                }
            } catch (error) {
                console.error(' Error loading data:', error);
                notify('锔 砖 注转 转', 'error');
                portfolio.holdings = [];
                return false;
            }
        }

        // ===========================================
        // HOLDINGS MANAGEMENT - FIXED
        // ===========================================
        
        function showAddHoldingForm() {
            editingHoldingId = null; // Reset editing mode
            document.getElementById('add-holding-form').style.display = 'block';
            updateGroupSelect();
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '住祝 拽 砖';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('add-holding-form').style.display = 'none';
            editingHoldingId = null;
            
            // Clear form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-shares').value = '';
            document.getElementById('new-cost').value = '';
            document.getElementById('new-alt-ticker').value = '';
            document.getElementById('new-purchase-date').value = '';  //  拽 转专
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '住祝 拽 砖';
        }
        
        function updateGroupSelect() {
            const select = document.getElementById('new-group');
            if (!select) {
                console.error(' Group select element not found');
                return;
            }
            select.innerHTML = portfolio.groups.map(g => 
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        }
        
        function addHolding() {
            console.log(' Starting addHolding function...');
            console.log(' Step 1: Getting form elements');
            
            const symbolInput = document.getElementById('new-symbol');
            const sharesInput = document.getElementById('new-shares');
            const costInput = document.getElementById('new-cost');
            const currencySelect = document.getElementById('new-currency');
            const groupSelect = document.getElementById('new-group');
            
            // 拽 砖  拽
            console.log(' Step 2: Checking if elements exist', {
                symbolInput: !!symbolInput,
                sharesInput: !!sharesInput,
                costInput: !!costInput,
                currencySelect: !!currencySelect,
                groupSelect: !!groupSelect
            });
            
            if (!symbolInput || !sharesInput || !costInput || !currencySelect || !groupSelect) {
                console.error(' One or more form elements not found');
                notify(' 砖 驻住 -   爪', 'error');
                return;
            }
            
            console.log(' Step 3: Reading form values');
            const symbol = symbolInput.value.trim().toUpperCase();
            const sharesStr = sharesInput.value.trim();
            const costStr = costInput.value.trim();
            const commissionInput = document.getElementById('new-commission');
            const commissionStr = commissionInput?.value.trim() || '0';
            const currency = currencySelect.value;
            const groupId = parseInt(groupSelect.value);
            const altTicker = document.getElementById('new-alt-ticker')?.value.trim().toUpperCase() || '';
            
            // 拽专转 转专 拽 ( 专拽 - 转专 )
            const purchaseDateInput = document.getElementById('new-purchase-date');
            let purchaseDate = purchaseDateInput?.value || new Date().toISOString().split('T')[0];
            
            // 专 -ISO format 
            purchaseDate = new Date(purchaseDate + 'T12:00:00.000Z').toISOString();
            
            console.log(' Form values:', { 
                symbol, 
                shares: sharesStr, 
                cost: costStr,
                commission: commissionStr,
                currency, 
                groupId,
                altTicker,
                purchaseDate,
                raw: {
                    symbolRaw: symbolInput.value,
                    sharesRaw: sharesInput.value,
                    costRaw: costInput.value
                }
            });
            
            // 拽转 转拽转 - 砖转 专拽
            console.log(' Step 4: Validating empty fields');
            if (!symbol || !sharesStr || !costStr) {
                console.error(' Empty fields detected:', { symbol, sharesStr, costStr });
                notify('  转  砖转', 'error');
                return;
            }
            
            // 专 住驻专
            console.log(' Step 5: Converting to numbers');
            const shares = parseFloat(sharesStr);
            const cost = parseFloat(costStr);
            const commission = parseFloat(commissionStr);
            
            console.log(' Parsed numbers:', { shares, cost, commission, isNaN_shares: isNaN(shares), isNaN_cost: isNaN(cost), isNaN_commission: isNaN(commission) });
            
            // 拽 砖专 爪
            if (isNaN(shares) || isNaN(cost) || isNaN(commission)) {
                console.error(' NaN detected after parsing');
                notify(' 转, 专 注  转 住驻专', 'error');
                return;
            }
            
            // 拽 砖注专   驻住 (注  转 0)
            console.log(' Step 6: Validating positive numbers');
            if (shares <= 0 || cost <= 0 || commission < 0) {
                console.error(' Invalid numbers:', { shares, cost, commission });
                notify(' 转 专  转  驻住, 注   转 砖转', 'error');
                return;
            }
            
            //  砖 专 转 注 注
            // 专 转  = (转  专 + 注) / 转
            const actualCost = (shares * cost + commission) / shares;
            console.log(` Cost calculation: (${shares}  ${cost} + ${commission}) / ${shares} = ${actualCost.toFixed(4)}`);

            
            // 拽   爪 注专  住驻
            if (editingHoldingId !== null) {
                // 爪 注专 - 注 拽 拽转
                console.log(' Step 7: Updating existing holding:', editingHoldingId);
                const holding = portfolio.holdings.find(h => h.id === editingHoldingId);
                if (holding) {
                    holding.symbol = symbol;
                    holding.shares = shares;
                    holding.costBasis = actualCost;  //  专 转  注
                    holding.currency = currency;
                    holding.groupId = groupId;
                    holding.altTicker = altTicker;
                    holding.purchaseDate = purchaseDate;
                    holding.lastUpdate = new Date().toISOString();
                    console.log(' Holding updated:', holding);
                }
            } else {
                // 爪 住驻 - 爪专 拽 砖
                console.log(' Step 7: Creating new holding object');
                
                // 砖 住 拽 ( 注!)
                const purchaseAmountInCurrency = shares * cost + commission;  // 注 拽专
                const purchaseAmount = convertToILS(purchaseAmountInCurrency, currency);  // 砖拽
                const availableCash = getImplicitCash('stocks');
                
                // 砖: 驻 住祝?
                let fundingSource = 'cash'; // default
                
                if (availableCash < purchaseAmount) {
                    //  住驻拽  -  驻拽
                    const needDeposit = purchaseAmount - availableCash;
                    if (!confirm(` 住驻拽  转拽 (: ${Math.round(availableCash).toLocaleString()}).\n 驻拽 ${Math.round(needDeposit).toLocaleString()} 住驻?`)) {
                        notify('  -  住驻拽 ', 'error');
                        return;
                    }
                    fundingSource = 'deposit';
                } else if (availableCash > 0) {
                    // 砖  - 砖
                    fundingSource = confirm(`  拽 转拽 (${Math.round(availableCash).toLocaleString()})?\n\n抓 砖专  拽,  驻拽 砖.`) ? 'cash' : 'deposit';
                } else {
                    //    - 驻拽
                    fundingSource = 'deposit';
                }
                
                // 砖专转 砖 转拽 驻 专 拽 (costBasis) 驻 住驻转  砖
                const valueBeforeNewHolding = getTotalPortfolioValueAtCost();
                
                const newHolding = {
                    id: Date.now(),
                    symbol,
                    shares,
                    costBasis: actualCost,  //  专 转  注
                    currentPrice: actualCost,  //  专 转  注
                    currency,
                    groupId,
                    altTicker: altTicker || '',
                    purchaseDate: purchaseDate,  //  转专 拽!
                    lastUpdate: new Date().toISOString()
                };
                
                console.log(' Adding holding:', newHolding);
                portfolio.holdings.push(newHolding);
                
                // 转 portfolio.cash
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                
                //  爪专 驻拽 - 住祝  驻 住专!
                if (fundingSource === 'deposit') {
                    const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                    
                    // 专 转 驻拽 注 转
                    let depositInCurrency;
                    if (currency === 'ILS') {
                        depositInCurrency = depositAmount;
                    } else if (currency === 'USD') {
                        depositInCurrency = depositAmount / (portfolio.rates.USD || 3.7);
                    } else if (currency === 'EUR') {
                        depositInCurrency = depositAmount / (portfolio.rates.EUR || 4.0);
                    }
                    
                    // 住祝 转 驻拽 
                    portfolio.cash[currency] = (portfolio.cash[currency] || 0) + depositInCurrency;
                    console.log(` 驻拽: ${depositInCurrency.toFixed(2)} ${currency} 住祝 `);
                    
                    const deposit = {
                        id: Date.now() + 1,
                        date: purchaseDate,  //  转专 拽 转!
                        amount: depositAmount,
                        currency: currency,
                        assetType: 'stocks',
                        note: `驻拽 拽: ${symbol}`
                    };
                    portfolio.deposits.push(deposit);
                }
                
                // 注 portfolio.cash - 驻转 转 住 拽 注 拽专
                portfolio.cash[currency] = (portfolio.cash[currency] || 0) - purchaseAmountInCurrency;
                console.log(` 拽: 驻转 ${purchaseAmountInCurrency.toFixed(2)} ${currency} 转专转 `);
                console.log(`   转专转 ${currency} 砖: ${portfolio.cash[currency].toFixed(2)}`);
                console.log(`   (住 砖拽: ${purchaseAmount.toFixed(2)})`);
                
                // 专砖 拽 - 注 注  注 注 注
                const purchase = {
                    id: Date.now(),
                    date: purchaseDate,  //  转专 拽 转!
                    symbol: symbol,
                    shares: shares,
                    
                    // 注 拽专
                    original_currency: currency,
                    original_price: cost,  // 专 拽专  (驻 注)
                    original_amount: shares * cost,  // 住 拽专 (驻 注)
                    
                    // 注
                    fee: commission,
                    fee_currency: currency,
                    
                    // 砖 砖拽 (转转 专 转爪)
                    amount: purchaseAmount,
                    originalAmount: purchaseAmountInCurrency,  // 住 注 拽专
                    currency: currency,  // 注 拽专
                    assetType: 'stocks',
                    assetId: newHolding.id,
                    note: `拽: ${shares}  ${getCurrencySymbol(currency)}${cost.toFixed(2)}` + (commission > 0 ? ` + ${getCurrencySymbol(currency)}${commission.toFixed(2)} 注` : '')
                };
                portfolio.purchases.push(purchase);
                
                //  转 驻拽 - 爪专 snapshot
                if (fundingSource === 'deposit') {
                    const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                    
                    // 爪专转 snapshot 注 砖 驻 拽
                    const snapshot = {
                        id: Date.now() + 2,
                        date: purchaseDate,  //  转专 拽 转!
                        value_before_flow: valueBeforeNewHolding,
                        cash_flow: depositAmount,
                        stocksValue: getTotalValueILS(),
                        bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                        implicitCash: getImplicitCash('all'),
                        totalValue: getTotalPortfolioValue(),
                        triggerType: 'deposit',
                        triggerNote: `驻拽 拽: ${symbol}`
                    };
                    portfolio.snapshots.push(snapshot);
                    console.log(' Snapshot created with value_before_flow:', valueBeforeNewHolding);
                }
                
                console.log(' Purchase recorded:', purchase);
                console.log(' Funding source:', fundingSource);
            }
            
            console.log(' Step 8: Saving data');
            
            // 砖专
            saveData();
            
            console.log(' Step 9: Closing form and clearing inputs');
            
            // 住专转 驻住 拽
            hideAddHoldingForm();
            symbolInput.value = '';
            sharesInput.value = '';
            costInput.value = '';
            
            console.log(' Step 10: Updating UI');
            
            // 注 转爪
            renderHoldingsList();
            updateOverview();
            
            const actionText = editingHoldingId ? '注' : '住祝';
            notify(` ${symbol} ${actionText} 爪!`);
            console.log(' Holding saved successfully. Total holdings:', portfolio.holdings.length);
            console.log(' addHolding function completed successfully');
        }
        
        function deleteHolding(id) {
            if (!confirm(' 拽 拽 ?\n\n  转 拽 专 转 住祝.')) return;
            
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) {
                notify(' 拽  爪', 'error');
                return;
            }
            
            // 爪 转 注住拽 拽专转
            const purchase = portfolio.purchases.find(p => p.assetId === id);
            
            // 专 转 住祝 -portfolio.cash
            if (purchase) {
                const purchaseAmountInCurrency = holding.shares * holding.costBasis;
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + purchaseAmountInCurrency;
                console.log(` 专 ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} `);
                
                // 拽 转 注住拽
                portfolio.purchases = portfolio.purchases.filter(p => p.assetId !== id);
                console.log('锔 注住拽转 拽 拽');
            }
            
            // 拽 转 驻爪
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            renderTransactions();
            updateOverview();
            notify(' 拽 注住拽 拽, 住祝 专');
        }
        
        function editHolding(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            // Set editing mode
            editingHoldingId = id;
            
            // Fill form with holding data
            document.getElementById('new-symbol').value = holding.symbol;
            document.getElementById('new-shares').value = holding.shares;
            document.getElementById('new-cost').value = holding.costBasis;
            document.getElementById('new-currency').value = holding.currency;
            document.getElementById('new-group').value = holding.groupId;
            document.getElementById('new-alt-ticker').value = holding.altTicker || '';
            
            // Change form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = `注专 拽: ${holding.symbol}`;
            
            // Show form
            document.getElementById('add-holding-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('add-holding-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updatePriceManually(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const newPrice = prompt(`注 专 注专 ${holding.symbol}\n\n专 : ${getCurrencySymbol(holding.currency)}${holding.currentPrice}\n\n 专 砖:`, holding.currentPrice);
            
            if (newPrice === null) return; // User cancelled
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify(' 专  转拽', 'error');
                return;
            }
            
            holding.currentPrice = price;
            holding.isManualPrice = true; //  Mark as manual - will not be overridden!
            holding.lastUpdate = new Date().toISOString();
            saveData();
            renderHoldingsList();
             //  Update TWR Live!
            updateOverview();
            notify(` 专 ${holding.symbol} 注 转 -${getCurrencySymbol(holding.currency)}${price} ( 专注)`);
        }
        
        function unlockPrice(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            if (!confirm(`   注 ${holding.symbol}?\n\n专 转注 转 专注 .`)) {
                return;
            }
            
            delete holding.isManualPrice;
            saveData();
            renderHoldingsList();
            notify(`   注专 ${holding.symbol}. 专 转注 转 专注 .`);
        }
        
        // ===========================================
        // BONDS MANAGEMENT
        // ===========================================
        let editingBondId = null;
        
        window.showAddBondForm = function() {
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.hideAddBondForm = function() {
            const form = document.getElementById('add-bond-form');
            if (form) form.style.display = 'none';
            
            // Reset editing state
            editingBondId = null;
            
            // Clear form with proper field names
            const symbol = document.getElementById('bond-symbol');
            const altTicker = document.getElementById('bond-alt-ticker');
            const units = document.getElementById('bond-units');
            const cost = document.getElementById('bond-cost');
            const date = document.getElementById('bond-purchase-date');
            
            if (symbol) symbol.value = '';
            if (altTicker) altTicker.value = '';
            if (units) units.value = '';
            if (cost) cost.value = '';
            if (date) date.value = new Date().toISOString().split('T')[0];
        }
        
        function saveBond() {
            console.log('=== START saveBond ===');
            console.log('Cash before:', JSON.stringify(portfolio.cash));
            const symbol = document.getElementById('bond-symbol').value.trim();
            const altTicker = document.getElementById('bond-alt-ticker').value.trim();
            const units = parseFloat(document.getElementById('bond-units').value);
            const costBasis = parseFloat(document.getElementById('bond-cost').value);
            const commissionInput = document.getElementById('bond-commission');
            const commission = parseFloat(commissionInput?.value || '0');
            const purchaseDate = document.getElementById('bond-purchase-date').value;
            const currency = document.getElementById('bond-currency').value;
            
            if (!symbol || !units || !costBasis || !purchaseDate) {
                notify(' 砖  转  砖转 ', 'error');
                return;
            }
            
            if (isNaN(commission) || commission < 0) {
                notify(' 注  转拽', 'error');
                return;
            }
            
            //  砖 专 转 注 注
            // 专 转  = (转  专 + 注) / 转
            const actualCostBasis = (units * costBasis + commission) / units;
            console.log(` Bond cost calculation: (${units}  ${costBasis} + ${commission}) / ${units} = ${actualCostBasis.toFixed(4)}`);
            
            //  Check if editing existing bond
            if (editingBondId !== null) {
                const bond = portfolio.bonds.find(b => b.id === editingBondId);
                if (bond) {
                    bond.symbol = symbol;
                    bond.altTicker = altTicker;
                    bond.units = units;
                    bond.costBasis = actualCostBasis;  //  专 转  注
                    bond.purchaseDate = purchaseDate;
                    bond.currency = currency;
                    bond.lastUpdate = new Date().toISOString();
                    
                    console.log(' Bond updated:', bond);
                    
                    saveData();
                    renderBondsList();
                    updateOverview();
                    
                    document.getElementById('add-bond-form').style.display = 'none';
                    editingBondId = null;
                    
                    notify(' 拽专 " 注 爪', 'success');
                    return;
                }
            }
            
            // 拽转   (only for new bonds) -  注!
            const totalCost = units * costBasis + commission;
            const availableCash = portfolio.cash[currency] || 0;
            let hadDeposit = false; //  砖转 注拽  转 驻拽
            
            if (availableCash < totalCost) {
                const shortage = totalCost - availableCash;
                const currSymbol = getCurrencySymbol(currency);
                const depositNow = confirm(
                    `  住驻拽  ${currency}

` +
                    `专砖: ${currSymbol}${totalCost.toFixed(2)}
` +
                    `: ${currSymbol}${availableCash.toFixed(2)}
` +
                    `住专: ${currSymbol}${shortage.toFixed(2)}

` +
                    ` 驻拽 ${currSymbol}${shortage.toFixed(2)} 注砖?`
                );
                
                if (depositNow) {
                    hadDeposit = true; //  住 砖转 驻拽
                    
                    // 驻拽 转
                    portfolio.cash[currency] = availableCash + shortage;
                    console.log(` After deposit: ${currency} = ${portfolio.cash[currency]}`);
                    
                    // 专砖 deposits (住专)
                    if (!Array.isArray(portfolio.deposits)) {
                        portfolio.deposits = [];
                    }
                    portfolio.deposits.push({
                        id: Date.now(),
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `驻拽 转 拽转 ${symbol}`
                    });
                    
                    // 专砖 cashFlows (-MWR)
                    if (!Array.isArray(portfolio.cashFlows)) {
                        portfolio.cashFlows = [];
                    }
                    portfolio.cashFlows.push({
                        id: Date.now() + 1,
                        type: 'deposit',
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `驻拽 转 拽转 ${symbol}`
                    });
                    
                    notify(` 驻拽 ${currSymbol}${shortage.toFixed(2)}`, 'success');
                } else {
                    notify(' 拽  -  住驻拽 ', 'error');
                    return;
                }
            }
            
            const bond = {
                id: Date.now(),
                symbol: symbol,
                altTicker: altTicker,
                units: units,
                costBasis: actualCostBasis,  //  专 转  注
                currentPrice: actualCostBasis,  //  专 转  注
                purchaseDate: purchaseDate,
                currency: currency,
                isManualPrice: false
            };
            
            if (!Array.isArray(portfolio.bonds)) {
                portfolio.bonds = [];
            }
            
            portfolio.bonds.push(bond);
            
            // 专砖 注住拽转 拽 -transactions (转爪)
            if (!Array.isArray(portfolio.transactions)) {
                portfolio.transactions = [];
            }
            
            portfolio.transactions.push({
                id: Date.now() + 1,
                type: 'buy',
                assetType: 'bond',
                symbol: symbol,
                shares: units,
                price: costBasis,
                date: purchaseDate,
                currency: currency
            });
            
            //  专砖  -purchases (砖 getImplicitCash)
            if (!Array.isArray(portfolio.purchases)) {
                portfolio.purchases = [];
            }
            
            const purchaseAmountILS = convertToILS(totalCost, currency);
            portfolio.purchases.push({
                id: Date.now() + 2,
                date: purchaseDate,
                amount: purchaseAmountILS,
                assetType: 'bonds',
                assetId: bond.id,
                symbol: symbol,
                note: `拽: ${units}  ${currency}${costBasis}`
            });
            
            // 驻转  -  砖 拽专!
            const currentCash = portfolio.cash[currency] || 0;
            const newCash = currentCash - totalCost;
            portfolio.cash[currency] = newCash;
            console.log(` Cash after purchase: ${currency} = ${newCash} (was ${currentCash}, spent ${totalCost})`);
            
            //   转 驻拽 - 爪专 snapshot  砖砖 转砖  
            if (hadDeposit) {
                const shortage = totalCost - availableCash;
                const valueBeforeDeposit = getTotalPortfolioValue() - convertToILS(totalCost, currency); // 砖 驻 拽 驻拽
                
                // 爪专转 snapshot 专 Modal
                openSnapshotDataModal('deposit', convertToILS(shortage, currency), purchaseDate, `驻拽 拽: ${symbol}`, (snapshot) => {
                    console.log(' Snapshot created for bond deposit:', snapshot);
                    saveData();
                    updateOverview();
                });
            };
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            hideAddBondForm();
            updateOverview();
            renderCashFlow();
            notify(' 拽专 " 住驻 爪', 'success');
        }

        async function refreshBondPrices() {
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                notify(' 拽专转 " 专注', 'info');
                return;
            }
            
            notify(' 专注 专 "...', 'info');
            
            let updated = 0;
            let failed = 0;
            let skipped = 0;
            const total = portfolio.bonds.length;
            
            for (let i = 0; i < portfolio.bonds.length; i++) {
                const bond = portfolio.bonds[i];
                
                if (bond.isManualPrice) {
                    console.log(` Skipping ${bond.symbol} - manual price`);
                    skipped++;
                    continue;
                }
                
                try {
                    let price = null;
                    
                    // Try Israeli TASE first if applicable
                    if (isIsraeliSecurity(bond.symbol)) {
                        try {
                            price = await fetchStockPrice(bond.symbol);
                            console.log(` ${bond.symbol}: ${price} (from TASE)`);
                        } catch (e) {
                            // Try alternative ticker
                            if (bond.altTicker) {
                                price = await fetchStockPrice(bond.altTicker);
                                console.log(` ${bond.symbol}: ${price} (from ${bond.altTicker})`);
                            } else {
                                throw e;
                            }
                        }
                    } else {
                        const ticker = bond.altTicker || bond.symbol;
                        price = await fetchStockPrice(ticker);
                        console.log(` ${bond.symbol}: ${price} (from ${ticker})`);
                    }
                    
                    if (price && price > 0) {
                        bond.currentPrice = price;
                        bond.lastUpdate = new Date().toISOString();
                        delete bond.isManualPrice;
                        updated++;
                    }
                } catch (error) {
                    console.error(` Failed: ${bond.symbol}`, error);
                    failed++;
                }
                
                // 转 拽爪专  拽砖转
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            renderBondsList();
            updateOverview();
            
            let msg = '';
            if (skipped > 0) msg += ` ${skipped}  (专 )
`;
            if (failed === 0) {
                notify(` ${updated} 专 " 注!
${msg}`, 'success');
            } else {
                notify(`锔 ${updated} 爪, ${failed} 砖
${msg}`, 'warning');
            }
        }

        
        function editBond(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            editingBondId = id;
            document.getElementById('bond-symbol').value = bond.symbol;
            document.getElementById('bond-alt-ticker').value = bond.altTicker || '';
            document.getElementById('bond-units').value = bond.units;
            document.getElementById('bond-cost').value = bond.costBasis;
            document.getElementById('bond-purchase-date').value = bond.purchaseDate ? bond.purchaseDate.split('T')[0] : '';
            document.getElementById('bond-currency').value = bond.currency || 'ILS';
            
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.deleteBond = function(bondId) {
            if (!confirm(' 转  砖专爪 拽 拽专 " ?')) return;
            
            if (!Array.isArray(portfolio.bonds)) {
                notify('  拽专转 "', 'error');
                return;
            }
            
            const bondIndex = portfolio.bonds.findIndex(b => b.id === bondId);
            if (bondIndex === -1) {
                notify(' 拽专 "  爪', 'error');
                return;
            }
            
            const bond = portfolio.bonds[bondIndex];
            
            // 住祝 专  (专 转 拽 拽专转)
            const totalCost = bond.units * bond.costBasis;
            const currency = bond.currency || 'ILS';
            portfolio.cash[currency] = (portfolio.cash[currency] || 0) + totalCost;
            
            console.log(` Refunded ${totalCost} ${currency} after deleting bond`);
            
            // 拽 注住拽转 拽砖专转 (transactions)
            if (Array.isArray(portfolio.transactions)) {
                portfolio.transactions = portfolio.transactions.filter(t => 
                    !(t.assetType === 'bond' && t.symbol === bond.symbol)
                );
            }
            
            //  拽  purchases 拽砖专转
            if (Array.isArray(portfolio.purchases)) {
                portfolio.purchases = portfolio.purchases.filter(p => 
                    !(p.assetType === 'bonds' && p.assetId === bondId)
                );
            }
            
            // 拽 转 "
            portfolio.bonds.splice(bondIndex, 1);
            
            console.log('Cash after deletion:', JSON.stringify(portfolio.cash));
            console.log('Transactions left:', portfolio.transactions ? portfolio.transactions.length : 0);
            
            saveData();
            renderBondsList();
            updateOverview();
            renderCashFlow();
            notify(' 拽专 " 拽 住祝 专', 'success');
        }

        window.updateBondPriceManually = function(bondId) {
            if (!Array.isArray(portfolio.bonds)) {
                notify('  拽专转 "', 'error');
                return;
            }
            
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) {
                notify(' 拽专 "  爪', 'error');
                return;
            }
            
            const newPrice = prompt(`注 专 注专 ${bond.symbol}:`, bond.currentPrice);
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify(' 专  转拽', 'error');
                return;
            }
            
            bond.currentPrice = price;
            bond.isManualPrice = true;
            bond.lastUpdate = new Date().toISOString();
            
            console.log(` Manual price update: ${bond.symbol} = ${price}`);
            
            saveData();
            renderBondsList();
            updateOverview();
            notify(` 专 注 -${getCurrencySymbol(bond.currency)}${price.toFixed(2)}`, 'success');
        }
        
        window.unlockBondPrice = function(bondId) {
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) return;
            
            bond.isManualPrice = false;
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            notify(' 转 专  - 专注  驻注', 'success');
        }
        


        

        // ===========================================
        // BOND UNITS - ADD (MODAL)
        // ===========================================
        let addingToBondId = null;
        
        function addBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            addingToBondId = id;
            
            document.getElementById('add-bond-symbol').textContent = bond.symbol;
            document.getElementById('add-bond-current').textContent = `${bond.units} 转`;
            document.getElementById('add-bond-price').value = bond.currentPrice;
            document.getElementById('add-bond-quantity').value = '';
            document.getElementById('add-bond-commission').value = '0';
            document.getElementById('add-bond-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('add-bond-units-modal').style.display = 'flex';
        }
        
        function hideAddBondUnitsModal() {
            document.getElementById('add-bond-units-modal').style.display = 'none';
            addingToBondId = null;
        }
        
        function submitAddBondUnits() {
            const bond = portfolio.bonds.find(b => b.id === addingToBondId);
            if (!bond) return notify(' "  爪', 'error');
            
            const unitsNum = parseFloat(document.getElementById('add-bond-quantity').value);
            const priceNum = parseFloat(document.getElementById('add-bond-price').value);
            const commission = parseFloat(document.getElementById('add-bond-commission').value) || 0;
            const dateInput = document.getElementById('add-bond-date').value;
            
            if (isNaN(unitsNum) || unitsNum <= 0) return notify(' 转  转拽', 'error');
            if (isNaN(priceNum) || priceNum <= 0) return notify(' 专  转拽', 'error');
            if (isNaN(commission) || commission < 0) return notify(' 注  转拽', 'error');
            if (!dateInput) return notify('  专 转专', 'error');
            
            const purchaseDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            const actualPriceNum = (unitsNum * priceNum + commission) / unitsNum;
            const purchaseAmount = unitsNum * priceNum + commission;
            const availableCash = getImplicitCash('bonds');
            
            let fundingSource = 'cash';
            if (availableCash < purchaseAmount) {
                const needDeposit = purchaseAmount - availableCash;
                if (!confirm(` 住驻拽  (: ${Math.round(availableCash).toLocaleString()}).\n 驻拽 ${Math.round(needDeposit).toLocaleString()}?`)) {
                    return notify(' ', 'error');
                }
                fundingSource = 'deposit';
            } else if (availableCash > 0) {
                fundingSource = confirm(`  拽 (${Math.round(availableCash).toLocaleString()})?\n\n砖专=, =驻拽.`) ? 'cash' : 'deposit';
            } else {
                fundingSource = 'deposit';
            }
            
            const oldCost = bond.units * bond.costBasis;
            const newCost = unitsNum * actualPriceNum;
            const totalUnits = bond.units + unitsNum;
            const newAvgCost = (oldCost + newCost) / totalUnits;
            const valueBeforeUpdate = getTotalPortfolioValueAtCost();
            
            bond.units = totalUnits;
            bond.costBasis = newAvgCost;
            bond.lastUpdate = new Date().toISOString();
            
            portfolio.purchases.push({
                id: Date.now(),
                date: purchaseDate,
                symbol: bond.symbol,
                shares: unitsNum,
                
                // 注 拽专 (" = 砖拽)
                original_currency: bond.currency || 'ILS',
                original_price: priceNum,
                original_amount: unitsNum * priceNum,
                
                // 注
                fee: commission,
                fee_currency: bond.currency || 'ILS',
                
                // 砖 砖拽
                amount: purchaseAmount,
                originalAmount: purchaseAmountInCurrency || purchaseAmount,  // 住 注 拽专
                currency: currency || 'ILS',  // 注 拽专
                assetType: 'bonds',
                assetId: bond.id,
                note: `拽: ${unitsNum}  ${priceNum.toFixed(2)}` + (commission > 0 ? ` + ${commission.toFixed(2)} 注` : '')
            });
            
            if (fundingSource === 'deposit') {
                const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                portfolio.deposits.push({
                    id: Date.now() + 1,
                    date: purchaseDate,
                    amount: depositAmount,
                    assetType: 'bonds',
                    note: `驻拽 拽: ${bond.symbol}`
                });
                
                portfolio.snapshots.push({
                    id: Date.now() + 2,
                    date: purchaseDate,
                    value_before_flow: valueBeforeUpdate,
                    cash_flow: depositAmount,
                    stocksValue: getTotalValueILS(),
                    bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                    implicitCash: getImplicitCash('all'),
                    totalValue: getTotalPortfolioValue(),
                    triggerType: 'deposit',
                    triggerNote: `驻拽 拽: ${bond.symbol}`
                });
            }
            
            saveData();
            renderBondsList();
            renderCashFlow();
            updateOverview();
            
            hideAddBondUnitsModal();
            notify(` 住驻 ${unitsNum} 转 -${bond.symbol}\n专 爪注 砖: ${newAvgCost.toFixed(2)}`, 'success');
        }
        
        // ===========================================
        // BOND UNITS - SELL (MODAL)
        // ===========================================
        let sellingFromBondId = null;
        
        function sellBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            sellingFromBondId = id;
            
            document.getElementById('sell-bond-symbol').textContent = bond.symbol;
            document.getElementById('sell-bond-current').textContent = `${bond.units} 转`;
            document.getElementById('sell-bond-price').value = bond.currentPrice;
            document.getElementById('sell-bond-quantity').value = '';
            document.getElementById('sell-bond-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('sell-bond-units-modal').style.display = 'flex';
        }
        
        function hideSellBondUnitsModal() {
            document.getElementById('sell-bond-units-modal').style.display = 'none';
            sellingFromBondId = null;
        }
        
        function submitSellBondUnits() {
            const bond = portfolio.bonds.find(b => b.id === sellingFromBondId);
            if (!bond) return notify(' "  爪', 'error');
            
            const unitsNum = parseFloat(document.getElementById('sell-bond-quantity').value);
            const priceNum = parseFloat(document.getElementById('sell-bond-price').value);
            const dateInput = document.getElementById('sell-bond-date').value;
            
            if (isNaN(unitsNum) || unitsNum <= 0) return notify(' 转  转拽', 'error');
            if (unitsNum > bond.units) return notify('  住驻拽 转 专', 'error');
            if (isNaN(priceNum) || priceNum <= 0) return notify(' 专  转拽', 'error');
            if (!dateInput) return notify('  专 转专', 'error');
            
            const saleDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            const saleAmount = unitsNum * priceNum;
            const profit = (priceNum - bond.costBasis) * unitsNum;
            
            const keepInPortfolio = confirm(`转专转 专: ${saleAmount.toLocaleString()}\n\n 砖专 转拽 ?\n\n抓 砖专 砖专 转拽,  砖 .`);
            
            portfolio.sales.push({
                id: Date.now(),
                date: saleDate,
                amount: saleAmount,  // 砖拽
                originalAmount: saleAmount,  // 注 拽专
                currency: bond.currency || 'ILS',
                profit: profit,
                assetType: 'bonds',
                assetId: bond.id,
                fundName: bond.symbol,
                units: unitsNum,
                salePrice: priceNum,
                costBasis: bond.costBasis
            });
            
            if (!keepInPortfolio) {
                portfolio.withdrawals.push({
                    id: Date.now() + 1,
                    date: saleDate,
                    amount: saleAmount,
                    assetType: 'bonds',
                    note: `砖 专转 ${unitsNum} 转 ${bond.symbol}`
                });
                (() => {
                openSnapshotDataModal('withdrawal', -saleAmount, saleDate, `砖 专转 ${bond.symbol}`, (snapshot) => {
                    saveData();
                    updateOverview();
                });
            })();
            }
            
            bond.units -= unitsNum;
            
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash.ILS = (portfolio.cash.ILS || 0) + saleAmount;
            }
            
            bond.lastUpdate = new Date().toISOString();
            
            if (bond.units === 0) {
                if (confirm(`专转 转  转 砖 ${bond.symbol}.  拽 转 拽专 专砖?`)) {
                    portfolio.bonds = portfolio.bonds.filter(b => b.id !== sellingFromBondId);
                }
            }
            
            saveData();
            renderBondsList();
            renderCashFlow();
            updateOverview();
            
            hideSellBondUnitsModal();
            
            const profitText = profit >= 0 ? `+${profit.toFixed(2)}` : `${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '砖专 转拽' : '砖';
            notify(` 专 ${unitsNum} 转 -${bond.symbol}\n专: ${profitText}\n${actionText}`, 'success');
        }
        
        // ===========================================
        // NEW: BONDS CAPITAL MOVEMENTS
        // ===========================================
        function addBondsCapitalMovement() {
            const amount = prompt(' 住:\n\n( = 驻拽, 砖 = 砖)');
            if (amount === null) return;
            
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum === 0) {
                notify(' 住  转拽', 'error');
                return;
            }
            
            const note = prompt('注专 (驻爪):', '') || '';
            
            //  Create snapshot BEFORE adding the capital movement
            const typeText = amountNum > 0 ? '驻拽' : '砖';
            createPortfolioSnapshot(amountNum > 0 ? 'bonds-deposit' : 'bonds-withdrawal', `": ${typeText} ${Math.abs(amountNum).toLocaleString()}`);
            
            if (!portfolio.bondsCapitalMovements) portfolio.bondsCapitalMovements = [];
            portfolio.bondsCapitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amountNum,
                type: amountNum > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            
            notify(` ${typeText} 砖 ${Math.abs(amountNum).toLocaleString()} 专砖 "`);
        }
        
        function deleteBondsCapitalMovement(id) {
            if (!confirm(' 拽 转注 ?')) return;
            
            portfolio.bondsCapitalMovements = portfolio.bondsCapitalMovements.filter(m => m.id !== id);
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            notify(' 转注 拽');
        }
        
        function renderBondsCapitalMovements() {
            const container = document.getElementById('bonds-capital-movements-list');
            if (!container) return;
            
            if (!portfolio.bondsCapitalMovements || portfolio.bondsCapitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #92400e;"> 转注转  "</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #fde68a;"><th style="padding: 8px;">转专</th><th>住</th><th>住</th><th>注专</th><th>驻注转</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.bondsCapitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+${m.amount.toLocaleString()}` : `-${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? ' 驻拽' : ' 砖';
                
                html += `<tr style="border-bottom: 1px solid #fde68a;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #92400e;">${m.note || '-'}</td>
                    <td><button onclick="deleteBondsCapitalMovement(${m.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">锔</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            const totalBondsCapital = portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                <strong style="color: #92400e;">住"  拽专 ": ${totalBondsCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderBondsList() {
            const container = document.getElementById('bonds-list');
            if (!container) return;
            
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;"> 拽专转 " 注</p>
                        <p>抓 注 "住祝 拽专 ""  转</p>
                    </div>
                `;
                return;
            }
            
            //  专转
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 700;">住 / .注.</th>
                    <th style="padding: 15px; text-align: center;">转</th>
                    <th style="padding: 15px; text-align: center;">专 拽</th>
                    <th style="padding: 15px; text-align: center;">专 </th>
                    <th style="padding: 15px; text-align: center;">砖</th>
                    <th style="padding: 15px; text-align: center;">专/驻住</th>
                    <th style="padding: 15px; text-align: center;">转专 拽</th>
                    <th style="padding: 15px; text-align: center;">驻注转</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.bonds.forEach(bond => {
                const currentValue = bond.units * bond.currentPrice;
                const costValue = bond.units * bond.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
                const currSymbol = getCurrencySymbol(bond.currency);
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 15px; font-weight: 700; color: var(--text-primary);">
                        ${bond.symbol}
                        ${bond.altTicker ? `<br><span style="font-size: 0.75rem; color: var(--warning);"> ${bond.altTicker}</span>` : ''}
                        ${bond.isManualPrice ? '<span style="font-size: 0.75rem; color: var(--warning); margin-right: 5px;" title="专 "></span>' : ''}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${bond.units}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${currSymbol}${bond.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${currSymbol}${bond.currentPrice.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: var(--text-primary);">
                        ${currSymbol}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${currSymbol}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        ${new Date(bond.purchaseDate).toLocaleDateString('he-IL')}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="addBondUnits(${bond.id})" class="btn btn-sm" title="住祝 转" style="background: var(--profit); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                
                            </button>
                            <button onclick="sellBondUnits(${bond.id})" class="btn btn-sm" title="专 转" style="background: var(--warning); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                
                            </button>
                            <button onclick="editBond(${bond.id})" class="btn btn-sm" title="注专" style="background: var(--info); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                锔
                            </button>
                            <button onclick="updateBondPriceManually(${bond.id})" class="btn btn-sm" title="${bond.isManualPrice ? '专 ' : '注 专'}" style="background: var(--accent); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${bond.isManualPrice ? '' : ''}
                            </button>
                            <button onclick="console.log('Deleting bond:', ${bond.id}); deleteBond(${bond.id}); return false;" class="btn btn-sm" title="拽" style="background: var(--loss); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                锔
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // ===========================================
        // NEW: ADD SHARES TO EXISTING POSITION (MODAL)
        // ===========================================
        let addingToHoldingId = null;
        
        function showAddSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            addingToHoldingId = id;
            
            // Set modal content
            document.getElementById('add-shares-symbol').textContent = holding.symbol;
            document.getElementById('add-shares-current').textContent = `${holding.shares} 转`;
            document.getElementById('add-shares-avg-cost').textContent = `${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}`;
            
            // Pre-fill with current price
            document.getElementById('add-shares-price').value = holding.currentPrice;
            document.getElementById('add-shares-quantity').value = '';
            document.getElementById('add-shares-commission').value = '0';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('add-shares-date').value = today;
            
            // Show modal
            document.getElementById('add-shares-modal').style.display = 'flex';
        }
        
        function hideAddSharesModal() {
            document.getElementById('add-shares-modal').style.display = 'none';
            addingToHoldingId = null;
        }
        
        function submitAddShares() {
            const holding = portfolio.holdings.find(h => h.id === addingToHoldingId);
            if (!holding) {
                notify(' 拽  爪', 'error');
                return;
            }
            
            // Get form values
            const sharesToAdd = parseFloat(document.getElementById('add-shares-quantity').value);
            const purchasePrice = parseFloat(document.getElementById('add-shares-price').value);
            const commission = parseFloat(document.getElementById('add-shares-commission').value) || 0;
            const dateInput = document.getElementById('add-shares-date').value;
            
            // Validation
            if (isNaN(sharesToAdd) || sharesToAdd <= 0) {
                notify(' 转  转拽', 'error');
                return;
            }
            
            if (isNaN(purchasePrice) || purchasePrice <= 0) {
                notify(' 专  转拽', 'error');
                return;
            }
            
            if (isNaN(commission) || commission < 0) {
                notify(' 注  转拽', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('  专 转专', 'error');
                return;
            }
            
            // Convert date to ISO format
            const purchaseDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            
            //  砖 专 转 注 注
            const actualPurchasePrice = (sharesToAdd * purchasePrice + commission) / sharesToAdd;
            console.log(` Cost calculation: (${sharesToAdd}  ${purchasePrice} + ${commission}) / ${sharesToAdd} = ${actualPurchasePrice.toFixed(4)}`);
            
            //  砖 住 拽 ( 注!)
            const purchaseAmountInCurrency = sharesToAdd * purchasePrice + commission;
            const purchaseAmount = convertToILS(purchaseAmountInCurrency, holding.currency);
            const availableCash = getImplicitCash('stocks');
            
            //  砖: 驻 住祝?
            let fundingSource = 'cash';
            
            if (availableCash < purchaseAmount) {
                const needDeposit = purchaseAmount - availableCash;
                if (!confirm(` 住驻拽  转拽 (: ${Math.round(availableCash).toLocaleString()}).\n 驻拽 ${Math.round(needDeposit).toLocaleString()} 住驻?`)) {
                    notify('  -  住驻拽 ', 'error');
                    return;
                }
                fundingSource = 'deposit';
            } else if (availableCash > 0) {
                fundingSource = confirm(`  拽 转拽 (${Math.round(availableCash).toLocaleString()})?\n\n抓 砖专  拽,  驻拽 砖.`) ? 'cash' : 'deposit';
            } else {
                fundingSource = 'deposit';
            }
            
            // 砖专转 砖 转拽 驻 拽
            const valueBeforeUpdate = getTotalPortfolioValueAtCost();
            
            //  Calculate new average cost
            const oldTotal = holding.shares * holding.costBasis;
            const newTotal = sharesToAdd * actualPurchasePrice;
            const newShares = holding.shares + sharesToAdd;
            const newAvgCost = (oldTotal + newTotal) / newShares;
            
            // Update holding
            holding.shares = newShares;
            holding.costBasis = newAvgCost;
            holding.lastUpdate = new Date().toISOString();
            
            //  专砖 拽 - 注 注 
            const purchase = {
                id: Date.now(),
                date: purchaseDate,
                symbol: holding.symbol,
                shares: sharesToAdd,
                
                // 注 拽专
                original_currency: holding.currency,
                original_price: purchasePrice,  // 专 拽专  (驻 注)
                original_amount: sharesToAdd * purchasePrice,  // 住 拽专 (驻 注)
                
                // 注
                fee: commission,
                fee_currency: holding.currency,
                
                // 砖 砖拽
                amount: purchaseAmount,
                originalAmount: purchaseAmountInCurrency || purchaseAmount,  // 住 注 拽专
                currency: holding.currency || 'ILS',  // 注 拽专
                assetType: 'stocks',
                assetId: holding.id,
                note: `拽: ${sharesToAdd}  ${getCurrencySymbol(holding.currency)}${purchasePrice.toFixed(2)}` + (commission > 0 ? ` + ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)} 注` : '')
            };
            portfolio.purchases.push(purchase);
            
            //  转 portfolio.cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            //   爪专 驻拽
            if (fundingSource === 'deposit') {
                const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                const deposit = {
                    id: Date.now() + 1,
                    date: purchaseDate,
                    amount: depositAmount,
                    assetType: 'stocks',
                    note: `驻拽 拽: ${holding.symbol}`
                };
                portfolio.deposits.push(deposit);
                
                portfolio.cash.ILS = (portfolio.cash.ILS || 0) + depositAmount;
                console.log(` 驻拽: ${depositAmount.toFixed(2)}`);
                
                // 爪专转 snapshot 注 Modal 拽转 转 住专
                openSnapshotDataModal('deposit', depositAmount, purchaseDate, `驻拽 拽: ${holding.symbol}`, (snapshot) => {
                    console.log(' Snapshot created for existing holding deposit:', snapshot);
                    saveData();
                    updateOverview();
                });
            }
            
            //  驻转 转 住 拽  (注 转)
            portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) - purchaseAmountInCurrency;
            console.log(` 住专 ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} `);
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            updateOverview();
            
            hideAddSharesModal();
            notify(` 住驻 ${sharesToAdd} 转 砖 ${holding.symbol}\n专 爪注 砖: ${getCurrencySymbol(holding.currency)}${newAvgCost.toFixed(2)}`, 'success');
        }
        
        // ===========================================
        // NEW: SELL PARTIAL POSITION (MODAL)
        // ===========================================
        let sellingFromHoldingId = null;
        
        function showSellSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            sellingFromHoldingId = id;
            
            // Set modal content
            document.getElementById('sell-shares-symbol').textContent = holding.symbol;
            document.getElementById('sell-shares-current').textContent = `${holding.shares} 转`;
            document.getElementById('sell-shares-avg-cost').textContent = `${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}`;
            document.getElementById('sell-shares-current-price').textContent = `${getCurrencySymbol(holding.currency)}${holding.currentPrice.toFixed(2)}`;
            
            // Pre-fill with current price
            document.getElementById('sell-shares-price').value = holding.currentPrice;
            document.getElementById('sell-shares-quantity').value = '';
            document.getElementById('sell-shares-commission').value = '0';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sell-shares-date').value = today;
            
            // Show modal
            document.getElementById('sell-shares-modal').style.display = 'flex';
        }
        
        function hideSellSharesModal() {
            document.getElementById('sell-shares-modal').style.display = 'none';
            sellingFromHoldingId = null;
        }
        
        function submitSellShares() {
            const holding = portfolio.holdings.find(h => h.id === sellingFromHoldingId);
            if (!holding) {
                notify(' 拽  爪', 'error');
                return;
            }
            
            // Get form values
            const sharesToSell = parseFloat(document.getElementById('sell-shares-quantity').value);
            const salePrice = parseFloat(document.getElementById('sell-shares-price').value);
            const dateInput = document.getElementById('sell-shares-date').value;
            const commission = parseFloat(document.getElementById('sell-shares-commission').value) || 0;
            
            // Validation
            if (isNaN(sharesToSell) || sharesToSell <= 0) {
                notify(' 转  转拽', 'error');
                return;
            }
            
            if (sharesToSell > holding.shares) {
                notify('  住驻拽 转 专', 'error');
                return;
            }
            
            if (isNaN(salePrice) || salePrice <= 0) {
                notify(' 专  转拽', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('  专 转专', 'error');
                return;
            }
            
            // Convert date to ISO format
            const saleDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            
            // Calculate amounts - 注 驻转转 转专
            const grossAmount = sharesToSell * salePrice;  // 住 专
            const saleAmountForeign = grossAmount - commission;  // 住  (专 注)
            const netPricePerShare = saleAmountForeign / sharesToSell;  // 专  
            const saleAmountILS = convertToILS(saleAmountForeign, holding.currency);
            const profit = (netPricePerShare - holding.costBasis) * sharesToSell;  // 专 驻 专 
            const profitILS = convertToILS(profit, holding.currency);
            
            // 砖:  注砖转 注 转专?
            const commissionText = commission > 0 ? `\n注: ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)}` : '';
            const keepInPortfolio = confirm(`转专转 专 (): ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)} (${Math.round(saleAmountILS).toLocaleString()})${commissionText}\n\n 砖专 转拽 ?\n\n抓 砖专 砖专 转拽,  砖 .`);
            
            // 专砖 专 - 注 注 
            const noteText = commission > 0 
                ? `专: ${sharesToSell}  ${getCurrencySymbol(holding.currency)}${salePrice.toFixed(2)} - 注 ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)} = ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)}`
                : `专: ${sharesToSell}  ${getCurrencySymbol(holding.currency)}${salePrice.toFixed(2)} = ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)}`;
            
            const sale = {
                id: Date.now(),
                date: saleDate,
                symbol: holding.symbol,
                shares: sharesToSell,
                
                // 注 拽专
                original_currency: holding.currency,
                original_price: salePrice,  // 专 专  (专)
                net_price: netPricePerShare,  // 专   (专 注)
                original_amount: saleAmountForeign,  // 住  注 拽专
                gross_amount: grossAmount,  // 住 专 驻 注
                commission: commission,  // 注转 专
                
                // 注转 专
                costBasis: holding.costBasis,
                profit: profit,  // 专 注 拽专 (砖 驻 )
                
                // 砖 砖拽 (转转)
                amount: saleAmountILS,
                originalAmount: saleAmountForeign,  // 住 注 拽专
                profitILS: profitILS,
                originalProfit: profit,  // 专 注 拽专
                assetType: 'stocks',
                assetId: holding.id,
                currency: holding.currency,  // 转转 专
                salePrice: salePrice,  // 转转 专
                note: noteText
            };
            portfolio.sales.push(sale);
            
            //  专 砖 - 爪专转 砖 -snapshot
            if (!keepInPortfolio) {
                const withdrawal = {
                    id: Date.now() + 1,
                    date: saleDate,
                    amount: saleAmountILS,
                    assetType: 'stocks',
                    note: `砖 专转 ${sharesToSell} ${holding.symbol}`
                };
                portfolio.withdrawals.push(withdrawal);
                (() => {
                    openSnapshotDataModal('withdrawal', -saleAmountILS, saleDate, `砖 专转 ${holding.symbol}`, (snapshot) => {
                        saveData();
                        updateOverview();
                    });
                })();
            }
            
            // 注 portfolio.cash - 住祝 转 转专转 专  ( 砖专 转拽)
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + saleAmountForeign;
                console.log(` 专: 住祝 ${saleAmountForeign.toFixed(2)} ${holding.currency} 转专转  ( 专 注)`);
            }
            
            // Update holding
            holding.shares -= sharesToSell;
            holding.lastUpdate = new Date().toISOString();
            
            // If sold all shares, remove holding
            if (holding.shares === 0) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== sellingFromHoldingId);
            }
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            updateOverview();
            
            hideSellSharesModal();
            
            const profitText = profit >= 0 ? `专: +${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}` : `驻住: ${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '砖专 转拽' : '砖';
            notify(` 专 ${sharesToSell} ${holding.symbol}\n${profitText}\n${actionText}`, 'success');
        }
        
        // ===========================================
        // CASHFLOW UI FUNCTIONS
        // ===========================================
        
        function showDepositModal() {
            document.getElementById('deposit-modal').style.display = 'flex';
            document.getElementById('deposit-amount').value = '';
            document.getElementById('deposit-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deposit-date').value = today;
        }
        
        function hideDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
        }
        
        function submitDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const dateInput = document.getElementById('deposit-date').value;
            const note = document.getElementById('deposit-note').value || '';
            
            if (isNaN(amount) || amount <= 0) {
                notify(' 住  转拽', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('  专 转专', 'error');
                return;
            }
            
            // Hide deposit modal first
            hideDepositModal();
            
            // Open snapshot data modal
            handleDepositWithSnapshot(amount, dateInput, note);
        }

                function showWithdrawalModal() {
            const availableCash = getImplicitCash('all');
            document.getElementById('withdrawal-max').textContent = Math.round(availableCash).toLocaleString();
            document.getElementById('withdrawal-modal').style.display = 'flex';
            document.getElementById('withdrawal-amount').value = '';
            document.getElementById('withdrawal-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('withdrawal-date').value = today;
        }
        
        function hideWithdrawalModal() {
            document.getElementById('withdrawal-modal').style.display = 'none';
        }
        
        function submitWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const dateInput = document.getElementById('withdrawal-date').value;
            const note = document.getElementById('withdrawal-note').value || '';
            const availableCash = getImplicitCash('all');
            
            if (isNaN(amount) || amount <= 0) {
                notify(' 住  转拽', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('  专 转专', 'error');
                return;
            }
            
            if (amount > availableCash) {
                notify(`  住驻拽 . : ${Math.round(availableCash).toLocaleString()}`, 'error');
                return;
            }
            
            // Hide withdrawal modal first
            hideWithdrawalModal();
            
            // Open snapshot data modal
            handleWithdrawalWithSnapshot(amount, dateInput, note);
        }

                function deleteDeposit(id) {
            if (!confirm('拽 驻拽 ?')) return;
            
            portfolio.deposits = portfolio.deposits.filter(d => d.id !== id);
            // Remove associated snapshot
            const deposit = portfolio.deposits.find(d => d.id === id);
            if (deposit) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify(' 驻拽 拽');
        }
        
        function deleteWithdrawal(id) {
            if (!confirm('拽 砖 ?')) return;
            
            portfolio.withdrawals = portfolio.withdrawals.filter(w => w.id !== id);
            // Remove associated snapshot
            const withdrawal = portfolio.withdrawals.find(w => w.id === id);
            if (withdrawal) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify(' 砖 拽');
        }
        
                function renderCashFlow() {
            // ============================================
            // 转爪转 转专转  (3 注转)
            // ============================================
            // 砖转砖 -portfolio.cash 砖 转  转专转  专转 注
            
            // 转 portfolio.cash   拽
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            
            console.log(' Cash balances by currency:', cashBalances);
            
            const cashHtml = `
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                         转专转  
                        <button onclick="showCurrencyExchange()" style="margin-right: auto; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                             专转 注
                        </button>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">砖拽 ()</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${Math.round(cashBalances.ILS).toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">专 ($)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">$${cashBalances.USD.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">专 ()</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${cashBalances.EUR.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            const cashContainer = document.getElementById('cash-balances-container');
            if (cashContainer) {
                cashContainer.innerHTML = cashHtml;
            }
            
            // ============================================
            // 转 驻拽转
            // ============================================
            const depositsContainer = document.getElementById('deposits-list');
            if (portfolio.deposits.length === 0) {
                depositsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;"> 驻拽转 注</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #d1fae5;"><th style="padding: 8px;">转专</th><th>住</th><th>住</th><th>注专</th><th>驻注转</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.deposits].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalDep = 0;
                sorted.forEach(d => {
                    const amount = parseFloat(d.amount);
                    if (!d.amount || isNaN(amount) || amount <= 0) return;
                    totalDep += amount;
                    
                    const date = new Date(d.date).toLocaleDateString('he-IL');
                    const typeText = d.assetType === 'bonds' ? '\"' : '转';
                    html += `<tr style="border-bottom: 1px solid #d1fae5;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: var(--profit); font-weight: bold;">+${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: var(--text-secondary);">${d.note || '-'}</td>
                        <td><button onclick="deleteDeposit(${d.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">拽</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #a7f3d0; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">住\" 驻拽转</td>
                    <td style="color: #059669;">+${Math.round(totalDep).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                depositsContainer.innerHTML = html;
            }
            
            // ============================================
            // 转 砖转
            // ============================================
            const withdrawalsContainer = document.getElementById('withdrawals-list');
            if (portfolio.withdrawals.length === 0) {
                withdrawalsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;"> 砖转 注</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #fee2e2;"><th style="padding: 8px;">转专</th><th>住</th><th>住</th><th>注专</th><th>驻注转</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.withdrawals].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalWith = 0;
                sorted.forEach(w => {
                    const amount = parseFloat(w.amount);
                    if (!w.amount || isNaN(amount) || amount <= 0) return;
                    totalWith += amount;
                    
                    const date = new Date(w.date).toLocaleDateString('he-IL');
                    const typeText = w.assetType === 'bonds' ? '\"' : '转';
                    html += `<tr style="border-bottom: 1px solid #fee2e2;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: var(--loss); font-weight: bold;">-${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: var(--text-secondary);">${w.note || '-'}</td>
                        <td><button onclick="deleteWithdrawal(${w.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">拽</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #fecaca; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">住\" 砖转</td>
                    <td style="color: #dc2626;">-${Math.round(totalWith).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                withdrawalsContainer.innerHTML = html;
            }
            
            // Summary
            const totalDeposits = portfolio.deposits.reduce((sum, d) => {
                const amount = parseFloat(d.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => {
                const amount = parseFloat(w.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const netCapital = totalDeposits - totalWithdrawals;
            const availableCash = getImplicitCash('all');
            
            // 注 转 住  转专 住驻
            const el1 = document.getElementById('total-deposits');
            if (el1) el1.textContent = Math.round(totalDeposits).toLocaleString();
            
            const el2 = document.getElementById('total-withdrawals');
            if (el2) el2.textContent = Math.round(totalWithdrawals).toLocaleString();
            
            // 注  转 住拽专 转
            const el1b = document.getElementById('overview-total-deposits');
            if (el1b) el1b.textContent = `${Math.round(totalDeposits).toLocaleString()}`;
            
            const el2b = document.getElementById('overview-total-withdrawals');
            if (el2b) el2b.textContent = `${Math.round(totalWithdrawals).toLocaleString()}`;
            
            const el3 = document.getElementById('net-capital');
            if (el3) el3.textContent = Math.round(netCapital).toLocaleString();
            
            const el4 = document.getElementById('available-cash');
            if (el4) el4.textContent = Math.round(availableCash).toLocaleString();
        }
        
        let currentTransactionFilter = 'all';
        
        function filterTransactions(type) {
            currentTransactionFilter = type;
            
            // Update button styles
            ['all', 'deposits', 'withdrawals', 'purchases', 'sales'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (btn) {
                    btn.className = t === type ? 'btn btn-primary' : 'btn';
                }
            });
            
            renderTransactions();
        }
        
        function renderTransactions() {
            const container = document.getElementById('transactions-list');
            
            // Collect all transactions
            let transactions = [];
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'deposits') {
                portfolio.deposits.forEach(d => {
                    transactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        amount: d.amount,
                        note: d.note || '-',
                        assetType: d.assetType,
                        icon: '',
                        color: '#10b981'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'withdrawals') {
                portfolio.withdrawals.forEach(w => {
                    transactions.push({
                        id: w.id,
                        date: w.date,
                        type: 'withdrawal',
                        amount: -w.amount,
                        note: w.note || '-',
                        assetType: w.assetType,
                        icon: '',
                        color: '#ef4444'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'purchases') {
                portfolio.purchases.forEach(p => {
                    transactions.push({
                        id: p.id,
                        date: p.date,
                        type: 'purchase',
                        amount: -p.amount,
                        note: p.note || p.symbol || '-',
                        assetType: p.assetType,
                        icon: '',
                        color: '#3b82f6'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'sales') {
                portfolio.sales.forEach(s => {
                    transactions.push({
                        id: s.id,
                        date: s.date,
                        type: 'sale',
                        amount: s.amount,
                        profit: s.profit,
                        note: `${s.symbol || s.fundName} (专: ${s.profit >= 0 ? '+' : ''}${Math.round(s.profit).toLocaleString()})`,
                        assetType: s.assetType,
                        icon: '',
                        color: '#f59e0b'
                    });
                });
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;"> 注住拽转 爪</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f3f4f6;"><th style="padding: 10px;">转专</th><th>住</th><th>住</th><th>转专</th><th>住</th><th>驻注转</th></tr></thead>';
            html += '<tbody>';
            
            transactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const typeText = {
                    'deposit': '驻拽',
                    'withdrawal': '砖',
                    'purchase': '拽',
                    'sale': '专'
                }[t.type];
                const assetText = t.assetType === 'bonds' ? '"' : '转';
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px;">${date}</td>
                    <td style="color: ${t.color};">${t.icon} ${typeText}</td>
                    <td>${assetText}</td>
                    <td style="color: var(--text-secondary);">${t.note}</td>
                    <td style="font-weight: bold; color: ${t.amount >= 0 ? '#10b981' : '#ef4444'};">
                        ${t.amount >= 0 ? '+' : ''}${Math.round(Math.abs(t.amount)).toLocaleString()}
                    </td>
                    <td>
                        ${t.type === 'purchase' || t.type === 'sale' ? 
                            `<button onclick="showEditTransactionDate('${t.type}', ${t.id})" 
                                style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px;">
                                锔 注专 转专
                            </button>
                            <span style="color: #9ca3af; font-size: 0.85rem;">转拽 驻专  拽转</span>` :
                            `<button onclick="showEditTransactionDate('${t.type}', ${t.id})" 
                                style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px;">
                                锔
                            </button>
                            <button onclick="deleteTransaction('${t.type}', ${t.id})" 
                                style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            拽
                        </button>`}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function deleteTransaction(type, id) {
            // 锔 SAFETY: Only allow deleting deposits and withdrawals
            // Purchases and sales are too complex to safely delete
            if (type === 'purchase' || type === 'sale') {
                notify('锔  转 拽 拽转  专转 \n\n 爪专 转拽, 砖转砖 驻转专 锔 注专  拽转', 'error');
                return;
            }
            
            if (!confirm(' 拽 注住拽 ?')) return;
            
            let found = false;
            
            switch(type) {
                case 'deposit':
                    const depositIndex = portfolio.deposits.findIndex(d => d.id === id);
                    if (depositIndex !== -1) {
                        const deposit = portfolio.deposits[depositIndex];
                        
                        portfolio.deposits.splice(depositIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                        );
                        
                        console.log(` 驻拽 拽: ${deposit.amount.toFixed(2)}`);
                        found = true;
                    }
                    break;
                    
                case 'withdrawal':
                    const withdrawalIndex = portfolio.withdrawals.findIndex(w => w.id === id);
                    if (withdrawalIndex !== -1) {
                        const withdrawal = portfolio.withdrawals[withdrawalIndex];
                        
                        portfolio.withdrawals.splice(withdrawalIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                        );
                        
                        console.log(` 砖 拽: ${withdrawal.amount.toFixed(2)}`);
                        found = true;
                    }
                    break;
            }
            
            if (found) {
                saveData();
                renderCashFlow();
                renderTransactions();
                updateOverview();
                notify(' 注住拽 拽 爪', 'success');
            } else {
                notify(' 注住拽  爪', 'error');
            }
        }
        
        // ===========================================
        // EDIT TRANSACTION DATE
        // ===========================================
        let editingTransaction = { type: null, id: null };
        
        function showEditTransactionDate(type, id) {
            editingTransaction = { type, id };
            
            // Find the transaction
            let transaction = null;
            let typeText = '';
            
            switch(type) {
                case 'deposit':
                    transaction = portfolio.deposits.find(d => d.id === id);
                    typeText = '驻拽';
                    break;
                case 'withdrawal':
                    transaction = portfolio.withdrawals.find(w => w.id === id);
                    typeText = '砖';
                    break;
                case 'purchase':
                    transaction = portfolio.purchases.find(p => p.id === id);
                    typeText = '拽';
                    break;
                case 'sale':
                    transaction = portfolio.sales.find(s => s.id === id);
                    typeText = '专';
                    break;
            }
            
            if (!transaction) {
                notify(' 注住拽  爪', 'error');
                return;
            }
            
            // Set modal content
            document.getElementById('edit-date-type').textContent = typeText;
            const currentDate = new Date(transaction.date).toLocaleDateString('he-IL');
            document.getElementById('edit-date-current').textContent = currentDate;
            document.getElementById('edit-date-new').value = new Date(transaction.date).toISOString().split('T')[0];
            
            // Show modal
            document.getElementById('edit-date-modal').style.display = 'flex';
        }
        
        function hideEditDateModal() {
            document.getElementById('edit-date-modal').style.display = 'none';
            editingTransaction = { type: null, id: null };
        }
        
        function submitEditDate() {
            const newDate = document.getElementById('edit-date-new').value;
            
            if (!newDate) {
                notify('  专 转专', 'error');
                return;
            }
            
            // Find and update the transaction
            let transaction = null;
            const { type, id } = editingTransaction;
            
            switch(type) {
                case 'deposit':
                    transaction = portfolio.deposits.find(d => d.id === id);
                    break;
                case 'withdrawal':
                    transaction = portfolio.withdrawals.find(w => w.id === id);
                    break;
                case 'purchase':
                    transaction = portfolio.purchases.find(p => p.id === id);
                    break;
                case 'sale':
                    transaction = portfolio.sales.find(s => s.id === id);
                    break;
            }
            
            if (transaction) {
                // Convert date to ISO format
                const isoDate = new Date(newDate + 'T12:00:00.000Z').toISOString();
                transaction.date = isoDate;
                
                // Also update associated snapshot if exists
                if (type === 'deposit' || type === 'withdrawal') {
                    const snapshot = portfolio.snapshots.find(s => 
                        s.triggerType === type && Math.abs(new Date(s.date) - new Date(transaction.date)) < 86400000 // 1 day tolerance
                    );
                    if (snapshot) {
                        snapshot.date = isoDate;
                    }
                }
                
                saveData();
                renderTransactions();
                renderCashFlow();
                updateOverview();
                
                notify(' 转专 注 爪', 'success');
                hideEditDateModal();
            } else {
                notify(' 砖 注 转专', 'error');
            }
        }
        
        // ===========================================
        // ===========================================
        // DATA MIGRATION
        // ===========================================
        
        function migrateOldData() {
            let migrated = false;
            
            // Migrate capitalMovements to deposits/withdrawals
            if (portfolio.capitalMovements && portfolio.capitalMovements.length > 0) {
                console.log(' Migrating capitalMovements...');
                
                portfolio.capitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id,
                            date: m.date,
                            amount: m.amount,
                            assetType: 'stocks',
                            note: m.note || '专爪'
                        });
                        createSnapshot('deposit', m.note || '专爪');
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id,
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'stocks',
                            note: m.note || '专爪'
                        });
                        createSnapshot('withdrawal', m.note || '专爪');
                    }
                });
                
                delete portfolio.capitalMovements;
                migrated = true;
            }
            
            // Migrate bondsCapitalMovements
            if (portfolio.bondsCapitalMovements && portfolio.bondsCapitalMovements.length > 0) {
                portfolio.bondsCapitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: m.amount,
                            assetType: 'bonds',
                            note: m.note || '专爪'
                        });
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'bonds',
                            note: m.note || '专爪'
                        });
                    }
                });
                
                delete portfolio.bondsCapitalMovements;
                migrated = true;
            }
            
            // Migrate bondsSales
            if (portfolio.bondsSales && portfolio.bondsSales.length > 0) {
                portfolio.bondsSales.forEach(bs => {
                    portfolio.sales.push({
                        id: bs.id,
                        date: bs.date,
                        amount: bs.units * bs.salePrice,
                        profit: bs.profit,
                        assetType: 'bonds',
                        fundName: bs.fundName,
                        units: bs.units,
                        salePrice: bs.salePrice,
                        costBasis: bs.costBasis
                    });
                });
                
                delete portfolio.bondsSales;
                migrated = true;
            }
            
            // Migrate portfolioSnapshots
            if (portfolio.portfolioSnapshots && portfolio.portfolioSnapshots.length > 0) {
                portfolio.portfolioSnapshots.forEach(ps => {
                    portfolio.snapshots.push({
                        id: ps.id,
                        date: ps.date,
                        stocksValue: ps.stocksValue || 0,
                        bondsValue: ps.bondsValue || 0,
                        implicitCash: 0,
                        totalValue: ps.totalValue,
                        triggerType: ps.triggerType,
                        triggerNote: ps.triggerNote || ''
                    });
                });
                
                delete portfolio.portfolioSnapshots;
                migrated = true;
            }
            
            if (migrated) {
                saveData();
                console.log(' Migration completed');
                notify(' 转 专');
            }
        }
        
        function addCapitalMovement() {
            const amountStr = prompt('住 住:\n( 驻拽, 砖 砖)');
            if (!amountStr) return;
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount === 0) {
                notify(' 住  转拽', 'error');
                return;
            }
            
            const note = prompt('注专 (驻爪):') || '';
            
            //  Create snapshot BEFORE adding the capital movement
            const typeText = amount > 0 ? '驻拽' : '砖';
            createPortfolioSnapshot(amount > 0 ? 'deposit' : 'withdrawal', `转: ${typeText} ${Math.abs(amount).toLocaleString()}`);
            
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amount,
                type: amount > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderCapitalMovements();
            updateOverview();
            
            notify(` ${typeText} 砖 ${Math.abs(amount).toLocaleString()} 专砖`);
        }
        
        function deleteCapitalMovement(id) {
            if (!confirm(' 拽 转注 ?')) return;
            
            portfolio.capitalMovements = portfolio.capitalMovements.filter(m => m.id !== id);
            saveData();
            renderCapitalMovements();
            updateOverview();
            notify(' 转注 拽');
        }
        
        function renderCapitalMovements() {
            const container = document.getElementById('capital-movements-list');
            if (!container) return;
            
            if (!portfolio.capitalMovements || portfolio.capitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;"> 转注转 </p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px;">转专</th><th>住</th><th>住</th><th>注专</th><th>驻注转</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.capitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+${m.amount.toLocaleString()}` : `-${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? '驻拽' : '砖';
                
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #666;">${m.note || '-'}</td>
                    <td><button onclick="deleteCapitalMovement(${m.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">拽</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Add summary
            const totalCapital = portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                <strong>住"  拽专: ${totalCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderSalesHistory() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            const hasStockSales = portfolio.sales && portfolio.sales.length > 0;
            const hasBondSales = portfolio.bondsSales && portfolio.bondsSales.length > 0;
            
            if (!hasStockSales && !hasBondSales) {
                container.innerHTML = '<p style="text-align: center; color: #999;"> 住专转 专转</p>';
                return;
            }
            
            let html = '';
            
            // 专转 转
            if (hasStockSales) {
                html += '<h4 style="margin-bottom: 15px; color: #3b82f6;"> 专转 转</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">转专</th><th>住</th><th>转</th><th>专 专</th><th>专 拽</th><th>专/驻住</th><th>驻注转</th></tr></thead>';
                html += '<tbody>';
                
                const sortedStocks = [...portfolio.sales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedStocks = 0;
                sortedStocks.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitText = `${getCurrencySymbol(s.currency)}${s.profit.toFixed(2)} (${s.profitPercent}%)`;
                    
                    // Convert to ILS for total
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    totalRealizedStocks += s.profit * rate;
                    
                    html += `<tr style="border-bottom: 1px solid #dbeafe;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.symbol}</strong></td>
                        <td>${s.shares}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.salePrice.toFixed(2)}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteSale(${s.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">锔</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #eff6ff; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                    <strong style="color: #1e40af;">住" 专 砖 转: ${Math.round(totalRealizedStocks).toLocaleString()}</strong>
                </div>`;
            }
            
            // 专转 "
            if (hasBondSales) {
                html += '<h4 style="margin-bottom: 15px; color: var(--warning);"> 专转 "</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #fef3c7;"><th style="padding: 8px;">转专</th><th>砖 拽专</th><th>转</th><th>专 专</th><th>专 拽</th><th>专/驻住</th><th>驻注转</th></tr></thead>';
                html += '<tbody>';
                
                const sortedBonds = [...portfolio.bondsSales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedBonds = 0;
                sortedBonds.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitPercent = ((s.salePrice - s.costBasis) / s.costBasis * 100).toFixed(2);
                    const profitText = `${s.profit.toFixed(2)} (${profitPercent}%)`;
                    
                    totalRealizedBonds += s.profit;
                    
                    html += `<tr style="border-bottom: 1px solid #fde68a;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.fundName}</strong></td>
                        <td>${s.units}</td>
                        <td>${s.salePrice.toFixed(2)}</td>
                        <td>${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteBondSale(${s.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">锔</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                    <strong style="color: #92400e;">住" 专 砖 ": ${Math.round(totalRealizedBonds).toLocaleString()}</strong>
                </div>`;
            }
            
            // 住 
            if (hasStockSales && hasBondSales) {
                const totalStocks = portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0);
                const totalBonds = portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0);
                const grandTotal = totalStocks + totalBonds;
                
                html += `<div style="padding: 15px; background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-radius: 8px; text-align: center; border: 2px solid #8b5cf6;">
                    <strong style="color: #5b21b6; font-size: 1.2rem;"> 住" 专 砖 : ${Math.round(grandTotal).toLocaleString()}</strong>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        function renderAllTransactions() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            // 住祝 转  注住拽转
            const allTransactions = [];
            
            console.log(' Transactions:', portfolio.transactions);
            
            // 住祝 拽转 转 "
            if (portfolio.transactions && portfolio.transactions.length > 0) {
                portfolio.transactions.forEach(t => {
                    //  注住拽 -  转  "
                    allTransactions.push({
                        ...t,
                        displayType: t.assetType === 'bond' ? ' "' : ' ',
                        displayAction: t.type === 'buy' ? ' 拽' : ' 专'
                    });
                });
            }
            
            // 住祝  deposits
            if (portfolio.deposits && portfolio.deposits.length > 0) {
                portfolio.deposits.forEach(d => {
                    allTransactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        assetType: 'cash',
                        symbol: d.note || '驻拽',
                        shares: d.amount,
                        price: 1,
                        currency: d.currency || 'ILS',
                        displayType: ' 驻拽',
                        displayAction: ' 驻拽'
                    });
                });
            }
            
            //  驻 转专
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;"> 注住拽转</p>';
                return;
            }
            
            let html = '<h4 style="margin-bottom: 15px;">  注住拽转</h4>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
            html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">转专</th><th>住</th><th>驻注</th><th>住</th><th>转</th><th>专</th><th>住"</th></tr></thead>';
            html += '<tbody>';
            
            allTransactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const currSymbol = getCurrencySymbol(t.currency || 'ILS');
                const total = (t.shares * t.price).toFixed(2);
                const actionColor = t.type === 'buy' ? '#10b981' : '#ef4444';
                
                html += `<tr style="border-bottom: 1px solid #dbeafe;">
                    <td style="padding: 8px;">${date}</td>
                    <td>${t.displayType}</td>
                    <td style="color: ${actionColor}; font-weight: bold;">${t.displayAction}</td>
                    <td><strong>${t.symbol}</strong></td>
                    <td>${t.shares}</td>
                    <td>${currSymbol}${t.price.toFixed(2)}</td>
                    <td>${currSymbol}${total}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
        
        function deleteSale(id) {
            if (!confirm(' 拽 专  住专?')) return;
            
            portfolio.sales = portfolio.sales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify(' 专 拽 住专');
        }
        
        function deleteBondSale(id) {
            if (!confirm(' 拽 专转 "  住专?')) return;
            
            portfolio.bondsSales = portfolio.bondsSales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify(' 专转 " 拽 住专');
        }
        
        function updateCapitalSummary() {
            const container = document.getElementById('capital-summary');
            if (!container) return;
            
            // === 转 ===
            const stocksCapital = portfolio.capitalMovements ? 
                portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const stocksValue = getTotalValueILS();
            const stocksRealizedProfit = portfolio.sales ?
                portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0) : 0;
            const stocksCost = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            const stocksUnrealizedProfit = stocksValue - stocksCost;
            const stocksTotalProfit = stocksValue - stocksCapital;
            const stocksProfitPercent = stocksCapital > 0 ? (stocksTotalProfit / stocksCapital * 100) : 0;
            
            // === " ===
            const bondsCapital = portfolio.bondsCapitalMovements ?
                portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0);
            const bondsCost = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const bondsRealizedProfit = portfolio.bondsSales ?
                portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0) : 0;
            const bondsUnrealizedProfit = bondsValue - bondsCost;
            const bondsTotalProfit = bondsValue - bondsCapital;
            const bondsProfitPercent = bondsCapital > 0 ? (bondsTotalProfit / bondsCapital * 100) : 0;
            
            // === 住" ===
            const totalCapital = stocksCapital + bondsCapital;
            const totalValue = stocksValue + bondsValue;
            const totalProfit = totalValue - totalCapital;
            const totalProfitPercent = totalCapital > 0 ? (totalProfit / totalCapital * 100) : 0;
            
            let html = '';
            
            // 转
            html += `
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                    <h4 style="margin-bottom: 15px; color: #1e40af;"> 转</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;"> 拽专</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">${stocksCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">砖 </div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">${Math.round(stocksValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">专 砖</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">${Math.round(stocksRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">专  砖</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">${Math.round(stocksUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;"> 专 </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${stocksTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${stocksTotalProfit >= 0 ? '+' : ''}${Math.round(stocksTotalProfit).toLocaleString()} (${stocksProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // "
            html += `
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: #92400e;"> "</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;"> 拽专</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">${bondsCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">砖 </div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">${Math.round(bondsValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">专 砖</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">${Math.round(bondsRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">专  砖</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">${Math.round(bondsUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;"> 专 </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${bondsTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${bondsTotalProfit >= 0 ? '+' : ''}${Math.round(bondsTotalProfit).toLocaleString()} (${bondsProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 住"
            html += `
                <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); padding: 20px; border-radius: 12px; border: 2px solid #8b5cf6;">
                    <h4 style="margin-bottom: 15px; color: #5b21b6;"> 住" 转拽 砖拽注转</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;"> 拽专 </div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">${totalCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">砖 </div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">${Math.round(totalValue).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;"> 专 </div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${totalProfit >= 0 ? '+' : ''}${Math.round(totalProfit).toLocaleString()} (${totalProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 住专
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.95rem;"> 住专 砖:</h4>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                        <strong>专  = 砖  -  拽专</strong><br>
                        <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-right: 3px solid #f59e0b;">
                             <strong>砖:</strong> 砖 拽 砖 转 转注转  (驻拽转 砖转)  转 注转 专砖 爪注转.
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ===========================================
        // CALCULATE CAPITAL FROM HOLDINGS
        // ===========================================
        let selectedHoldings = new Set();
        
        function showCalculateCapitalFromHoldings() {
            if (portfolio.holdings.length === 0) {
                notify('  拽转 转拽', 'error');
                return;
            }
            
            // Reset selection
            selectedHoldings = new Set(portfolio.holdings.map(h => h.id));
            
            // Render checkboxes
            renderHoldingsCheckboxes();
            
            // Show modal
            const modal = document.getElementById('calculate-capital-modal');
            modal.style.display = 'flex';
        }
        
        function hideCalculateCapitalModal() {
            document.getElementById('calculate-capital-modal').style.display = 'none';
        }
        
        function renderHoldingsCheckboxes() {
            const container = document.getElementById('holdings-checkboxes');
            if (!container) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            portfolio.holdings.forEach(h => {
                const cost = h.shares * h.costBasis;
                const costILS = convertToILS(cost, h.currency);
                const checked = selectedHoldings.has(h.id) ? 'checked' : '';
                
                html += `
                    <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid ${checked ? '#3b82f6' : '#e5e7eb'};">
                        <input type="checkbox" ${checked} onchange="toggleHoldingSelection(${h.id})" style="width: 20px; height: 20px; margin-left: 10px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 3px;">${h.symbol}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${h.shares} 转  ${getCurrencySymbol(h.currency)}${h.costBasis.toFixed(2)} = 
                                <strong>${getCurrencySymbol(h.currency)}${cost.toFixed(2)}</strong>
                                ${h.currency !== 'ILS' ? ` (${Math.round(costILS).toLocaleString()})` : ''}
                            </div>
                        </div>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            updateSelectedCapitalTotal();
        }
        
        function toggleHoldingSelection(id) {
            if (selectedHoldings.has(id)) {
                selectedHoldings.delete(id);
            } else {
                selectedHoldings.add(id);
            }
            renderHoldingsCheckboxes();
        }
        
        function updateSelectedCapitalTotal() {
            let total = 0;
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                }
            });
            
            const display = document.getElementById('selected-capital-total');
            if (display) {
                display.textContent = `${Math.round(total).toLocaleString()}`;
            }
        }
        
        function addCalculatedCapital() {
            if (selectedHoldings.size === 0) {
                notify(' 专 驻转 拽 转', 'error');
                return;
            }
            
            let total = 0;
            const selectedSymbols = [];
            
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                    selectedSymbols.push(holding.symbol);
                }
            });
            
            // Add as capital movement
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: Math.round(total),
                type: 'deposit',
                note: `砖 : ${selectedSymbols.join(', ')}`
            });
            
            saveData();
            renderCapitalMovements();
            updateCapitalSummary();
            hideCalculateCapitalModal();
            
            notify(` 住祝  拽专: ${Math.round(total).toLocaleString()}`);
        }
        
        function renderHoldingsList() {
            const container = document.getElementById('holdings-list');
            
            if (!container) {
                console.error(' Holdings list container not found');
                return;
            }
            
            console.log(' Rendering holdings list (Table view). Total:', portfolio.holdings.length);
            
            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;"> 拽转 注</p>
                        <p>抓 注 "住祝 拽"  转</p>
                    </div>
                `;
                return;
            }
            
            //  专转 拽
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--bg-surface); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: var(--bg-elevated);">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">住</th>
                    <th style="padding: 15px; text-align: right; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">拽爪</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">转</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">专 拽</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">专 </th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">砖</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">专/驻住</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">驻注转</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.holdings.forEach(holding => {
                const holdingGroupId = parseInt(holding.groupId);
                const group = portfolio.groups.find(g => g.id === holdingGroupId);
                
                const currentValue = holding.shares * (holding.currentPrice || holding.costBasis);
                const costValue = holding.shares * holding.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? 'var(--profit)' : 'var(--loss)';
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 15px; font-weight: 700; color: var(--text-primary);">
                        ${holding.symbol}
                        ${holding.altTicker ? `<br><span style="font-size: 0.75rem; color: var(--accent);"> ${holding.altTicker}</span>` : ''}
                        ${holding.isManualPrice ? '<span style="font-size: 0.75rem; color: var(--warning); margin-right: 5px;" title="专  - "></span>' : ''}
                    </td>
                    <td style="padding: 15px; color: var(--text-secondary);">
                        ${group ? group.name : ' 注'}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-primary);">
                        ${holding.shares}
                    </td>
                    <td style="padding: 15px; text-align: center; color: var(--text-secondary);">
                        ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-primary);">
                        ${getCurrencySymbol(holding.currency)}${(holding.currentPrice || holding.costBasis).toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: var(--text-primary);">
                        ${getCurrencySymbol(holding.currency)}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showAddSharesForm(${holding.id})" class="btn btn-sm" title="住祝 转" style="background: var(--profit); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                
                            </button>
                            <button onclick="showSellSharesForm(${holding.id})" class="btn btn-sm" title="专" style="background: var(--warning); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                
                            </button>
                            <button onclick="editHolding(${holding.id})" class="btn btn-sm" title="注专" style="background: var(--info); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                锔
                            </button>
                            <button onclick="updatePriceManually(${holding.id})" class="btn btn-sm" title="${holding.isManualPrice ? '专 ' : '注 专'}" style="background: var(--accent); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${holding.isManualPrice ? '' : ''}
                            </button>
                            <button onclick="deleteHolding(${holding.id})" class="btn btn-sm" title="拽" style="background: var(--loss); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                锔
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ===========================================
        // OVERVIEW
        // ===========================================
        
        function updateOverview() {
            console.log(' Starting updateOverview...');
            
            // =============================================
            // CALCULATE EVERYTHING FIRST
            // =============================================
            const stocksValue = getTotalValueILS();
            const bondsValue = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
            const bondsCount = Array.isArray(portfolio.bonds) ? portfolio.bonds.length : 0;
            const totalValue = getTotalPortfolioValue();
            
            //  FIX: Calculate available cash from portfolio.cash (includes currency exchanges!)
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            const availableCash = 
                (portfolio.cash.ILS || 0) + 
                convertToILS(portfolio.cash.USD || 0, 'USD') + 
                convertToILS(portfolio.cash.EUR || 0, 'EUR');
            
            console.log(' Available cash calculation:', {
                ILS: portfolio.cash.ILS,
                USD: portfolio.cash.USD,
                EUR: portfolio.cash.EUR,
                totalILS: availableCash.toFixed(2)
            });
            
            // Deposits & Withdrawals
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            
            //  FIX: Calculate invested amounts from cost basis, not deposits
            const stocksInvested = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            
            const bondsInvested = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => {
                    const cost = b.units * b.costBasis;
                    return sum + convertToILS(cost, b.currency || 'ILS');
                }, 0) : 0;
            
            // TWR Calculation
            const totalTWR = calculateTWR('total');
            
            // =============================================
            // UPDATE MAIN TWR HERO
            // =============================================
            if (totalTWR !== null) {
                const color = totalTWR.total >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('main-twr-display').textContent = 
                    `${totalTWR.total >= 0 ? '+' : ''}${totalTWR.total.toFixed(1)}%`;
                document.getElementById('main-twr-display').style.color = color;
                
                // TWR Breakdown (Base + Live)
                if (totalTWR.base !== undefined && totalTWR.live !== undefined) {
                    document.getElementById('twr-breakdown').textContent = 
                        `Base: ${totalTWR.base >= 0 ? '+' : ''}${totalTWR.base.toFixed(1)}% | Live: ${totalTWR.live >= 0 ? '+' : ''}${totalTWR.live.toFixed(1)}%`;
                } else {
                    document.getElementById('twr-breakdown').textContent = '';
                }
                
                // Absolute Profit
                const profit = totalValue - totalDeposits + totalWithdrawals;
                document.getElementById('main-profit-display').textContent = 
                    `${profit >= 0 ? '+' : ''}${Math.round(profit).toLocaleString()}`;
                document.getElementById('main-profit-display').style.color = profit >= 0 ? '#10b981' : '#ef4444';
                
                // Period Info
                if (totalTWR.years !== undefined) {
                    const days = Math.round(totalTWR.years * 365);
                    document.getElementById('twr-period-info').textContent = 
                        ` 转转 转拽: ${totalTWR.years.toFixed(1)} 砖 (${days} )`;
                }
            } else {
                document.getElementById('main-twr-display').textContent = '--';
                document.getElementById('twr-breakdown').textContent = '爪专 转...';
                document.getElementById('main-profit-display').textContent = '0';
                document.getElementById('twr-period-info').textContent = ' 住祝 驻拽  砖 砖 TWR';
            }
            
            // =============================================
            // UPDATE STOCKS CARD
            // =============================================
            document.getElementById('stocks-value').textContent = `${Math.round(stocksValue).toLocaleString()}`;
            
            const usdTotal = portfolio.holdings.filter(h => h.currency === 'USD')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            const eurTotal = portfolio.holdings.filter(h => h.currency === 'EUR')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            
            document.getElementById('stocks-value-original').textContent = 
                `$${Math.round(usdTotal).toLocaleString()} + ${Math.round(eurTotal).toLocaleString()}`;
            
            document.getElementById('stocks-count').textContent = `${portfolio.holdings.length} 拽转`;
            document.getElementById('stocks-capital').textContent = `${Math.round(stocksInvested).toLocaleString()}`;
            
            // =============================================
            // UPDATE BONDS CARD
            // =============================================
            document.getElementById('bonds-value').textContent = `${Math.round(bondsValue).toLocaleString()}`;
            document.getElementById('bonds-count').textContent = `${bondsCount} 拽专转`;
            document.getElementById('bonds-count-num').textContent = `${bondsCount}`;
            document.getElementById('bonds-cost').textContent = `${Math.round(bondsInvested).toLocaleString()}`;
            
            // =============================================
            // UPDATE TOTAL CARD
            // =============================================
            const totalValueEl = document.getElementById('total-value');
            const totalValue2El = document.getElementById('total-value-2');
            const overviewTotalDepositsEl = document.getElementById('overview-total-deposits');
            
            if (totalValueEl) totalValueEl.textContent = `${Math.round(totalValue).toLocaleString()}`;
            if (totalValue2El) totalValue2El.textContent = `${Math.round(totalValue).toLocaleString()}`;
            if (overviewTotalDepositsEl) overviewTotalDepositsEl.textContent = `砖拽注: ${Math.round(totalDeposits).toLocaleString()}`;
            
            const availableCashOverviewEl = document.getElementById('available-cash-overview');
            if (availableCashOverviewEl) availableCashOverviewEl.textContent = `${Math.round(availableCash).toLocaleString()}`;
            
            // Update last update time
            const now = new Date();
            const lastUpdateTimeEl = document.getElementById('last-update-time');
            if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            
            // =============================================
            // UPDATE CASH FLOW SUMMARY
            // =============================================
            const totalDepositsEl = document.getElementById('total-deposits');
            const totalWithdrawalsEl = document.getElementById('total-withdrawals');
            const availableCashSummaryEl = document.getElementById('available-cash-summary');
            
            if (totalDepositsEl) totalDepositsEl.textContent = `${Math.round(totalDeposits).toLocaleString()}`;
            if (totalWithdrawalsEl) totalWithdrawalsEl.textContent = `${Math.round(totalWithdrawals).toLocaleString()}`;
            if (availableCashSummaryEl) availableCashSummaryEl.textContent = `${Math.round(availableCash).toLocaleString()}`;
            
            // =============================================
            // RENDER OTHER SECTIONS
            // =============================================
            renderAllocationComparison();
            renderPortfolioChart();
            updateAnalysisTab();
        }
        
        function renderAllocationComparison() {
            const container = document.getElementById('allocation-comparison');
            const totalValue = getTotalValueILS();
            
            console.log(' renderAllocationComparison - Total value:', totalValue);
            console.log(' All holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId, groupIdType: typeof h.groupId })));
            
            const html = `<div class="allocation-grid">` + portfolio.groups.map(group => {
                // Handle both string and number groupId
                const groupHoldings = portfolio.holdings.filter(h => {
                    const holdingGroupId = parseInt(h.groupId);
                    return holdingGroupId === group.id;
                });
                
                console.log(` Group ${group.name} (ID: ${group.id}):`, {
                    holdings: groupHoldings.length,
                    symbols: groupHoldings.map(h => h.symbol)
                });
                
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    const ilsValue = convertToILS(value, h.currency);
                    console.log(`  - ${h.symbol}: ${h.shares}  ${h.currentPrice || h.costBasis} ${h.currency} = ${ilsValue.toFixed(2)}`);
                    return sum + ilsValue;
                }, 0);
                
                console.log(`  Total group value: ${groupValue.toFixed(2)}`);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = actualPercent - group.target;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                let diffText = '';
                
                if (Math.abs(diff) < 2) {
                    statusClass = 'balanced';
                    statusIcon = '';
                    statusText = '';
                    diffText = '';
                } else if (diff < 0) {
                    statusClass = 'under';
                    statusIcon = '';
                    statusText = '住专';
                    diffText = `${Math.abs(diff).toFixed(1)}%`;
                } else {
                    statusClass = 'over';
                    statusIcon = '';
                    statusText = '注祝';
                    diffText = `${diff.toFixed(1)}%`;
                }
                
                return `
                    <div class="allocation-row">
                        <div class="allocation-main">
                            <div class="allocation-header">
                                <span class="allocation-name">${group.name}</span>
                                <div class="allocation-numbers">
                                    <span class="allocation-target">
                                        注: <strong>${group.target}%</strong>
                                    </span>
                                    <span class="allocation-actual ${statusClass}">
                                        ${actualPercent.toFixed(1)}%
                                    </span>
                                    <span class="allocation-value">
                                        ${Math.round(groupValue).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <div class="allocation-progress">
                                <div class="allocation-progress-fill ${statusClass}" 
                                     style="width: ${Math.min(actualPercent, 100)}%"></div>
                                <div class="allocation-target-marker" 
                                     style="left: ${group.target}%"></div>
                            </div>
                        </div>
                        <div class="allocation-status ${statusClass}">
                            <div class="allocation-status-icon">${statusIcon}</div>
                            <div class="allocation-status-text">${statusText}</div>
                            ${diffText ? `<div class="allocation-diff">${diffText}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('') + `</div>`;
            
            container.innerHTML = html;
        }
        
        function renderPortfolioChart() {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            const totalValue = getTotalValueILS();
            const data = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                return groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
            });
            
            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: portfolio.groups.map(g => g.name),
                    datasets: [{
                        data: data,
                        backgroundColor: portfolio.groups.map(g => g.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `${context.label}: ${Math.round(value).toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===========================================
        // GROUPS
        // ===========================================
        
        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            const totalValue = getTotalValueILS();
            
            const html = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="group-target">注: ${group.target}% | 驻注: ${actualPercent.toFixed(1)}%</div>
                                <button onclick="editGroup(${group.id})" class="btn btn-primary btn-sm" title="注专 拽爪">
                                    锔 注专
                                </button>
                                <button onclick="deleteGroup(${group.id})" class="btn btn-sm" style="background: var(--loss); color: white;" title="拽 拽爪">
                                    锔
                                </button>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%; background: ${group.color}">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="group-holdings" style="margin-top: 15px; display: grid; gap: 10px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const valueILS = convertToILS(value, h.currency);
                                const holdingPercentOfTotal = totalValue > 0 ? (valueILS / totalValue * 100) : 0;
                                const holdingPercentOfGroup = groupValue > 0 ? (valueILS / groupValue * 100) : 0;
                                const positionTarget = group.positionTargets && group.positionTargets[h.symbol];
                                const targetDiff = positionTarget ? (holdingPercentOfGroup - positionTarget) : null;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-surface); border-radius: 8px; align-items: center; flex-wrap: wrap; gap: 5px;">
                                        <span style="font-weight: 600;">${h.symbol}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                            ${Math.round(valueILS).toLocaleString()} 
                                            <span style="color: ${group.color}; font-weight: 600;">(${holdingPercentOfGroup.toFixed(0)}% 拽爪)</span>
                                            ${positionTarget ? `<span style="color: ${targetDiff >= 0 ? '#10b981' : '#f59e0b'}; font-size: 0.8rem;"> 注: ${positionTarget}%</span>` : ''}
                                            <span style="color: #9ca3af;"> | ${holdingPercentOfTotal.toFixed(1)}% 转拽</span>
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // RECOMMENDATIONS
        // ===========================================
        
        function editGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 砖 拽爪
            const newName = prompt(`注专 砖 拽爪\n\n砖 : ${group.name}\n\n 砖 砖:`, group.name);
            if (newName === null) return;
            if (newName.trim()) group.name = newName.trim();
            
            //  注
            const newTarget = prompt(`注专  注\n\n注 : ${group.target}%\n\n 注 砖 (0-100):`, group.target);
            if (newTarget === null) return;
            const targetNum = parseFloat(newTarget);
            if (!isNaN(targetNum) && targetNum >= 0 && targetNum <= 100) {
                group.target = targetNum;
            }
            
            // 爪注
            const newColor = prompt(`注专 爪注 拽爪\n\n爪注 : ${group.color}\n\n 拽 爪注 (HEX):`, group.color);
            if (newColor === null) return;
            if (newColor.trim()) group.color = newColor.trim();
            
            // 注 驻爪转
            const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
            if (groupHoldings.length > 0) {
                const editPositionTargets = confirm(` 专爪 专 注 驻爪转 拽爪 ?\n\n注 驻砖专  拽注    驻爪 爪专 转 转 拽爪.\n\n抓 砖专 专 注,  .`);
                
                if (editPositionTargets) {
                    // 转  注 驻爪转   拽
                    if (!group.positionTargets) {
                        group.positionTargets = {};
                    }
                    
                    // 注专 注  驻爪 拽砖 注
                    for (const holding of groupHoldings) {
                        const currentTarget = group.positionTargets[holding.symbol] || '';
                        const targetPrompt = prompt(
                            `专 注 -${holding.symbol}\n\n` +
                            `(砖专 专拽   注 住驻爪驻)\n` +
                            `注  转 拽爪 (0-100):`,
                            currentTarget
                        );
                        
                        if (targetPrompt === null) {
                            // 砖转砖 抓 Cancel - 注爪专 转  转
                            break;
                        }
                        
                        if (targetPrompt.trim() === '') {
                            //  专拽, 拽 转 注
                            delete group.positionTargets[holding.symbol];
                        } else {
                            const posTarget = parseFloat(targetPrompt);
                            if (!isNaN(posTarget) && posTarget >= 0 && posTarget <= 100) {
                                group.positionTargets[holding.symbol] = posTarget;
                            }
                        }
                    }
                    
                    // 拽转 住" 注
                    const totalTargets = Object.values(group.positionTargets).reduce((sum, t) => sum + t, 0);
                    if (totalTargets > 100) {
                        notify(`锔 砖 : 住" 注 驻爪转 (${totalTargets.toFixed(0)}%) 注 注 100%`, 'warning');
                    }
                }
            }
            
            saveData();
            renderGroupsList();
            updateOverview();
            notify(` 拽爪 "${group.name}" 注`);
        }
        
        function addGroup() {
            // 砖 拽爪
            const name = prompt(' 砖 拽爪 砖:');
            if (!name || !name.trim()) {
                notify('   砖 拽爪', 'error');
                return;
            }
            
            //  注
            const targetStr = prompt('  注 拽爪 (0-100):', '10');
            if (targetStr === null) return;
            const target = parseFloat(targetStr);
            if (isNaN(target) || target < 0 || target > 100) {
                notify('  注  转拽', 'error');
                return;
            }
            
            // 爪注
            const defaultColors = ['#8b5cf6', '#f59e0b', '#06b6d4', '#ec4899', '#84cc16', '#6366f1'];
            const usedColors = portfolio.groups.map(g => g.color);
            const availableColor = defaultColors.find(c => !usedColors.includes(c)) || '#8b5cf6';
            
            const color = prompt(' 爪注 拽爪 (HEX):', availableColor);
            if (color === null) return;
            
            // 爪专转 ID 砖 - 住驻专  转专 + 1
            const maxId = portfolio.groups.reduce((max, g) => Math.max(max, g.id), 0);
            const newId = maxId + 1;
            
            // 住驻转 拽爪
            const newGroup = {
                id: newId,
                name: name.trim(),
                target: target,
                color: color.trim() || availableColor
            };
            
            portfolio.groups.push(newGroup);
            
            saveData();
            renderGroupsList();
            updateGroupSelect(); // 注 住拽专 住驻转 
            updateOverview();
            notify(` 拽爪 "${newGroup.name}" 住驻 爪`);
        }
        
        function deleteGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // 拽 砖 转 拽爪
            const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === groupId);
            if (groupHoldings.length > 0) {
                notify(`  转 拽 拽爪 "${group.name}" - 砖  ${groupHoldings.length} 转. 注专 转 转 拽爪 专转 转.`, 'error');
                return;
            }
            
            // 拽 砖砖专转 驻转 拽爪 转
            if (portfolio.groups.length <= 1) {
                notify('  转 拽 转 拽爪 专', 'error');
                return;
            }
            
            // 砖专 拽
            if (!confirm(` 拽 转 拽爪 "${group.name}"?`)) {
                return;
            }
            
            // 拽转 拽爪
            portfolio.groups = portfolio.groups.filter(g => g.id !== groupId);
            
            saveData();
            renderGroupsList();
            updateGroupSelect();
            updateOverview();
            notify(` 拽爪 "${group.name}" 拽`);
        }
        
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            const totalValue = getTotalValueILS();
            
            const recommendations = [];
            
            portfolio.groups.forEach(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = group.target - actualPercent;
                
                if (Math.abs(diff) > 2) {
                    recommendations.push({
                        group: group.name,
                        diff: diff,
                        action: diff > 0 ? 'buy' : 'sell'
                    });
                }
            });
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <h3 style="color: var(--profit); margin-bottom: 10px;">转拽  爪!</h3>
                        <p style="color: var(--text-secondary);"> 拽爪转 拽专转 注 砖</p>
                    </div>
                `;
                return;
            }
            
            const html = recommendations.map(rec => {
                const color = rec.action === 'buy' ? '#fef3c7' : '#fee2e2';
                const textColor = rec.action === 'buy' ? '#92400e' : '#991b1b';
                const icon = rec.action === 'buy' ? '' : '';
                const actionText = rec.action === 'buy' ? '拽' : '专';
                
                return `
                    <div class="glass" style="background: ${color}; border: 2px solid ${textColor}40; margin-bottom: 15px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2rem;">${icon}</span>
                            <h4 style="color: ${textColor};">${actionText} ${rec.group}</h4>
                        </div>
                        <p style="color: ${textColor};">
                            ${rec.action === 'buy' 
                                ? `拽爪 住专 ${Math.abs(rec.diff).toFixed(1)}% 注. 拽 , 转拽 拽爪 .`
                                : `拽爪 注驻转 -${Math.abs(rec.diff).toFixed(1)}%. 砖拽 驻住拽 砖拽注  转.`
                            }
                        </p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        
        function saveBonds() {
            portfolio.bonds = parseFloat(document.getElementById('bonds-amount').value) || 0;
            saveData();
            updateOverview();
            notify(' " 砖专');
        }
        
        function exportData() {
            const json = JSON.stringify(portfolio, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify(' 转 爪');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    portfolio = JSON.parse(e.target.result);
                    saveData();
                    updateOverview();
                    renderGroupsList();
                    renderHoldingsList();
                    renderCashFlow();
                    renderTransactions();
                    notify(' 转 ');
                } catch (error) {
                    notify(' 砖 拽专转 拽抓', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
        
        function deleteAllData() {
            const confirmation = confirm('锔  转  砖专爪 拽 转  转?\n\n驻注  转拽 爪转转:\n  转\n  "\n  驻拽转 砖转\n  注住拽转\n  -Snapshots\n\n 转 砖专 转 转!\n\n拽 "拽 "  砖专.');
            
            if (!confirmation) return;
            
            const secondConfirmation = prompt('拽 "拽 " 拽  砖专 拽:');
            
            if (secondConfirmation !== '拽 ') {
                notify(' 拽 ', 'warning');
                return;
            }
            
            // Reset portfolio to empty state
            portfolio = {
                holdings: [],
                groups: [
                    { id: 1, name: ' 注', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '拽/住', target: 10, color: '#ef4444' }
                ],
                rates: {
                    USD: 3.75,
                    EUR: 4.05
                },
                bonds: [],
                deposits: [],
                withdrawals: [],
                purchases: [],
                sales: [],
                snapshots: []
            };
            
            // Save to localStorage
            saveData();
            
            // Refresh all views
            updateOverview();
            renderHoldingsList();
            renderBondsList();
            renderCashFlow();
            
            renderTransactions();
            
            notify('  转 拽', 'success');
        }
        
        function fixSnapshots() {
            if (!confirm(' 驻注  转拽 转  -Snapshots 砖 转爪专 snapshot  砖 注 驻专 注.\n\n砖?')) {
                return;
            }
            
            // Delete all old snapshots
            portfolio.snapshots = [];
            
            // Create one new snapshot with current portfolio value
            const currentValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            
            createSnapshot('fix', '转拽 驻专', 0);
            
            // Update the snapshot to have proper value_before_flow
            if (portfolio.snapshots.length > 0) {
                const newSnapshot = portfolio.snapshots[0];
                newSnapshot.value_before_flow = 0;
                newSnapshot.cash_flow = totalDeposits;
            }
            
            saveData();
            
            updateOverview();
            
            notify(' Snapshots 转拽! TWR 转 转注 注砖.', 'success');
        }

        // ===========================================
        // REBUILD SNAPSHOTS FROM HISTORY
        // ===========================================
        
        function rebuildSnapshotsFromHistory() {
            if (!confirm(' 驻注  转 砖 转  -Snapshots 住专转 驻注转.\n\n驻拽爪 转注专 注  驻拽转 砖转 住专 专 转砖 砖 转 砖 转拽  拽.\n\n砖?')) {
                return;
            }
            
            console.log(' Starting rebuildSnapshotsFromHistory...');
            
            // Step 1: Collect all cash flow events (deposits and withdrawals only)
            const allCashFlows = [];
            
            // Add deposits
            if (Array.isArray(portfolio.deposits)) {
                portfolio.deposits.forEach(d => {
                    allCashFlows.push({
                        type: 'deposit',
                        date: new Date(d.date),
                        amount: d.amount || 0,
                        note: d.note || '驻拽',
                        id: d.id
                    });
                });
            }
            
            // Add withdrawals (as negative amounts)
            if (Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals.forEach(w => {
                    allCashFlows.push({
                        type: 'withdrawal',
                        date: new Date(w.date),
                        amount: -(w.amount || 0),
                        note: w.note || '砖',
                        id: w.id
                    });
                });
            }
            
            // Sort chronologically
            allCashFlows.sort((a, b) => a.date - b.date);
            
            console.log(` Found ${allCashFlows.length} cash flow events to process`);
            
            if (allCashFlows.length === 0) {
                notify('  爪 驻拽转  砖转 住专', 'error');
                return;
            }
            
            // Step 2: Collect all purchases and sales to calculate portfolio value at each point
            const allPurchases = [];
            const allSales = [];
            
            // Stock purchases from holdings
            if (Array.isArray(portfolio.holdings)) {
                portfolio.holdings.forEach(h => {
                    if (h.purchaseDate) {
                        allPurchases.push({
                            type: 'stock',
                            date: new Date(h.purchaseDate),
                            amount: convertToILS(h.shares * h.costBasis, h.currency),
                            symbol: h.symbol
                        });
                    }
                });
            }
            
            // Also check transactions for additional purchases
            if (Array.isArray(portfolio.transactions)) {
                portfolio.transactions.forEach(t => {
                    if (t.type === 'buy' && t.date) {
                        allPurchases.push({
                            type: t.assetType || 'stock',
                            date: new Date(t.date),
                            amount: convertToILS(t.shares * t.price, t.currency || 'ILS'),
                            symbol: t.symbol
                        });
                    } else if (t.type === 'sell' && t.date) {
                        allSales.push({
                            type: t.assetType || 'stock',
                            date: new Date(t.date),
                            amount: convertToILS(t.shares * t.price, t.currency || 'ILS'),
                            symbol: t.symbol
                        });
                    }
                });
            }
            
            // Bond purchases
            if (Array.isArray(portfolio.bonds)) {
                portfolio.bonds.forEach(b => {
                    if (b.purchaseDate) {
                        allPurchases.push({
                            type: 'bond',
                            date: new Date(b.purchaseDate),
                            amount: convertToILS(b.units * b.costBasis, b.currency || 'ILS'),
                            symbol: b.symbol
                        });
                    }
                });
            }
            
            // Sales from portfolio.sales
            if (Array.isArray(portfolio.sales)) {
                portfolio.sales.forEach(s => {
                    allSales.push({
                        type: s.assetType || 'stock',
                        date: new Date(s.date),
                        amount: s.amount || 0,
                        symbol: s.symbol
                    });
                });
            }
            
            // Bond sales
            if (Array.isArray(portfolio.bondsSales)) {
                portfolio.bondsSales.forEach(s => {
                    allSales.push({
                        type: 'bond',
                        date: new Date(s.date),
                        amount: s.amount || 0,
                        symbol: s.symbol
                    });
                });
            }
            
            // Sort purchases and sales
            allPurchases.sort((a, b) => a.date - b.date);
            allSales.sort((a, b) => a.date - b.date);
            
            console.log(` Found ${allPurchases.length} purchases and ${allSales.length} sales`);
            
            // Step 3: Calculate portfolio value at each cash flow event
            // Using cost basis approach (since we don't have historical prices)
            
            function getPortfolioValueAtDate(targetDate) {
                let stocksValue = 0;
                let bondsValue = 0;
                
                // Calculate stocks value at target date using cost basis
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings.forEach(h => {
                        const purchaseDate = h.purchaseDate ? new Date(h.purchaseDate) : new Date(0);
                        if (purchaseDate <= targetDate) {
                            // Use cost basis for historical value
                            stocksValue += convertToILS(h.shares * h.costBasis, h.currency);
                        }
                    });
                }
                
                // Calculate bonds value at target date using cost basis
                if (Array.isArray(portfolio.bonds)) {
                    portfolio.bonds.forEach(b => {
                        const purchaseDate = b.purchaseDate ? new Date(b.purchaseDate) : new Date(0);
                        if (purchaseDate <= targetDate) {
                            // Use cost basis for historical value
                            bondsValue += convertToILS(b.units * b.costBasis, b.currency || 'ILS');
                        }
                    });
                }
                
                // Calculate cash at target date
                let cashValue = 0;
                
                // Add all deposits before target date
                if (Array.isArray(portfolio.deposits)) {
                    portfolio.deposits.forEach(d => {
                        if (new Date(d.date) <= targetDate) {
                            cashValue += d.amount || 0;
                        }
                    });
                }
                
                // Subtract all withdrawals before target date
                if (Array.isArray(portfolio.withdrawals)) {
                    portfolio.withdrawals.forEach(w => {
                        if (new Date(w.date) <= targetDate) {
                            cashValue -= w.amount || 0;
                        }
                    });
                }
                
                // Subtract purchases before target date
                allPurchases.forEach(p => {
                    if (p.date <= targetDate) {
                        cashValue -= p.amount;
                    }
                });
                
                // Add sales before target date
                allSales.forEach(s => {
                    if (s.date <= targetDate) {
                        cashValue += s.amount;
                    }
                });
                
                // Cash can be negative if there were manual adjustments
                cashValue = Math.max(0, cashValue);
                
                return {
                    stocks: stocksValue,
                    bonds: bondsValue,
                    cash: cashValue,
                    total: stocksValue + bondsValue + cashValue
                };
            }
            
            // Step 4: Clear old snapshots and build new ones
            portfolio.snapshots = [];
            
            allCashFlows.forEach((event, index) => {
                // Get portfolio value BEFORE this cash flow
                // To do this, we look at the state just before this event's date
                const valueBeforeDate = new Date(event.date.getTime() - 1000); // 1 second before
                const valueBefore = getPortfolioValueAtDate(valueBeforeDate);
                
                // Create snapshot
                const snapshot = {
                    id: Date.now() + index,
                    date: event.date.toISOString(),
                    value_before_flow: valueBefore.total,
                    cash_flow: event.amount, // positive for deposit, negative for withdrawal
                    stocksValue: valueBefore.stocks,
                    bondsValue: valueBefore.bonds,
                    implicitCash: valueBefore.cash,
                    totalValue: valueBefore.total,
                    triggerType: event.type,
                    triggerNote: event.note
                };
                
                portfolio.snapshots.push(snapshot);
                
                console.log(` Snapshot ${index + 1}:`, {
                    date: event.date.toLocaleDateString('he-IL'),
                    type: event.type,
                    cashFlow: event.amount,
                    valueBefore: valueBefore.total
                });
            });
            
            // Sort snapshots by date
            portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log(` Created ${portfolio.snapshots.length} snapshots from history`);
            
            // Save and update UI
            saveData();
            updateOverview();
            renderCashFlow();
            
            notify(`  砖 ${portfolio.snapshots.length} snapshots 住专转 驻注转!`, 'success');
        }

        // ===========================================
        // ANALYSIS TAB - METRICS & TREEMAP
        // ===========================================
        
        // ========================================
        // MWR (Money-Weighted Return) Calculation
        // ========================================
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        /**
         * Calculate XNPV (Net Present Value with dates)
         * Similar to Excel's XNPV function
         */
        function XNPV(rate, values, dates) {
            if (values.length !== dates.length) {
                return null;
            }
            
            const firstDate = dates[0];
            let npv = 0;
            
            for (let i = 0; i < values.length; i++) {
                const diffDays = (dates[i] - firstDate) / (1000 * 60 * 60 * 24);
                npv += values[i] / Math.pow(1 + rate, diffDays / 365.25);
            }
            
            return npv;
        }
        
        /**
         * Calculate XIRR (Internal Rate of Return with dates)
         * Similar to Excel's XIRR function
         * Returns annualized rate directly
         */
        function XIRR(values, dates, guess = 0.1) {
            if (values.length !== dates.length || values.length < 2) {
                console.log(' XIRR: Invalid input lengths');
                return null;
            }
            
            // Check that we have both positive and negative values
            const hasPositive = values.some(v => v > 0);
            const hasNegative = values.some(v => v < 0);
            if (!hasPositive || !hasNegative) {
                console.log(' XIRR: Need both positive and negative values');
                return null;
            }
            
            console.log(' XIRR starting Newton-Raphson...');
            
            // Newton-Raphson method
            let rate = guess;
            const maxIterations = 100;
            const tolerance = 0.0001;
            
            for (let i = 0; i < maxIterations; i++) {
                const npv = XNPV(rate, values, dates);
                
                if (i % 10 === 0 || i < 5) {
                    console.log(`  Iteration ${i}: rate=${(rate*100).toFixed(4)}%, NPV=${npv.toFixed(2)}`);
                }
                
                if (Math.abs(npv) < tolerance) {
                    console.log(` XIRR converged: ${(rate*100).toFixed(2)}% (${i} iterations)`);
                    return rate; // Already annualized!
                }
                
                // Calculate derivative (dNPV/dRate)
                const firstDate = dates[0];
                let dnpv = 0;
                for (let j = 0; j < values.length; j++) {
                    const diffDays = (dates[j] - firstDate) / (1000 * 60 * 60 * 24);
                    const years = diffDays / 365.25;
                    dnpv -= years * values[j] / Math.pow(1 + rate, years + 1);
                }
                
                if (dnpv === 0) {
                    console.log(`锔 XIRR: dnpv=0 at iteration ${i}`);
                    break;
                }
                
                const newRate = rate - npv / dnpv;
                
                if (!isFinite(newRate) || Math.abs(newRate) > 100) {
                    console.log(`锔 XIRR: newRate out of bounds at iteration ${i}`);
                    break;
                }
                
                if (Math.abs(newRate - rate) < 1e-10) {
                    console.log(` XIRR converged by delta: ${(newRate*100).toFixed(2)}%`);
                    return newRate;
                }
                
                rate = newRate;
            }
            
            console.log('锔 XIRR: Newton-Raphson failed, trying Bisection...');
            
            // If Newton-Raphson fails, try bisection
            let low = -0.99;
            let high = 10.0;
            
            const npvLow = XNPV(low, values, dates);
            const npvHigh = XNPV(high, values, dates);
            
            console.log(` Bisection: NPV(${(low*100).toFixed(0)}%)=${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(0)}%)=${npvHigh.toFixed(2)}`);
            
            if (npvLow * npvHigh > 0) {
                console.log(' XIRR: No solution (NPV does not cross zero)');
                return null; // No solution
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = XNPV(mid, values, dates);
                
                if (i % 10 === 0) {
                    console.log(`  Bisection ${i}: mid=${(mid*100).toFixed(4)}%, NPV=${npvMid.toFixed(4)}`);
                }
                
                if (Math.abs(npvMid) < tolerance) {
                    console.log(` XIRR (Bisection): ${(mid*100).toFixed(2)}%`);
                    return mid;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log(' XIRR: Bisection also failed');
            return null;
        }
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * Returns annualized IRR if period < 1 year
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        function calculateIRR(cashFlows) {
            if (!cashFlows || cashFlows.length < 2) {
                console.log(' IRR: Not enough cash flows');
                return null;
            }
            
            // Sort by date
            const flows = [...cashFlows].sort((a, b) => a.date - b.date);
            
            console.log(' IRR Input flows:', flows.map(f => ({
                date: f.date.toLocaleDateString('he-IL'),
                amount: f.amount.toFixed(2)
            })));
            
            // Check if all flows are same sign (invalid for IRR)
            const allPositive = flows.every(f => f.amount > 0);
            const allNegative = flows.every(f => f.amount < 0);
            
            if (allPositive || allNegative) {
                console.log(' IRR: All cash flows have same sign');
                return null;
            }
            
            // Reference date (earliest date)
            const refDate = flows[0].date;
            
            // Convert dates to years from reference
            const flowsWithYears = flows.map(f => ({
                years: (f.date - refDate) / (1000 * 60 * 60 * 24 * 365.25),
                amount: f.amount
            }));
            
            const totalYears = flowsWithYears[flowsWithYears.length - 1].years;
            
            console.log(` Period: ${totalYears.toFixed(4)} years (${(totalYears * 365.25).toFixed(1)} days)`);
            
            // Newton-Raphson to find IRR for the period (not annualized)
            // For short periods, IRR will be very small, so we need better starting guesses
            const startingGuesses = [0, 0.0001, 0.001, 0.005, 0.01, -0.0001, -0.001, 0.05, 0.1, 0.02];
            
            for (let guess of startingGuesses) {
                let rate = guess;
                const maxIterations = 3000;
                const tolerance = 1e-12; // Tighter tolerance for better accuracy
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let dnpv = 0;
                    
                    flowsWithYears.forEach(f => {
                        const factor = Math.pow(1 + rate, f.years);
                        if (!isFinite(factor) || factor === 0) return;
                        
                        npv += f.amount / factor;
                        dnpv -= f.years * f.amount / (factor * (1 + rate));
                    });
                    
                    // Check both absolute and relative error
                    const absError = Math.abs(npv);
                    const sumAbsFlows = flowsWithYears.reduce((sum, f) => sum + Math.abs(f.amount), 0);
                    const relError = absError / (sumAbsFlows + 1);
                    
                    if (absError < 0.01 || relError < 1e-10) {
                        // Found period IRR, now annualize if needed
                        let annualizedRate = rate;
                        
                        if (totalYears > 0 && totalYears < 1) {
                            // Annualize: (1 + period_rate)^(1/years) - 1
                            annualizedRate = Math.pow(1 + rate, 1 / totalYears) - 1;
                            console.log(` IRR: Period=${(rate*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        } else {
                            console.log(` IRR: ${(rate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        }
                        
                        return annualizedRate;
                    }
                    
                    if (!isFinite(dnpv) || dnpv === 0) break;
                    
                    // Newton step with damping to prevent overshooting
                    const rawStep = -npv / dnpv;
                    const dampingFactor = 0.5; // Use half-steps for stability
                    const newRate = rate + dampingFactor * rawStep;
                    
                    if (!isFinite(newRate) || newRate < -0.99 || newRate > 1000) break;
                    
                    // Check if we're converging
                    if (i > 10 && Math.abs(newRate - rate) < 1e-12) {
                        // Converged in delta, check NPV one more time
                        break;
                    }
                    
                    rate = newRate;
                }
            }
            
            console.log('锔 IRR: Newton-Raphson failed, trying Secant method');
            
            // Secant method as fallback - more stable for difficult cases
            const calcNPV = (rate) => {
                let npv = 0;
                flowsWithYears.forEach(f => {
                    const factor = Math.pow(1 + rate, f.years);
                    if (isFinite(factor) && factor !== 0) {
                        npv += f.amount / factor;
                    }
                });
                return npv;
            };
            
            // Try multiple starting pairs for Secant method
            const secantStarts = [
                [0, 0.001],
                [0, 0.01],
                [-0.001, 0.001],
                [0.001, 0.005],
                [0, 0.0001]
            ];
            
            for (let [r0, r1] of secantStarts) {
                let rate0 = r0;
                let rate1 = r1;
                
                for (let i = 0; i < 2000; i++) {
                    const npv0 = calcNPV(rate0);
                    const npv1 = calcNPV(rate1);
                    
                    if (Math.abs(npv1) < 0.01) {
                        let annualizedRate = rate1;
                        if (totalYears > 0 && totalYears < 1) {
                            annualizedRate = Math.pow(1 + rate1, 1 / totalYears) - 1;
                        }
                        console.log(` IRR (Secant): Period=${(rate1*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}%`);
                        return annualizedRate;
                    }
                    
                    if (Math.abs(npv1 - npv0) < 1e-14) break; // Too close, try next pair
                    
                    const rate2 = rate1 - npv1 * (rate1 - rate0) / (npv1 - npv0);
                    
                    if (!isFinite(rate2) || rate2 < -0.99 || rate2 > 1000) break;
                    
                    rate0 = rate1;
                    rate1 = rate2;
                }
            }
            
            // Last resort: Bisection method (slowest but most reliable)
            console.log('锔 IRR: Secant failed, trying Bisection method');
            
            let low = -0.5;
            let high = 2.0;
            const npvLow = calcNPV(low);
            const npvHigh = calcNPV(high);
            
            console.log(` Bisection: NPV(${(low*100).toFixed(2)}%) = ${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(2)}%) = ${npvHigh.toFixed(2)}`);
            
            // Check if solution is in range
            if (npvLow * npvHigh > 0) {
                console.log(' IRR: No solution found in range (NPV does not cross zero)');
                return null;
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = calcNPV(mid);
                
                if (Math.abs(npvMid) < 0.01 || Math.abs(high - low) < 1e-10) {
                    let annualizedRate = mid;
                    if (totalYears > 0 && totalYears < 1) {
                        annualizedRate = Math.pow(1 + mid, 1 / totalYears) - 1;
                    }
                    console.log(` IRR (Bisection): Period=${(mid*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations)`);
                    return annualizedRate;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log(' IRR: Could not calculate');
            return null;
        }

        
        /**
         * Calculate MWR (Money-Weighted Return) for the entire portfolio
         * MWR = IRR that considers timing of cash flows
         * @returns {number} MWR as percentage (e.g., 15.5 = 15.5%)
         */
        /**
         * Combine cash flows that occur on the same date
         * This is necessary for XIRR to work correctly
         */
        function combineCashFlows(values, dates) {
            const flowMap = new Map();
            
            // Group by date
            for (let i = 0; i < values.length; i++) {
                const dateKey = dates[i].toISOString().split('T')[0]; // Use date only (YYYY-MM-DD)
                if (flowMap.has(dateKey)) {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: flowMap.get(dateKey).value + values[i]
                    });
                } else {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: values[i]
                    });
                }
            }
            
            // Convert back to arrays
            const combinedValues = [];
            const combinedDates = [];
            
            // Sort by date
            const sortedEntries = Array.from(flowMap.entries()).sort((a, b) => 
                new Date(a[0]) - new Date(b[0])
            );
            
            sortedEntries.forEach(([dateKey, flow]) => {
                combinedValues.push(flow.value);
                combinedDates.push(flow.date);
            });
            
            return { values: combinedValues, dates: combinedDates };
        }
        
        /**
         * Calculate annualized returns when IRR is undefined
         * Returns both 365.25-day and 360-day conventions
         */
        function calculateFallbackReturns(values, dates) {
            const totalInvested = values.filter(v => v < 0).reduce((sum, v) => sum + Math.abs(v), 0);
            const totalReceived = values.filter(v => v > 0).reduce((sum, v) => sum + v, 0);
            const profit = totalReceived - totalInvested;
            
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            const periodDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
            
            // Period return
            const periodReturn = profit / totalInvested;
            
            // Simple annualized
            const simpleAnnualized = periodReturn * (365.25 / periodDays);
            
            // Compound annualized - Standard (365.25 days/year)
            const compoundAnnualized365 = Math.pow(1 + periodReturn, 365.25 / periodDays) - 1;
            
            // Compound annualized - Financial (360 days/year)
            const compoundAnnualized360 = Math.pow(1 + periodReturn, 360 / periodDays) - 1;
            
            return {
                periodReturn,
                periodDays,
                simpleAnnualized,
                compoundAnnualized365,
                compoundAnnualized360
            };
        }
        
        function calculateMWR() {
            try {
                //  CORRECT XIRR convention (from INVESTOR perspective):
                // Negative = Money OUT of investor (deposits)
                // Positive = Money INTO investor (withdrawals + final value)
                
                const values = [];
                const dates = [];
                
                // Deposits: Money OUT of investor = NEGATIVE
                console.log(' Deposits:', portfolio.deposits?.length || 0);
                if (portfolio.deposits && portfolio.deposits.length > 0) {
                    portfolio.deposits.forEach((d, idx) => {
                        const amount = d.amount || 0;
                        values.push(-Math.abs(amount)); // NEGATIVE (money leaving investor)
                        dates.push(new Date(d.date));
                        console.log(`  Deposit ${idx}: ${d.date} = -${amount}`);
                    });
                }
                
                // Withdrawals: Money INTO investor = POSITIVE
                console.log(' Withdrawals:', portfolio.withdrawals?.length || 0);
                if (portfolio.withdrawals && portfolio.withdrawals.length > 0) {
                    portfolio.withdrawals.forEach((w, idx) => {
                        const amount = w.amount || 0;
                        values.push(Math.abs(amount)); // POSITIVE (money returning to investor)
                        dates.push(new Date(w.date));
                        console.log(`  Withdrawal ${idx}: ${w.date} = +${amount} (note: ${w.note})`);
                    });
                }
                
                // Current Value: What investor gets back today = POSITIVE
                const currentValue = getTotalPortfolioValue();
                console.log(' Current Value:', currentValue);
                values.push(currentValue); // POSITIVE (as if selling everything)
                dates.push(new Date());
                
                console.log(' Total cash flows (before combining):', values.length);
                console.log(' Sum of flows:', values.reduce((a,b) => a+b, 0).toFixed(2));
                
                if (values.length < 2) {
                    console.log('锔 MWR: Not enough cash flows');
                    return null;
                }
                
                // 猸 COMBINE flows on the same date
                const { values: combinedValues, dates: combinedDates } = combineCashFlows(values, dates);
                
                console.log(' After combining same-date flows:', combinedValues.length);
                console.log(' MWR Cash Flows (combined):', combinedValues.map((v, i) => ({
                    date: combinedDates[i].toLocaleDateString('he-IL'),
                    amount: v.toFixed(2)
                })));
                
                // Calculate XIRR (already returns annualized rate!)
                const xirr = XIRR(combinedValues, combinedDates);
                
                if (xirr === null || !isFinite(xirr)) {
                    console.log('锔 MWR: IRR is mathematically undefined (NPV does not cross zero)');
                    console.log('    Using compound annualized return instead...');
                    
                    // Fallback: Calculate compound annualized return
                    const returns = calculateFallbackReturns(combinedValues, combinedDates);
                    
                    console.log(` Fallback Returns:`);
                    console.log(`   Period: ${returns.periodDays.toFixed(0)} days`);
                    console.log(`   Period Return: ${(returns.periodReturn * 100).toFixed(2)}%`);
                    console.log(`   Simple Annualized: ${(returns.simpleAnnualized * 100).toFixed(2)}%`);
                    console.log(`   Compound (365.25 days/year): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    console.log(`   Compound (360 days/year):    ${(returns.compoundAnnualized360 * 100).toFixed(2)}%`);
                    console.log(` Using Compound (365.25): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    
                    // Return the standard 365.25-day calculation
                    return returns.compoundAnnualized365 * 100;
                }
                
                // XIRR already returns annualized rate - NO double annualization!
                console.log(` MWR calculated: ${(xirr * 100).toFixed(2)}%`);
                return xirr * 100; // Return as percentage
                
            } catch (error) {
                console.error(' Error calculating MWR:', error);
                return null;
            }
        }
        
        // ========================================
        // Portfolio Metrics (Sharpe, Volatility, etc.)
        // ========================================
        
        function calculatePortfolioMetrics() {
            const holdings = portfolio.holdings || [];
            
            if (holdings.length === 0) {
                return {
                    sharpeRatio: 0,
                    maxDrawdown: 0,
                    volatility: 0,
                    winRate: 0,
                    mwr: null
                };
            }
            
            // Calculate returns array (simplified - based on current profit/loss)
            let returns = [];
            let totalInvested = 0;
            let totalCurrent = 0;
            let winners = 0;
            
            holdings.forEach(h => {
                const invested = h.shares * h.costBasis;
                const current = h.shares * (h.currentPrice || h.costBasis);
                const returnPct = ((current - invested) / invested) * 100;
                
                returns.push(returnPct);
                totalInvested += invested;
                totalCurrent += current;
                
                if (returnPct > 0) winners++;
            });
            
            // Win Rate
            const winRate = holdings.length > 0 ? (winners / holdings.length) * 100 : 0;
            
            // Volatility (Standard Deviation of Returns)
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const squaredDiffs = returns.map(r => Math.pow(r - avgReturn, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / returns.length;
            const volatility = Math.sqrt(variance);
            
            // Sharpe Ratio (simplified: avg return / volatility)
            // Assuming risk-free rate = 0 for simplicity
            const sharpeRatio = volatility > 0 ? avgReturn / volatility : 0;
            
            // Max Drawdown (simplified: worst single holding performance)
            const maxDrawdown = returns.length > 0 ? Math.min(...returns) : 0;
            
            // Calculate MWR (Money-Weighted Return)
            const mwr = calculateMWR();
            
            return {
                sharpeRatio: sharpeRatio.toFixed(2),
                maxDrawdown: maxDrawdown.toFixed(2) + '%',
                volatility: volatility.toFixed(2) + '%',
                winRate: winRate.toFixed(1) + '%',
                mwr: mwr !== null ? mwr.toFixed(2) + '%' : 'N/A'
            };
        }
        
        function updateAnalysisTab() {
            const metrics = calculatePortfolioMetrics();
            
            // Update KPI cards - with null safety
            const sharpeEl = document.getElementById('sharpe-ratio');
            const drawdownEl = document.getElementById('max-drawdown');
            const volatilityEl = document.getElementById('volatility');
            const winRateEl = document.getElementById('win-rate');
            const mwrEl = document.getElementById('mwr-value');
            
            if (sharpeEl) sharpeEl.textContent = metrics.sharpeRatio;
            if (drawdownEl) drawdownEl.textContent = metrics.maxDrawdown;
            if (volatilityEl) volatilityEl.textContent = metrics.volatility;
            if (winRateEl) winRateEl.textContent = metrics.winRate;
            if (mwrEl) mwrEl.textContent = metrics.mwr;
            
            // Draw Treemap
            drawTreemap();
        }
        
        function drawTreemap() {
            const container = document.getElementById('treemap-container');
            if (!container) return;
            
            const holdings = portfolio.holdings || [];
            if (holdings.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 1.2rem;"> 转 转拽</div>';
                return;
            }
            
            // Calculate total value
            let totalValue = 0;
            holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                totalValue += convertToILS(value, h.currency);
            });
            
            // Create treemap data
            const treemapData = holdings.map(h => {
                const currentValue = h.shares * (h.currentPrice || h.costBasis);
                const invested = h.shares * h.costBasis;
                const valueILS = convertToILS(currentValue, h.currency);
                const profit = convertToILS(currentValue - invested, h.currency);
                const profitPct = ((currentValue - invested) / invested) * 100;
                const percentage = (valueILS / totalValue) * 100;
                
                return {
                    symbol: h.symbol,
                    value: valueILS,
                    percentage: percentage,
                    profit: profit,
                    profitPct: profitPct
                };
            });
            
            // Sort by value (largest first)
            treemapData.sort((a, b) => b.value - a.value);
            
            // Clear container
            container.innerHTML = '';
            
            // Draw rectangles
            let remainingWidth = 100;
            let remainingHeight = 100;
            let currentX = 0;
            let currentY = 0;
            let rowHeight = 0;
            
            treemapData.forEach((item, index) => {
                // Calculate size based on percentage
                const itemPercentage = item.percentage;
                
                // Simple treemap layout (can be improved)
                let width, height;
                
                if (itemPercentage >= 20) {
                    // Large items get full width
                    width = 100;
                    height = itemPercentage;
                    currentX = 0;
                    currentY += rowHeight;
                    rowHeight = height;
                } else {
                    // Smaller items share rows
                    width = Math.max(itemPercentage * 3, 10);
                    height = 20;
                    
                    if (currentX + width > 100) {
                        currentX = 0;
                        currentY += rowHeight;
                        rowHeight = height;
                    }
                }
                
                // Determine color based on profit
                let color;
                if (item.profitPct > 0) {
                    color = `rgba(16, 185, 129, ${Math.min(item.profitPct / 50, 1)})`; // Green
                } else if (item.profitPct < 0) {
                    color = `rgba(239, 68, 68, ${Math.min(Math.abs(item.profitPct) / 50, 1)})`; // Red
                } else {
                    color = '#9ca3af'; // Gray
                }
                
                // Create rectangle
                const rect = document.createElement('div');
                rect.style.position = 'absolute';
                rect.style.left = currentX + '%';
                rect.style.top = currentY + '%';
                rect.style.width = width + '%';
                rect.style.height = height + '%';
                rect.style.background = color;
                rect.style.border = '1px solid white';
                rect.style.padding = '8px';
                rect.style.boxSizing = 'border-box';
                rect.style.cursor = 'pointer';
                rect.style.transition = 'all 0.3s';
                rect.style.overflow = 'hidden';
                
                // Add content
                const fontSize = width > 15 ? '0.9rem' : '0.7rem';
                rect.innerHTML = `
                    <div style="color: white; font-weight: bold; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.symbol}</div>
                    <div style="color: white; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.percentage.toFixed(1)}%</div>
                    <div style="color: white; font-size: calc(${fontSize} * 0.85); text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.profitPct > 0 ? '+' : ''}${item.profitPct.toFixed(1)}%</div>
                `;
                
                // Hover effect
                rect.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.zIndex = '10';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                
                rect.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.zIndex = '1';
                    this.style.boxShadow = 'none';
                });
                
                container.appendChild(rect);
                
                currentX += width;
                rowHeight = Math.max(rowHeight, height);
            });
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        

        function fixTWR() {
            if (!confirm(' 拽 转  -snapshots 砖 爪专  砖?\n\n 驻住 转 砖 TWR   砖驻注 注 转 专.')) {
                return;
            }
            
            // 拽 snapshots 砖
            portfolio.snapshots = [];
            
            // 爪专 snapshot 砖
            createSnapshot('fix', '转拽 驻专', 0);
            
            saveData();
            updateOverview();
            
            notify(' TWR 转拽! snapshot 砖 爪专.', 'success');
        }

        // ============================================
        // CURRENCY EXCHANGE
        // ============================================
        
        function showCurrencyExchange() {
            const modal = document.createElement('div');
            modal.id = 'exchange-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            // 砖 转专转 :
            // portfolio.cash =  转专转 (ILS, USD, EUR)
            // getImplicitCash = 专拽 拽 砖 deposits-withdrawals-purchases+sales
            
            // 转 portfolio.cash   拽
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            
            modal.innerHTML = `
                <div style="background: var(--bg-surface); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0;"> 专转 注</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">注 拽专:</label>
                        <select id="exchange-from" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="ILS">砖拽 () - 转专: ${Math.round(cashBalances.ILS).toLocaleString()}</option>
                            <option value="USD">专 ($) - 转专: $${cashBalances.USD.toFixed(2)}</option>
                            <option value="EUR">专 () - 转专: ${cashBalances.EUR.toFixed(2)}</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">注 注:</label>
                        <select id="exchange-to" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="USD">专 ($)</option>
                            <option value="ILS">砖拽 ()</option>
                            <option value="EUR">专 ()</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">住 专:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="exchange-amount-from" placeholder="住 拽专" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <span style="padding: 10px; font-size: 24px;"></span>
                            <input type="number" id="exchange-amount-to" placeholder="住 注" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">砖注专 专:</label>
                        <input type="number" id="exchange-rate" step="0.0001" placeholder="砖注专" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">砖注专 注 转 专转, 驻砖专 砖转 转</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="executeCurrencyExchange()" style="flex: 1; padding: 12px; background: var(--profit); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                             爪注 专
                        </button>
                        <button onclick="closeExchangeModal()" style="flex: 1; padding: 12px; background: var(--text-muted); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up event listeners
            const fromSelect = document.getElementById('exchange-from');
            const toSelect = document.getElementById('exchange-to');
            const rateInput = document.getElementById('exchange-rate');
            const amountFromInput = document.getElementById('exchange-amount-from');
            const amountToInput = document.getElementById('exchange-amount-to');
            
            // Update rate when currencies change
            function updateRate() {
                const from = fromSelect.value;
                const to = toSelect.value;
                
                if (from === to) {
                    rateInput.value = '1';
                    return;
                }
                
                // 转 爪 转 砖注专 注 (USD=3.75, EUR=4.05)
                // 注专转 转注 转 驻 转 拽 砖
                let rate = 1;
                if (from === 'ILS' && to === 'USD') {
                    rate = portfolio.rates.USD;  // 爪 3.75 (拽 )
                } else if (from === 'USD' && to === 'ILS') {
                    rate = portfolio.rates.USD;  // 爪 3.75 (驻 )
                } else if (from === 'ILS' && to === 'EUR') {
                    rate = portfolio.rates.EUR;  // 爪 4.05 (拽 )
                } else if (from === 'EUR' && to === 'ILS') {
                    rate = portfolio.rates.EUR;  // 爪 4.05 (驻 )
                } else if (from === 'USD' && to === 'EUR') {
                    rate = portfolio.rates.EUR / portfolio.rates.USD;  // 砖注专 专/专
                } else if (from === 'EUR' && to === 'USD') {
                    rate = portfolio.rates.USD / portfolio.rates.EUR;  // 砖注专 专/专
                }
                
                rateInput.value = rate.toFixed(4);
            }
            
            // Update amount when rate or amount changes
            function updateAmountTo() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountFrom = parseFloat(amountFromInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountFrom) && !isNaN(rate)) {
                    let amountTo;
                    // 拽注  驻  拽
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // -ILS 注 专 - 拽
                        amountTo = amountFrom / rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // 注 专 -ILS - 驻
                        amountTo = amountFrom * rate;
                    } else {
                        //  注转 专 - 驻 砖注专
                        amountTo = amountFrom * rate;
                    }
                    amountToInput.value = amountTo.toFixed(2);
                }
            }
            
            function updateAmountFrom() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountTo = parseFloat(amountToInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountTo) && !isNaN(rate) && rate !== 0) {
                    let amountFrom;
                    // 驻 转 驻注
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // -ILS 注 专 -  拽, 注砖 驻
                        amountFrom = amountTo * rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // 注 专 -ILS -  驻, 注砖 拽
                        amountFrom = amountTo / rate;
                    } else {
                        //  注转 专 - 拽
                        amountFrom = amountTo / rate;
                    }
                    amountFromInput.value = amountFrom.toFixed(2);
                }
            }
            
            fromSelect.addEventListener('change', updateRate);
            toSelect.addEventListener('change', updateRate);
            rateInput.addEventListener('input', updateAmountTo);
            amountFromInput.addEventListener('input', updateAmountTo);
            amountToInput.addEventListener('input', updateAmountFrom);
            
            // Initialize rate
            updateRate();
        }
        
        function closeExchangeModal() {
            const modal = document.getElementById('exchange-modal');
            if (modal) modal.remove();
        }
        
        function executeCurrencyExchange() {
            const from = document.getElementById('exchange-from').value;
            const to = document.getElementById('exchange-to').value;
            const amountFrom = parseFloat(document.getElementById('exchange-amount-from').value);
            const amountTo = parseFloat(document.getElementById('exchange-amount-to').value);
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            
            // Validation
            if (!from || !to || from === to) {
                notify(' 专 注转 砖', 'error');
                return;
            }
            
            if (isNaN(amountFrom) || amountFrom <= 0) {
                notify('  住 转拽 专', 'error');
                return;
            }
            
            if (isNaN(rate) || rate <= 0) {
                notify('  砖注专 专 转拽', 'error');
                return;
            }
            
            // Check balance
            // 砖 转专转 :
            // portfolio.cash =  转专转 (ILS, USD, EUR)
            // getImplicitCash = 专拽 拽 砖 deposits-withdrawals-purchases+sales
            
            // 转 portfolio.cash   拽
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            if (cashBalances[from] < amountFrom) {
                notify(`  住驻拽 转专 -${from}. 转专 转: ${cashBalances[from].toFixed(2)}`, 'error');
                return;
            }
            
            // Execute exchange -  砖转/驻拽转!
            // 专 = 砖拽 住 0,  爪专 砖驻注 注 TWR
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            // 驻砖 注 转 portfolio.cash 砖专转
            portfolio.cash[from] -= amountFrom;
            portfolio.cash[to] += amountTo;
            
            console.log(` 专: ${amountFrom} ${from}  ${amountTo} ${to}`);
            console.log(`   转专转: ILS=${portfolio.cash.ILS}, USD=${portfolio.cash.USD}, EUR=${portfolio.cash.EUR}`);
            
            // Record transaction (for history)
            if (!portfolio.currencyExchanges) portfolio.currencyExchanges = [];
            portfolio.currencyExchanges.push({
                id: Date.now() + 2,
                date: new Date().toISOString(),
                from: from,
                to: to,
                amountFrom: amountFrom,
                amountTo: amountTo,
                rate: rate
            });
            
            saveData();
            renderCashFlow();
            updateOverview();
            
            notify(` 专 爪注: ${amountFrom.toFixed(2)} ${from}  ${amountTo.toFixed(2)} ${to}`, 'success');
            
            closeExchangeModal();
        }
        // ==================== ADVANCED CHARTS (NEW!) ====================
        //  驻拽爪转 爪专转 专驻 转拽
        
        let advancedCharts = {};
        
        async function createAdvancedCharts() {
            console.log(' Creating advanced charts...');
            
            // Destroy existing charts
            Object.values(advancedCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            advancedCharts = {};
            
            // Get theme colors (dark is default, light is with data-theme="light")
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            const textColor = isLight ? '#1f2937' : '#f9fafb';
            const gridColor = isLight ? '#e5e7eb' : '#374151';
            
            createValueOverTimeChart(textColor, gridColor);
            createGainLossChart(textColor, gridColor);
            createCurrencyDistributionChart(textColor, gridColor);
            await createPerformanceComparisonChart(textColor, gridColor);  //  await
            
            console.log(' Advanced charts created successfully!');
        }
        
        function createValueOverTimeChart(textColor, gridColor) {
            const canvas = document.getElementById('value-over-time-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            //  砖砖 -snapshots 转!
            const snapshots = portfolio.snapshots || [];
            
            if (snapshots.length === 0) {
                //  snapshots - 爪 注
                canvas.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);"> 转 住专. 住祝 snapshots  专转 转 转驻转转.</div>';
                return;
            }
            
            //  驻 转专
            const sortedSnapshots = [...snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 转 转
            const labels = [];
            const portfolioValues = [];
            const depositsCumulative = [];
            
            // 砖 驻拽转 爪专转  转专 snapshot
            const deposits = portfolio.deposits || [];
            const withdrawals = portfolio.withdrawals || [];
            
            sortedSnapshots.forEach(snap => {
                const snapDate = new Date(snap.date);
                const label = snapDate.toLocaleDateString('he-IL', { month: 'short', year: '2-digit' });
                labels.push(label);
                
                // 砖 转拽 -snapshot
                const value = (snap.value_before_flow || 0) + (snap.cash_flow || 0);
                portfolioValues.push(value);
                
                // 砖 驻拽转 爪专转 注 转专 
                let cumDeposits = 0;
                deposits.forEach(d => {
                    if (new Date(d.date) <= snapDate) {
                        cumDeposits += d.amount;
                    }
                });
                withdrawals.forEach(w => {
                    if (new Date(w.date) <= snapDate) {
                        cumDeposits -= w.amount;
                    }
                });
                depositsCumulative.push(cumDeposits);
            });
            
            // 住祝 拽 转
            const now = new Date();
            const currentValue = getTotalPortfolioValue();
            labels.push(now.toLocaleDateString('he-IL', { month: 'short', year: '2-digit' }));
            portfolioValues.push(currentValue);
            
            let totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
            let totalWithdrawals = withdrawals.reduce((sum, w) => sum + w.amount, 0);
            depositsCumulative.push(totalDeposits - totalWithdrawals);
            
            advancedCharts.valueOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '砖 转拽 驻注',
                            data: portfolioValues,
                            borderColor: 'var(--profit)',
                            backgroundColor: 'rgba(0, 245, 212, 0.1)',
                            fill: true,
                            tension: 0.2,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: 'var(--profit)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8
                        },
                        {
                            label: '住 驻拽转 ',
                            data: depositsCumulative,
                            borderColor: '#4dabf7',
                            backgroundColor: 'rgba(77, 171, 247, 0.05)',
                            fill: true,
                            tension: 0.2,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4,
                            pointBackgroundColor: '#4dabf7',
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: { size: 13, weight: '600' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'var(--accent)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString();
                                },
                                afterBody: function(context) {
                                    if (context.length >= 2) {
                                        const value = context[0].parsed.y;
                                        const deposits = context[1].parsed.y;
                                        const profit = value - deposits;
                                        return '\n 专: ' + (profit >= 0 ? '+' : '') + '' + Math.round(profit).toLocaleString();
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '转专 (住住 注 snapshots)',
                                color: textColor,
                                font: { size: 12, weight: '600' }
                            },
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '注专 ()',
                                color: textColor,
                                font: { size: 12, weight: '600' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        function createGainLossChart(textColor, gridColor) {
            const canvas = document.getElementById('gain-loss-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            //  专祝 Scatter:  驻爪  爪注
            const holdings = portfolio.holdings || [];
            const bonds = portfolio.bonds || [];
            
            if (holdings.length === 0 && bonds.length === 0) {
                canvas.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);"> 拽转 爪</div>';
                return;
            }
            
            // 砖 砖 
            let totalValue = getTotalPortfolioValue();
            if (totalValue <= 0) totalValue = 1; // 注转 拽 驻住
            
            // 转 转 scatter
            const scatterData = [];
            
            // 转
            holdings.forEach(h => {
                const currentPrice = h.currentPrice || h.costBasis;
                const value = h.shares * currentPrice;
                const valueILS = convertToILS(value, h.currency || 'ILS');
                const costValue = h.shares * h.costBasis;
                const costILS = convertToILS(costValue, h.currency || 'ILS');
                
                const sizePercent = (valueILS / totalValue) * 100;
                const returnPercent = costILS > 0 ? ((valueILS - costILS) / costILS) * 100 : 0;
                
                scatterData.push({
                    name: h.symbol,
                    x: sizePercent,
                    y: returnPercent,
                    value: valueILS,
                    type: 'stock'
                });
            });
            
            // "
            bonds.forEach(b => {
                const value = b.units * (b.currentPrice || b.costBasis);
                const valueILS = convertToILS(value, b.currency || 'ILS');
                const costValue = b.units * b.costBasis;
                const costILS = convertToILS(costValue, b.currency || 'ILS');
                
                const sizePercent = (valueILS / totalValue) * 100;
                const returnPercent = costILS > 0 ? ((valueILS - costILS) / costILS) * 100 : 0;
                
                scatterData.push({
                    name: b.symbol,
                    x: sizePercent,
                    y: returnPercent,
                    value: valueILS,
                    type: 'bond'
                });
            });
            
            //  驻  (爪专  拽转)
            scatterData.sort((a, b) => b.x - a.x);
            
            advancedCharts.gainLoss = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '拽转',
                        data: scatterData.map(d => ({ x: d.x, y: d.y, name: d.name, value: d.value, type: d.type })),
                        backgroundColor: scatterData.map(d => 
                            d.y >= 0 ? 'rgba(0, 245, 212, 0.7)' : 'rgba(255, 107, 107, 0.7)'
                        ),
                        borderColor: scatterData.map(d => 
                            d.y >= 0 ? '#00f5d4' : '#ff6b6b'
                        ),
                        borderWidth: 2,
                        pointRadius: scatterData.map(d => Math.max(6, Math.min(20, d.x * 0.8))),
                        pointHoverRadius: scatterData.map(d => Math.max(8, Math.min(24, d.x * 0.8 + 4))),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            callbacks: {
                                label: function(ctx) {
                                    const point = ctx.raw;
                                    return [
                                        ' ' + point.name + (point.type === 'bond' ? ' (")' : ''),
                                        ' : ' + point.x.toFixed(1) + '% 转拽',
                                        ' 砖: ' + Math.round(point.value).toLocaleString(),
                                        ' 转砖: ' + (point.y >= 0 ? '+' : '') + point.y.toFixed(1) + '%'
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: ' 驻爪 (% 转拽)',
                                color: textColor,
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: gridColor },
                            ticks: { 
                                color: textColor,
                                callback: val => val.toFixed(0) + '%'
                            },
                            min: 0
                        },
                        y: {
                            title: {
                                display: true,
                                text: '转砖 (%)',
                                color: textColor,
                                font: { size: 12, weight: '600' }
                            },
                            grid: { color: gridColor },
                            ticks: { 
                                color: textColor,
                                callback: val => (val >= 0 ? '+' : '') + val.toFixed(0) + '%'
                            }
                        }
                    }
                }
            });
        }
        
        function createCurrencyDistributionChart(textColor, gridColor) {
            const canvas = document.getElementById('currency-distribution-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 砖 拽 注转 - 转拽 砖!
            let ilsTotal = 0;
            let usdTotal = 0;
            let eurTotal = 0;
            
            // 转
            portfolio.holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                if (h.currency === 'ILS') {
                    ilsTotal += value;
                } else if (h.currency === 'USD') {
                    // 砖专 转 住 注 拽专 (专)
                    usdTotal += value;
                } else if (h.currency === 'EUR') {
                    // 砖专 转 住 注 拽专 (专)
                    eurTotal += value;
                }
            });
            
            // " (专  砖拽)
            if (portfolio.bonds) {
                portfolio.bonds.forEach(b => {
                    ilsTotal += b.units * b.currentPrice;
                });
            }
            
            // 
            if (portfolio.cash) {
                ilsTotal += portfolio.cash.ILS || 0;
                usdTotal += portfolio.cash.USD || 0;
                eurTotal += portfolio.cash.EUR || 0;
            }
            
            // 专 砖拽 爪专 砖 
            const ilsTotalInILS = ilsTotal;
            const usdTotalInILS = usdTotal * portfolio.rates.USD;
            const eurTotalInILS = eurTotal * portfolio.rates.EUR;
            const grandTotal = ilsTotalInILS + usdTotalInILS + eurTotalInILS;
            
            console.log(' Currency Distribution:');
            console.log(`   ILS: ${ilsTotal.toFixed(2)} (${(ilsTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   USD: $${usdTotal.toFixed(2)} = ${usdTotalInILS.toFixed(2)} (${(usdTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   EUR: ${eurTotal.toFixed(2)} = ${eurTotalInILS.toFixed(2)} (${(eurTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   Total: ${grandTotal.toFixed(2)}`);
            
            advancedCharts.currencyDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['砖拽 ()', '专 ($)', '专 ()'],
                    datasets: [{
                        data: [ilsTotalInILS, usdTotalInILS, eurTotalInILS],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b'
                        ],
                        borderWidth: 3,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = grandTotal > 0 ? (value / grandTotal * 100).toFixed(1) : 0;
                                    return context.label + ': ' + Math.round(value).toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function createPerformanceComparisonChart(textColor, gridColor) {
            const canvas = document.getElementById('performance-comparison-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            //  砖 TWR 砖 转拽 (转砖 砖拽转  - 砖 转 转专!)
            let portfolioReturn = 0;
            let comparisonNote = '';
            
            const twrResult = calculateTWRv3();
            if (twrResult && twrResult.total !== undefined) {
                portfolioReturn = twrResult.total;  // 专 
                comparisonNote = 'TWR';
                console.log(' Using TWR for comparison:', portfolioReturn.toFixed(2) + '%');
            } else {
                // Fallback 砖 驻砖   snapshots
                const totalValue = getTotalPortfolioValue();
                const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + d.amount, 0);
                const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + w.amount, 0);
                
                if (totalDeposits > 0) {
                    const netProfit = totalValue - totalDeposits + totalWithdrawals;
                    portfolioReturn = (netProfit / totalDeposits) * 100;
                }
                comparisonNote = '驻砖';
                console.log(' Using simple return for comparison:', portfolioReturn.toFixed(2) + '%');
            }
            
            //  爪 转专 拽 专砖
            const firstDate = getFirstPurchaseDate();
            console.log(' First purchase date:', firstDate.toISOString().split('T')[0]);
            
            //  砖 转砖转 拽住 "专转" -  砖拽注转 拽住 转 转专 住
            let acwiReturn = 10;   // fallback - MSCI ACWI
            let spyReturn = 12;    // fallback - S&P 500
            let qqqReturn = 15;    // fallback - NASDAQ
            let dataSource = '爪注 2020-2024';
            let useVirtualCalc = false;
            
            try {
                const deposits = portfolio.deposits || [];
                
                if (deposits.length > 0) {
                    console.log(' Calculating virtual index returns based on', deposits.length, 'deposits...');
                    
                    // 砖 专 - 砖 转!
                    const [acwiResult, spyResult, qqqResult] = await Promise.allSettled([
                        calculateVirtualIndexReturn('ACWI', deposits),   // iShares MSCI ACWI
                        calculateVirtualIndexReturn('SPY', deposits),    // SPDR S&P 500
                        calculateVirtualIndexReturn('QQQ', deposits)     // Invesco QQQ
                    ]);
                    
                    if (acwiResult.status === 'fulfilled' && acwiResult.value !== null) {
                        acwiReturn = acwiResult.value;
                        useVirtualCalc = true;
                        console.log(' ACWI virtual:', acwiReturn.toFixed(2) + '%');
                    } else {
                        console.log('锔 ACWI virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('ACWI', firstDate);
                        if (simple !== null) acwiReturn = simple;
                    }
                    
                    if (spyResult.status === 'fulfilled' && spyResult.value !== null) {
                        spyReturn = spyResult.value;
                        console.log(' SPY virtual:', spyReturn.toFixed(2) + '%');
                    } else {
                        console.log('锔 SPY virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('SPY', firstDate);
                        if (simple !== null) spyReturn = simple;
                    }
                    
                    if (qqqResult.status === 'fulfilled' && qqqResult.value !== null) {
                        qqqReturn = qqqResult.value;
                        console.log(' QQQ virtual:', qqqReturn.toFixed(2) + '%');
                    } else {
                        console.log('锔 QQQ virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('QQQ', firstDate);
                        if (simple !== null) qqqReturn = simple;
                    }
                    
                    dataSource = useVirtualCalc ? '砖 转' : `-${firstDate.toLocaleDateString('he-IL')}`;
                } else {
                    //  驻拽转 - 砖转砖 砖 驻砖
                    console.log(' No deposits, using simple return calculation');
                    const [acwiResult, spyResult, qqqResult] = await Promise.allSettled([
                        fetchHistoricalReturn('ACWI', firstDate),
                        fetchHistoricalReturn('SPY', firstDate),
                        fetchHistoricalReturn('QQQ', firstDate)
                    ]);
                    
                    if (acwiResult.status === 'fulfilled' && acwiResult.value !== null) acwiReturn = acwiResult.value;
                    if (spyResult.status === 'fulfilled' && spyResult.value !== null) spyReturn = spyResult.value;
                    if (qqqResult.status === 'fulfilled' && qqqResult.value !== null) qqqReturn = qqqResult.value;
                    
                    dataSource = `-${firstDate.toLocaleDateString('he-IL')}`;
                }
                
            } catch (error) {
                console.error(' Using averages:', error.message);
            }
            
            console.log(' Performance:', portfolioReturn.toFixed(1) + '% | ACWI:', acwiReturn.toFixed(1) + '% | SPY:', spyReturn.toFixed(1) + '% | QQQ:', qqqReturn.toFixed(1) + '%');
            
            advancedCharts.performanceComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [`转拽 砖 (${comparisonNote})`, 'MSCI ACWI', 'S&P 500', 'NASDAQ'],
                    datasets: [{
                        label: `转砖 (${dataSource})`,
                        data: [portfolioReturn, acwiReturn, spyReturn, qqqReturn],
                        backgroundColor: [
                            portfolioReturn >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            portfolioReturn >= 0 ? '#10b981' : '#ef4444',
                            '#3b82f6',
                            '#667eea',
                            '#f59e0b'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return '转砖: ' + (context.parsed.y >= 0 ? '+' : '') + context.parsed.y.toFixed(1) + '%';
                                },
                                afterLabel: function(context) {
                                    if (context.dataIndex === 0) {
                                        return '爪注 转拽 砖';
                                    } else {
                                        return dataSource;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '拽住',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '转砖 (%)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value + '%';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== END ADVANCED CHARTS ====================
        
        window.onload = function() {
            console.log('');
            console.log(' VERSION: v49 - Smart TWR (Auto/Manual)');
            console.log('    Multi-currency cash tracking');
            console.log('    Enhanced TWR calculation');
            console.log('    Fee configuration by symbol');
            console.log('    Proper bond pricing (% of face value)');
            console.log('');
            console.log(' Initializing portfolio with bonds actions...');
            console.log(' Portfolio data structure:', portfolio);
            
            // 拽专 -init  注 转
            init();
        }
        
        async function init() {
            await loadData();  // Load from localStorage
            console.log(' Loaded holdings:', portfolio.holdings.length);
            
            updateOverview();
            updateGroupSelect();
            renderHoldingsList();
            renderCashFlow();
            
            
            renderTransactions();
            
            // 注转 注专 专转
            document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
            document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
            
            // Hide loading screen with animation
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    if (mainContent) mainContent.style.display = 'block';
                    
                    // Initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    // Create advanced charts after content is visible
                    setTimeout(() => {
                        createAdvancedCharts();
                    }, 300);
                }, 300);
            }
            
            // 住 注  (专拽注 -  住)
            autoUpdateExchangeRates().then(success => {
                if (success) {
                    updateOverview();
                    console.log(' Auto-update successful');
                } else {
                    console.log('癸 Using manual rates');
                }
            });
            
            notify(' 注专转  注 专驻 转拽!', 'success');
            console.log(' Portfolio initialized successfully');
            console.log('');
            console.log(' Debug Info:');
            console.log('  - Holdings:', portfolio.holdings.length);
            console.log('  - Groups:', portfolio.groups.length);
            console.log('  - USD Rate:', portfolio.rates.USD);
            console.log('  - EUR Rate:', portfolio.rates.EUR);
            console.log('  - Bonds:', portfolio.bonds);
            console.log('');
            console.log(' To add a holding, click "住祝 拽" and fill the form');
            console.log(' To refresh prices, click "专注 专"');
            console.log(' To view advanced charts, click on "专驻" tab');
            console.log(' To toggle dark mode, click the moon/sun icon');
            console.log('');
            
            // 砖专 转 转 专 注
            saveData();
        };
        
        // Expose functions to window for HTML onclick handlers
        window.showTab = showTab;
        window.addHolding = addHolding;
        window.editHolding = editHolding;
        window.deleteHolding = deleteHolding;
        window.updatePriceManually = updatePriceManually;
        window.showAddSharesForm = showAddSharesForm;
        window.hideAddSharesModal = hideAddSharesModal;
        window.submitAddShares = submitAddShares;
        window.showSellSharesForm = showSellSharesForm;
        window.hideSellSharesModal = hideSellSharesModal;
        window.submitSellShares = submitSellShares;
        window.addCapitalMovement = addCapitalMovement;
        window.deleteCapitalMovement = deleteCapitalMovement;
        window.deleteSale = deleteSale;
        window.filterTransactions = filterTransactions;
        window.deleteTransaction = deleteTransaction;
        window.showEditTransactionDate = showEditTransactionDate;
        window.hideEditDateModal = hideEditDateModal;
        window.submitEditDate = submitEditDate;
        window.deleteDeposit = deleteDeposit;
        window.deleteWithdrawal = deleteWithdrawal;
        window.showCalculateCapitalFromHoldings = showCalculateCapitalFromHoldings;
        window.hideCalculateCapitalModal = hideCalculateCapitalModal;
        window.toggleHoldingSelection = toggleHoldingSelection;
        window.addCalculatedCapital = addCalculatedCapital;
        window.showAddBondForm = showAddBondForm;
        window.hideAddBondForm = hideAddBondForm;
        window.saveBond = saveBond;
        window.addBondUnits = addBondUnits;
        window.hideAddBondUnitsModal = hideAddBondUnitsModal;
        window.submitAddBondUnits = submitAddBondUnits;
        window.sellBondUnits = sellBondUnits;
        window.hideSellBondUnitsModal = hideSellBondUnitsModal;
        window.submitSellBondUnits = submitSellBondUnits;
        window.editBond = editBond;
        window.deleteBond = deleteBond;
        window.refreshBondPrices = refreshBondPrices;
        window.refreshPrices = refreshPrices;
        window.showCurrencyExchange = showCurrencyExchange;
        window.closeExchangeModal = closeExchangeModal;
        window.executeCurrencyExchange = executeCurrencyExchange;
        window.fixTWR = fixTWR;
        window.showAddHoldingForm = showAddHoldingForm;
        window.hideAddHoldingForm = hideAddHoldingForm;
        window.calculateInvestment = calculateInvestment;
        window.editGroup = editGroup;
        window.addGroup = addGroup;
        window.deleteGroup = deleteGroup;
        window.fixGroupIds = fixGroupIds;
        window.updateExchangeRates = updateExchangeRates;
        window.tryAutoUpdateRates = tryAutoUpdateRates;
        window.exportData = exportData;
        window.importData = importData;
        window.showDepositModal = showDepositModal;
        window.hideDepositModal = hideDepositModal;
        window.submitDeposit = submitDeposit;
        window.showWithdrawalModal = showWithdrawalModal;
        window.hideWithdrawalModal = hideWithdrawalModal;
        window.submitWithdrawal = submitWithdrawal;
        window.toggleTheme = toggleTheme;
        window.deleteAllData = deleteAllData;
        window.fixSnapshots = fixSnapshots;
        window.rebuildSnapshotsFromHistory = rebuildSnapshotsFromHistory;
        
        // TWR Enhancement v45 exports
        window.calculateTWREnhanced = calculateTWREnhanced;
        window.getTotalPortfolioValueEnhanced = getTotalPortfolioValueEnhanced;
        window.rebuildCashFromHistory = rebuildCashFromHistory;
        window.portfolio = portfolio;
        window.saveData = saveData;
        window.getAssetCurrency = getAssetCurrency;
        window.calculateFeeForTransaction = calculateFeeForTransaction;
        window.getTotalCashILS = getTotalCashILS;
        window.calculateStocksValueILS = calculateStocksValueILS;
        window.calculateBondsValueILS = calculateBondsValueILS;
        window.initializeCash = initializeCash;
        
        console.log(' All functions exposed to window');

    
        // Initialize theme from localStorage on load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log(' Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('锔 Service Worker registration failed:', error);
                    });
            });
        }

    </script>
</body>
</html>