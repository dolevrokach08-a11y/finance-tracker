<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Portfolio Tracker v52</title>
    
    <!-- Google Fonts - Space Grotesk for modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js - Fixed CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ==================== DARK FINTECH THEME ==================== */
        :root {
            /* Dark backgrounds */
            --bg-base: #0a0a0f;
            --bg-surface: #12121a;
            --bg-elevated: #1a1a24;
            --bg-hover: #22222e;
            
            /* Accent - Neon Cyan */
            --accent: #00f5d4;
            --accent-dim: rgba(0, 245, 212, 0.15);
            --accent-glow: 0 0 20px rgba(0, 245, 212, 0.3);
            
            /* Text */
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            
            /* Status Colors */
            --profit: #00f5d4;
            --loss: #ff6b6b;
            --warning: #ffd93d;
            --info: #4dabf7;
            --success: #00f5d4;
            --danger: #ff6b6b;
            
            /* Borders */
            --border: rgba(255, 255, 255, 0.1);
            --border-accent: rgba(0, 245, 212, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
            
            /* Legacy mapping */
            --bg-primary: #12121a;
            --bg-secondary: #1a1a24;
            --bg-tertiary: #22222e;
            --bg-gradient-start: #6366f1;
            --bg-gradient-end: #8b5cf6;
            --card-bg: #12121a;
            --glass-bg: rgba(18, 18, 26, 0.95);
            --shadow-color: rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.4);
            
            /* Misc */
            --radius: 16px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-base: #f8f9fa;
            --bg-surface: #ffffff;
            --bg-elevated: #f1f3f5;
            --bg-hover: #e9ecef;
            
            --accent: #00b894;
            --accent-dim: rgba(0, 184, 148, 0.12);
            --accent-glow: 0 0 20px rgba(0, 184, 148, 0.2);
            
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a7a;
            --text-muted: #8b8ba0;
            
            --profit: #00b894;
            --loss: #e74c3c;
            --success: #00b894;
            --danger: #e74c3c;
            
            --border: rgba(0, 0, 0, 0.08);
            --border-accent: rgba(0, 184, 148, 0.3);
            --border-color: rgba(0, 0, 0, 0.08);
            
            --bg-primary: #ffffff;
            --bg-secondary: #f1f3f5;
            --bg-tertiary: #e9ecef;
            --card-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-color: rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.08);
        }
        
        /* ==================== BASIC RESET & RTL ==================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Heebo', 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-base);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Numbers - Monospace */
        .mono, .value, [data-value], .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: 'tnum';
        }
        
        /* ==================== LAYOUT ==================== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 220px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 20px 12px;
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        
        .sidebar-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 32px;
            padding: 0 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.9rem;
            font-family: inherit;
            width: 100%;
            text-align: right;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent-dim);
            color: var(--accent);
        }
        
        .nav-item i, .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        
        .nav-item.active i, .nav-item.active svg {
            opacity: 1;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .theme-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            font-family: inherit;
            text-align: right;
            transition: all 0.15s ease;
        }
        
        .theme-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 220px;
            padding: 24px 32px;
            min-height: 100vh;
        }
        
        /* ==================== LOADING SCREEN ==================== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-base);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-elevated);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .loading-text {
            color: var(--accent);
            margin-top: 24px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .loading-subtext {
            color: var(--text-muted);
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== CARDS ==================== */
        .glass, .card {
            background: var(--bg-surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .glass:hover, .card:hover {
            border-color: var(--border-accent);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        /* ==================== PAGE HEADER ==================== */
        .page-header {
            margin-bottom: 24px;
        }
        
        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .page-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        /* Hide old header */
        .header {
            display: none;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: absolute;
            top: 0;
            left: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.5rem;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(15deg);
        }
        
        /* ==================== NAVIGATION LINKS ==================== */
        .nav-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ==================== TABS (Hidden - using sidebar) ==================== */
        .tabs {
            display: none;
        }
        
        .tab-btn {
            display: none;
        }
        
        .tab-content { 
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active { display: block; }
        
        /* ==================== SUB-TABS ==================== */
        .sub-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            width: fit-content;
            border: 1px solid var(--border);
        }
        
        .sub-tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sub-tab-btn i, .sub-tab-btn svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        
        .sub-tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .sub-tab-btn:hover i {
            opacity: 1;
        }
        
        .sub-tab-btn.active {
            background: var(--accent-dim);
            color: var(--accent);
            font-weight: 600;
        }
        
        .sub-tab-btn.active i {
            opacity: 1;
        }
        
        .sub-tab-content {
            display: none;
        }
        
        .sub-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== ADDITIONAL MODERN ENHANCEMENTS ==================== */
        
        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Selection styling */
        ::selection {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
        }
        
        /* Focus visible for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            letter-spacing: 0.3px;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.12);
            color: #059669;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.12);
            color: #dc2626;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.12);
            color: #d97706;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.12);
            color: #2563eb;
        }
        
        body.dark-mode .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        body.dark-mode .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        body.dark-mode .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }
        
        body.dark-mode .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 0.9rem;
        }
        
        /* Card hover effect */
        .card-interactive {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .card-interactive:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Stat change indicator */
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        /* ==================== SUMMARY CARDS ==================== */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: var(--bg-surface);
            color: var(--text-primary);
            padding: 20px 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            display: none;
        }
        
        .summary-card:hover {
            border-color: var(--border-accent);
        }
        
        .summary-card.green {
            border-color: var(--profit);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(0, 245, 212, 0.08) 100%);
        }
        
        .summary-card.green:hover {
            box-shadow: 0 0 20px rgba(0, 245, 212, 0.15);
        }
        
        .summary-card.purple {
            border-color: #a855f7;
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(168, 85, 247, 0.08) 100%);
        }
        
        .summary-card.blue {
            border-color: var(--info);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(77, 171, 247, 0.08) 100%);
        }
        
        .summary-card.orange {
            border-color: var(--warning);
            background: linear-gradient(135deg, var(--bg-surface) 0%, rgba(255, 217, 61, 0.08) 100%);
        }
        
        .summary-card h3 { 
            font-size: 0.75rem; 
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .summary-card .value { 
            font-size: 1.6rem; 
            font-weight: 600; 
            margin-bottom: 4px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        .summary-card .sub { 
            font-size: 0.8rem; 
            color: var(--text-secondary);
        }
        
        /* ==================== CHARTS CONTAINER ==================== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .chart-container {
            background: var(--glass-bg);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            height: 400px;
            border: 1px solid var(--border-color);
            transition: all 0.25s ease;
        }
        
        .chart-container:hover {
            box-shadow: 0 14px 44px var(--shadow-color);
        }
        
        .chart-container.large {
            grid-column: 1 / -1;
            height: 500px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        canvas {
            max-height: 100%;
        }
        
        /* ==================== FORMS ==================== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 11px 14px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        .form-group input::placeholder {
            color: var(--text-muted);
        }
        
        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #0a0a0f;
            box-shadow: 0 2px 8px var(--accent-dim);
        }
        
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: var(--accent-glow);
        }
        
        .btn-success {
            background: var(--profit);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(0, 245, 212, 0.25);
        }
        
        .btn-success:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(0, 245, 212, 0.4);
        }
        
        .btn-danger {
            background: var(--loss);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.25);
        }
        
        .btn-danger:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(255, 107, 107, 0.4);
        }
        
        .btn-warning {
            background: var(--warning);
            color: #0a0a0f;
            box-shadow: 0 2px 8px rgba(255, 217, 61, 0.25);
        }
        
        .btn-warning:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 16px rgba(255, 217, 61, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: var(--radius-sm);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 10000;
            opacity: 0;
            transition: all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            border-right: 4px solid var(--accent);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success {
            background: rgba(0, 245, 212, 0.15);
            color: var(--profit);
            border-right-color: var(--profit);
        }
        
        .notification.error {
            background: rgba(255, 107, 107, 0.15);
            color: var(--loss);
            border-right-color: var(--loss);
        }
        
        .notification.warning {
            background: rgba(255, 217, 61, 0.15);
            color: var(--warning);
            border-right-color: var(--warning);
        }
        
        [data-theme="light"] .notification.success {
            background: #ecfdf5;
            color: #065f46;
        }
        
        [data-theme="light"] .notification.error {
            background: #fef2f2;
            color: #991b1b;
        }
        
        [data-theme="light"] .notification.warning {
            background: var(--bg-elevated);
            color: #92400e;
        }
        
        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .theme-toggle {
                top: -10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                white-space: nowrap;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: 0;
                height: 350px;
            }
            
            .glass {
                padding: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                flex-direction: column;
            }
            
            .nav-link {
                justify-content: center;
            }
        }
        
        /* ==================== TABLES ==================== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-surface);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        thead {
            background: var(--bg-elevated);
        }
        
        thead th {
            padding: 14px 16px;
            text-align: right;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }
        
        tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        tbody tr {
            transition: background 0.15s ease;
        }
        
        tbody tr:hover {
            background: var(--bg-hover);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* ==================== UTILITY CLASSES ==================== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        
        /* Profit/Loss colors */
        .profit, .text-profit, .text-success, .positive { color: var(--profit) !important; }
        .loss, .text-loss, .text-danger, .negative { color: var(--loss) !important; }
        .text-warning { color: var(--warning) !important; }
        .text-info { color: var(--info) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .text-secondary { color: var(--text-secondary) !important; }
        .text-primary { color: var(--text-primary) !important; }
        .text-accent { color: var(--accent) !important; }
        
        /* Font weights */
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        /* Font sizes */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        
        /* ==================== PULSE ANIMATION FOR LIVE DATA ==================== */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    
        .calculator-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .calculator-header h3 {
            margin: 0;
            color: #92400e;
            font-size: 1.5rem;
        }
        
        .calc-input-group {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
        }
        
        .calc-results {
            display: none;
            background: var(--bg-surface);
            border-radius: 8px;
            padding: 20px;
        }
        
        .calc-results.active {
            display: block;
        }
        
        #calc-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-right: 4px solid #667eea;
        }
        
        .calc-item strong {
            color: #111827;
        }
        
        .calc-item span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Calculator card - Dark theme default */
        .calculator-card {
            background: var(--bg-elevated);
            border: 1px solid var(--warning);
        }
        
        .calculator-header h3 {
            color: var(--warning);
        }
        
        .calc-results {
            background: var(--bg-surface);
        }
        
        .calc-item {
            background: var(--bg-hover);
            border-right-color: var(--accent);
        }
        
        .calc-item strong {
            color: var(--text-primary);
        }
        
        /* Modals - Dark theme default */
        [id$="-modal"] > div,
        .modal-box {
            background: var(--bg-surface);
            color: var(--text-primary);
        }
        
        [id$="-modal"] h3 {
            color: var(--text-primary);
        }
        
        [id$="-modal"] label {
            color: var(--text-secondary);
        }
        
        .modal-header,
        .modal-footer {
            border-color: var(--border);
        }
        
        /* Light theme overrides */
        [data-theme="light"] .calculator-card {
            background: var(--bg-elevated);
            border-color: var(--warning);
        }
        
        [data-theme="light"] .calculator-header h3 {
            color: #92400e;
        }
        
        [data-theme="light"] .calc-results {
            background: var(--bg-surface);
        }
        
        [data-theme="light"] .calc-item {
            background: #f9fafb;
        }
        
        [data-theme="light"] .calc-item strong {
            color: #111827;
        }

        /* ==================== ALLOCATION COMPARISON - IMPROVED ==================== */
        .allocation-grid {
            display: grid;
            gap: 12px;
        }
        
        .allocation-row {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .allocation-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .allocation-main {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .allocation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .allocation-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .allocation-numbers {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .allocation-target {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .allocation-actual {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .allocation-actual.balanced { color: var(--profit); }
        .allocation-actual.under { color: var(--warning); }
        .allocation-actual.over { color: var(--loss); }
        
        .allocation-value {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .allocation-progress {
            position: relative;
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: visible;
        }
        
        .allocation-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .allocation-progress-fill.balanced { background: var(--profit); }
        .allocation-progress-fill.under { background: var(--warning); }
        .allocation-progress-fill.over { background: var(--loss); }
        
        .allocation-target-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        .allocation-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .allocation-status.balanced {
            background: rgba(16, 185, 129, 0.15);
            color: var(--profit);
        }
        
        .allocation-status.under {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .allocation-status.over {
            background: rgba(239, 68, 68, 0.15);
            color: var(--loss);
        }
        
        .allocation-status-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }
        
        .allocation-status-text {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .allocation-diff {
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            .allocation-row {
                grid-template-columns: 1fr;
            }
            
            .allocation-status {
                flex-direction: row;
                gap: 10px;
                justify-content: flex-start;
            }
            
            .allocation-numbers {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

    
        /* Snapshot Data Modal */
        #snapshot-data-modal .modal-content {
            direction: rtl;
            text-align: right;
        }
        #snapshot-data-modal input[type="number"] {
            text-align: left;
            direction: ltr;
        }
        #snapshot-data-modal table {
            border-collapse: collapse;
        }
        #snapshot-data-modal th, #snapshot-data-modal td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        /* ==================== MODERN MODAL STYLES ==================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-box {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Form styles inside modals */
        .modal-form-group {
            margin-bottom: 18px;
        }
        
        .modal-form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .modal-form-group input,
        .modal-form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .modal-form-group input:focus,
        .modal-form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        /* ==================== DARK MODE FIXES ==================== */
        /* Fix hardcoded light backgrounds */
        :root .glass[style*="fef3c7"],
        :root .glass[style*="fee2e2"],
        :root .glass[style*="d1fae5"],
        :root .glass[style*="fecaca"],
        :root .glass[style*="fde68a"],
        :root .glass[style*="a7f3d0"] {
            background: var(--bg-elevated) !important;
            border-color: var(--border) !important;
        }
        
        /* Fix inline colored text */
        [style*="color: var(--profit)"] { color: var(--profit) !important; }
        [style*="color: var(--loss)"] { color: var(--loss) !important; }
        [style*="color: var(--warning)"] { color: var(--warning) !important; }
        
        /* Fix allocation status colors */
        .allocation-status.balanced {
            background: var(--accent-dim);
            color: var(--profit);
        }
        
        .allocation-status.under {
            background: rgba(255, 217, 61, 0.15);
            color: var(--warning);
        }
        
        .allocation-status.over {
            background: rgba(255, 107, 107, 0.15);
            color: var(--loss);
        }
        
        /* Fix chart legends */
        .chart-legend, 
        canvas + div,
        [class*="legend"] {
            color: var(--text-primary) !important;
        }
        
        /* Fix currency legends */
        .currency-legend span,
        .chart-container span {
            color: var(--text-primary) !important;
        }
        
        /* Fix holding rows */
        .holding-row, .bond-row, tr {
            color: var(--text-primary);
        }
        
        /* Fix modal backgrounds */
        .modal-content {
            background: var(--bg-surface) !important;
            border: 1px solid var(--border);
        }
        
        /* Fix input fields */
        input, select, textarea {
            background: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        
        input::placeholder {
            color: var(--text-muted) !important;
        }
        
        /* Fix buttons with inline styles */
        button[style*="background: var(--loss)"] {
            background: var(--loss) !important;
        }
        
        button[style*="background: var(--warning)"] {
            background: var(--warning) !important;
        }
        
        button[style*="background: var(--profit)"] {
            background: var(--profit) !important;
        }
        
        /* Fix light mode overrides */
        [data-theme="light"] .glass[style*="fef3c7"],
        [data-theme="light"] .glass[style*="fee2e2"],
        [data-theme="light"] .glass[style*="d1fae5"] {
            /* Allow original colors in light mode */
            background: inherit !important;
            border-color: inherit !important;
        }
        
        /* ==================== SCROLLBAR ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 180px;
            }
            .main-content {
                margin-right: 180px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                top: auto;
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 8px 12px;
                border-left: none;
                border-top: 1px solid var(--border);
                overflow-x: auto;
            }
            
            .sidebar-logo { display: none; }
            
            .sidebar-nav {
                flex-direction: row;
                gap: 4px;
                overflow-x: auto;
            }
            
            .nav-item {
                padding: 8px 12px;
                flex-direction: column;
                gap: 2px;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            .sidebar-footer { display: none; }
            
            .main-content {
                margin-right: 0;
                padding: 16px;
                padding-bottom: 80px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">◊ò◊ï◊¢◊ü ◊™◊ô◊ß ◊î◊©◊ß◊¢◊ï◊™</div>
        <div class="loading-subtext">◊ê◊†◊ê ◊î◊û◊™◊ü...</div>
    </div>

    <!-- App Container -->
    <div id="mainContent" style="display: none;" class="app-container">
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-logo">
                <span style="font-size: 1.3rem;">üìà</span>
                Portfolio
            </div>
            
            <div class="sidebar-nav">
                <button class="nav-item active" onclick="showTab('overview')">
                    <i data-lucide="layout-dashboard"></i>
                    <span>◊°◊ô◊õ◊ï◊ù</span>
                </button>
                <button class="nav-item" onclick="showTab('portfolio')">
                    <i data-lucide="briefcase"></i>
                    <span>◊™◊ô◊ß</span>
                </button>
                <button class="nav-item" onclick="showTab('performance')">
                    <i data-lucide="trending-up"></i>
                    <span>◊ë◊ô◊¶◊ï◊¢◊ô◊ù</span>
                </button>
                <button class="nav-item" onclick="showTab('planning')">
                    <i data-lucide="calculator"></i>
                    <span>◊™◊õ◊†◊ï◊ü</span>
                </button>
                <button class="nav-item" onclick="showTab('history')">
                    <i data-lucide="clock"></i>
                    <span>◊î◊ô◊°◊ò◊ï◊®◊ô◊î</span>
                </button>
                <button class="nav-item" onclick="showTab('settings')">
                    <i data-lucide="settings"></i>
                    <span>◊î◊í◊ì◊®◊ï◊™</span>
                </button>
            </div>
            
            <div class="sidebar-footer">
                <button class="theme-btn" onclick="toggleTheme()">
                    <span id="theme-icon">‚òÄÔ∏è</span>
                    <span>◊û◊¶◊ë ◊ë◊î◊ô◊®</span>
                </button>
                <a href="finance.html" class="nav-item" target="_blank" style="margin-top: 8px; text-decoration: none;">
                    <i data-lucide="external-link"></i>
                    <span>◊û◊¢◊ß◊ë ◊õ◊°◊§◊ô</span>
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Hidden old header -->
            <div class="header" style="display:none;"></div>
            <div class="nav-links" style="display:none;"></div>
            
            <!-- Main Glass Container -->
            <div class="glass">
                <!-- Hidden old tabs (for JS compatibility) -->
                <div class="tabs" style="display:none;">
                    <button class="tab-btn active" onclick="showTab('overview')">◊°◊ô◊õ◊ï◊ù</button>
                    <button class="tab-btn" onclick="showTab('portfolio')">◊™◊ô◊ß</button>
                    <button class="tab-btn" onclick="showTab('performance')">◊ë◊ô◊¶◊ï◊¢◊ô◊ù</button>
                    <button class="tab-btn" onclick="showTab('planning')">◊™◊õ◊†◊ï◊ü</button>
                    <button class="tab-btn" onclick="showTab('history')">◊î◊ô◊°◊ò◊ï◊®◊ô◊î</button>
                    <button class="tab-btn" onclick="showTab('settings')">◊î◊í◊ì◊®◊ï◊™</button>
                </div>

                <!-- Sub-Tabs Container (shown dynamically) -->
                <div id="sub-tabs-container" class="sub-tabs" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- ===== TAB: OVERVIEW ===== -->
                <div id="tab-overview" class="tab-content active">
                    <div class="page-header">
                        <h1>üíº ◊°◊ô◊õ◊ï◊ù ◊™◊ô◊ß ◊î◊î◊©◊ß◊¢◊ï◊™</h1>
                        <p>◊û◊ë◊ò ◊¢◊ú ◊î◊ë◊ô◊¶◊ï◊¢◊ô◊ù ◊ï◊î◊™◊©◊ï◊ê◊ï◊™ ◊©◊ú◊ö</p>
                    </div>

                    <!-- Main TWR Hero Card -->
                    <div class="summary-grid">
                        <div class="summary-card purple">
                            <h3><i data-lucide="trending-up"></i> ◊™◊©◊ï◊ê◊î ◊õ◊ï◊ú◊ú◊™ (TWR)</h3>
                            <div class="value" id="main-twr-display">--</div>
                            <div class="sub" id="twr-breakdown">◊ë◊ò◊¢◊ô◊†◊î...</div>
                            <div class="sub" id="twr-period-info" style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                                üìÖ ◊û◊™◊ó◊ô◊ú◊™ ◊î◊™◊ô◊ß
                            </div>
                        </div>

                        <div class="summary-card green">
                            <h3><i data-lucide="dollar-sign"></i> ◊®◊ï◊ï◊ó/◊î◊§◊°◊ì ◊û◊ï◊ó◊ú◊ò</h3>
                            <div class="value" id="main-profit-display">‚Ç™0</div>
                            <div class="sub" id="overview-total-deposits">◊î◊ï◊©◊ß◊¢: ‚Ç™0</div>
                        </div>

                        <div class="summary-card blue">
                            <h3><i data-lucide="wallet"></i> ◊©◊ï◊ï◊ô ◊õ◊ï◊ú◊ú</h3>
                            <div class="value" id="total-value">‚Ç™0</div>
                            <div class="sub">◊†◊õ◊°◊ô◊ù + ◊û◊ñ◊ï◊û◊ü</div>
                        </div>
                    </div>

                    <!-- Asset Cards Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Stocks Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #0ea5e9; padding: 20px;">
                            <h3 style="color: #0c4a6e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i> ◊û◊†◊ô◊ï◊™
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #0ea5e9;" id="stocks-value">‚Ç™0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);" id="stocks-value-original">$0 + ‚Ç¨0</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);">◊î◊ó◊ñ◊ß◊ï◊™</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-count">0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">◊î◊ï◊©◊ß◊¢</div>
                                    <div style="font-weight: 600; color: #0c4a6e;" id="stocks-capital">‚Ç™0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bonds Card -->
                        <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                            <h3 style="color: #78350f; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="file-text" style="width: 24px; height: 24px;"></i> ◊ê◊í"◊ó
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô</div>
                                <div style="font-size: 2rem; font-weight: bold; color: var(--warning);" id="bonds-value">‚Ç™0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);" id="bonds-count">0 ◊ß◊®◊†◊ï◊™</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);">◊ß◊®◊†◊ï◊™</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-count-num">0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">◊î◊ï◊©◊ß◊¢</div>
                                    <div style="font-weight: 600; color: #78350f;" id="bonds-cost">‚Ç™0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Total Card -->
                        <div class="glass" style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border: 2px solid #8b5cf6; padding: 20px;">
                            <h3 style="color: #4c1d95; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="wallet" style="width: 24px; height: 24px;"></i> ◊õ◊ï◊ú◊ú
                            </h3>
                            <div style="background: var(--bg-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊©◊ï◊ï◊ô ◊õ◊ï◊ú◊ú</div>
                                <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;" id="total-value-2">‚Ç™0</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">◊†◊õ◊°◊ô◊ù + ◊û◊ñ◊ï◊û◊ü</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-secondary);">◊û◊ñ◊ï◊û◊ü ◊ñ◊û◊ô◊ü</div>
                                    <div style="font-weight: 600; color: #4c1d95;" id="available-cash-overview">‚Ç™0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">◊¢◊ì◊õ◊ï◊ü</div>
                                    <div style="font-weight: 600; color: #4c1d95; font-size: 0.75rem;" id="last-update-time">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Summary -->
                    <div class="glass" style="margin-bottom: 20px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="arrow-right-left"></i> ◊™◊ñ◊®◊ô◊ù ◊û◊ñ◊ï◊û◊†◊ô◊ù
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊î◊©◊ß◊¢◊™◊ô ◊ë◊™◊ô◊ß</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--profit);" id="total-deposits">‚Ç™0</div>
                            </div>
                            <div style="padding: 15px; background: #fef2f2; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊û◊©◊õ◊™◊ô ◊û◊î◊™◊ô◊ß</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--loss);" id="total-withdrawals">‚Ç™0</div>
                            </div>
                            <div style="padding: 15px; background: #f0fdf4; border-radius: 8px;">
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">◊û◊ñ◊ï◊û◊ü ◊§◊†◊ï◊ô</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;" id="available-cash-summary">‚Ç™0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Allocation Comparison -->
                    <div class="glass" style="padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="target"></i> ◊î◊™◊ê◊û◊î ◊ú◊ô◊¢◊ì
                        </h3>
                        <div id="allocation-comparison"></div>
                    </div>

                    <!-- Current Allocation Chart -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="portfolio-chart"></canvas>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button onclick="refreshPrices()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                            <i data-lucide="refresh-cw"></i> ◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô ◊û◊†◊ô◊ï◊™
                        </button>
                        
                        <button onclick="fixGroupIds()" class="btn btn-warning" style="flex: 1; min-width: 200px;">
                            <i data-lucide="wrench"></i> ◊™◊ß◊ü ◊ß◊ë◊ï◊¶◊ï◊™
                        </button>
                    </div>
                </div>

                <!-- ===== TAB: CHARTS (NEW!) ===== -->
                <div id="tab-charts" class="tab-content">
                    <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 25px;">
                        üìä ◊í◊®◊§◊ô◊ù ◊û◊™◊ß◊ì◊û◊ô◊ù
                    </h2>
                    
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1rem;">
                        ◊û◊¢◊ß◊ë ◊ï◊ô◊ñ◊ï◊ê◊ú◊ô ◊ê◊ó◊® ◊ë◊ô◊¶◊ï◊¢◊ô ◊î◊™◊ô◊ß ◊©◊ú◊ö ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü
                    </p>

                    <div class="charts-grid">
                        <!-- Portfolio Value Over Time -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="trending-up"></i>
                                ◊î◊™◊§◊™◊ó◊ï◊™ ◊¢◊®◊ö ◊î◊™◊ô◊ß ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü
                            </div>
                            <canvas id="value-over-time-chart"></canvas>
                        </div>

                        <!-- Gain/Loss Over Time -->
                        <div class="chart-container large">
                            <div class="chart-title">
                                <i data-lucide="bar-chart-2"></i>
                                ◊®◊ï◊ï◊ó/◊î◊§◊°◊ì ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü
                            </div>
                            <canvas id="gain-loss-chart"></canvas>
                        </div>

                        <!-- Currency Distribution -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="pie-chart"></i>
                                ◊î◊™◊§◊ú◊í◊ï◊™ ◊û◊ò◊ë◊¢◊ï◊™
                            </div>
                            <canvas id="currency-distribution-chart"></canvas>
                        </div>

                        <!-- Performance Comparison -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <i data-lucide="activity"></i>
                                ◊ë◊ô◊¶◊ï◊¢◊ô◊ù ◊ô◊ó◊°◊ô◊™ ◊ú◊ê◊ô◊†◊ì◊ß◊°
                            </div>
                            <canvas id="performance-comparison-chart"></canvas>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                                üìå ◊î◊©◊ï◊ï◊ê◊î ◊î◊ï◊í◊†◊™: ◊û◊î ◊î◊ô◊î ◊ß◊ï◊®◊î ◊ê◊ù ◊î◊ô◊ô◊™ ◊û◊©◊ß◊ô◊¢ ◊ë◊ê◊ô◊†◊ì◊ß◊° ◊ë◊ê◊ï◊™◊ù ◊™◊ê◊®◊ô◊õ◊ô◊ù ◊ï◊°◊õ◊ï◊û◊ô◊ù ◊©◊î◊§◊ß◊ì◊™ ◊ú◊™◊ô◊ß.
                            </div>
                        </div>
                    </div>
                </div>

<div id="tab-analysis" class="tab-content">
                <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 15px;">
                    üî¨ ◊†◊ô◊™◊ï◊ó ◊û◊™◊ß◊ì◊ù ◊©◊ú ◊î◊™◊ô◊ß
                </h2>
                
                <!-- Info Box -->
                <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-right: 4px solid #3b82f6;">
                    <div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.6;">
                        üí° <strong>TWR vs MWR:</strong> 
                        TWR (◊ë◊ò◊ê◊ë ◊°◊ô◊õ◊ï◊ù) ◊û◊ï◊ì◊ì ◊ë◊ô◊¶◊ï◊¢◊ô ◊î◊©◊ï◊ß ◊ë◊ú◊ô ◊î◊©◊§◊¢◊™ ◊™◊ñ◊û◊ï◊ü ◊î◊î◊§◊ß◊ì◊ï◊™. 
                        <strong>MWR</strong> (◊õ◊ê◊ü ◊ú◊û◊ò◊î) ◊û◊ó◊©◊ë ◊™◊©◊ï◊ê◊î ◊©◊û◊™◊ó◊©◊ë◊™ ◊ë◊™◊ñ◊û◊ï◊ü - ◊ê◊ù ◊î◊§◊ß◊ì◊™ ◊õ◊°◊£ ◊ë◊û◊ï◊¢◊ì ◊ò◊ï◊ë/◊®◊¢.
                    </div>
                </div>

                <!-- KPI Cards Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Sharpe Ratio Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üìà</div>
                            <div style="font-size: 0.85rem; color: #1e40af; font-weight: 600; margin-bottom: 10px;">Sharpe Ratio</div>
                            <div id="sharpe-ratio" style="font-size: 2.5rem; font-weight: bold; color: #2563eb; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ◊™◊©◊ï◊ê◊î ◊û◊ï◊ú ◊°◊ô◊õ◊ï◊ü<br>
                                <span style="color: #16a34a;">‚Üë ◊ô◊ï◊™◊® ◊ò◊ï◊ë</span>
                            </div>
                        </div>
                    </div>

                    <!-- Max Drawdown Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üìâ</div>
                            <div style="font-size: 0.85rem; color: #991b1b; font-weight: 600; margin-bottom: 10px;">Max Drawdown</div>
                            <div id="max-drawdown" style="font-size: 2.5rem; font-weight: bold; color: #dc2626; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ◊ô◊®◊ô◊ì◊î ◊û◊ß◊°◊ô◊û◊ú◊ô◊™<br>
                                <span style="color: #16a34a;">‚Üë ◊ß◊®◊ï◊ë ◊ú-0% ◊ô◊ï◊™◊® ◊ò◊ï◊ë</span>
                            </div>
                        </div>
                    </div>

                    <!-- Volatility Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üìä</div>
                            <div style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 10px;">Volatility</div>
                            <div id="volatility" style="font-size: 2.5rem; font-weight: bold; color: #d97706; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ◊°◊ò◊ô◊ô◊™ ◊™◊ß◊ü ◊©◊†◊™◊ô◊™<br>
                                <span style="color: #16a34a;">‚Üì ◊§◊ó◊ï◊™ ◊™◊†◊ï◊ì◊ï◊™</span>
                            </div>
                        </div>
                    </div>

                    <!-- Win Rate Card -->
                    <div class="glass" style="background: var(--bg-elevated); border: 1px solid var(--border); padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
                            <div style="font-size: 0.85rem; color: #065f46; font-weight: 600; margin-bottom: 10px;">Win Rate</div>
                            <div id="win-rate" style="font-size: 2.5rem; font-weight: bold; color: #059669; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ◊ê◊ó◊ï◊ñ ◊û◊†◊ô◊ï◊™ ◊ë◊®◊ï◊ï◊ó<br>
                                <span style="color: #16a34a;">‚Üë ◊ô◊ï◊™◊® ◊ò◊ï◊ë</span>
                            </div>
                        </div>
                    </div>

                    <!-- MWR Card -->
                    <div class="glass" style="background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%); border: 2px solid #a855f7; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üí∞</div>
                            <div style="font-size: 0.85rem; color: #6b21a8; font-weight: 600; margin-bottom: 10px;">MWR (IRR)</div>
                            <div id="mwr-value" style="font-size: 2.5rem; font-weight: bold; color: #9333ea; margin-bottom: 10px;">-</div>
                            <div style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
                                ◊™◊©◊ï◊ê◊î ◊û◊©◊ï◊ß◊ú◊ú◊™ ◊õ◊°◊£<br>
                                <span style="color: #16a34a;">◊õ◊ï◊ú◊ú timing</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Treemap Section -->
                <div class="glass" style="padding: 25px;">
                    <h3 style="text-align: center; color: var(--text-primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">üå≥</span>
                        <span>◊û◊§◊™ ◊î◊™◊ô◊ß (Treemap)</span>
                    </h3>
                    <div style="text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 20px;">
                        ◊í◊ï◊ì◊ú = ◊û◊©◊ß◊ú ◊ë◊™◊ô◊ß | ◊¶◊ë◊¢ = ◊®◊ï◊ï◊ó/◊î◊§◊°◊ì
                    </div>
                    <div id="treemap-container" style="width: 100%; height: 500px; position: relative; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: #f9fafb;">
                        <!-- Treemap will be drawn here -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary);">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--profit); border-radius: 4px;"></div>
                            <span>◊®◊ï◊ï◊ó</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--text-muted); border-radius: 4px;"></div>
                            <span>◊†◊ô◊ò◊®◊ú◊ô</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 20px; height: 20px; background: var(--loss); border-radius: 4px;"></div>
                            <span>◊î◊§◊°◊ì</span>
                        </div>
                    </div>
                </div>

            </div>



                <!-- ===== PLACEHOLDER FOR OTHER TABS ===== -->
                
<!-- Holdings Tab -->
            
<div id="tab-calculator" class="tab-content">
                <div class="calculator-card">
                    <div class="calculator-header">
                        <span style="font-size: 2rem;">üßÆ</span>
                        <h3>◊û◊ó◊©◊ë◊ï◊ü ◊ó◊ú◊ï◊ß◊™ ◊î◊©◊ß◊¢◊î</h3>
                    </div>
                    
                    <p style="color: #92400e; margin-bottom: 20px;">
                        ◊î◊ñ◊ü ◊°◊õ◊ï◊ù ◊©◊ê◊™◊î ◊®◊ï◊¶◊î ◊ú◊î◊©◊ß◊ô◊¢ ◊ï◊î◊û◊¢◊®◊õ◊™ ◊™◊ó◊©◊ë ◊ú◊ö ◊ê◊ô◊ö ◊ú◊ó◊ú◊ß ◊ê◊ï◊™◊ï ◊ë◊ô◊ü ◊î◊û◊†◊ô◊ï◊™ ◊¢◊ú ◊§◊ô ◊î◊§◊¢◊®◊ô◊ù ◊û◊î◊ô◊¢◊ì
                    </p>

                    <div class="calc-input-group">
                        <div class="form-group" style="flex: 1;">
                            <label>◊°◊õ◊ï◊ù ◊ú◊î◊©◊ß◊¢◊î (‚Ç™)</label>
                            <input type="number" id="invest-amount" placeholder="10000" step="100">
                        </div>
                        <button onclick="console.log('üî• BUTTON CLICKED!'); try { calculateInvestment(); } catch(e) { console.error('üí• Error:', e); }" class="btn btn-success">
                            ‚ú® ◊ó◊©◊ë ◊ó◊ú◊ï◊ß◊î
                        </button>
                    </div>

                    <div id="calc-results" class="calc-results">
                        <h4 style="margin-bottom: 15px; color: #111827;">üí° ◊î◊û◊ú◊¶◊™ ◊ó◊ú◊ï◊ß◊î:</h4>
                        <div id="calc-items"></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>◊°◊î"◊õ:</span>
                                <span id="calc-total" style="color: var(--accent); font-size: 1.2rem;">‚Ç™0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">‚ÑπÔ∏è ◊ê◊ô◊ö ◊ñ◊î ◊¢◊ï◊ë◊ì?</h4>
                    <ul style="color: #1e3a8a; line-height: 1.8;">
                        <li>◊î◊û◊¢◊®◊õ◊™ ◊û◊ó◊©◊ë◊™ ◊ê◊™ ◊î◊§◊¢◊® ◊©◊ú ◊õ◊ú ◊ß◊ë◊ï◊¶◊î ◊û◊î◊ô◊¢◊ì ◊©◊ú◊î</li>
                        <li>◊î◊ß◊ë◊ï◊¶◊ï◊™ ◊¢◊ù ◊î◊§◊¢◊® ◊î◊í◊ì◊ï◊ú ◊ë◊ô◊ï◊™◊® ◊û◊ß◊ë◊ú◊ï◊™ ◊ô◊ï◊™◊® ◊õ◊°◊£</li>
                        <li>◊ë◊™◊ï◊ö ◊õ◊ú ◊ß◊ë◊ï◊¶◊î, ◊î◊î◊©◊ß◊¢◊î ◊û◊™◊ó◊ú◊ß◊™ ◊ë◊ê◊ï◊§◊ü ◊©◊ï◊ï◊î ◊ë◊ô◊ü ◊î◊û◊†◊ô◊ï◊™</li>
                        <li>◊ñ◊î ◊¢◊ï◊ñ◊® ◊ú◊ö ◊ú◊©◊û◊ï◊® ◊¢◊ú ◊î◊™◊û◊î◊ô◊ú ◊î◊®◊¶◊ï◊ô ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü</li>
                    </ul>
                </div>
            </div>

            
<div id="tab-holdings" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddHoldingForm()" class="btn btn-success">‚ûï ◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î</button>
                    <button onclick="refreshPrices()" class="btn btn-primary">üîÑ ◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù</button>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.5rem;">üáÆüá±</span>
                        <div>
                            <strong style="color: #1e40af;">◊†◊ô◊ô◊®◊ï◊™ ◊¢◊®◊ö ◊ô◊©◊®◊ê◊ú◊ô◊ô◊ù:</strong>
                            <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 0.9rem;">
                                ◊ú◊û◊°◊§◊®◊ô ◊†◊ô◊ô◊®◊ï◊™ ◊¢◊®◊ö ◊ô◊©◊®◊ê◊ú◊ô◊ô◊ù (7 ◊°◊§◊®◊ï◊™, ◊ú◊ì◊ï◊í◊û◊ê: 1209220), <strong>◊î◊ñ◊ü ◊ê◊™ ◊î◊û◊°◊§◊®</strong>. ◊î◊û◊¢◊®◊õ◊™ ◊™◊†◊°◊î ◊ú◊©◊ê◊ï◊ë ◊û◊ó◊ô◊®◊ô◊ù ◊û◊î◊ë◊ï◊®◊°◊î.
                            </p>
                            <div style="margin: 8px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <p style="margin: 0; color: #92400e; font-size: 0.85rem;">
                                    ‚ö†Ô∏è <strong>◊ó◊©◊ï◊ë:</strong> ◊©◊ê◊ô◊ë◊™ ◊û◊ó◊ô◊®◊ô◊ù ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊û◊î◊ë◊ï◊®◊°◊î ◊î◊ô◊©◊®◊ê◊ú◊ô◊™ ◊ú◊ê ◊™◊û◊ô◊ì ◊¢◊ï◊ë◊ì◊™ (◊ë◊í◊ú◊ú ◊û◊í◊ë◊ú◊ï◊™ ◊ò◊õ◊†◊ô◊ï◊™).
                                </p>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.85rem;">
                                üí° <strong>◊î◊û◊ú◊¶◊î:</strong> 
                            </p>
                            <ol style="margin: 5px 0 0 20px; color: #1e3a8a; font-size: 0.85rem; line-height: 1.6;">
                                <li>◊î◊í◊ì◊® <strong>"◊ò◊ô◊ß◊® ◊ó◊ú◊ï◊§◊ô"</strong> (◊ê◊ù ◊ô◊© - ◊ú◊ì◊ï◊í◊û◊ê: VWRL.L ◊ú◊™◊¢◊ï◊ì◊™ ◊°◊ú)</li>
                                <li>◊ê◊ï ◊î◊©◊™◊û◊© ◊ë◊õ◊§◊™◊ï◊® <strong>"üí∞ ◊û◊ó◊ô◊®"</strong> ◊ú◊¢◊ì◊õ◊ü ◊ô◊ì◊†◊ô◊™</li>
                                <li>◊¢◊ì◊õ◊ü ◊û◊ó◊ô◊®◊ô◊ù ◊ô◊ì◊†◊ô◊™ ◊û<a href="https://www.tase.co.il" target="_blank" style="color: var(--accent);">◊ê◊™◊® ◊î◊ë◊ï◊®◊°◊î</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="add-holding-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                    <h3 style="margin-bottom: 20px;">◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î ◊ó◊ì◊©◊î</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>◊°◊ô◊û◊ï◊ú / ◊û◊°' ◊†◊ô◊ô◊® ◊¢◊®◊ö (◊ú◊û◊©◊ú: AAPL, 1209220)</label>
                            <input type="text" id="new-symbol" placeholder="AAPL">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊†◊ô◊ô◊®◊ï◊™ ◊ô◊©◊®◊ê◊ú◊ô◊ô◊ù: ◊î◊ñ◊ü ◊û◊°◊§◊® ◊†◊ô◊ô◊® ◊¢◊®◊ö ◊ë◊ü 7 ◊°◊§◊®◊ï◊™</small>
                        </div>
                        <div class="form-group">
                            <label>◊ò◊ô◊ß◊® ◊ó◊ú◊ï◊§◊ô (◊í◊ô◊ë◊ï◊ô - ◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                            <input type="text" id="new-alt-ticker" placeholder="VWRL.L">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊í◊ô◊ë◊ï◊ô ◊ê◊ù ◊î◊©◊ê◊ô◊ë◊î ◊û◊î◊ë◊ï◊®◊°◊î ◊î◊ô◊©◊®◊ê◊ú◊ô◊™ ◊ú◊ê ◊¢◊ï◊ë◊ì◊™</small>
                        </div>
                        <div class="form-group">
                            <label>◊û◊°◊§◊® ◊û◊†◊ô◊ï◊™</label>
                            <input type="number" id="new-shares" placeholder="10" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î ◊û◊û◊ï◊¶◊¢</label>
                            <input type="number" id="new-cost" placeholder="150.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>◊¢◊û◊ú◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                            <input type="number" id="new-commission" placeholder="0" step="0.01" value="0">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊¢◊û◊ú◊™ ◊ß◊†◊ô◊ô◊î - ◊™◊™◊ï◊ï◊°◊£ ◊ú◊û◊ó◊ô◊®</small>
                        </div>
                        <div class="form-group">
                            <label>◊û◊ò◊ë◊¢</label>
                            <select id="new-currency">
                                <option value="ILS">‚Ç™ ◊©◊ß◊ú</option>
                                <option value="USD">$ ◊ì◊ï◊ú◊®</option>
                                <option value="EUR">‚Ç¨ ◊ô◊ï◊®◊ï</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î</label>
                            <input type="date" id="new-purchase-date" style="direction: ltr;">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊î◊©◊ê◊® ◊®◊ô◊ß ◊ú◊™◊ê◊®◊ô◊ö ◊î◊ô◊ï◊ù</small>
                        </div>
                        <div class="form-group">
                            <label>◊ß◊ë◊ï◊¶◊î</label>
                            <select id="new-group"></select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addHolding()" class="btn btn-success">‚úÖ ◊©◊û◊ï◊®</button>
                        <button onclick="hideAddHoldingForm()" class="btn" style="background: var(--text-muted); color: white;">‚ùå ◊ë◊ô◊ò◊ï◊ú</button>
                    </div>
                </div>

                <div id="holdings-list" class="holdings-grid"></div>
            </div>

            <!-- Bonds Tab -->
            <div id="tab-bonds" class="tab-content">
                <h3 style="margin-bottom: 20px;">üíº ◊ß◊®◊†◊ï◊™ ◊ê◊í"◊ó</h3>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddBondForm()" class="btn btn-success">‚ûï ◊î◊ï◊°◊£ ◊ß◊®◊ü ◊ê◊í"◊ó</button>
                    <button onclick="refreshBondPrices()" class="btn btn-primary">üîÑ ◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù</button>
                </div>

                <!-- Add Bond Form -->
                <div id="add-bond-form" style="display: none; margin-bottom: 30px;" class="glass">
                    <h4 style="margin-bottom: 15px;">◊î◊ï◊°◊£/◊¢◊®◊ï◊ö ◊ß◊®◊ü ◊ê◊í"◊ó</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>◊û◊°◊§◊® ◊†◊ô◊ô◊® ◊¢◊®◊ö / ◊°◊ô◊û◊ï◊ú</label>
                            <input type="text" id="bond-symbol" placeholder="1234567">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊†◊ô◊ô◊®◊ï◊™ ◊ô◊©◊®◊ê◊ú◊ô◊ô◊ù: ◊î◊ñ◊ü ◊û◊°◊§◊® ◊†◊ô◊ô◊® ◊¢◊®◊ö ◊ë◊ü 7 ◊°◊§◊®◊ï◊™</small>
                        </div>
                        <div class="form-group">
                            <label>◊ò◊ô◊ß◊® ◊ó◊ú◊ï◊§◊ô (◊í◊ô◊ë◊ï◊ô - ◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                            <input type="text" id="bond-alt-ticker" placeholder="BOND.TA">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊í◊ô◊ë◊ï◊ô ◊ê◊ù ◊î◊©◊ê◊ô◊ë◊î ◊û◊î◊ë◊ï◊®◊°◊î ◊ú◊ê ◊¢◊ï◊ë◊ì◊™</small>
                        </div>
                        <div class="form-group">
                            <label>◊õ◊û◊ï◊™ ◊ô◊ó◊ô◊ì◊ï◊™</label>
                            <input type="number" id="bond-units" step="0.001" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î ◊ú◊ô◊ó◊ô◊ì◊î</label>
                            <input type="number" id="bond-cost" step="0.01" placeholder="100.00">
                        </div>
                        <div class="form-group">
                            <label>◊¢◊û◊ú◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                            <input type="number" id="bond-commission" step="0.01" placeholder="0" value="0">
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">◊¢◊û◊ú◊™ ◊ß◊†◊ô◊ô◊î - ◊™◊™◊ï◊ï◊°◊£ ◊ú◊û◊ó◊ô◊®</small>
                        </div>
                        <div class="form-group">
                            <label>◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î</label>
                            <input type="date" id="bond-purchase-date">
                        </div>
                        <div class="form-group">
                            <label>◊û◊ò◊ë◊¢</label>
                            <select id="bond-currency">
                                <option value="ILS">‚Ç™ ◊©◊ß◊ú (ILS)</option>
                                <option value="USD">$ ◊ì◊ï◊ú◊® (USD)</option>
                                <option value="EUR">‚Ç¨ ◊ô◊ï◊®◊ï (EUR)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="saveBond()" class="btn btn-success">üíæ ◊©◊û◊ï◊®</button>
                        <button onclick="hideAddBondForm()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                    </div>
                </div>

                <!-- Bonds List -->
                <div id="bonds-list"></div>
            </div>

            <!-- Groups Tab -->
            <div id="tab-groups" class="tab-content">
                <h3 style="margin-bottom: 20px;">◊ß◊ë◊ï◊¶◊ï◊™ ◊î◊î◊©◊ß◊¢◊î ◊©◊ú◊ö</h3>
                <div id="groups-list" class="groups-list"></div>
            </div>

            <!-- Recommendations Tab -->
            <div id="tab-recommendations" class="tab-content">
                <h3 style="margin-bottom: 20px;">üí° ◊î◊û◊ú◊¶◊ï◊™ ◊ú◊ê◊ô◊ñ◊ï◊ü ◊™◊ô◊ß</h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <h3 style="margin-bottom: 20px;">üìú ◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊¢◊°◊ß◊ê◊ï◊™</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="filterTransactions('all')" class="btn btn-primary" id="filter-all">◊î◊õ◊ú</button>
                    <button onclick="filterTransactions('deposits')" class="btn" id="filter-deposits">◊î◊§◊ß◊ì◊ï◊™</button>
                    <button onclick="filterTransactions('withdrawals')" class="btn" id="filter-withdrawals">◊û◊©◊ô◊õ◊ï◊™</button>
                    <button onclick="filterTransactions('purchases')" class="btn" id="filter-purchases">◊ß◊†◊ô◊ï◊™</button>
                    <button onclick="filterTransactions('sales')" class="btn" id="filter-sales">◊û◊õ◊ô◊®◊ï◊™</button>
                </div>
                
                <div class="glass">
                    <div id="transactions-list"></div>
                </div>
            </div>

            <!-- Capital Tab -->
            <!-- Cash Flow Tab -->
            <div id="tab-cashflow" class="tab-content">
                <h3 style="margin-bottom: 20px;">üí∞ ◊™◊ñ◊®◊ô◊ù ◊õ◊°◊§◊ô</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showDepositModal()" class="btn btn-success">üì• ◊î◊§◊ß◊ì◊î</button>
                    <button onclick="showWithdrawalModal()" class="btn" style="background: var(--loss); color: white;">üì§ ◊û◊©◊ô◊õ◊î</button>
                </div>
                
                <!-- Cash Balances Container -->
                <div id="cash-balances-container"></div>
                
                <!-- Deposits -->
                <div class="glass" style="margin-bottom: 20px; background: var(--bg-elevated);">
                    <h4 style="margin-bottom: 15px; color: #065f46;">üì• ◊î◊§◊ß◊ì◊ï◊™</h4>
                    <div id="deposits-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: var(--bg-surface); border-radius: 8px; text-align: center;">
                        <strong style="color: var(--profit);">◊°◊î"◊õ ◊î◊§◊ß◊ì◊ï◊™: ‚Ç™<span id="total-deposits">0</span></strong>
                    </div>
                </div>
                
                <!-- Withdrawals -->
                <div class="glass" style="margin-bottom: 20px; background: var(--bg-elevated);">
                    <h4 style="margin-bottom: 15px; color: #7f1d1d;">üì§ ◊û◊©◊ô◊õ◊ï◊™</h4>
                    <div id="withdrawals-list" style="margin-bottom: 15px;"></div>
                    <div style="padding: 10px; background: var(--bg-surface); border-radius: 8px; text-align: center;">
                        <strong style="color: var(--loss);">◊°◊î"◊õ ◊û◊©◊ô◊õ◊ï◊™: ‚Ç™<span id="total-withdrawals">0</span></strong>
                    </div>
                </div>
                

            </div>
            
            <!-- Performance Tab -->
            <!-- Deposit Modal -->
            <div id="deposit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">üì• ◊î◊§◊ß◊ì◊î ◊ú◊™◊ô◊ß</h3>
                    
                    <div class="form-group">
                        <label>◊°◊õ◊ï◊ù ◊î◊î◊§◊ß◊ì◊î (‚Ç™)</label>
                        <input type="number" id="deposit-amount" placeholder="10000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊î◊î◊§◊ß◊ì◊î</label>
                        <input type="date" id="deposit-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>◊î◊¢◊®◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                        <input type="text" id="deposit-note" placeholder="◊î◊©◊ß◊¢◊î ◊ó◊ï◊ì◊©◊ô◊™">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideDepositModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitDeposit()" class="btn btn-success">◊ê◊ô◊©◊ï◊® ◊î◊§◊ß◊ì◊î</button>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Modal -->
            <div id="withdrawal-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">üì§ ◊û◊©◊ô◊õ◊î ◊û◊î◊™◊ô◊ß</h3>
                    
                    <div style="padding: 10px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
                        <div style="font-size: 0.9rem; color: #1e40af;">◊û◊ñ◊ï◊û◊ü ◊ñ◊û◊ô◊ü ◊ú◊û◊©◊ô◊õ◊î: <strong>‚Ç™<span id="withdrawal-max">0</span></strong></div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊°◊õ◊ï◊ù ◊î◊û◊©◊ô◊õ◊î (‚Ç™)</label>
                        <input type="number" id="withdrawal-amount" placeholder="5000" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊î◊û◊©◊ô◊õ◊î</label>
                        <input type="date" id="withdrawal-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                    </div>
                    

                    
                    <div class="form-group">
                        <label>◊î◊¢◊®◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                        <input type="text" id="withdrawal-note" placeholder="◊®◊ï◊ï◊ó◊ô◊ù">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideWithdrawalModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitWithdrawal()" class="btn" style="background: var(--loss); color: white;">◊ê◊ô◊©◊ï◊® ◊û◊©◊ô◊õ◊î</button>
                    </div>
                </div>
            </div>

            <!-- Add Bond Units Modal -->
            <div id="add-bond-units-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">‚ûï ◊î◊ï◊°◊£ ◊ô◊ó◊ô◊ì◊ï◊™ ◊ê◊í"◊ó</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="add-bond-symbol"></strong><br>
                            ◊ô◊ó◊ô◊ì◊ï◊™ ◊†◊ï◊õ◊ó◊ô◊ï◊™: <strong id="add-bond-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊õ◊û◊ï◊™ ◊ô◊ó◊ô◊ì◊ï◊™ ◊ú◊î◊ï◊°◊§◊î</label>
                        <input type="number" id="add-bond-quantity" placeholder="100" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î ◊ú◊ô◊ó◊ô◊ì◊î</label>
                        <input type="number" id="add-bond-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>◊¢◊û◊ú◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                        <input type="number" id="add-bond-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">◊¢◊û◊ú◊™ ◊ß◊†◊ô◊ô◊î - ◊™◊™◊ï◊ï◊°◊£ ◊ú◊û◊ó◊ô◊®</small>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î</label>
                        <input type="date" id="add-bond-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideAddBondUnitsModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitAddBondUnits()" class="btn btn-success">‚úÖ ◊î◊ï◊°◊£ ◊ô◊ó◊ô◊ì◊ï◊™</button>
                    </div>
                </div>
            </div>

            <!-- Sell Bond Units Modal -->
            <div id="sell-bond-units-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">üí∏ ◊û◊õ◊ï◊® ◊ô◊ó◊ô◊ì◊ï◊™ ◊ê◊í"◊ó</h3>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="sell-bond-symbol"></strong><br>
                            ◊ô◊ó◊ô◊ì◊ï◊™ ◊†◊ï◊õ◊ó◊ô◊ï◊™: <strong id="sell-bond-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊õ◊û◊ï◊™ ◊ô◊ó◊ô◊ì◊ï◊™ ◊ú◊û◊õ◊ô◊®◊î</label>
                        <input type="number" id="sell-bond-quantity" placeholder="100" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î ◊ú◊ô◊ó◊ô◊ì◊î</label>
                        <input type="number" id="sell-bond-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊û◊õ◊ô◊®◊î</label>
                        <input type="date" id="sell-bond-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideSellBondUnitsModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitSellBondUnits()" class="btn" style="background: var(--warning); color: white;">üí∏ ◊û◊õ◊ï◊®</button>
                    </div>
                </div>
            </div>

            <!-- Sell Shares Modal -->
            <div id="sell-shares-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">üìâ ◊û◊õ◊ï◊® ◊û◊†◊ô◊ï◊™</h3>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="sell-shares-symbol"></strong><br>
                            ◊î◊ó◊ñ◊ß◊î ◊†◊ï◊õ◊ó◊ô◊™: <strong id="sell-shares-current"></strong><br>
                            ◊û◊ó◊ô◊® ◊û◊û◊ï◊¶◊¢: <strong id="sell-shares-avg-cost"></strong><br>
                            ◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô: <strong id="sell-shares-current-price"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊õ◊û◊ï◊™ ◊û◊†◊ô◊ï◊™ ◊ú◊û◊õ◊ô◊®◊î</label>
                        <input type="number" id="sell-shares-quantity" placeholder="10" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î ◊ú◊û◊†◊ô◊î</label>
                        <input type="number" id="sell-shares-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊û◊õ◊ô◊®◊î</label>
                        <input type="date" id="sell-shares-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label>◊¢◊û◊ú◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                        <input type="number" id="sell-shares-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">◊¢◊û◊ú◊™ ◊û◊õ◊ô◊®◊î - ◊™◊ï◊§◊ó◊™ ◊û◊î◊™◊û◊ï◊®◊î</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideSellSharesModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitSellShares()" class="btn" style="background: var(--warning); color: white;">üí∏ ◊û◊õ◊ï◊®</button>
                    </div>
                </div>
            </div>

            <!-- Add Shares Modal -->
            <div id="add-shares-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">‚ûï ◊î◊ï◊°◊£ ◊û◊†◊ô◊ï◊™ ◊ú◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊ß◊ô◊ô◊û◊™</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <strong id="add-shares-symbol"></strong><br>
                            ◊î◊ó◊ñ◊ß◊î ◊†◊ï◊õ◊ó◊ô◊™: <strong id="add-shares-current"></strong><br>
                            ◊û◊ó◊ô◊® ◊û◊û◊ï◊¶◊¢: <strong id="add-shares-avg-cost"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊õ◊û◊ï◊™ ◊û◊†◊ô◊ï◊™ ◊ú◊î◊ï◊°◊§◊î</label>
                        <input type="number" id="add-shares-quantity" placeholder="10" step="0.001">
                    </div>
                    
                    <div class="form-group">
                        <label>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î ◊ú◊û◊†◊ô◊î</label>
                        <input type="number" id="add-shares-price" placeholder="100.50" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label>◊¢◊û◊ú◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô)</label>
                        <input type="number" id="add-shares-commission" placeholder="0" step="0.01" value="0">
                        <small style="color: var(--text-secondary); font-size: 0.8rem;">◊¢◊û◊ú◊™ ◊ß◊†◊ô◊ô◊î - ◊™◊™◊ï◊ï◊°◊£ ◊ú◊û◊ó◊ô◊®</small>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î</label>
                        <input type="date" id="add-shares-date" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideAddSharesModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitAddShares()" class="btn btn-success">‚úÖ ◊î◊ï◊°◊£ ◊û◊†◊ô◊ï◊™</button>
                    </div>
                </div>
            </div>

            <!-- Edit Transaction Date Modal -->
            <div id="edit-date-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-surface); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px;">üìÖ ◊¢◊®◊ô◊õ◊™ ◊™◊ê◊®◊ô◊ö ◊¢◊°◊ß◊î</h3>
                    
                    <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            ◊°◊ï◊í ◊¢◊°◊ß◊î: <strong id="edit-date-type"></strong><br>
                            ◊™◊ê◊®◊ô◊ö ◊†◊ï◊õ◊ó◊ô: <strong id="edit-date-current"></strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>◊™◊ê◊®◊ô◊ö ◊ó◊ì◊©</label>
                        <input type="date" id="edit-date-new" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; width: 100%;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="hideEditDateModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                        <button onclick="submitEditDate()" class="btn btn-success">üíæ ◊©◊û◊ï◊® ◊©◊ô◊†◊ï◊ô◊ô◊ù</button>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">‚öôÔ∏è ◊î◊í◊ì◊®◊ï◊™</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üí± ◊©◊¢◊®◊ô ◊î◊û◊®◊î</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        üìù <strong>◊¢◊®◊ï◊ö ◊ê◊™ ◊î◊©◊¢◊®◊ô◊ù ◊ô◊ì◊†◊ô◊™</strong> ◊ê◊ï ◊†◊°◊î ◊®◊¢◊†◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>◊ì◊ï◊ú◊® ($) ◊ú◊©◊ß◊ú</label>
                            <input type="number" id="rate-usd" step="0.0001" value="3.7500" 
                                   placeholder="3.7500" 
                                   style="background: var(--bg-elevated); border: 1px solid var(--border);">
                        </div>
                        <div class="form-group">
                            <label>◊ô◊ï◊®◊ï (‚Ç¨) ◊ú◊©◊ß◊ú</label>
                            <input type="number" id="rate-eur" step="0.0001" value="4.0500" 
                                   placeholder="4.0500"
                                   style="background: var(--bg-elevated); border: 1px solid var(--border);">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="tryAutoUpdateRates()" class="btn btn-primary">
                            üîÑ ◊®◊¢◊†◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™
                        </button>
                        <button onclick="updateExchangeRates()" class="btn btn-success">
                            üíæ ◊©◊û◊ï◊® ◊©◊¢◊®◊ô◊ù
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 10px; font-size: 0.8rem;">
                        üí° ◊®◊¢◊†◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊û◊†◊°◊î ◊ú◊û◊©◊ï◊ö ◊©◊¢◊®◊ô◊ù ◊û◊î◊ê◊ô◊†◊ò◊®◊†◊ò. ◊ê◊ù ◊ñ◊î ◊ú◊ê ◊¢◊ï◊ë◊ì, ◊¢◊®◊ï◊ö ◊ô◊ì◊†◊ô◊™ ◊û-<a href="https://www.boi.org.il/he/markets/exchangerates/" target="_blank" style="color: var(--accent);">◊ë◊†◊ß ◊ô◊©◊®◊ê◊ú</a>
                    </p>
                </div>

                <div class="glass">
                    <h4 style="margin-bottom: 15px;">üíæ ◊í◊ô◊ë◊ï◊ô ◊ï◊©◊ó◊ñ◊ï◊®</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportData()" class="btn btn-primary">üì§ ◊ô◊ô◊¶◊ï◊ê ◊†◊™◊ï◊†◊ô◊ù</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            üì• ◊ô◊ô◊ë◊ï◊ê ◊†◊™◊ï◊†◊ô◊ù
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
                
                <div class="glass" style="border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: var(--warning);">üîß ◊™◊ô◊ß◊ï◊ü TWR</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        ◊ê◊ù TWR ◊ú◊ê ◊¢◊ï◊ë◊ì, ◊ñ◊î ◊ë◊í◊ú◊ú snapshots ◊ô◊©◊†◊ô◊ù. ◊ú◊ó◊• ◊õ◊ê◊ü ◊ú◊û◊ó◊ï◊ß snapshots ◊ô◊©◊†◊ô◊ù ◊ï◊ú◊ô◊¶◊ï◊® ◊ó◊ì◊©.
                    </p>
                    <button onclick="fixSnapshots()" class="btn" style="background: var(--warning); color: white;">
                        üîß ◊™◊ß◊ü Snapshots (◊ê◊ô◊§◊ï◊° ◊û◊î◊ô◊®)
                    </button>
                </div>
                
                <div class="glass" style="border: 2px solid #8b5cf6;">
                    <h4 style="margin-bottom: 15px; color: #8b5cf6;">üîÑ ◊ë◊†◊ô◊ô◊î ◊û◊ó◊ì◊© ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        <strong>◊§◊™◊®◊ï◊ü ◊û◊ß◊ô◊£:</strong> ◊î◊§◊ï◊†◊ß◊¶◊ô◊î ◊î◊ñ◊ï ◊¢◊ï◊ë◊®◊™ ◊¢◊ú ◊õ◊ú ◊î◊§◊¢◊ï◊ú◊ï◊™ (◊î◊§◊ß◊ì◊ï◊™, ◊û◊©◊ô◊õ◊ï◊™, ◊ß◊†◊ô◊ï◊™, ◊û◊õ◊ô◊®◊ï◊™) ◊û◊î◊î◊™◊ó◊ú◊î ◊ï◊¢◊ì ◊î◊°◊ï◊£ ◊ë◊°◊ì◊® ◊õ◊®◊ï◊†◊ï◊ú◊ï◊í◊ô, ◊ï◊ë◊ï◊†◊î ◊û◊ó◊ì◊© ◊ê◊™ ◊î-snapshots ◊ï◊ó◊ô◊©◊ï◊ë◊ô ◊î◊û◊ñ◊ï◊û◊ü ◊ë◊¶◊ï◊®◊î ◊†◊õ◊ï◊†◊î.
                        <br><br>
                        üí° <strong>◊û◊™◊ô ◊ú◊î◊©◊™◊û◊©?</strong> ◊ê◊ù ◊ô◊ô◊ë◊ê◊™ ◊†◊™◊ï◊†◊ô◊ù ◊û◊ó◊ì◊©, ◊î◊ï◊°◊§◊™ ◊§◊¢◊ï◊ú◊ï◊™ ◊ú◊û◊§◊®◊¢, ◊ê◊ï ◊©◊ô◊© ◊ê◊ô-◊î◊™◊ê◊û◊ï◊™ ◊ë◊ó◊ô◊©◊ï◊ë◊ô◊ù.
                    </p>
                    <button onclick="rebuildSnapshotsFromHistory()" class="btn" style="background: var(--accent); color: white;">
                        üîÑ ◊ë◊†◊î ◊û◊ó◊ì◊© ◊û◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊§◊¢◊ï◊ú◊ï◊™
                    </button>
                </div>
                
                <div class="glass" style="border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: var(--loss);">üóëÔ∏è ◊ê◊ñ◊ï◊® ◊û◊°◊ï◊õ◊ü</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        ‚ö†Ô∏è <strong>◊§◊¢◊ï◊ú◊î ◊ë◊ú◊™◊ô ◊î◊§◊ô◊õ◊î!</strong> ◊û◊ó◊ô◊ß◊™ ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù ◊™◊û◊ó◊ß ◊ú◊¶◊û◊ô◊™◊ï◊™ ◊ê◊™ ◊õ◊ú ◊î◊û◊†◊ô◊ï◊™, ◊î◊ê◊í"◊ó, ◊î◊î◊§◊ß◊ì◊ï◊™, ◊î◊û◊©◊ô◊õ◊ï◊™ ◊ï◊î◊¢◊°◊ß◊ê◊ï◊™.
                    </p>
                    <button onclick="deleteAllData()" class="btn" style="background: var(--loss); color: white;">
                        üóëÔ∏è ◊û◊ó◊ß ◊ê◊™ ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End mainContent -->
<div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Import
        import { auth, db, onAuthStateChanged, doc, setDoc, getDoc } from './firebase-config.js';

        // Auth check
        let currentUser = null;
        let authChecked = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ User authenticated:', user.email);
                if (!authChecked) {
                    authChecked = true;
                    init();
                }
            } else {
                if (authChecked) {
                    window.location.href = '/index.html';
                } else {
                    setTimeout(() => {
                        if (!currentUser) window.location.href = '/index.html';
                    }, 2000);
                }
            }
        });

        // =========================================== 
        // DATA STRUCTURE - ENHANCED
        // ===========================================
        
        let editingHoldingId = null; // Track which holding is being edited
        
        
        // ‚ú® ◊†◊™◊ï◊†◊ô◊ù ◊û◊™◊ï◊ß◊†◊ô◊ù ◊û◊î◊ê◊ß◊°◊ú◊ô◊ù - 2025-10-30T22:36:57.557729
        // üìä 6 ◊û◊†◊ô◊ï◊™/◊ß◊®◊†◊ï◊™ | 2 ◊ê◊í"◊ó
        // üí∞ ◊ô◊™◊®◊ï◊™: ‚Ç™36.90 + $27.08
        // [REMOVED] let portfolio = {} - ◊î◊ï◊°◊® ◊õ◊ì◊ô ◊ú◊ê ◊ú◊ì◊®◊ï◊° ◊ê◊™ ◊î◊†◊™◊ï◊†◊ô◊ù ◊û◊î-IIFE
        // portfolio ◊ô◊ò◊¢◊ü ◊û-localStorage ◊¢◊ú ◊ô◊ì◊ô loadData()
        let portfolio = {};  // ◊ô◊ó◊ú◊ô◊£ loadData


        // ============================================
        // [DISABLED] FORCE SAVE - DO NOT OVERWRITE USER DATA
        // ============================================
        // ◊î◊°◊ß◊®◊ô◊§◊ò ◊î◊ñ◊î ◊î◊ï◊©◊ë◊™ ◊õ◊ì◊ô ◊ú◊ê ◊ú◊ì◊®◊ï◊° ◊†◊™◊ï◊†◊ô◊ù ◊©◊ú ◊î◊û◊©◊™◊û◊©
        /*
        console.log('üíæ ◊õ◊ï◊§◊î ◊©◊û◊ô◊®◊™ ◊†◊™◊ï◊†◊ô◊ù ◊ó◊ì◊©◊ô◊ù ◊ú-localStorage...');
        localStorage.setItem('portfolio', JSON.stringify(portfolio));
        console.log('‚úÖ ◊†◊™◊ï◊†◊ô◊ù ◊ó◊ì◊©◊ô◊ù ◊†◊©◊û◊®◊ï ◊ë◊õ◊ï◊ó!');
        console.log('   - IBI ◊û◊õ◊ô◊®◊ï◊™ ◊™◊ï◊ß◊†◊ï (◊ó◊ï◊ú◊ß◊ï ◊ë-100)');
        console.log('   - ◊û◊©◊õ◊†◊™◊ê ◊™◊ï◊ß◊†◊î (◊ó◊ï◊ú◊ß◊î ◊ë-100)');
        console.log('   - ◊û◊©◊ô◊õ◊ï◊™: ' + portfolio.withdrawals.length);
        console.log('   - ◊û◊õ◊ô◊®◊ï◊™: ' + portfolio.sales.length);
        */


        let charts = {};

        // ===========================================
        // TWR ENHANCEMENT v45 - Multi-Currency Cash Tracking
        // ===========================================
        
        // ◊î◊í◊ì◊®◊ï◊™ ◊¢◊û◊ú◊ï◊™
        const FEE_CONFIG = {
            USD: 5,    // $5 ◊ú◊¢◊°◊ß◊î ◊ì◊ï◊ú◊®◊ô◊™
            EUR: 20,   // ‚Ç¨20 ◊ú◊¢◊°◊ß◊î ◊ô◊ï◊®◊ï
            ILS: 0,    // ◊ú◊ú◊ê ◊¢◊û◊ú◊î ◊ú◊©◊ß◊ú◊ô◊™
            
            // ◊û◊†◊ô◊ï◊™ ◊¢◊ù ◊¢◊û◊ú◊î ◊ì◊ï◊ú◊®◊ô◊™
            USD_FEE_SYMBOLS: ['USSC.L', 'MARA', 'LUMN', 'NVDA', 'AVGS.L'],
            
            // ◊û◊†◊ô◊ï◊™ ◊¢◊ù ◊¢◊û◊ú◊î ◊ô◊ï◊®◊ï (◊®◊ß ◊ß◊†◊ô◊ï◊™!)
            EUR_FEE_SYMBOLS: ['ZPRX.DE', 'AVWS.DE'],
            
            // ◊û◊†◊ô◊ï◊™ ◊©◊î◊ß◊†◊ô◊ô◊î ◊î◊®◊ê◊©◊ï◊†◊î ◊õ◊ë◊® ◊õ◊ú◊ú◊î ◊¢◊û◊ú◊î
            FIRST_PURCHASE_FEE_INCLUDED: ['USSC.L']
        };

        // ◊û◊§◊™ ◊û◊ò◊ë◊¢ ◊ú◊§◊ô ◊°◊ô◊û◊ï◊ú
        const CURRENCY_MAP = {
            'USSC.L': 'USD', 'AVGS.L': 'USD',
            'AVWS.DE': 'EUR', 'ZPRX.DE': 'EUR',
            'NVDA': 'USD', 'MAGS': 'USD', 'IBIT': 'USD', 'ETHA': 'USD', 'TSLA': 'USD',
            'MARA': 'USD', 'NNE': 'USD', 'OKLO': 'USD', 'PLTR': 'USD', 'SFM': 'USD',
            'FLEX': 'USD', 'AMD': 'USD', 'APP': 'USD', 'AAPL': 'USD', 'GOOGL': 'USD',
            'TEM': 'USD', 'OPEN': 'USD', 'RKT': 'USD', 'LUMN': 'USD'
        };

        // ◊ê◊í"◊ó ◊ê◊û◊ô◊™◊ô◊ï◊™ (◊û◊ó◊ô◊® ◊ë◊ê◊ó◊ï◊ñ◊ô◊ù)
        const REAL_BONDS = new Set(['5139522', '2310449']);

        /**
         * ◊ß◊ë◊ú◊™ ◊û◊ò◊ë◊¢ ◊î◊†◊õ◊° ◊ú◊§◊ô ◊°◊ô◊û◊ï◊ú
         */
        function getAssetCurrency(symbol) {
            if (!symbol) return 'ILS';
            if (/^\d{7}$/.test(symbol)) return 'ILS';
            return CURRENCY_MAP[symbol] || 'USD';
        }

        /**
         * ◊ë◊ì◊ô◊ß◊î ◊ê◊ù ◊î◊†◊õ◊° ◊î◊ï◊ê ◊ê◊í"◊ó ◊ê◊û◊ô◊™◊ô◊™
         */
        function isRealBond(symbol) {
            return REAL_BONDS.has(symbol);
        }

        /**
         * ◊ó◊ô◊©◊ï◊ë ◊¢◊û◊ú◊î ◊ú◊¢◊°◊ß◊î
         */
        function calculateFeeForTransaction(symbol, transactionType, purchaseCountForSymbol = 0) {
            const currency = getAssetCurrency(symbol);
            
            if (transactionType === 'sell') {
                return { fee: 0, feeCurrency: null };
            }
            
            if (symbol === 'USSC.L' && purchaseCountForSymbol === 0) {
                return { fee: 0, feeCurrency: null };
            }
            
            if (currency === 'USD' && FEE_CONFIG.USD_FEE_SYMBOLS.includes(symbol)) {
                return { fee: FEE_CONFIG.USD, feeCurrency: 'USD' };
            }
            if (currency === 'EUR' && FEE_CONFIG.EUR_FEE_SYMBOLS.includes(symbol)) {
                return { fee: FEE_CONFIG.EUR, feeCurrency: 'EUR' };
            }
            
            return { fee: 0, feeCurrency: null };
        }

        /**
         * ◊ê◊™◊ó◊ï◊ú ◊û◊ñ◊ï◊û◊ü ◊ú◊§◊ô ◊û◊ò◊ë◊¢
         */
        function initializeCash() {
            if (!portfolio.cash || typeof portfolio.cash !== 'object') {
                portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            }
            if (portfolio.cash.EUR === undefined) {
                portfolio.cash.EUR = 0;
            }
        }

        /**
         * ◊ß◊ë◊ú◊™ ◊°◊ö ◊û◊ñ◊ï◊û◊ü ◊ë◊©◊ß◊ú◊ô◊ù
         */
        function getTotalCashILS(rates = null) {
            initializeCash();
            const r = rates || portfolio.rates;
            return (portfolio.cash.ILS || 0) + 
                   (portfolio.cash.USD || 0) * (r.USD || 3.6) + 
                   (portfolio.cash.EUR || 0) * (r.EUR || 4.0);
        }

        /**
         * ◊î◊û◊®◊î ◊ú◊©◊ß◊ú◊ô◊ù ◊ú◊§◊ô ◊©◊¢◊®◊ô◊ù ◊†◊™◊ï◊†◊ô◊ù
         */
        
        // =============================================================================
        // TWR COMPLETE SYSTEM v3.0 - INSERTED
        // =============================================================================
        
        // =============================================================================
// TWR COMPLETE SYSTEM v3.0
// ◊û◊¢◊®◊õ◊™ ◊û◊ú◊ê◊î ◊ú◊ó◊ô◊©◊ï◊ë ◊™◊©◊ï◊ê◊î ◊û◊©◊ï◊ß◊ú◊ú◊™ ◊ñ◊û◊ü
// - ◊©◊û◊ô◊®◊™ ◊¢◊°◊ß◊ê◊ï◊™ ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô ◊ë◊ú◊ë◊ì
// - Modal ◊ú◊ê◊ô◊°◊ï◊£ ◊û◊ó◊ô◊®◊ô◊ù ◊ï◊©◊¢◊®◊ô◊ù ◊ë◊¢◊™ ◊ô◊¶◊ô◊®◊™ snapshot
// - ◊ó◊ô◊©◊ï◊ë TWR ◊û◊ì◊ï◊ô◊ß
// =============================================================================

// -----------------------------------------------------------------------------
// SNAPSHOT DATA MODAL - Modal ◊ú◊ê◊ô◊°◊ï◊£ ◊†◊™◊ï◊†◊ô◊ù
// -----------------------------------------------------------------------------

/**
 * Open modal to collect historical prices and rates for snapshot
 * @param {string} triggerType - 'deposit' or 'withdrawal'
 * @param {number} cashFlowILS - The cash flow amount in ILS
 * @param {string} date - The date for the snapshot
 * @param {string} note - Description
 * @param {Function} onComplete - Callback after snapshot created
 */

/**
 * Fill current prices in the modal (for when prices haven't changed much)
 */
async function fillCurrentPrices() {
    console.log('üîÑ Filling current prices...');
    notify('üîÑ ◊ò◊ï◊¢◊ü ◊û◊ó◊ô◊®◊ô◊ù ◊†◊ï◊õ◊ó◊ô◊ô◊ù...', 'info');
    
    const data = window._snapshotModalData;
    if (!data) return;
    
    try {
        // Refresh rates
        await loadRates();
        document.getElementById('snapshot-rate-usd').value = portfolio.rates?.USD?.toFixed(4) || '3.7';
        document.getElementById('snapshot-rate-eur').value = portfolio.rates?.EUR?.toFixed(4) || '4.0';
        
        // Fill holding prices
        for (let i = 0; i < data.activeHoldings.length; i++) {
            const h = data.activeHoldings[i];
            const input = document.getElementById(`snapshot-price-holding-${i}`);
            if (input) {
                // Try to get fresh price
                try {
                    const price = await fetchStockPrice(h.symbol);
                    if (price && price > 0) {
                        input.value = price.toFixed(2);
                        console.log(`‚úì ${h.symbol}: ${price}`);
                    }
                } catch (e) {
                    // Use current price from portfolio
                    input.value = h.currentPrice || h.costBasis || '';
                }
            }
        }
        
        // Fill bond prices
        for (let i = 0; i < data.activeBonds.length; i++) {
            const b = data.activeBonds[i];
            const input = document.getElementById(`snapshot-price-bond-${i}`);
            if (input) {
                try {
                    const price = await fetchBondPrice(b.symbol);
                    if (price && price > 0) {
                        input.value = price.toFixed(2);
                        console.log(`‚úì ${b.symbol}: ${price}`);
                    }
                } catch (e) {
                    input.value = b.currentPrice || b.costBasis || '';
                }
            }
        }
        
        // Recalculate total
        recalculateSnapshotValue();
        notify('‚úÖ ◊û◊ó◊ô◊®◊ô◊ù ◊¢◊ï◊ì◊õ◊†◊ï', 'success');
        
    } catch (error) {
        console.error('Error filling prices:', error);
        notify('‚ö†Ô∏è ◊ó◊ú◊ß ◊û◊î◊û◊ó◊ô◊®◊ô◊ù ◊ú◊ê ◊¢◊ï◊ì◊õ◊†◊ï', 'warning');
    }
}

function openSnapshotDataModal(triggerType, cashFlowILS, date, note, onComplete) {
    console.log('üîµ openSnapshotDataModal called:', { triggerType, cashFlowILS, date, note });
    
    try {
        // Get active holdings at this date
        const activeHoldings = getActiveHoldingsAtDate(date);
        const activeBonds = getActiveBondsAtDate(date);
        console.log('üîµ Active holdings:', activeHoldings.length, 'Active bonds:', activeBonds.length);
    
    // Create modal HTML
    const modalHTML = `
        <div id="snapshot-data-modal" class="modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999;">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3>üì∏ ◊†◊™◊ï◊†◊ô◊ù ◊ú◊ô◊¶◊ô◊®◊™ Snapshot</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    ${triggerType === 'deposit' ? '◊î◊§◊ß◊ì◊î' : '◊û◊©◊ô◊õ◊î'}: ‚Ç™${Math.abs(cashFlowILS).toLocaleString()} | 
                    ◊™◊ê◊®◊ô◊ö: ${new Date(date).toLocaleDateString('he-IL')}
                </p>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üí± ◊©◊¢◊®◊ô ◊û◊ò◊ë◊¢</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label>USD ‚Üí ILS</label>
                            <input type="number" id="snapshot-rate-usd" step="0.01" placeholder="3.70" value="${portfolio.rates?.USD || 3.7}">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>EUR ‚Üí ILS</label>
                            <input type="number" id="snapshot-rate-eur" step="0.01" placeholder="4.00" value="${portfolio.rates?.EUR || 4.0}">
                        </div>
                    </div>
                    <button onclick="fetchHistoricalRatesForModal('${date}')" class="btn" style="margin-top: 10px; background: var(--info);">
                        üîÑ ◊î◊ë◊ê ◊©◊¢◊®◊ô◊ù ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™
                    </button>
                    <button onclick="fillCurrentPrices()" class="btn" style="margin-top: 10px; margin-right: 10px; background: var(--profit);">
                        ‚ö° ◊û◊ú◊ê ◊û◊ó◊ô◊®◊ô◊ù ◊†◊ï◊õ◊ó◊ô◊ô◊ù
                    </button>
                </div>
                
                ${activeHoldings.length > 0 ? `
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üìà ◊û◊ó◊ô◊®◊ô ◊û◊†◊ô◊ï◊™</h4>
                    <table style="width: 100%; font-size: 14px;">
                        <thead>
                            <tr style="text-align: right;">
                                <th>◊°◊ô◊û◊ï◊ú</th>
                                <th>◊õ◊û◊ï◊™</th>
                                <th>◊û◊ò◊ë◊¢</th>
                                <th>◊û◊ó◊ô◊®</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeHoldings.map((h, i) => `
                                <tr>
                                    <td><strong>${h.symbol}</strong></td>
                                    <td>${h.shares}</td>
                                    <td>${h.currency}</td>
                                    <td>
                                        <input type="number" 
                                               id="snapshot-price-holding-${i}" 
                                               data-holding-id="${h.id}"
                                               data-currency="${h.currency}"
                                               step="0.01" 
                                               value="${h.currentPrice || h.costBasis || ''}"
                                               style="width: 80px;">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                
                ${activeBonds.length > 0 ? `
                <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üìä ◊û◊ó◊ô◊®◊ô ◊ê◊í"◊ó</h4>
                    <table style="width: 100%; font-size: 14px;">
                        <thead>
                            <tr style="text-align: right;">
                                <th>◊©◊ù</th>
                                <th>◊ô◊ó◊ô◊ì◊ï◊™</th>
                                <th>◊û◊ò◊ë◊¢</th>
                                <th>◊û◊ó◊ô◊®</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeBonds.map((b, i) => `
                                <tr>
                                    <td><strong>${b.symbol}</strong></td>
                                    <td>${b.units}</td>
                                    <td>${b.currency || 'ILS'}</td>
                                    <td>
                                        <input type="number" 
                                               id="snapshot-price-bond-${i}" 
                                               data-bond-id="${b.id}"
                                               data-currency="${b.currency || 'ILS'}"
                                               step="0.01" 
                                               value="${b.currentPrice || b.costBasis || ''}"
                                               style="width: 80px;">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
                
                <div style="background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üí∞ ◊û◊ñ◊ï◊û◊ü</h4>
                    <div id="snapshot-cash-display">
                        ${Object.entries(portfolio.cash || {}).map(([curr, amount]) => 
                            amount !== 0 ? `<div>${curr}: ${amount.toLocaleString()}</div>` : ''
                        ).join('')}
                    </div>
                </div>
                
                <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0;">üìä ◊©◊ï◊ï◊ô ◊û◊ó◊ï◊©◊ë: <span id="snapshot-calculated-value">‚Ç™0</span></h4>
                    <button onclick="recalculateSnapshotValue()" class="btn" style="margin-top: 10px; background: #6366f1;">
                        üîÑ ◊ó◊©◊ë ◊û◊ó◊ì◊©
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="cancelSnapshotModal()" class="btn" style="background: var(--text-muted);">◊ë◊ô◊ò◊ï◊ú</button>
                    <button onclick="confirmSnapshotData()" class="btn btn-success">‚úÖ ◊ê◊ô◊©◊ï◊® ◊ï◊ô◊¶◊ô◊®◊™ Snapshot</button>
                </div>
            </div>
        </div>
    `;
    
    // Store callback and data for later use
    window._snapshotModalData = {
        triggerType,
        cashFlowILS,
        date,
        note,
        onComplete,
        activeHoldings,
        activeBonds
    };
    
    // Add modal to page
    const modalContainer = document.createElement('div');
    modalContainer.id = 'snapshot-modal-container';
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    console.log('üü¢ Modal added to page');
    
    // Calculate initial value
    setTimeout(recalculateSnapshotValue, 100);
    } catch (error) {
        console.error('üî¥ Error in openSnapshotDataModal:', error);
        notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊§◊™◊ô◊ó◊™ ◊ó◊ú◊ï◊ü ◊î◊†◊™◊ï◊†◊ô◊ù', 'error');
    }
}

/**
 * Get holdings that existed at a specific date
 */
function getActiveHoldingsAtDate(date) {
    if (!Array.isArray(portfolio.holdings)) return [];
    
    const targetDate = new Date(date);
    
    return portfolio.holdings.filter(h => {
        // If holding has purchaseDate, check if it was before target date
        if (h.purchaseDate) {
            return new Date(h.purchaseDate) <= targetDate;
        }
        // If no purchaseDate, assume it exists
        return true;
    });
}

/**
 * Get bonds that existed at a specific date
 */
function getActiveBondsAtDate(date) {
    if (!Array.isArray(portfolio.bonds)) return [];
    
    const targetDate = new Date(date);
    
    return portfolio.bonds.filter(b => {
        if (b.purchaseDate) {
            return new Date(b.purchaseDate) <= targetDate;
        }
        return true;
    });
}

/**
 * Fetch historical rates and populate modal
 */
async function fetchHistoricalRatesForModal(date) {
    try {
        const dateStr = new Date(date).toISOString().split('T')[0];
        const response = await fetch(`https://api.frankfurter.app/${dateStr}?from=ILS`);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.rates.USD) {
                document.getElementById('snapshot-rate-usd').value = (1 / data.rates.USD).toFixed(4);
            }
            if (data.rates.EUR) {
                document.getElementById('snapshot-rate-eur').value = (1 / data.rates.EUR).toFixed(4);
            }
            
            notify('‚úÖ ◊©◊¢◊®◊ô◊ù ◊î◊ï◊ë◊ê◊ï ◊ë◊î◊¶◊ú◊ó◊î', 'success');
            recalculateSnapshotValue();
        } else {
            notify('‚ö†Ô∏è ◊ú◊ê ◊î◊¶◊ú◊ó◊™◊ô ◊ú◊î◊ë◊ô◊ê ◊©◊¢◊®◊ô◊ù', 'error');
        }
    } catch (error) {
        console.error('Error fetching rates:', error);
        notify('‚ö†Ô∏è ◊©◊í◊ô◊ê◊î ◊ë◊î◊ë◊ê◊™ ◊©◊¢◊®◊ô◊ù', 'error');
    }
}

/**
 * Recalculate portfolio value based on modal inputs
 */
function recalculateSnapshotValue() {
    const data = window._snapshotModalData;
    if (!data) return;
    
    const rates = {
        USD: parseFloat(document.getElementById('snapshot-rate-usd').value) || 3.7,
        EUR: parseFloat(document.getElementById('snapshot-rate-eur').value) || 4.0,
        ILS: 1
    };
    
    let totalValue = 0;
    
    // Holdings
    data.activeHoldings.forEach((h, i) => {
        const priceInput = document.getElementById(`snapshot-price-holding-${i}`);
        if (priceInput) {
            const price = parseFloat(priceInput.value) || 0;
            const currency = h.currency || 'ILS';
            const valueInCurrency = h.shares * price;
            const valueInILS = currency === 'ILS' ? valueInCurrency : valueInCurrency * (rates[currency] || 1);
            totalValue += valueInILS;
        }
    });
    
    // Bonds
    data.activeBonds.forEach((b, i) => {
        const priceInput = document.getElementById(`snapshot-price-bond-${i}`);
        if (priceInput) {
            const price = parseFloat(priceInput.value) || 0;
            const currency = b.currency || 'ILS';
            const valueInCurrency = b.units * price;
            const valueInILS = currency === 'ILS' ? valueInCurrency : valueInCurrency * (rates[currency] || 1);
            totalValue += valueInILS;
        }
    });
    
    // Cash
    if (portfolio.cash) {
        for (const [currency, amount] of Object.entries(portfolio.cash)) {
            if (typeof amount === 'number') {
                totalValue += currency === 'ILS' ? amount : amount * (rates[currency] || 1);
            }
        }
    }
    
    document.getElementById('snapshot-calculated-value').textContent = `‚Ç™${Math.round(totalValue).toLocaleString()}`;
    
    return totalValue;
}

/**
 * Cancel snapshot modal
 */
function cancelSnapshotModal() {
    const container = document.getElementById('snapshot-modal-container');
    if (container) {
        container.remove();
    }
    window._snapshotModalData = null;
    notify('‚ùå ◊ë◊ï◊ò◊ú', 'info');
}

/**
 * Confirm and create snapshot
 */
function confirmSnapshotData() {
    console.log('üîµ confirmSnapshotData called');
    const data = window._snapshotModalData;
    if (!data) {
        console.error('üî¥ No modal data found!');
        return;
    }
    console.log('üîµ Modal data:', data);
    
    // Get rates
    const rates = {
        USD: parseFloat(document.getElementById('snapshot-rate-usd').value) || 3.7,
        EUR: parseFloat(document.getElementById('snapshot-rate-eur').value) || 4.0,
        ILS: 1
    };
    
    // Calculate final value
    const totalValue = recalculateSnapshotValue();
    
    // Create snapshot
    const snapshot = {
        id: Date.now(),
        date: data.date,
        value_before_flow: totalValue,
        cash_flow: data.cashFlowILS,
        exchange_rates: { ...rates },
        totalValue: totalValue + data.cashFlowILS,
        triggerType: data.triggerType,
        triggerNote: data.note
    };
    
    // Add to portfolio
    if (!Array.isArray(portfolio.snapshots)) {
        portfolio.snapshots = [];
    }
    portfolio.snapshots.push(snapshot);
    portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log('üì∏ Snapshot created:', snapshot);
    
    // Close modal
    const container = document.getElementById('snapshot-modal-container');
    if (container) {
        container.remove();
    }
    
    // Callback
    if (data.onComplete) {
        data.onComplete(snapshot);
    }
    
    window._snapshotModalData = null;
    notify('‚úÖ Snapshot ◊†◊ï◊¶◊® ◊ë◊î◊¶◊ú◊ó◊î', 'success');
}

// -----------------------------------------------------------------------------
// TRANSACTION HANDLERS - ◊©◊ï◊û◊®◊ô◊ù ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô ◊ë◊ú◊ë◊ì
// -----------------------------------------------------------------------------

/**
 * Handle deposit with snapshot modal
 */

/**
 * Handle automatic snapshot for today's date
 * Refreshes all prices and creates snapshot automatically
 */
async function handleAutomaticSnapshot(triggerType, cashFlowILS, date, note, onComplete) {
    console.log('üöÄ Automatic snapshot - refreshing prices...');
    notify('üîÑ ◊û◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù...', 'info');
    
    try {
        // 1. Refresh exchange rates
        await loadRates();
        console.log('‚úì Exchange rates refreshed');
        
        // 2. Refresh stock prices
        if (portfolio.holdings && portfolio.holdings.length > 0) {
            for (const holding of portfolio.holdings) {
                try {
                    const price = await fetchStockPrice(holding.symbol);
                    if (price && price > 0) {
                        holding.currentPrice = price;
                        console.log(`‚úì ${holding.symbol}: ${price}`);
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è Could not refresh ${holding.symbol}`);
                }
            }
        }
        
        // 3. Refresh bond prices
        if (portfolio.bonds && portfolio.bonds.length > 0) {
            for (const bond of portfolio.bonds) {
                try {
                    const price = await fetchBondPrice(bond.symbol);
                    if (price && price > 0) {
                        bond.currentPrice = price;
                        console.log(`‚úì ${bond.symbol}: ${price}`);
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è Could not refresh ${bond.symbol}`);
                }
            }
        }
        
        // 4. Calculate current portfolio value
        const rates = {
            USD: portfolio.rates?.USD || 3.7,
            EUR: portfolio.rates?.EUR || 4.0,
            ILS: 1
        };
        
        let totalValue = 0;
        
        // Holdings value
        if (portfolio.holdings) {
            for (const h of portfolio.holdings) {
                const price = h.currentPrice || h.costBasis || 0;
                const value = (h.shares || 0) * price;
                const currency = h.currency || 'ILS';
                totalValue += currency === 'ILS' ? value : value * (rates[currency] || 1);
            }
        }
        
        // Bonds value
        if (portfolio.bonds) {
            for (const b of portfolio.bonds) {
                const price = b.currentPrice || b.costBasis || 0;
                const value = (b.units || 0) * price;
                const currency = b.currency || 'ILS';
                totalValue += currency === 'ILS' ? value : value * (rates[currency] || 1);
            }
        }
        
        // Cash value
        if (portfolio.cash) {
            for (const [currency, amount] of Object.entries(portfolio.cash)) {
                if (typeof amount === 'number') {
                    totalValue += currency === 'ILS' ? amount : amount * (rates[currency] || 1);
                }
            }
        }
        
        console.log(`üìä Portfolio value: ‚Ç™${Math.round(totalValue).toLocaleString()}`);
        
        // 5. Create snapshot
        const snapshot = {
            id: Date.now(),
            date: date,
            value_before_flow: Math.round(totalValue),
            cash_flow: cashFlowILS,
            exchange_rates: { ...rates },
            totalValue: Math.round(totalValue) + cashFlowILS,
            triggerType: triggerType,
            triggerNote: note,
            automatic: true // Mark as automatic
        };
        
        if (!Array.isArray(portfolio.snapshots)) {
            portfolio.snapshots = [];
        }
        portfolio.snapshots.push(snapshot);
        portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        console.log('üì∏ Automatic snapshot created:', snapshot);
        notify('‚úÖ Snapshot ◊†◊ï◊¶◊® ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™', 'success');
        
        // 6. Call completion callback
        if (onComplete) {
            onComplete(snapshot);
        }
        
    } catch (error) {
        console.error('üî¥ Error in automatic snapshot:', error);
        notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊®◊ô◊¢◊†◊ï◊ü ◊û◊ó◊ô◊®◊ô◊ù - ◊†◊°◊î ◊ô◊ì◊†◊ô◊™', 'error');
        
        // Fall back to manual modal
        openSnapshotDataModal(triggerType, cashFlowILS, date, note, onComplete);
    }
}

function handleDepositWithSnapshot(amount, date, note) {
    console.log('üîµ handleDepositWithSnapshot called:', { amount, date, note });
    
    const depositDate = new Date(date + 'T12:00:00').toISOString();
    const today = new Date().toISOString().split('T')[0];
    const isToday = date === today;
    
    console.log('üîµ Deposit date:', depositDate, '| Is today:', isToday);
    
    if (isToday) {
        // Today - automatic snapshot with current prices
        handleAutomaticSnapshot('deposit', amount, depositDate, note || '◊î◊§◊ß◊ì◊î', () => {
            // Add deposit record
            if (!Array.isArray(portfolio.deposits)) {
                portfolio.deposits = [];
            }
            portfolio.deposits.push({
                id: Date.now(),
                date: depositDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) + amount;
            
            // Sort and save
            portfolio.deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(`‚úÖ Deposit completed: ‚Ç™${amount.toLocaleString()}`);
            notify(`‚úÖ ◊î◊§◊ß◊ì◊î ◊†◊©◊û◊®◊î: ‚Ç™${amount.toLocaleString()}`, 'success');
        });
    } else {
        // Past date - manual modal
        openSnapshotDataModal('deposit', amount, depositDate, note || '◊î◊§◊ß◊ì◊î', (snapshot) => {
            console.log('üü¢ Snapshot callback received:', snapshot);
            
            // Add deposit record
            if (!Array.isArray(portfolio.deposits)) {
                portfolio.deposits = [];
            }
            portfolio.deposits.push({
                id: Date.now(),
                date: depositDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) + amount;
            
            // Sort and save
            portfolio.deposits.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(`‚úÖ Deposit completed: ‚Ç™${amount.toLocaleString()}`);
            notify(`‚úÖ ◊î◊§◊ß◊ì◊î ◊†◊©◊û◊®◊î: ‚Ç™${amount.toLocaleString()}`, 'success');
        });
    }
}

/**
 * Handle withdrawal with snapshot modal
 */
function handleWithdrawalWithSnapshot(amount, date, note) {
    console.log('üîµ handleWithdrawalWithSnapshot called:', { amount, date, note });
    
    const withdrawalDate = new Date(date + 'T12:00:00').toISOString();
    const today = new Date().toISOString().split('T')[0];
    const isToday = date === today;
    
    console.log('üîµ Withdrawal date:', withdrawalDate, '| Is today:', isToday);
    
    if (isToday) {
        // Today - automatic snapshot with current prices
        handleAutomaticSnapshot('withdrawal', -amount, withdrawalDate, note || '◊û◊©◊ô◊õ◊î', () => {
            // Add withdrawal record
            if (!Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals = [];
            }
            portfolio.withdrawals.push({
                id: Date.now(),
                date: withdrawalDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) - amount;
            
            // Sort and save
            portfolio.withdrawals.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(`‚úÖ Withdrawal completed: ‚Ç™${amount.toLocaleString()}`);
            notify(`‚úÖ ◊û◊©◊ô◊õ◊î ◊†◊©◊û◊®◊î: ‚Ç™${amount.toLocaleString()}`, 'success');
        });
    } else {
        // Past date - manual modal
        openSnapshotDataModal('withdrawal', -amount, withdrawalDate, note || '◊û◊©◊ô◊õ◊î', (snapshot) => {
            console.log('üü¢ Snapshot callback received:', snapshot);
            
            // Add withdrawal record
            if (!Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals = [];
            }
            portfolio.withdrawals.push({
                id: Date.now(),
                date: withdrawalDate,
                amount: amount,
                currency: 'ILS',
                note: note
            });
            
            // Update cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            portfolio.cash.ILS = (portfolio.cash.ILS || 0) - amount;
            
            // Sort and save
            portfolio.withdrawals.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderCashFlow();
            updateOverview();
            
            console.log(`‚úÖ Withdrawal completed: ‚Ç™${amount.toLocaleString()}`);
            notify(`‚úÖ ◊û◊©◊ô◊õ◊î ◊†◊©◊û◊®◊î: ‚Ç™${amount.toLocaleString()}`, 'success');
        });
    }
}


/**
 * Record purchase - ALWAYS in original currency
 */
function recordPurchaseInOriginalCurrency(symbol, shares, price, currency, date, fee = 0, assetType = 'stocks', assetId = null) {
    const purchaseDate = new Date(date + 'T12:00:00').toISOString();
    const totalAmount = shares * price + fee;
    
    if (!Array.isArray(portfolio.purchases)) {
        portfolio.purchases = [];
    }
    
    portfolio.purchases.push({
        id: Date.now(),
        date: purchaseDate,
        symbol: symbol,
        shares: shares,
        price: price,              // ◊û◊ó◊ô◊® ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
        currency: currency,        // ◊î◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
        amount: totalAmount,       // ◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
        fee: fee,
        assetType: assetType,
        assetId: assetId,
        note: `◊ß◊†◊ô◊ô◊î: ${shares} √ó ${getCurrencySymbol(currency)}${price}`
    });
    
    portfolio.purchases.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(`üìù Purchase recorded: ${shares} ${symbol} @ ${currency}${price} (total: ${currency}${totalAmount})`);
}

/**
 * Record sale - ALWAYS in original currency
 */
function recordSaleInOriginalCurrency(symbol, shares, price, currency, date, fee = 0, assetType = 'stocks', assetId = null) {
    const saleDate = new Date(date + 'T12:00:00').toISOString();
    const totalAmount = shares * price - fee;
    
    if (!Array.isArray(portfolio.sales)) {
        portfolio.sales = [];
    }
    
    portfolio.sales.push({
        id: Date.now(),
        date: saleDate,
        symbol: symbol,
        shares: shares,
        price: price,              // ◊û◊ó◊ô◊® ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
        currency: currency,        // ◊î◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
        amount: totalAmount,       // ◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
        fee: fee,
        assetType: assetType,
        assetId: assetId,
        note: `◊û◊õ◊ô◊®◊î: ${shares} √ó ${getCurrencySymbol(currency)}${price}`
    });
    
    portfolio.sales.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(`üìù Sale recorded: ${shares} ${symbol} @ ${currency}${price} (total: ${currency}${totalAmount})`);
}

/**
 * Record currency exchange
 */
function recordCurrencyExchange(fromCurrency, fromAmount, toCurrency, toAmount, date) {
    const exchangeDate = new Date(date + 'T12:00:00').toISOString();
    
    if (!Array.isArray(portfolio.exchanges)) {
        portfolio.exchanges = [];
    }
    
    portfolio.exchanges.push({
        id: Date.now(),
        date: exchangeDate,
        fromCurrency: fromCurrency,
        fromAmount: fromAmount,
        toCurrency: toCurrency,
        toAmount: toAmount,
        rate: toAmount / fromAmount,
        note: `◊î◊û◊®◊î: ${fromAmount} ${fromCurrency} ‚Üí ${toAmount} ${toCurrency}`
    });
    
    // Update cash
    if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
    portfolio.cash[fromCurrency] = (portfolio.cash[fromCurrency] || 0) - fromAmount;
    portfolio.cash[toCurrency] = (portfolio.cash[toCurrency] || 0) + toAmount;
    
    portfolio.exchanges.sort((a, b) => new Date(a.date) - new Date(b.date));
    saveData();
    
    console.log(`üí± Exchange recorded: ${fromAmount} ${fromCurrency} ‚Üí ${toAmount} ${toCurrency}`);
}

// -----------------------------------------------------------------------------
// TWR CALCULATION - ◊ó◊ô◊©◊ï◊ë ◊™◊©◊ï◊ê◊î
// -----------------------------------------------------------------------------

/**
 * Calculate TWR from snapshots
 */
function calculateTWRv3() {
    if (!Array.isArray(portfolio.snapshots) || portfolio.snapshots.length === 0) {
        console.log('‚ö†Ô∏è No snapshots for TWR calculation');
        return null;
    }
    
    const snapshots = [...portfolio.snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    console.log(`üìä Calculating TWR with ${snapshots.length} snapshots`);
    
    // Calculate periodic returns
    const periodicReturns = [];
    
    for (let i = 1; i < snapshots.length; i++) {
        const prev = snapshots[i - 1];
        const curr = snapshots[i];
        
        // Start value = previous value_before_flow + previous cash_flow
        const startValue = (prev.value_before_flow || 0) + (prev.cash_flow || 0);
        
        // End value = current value_before_flow
        const endValue = curr.value_before_flow || 0;
        
        if (startValue > 0 && !isNaN(endValue)) {
            const R = (endValue - startValue) / startValue;
            periodicReturns.push(1 + R);
            console.log(`üìä Period ${i}: ‚Ç™${Math.round(startValue).toLocaleString()} ‚Üí ‚Ç™${Math.round(endValue).toLocaleString()} = ${(R * 100).toFixed(2)}%`);
        }
    }
    
    // Base TWR
    const baseTWR = periodicReturns.length > 0
        ? periodicReturns.reduce((acc, r) => acc * r, 1) - 1
        : 0;
    
    // Live period
    const lastSnap = snapshots[snapshots.length - 1];
    const liveStart = (lastSnap.value_before_flow || 0) + (lastSnap.cash_flow || 0);
    const currentValue = getTotalPortfolioValue();
    
    let liveTWR = 0;
    if (liveStart > 0 && !isNaN(currentValue)) {
        liveTWR = (currentValue - liveStart) / liveStart;
        console.log(`üìä Live: ‚Ç™${Math.round(liveStart).toLocaleString()} ‚Üí ‚Ç™${Math.round(currentValue).toLocaleString()} = ${(liveTWR * 100).toFixed(2)}%`);
    }
    
    // Total TWR
    const totalTWR = (1 + baseTWR) * (1 + liveTWR) - 1;
    
    // Years for annualization
    const firstSnap = snapshots[0];
    const days = (new Date() - new Date(firstSnap.date)) / (1000 * 60 * 60 * 24);
    const years = days / 365.25;
    
    let annualized = null;
    if (years >= 1 && totalTWR > -1) {
        annualized = (Math.pow(1 + totalTWR, 1 / years) - 1) * 100;
    }
    
    console.log(`‚úÖ TWR: Base=${(baseTWR * 100).toFixed(2)}%, Live=${(liveTWR * 100).toFixed(2)}%, Total=${(totalTWR * 100).toFixed(2)}%`);
    
    return {
        total: totalTWR * 100,
        base: baseTWR * 100,
        live: liveTWR * 100,
        annualized,
        years,
        periods: periodicReturns.length + 1
    };
}

// -----------------------------------------------------------------------------
// UTILITY FUNCTIONS
// -----------------------------------------------------------------------------

// getCurrencySymbol already defined elsewhere



        // Expose functions globally for onclick handlers
        window.openSnapshotDataModal = openSnapshotDataModal;
        window.confirmSnapshotData = confirmSnapshotData;
        window.cancelSnapshotModal = cancelSnapshotModal;
        window.recalculateSnapshotValue = recalculateSnapshotValue;
        window.fetchHistoricalRatesForModal = fetchHistoricalRatesForModal;
        window.handleAutomaticSnapshot = handleAutomaticSnapshot;
        window.fillCurrentPrices = fillCurrentPrices;
        
        console.log('‚úÖ TWR Complete System v3.0 loaded');

        
        // =============================================================================
        // END OF TWR SYSTEM v3.0
        // =============================================================================
        
        function convertToILSWithRates(amount, currency, rates) {
            if (currency === 'ILS') return amount;
            const rate = rates[currency] || portfolio.rates[currency] || 1;
            return amount * rate;
        }

        /**
         * ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊û◊†◊ô◊ï◊™
         */
        function calculateStocksValueILS(rates = null) {
            const r = rates || portfolio.rates;
            let total = 0;
            
            if (!Array.isArray(portfolio.holdings)) return 0;
            
            portfolio.holdings.forEach(h => {
                const price = h.currentPrice || h.costBasis || 0;
                const shares = h.shares || 0;
                const currency = h.currency || getAssetCurrency(h.symbol);
                
                // ◊©◊ï◊ï◊ô = ◊õ◊û◊ï◊™ √ó ◊û◊ó◊ô◊® (◊î◊ê◊™◊® ◊©◊ï◊û◊® ◊û◊ó◊ô◊®◊ô◊ù ◊ë◊©◊ß◊ú◊ô◊ù/◊ì◊ï◊ú◊®◊ô◊ù, ◊ú◊ê ◊ë◊ê◊ó◊ï◊ñ◊ô◊ù)
                const value = shares * price;
                
                total += convertToILSWithRates(value, currency, r);
            });
            
            return total;
        }

        /**
         * ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊ê◊í"◊ó
         */
        function calculateBondsValueILS(rates = null) {
            const r = rates || portfolio.rates;
            let total = 0;
            
            if (!Array.isArray(portfolio.bonds)) return 0;
            
            portfolio.bonds.forEach(b => {
                const price = b.currentPrice || b.costBasis || 0;
                const units = b.units || 0;
                const currency = b.currency || 'ILS';
                
                // ◊©◊ï◊ï◊ô = ◊ô◊ó◊ô◊ì◊ï◊™ √ó ◊û◊ó◊ô◊® (◊î◊ê◊™◊® ◊©◊ï◊û◊® ◊û◊ó◊ô◊®◊ô◊ù ◊ë◊©◊ß◊ú◊ô◊ù, ◊ú◊ê ◊ë◊ê◊ó◊ï◊ñ◊ô◊ù)
                const value = units * price;
                
                total += convertToILSWithRates(value, currency, r);
            });
            
            return total;
        }

        /**
         * ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊™◊ô◊ß ◊õ◊ï◊ú◊ú (◊û◊©◊ï◊§◊®)
         */
        function getTotalPortfolioValueEnhanced(rates = null) {
            const stocksValue = calculateStocksValueILS(rates);
            const bondsValue = calculateBondsValueILS(rates);
            const cashValue = getTotalCashILS(rates);
            
            return stocksValue + bondsValue + cashValue;
        }

        /**
         * ◊ó◊ô◊©◊ï◊ë TWR ◊û◊©◊ï◊§◊®
         */
        function calculateTWREnhanced() {
            if (!Array.isArray(portfolio.snapshots) || portfolio.snapshots.length === 0) {
                console.log('‚ö†Ô∏è No snapshots for TWR calculation');
                return null;
            }
            
            const snapshots = [...portfolio.snapshots].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log(`üìä Calculating TWR with ${snapshots.length} snapshots`);
            
            if (snapshots.length === 1) {
                const lastSnapshot = snapshots[0];
                const startValue = (lastSnapshot.value_before_flow || lastSnapshot.totalValue || 0) + 
                                  (lastSnapshot.cash_flow || 0);
                const currentValue = getTotalPortfolioValueEnhanced();
                
                if (startValue === 0) return null;
                
                const rLive = (currentValue - startValue) / startValue;
                const days = (new Date() - new Date(lastSnapshot.date)) / (1000 * 60 * 60 * 24);
                const years = days / 365.25;
                
                return {
                    total: rLive * 100,
                    base: 0,
                    live: rLive * 100,
                    annualized: years >= 1 ? (Math.pow(1 + rLive, 1/years) - 1) * 100 : null,
                    years: years,
                    periods: 1
                };
            }
            
            const periodicReturns = [];
            
            for (let i = 1; i < snapshots.length; i++) {
                const prev = snapshots[i - 1];
                const curr = snapshots[i];
                
                const startValue = (prev.value_before_flow !== undefined ? prev.value_before_flow : prev.totalValue || 0) + 
                                  (prev.cash_flow || 0);
                const endValue = curr.value_before_flow !== undefined ? curr.value_before_flow : curr.totalValue || 0;
                
                if (startValue > 0 && !isNaN(startValue) && !isNaN(endValue)) {
                    const R_i = (endValue - startValue) / startValue;
                    periodicReturns.push(1 + R_i);
                    console.log(`üìä Period ${i}: ‚Ç™${Math.round(startValue)} ‚Üí ‚Ç™${Math.round(endValue)}, R=${(R_i*100).toFixed(2)}%`);
                }
            }
            
            const TWR_Base = periodicReturns.length > 0 
                ? periodicReturns.reduce((acc, factor) => acc * factor, 1) - 1 
                : 0;
            
            const lastSnapshot = snapshots[snapshots.length - 1];
            const startValueLive = (lastSnapshot.value_before_flow !== undefined ? lastSnapshot.value_before_flow : lastSnapshot.totalValue || 0) + 
                                  (lastSnapshot.cash_flow || 0);
            const currentValueLive = getTotalPortfolioValueEnhanced();
            
            let R_Live = 0;
            if (startValueLive > 0 && !isNaN(startValueLive) && !isNaN(currentValueLive)) {
                R_Live = (currentValueLive - startValueLive) / startValueLive;
                console.log(`üìä Live: ‚Ç™${Math.round(startValueLive)} ‚Üí ‚Ç™${Math.round(currentValueLive)}, R=${(R_Live*100).toFixed(2)}%`);
            }
            
            const TWR_Total = (1 + TWR_Base) * (1 + R_Live) - 1;
            
            const firstSnapshot = snapshots[0];
            const daysDiff = (new Date() - new Date(firstSnapshot.date)) / (1000 * 60 * 60 * 24);
            const years = daysDiff / 365.25;
            
            let annualized = null;
            if (years >= 1 && TWR_Total > -1) {
                annualized = (Math.pow(1 + TWR_Total, 1 / years) - 1) * 100;
            }
            
            console.log(`‚úÖ TWR: Base=${(TWR_Base*100).toFixed(2)}%, Live=${(R_Live*100).toFixed(2)}%, Total=${(TWR_Total*100).toFixed(2)}%`);
            
            return {
                total: TWR_Total * 100,
                base: TWR_Base * 100,
                live: R_Live * 100,
                annualized: annualized,
                years: years,
                periods: periodicReturns.length + 1
            };
        }

        /**
         * ◊ë◊†◊ô◊ô◊™ ◊û◊ñ◊ï◊û◊ü ◊û◊ó◊ì◊© ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î
         */
        function rebuildCashFromHistory() {
            console.log('üîÑ Rebuilding cash from history...');
            
            const allEvents = [];
            
            // ◊î◊§◊ß◊ì◊ï◊™
            if (Array.isArray(portfolio.deposits)) {
                portfolio.deposits.forEach(d => {
                    allEvents.push({
                        type: 'deposit',
                        date: new Date(d.date),
                        amount: d.amount || 0,
                        currency: d.currency || 'ILS'
                    });
                });
            }
            
            // ◊û◊©◊ô◊õ◊ï◊™
            if (Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals.forEach(w => {
                    allEvents.push({
                        type: 'withdrawal',
                        date: new Date(w.date),
                        amount: w.amount || 0,
                        currency: w.currency || 'ILS'
                    });
                });
            }
            
            // ◊ß◊†◊ô◊ï◊™
            if (Array.isArray(portfolio.purchases)) {
                portfolio.purchases.forEach(p => {
                    // ◊©◊ô◊û◊ï◊© ◊ë◊©◊ì◊ï◊™ ◊î◊ó◊ì◊©◊ô◊ù ◊ê◊ù ◊ß◊ô◊ô◊û◊ô◊ù
                    let currency = p.original_currency || getAssetCurrency(p.symbol);
                    let amount = p.original_amount;
                    let fee = p.fee || 0;
                    let feeCurrency = p.fee_currency || currency;
                    
                    // ◊ê◊ù ◊ê◊ô◊ü original_amount - ◊†◊°◊î ◊ú◊©◊ó◊ñ◊® ◊û-amount
                    if (!amount && p.amount) {
                        const rate = portfolio.rates[currency] || 1;
                        amount = p.amount / rate;
                    }
                    
                    allEvents.push({
                        type: 'purchase',
                        date: new Date(p.date),
                        symbol: p.symbol,
                        amount: amount || 0,
                        currency: currency,
                        fee: fee,
                        feeCurrency: feeCurrency
                    });
                });
            }
            
            // ◊û◊õ◊ô◊®◊ï◊™
            if (Array.isArray(portfolio.sales)) {
                portfolio.sales.forEach(s => {
                    // ◊©◊ô◊û◊ï◊© ◊ë◊©◊ì◊ï◊™ ◊î◊ó◊ì◊©◊ô◊ù ◊ê◊ù ◊ß◊ô◊ô◊û◊ô◊ù
                    let currency = s.original_currency || s.currency || getAssetCurrency(s.symbol);
                    let amount = s.original_amount;
                    
                    // ◊ê◊ù ◊ê◊ô◊ü original_amount - ◊†◊°◊î ◊ú◊©◊ó◊ñ◊®
                    if (!amount) {
                        if (s.shares && s.salePrice) {
                            amount = s.shares * s.salePrice;
                        } else if (s.amount) {
                            const rate = portfolio.rates[currency] || 1;
                            amount = s.amount / rate;
                        }
                    }
                    
                    allEvents.push({
                        type: 'sale',
                        date: new Date(s.date),
                        symbol: s.symbol,
                        amount: amount || 0,
                        currency: currency
                    });
                });
            }
            
            // ◊î◊û◊®◊ï◊™ ◊û◊ò◊ë◊¢
            if (Array.isArray(portfolio.currencyExchanges)) {
                portfolio.currencyExchanges.forEach(e => {
                    allEvents.push({
                        type: 'exchange',
                        date: new Date(e.date),
                        fromCurrency: e.fromCurrency,
                        fromAmount: e.fromAmount,
                        toCurrency: e.toCurrency,
                        toAmount: e.toAmount
                    });
                });
            }
            
            allEvents.sort((a, b) => a.date - b.date);
            
            const cash = { ILS: 0, USD: 0, EUR: 0 };
            const purchaseCountBySymbol = {};
            
            console.log(`üìã Processing ${allEvents.length} events...`);
            
            allEvents.forEach((event, idx) => {
                switch (event.type) {
                    case 'deposit':
                        cash[event.currency] += event.amount;
                        console.log(`üì• ${idx+1}. ◊î◊§◊ß◊ì◊î: +${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'withdrawal':
                        cash[event.currency] -= event.amount;
                        console.log(`üì§ ${idx+1}. ◊û◊©◊ô◊õ◊î: -${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'purchase':
                        const purchaseCount = purchaseCountBySymbol[event.symbol] || 0;
                        purchaseCountBySymbol[event.symbol] = purchaseCount + 1;
                        
                        // ◊ó◊ô◊©◊ï◊ë ◊¢◊û◊ú◊î - ◊©◊ô◊û◊ï◊© ◊ë◊¢◊û◊ú◊î ◊û◊î◊¢◊°◊ß◊î ◊ê◊ù ◊ô◊©, ◊ê◊ó◊®◊™ ◊ó◊ô◊©◊ï◊ë
                        let fee = event.fee || 0;
                        let feeCurrency = event.feeCurrency || event.currency;
                        
                        if (!event.fee) {
                            // ◊ê◊ô◊ü ◊¢◊û◊ú◊î ◊©◊û◊ï◊®◊î - ◊ó◊©◊ë ◊ú◊§◊ô ◊î◊õ◊ú◊ú◊ô◊ù
                            const feeCalc = calculateFeeForTransaction(event.symbol, 'buy', purchaseCount);
                            fee = feeCalc.fee;
                            feeCurrency = feeCalc.feeCurrency || event.currency;
                        }
                        
                        cash[event.currency] -= event.amount;
                        if (fee > 0 && feeCurrency) {
                            cash[feeCurrency] -= fee;
                        }
                        console.log(`üõí ${idx+1}. ◊ß◊†◊ô◊ô◊î ${event.symbol}: -${event.amount.toFixed(2)} ${event.currency}` + 
                                   (fee > 0 ? ` + ◊¢◊û◊ú◊î -${fee} ${feeCurrency}` : ''));
                        break;
                        
                    case 'sale':
                        cash[event.currency] += event.amount;
                        console.log(`üí∞ ${idx+1}. ◊û◊õ◊ô◊®◊î ${event.symbol}: +${event.amount.toFixed(2)} ${event.currency}`);
                        break;
                        
                    case 'exchange':
                        cash[event.fromCurrency] -= event.fromAmount;
                        cash[event.toCurrency] += event.toAmount;
                        console.log(`üîÑ ${idx+1}. ◊î◊û◊®◊î: -${event.fromAmount.toFixed(2)} ${event.fromCurrency} ‚Üí +${event.toAmount.toFixed(2)} ${event.toCurrency}`);
                        break;
                }
            });
            
            portfolio.cash = { ...cash };
            
            console.log('');
            console.log('üí∞ Final cash balances:');
            console.log(`   ILS: ‚Ç™${cash.ILS.toFixed(2)}`);
            console.log(`   USD: $${cash.USD.toFixed(2)}`);
            console.log(`   EUR: ‚Ç¨${cash.EUR.toFixed(2)}`);
            
            return cash;
        }

        // ===========================================
        // EXCHANGE RATES - AUTO UPDATE
        // ===========================================
        
        async function updateExchangeRates() {
            // ◊¢◊ì◊õ◊ï◊ü ◊û◊î◊©◊ì◊ï◊™ ◊ë◊û◊û◊©◊ß (◊¢◊ì◊õ◊ï◊ü ◊ô◊ì◊†◊ô)
            const usdInput = document.getElementById('rate-usd');
            const eurInput = document.getElementById('rate-eur');
            
            const usdValue = parseFloat(usdInput.value);
            const eurValue = parseFloat(eurInput.value);
            
            if (!isNaN(usdValue) && usdValue > 0) {
                portfolio.rates.USD = usdValue;
            }
            if (!isNaN(eurValue) && eurValue > 0) {
                portfolio.rates.EUR = eurValue;
            }
            
            saveData();
            updateOverview();
            notify(`‚úÖ ◊©◊¢◊®◊ô◊ù ◊†◊©◊û◊®◊ï! $1 = ‚Ç™${portfolio.rates.USD.toFixed(2)} | ‚Ç¨1 = ‚Ç™${portfolio.rates.EUR.toFixed(2)}`);
        }
        
        async function tryAutoUpdateRates() {
            const notif = document.getElementById('notification');
            notif.textContent = 'üîÑ ◊û◊ï◊©◊ö ◊©◊¢◊®◊ô◊ù ◊û◊î◊ê◊ô◊†◊ò◊®◊†◊ò...';
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üîÑ Starting automatic exchange rate update...');
            console.log('Current rates before update:', { 
                USD: portfolio.rates.USD, 
                EUR: portfolio.rates.EUR 
            });
            
            try {
                const success = await autoUpdateExchangeRates();
                
                // Always hide the loading message
                notif.classList.remove('show');
                
                if (success) {
                    console.log('New rates after update:', { 
                        USD: portfolio.rates.USD, 
                        EUR: portfolio.rates.EUR 
                    });
                    console.log('‚úÖ Exchange rates updated successfully!');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    
                    updateOverview();
                    notify(`‚úÖ ◊©◊¢◊®◊ô◊ù ◊¢◊ï◊ì◊õ◊†◊ï!\nüíµ $1 = ‚Ç™${portfolio.rates.USD.toFixed(4)}\nüí∂ ‚Ç¨1 = ‚Ç™${portfolio.rates.EUR.toFixed(4)}`);
                } else {
                    console.log('‚ùå All API methods failed');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    notify('‚ö†Ô∏è ◊¢◊ì◊õ◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊†◊õ◊©◊ú. ◊¢◊®◊ï◊ö ◊ô◊ì◊†◊ô◊™ ◊ê◊ï ◊†◊°◊î ◊©◊ï◊ë ◊û◊ê◊ï◊ó◊® ◊ô◊ï◊™◊®', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error during exchange rate update:', error);
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                notif.classList.remove('show');
                notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü ◊©◊¢◊®◊ô◊ù. ◊†◊°◊î ◊©◊ï◊ë ◊û◊ê◊ï◊ó◊® ◊ô◊ï◊™◊®', 'error');
            }
        }
        
        async function autoUpdateExchangeRates() {
            // ◊†◊ô◊°◊ô◊ï◊ü ◊¢◊ì◊õ◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊¢◊ù ◊û◊°◊§◊® APIs (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô - ◊ú◊ê ◊õ◊©◊ú◊ï◊ü ◊ê◊ù ◊†◊õ◊©◊ú)
            console.log('üîÑ Trying to auto-update exchange rates...');
            
            // ◊†◊ô◊°◊ô◊ï◊ü 1: Frankfurter API
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS,EUR');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Frankfurter API response:', data);
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: 1 USD = X ILS and 1 USD = Y EUR
                        // We need: USD to ILS and EUR to ILS
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`üíµ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // If 1 USD = 3.75 ILS and 1 USD = 0.92 EUR
                        // Then 1 EUR = (1/0.92) USD = 1.087 USD
                        // So 1 EUR = 1.087 √ó 3.75 = 4.08 ILS
                        // Formula: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`üí∂ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('‚úÖ Exchange rates updated via Frankfurter API');
                        console.log(`   Final rates: $1 = ‚Ç™${portfolio.rates.USD.toFixed(4)}, ‚Ç¨1 = ‚Ç™${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Frankfurter API failed:', error.message);
            }
            
            // ◊†◊ô◊°◊ô◊ï◊ü 2: ExchangeRate-API
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä ExchangeRate-API response (first 5 rates):', {
                        ILS: data.rates?.ILS,
                        EUR: data.rates?.EUR,
                        GBP: data.rates?.GBP,
                        JPY: data.rates?.JPY,
                        CNY: data.rates?.CNY
                    });
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: all rates relative to 1 USD
                        // 1 USD = X ILS, 1 USD = Y EUR
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`üíµ USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // Same logic as above: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`üí∂ EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('‚úÖ Exchange rates updated via ExchangeRate-API');
                        console.log(`   Final rates: $1 = ‚Ç™${portfolio.rates.USD.toFixed(4)}, ‚Ç¨1 = ‚Ç™${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è ExchangeRate-API failed:', error.message);
            }
            
            // ◊†◊ô◊°◊ô◊ï◊ü 3: ◊î◊ï◊°◊£ Bank of Israel API ◊ê◊ù ◊ê◊§◊©◊®◊ô
            try {
                // Note: BOI API usually requires CORS proxy or backend
                // This is a fallback attempt
                const response = await fetch('https://www.boi.org.il/currency.xml');
                if (response.ok) {
                    const text = await response.text();
                    console.log('üìä BOI XML received, parsing...');
                    // Parse XML for USD and EUR rates
                    // This is complex and might not work due to CORS
                }
            } catch (error) {
                console.log('‚ö†Ô∏è BOI API not accessible (CORS or network issue)');
            }
            
            console.log('‚ÑπÔ∏è All auto-update methods failed - using manual rates');
            console.log('üí° You can update manually from: https://www.boi.org.il/he/markets/exchangerates/');
            return false;
        }

        // ===========================================
        // CASH FLOW CORE FUNCTIONS
        // ===========================================
        
        // ◊ó◊ô◊©◊ï◊ë ◊û◊ñ◊ï◊û◊ü ◊ï◊ô◊®◊ò◊ï◊ê◊ú◊ô (implicit cash)
        function getImplicitCash(assetType = 'all') {
            let deposits = 0;
            let withdrawals = 0;
            let purchases = 0;
            let sales = 0;
            
            if (assetType === 'all' || assetType === 'stocks') {
                deposits += portfolio.deposits
                    .filter(d => !d.assetType || d.assetType === 'stocks')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => !w.assetType || w.assetType === 'stocks')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => !p.assetType || p.assetType === 'stocks')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => !s.assetType || s.assetType === 'stocks')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            if (assetType === 'all' || assetType === 'bonds') {
                deposits += portfolio.deposits
                    .filter(d => d.assetType === 'bonds')
                    .reduce((sum, d) => sum + (d.amount || 0), 0);
                withdrawals += portfolio.withdrawals
                    .filter(w => w.assetType === 'bonds')
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                purchases += portfolio.purchases
                    .filter(p => p.assetType === 'bonds')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                sales += portfolio.sales
                    .filter(s => s.assetType === 'bonds')
                    .reduce((sum, s) => sum + (s.amount || 0), 0);
            }
            
            return deposits - withdrawals - purchases + sales;
        }
        
        // ‚úÖ NEW: Calculate cash by currency (for display in Cash Flow tab)
        function getCashByCurrency(currency) {
            let deposits = 0;
            let withdrawals = 0;
            let purchases = 0;
            let sales = 0;
            
            // Deposits in this currency
            deposits = portfolio.deposits
                .filter(d => d.currency === currency || (!d.currency && currency === 'ILS'))
                .reduce((sum, d) => sum + (d.amount || 0), 0);
            
            // Withdrawals in this currency
            withdrawals = portfolio.withdrawals
                .filter(w => w.currency === currency || (!w.currency && currency === 'ILS'))
                .reduce((sum, w) => sum + (w.amount || 0), 0);
            
            // Purchases in this currency (stocks + bonds)
            portfolio.holdings
                .filter(h => h.currency === currency)
                .forEach(h => {
                    purchases += h.shares * h.costBasis;
                });
            
            if (portfolio.bonds) {
                portfolio.bonds
                    .filter(b => (b.currency || 'ILS') === currency)
                    .forEach(b => {
                        purchases += b.units * b.costBasis;
                    });
            }
            
            // Sales in this currency
            sales = portfolio.sales
                .filter(s => s.currency === currency)
                .reduce((sum, s) => {
                    const amount = s.shares ? (s.shares * s.salePrice) : s.amount;
                    return sum + (amount || 0);
                }, 0);
            
            return deposits - withdrawals - purchases + sales;
        }
        
        // ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊õ◊ï◊ú◊ú ◊©◊ú ◊î◊™◊ô◊ß
        function getTotalPortfolioValue() {
            const stocksValue = getTotalValueILS();
            const bondsValue = portfolio.bonds ? portfolio.bonds.reduce((sum, b) => {
                const value = b.units * b.currentPrice;
                return sum + convertToILS(value, b.currency || 'ILS');
            }, 0) : 0;
            
            // ‚úÖ FIX: Use portfolio.cash instead of getImplicitCash for accurate total
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            const cash = (portfolio.cash.ILS || 0) + 
                         convertToILS(portfolio.cash.USD || 0, 'USD') + 
                         convertToILS(portfolio.cash.EUR || 0, 'EUR');
            
            return stocksValue + bondsValue + cash;
        }
        
        // ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊™◊ô◊ß ◊ú◊§◊ô ◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î (costBasis) - ◊ú◊©◊ô◊û◊ï◊© ◊ë-snapshots
        function getTotalPortfolioValueAtCost() {
            let stocksValue = 0;
            portfolio.holdings.forEach(h => {
                const value = h.shares * h.costBasis;
                stocksValue += convertToILS(value, h.currency);
            });
            
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const cash = getImplicitCash('all');
            
            return stocksValue + bondsValue + cash;
        }
        
        // ◊ô◊¶◊ô◊®◊™ Snapshot (◊ú◊§◊†◊ô ◊î◊§◊ß◊ì◊î/◊û◊©◊ô◊õ◊î!)
        function createSnapshot(triggerType, triggerNote = '', cashFlow = 0, customDate = null) {
            const snapshot = {
                id: Date.now(),
                date: customDate || new Date().toISOString(),
                value_before_flow: getTotalPortfolioValue(), // ◊©◊ï◊ï◊ô ◊î◊™◊ô◊ß ◊ú◊§◊†◊ô ◊ñ◊®◊ô◊û◊™ ◊î◊û◊ñ◊ï◊û◊ü
                cash_flow: cashFlow, // ◊°◊õ◊ï◊ù ◊î◊î◊§◊ß◊ì◊î (+) ◊ê◊ï ◊î◊û◊©◊ô◊õ◊î (-)
                stocksValue: getTotalValueILS(),
                bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                implicitCash: getImplicitCash('all'),
                totalValue: getTotalPortfolioValue(),
                triggerType: triggerType, // 'deposit' or 'withdrawal'
                triggerNote: triggerNote
            };
            
            portfolio.snapshots.push(snapshot);
            
            // Sort snapshots by date after adding new one
            portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log('üì∏ Snapshot created:', snapshot);
            return snapshot;
        }
        
        // ◊ó◊ô◊©◊ï◊ë TWR ◊¢◊ù ◊™◊û◊ô◊õ◊î ◊ë-Live TWR
        function calculateTWR(assetType = 'total') {
            // ◊©◊ô◊û◊ï◊© ◊ë◊í◊®◊°◊î ◊î◊û◊©◊ï◊§◊®◊™
            return calculateTWREnhanced();
        }

        // ===========================================
        // ISRAELI TASE (BORSE) API
        // ===========================================
        
        async function fetchTASEPrice(securityNumber) {
            console.log(`üáÆüá± Fetching Israeli security: ${securityNumber}`);
            
            // Strategy 1: Try TASE Official Site (BEST - real-time updates!)
            try {
                console.log(`üìä Strategy 1: TASE Official Site (market.tase.co.il)...`);
                const taseUrl = `https://market.tase.co.il/he/market_data/security/${securityNumber}/major_data`;
                
                const response = await fetch(taseUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`‚úÖ Got TASE HTML, length: ${html.length}`);
                    
                    // Look for "◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü (◊ë◊ê◊í◊ï◊®◊ï◊™)" or similar
                    const patterns = [
                        // Pattern 1: "◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü (◊ë◊ê◊í◊ï◊®◊ï◊™):" followed by number
                        /◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü\s*\(◊ë◊ê◊í◊ï◊®◊ï◊™\)[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: Just "◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü" with number
                        /◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü[:\s]*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Data in structured format
                        /◊ë◊ê◊í◊ï◊®◊ï◊™[):\s]*([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`üîç TASE Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // TASE shows in agorot - convert to shekels
                                if (price > 100) {
                                    console.log(`üîÑ Converting from agorot: ${price} ‚Üí ‚Ç™${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`‚úÖ TASE Official: ‚Ç™${price.toFixed(2)} (real-time!)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`‚ö†Ô∏è No price found in TASE HTML (might be JS-rendered)`);
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è TASE Official failed: ${e.message}`);
            }
            
            // Strategy 2: Try TheMarker (fallback - end of day prices)
            try {
                console.log(`üìä Strategy 2: TheMarker (end-of-day prices)...`);
                const markerUrl = `https://finance.themarker.com/etf/${securityNumber}`;
                
                const response = await fetch(markerUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`‚úÖ Got TheMarker HTML, length: ${html.length}`);
                    
                    // Look for SPECIFIC data cells/patterns
                    const patterns = [
                        // Pattern 1: "◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü" followed by number (most specific!)
                        /◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü[^\d]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 2: In table/data structure with pipe separator
                        /◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü[^|]*\|\s*([0-9,]+\.?[0-9]*)/,
                        // Pattern 3: Generic price keywords with clear separation
                        /(?:◊©◊¢◊® ◊ê◊ó◊®◊ï◊ü|◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô|◊©◊ï◊ï◊ô ◊ô◊ó◊ô◊ì◊î)[\s\S]{0,50}?([0-9,]+\.?[0-9]*)/,
                        // Pattern 4: Fallback - price near beginning
                        /(?:◊û◊ó◊ô◊®|◊©◊¢◊®)[\s:|\-]{1,10}([0-9,]+\.?[0-9]*)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1].trim();
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`üîç TheMarker Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(`üîÑ Converting from agorot: ${price} ‚Üí ‚Ç™${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`‚úÖ TheMarker: ‚Ç™${price.toFixed(2)} (end-of-day)`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`‚ö†Ô∏è No valid price found in TheMarker HTML`);
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è TheMarker failed: ${e.message}`);
            }
            
            // Strategy 3: Try Globes
            try {
                console.log(`üìä Strategy 3: Globes...`);
                const globesUrl = `https://www.globes.co.il/portal/instrument.aspx?instrumentid=${securityNumber}`;
                
                const response = await fetch(globesUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    console.log(`‚úÖ Got Globes HTML, length: ${html.length}`);
                    
                    // Context-based patterns only
                    const patterns = [
                        /(?:◊©◊¢◊®|◊û◊ó◊ô◊®|◊©◊ï◊ï◊ô)[^\d]{0,30}(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/,
                        /class="[^"]*price[^"]*"[^>]*>(\d{1,3}(?:,\d{3})*(?:\.\d+)?)/
                    ];
                    
                    for (let i = 0; i < patterns.length; i++) {
                        const match = html.match(patterns[i]);
                        if (match && match[1]) {
                            let priceStr = match[1];
                            let price = parseFloat(priceStr.replace(/,/g, ''));
                            console.log(`üîç Globes Pattern ${i+1} found: "${priceStr}" = ${price}`);
                            
                            if (price && price > 0) {
                                // Convert from agorot if > 100
                                if (price > 100) {
                                    console.log(`üîÑ Converting from agorot: ${price} ‚Üí ‚Ç™${(price/100).toFixed(2)}`);
                                    price = price / 100;
                                }
                                console.log(`‚úÖ Globes: ‚Ç™${price.toFixed(2)}`);
                                return price;
                            }
                        }
                    }
                    
                    console.log(`‚ö†Ô∏è No valid price found in Globes HTML`);
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è Globes failed: ${e.message}`);
            }
            
            // Strategy 4: Try Yahoo with .TA suffix
            try {
                console.log(`üìä Strategy 4: Yahoo Finance .TA...`);
                let yahooPrice = await fetchYahooChart(`${securityNumber}.TA`);
                if (yahooPrice && yahooPrice > 0) {
                    if (yahooPrice > 100) {
                        console.log(`üîÑ Converting from agorot: ${yahooPrice} ‚Üí ‚Ç™${(yahooPrice/100).toFixed(2)}`);
                        yahooPrice = yahooPrice / 100;
                    }
                    console.log(`‚úÖ Yahoo .TA: ‚Ç™${yahooPrice.toFixed(2)}`);
                    return yahooPrice;
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è Yahoo .TA failed: ${e.message}`);
            }
            
            // Strategy 5: Try alternative Yahoo formats
            try {
                console.log(`üìä Strategy 5: Alternative Yahoo formats...`);
                const formats = [
                    `TLV:${securityNumber}`,
                    `TASE:${securityNumber}`,
                    `${securityNumber}.TASE`
                ];
                
                for (const format of formats) {
                    try {
                        let price = await fetchYahooChart(format);
                        if (price && price > 0) {
                            if (price > 100) {
                                price = price / 100;
                            }
                            console.log(`‚úÖ Yahoo ${format}: ‚Ç™${price.toFixed(2)}`);
                            return price;
                        }
                    } catch (e) {
                        // Silent - try next
                    }
                }
            } catch (e) {
                console.log(`‚ö†Ô∏è Alternative Yahoo formats failed`);
            }
            
            console.log(`‚ùå All strategies failed for ${securityNumber}`);
            throw new Error(`üáÆüá± ◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ß◊ë◊ú ◊û◊ó◊ô◊® ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊¢◊ë◊ï◊® ${securityNumber}. ◊ú◊ó◊• "üí∞ ◊û◊ó◊ô◊®" ◊ú◊¢◊ì◊õ◊ü ◊ô◊ì◊†◊ô◊™.`);
        }
        
        function isIsraeliSecurity(symbol) {
            // Israeli security numbers are 7 digits
            return /^\d{7}$/.test(symbol);
        }

        // ===========================================
        // ENHANCED API - WITH MULTIPLE FALLBACKS
        // ===========================================
        
        async function fetchStockPrice(symbol) {
            console.log(`üîç Fetching price for: ${symbol}`);
            
            // First, check if this is an Israeli security
            if (isIsraeliSecurity(symbol)) {
                console.log('üáÆüá± Detected Israeli security number, trying TASE first...');
                try {
                    const price = await fetchTASEPrice(symbol);
                    return price;
                } catch (e) {
                    console.log('‚ö†Ô∏è TASE fetch failed, will try alternatives if available');
                }
            }
            
            // ◊†◊ô◊°◊ï◊ô 3 ◊©◊ô◊ò◊ï◊™ ◊©◊ï◊†◊ï◊™
            const methods = [
                () => fetchYahooChart(symbol),
                () => fetchYahooQuote(symbol),
                () => fetchYahooV10(symbol)
            ];
            
            // ◊†◊ô◊°◊ô◊ï◊ü ◊¢◊ù ◊î◊°◊ô◊û◊ï◊ú ◊î◊û◊ß◊ï◊®◊ô
            for (const method of methods) {
                try {
                    const price = await method();
                    if (price && price > 0) {
                        console.log(`‚úÖ Success: ${price}`);
                        return price;
                    }
                } catch (e) {
                    console.log(`‚ùå Method failed: ${e.message}`);
                }
            }
            
            // ◊†◊ô◊°◊ô◊ï◊ü ◊¢◊ù ◊°◊ô◊û◊ï◊ú◊ô◊ù ◊ó◊ú◊ï◊§◊ô◊ô◊ù
            const alternatives = getAlternativeSymbols(symbol);
            for (const alt of alternatives) {
                console.log(`üîÑ Trying alternative: ${alt}`);
                for (const method of methods) {
                    try {
                        const price = await method.call(null, alt);
                        if (price && price > 0) {
                            console.log(`‚úÖ Success with alternative: ${price}`);
                            return price;
                        }
                    } catch (e) {
                        // ◊©◊ß◊ò, ◊û◊û◊©◊ô◊õ◊ô◊ù ◊î◊ú◊ê◊î
                    }
                }
            }
            
            throw new Error(`Could not fetch price for ${symbol}`);
        }
        
        async function fetchYahooChart(symbol) {
            // Using CORS proxy to bypass CORS restrictions
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
        }
        
        // ‚úÖ ◊§◊ï◊†◊ß◊¶◊ô◊î ◊ó◊ì◊©◊î: ◊ó◊ô◊©◊ï◊ë ◊™◊©◊ï◊ê◊™ ◊ê◊ô◊†◊ì◊ß◊° "◊ï◊ô◊®◊ò◊ï◊ê◊ú◊ô◊™" - ◊õ◊ê◊ô◊ú◊ï ◊î◊©◊ß◊¢◊™ ◊ë◊ê◊ô◊†◊ì◊ß◊° ◊ë◊ê◊ï◊™◊ù ◊™◊ê◊®◊ô◊õ◊ô◊ù
        // ◊í◊ô◊©◊™ MWR: ◊ú◊õ◊ú ◊î◊§◊ß◊ì◊î ◊û◊ó◊©◊ë ◊ê◊™ ◊î◊™◊©◊ï◊ê◊î ◊û◊ê◊ñ ◊ï◊¢◊ì ◊î◊ô◊ï◊ù, ◊ï◊û◊©◊ß◊ú◊ú ◊ú◊§◊ô ◊í◊ï◊ì◊ú ◊î◊î◊§◊ß◊ì◊î
        async function calculateVirtualIndexReturn(symbol, deposits) {
            try {
                if (!deposits || deposits.length === 0) {
                    console.log(`‚ö†Ô∏è No deposits for virtual ${symbol} calculation`);
                    return null;
                }
                
                // ◊û◊¶◊ê ◊™◊ê◊®◊ô◊ö ◊î◊§◊ß◊ì◊î ◊®◊ê◊©◊ï◊ü
                const sortedDeposits = [...deposits].sort((a, b) => new Date(a.date) - new Date(b.date));
                const firstDepositDate = new Date(sortedDeposits[0].date);
                
                // ◊©◊ú◊ï◊£ ◊ê◊™ ◊õ◊ú ◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î ◊©◊ú ◊î◊ê◊ô◊†◊ì◊ß◊° ◊û◊î◊î◊§◊ß◊ì◊î ◊î◊®◊ê◊©◊ï◊†◊î
                const start = Math.floor(firstDepositDate.getTime() / 1000);
                const end = Math.floor(Date.now() / 1000);
                
                const proxies = [
                    `https://api.allorigins.win/raw?url=`,
                    `https://corsproxy.io/?`
                ];
                
                let priceHistory = null;
                let timestamps = null;
                
                for (const proxy of proxies) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${start}&period2=${end}&interval=1d`;
                        const response = await fetch(proxy + encodeURIComponent(url), { timeout: 8000 });
                        
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        const result = data.chart?.result?.[0];
                        
                        if (!result) continue;
                        
                        priceHistory = result.indicators?.quote?.[0]?.close;
                        timestamps = result.timestamp;
                        
                        if (priceHistory && timestamps && priceHistory.length > 0) {
                            console.log(`‚úÖ Fetched ${priceHistory.length} days of ${symbol} history`);
                            break;
                        }
                    } catch (e) {
                        console.log(`Failed to fetch ${symbol} history from ${proxy}:`, e.message);
                    }
                }
                
                if (!priceHistory || !timestamps) {
                    console.log(`‚ùå Could not fetch ${symbol} history`);
                    return null;
                }
                
                // ◊§◊ï◊†◊ß◊¶◊ô◊ô◊™ ◊¢◊ñ◊®: ◊û◊¶◊ê ◊û◊ó◊ô◊® ◊ú◊™◊ê◊®◊ô◊ö ◊û◊°◊ï◊ô◊ù (◊ê◊ï ◊î◊õ◊ô ◊ß◊®◊ï◊ë)
                function getPriceForDate(targetDate) {
                    const targetTime = new Date(targetDate).getTime() / 1000;
                    
                    // ◊û◊¶◊ê ◊ê◊™ ◊î◊ê◊ô◊†◊ì◊ß◊° ◊î◊õ◊ô ◊ß◊®◊ï◊ë
                    let closestIdx = 0;
                    let minDiff = Math.abs(timestamps[0] - targetTime);
                    
                    for (let i = 1; i < timestamps.length; i++) {
                        const diff = Math.abs(timestamps[i] - targetTime);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestIdx = i;
                        }
                    }
                    
                    // ◊û◊¶◊ê ◊û◊ó◊ô◊® ◊™◊ß◊ô◊ü (◊ú◊ê null)
                    let price = priceHistory[closestIdx];
                    if (price === null || price <= 0) {
                        // ◊ó◊§◊© ◊ß◊ì◊ô◊û◊î ◊ï◊ê◊ó◊ï◊®◊î
                        for (let offset = 1; offset < 10; offset++) {
                            if (closestIdx + offset < priceHistory.length && priceHistory[closestIdx + offset] > 0) {
                                price = priceHistory[closestIdx + offset];
                                break;
                            }
                            if (closestIdx - offset >= 0 && priceHistory[closestIdx - offset] > 0) {
                                price = priceHistory[closestIdx - offset];
                                break;
                            }
                        }
                    }
                    
                    return price;
                }
                
                // ◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô (◊ê◊ó◊®◊ï◊ü ◊™◊ß◊ô◊ü)
                const validPrices = priceHistory.filter(p => p !== null && p > 0);
                const currentPrice = validPrices[validPrices.length - 1];
                
                // ◊í◊ô◊©◊™ MWR: ◊ú◊õ◊ú ◊î◊§◊ß◊ì◊î, ◊ó◊©◊ë ◊ê◊™ ◊î◊™◊©◊ï◊ê◊î ◊û◊ê◊ñ ◊ï◊¢◊ì ◊î◊ô◊ï◊ù
                // ◊ï◊©◊ß◊ú◊ú ◊ú◊§◊ô ◊í◊ï◊ì◊ú ◊î◊î◊§◊ß◊ì◊î
                let weightedReturnSum = 0;
                let totalWeight = 0;
                
                for (const deposit of sortedDeposits) {
                    const priceAtDeposit = getPriceForDate(deposit.date);
                    
                    if (priceAtDeposit && priceAtDeposit > 0) {
                        // ◊™◊©◊ï◊ê◊™ ◊î◊ê◊ô◊†◊ì◊ß◊° ◊û◊ô◊ï◊ù ◊î◊î◊§◊ß◊ì◊î ◊ï◊¢◊ì ◊î◊ô◊ï◊ù
                        const returnSinceDeposit = (currentPrice - priceAtDeposit) / priceAtDeposit;
                        
                        // ◊û◊©◊ß◊ú = ◊°◊õ◊ï◊ù ◊î◊î◊§◊ß◊ì◊î
                        weightedReturnSum += returnSinceDeposit * deposit.amount;
                        totalWeight += deposit.amount;
                        
                        console.log(`üìä ${symbol} @ ${new Date(deposit.date).toLocaleDateString('he-IL')}: $${priceAtDeposit.toFixed(2)} ‚Üí $${currentPrice.toFixed(2)} = ${(returnSinceDeposit * 100).toFixed(2)}% (weight: ‚Ç™${deposit.amount})`);
                    }
                }
                
                // ◊™◊©◊ï◊ê◊î ◊û◊©◊ï◊ß◊ú◊ú◊™
                const weightedReturn = totalWeight > 0 ? (weightedReturnSum / totalWeight) * 100 : 0;
                
                console.log(`‚úÖ Virtual ${symbol} MWR: ${weightedReturn.toFixed(2)}% (based on ${sortedDeposits.length} deposits)`);
                
                return weightedReturn;
                
            } catch (error) {
                console.error(`‚ùå calculateVirtualIndexReturn failed for ${symbol}:`, error);
                return null;
            }
        }
        
        // ‚úÖ ◊§◊ï◊†◊ß◊¶◊ô◊î ◊ó◊ì◊©◊î: ◊©◊ú◊ô◊§◊™ ◊†◊™◊ï◊†◊ô◊ù ◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊ù
        async function fetchHistoricalReturn(symbol, startDate) {
            try {
                const start = Math.floor(new Date(startDate).getTime() / 1000);
                const end = Math.floor(Date.now() / 1000);
                
                const proxies = [
                    `https://api.allorigins.win/raw?url=`,
                    `https://corsproxy.io/?`
                ];
                
                for (const proxy of proxies) {
                    try {
                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${start}&period2=${end}&interval=1d`;
                        const response = await fetch(proxy + encodeURIComponent(url), { timeout: 5000 });
                        
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        const quotes = data.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
                        
                        if (!quotes || quotes.length < 2) continue;
                        
                        // ◊û◊ó◊ô◊® ◊®◊ê◊©◊ï◊ü ◊ï◊ê◊ó◊®◊ï◊ü (◊û◊°◊†◊ü null values)
                        const validPrices = quotes.filter(p => p !== null && p > 0);
                        if (validPrices.length < 2) continue;
                        
                        const firstPrice = validPrices[0];
                        const lastPrice = validPrices[validPrices.length - 1];
                        
                        // ◊ó◊ô◊©◊ï◊ë ◊™◊©◊ï◊ê◊î
                        const returnPct = ((lastPrice - firstPrice) / firstPrice) * 100;
                        
                        console.log(`‚úÖ ${symbol}: ${firstPrice.toFixed(2)} ‚Üí ${lastPrice.toFixed(2)} = ${returnPct.toFixed(2)}%`);
                        return returnPct;
                        
                    } catch (e) {
                        console.log(`Failed to fetch ${symbol} from ${proxy}:`, e.message);
                    }
                }
                
                throw new Error(`Could not fetch historical data for ${symbol}`);
            } catch (error) {
                console.error(`fetchHistoricalReturn failed for ${symbol}:`, error);
                return null;
            }
        }
        
        // ‚úÖ ◊§◊ï◊†◊ß◊¶◊ô◊î: ◊û◊¶◊ô◊ê◊™ ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î ◊®◊ê◊©◊ï◊ü
        function getFirstPurchaseDate() {
            let firstDate = new Date();
            
            // ◊ë◊ì◊ï◊ß ◊û◊†◊ô◊ï◊™
            if (portfolio.holdings && portfolio.holdings.length > 0) {
                portfolio.holdings.forEach(h => {
                    if (h.purchaseDate) {
                        const date = new Date(h.purchaseDate);
                        if (date < firstDate) firstDate = date;
                    }
                });
            }
            
            // ◊ë◊ì◊ï◊ß ◊ê◊í"◊ó
            if (portfolio.bonds && portfolio.bonds.length > 0) {
                portfolio.bonds.forEach(b => {
                    if (b.purchaseDate) {
                        const date = new Date(b.purchaseDate);
                        if (date < firstDate) firstDate = date;
                    }
                });
            }
            
            // ◊ë◊ì◊ï◊ß ◊î◊§◊ß◊ì◊ï◊™ (fallback)
            if (portfolio.deposits && portfolio.deposits.length > 0) {
                portfolio.deposits.forEach(d => {
                    const date = new Date(d.date);
                    if (date < firstDate) firstDate = date;
                });
            }
            
            return firstDate;
        }
        
        async function fetchYahooQuote(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteResponse?.result?.[0]?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooV10(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteSummary?.result?.[0]?.price?.regularMarketPrice?.raw;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        function getAlternativeSymbols(symbol) {
            const alternatives = [];
            if (symbol.endsWith('.L')) {
                alternatives.push(symbol.replace('.L', '.AS'));
            }
            if (symbol.endsWith('.AS')) {
                alternatives.push(symbol.replace('.AS', '.L'));
            }
            if (symbol.endsWith('.DE')) {
                alternatives.push(symbol.replace('.DE', '.AS'));
            }
            if (symbol.includes('.')) {
                alternatives.push(symbol.split('.')[0]);
            }
            return alternatives;
        }
        
        // ===========================================
        // FIX EXISTING DATA
        // ===========================================
        
        function fixGroupIds() {
            console.log('üîß Starting to fix groupIds...');
            console.log('üìä Holdings before fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            let fixedCount = 0;
            
            portfolio.holdings.forEach(holding => {
                const originalGroupId = holding.groupId;
                
                // If groupId is missing, undefined, null, or NaN
                if (!holding.groupId || isNaN(parseInt(holding.groupId))) {
                    console.log(`‚ö†Ô∏è ${holding.symbol}: Invalid groupId (${holding.groupId}), setting to 1`);
                    holding.groupId = 1;
                    fixedCount++;
                } else {
                    // Parse to ensure it's a number
                    const parsed = parseInt(holding.groupId);
                    if (parsed !== holding.groupId) {
                        console.log(`üîß ${holding.symbol}: Converting groupId from ${holding.groupId} (${typeof holding.groupId}) to ${parsed}`);
                        holding.groupId = parsed;
                        fixedCount++;
                    }
                }
            });
            
            console.log('üìä Holdings after fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            // Save the fixed data
            saveData();
            
            // Update displays
            updateOverview();
            renderHoldingsList();
            renderGroupsList();
            
            if (fixedCount > 0) {
                notify(`‚úÖ ◊™◊ï◊ß◊†◊ï ${fixedCount} ◊û◊†◊ô◊ï◊™. ◊®◊¢◊†◊ü ◊ê◊™ ◊î◊ì◊£ ◊ê◊ù ◊¢◊ì◊ô◊ô◊ü ◊ô◊© ◊ë◊¢◊ô◊ï◊™.`);
            } else {
                notify(`‚ÑπÔ∏è ◊õ◊ú ◊î◊û◊†◊ô◊ï◊™ ◊õ◊ë◊® ◊™◊ß◊ô◊†◊ï◊™`);
            }
            
            console.log(`‚úÖ Fixed ${fixedCount} holdings`);
        }
        
        // ===========================================
        // REFRESH PRICES
        // ===========================================
        
        async function refreshPrices() {
            const notif = document.getElementById('notification');
            notif.textContent = 'üîÑ ◊û◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù... 0/' + portfolio.holdings.length;
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            const errors = [];
            const manualUpdateNeeded = [];
            
            for (let i = 0; i < portfolio.holdings.length; i++) {
                const holding = portfolio.holdings[i];
                
                // üîí Skip manually updated prices!
                if (holding.isManualPrice) {
                    console.log(`üîí Skipping ${holding.symbol} - manual price protected`);
                    skippedCount++;
                    continue;
                }
                
                // Update progress
                notif.textContent = `üîÑ ◊û◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù... ${i + 1}/${portfolio.holdings.length} (${holding.symbol})`;
                
                try {
                    let price = null;
                    
                    // Strategy: Try Israeli TASE first if applicable, then altTicker, then main symbol
                    if (isIsraeliSecurity(holding.symbol)) {
                        // Try TASE for Israeli securities
                        try {
                            price = await fetchStockPrice(holding.symbol);
                            console.log(`‚úÖ ${holding.symbol}: ‚Ç™${price} (from TASE)`);
                        } catch (e) {
                            console.log(`‚ö†Ô∏è TASE failed for ${holding.symbol}: ${e.message}`);
                            // If TASE fails and there's an alternative ticker, try it
                            if (holding.altTicker) {
                                try {
                                    price = await fetchStockPrice(holding.altTicker);
                                    console.log(`‚úÖ ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${holding.altTicker})`);
                                } catch (e2) {
                                    console.log(`‚ö†Ô∏è Alt ticker also failed for ${holding.symbol}`);
                                    manualUpdateNeeded.push(holding.symbol);
                                    throw new Error('◊¢◊ì◊õ◊ü ◊ô◊ì◊†◊ô◊™');
                                }
                            } else {
                                manualUpdateNeeded.push(holding.symbol);
                                throw e; // Re-throw if no alternative
                            }
                        }
                    } else {
                        // For non-Israeli securities, use altTicker if available, otherwise main symbol
                        const tickerToUse = holding.altTicker || holding.symbol;
                        price = await fetchStockPrice(tickerToUse);
                        console.log(`‚úÖ ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${tickerToUse})`);
                    }
                    
                    holding.currentPrice = price;
                    holding.lastUpdate = new Date().toISOString();
                    // Clear manual flag if automatic update succeeds
                    delete holding.isManualPrice;
                    successCount++;
                } catch (error) {
                    console.error(`‚ùå Failed: ${holding.symbol}${holding.altTicker ? ` (alt: ${holding.altTicker})` : ''}`, error);
                    errorCount++;
                    errors.push(holding.symbol);
                }
                
                // ◊î◊û◊™◊†◊î ◊ß◊¶◊®◊î ◊ë◊ô◊ü ◊ë◊ß◊©◊ï◊™
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            updateOverview();
            renderHoldingsList();
            
            // Hide loading notification
            notif.classList.remove('show');
            
            // Show final result
            let msg = '';
            if (skippedCount > 0) {
                msg = `üîí ${skippedCount} ◊û◊†◊ô◊ï◊™ ◊ì◊ï◊ú◊í◊ï (◊û◊ó◊ô◊® ◊ô◊ì◊†◊ô ◊û◊ï◊í◊ü)\n`;
            }
            
            if (errorCount === 0) {
                notify(`‚úÖ ${successCount} ◊û◊ó◊ô◊®◊ô◊ù ◊¢◊ï◊ì◊õ◊†◊ï ◊ë◊î◊¶◊ú◊ó◊î!\n${msg}`);
            } else if (successCount === 0 && skippedCount === 0) {
                notify(`‚ùå ◊õ◊ú ◊î◊†◊ô◊°◊ô◊ï◊†◊ï◊™ ◊†◊õ◊©◊ú◊ï. ◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊ó◊ô◊ë◊ï◊® ◊ú◊ê◊ô◊†◊ò◊®◊†◊ò`, 'error');
            } else {
                msg += `‚ö†Ô∏è ${successCount} ◊î◊¶◊ú◊ô◊ó◊ï, ${errorCount} ◊†◊õ◊©◊ú◊ï`;
                if (manualUpdateNeeded.length > 0) {
                    msg += `\n\nüáÆüá± ◊†◊ô◊ô◊®◊ï◊™ ◊ô◊©◊®◊ê◊ú◊ô◊ô◊ù ◊©◊ì◊ï◊®◊©◊ô◊ù ◊¢◊ì◊õ◊ï◊ü ◊ô◊ì◊†◊ô:\n${manualUpdateNeeded.join(', ')}\n\n◊ú◊ó◊• ◊¢◊ú ◊õ◊§◊™◊ï◊® "üí∞ ◊û◊ó◊ô◊®" ◊ú◊ô◊ì ◊î◊û◊†◊ô◊î ◊ú◊¢◊ì◊õ◊ü ◊ô◊ì◊†◊ô◊™`;
                }
                notify(msg, 'warning');
            }
        }

        // ===========================================
        // INVESTMENT CALCULATOR
        // ===========================================
        
        function calculateInvestment() {
            console.log('üéØ calculateInvestment STARTED!');
            console.log('üìã Function exists:', typeof calculateInvestment);
            console.log('ü™ü Window function exists:', typeof window.calculateInvestment);
            
            const inputElement = document.getElementById('invest-amount');
            console.log('üì• Input element:', inputElement);
            console.log('üí∞ Input value:', inputElement ? inputElement.value : 'ELEMENT NOT FOUND');
            
            const amount = parseFloat(document.getElementById('invest-amount').value);
            console.log('üí∏ Parsed amount:', amount);
            
            if (!amount || amount <= 0) {
                console.log('‚ùå Amount validation failed');
                notify('‚ùå ◊î◊ñ◊ü ◊°◊õ◊ï◊ù ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            console.log('üìÇ Portfolio object:', portfolio);
            console.log('üë• Portfolio groups:', portfolio.groups);
            console.log('üìä Portfolio holdings:', portfolio.holdings);
            
            // Check if getTotalValueILS exists
            console.log('üí∞ getTotalValueILS function exists:', typeof getTotalValueILS);
            
            let currentTotalValue;
            try {
                currentTotalValue = getTotalValueILS();
                console.log('üí∞ Current total value:', currentTotalValue);
            } catch (e) {
                console.error('üí• Error in getTotalValueILS:', e);
                return;
            }
            
            // ◊ó◊ô◊©◊ï◊ë ◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô (◊ú◊§◊ô ◊û◊ó◊ô◊®◊ô◊ù ◊†◊ï◊õ◊ó◊ô◊ô◊ù!)
            // const currentTotalValue = getTotalValueILS();
            
            // Check if convertToILS exists
            console.log('üí± convertToILS function exists:', typeof convertToILS);
            
            // ◊©◊ï◊ï◊ô ◊ê◊ó◊®◊ô ◊î◊î◊©◊ß◊¢◊î ◊î◊ó◊ì◊©◊î
            const futureTotal = currentTotalValue + amount;
            
            console.log('üí∞ Current value:', currentTotalValue);
            console.log('üí∞ Investment:', amount);
            console.log('üí∞ Future total:', futureTotal);
            
            // ◊ó◊ô◊©◊ï◊ë ◊û◊î ◊õ◊ú ◊ß◊ë◊ï◊¶◊î ◊¶◊®◊ô◊õ◊î ◊ú◊î◊ô◊ï◊™ ◊ê◊ó◊®◊ô ◊î◊î◊©◊ß◊¢◊î
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                
                // ◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô ◊©◊ú ◊î◊ß◊ë◊ï◊¶◊î (◊ú◊§◊ô currentPrice!)
                const currentValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                // ◊û◊î ◊î◊ß◊ë◊ï◊¶◊î ◊¶◊®◊ô◊õ◊î ◊ú◊î◊ô◊ï◊™ ◊ê◊ó◊®◊ô ◊î◊î◊©◊ß◊¢◊î
                const targetValue = futureTotal * (group.target / 100);
                
                // ◊õ◊û◊î ◊ó◊°◊® ◊ú◊ß◊ë◊ï◊¶◊î
                const needed = targetValue - currentValue;
                
                console.log(`üìä ${group.name}:`);
                console.log(`  Current: ‚Ç™${Math.round(currentValue)}`);
                console.log(`  Target: ‚Ç™${Math.round(targetValue)} (${group.target}%)`);
                console.log(`  Needed: ‚Ç™${Math.round(needed)}`);
                
                return {
                    group,
                    currentValue,
                    targetValue,
                    needed,
                    holdings: groupHoldings
                };
            });
            
            // ◊ó◊ô◊©◊ï◊ë ◊°◊ö ◊õ◊ú ◊î◊¶◊®◊õ◊ô◊ù ◊î◊ó◊ô◊ï◊ë◊ô◊ô◊ù
            const totalNeeded = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.needed), 0);
            
            console.log('üìä Total needed (positive only):', totalNeeded);
            
            // ◊ó◊ú◊ï◊ß◊™ ◊î◊õ◊°◊£
            const allocations = groupsStatus.map(status => {
                let allocatedAmount = 0;
                
                if (totalNeeded > 0) {
                    if (status.needed > 0) {
                        // ◊ê◊ù ◊°◊ö ◊î◊¶◊®◊õ◊ô◊ù ◊í◊ì◊ï◊ú ◊û◊î◊°◊õ◊ï◊ù ◊©◊ô◊©, ◊ó◊ú◊ß ◊§◊®◊ï◊§◊ï◊®◊¶◊ô◊ï◊†◊ú◊ô◊™
                        if (totalNeeded > amount) {
                            allocatedAmount = amount * (status.needed / totalNeeded);
                        } else {
                            // ◊ô◊© ◊û◊°◊§◊ô◊ß ◊õ◊°◊£ ◊ú◊õ◊ï◊ú◊ù, ◊™◊ü ◊ú◊ß◊ë◊ï◊¶◊î ◊ë◊ì◊ô◊ï◊ß ◊û◊î ◊©◊î◊ô◊ê ◊¶◊®◊ô◊õ◊î
                            allocatedAmount = status.needed;
                        }
                    }
                } else {
                    // ◊ê◊ù ◊ê◊ô◊ü ◊¶◊®◊õ◊ô◊ù (◊õ◊ï◊ú◊ù ◊û◊ú◊ê◊ô◊ù/◊û◊¢◊ú), ◊ó◊ú◊ß ◊©◊ï◊ï◊î ◊ë◊©◊ï◊ï◊î
                    allocatedAmount = amount / groupsStatus.length;
                }
                
                // ◊ó◊ú◊ï◊ß◊î ◊ë◊™◊ï◊ö ◊î◊ß◊ë◊ï◊¶◊î - ◊ú◊§◊ô ◊ô◊¢◊ì◊ô ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊ê◊ù ◊ß◊ô◊ô◊û◊ô◊ù
                const positionTargets = status.group.positionTargets || {};
                const hasAnyTargets = Object.keys(positionTargets).length > 0;
                
                // ◊ó◊©◊ë ◊©◊ï◊ï◊ô ◊¢◊™◊ô◊ì◊ô ◊©◊ú ◊î◊ß◊ë◊ï◊¶◊î (◊ê◊ó◊®◊ô ◊î◊î◊©◊ß◊¢◊î)
                const futureGroupValue = status.currentValue + allocatedAmount;
                
                // ◊ó◊©◊ë ◊î◊ß◊¶◊ê◊î ◊ú◊õ◊ú ◊§◊ï◊ñ◊ô◊¶◊ô◊î
                const holdingAllocations = [];
                
                if (hasAnyTargets) {
                    // ◊ô◊© ◊ô◊¢◊ì◊ô◊ù - ◊ó◊©◊ë ◊§◊¢◊® ◊û◊î◊ô◊¢◊ì ◊ú◊õ◊ú ◊§◊ï◊ñ◊ô◊¶◊ô◊î
                    const positionStatus = status.holdings.map(h => {
                        const value = h.shares * (h.currentPrice || h.costBasis);
                        const currentValueILS = convertToILS(value, h.currency);
                        const target = positionTargets[h.symbol];
                        
                        if (target !== undefined) {
                            // ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊¢◊ù ◊ô◊¢◊ì - ◊ó◊©◊ë ◊õ◊û◊î ◊¶◊®◊ô◊õ◊î ◊ú◊î◊ô◊ï◊™ ◊©◊ï◊ï◊î
                            const targetValue = futureGroupValue * (target / 100);
                            const needed = targetValue - currentValueILS;
                            return { 
                                symbol: h.symbol, 
                                currentValue: currentValueILS,
                                targetValue,
                                needed: Math.max(0, needed),  // ◊®◊ß ◊ó◊ô◊ï◊ë◊ô
                                hasTarget: true, 
                                target 
                            };
                        } else {
                            // ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊ú◊ú◊ê ◊ô◊¢◊ì
                            return { 
                                symbol: h.symbol, 
                                currentValue: currentValueILS,
                                targetValue: null,
                                needed: 0, 
                                hasTarget: false, 
                                target: null 
                            };
                        }
                    });
                    
                    // ◊°◊õ◊ï◊ù ◊î◊¶◊®◊õ◊ô◊ù ◊©◊ú ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊¢◊ù ◊ô◊¢◊ì
                    const totalPositionNeeded = positionStatus.reduce((sum, p) => sum + p.needed, 0);
                    
                    // ◊õ◊û◊î ◊†◊©◊ê◊® ◊ú◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊ú◊ú◊ê ◊ô◊¢◊ì
                    const amountForTargeted = Math.min(totalPositionNeeded, allocatedAmount);
                    const amountForUntargeted = allocatedAmount - amountForTargeted;
                    const holdingsWithoutTargets = positionStatus.filter(p => !p.hasTarget);
                    
                    for (const pos of positionStatus) {
                        if (pos.hasTarget) {
                            // ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊¢◊ù ◊ô◊¢◊ì - ◊î◊ß◊¶◊î ◊ú◊§◊ô ◊î◊§◊¢◊®
                            let posAllocation = 0;
                            if (totalPositionNeeded > 0) {
                                if (totalPositionNeeded > allocatedAmount) {
                                    // ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊õ◊°◊£ - ◊ó◊ú◊ß ◊§◊®◊ï◊§◊ï◊®◊¶◊ô◊ï◊†◊ú◊ô◊™
                                    posAllocation = allocatedAmount * (pos.needed / totalPositionNeeded);
                                } else {
                                    // ◊ô◊© ◊û◊°◊§◊ô◊ß - ◊™◊ü ◊ë◊ì◊ô◊ï◊ß ◊û◊î ◊©◊¶◊®◊ô◊ö
                                    posAllocation = pos.needed;
                                }
                            }
                            holdingAllocations.push({
                                symbol: pos.symbol,
                                amount: posAllocation,
                                hasTarget: true,
                                target: pos.target
                            });
                        } else {
                            // ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊ú◊ú◊ê ◊ô◊¢◊ì - ◊ó◊ú◊ß ◊©◊ï◊ï◊î ◊û◊î◊©◊ê◊®
                            const perUntargeted = holdingsWithoutTargets.length > 0 
                                ? amountForUntargeted / holdingsWithoutTargets.length 
                                : 0;
                            holdingAllocations.push({
                                symbol: pos.symbol,
                                amount: perUntargeted,
                                hasTarget: false,
                                target: null
                            });
                        }
                    }
                } else {
                    // ◊ê◊ô◊ü ◊ô◊¢◊ì◊ô◊ù - ◊ó◊ú◊ß ◊©◊ï◊ï◊î ◊ë◊©◊ï◊ï◊î
                    const perHolding = status.holdings.length > 0 ? allocatedAmount / status.holdings.length : 0;
                    for (const h of status.holdings) {
                        holdingAllocations.push({
                            symbol: h.symbol,
                            amount: perHolding,
                            hasTarget: false,
                            target: null
                        });
                    }
                }
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: holdingAllocations
                };
            });
            
            // ◊î◊¶◊í◊™ ◊™◊ï◊¶◊ê◊ï◊™
            displayCalculatorResults(allocations, amount);
        }
        
        function displayCalculatorResults(allocations, totalAmount) {
            console.log('üé® displayCalculatorResults called!');
            console.log('üìä Allocations:', allocations);
            console.log('üí∞ Total amount:', totalAmount);
            
            const container = document.getElementById('calc-items');
            const resultsDiv = document.getElementById('calc-results');
            
            console.log('üì¶ Container element:', container);
            console.log('üìã Results div:', resultsDiv);
            
            if (!container) {
                console.error('‚ùå calc-items container not found!');
                return;
            }
            
            if (!resultsDiv) {
                console.error('‚ùå calc-results div not found!');
                return;
            }
            
            let html = '';
            let displayedTotal = 0;
            
            console.log('üîÑ Processing allocations...');
            
            allocations.forEach((alloc, index) => {
                console.log(`üìä Allocation ${index}:`, alloc);
                if (alloc.amount > 0) {
                    console.log(`‚úÖ Adding group: ${alloc.group} with amount: ${alloc.amount}`);
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">${alloc.group} - ‚Ç™${Math.round(alloc.amount).toLocaleString()}</div>`;
                    
                    alloc.holdings.forEach((holding, hIndex) => {
                        console.log(`  üìà Holding ${hIndex}:`, holding);
                        if (holding.amount > 0) {
                            console.log(`  ‚úÖ Adding holding: ${holding.symbol} with amount: ${holding.amount}`);
                            const targetBadge = holding.hasTarget 
                                ? `<span style="font-size: 0.75rem; color: var(--profit); margin-right: 5px;">(◊ô◊¢◊ì ${holding.target}%)</span>` 
                                : '';
                            html += `<div class="calc-item">`;
                            html += `<span class="calc-symbol">${holding.symbol} ${targetBadge}</span>`;
                            html += `<span class="calc-amount">‚Ç™${Math.round(holding.amount).toLocaleString()}</span>`;
                            html += `</div>`;
                            displayedTotal += holding.amount;
                        }
                    });
                    
                    html += `</div>`;
                } else {
                    console.log(`‚è≠Ô∏è Skipping group: ${alloc.group} (amount is ${alloc.amount})`);
                }
            });
            
            console.log('üèóÔ∏è Generated HTML:', html);
            console.log('üí∞ Displayed total:', displayedTotal);
            
            container.innerHTML = html;
            console.log('üìù HTML set to container');
            
            const totalElement = document.getElementById('calc-total');
            console.log('üè∑Ô∏è Total element:', totalElement);
            
            if (totalElement) {
                totalElement.textContent = `‚Ç™${Math.round(displayedTotal).toLocaleString()}`;
                console.log('üí∞ Total set to:', totalElement.textContent);
            } else {
                console.error('‚ùå calc-total element not found!');
            }
            
            resultsDiv.classList.add('active');
            console.log('üëÅÔ∏è Added "active" class to results div');
            console.log('üéâ displayCalculatorResults completed!');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = 'notification show';
            
            // Remove all type classes first
            notif.classList.remove('error', 'warning');
            
            if (type === 'error') notif.classList.add('error');
            if (type === 'warning') notif.classList.add('warning');
            
            // Don't auto-hide for loading messages
            if (type === 'loading') {
                notif.style.background = '#3b82f6';
                return; // Stay visible
            }
            
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        // Tab configuration - maps main tabs to their sub-tabs
        const TAB_CONFIG = {
            'overview': { subTabs: null },
            'portfolio': { 
                subTabs: [
                    { id: 'holdings', label: '◊û◊†◊ô◊ï◊™', icon: 'briefcase' },
                    { id: 'bonds', label: '◊ê◊í"◊ó', icon: 'file-text' },
                    { id: 'cashflow', label: '◊™◊ñ◊®◊ô◊ù', icon: 'dollar-sign' }
                ],
                default: 'holdings'
            },
            'performance': {
                subTabs: [
                    { id: 'charts', label: '◊í◊®◊§◊ô◊ù', icon: 'trending-up' },
                    { id: 'analysis', label: '◊†◊ô◊™◊ï◊ó', icon: 'microscope' }
                ],
                default: 'charts'
            },
            'planning': {
                subTabs: [
                    { id: 'calculator', label: '◊û◊ó◊©◊ë◊ï◊ü', icon: 'calculator' },
                    { id: 'groups', label: '◊ß◊ë◊ï◊¶◊ï◊™', icon: 'folder' }
                ],
                default: 'calculator'
            },
            'history': { subTabs: null },
            'settings': { subTabs: null }
        };
        
        // Track current state
        let currentMainTab = 'overview';
        let currentSubTab = null;
        
        function showTab(tabName, event) {
            const config = TAB_CONFIG[tabName];
            
            // Update sidebar nav items
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.classList.remove('active');
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    item.classList.add('active');
                }
            });
            
            // If this is a main tab with sub-tabs
            if (config && config.subTabs) {
                currentMainTab = tabName;
                currentSubTab = config.default;
                
                // Update main tab buttons (legacy)
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
                    const onclick = btn.getAttribute('onclick');
                    return onclick && onclick.includes(`'${tabName}'`);
                });
                if (mainTabBtn) mainTabBtn.classList.add('active');
                
                // Show sub-tabs bar
                renderSubTabs(config.subTabs, config.default);
                
                // Show the default sub-tab content
                showSubTabContent(config.default);
                
            } else if (TAB_CONFIG[tabName]) {
                // Simple tab without sub-tabs
                currentMainTab = tabName;
                currentSubTab = null;
                
                // Update main tab buttons (legacy)
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
                    const onclick = btn.getAttribute('onclick');
                    return onclick && onclick.includes(`'${tabName}'`);
                });
                if (mainTabBtn) mainTabBtn.classList.add('active');
                
                // Hide sub-tabs bar
                const subTabsContainer = document.getElementById('sub-tabs-container');
                if (subTabsContainer) subTabsContainer.style.display = 'none';
                
                // Hide all tab contents and show the requested one
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                const tabElement = document.getElementById(`tab-${tabName}`);
                if (tabElement) {
                    tabElement.classList.add('active');
                }
                
                // Run tab-specific functions
                runTabFunctions(tabName);
                
            } else {
                // This might be a sub-tab call directly
                showSubTab(tabName);
            }
        }
        
        function renderSubTabs(subTabs, activeId) {
            const container = document.getElementById('sub-tabs-container');
            if (!container) return;
            
            container.style.display = 'flex';
            container.innerHTML = subTabs.map(tab => `
                <button class="sub-tab-btn ${tab.id === activeId ? 'active' : ''}" 
                        onclick="showSubTab('${tab.id}')">
                    <i data-lucide="${tab.icon}"></i> ${tab.label}
                </button>
            `).join('');
            
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function showSubTab(subTabId) {
            currentSubTab = subTabId;
            
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.sub-tab-btn')).find(btn => {
                const onclick = btn.getAttribute('onclick');
                return onclick && onclick.includes(`'${subTabId}'`);
            });
            if (activeBtn) activeBtn.classList.add('active');
            
            // Show the sub-tab content
            showSubTabContent(subTabId);
        }
        
        function showSubTabContent(subTabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show the requested sub-tab content
            const tabElement = document.getElementById(`tab-${subTabId}`);
            if (tabElement) {
                tabElement.classList.add('active');
            } else {
                console.error('Sub-tab not found:', subTabId);
            }
            
            // Run tab-specific functions
            runTabFunctions(subTabId);
        }
        
        function runTabFunctions(tabName) {
            switch(tabName) {
                case 'overview':
                    updateOverview();
                    break;
                case 'holdings':
                    renderHoldingsList();
                    break;
                case 'bonds':
                    renderBondsList();
                    break;
                case 'cashflow':
                    if (typeof renderCashFlow === 'function') renderCashFlow();
                    break;
                case 'groups':
                    renderGroupsList();
                    break;
                case 'history':
                    renderAllTransactions();
                    break;
                case 'charts':
                    setTimeout(() => {
                        if (typeof createAdvancedCharts === 'function') {
                            createAdvancedCharts();
                        }
                    }, 100);
                    break;
                case 'analysis':
                    // Analysis tab functions if any
                    break;
                case 'calculator':
                    // Calculator doesn't need refresh
                    break;
                case 'capital':
                    renderCapitalMovements();
                    renderBondsCapitalMovements();
                    updateCapitalSummary();
                    break;
                case 'recommendations':
                    renderRecommendations();
                    break;
            }
        }
        
        // Expose tab functions globally for onclick handlers
        window.showTab = showTab;
        window.showSubTab = showSubTab;

        // Toggle Dark/Light Mode (Dark is default)
        function toggleTheme() {
            const html = document.documentElement;
            const isLight = html.getAttribute('data-theme') === 'light';
            
            if (isLight) {
                // Switch to dark
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                // Switch to light
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            
            // Update icon and text
            const themeIcon = document.getElementById('theme-icon');
            const themeBtn = document.querySelector('.theme-btn');
            if (themeIcon) {
                themeIcon.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            }
            if (themeBtn) {
                const textSpan = themeBtn.querySelector('span:last-child');
                if (textSpan) {
                    textSpan.textContent = isLight ? '◊û◊¶◊ë ◊ë◊î◊ô◊®' : '◊û◊¶◊ë ◊õ◊î◊î';
                }
            }
            
            // Recreate charts with new theme
            if (typeof createAdvancedCharts === 'function') {
                setTimeout(() => createAdvancedCharts(), 100);
            }
        }
        
        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.textContent = 'üåô';
                const themeBtn = document.querySelector('.theme-btn');
                if (themeBtn) {
                    const textSpan = themeBtn.querySelector('span:last-child');
                    if (textSpan) textSpan.textContent = '◊û◊¶◊ë ◊õ◊î◊î';
                }
            }
        }




        
        function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            if (currency === 'USD') return amount * portfolio.rates.USD;
            if (currency === 'EUR') return amount * portfolio.rates.EUR;
            return amount;
        }
        
        function getTotalValueILS() {
            return portfolio.holdings.reduce((sum, h) => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                return sum + convertToILS(value, h.currency);
            }, 0);
        }
        
        function getCurrencySymbol(currency) {
            const symbols = { ILS: '‚Ç™', USD: '$', EUR: '‚Ç¨' };
            return symbols[currency] || currency;
        }

        // ===========================================
        // TWR (TIME-WEIGHTED RETURN) HELPERS
        // ===========================================
        
        function getBondsValue() {
            return Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
        }
        
        // ===========================================
        // DATA MANAGEMENT - FIREBASE
        // ===========================================
        
        async function saveData() {
            if (!currentUser) {
                console.log('‚è≥ Waiting for authentication...');
                return;
            }
            
            try {
                const defaultGroups = [
                    { id: 1, name: '◊û◊ì◊ì◊ô◊ù ◊¢◊ï◊ú◊û◊ô◊ô◊ù', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '◊ê◊ß◊ò◊ô◊ë◊ô/◊°◊ô◊õ◊ï◊†◊ô', target: 10, color: '#ef4444' }
                ];
                
                // Validate all holdings have valid groupId
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings = portfolio.holdings.map(h => {
                        const groupId = parseInt(h.groupId);
                        if (isNaN(groupId) || groupId <= 0) {
                            console.warn(`‚ö†Ô∏è Invalid groupId for ${h.symbol}, setting to 1`);
                            return { ...h, groupId: 1 };
                        }
                        return h;
                    });
                }
                
                const dataToSave = {
                    holdings: portfolio.holdings || [],
                    groups: defaultGroups,
                    rates: portfolio.rates || {},
                    bonds: portfolio.bonds || [],
                    deposits: portfolio.deposits || [],
                    withdrawals: portfolio.withdrawals || [],
                    purchases: portfolio.purchases || [],
                    sales: portfolio.sales || [],
                    snapshots: portfolio.snapshots || [],
                    cash: portfolio.cash || { ILS: 0, USD: 0, EUR: 0 },
                    transactions: portfolio.transactions || [],
                    capitalMovements: portfolio.capitalMovements || [],
                    bondsCapitalMovements: portfolio.bondsCapitalMovements || [],
                    bondsSales: portfolio.bondsSales || [],
                    portfolioSnapshots: portfolio.portfolioSnapshots || [],
                    cashFlows: portfolio.cashFlows || [],
                    lastModified: new Date().toISOString()
                };
                
                // Save to Firebase
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                await setDoc(userDocRef, dataToSave);
                console.log('‚úÖ Data saved to Firebase');
                
                // Also save to localStorage as backup
                localStorage.setItem('portfolio', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                notify('‚ö†Ô∏è ◊©◊í◊ô◊ê◊î ◊ë◊©◊û◊ô◊®◊™ ◊†◊™◊ï◊†◊ô◊ù', 'error');
                
                // Fallback to localStorage
                try {
                    const dataToSave = {
                        holdings: portfolio.holdings || [],
                        groups: [
                            { id: 1, name: '◊û◊ì◊ì◊ô◊ù ◊¢◊ï◊ú◊û◊ô◊ô◊ù', target: 60, color: '#3b82f6' },
                            { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                            { id: 3, name: '◊ê◊ß◊ò◊ô◊ë◊ô/◊°◊ô◊õ◊ï◊†◊ô', target: 10, color: '#ef4444' }
                        ],
                        rates: portfolio.rates || {},
                        bonds: portfolio.bonds || [],
                        deposits: portfolio.deposits || [],
                        withdrawals: portfolio.withdrawals || [],
                        purchases: portfolio.purchases || [],
                        sales: portfolio.sales || [],
                        snapshots: portfolio.snapshots || [],
                        cash: portfolio.cash || { ILS: 0, USD: 0, EUR: 0 }
                    };
                    localStorage.setItem('portfolio', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error('‚ùå localStorage fallback failed:', e);
                }
            }
        }
        
        async function loadData() {
            if (!currentUser) {
                console.log('‚è≥ Waiting for authentication...');
                return false;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const loaded = docSnap.data();
                    
                    const defaultGroups = [
                        { id: 1, name: '◊û◊ì◊ì◊ô◊ù ◊¢◊ï◊ú◊û◊ô◊ô◊ù', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '◊ê◊ß◊ò◊ô◊ë◊ô/◊°◊ô◊õ◊ï◊†◊ô', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            return {
                                ...h,
                                groupId: validGroupId
                            };
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : { USD: 3.7, EUR: 4.1 },
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : [],
                        deposits: Array.isArray(loaded.deposits) ? loaded.deposits : [],
                        withdrawals: Array.isArray(loaded.withdrawals) ? loaded.withdrawals : [],
                        purchases: Array.isArray(loaded.purchases) ? loaded.purchases : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : [],
                        snapshots: Array.isArray(loaded.snapshots) ? loaded.snapshots : [],
                        cash: loaded.cash && typeof loaded.cash === 'object' ? loaded.cash : { ILS: 0, USD: 0, EUR: 0 },
                        transactions: Array.isArray(loaded.transactions) ? loaded.transactions : [],
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        bondsCapitalMovements: Array.isArray(loaded.bondsCapitalMovements) ? loaded.bondsCapitalMovements : [],
                        bondsSales: Array.isArray(loaded.bondsSales) ? loaded.bondsSales : [],
                        portfolioSnapshots: Array.isArray(loaded.portfolioSnapshots) ? loaded.portfolioSnapshots : [],
                        cashFlows: Array.isArray(loaded.cashFlows) ? loaded.cashFlows : []
                    };
                    
                    // Run migration
                    migrateOldData();
                    
                    console.log('‚úÖ Data loaded from Firebase');
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('portfolio', JSON.stringify(portfolio));
                    
                    return true;
                } else {
                    console.log('No Firebase data, trying localStorage...');
                    return loadFromLocalStorage();
                }
            } catch (error) {
                console.error('‚ùå Firebase load failed:', error);
                return loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('portfolio');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    const defaultGroups = [
                        { id: 1, name: '◊û◊ì◊ì◊ô◊ù ◊¢◊ï◊ú◊û◊ô◊ô◊ù', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: '◊ê◊ß◊ò◊ô◊ë◊ô/◊°◊ô◊õ◊ï◊†◊ô', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            return {
                                ...h,
                                groupId: validGroupId
                            };
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        bonds: Array.isArray(loaded.bonds) ? loaded.bonds : 
                               (typeof loaded.bonds === 'number' && loaded.bonds > 0) ? 
                               [{
                                   id: Date.now(),
                                   name: '◊ß◊®◊ü ◊ê◊í"◊ó (◊û◊†◊™◊ï◊†◊ô◊ù ◊ô◊©◊†◊ô◊ù)',
                                   units: 1,
                                   costBasis: loaded.bonds,
                                   currentPrice: loaded.bonds,
                                   lastUpdate: new Date().toISOString()
                               }] : portfolio.bonds || [],
                        // New structure
                        deposits: Array.isArray(loaded.deposits) ? loaded.deposits : [],
                        withdrawals: Array.isArray(loaded.withdrawals) ? loaded.withdrawals : [],
                        purchases: Array.isArray(loaded.purchases) ? loaded.purchases : [],
                        sales: Array.isArray(loaded.sales) ? loaded.sales : [],
                        snapshots: Array.isArray(loaded.snapshots) ? loaded.snapshots : [],
                        cash: loaded.cash && typeof loaded.cash === 'object' ? loaded.cash : { ILS: 0, USD: 0 },
                        // Old structure (for migration)
                        capitalMovements: Array.isArray(loaded.capitalMovements) ? loaded.capitalMovements : [],
                        bondsCapitalMovements: Array.isArray(loaded.bondsCapitalMovements) ? loaded.bondsCapitalMovements : [],
                        bondsSales: Array.isArray(loaded.bondsSales) ? loaded.bondsSales : [],
                        portfolioSnapshots: Array.isArray(loaded.portfolioSnapshots) ? loaded.portfolioSnapshots : []
                    };
                    
                    // Run migration
                    migrateOldData();
                    
                    console.log('‚úÖ Data loaded from localStorage');
                    console.log('üìä Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('‚ÑπÔ∏è No saved data, using defaults');
                    if (!Array.isArray(portfolio.holdings)) {
                        portfolio.holdings = [];
                    }
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                notify('‚ö†Ô∏è ◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊†◊™◊ï◊†◊ô◊ù', 'error');
                portfolio.holdings = [];
                return false;
            }
        }

        // ===========================================
        // HOLDINGS MANAGEMENT - FIXED
        // ===========================================
        
        function showAddHoldingForm() {
            editingHoldingId = null; // Reset editing mode
            document.getElementById('add-holding-form').style.display = 'block';
            updateGroupSelect();
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î ◊ó◊ì◊©◊î';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('add-holding-form').style.display = 'none';
            editingHoldingId = null;
            
            // Clear form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-shares').value = '';
            document.getElementById('new-cost').value = '';
            document.getElementById('new-alt-ticker').value = '';
            document.getElementById('new-purchase-date').value = '';  // ‚Üê ◊†◊ô◊ß◊ï◊ô ◊™◊ê◊®◊ô◊ö
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = '◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î ◊ó◊ì◊©◊î';
        }
        
        function updateGroupSelect() {
            const select = document.getElementById('new-group');
            if (!select) {
                console.error('‚ùå Group select element not found');
                return;
            }
            select.innerHTML = portfolio.groups.map(g => 
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        }
        
        function addHolding() {
            console.log('üîç Starting addHolding function...');
            console.log('üìç Step 1: Getting form elements');
            
            const symbolInput = document.getElementById('new-symbol');
            const sharesInput = document.getElementById('new-shares');
            const costInput = document.getElementById('new-cost');
            const currencySelect = document.getElementById('new-currency');
            const groupSelect = document.getElementById('new-group');
            
            // ◊ë◊ì◊ô◊ß◊î ◊©◊õ◊ú ◊î◊ê◊ú◊û◊†◊ò◊ô◊ù ◊ß◊ô◊ô◊û◊ô◊ù
            console.log('üìç Step 2: Checking if elements exist', {
                symbolInput: !!symbolInput,
                sharesInput: !!sharesInput,
                costInput: !!costInput,
                currencySelect: !!currencySelect,
                groupSelect: !!groupSelect
            });
            
            if (!symbolInput || !sharesInput || !costInput || !currencySelect || !groupSelect) {
                console.error('‚ùå One or more form elements not found');
                notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ò◊ï◊§◊° - ◊ê◊ú◊û◊†◊ò ◊ú◊ê ◊†◊û◊¶◊ê', 'error');
                return;
            }
            
            console.log('üìç Step 3: Reading form values');
            const symbol = symbolInput.value.trim().toUpperCase();
            const sharesStr = sharesInput.value.trim();
            const costStr = costInput.value.trim();
            const commissionInput = document.getElementById('new-commission');
            const commissionStr = commissionInput?.value.trim() || '0';
            const currency = currencySelect.value;
            const groupId = parseInt(groupSelect.value);
            const altTicker = document.getElementById('new-alt-ticker')?.value.trim().toUpperCase() || '';
            
            // ◊ß◊®◊ô◊ê◊™ ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î (◊ê◊ù ◊®◊ô◊ß - ◊™◊ê◊®◊ô◊ö ◊î◊ô◊ï◊ù)
            const purchaseDateInput = document.getElementById('new-purchase-date');
            let purchaseDate = purchaseDateInput?.value || new Date().toISOString().split('T')[0];
            
            // ◊î◊û◊®◊î ◊ú-ISO format ◊û◊ú◊ê
            purchaseDate = new Date(purchaseDate + 'T12:00:00.000Z').toISOString();
            
            console.log('üìã Form values:', { 
                symbol, 
                shares: sharesStr, 
                cost: costStr,
                commission: commissionStr,
                currency, 
                groupId,
                altTicker,
                purchaseDate,
                raw: {
                    symbolRaw: symbolInput.value,
                    sharesRaw: sharesInput.value,
                    costRaw: costInput.value
                }
            });
            
            // ◊ë◊ì◊ô◊ß◊™ ◊™◊ß◊ô◊†◊ï◊™ - ◊©◊ì◊ï◊™ ◊®◊ô◊ß◊ô◊ù
            console.log('üìç Step 4: Validating empty fields');
            if (!symbol || !sharesStr || !costStr) {
                console.error('‚ùå Empty fields detected:', { symbol, sharesStr, costStr });
                notify('‚ùå ◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™', 'error');
                return;
            }
            
            // ◊î◊û◊®◊î ◊ú◊û◊°◊§◊®◊ô◊ù
            console.log('üìç Step 5: Converting to numbers');
            const shares = parseFloat(sharesStr);
            const cost = parseFloat(costStr);
            const commission = parseFloat(commissionStr);
            
            console.log('üî¢ Parsed numbers:', { shares, cost, commission, isNaN_shares: isNaN(shares), isNaN_cost: isNaN(cost), isNaN_commission: isNaN(commission) });
            
            // ◊ë◊ì◊ô◊ß◊î ◊©◊î◊û◊®◊î ◊î◊¶◊ú◊ô◊ó◊î
            if (isNaN(shares) || isNaN(cost) || isNaN(commission)) {
                console.error('‚ùå NaN detected after parsing');
                notify('‚ùå ◊î◊õ◊û◊ï◊™, ◊î◊û◊ó◊ô◊® ◊ï◊î◊¢◊û◊ú◊î ◊ó◊ô◊ô◊ë◊ô◊ù ◊ú◊î◊ô◊ï◊™ ◊û◊°◊§◊®◊ô◊ù', 'error');
                return;
            }
            
            // ◊ë◊ì◊ô◊ß◊î ◊©◊î◊¢◊®◊õ◊ô◊ù ◊ó◊ô◊ï◊ë◊ô◊ô◊ù ◊ê◊ï ◊ê◊§◊° (◊¢◊û◊ú◊î ◊ô◊õ◊ï◊ú◊î ◊ú◊î◊ô◊ï◊™ 0)
            console.log('üìç Step 6: Validating positive numbers');
            if (shares <= 0 || cost <= 0 || commission < 0) {
                console.error('‚ùå Invalid numbers:', { shares, cost, commission });
                notify('‚ùå ◊î◊õ◊û◊ï◊™ ◊ï◊î◊û◊ó◊ô◊® ◊ó◊ô◊ô◊ë◊ô◊ù ◊ú◊î◊ô◊ï◊™ ◊í◊ì◊ï◊ú◊ô◊ù ◊û◊ê◊§◊°, ◊¢◊û◊ú◊î ◊ú◊ê ◊ô◊õ◊ï◊ú◊î ◊ú◊î◊ô◊ï◊™ ◊©◊ú◊ô◊ú◊ô◊™', 'error');
                return;
            }
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊¢◊ù ◊¢◊û◊ú◊î
            // ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊ú◊û◊†◊ô◊î = (◊õ◊û◊ï◊™ √ó ◊û◊ó◊ô◊® + ◊¢◊û◊ú◊î) / ◊õ◊û◊ï◊™
            const actualCost = (shares * cost + commission) / shares;
            console.log(`üí∞ Cost calculation: (${shares} √ó ${cost} + ${commission}) / ${shares} = ${actualCost.toFixed(4)}`);

            
            // ◊ë◊ì◊ô◊ß◊î ◊ê◊ù ◊ê◊†◊ó◊†◊ï ◊ë◊û◊¶◊ë ◊¢◊®◊ô◊õ◊î ◊ê◊ï ◊î◊ï◊°◊§◊î
            if (editingHoldingId !== null) {
                // ◊û◊¶◊ë ◊¢◊®◊ô◊õ◊î - ◊¢◊ì◊õ◊ü ◊î◊ó◊ñ◊ß◊î ◊ß◊ô◊ô◊û◊™
                console.log('üìç Step 7: Updating existing holding:', editingHoldingId);
                const holding = portfolio.holdings.find(h => h.id === editingHoldingId);
                if (holding) {
                    holding.symbol = symbol;
                    holding.shares = shares;
                    holding.costBasis = actualCost;  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                    holding.currency = currency;
                    holding.groupId = groupId;
                    holding.altTicker = altTicker;
                    holding.purchaseDate = purchaseDate;
                    holding.lastUpdate = new Date().toISOString();
                    console.log('‚úÖ Holding updated:', holding);
                }
            } else {
                // ◊û◊¶◊ë ◊î◊ï◊°◊§◊î - ◊¶◊ï◊® ◊î◊ó◊ñ◊ß◊î ◊ó◊ì◊©◊î
                console.log('üìç Step 7: Creating new holding object');
                
                // ◊ó◊ô◊©◊ï◊ë ◊°◊õ◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î (◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î!)
                const purchaseAmountInCurrency = shares * cost + commission;  // ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                const purchaseAmount = convertToILS(purchaseAmountInCurrency, currency);  // ◊ë◊©◊ß◊ú◊ô◊ù
                const availableCash = getImplicitCash('stocks');
                
                // ◊©◊ê◊ú◊î: ◊û◊ê◊ô◊§◊î ◊î◊õ◊°◊£?
                let fundingSource = 'cash'; // default
                
                if (availableCash < purchaseAmount) {
                    // ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü - ◊ó◊ô◊ô◊ë◊ô◊ù ◊î◊§◊ß◊ì◊î
                    const needDeposit = purchaseAmount - availableCash;
                    if (!confirm(`◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü ◊ë◊™◊ô◊ß (◊ñ◊û◊ô◊ü: ‚Ç™${Math.round(availableCash).toLocaleString()}).\n◊î◊ê◊ù ◊ú◊î◊§◊ß◊ô◊ì ‚Ç™${Math.round(needDeposit).toLocaleString()} ◊†◊ï◊°◊§◊ô◊ù?`)) {
                        notify('‚ùå ◊ë◊ï◊ò◊ú - ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü', 'error');
                        return;
                    }
                    fundingSource = 'deposit';
                } else if (availableCash > 0) {
                    // ◊ô◊© ◊û◊ñ◊ï◊û◊ü - ◊©◊ï◊ê◊ú◊ô◊ù
                    fundingSource = confirm(`◊ú◊û◊û◊ü ◊û◊î◊û◊ñ◊ï◊û◊ü ◊î◊ß◊ô◊ô◊ù ◊ë◊™◊ô◊ß (‚Ç™${Math.round(availableCash).toLocaleString()})?\n\n◊ú◊ó◊• ◊ê◊ô◊©◊ï◊® ◊ú◊û◊ñ◊ï◊û◊ü ◊ß◊ô◊ô◊ù, ◊ë◊ô◊ò◊ï◊ú ◊ú◊î◊§◊ß◊ì◊î ◊ó◊ì◊©◊î.`) ? 'cash' : 'deposit';
                } else {
                    // ◊ê◊ô◊ü ◊û◊ñ◊ï◊û◊ü ◊ë◊õ◊ú◊ú - ◊î◊§◊ß◊ì◊î
                    fundingSource = 'deposit';
                }
                
                // ◊©◊û◊ô◊®◊™ ◊©◊ï◊ï◊ô ◊î◊™◊ô◊ß ◊ú◊§◊ô ◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î (costBasis) ◊ú◊§◊†◊ô ◊î◊ï◊°◊§◊™ ◊î◊û◊†◊ô◊î ◊î◊ó◊ì◊©◊î
                const valueBeforeNewHolding = getTotalPortfolioValueAtCost();
                
                const newHolding = {
                    id: Date.now(),
                    symbol,
                    shares,
                    costBasis: actualCost,  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                    currentPrice: actualCost,  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                    currency,
                    groupId,
                    altTicker: altTicker || '',
                    purchaseDate: purchaseDate,  // ‚Üê ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î!
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('‚ûï Adding holding:', newHolding);
                portfolio.holdings.push(newHolding);
                
                // ◊ê◊™◊ó◊ï◊ú portfolio.cash
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                
                // ◊ê◊ù ◊¶◊®◊ô◊ö ◊î◊§◊ß◊ì◊î - ◊î◊ï◊°◊£ ◊ú◊û◊ñ◊ï◊û◊ü ◊ú◊§◊†◊ô ◊î◊ó◊ô◊°◊ï◊®!
                if (fundingSource === 'deposit') {
                    const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                    
                    // ◊î◊û◊® ◊ê◊™ ◊î◊î◊§◊ß◊ì◊î ◊ú◊û◊ò◊ë◊¢ ◊î◊û◊™◊ê◊ô◊ù
                    let depositInCurrency;
                    if (currency === 'ILS') {
                        depositInCurrency = depositAmount;
                    } else if (currency === 'USD') {
                        depositInCurrency = depositAmount / (portfolio.rates.USD || 3.7);
                    } else if (currency === 'EUR') {
                        depositInCurrency = depositAmount / (portfolio.rates.EUR || 4.0);
                    }
                    
                    // ◊î◊ï◊°◊£ ◊ê◊™ ◊î◊î◊§◊ß◊ì◊î ◊ú◊û◊ñ◊ï◊û◊ü
                    portfolio.cash[currency] = (portfolio.cash[currency] || 0) + depositInCurrency;
                    console.log(`üí∞ ◊î◊§◊ß◊ì◊î: ${depositInCurrency.toFixed(2)} ${currency} ◊î◊ï◊°◊£ ◊ú◊û◊ñ◊ï◊û◊ü`);
                    
                    const deposit = {
                        id: Date.now() + 1,
                        date: purchaseDate,  // ‚Üê ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î ◊ê◊û◊ô◊™◊ô!
                        amount: depositAmount,
                        currency: currency,
                        assetType: 'stocks',
                        note: `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${symbol}`
                    };
                    portfolio.deposits.push(deposit);
                }
                
                // ◊¢◊ì◊õ◊ü portfolio.cash - ◊î◊§◊ó◊™ ◊ê◊™ ◊°◊õ◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                portfolio.cash[currency] = (portfolio.cash[currency] || 0) - purchaseAmountInCurrency;
                console.log(`üí∞ ◊ß◊†◊ô◊ô◊î: ◊î◊ï◊§◊ó◊™ ${purchaseAmountInCurrency.toFixed(2)} ${currency} ◊û◊ô◊™◊®◊™ ◊î◊û◊ñ◊ï◊û◊ü`);
                console.log(`   ◊ô◊™◊®◊™ ${currency} ◊ó◊ì◊©◊î: ${portfolio.cash[currency].toFixed(2)}`);
                console.log(`   (◊°◊õ◊ï◊ù ◊ë◊©◊ß◊ú◊ô◊ù: ‚Ç™${purchaseAmount.toFixed(2)})`);
                
                // ◊®◊ô◊©◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î - ◊¢◊ù ◊û◊ô◊ì◊¢ ◊û◊ú◊ê ◊¢◊ú ◊û◊ò◊ë◊¢ ◊ï◊¢◊û◊ú◊î
                const purchase = {
                    id: Date.now(),
                    date: purchaseDate,  // ‚Üê ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î ◊ê◊û◊ô◊™◊ô!
                    symbol: symbol,
                    shares: shares,
                    
                    // ◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
                    original_currency: currency,
                    original_price: cost,  // ◊û◊ó◊ô◊® ◊û◊ß◊ï◊®◊ô ◊ú◊û◊†◊ô◊î (◊ú◊§◊†◊ô ◊¢◊û◊ú◊î)
                    original_amount: shares * cost,  // ◊°◊õ◊ï◊ù ◊û◊ß◊ï◊®◊ô (◊ú◊§◊†◊ô ◊¢◊û◊ú◊î)
                    
                    // ◊¢◊û◊ú◊î
                    fee: commission,
                    fee_currency: currency,
                    
                    // ◊©◊ï◊ï◊ô ◊ë◊©◊ß◊ú◊ô◊ù (◊ú◊™◊ê◊ô◊û◊ï◊™ ◊ê◊ó◊ï◊®◊î ◊ï◊™◊¶◊ï◊í◊î)
                    amount: purchaseAmount,
                    originalAmount: purchaseAmountInCurrency,  // ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                    currency: currency,  // ◊î◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                    assetType: 'stocks',
                    assetId: newHolding.id,
                    note: `◊ß◊†◊ô◊ô◊î: ${shares} √ó ${getCurrencySymbol(currency)}${cost.toFixed(2)}` + (commission > 0 ? ` + ${getCurrencySymbol(currency)}${commission.toFixed(2)} ◊¢◊û◊ú◊î` : '')
                };
                portfolio.purchases.push(purchase);
                
                // ◊ê◊ù ◊î◊ô◊ô◊™◊î ◊î◊§◊ß◊ì◊î - ◊¶◊ï◊® snapshot
                if (fundingSource === 'deposit') {
                    const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                    
                    // ◊ô◊¶◊ô◊®◊™ snapshot ◊¢◊ù ◊©◊ï◊ï◊ô ◊ú◊§◊†◊ô ◊î◊ß◊†◊ô◊ô◊î
                    const snapshot = {
                        id: Date.now() + 2,
                        date: purchaseDate,  // ‚Üê ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î ◊ê◊û◊ô◊™◊ô!
                        value_before_flow: valueBeforeNewHolding,
                        cash_flow: depositAmount,
                        stocksValue: getTotalValueILS(),
                        bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                        implicitCash: getImplicitCash('all'),
                        totalValue: getTotalPortfolioValue(),
                        triggerType: 'deposit',
                        triggerNote: `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${symbol}`
                    };
                    portfolio.snapshots.push(snapshot);
                    console.log('üì∏ Snapshot created with value_before_flow:', valueBeforeNewHolding);
                }
                
                console.log('üìä Purchase recorded:', purchase);
                console.log('üìä Funding source:', fundingSource);
            }
            
            console.log('üìç Step 8: Saving data');
            
            // ◊©◊û◊ô◊®◊î
            saveData();
            
            console.log('üìç Step 9: Closing form and clearing inputs');
            
            // ◊°◊í◊ô◊®◊™ ◊î◊ò◊ï◊§◊° ◊ï◊†◊ô◊ß◊ï◊ô
            hideAddHoldingForm();
            symbolInput.value = '';
            sharesInput.value = '';
            costInput.value = '';
            
            console.log('üìç Step 10: Updating UI');
            
            // ◊¢◊ì◊õ◊ï◊ü ◊î◊™◊¶◊ï◊í◊î
            renderHoldingsList();
            updateOverview();
            
            const actionText = editingHoldingId ? '◊¢◊ï◊ì◊õ◊ü' : '◊†◊ï◊°◊£';
            notify(`‚úÖ ${symbol} ${actionText} ◊ë◊î◊¶◊ú◊ó◊î!`);
            console.log('‚úÖ Holding saved successfully. Total holdings:', portfolio.holdings.length);
            console.log('‚úÖ addHolding function completed successfully');
        }
        
        function deleteHolding(id) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊î◊ó◊ñ◊ß◊î ◊ñ◊ï?\n\n◊ñ◊î ◊ô◊ë◊ò◊ú ◊ê◊™ ◊î◊ß◊†◊ô◊ô◊î ◊ï◊ô◊ó◊ñ◊ô◊® ◊ê◊™ ◊î◊õ◊°◊£.')) return;
            
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) {
                notify('‚ùå ◊î◊ó◊ñ◊ß◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            // ◊û◊¶◊ê ◊ê◊™ ◊î◊¢◊°◊ß◊î ◊î◊û◊ß◊ï◊®◊ô◊™
            const purchase = portfolio.purchases.find(p => p.assetId === id);
            
            // ◊î◊ó◊ñ◊® ◊ê◊™ ◊î◊õ◊°◊£ ◊ú-portfolio.cash
            if (purchase) {
                const purchaseAmountInCurrency = holding.shares * holding.costBasis;
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + purchaseAmountInCurrency;
                console.log(`üí∞ ◊î◊ó◊ñ◊® ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} ◊ú◊û◊ñ◊ï◊û◊ü`);
                
                // ◊û◊ó◊ß ◊ê◊™ ◊î◊¢◊°◊ß◊î
                portfolio.purchases = portfolio.purchases.filter(p => p.assetId !== id);
                console.log('üóëÔ∏è ◊¢◊°◊ß◊™ ◊î◊ß◊†◊ô◊ô◊î ◊†◊û◊ó◊ß◊î');
            }
            
            // ◊û◊ó◊ß ◊ê◊™ ◊î◊§◊ï◊ñ◊ô◊¶◊ô◊î
            portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            renderTransactions();
            updateOverview();
            notify('‚úÖ ◊î◊ó◊ñ◊ß◊î ◊ï◊î◊¢◊°◊ß◊î ◊†◊û◊ó◊ß◊ï, ◊î◊õ◊°◊£ ◊î◊ï◊ó◊ñ◊®');
        }
        
        function editHolding(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            // Set editing mode
            editingHoldingId = id;
            
            // Fill form with holding data
            document.getElementById('new-symbol').value = holding.symbol;
            document.getElementById('new-shares').value = holding.shares;
            document.getElementById('new-cost').value = holding.costBasis;
            document.getElementById('new-currency').value = holding.currency;
            document.getElementById('new-group').value = holding.groupId;
            document.getElementById('new-alt-ticker').value = holding.altTicker || '';
            
            // Change form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = `◊¢◊®◊ï◊ö ◊î◊ó◊ñ◊ß◊î: ${holding.symbol}`;
            
            // Show form
            document.getElementById('add-holding-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('add-holding-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updatePriceManually(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const newPrice = prompt(`◊¢◊ì◊õ◊ü ◊û◊ó◊ô◊® ◊¢◊ë◊ï◊® ${holding.symbol}\n\n◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô: ${getCurrencySymbol(holding.currency)}${holding.currentPrice}\n\n◊î◊ñ◊ü ◊û◊ó◊ô◊® ◊ó◊ì◊©:`, holding.currentPrice);
            
            if (newPrice === null) return; // User cancelled
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            holding.currentPrice = price;
            holding.isManualPrice = true; // üîí Mark as manual - will not be overridden!
            holding.lastUpdate = new Date().toISOString();
            saveData();
            renderHoldingsList();
             // ‚ö° Update TWR Live!
            updateOverview();
            notify(`‚úÖ ◊û◊ó◊ô◊® ${holding.symbol} ◊¢◊ï◊ì◊õ◊ü ◊ô◊ì◊†◊ô◊™ ◊ú-${getCurrencySymbol(holding.currency)}${price} (◊û◊ï◊í◊ü ◊û◊®◊ô◊¢◊†◊ï◊ü)`);
        }
        
        function unlockPrice(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            if (!confirm(`üîì ◊ë◊ò◊ú ◊î◊í◊†◊î ◊¢◊ú ${holding.symbol}?\n\n◊î◊û◊ó◊ô◊® ◊ô◊™◊¢◊ì◊õ◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊ë◊®◊ô◊¢◊†◊ï◊ü ◊î◊ë◊ê.`)) {
                return;
            }
            
            delete holding.isManualPrice;
            saveData();
            renderHoldingsList();
            notify(`üîì ◊î◊í◊†◊î ◊ë◊ï◊ò◊ú◊î ◊¢◊ë◊ï◊® ${holding.symbol}. ◊î◊û◊ó◊ô◊® ◊ô◊™◊¢◊ì◊õ◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊ë◊®◊ô◊¢◊†◊ï◊ü ◊î◊ë◊ê.`);
        }
        
        // ===========================================
        // BONDS MANAGEMENT
        // ===========================================
        let editingBondId = null;
        
        window.showAddBondForm = function() {
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.hideAddBondForm = function() {
            const form = document.getElementById('add-bond-form');
            if (form) form.style.display = 'none';
            
            // Reset editing state
            editingBondId = null;
            
            // Clear form with proper field names
            const symbol = document.getElementById('bond-symbol');
            const altTicker = document.getElementById('bond-alt-ticker');
            const units = document.getElementById('bond-units');
            const cost = document.getElementById('bond-cost');
            const date = document.getElementById('bond-purchase-date');
            
            if (symbol) symbol.value = '';
            if (altTicker) altTicker.value = '';
            if (units) units.value = '';
            if (cost) cost.value = '';
            if (date) date.value = new Date().toISOString().split('T')[0];
        }
        
        function saveBond() {
            console.log('=== START saveBond ===');
            console.log('Cash before:', JSON.stringify(portfolio.cash));
            const symbol = document.getElementById('bond-symbol').value.trim();
            const altTicker = document.getElementById('bond-alt-ticker').value.trim();
            const units = parseFloat(document.getElementById('bond-units').value);
            const costBasis = parseFloat(document.getElementById('bond-cost').value);
            const commissionInput = document.getElementById('bond-commission');
            const commission = parseFloat(commissionInput?.value || '0');
            const purchaseDate = document.getElementById('bond-purchase-date').value;
            const currency = document.getElementById('bond-currency').value;
            
            if (!symbol || !units || !costBasis || !purchaseDate) {
                notify('‚ùå ◊ô◊© ◊ú◊û◊ú◊ê ◊ê◊™ ◊õ◊ú ◊î◊©◊ì◊ï◊™ ◊î◊ó◊ï◊ë◊î', 'error');
                return;
            }
            
            if (isNaN(commission) || commission < 0) {
                notify('‚ùå ◊¢◊û◊ú◊î ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
                return;
            }
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊¢◊ù ◊¢◊û◊ú◊î
            // ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊ú◊ô◊ó◊ô◊ì◊î = (◊õ◊û◊ï◊™ √ó ◊û◊ó◊ô◊® + ◊¢◊û◊ú◊î) / ◊õ◊û◊ï◊™
            const actualCostBasis = (units * costBasis + commission) / units;
            console.log(`üí∞ Bond cost calculation: (${units} √ó ${costBasis} + ${commission}) / ${units} = ${actualCostBasis.toFixed(4)}`);
            
            // ‚úÖ Check if editing existing bond
            if (editingBondId !== null) {
                const bond = portfolio.bonds.find(b => b.id === editingBondId);
                if (bond) {
                    bond.symbol = symbol;
                    bond.altTicker = altTicker;
                    bond.units = units;
                    bond.costBasis = actualCostBasis;  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                    bond.purchaseDate = purchaseDate;
                    bond.currency = currency;
                    bond.lastUpdate = new Date().toISOString();
                    
                    console.log('‚úÖ Bond updated:', bond);
                    
                    saveData();
                    renderBondsList();
                    updateOverview();
                    
                    document.getElementById('add-bond-form').style.display = 'none';
                    editingBondId = null;
                    
                    notify('‚úÖ ◊ß◊®◊ü ◊ê◊í"◊ó ◊¢◊ï◊ì◊õ◊†◊î ◊ë◊î◊¶◊ú◊ó◊î', 'success');
                    return;
                }
            }
            
            // ◊ë◊ì◊ô◊ß◊™ ◊û◊ñ◊ï◊û◊ü ◊ñ◊û◊ô◊ü (only for new bonds) - ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î!
            const totalCost = units * costBasis + commission;
            const availableCash = portfolio.cash[currency] || 0;
            let hadDeposit = false; // ‚úÖ ◊û◊©◊™◊†◊î ◊ú◊¢◊ß◊ï◊ë ◊ê◊ù ◊î◊ô◊ô◊™◊î ◊î◊§◊ß◊ì◊î
            
            if (availableCash < totalCost) {
                const shortage = totalCost - availableCash;
                const currSymbol = getCurrencySymbol(currency);
                const depositNow = confirm(
                    `‚ùå ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü ◊ë${currency}

` +
                    `◊ì◊®◊ï◊©: ${currSymbol}${totalCost.toFixed(2)}
` +
                    `◊ñ◊û◊ô◊ü: ${currSymbol}${availableCash.toFixed(2)}
` +
                    `◊ó◊°◊®: ${currSymbol}${shortage.toFixed(2)}

` +
                    `◊î◊ê◊ù ◊ú◊î◊§◊ß◊ô◊ì ${currSymbol}${shortage.toFixed(2)} ◊¢◊õ◊©◊ô◊ï?`
                );
                
                if (depositNow) {
                    hadDeposit = true; // ‚úÖ ◊°◊û◊ü ◊©◊î◊ô◊ô◊™◊î ◊î◊§◊ß◊ì◊î
                    
                    // ◊î◊§◊ß◊ì◊î ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™
                    portfolio.cash[currency] = availableCash + shortage;
                    console.log(`üí∞ After deposit: ${currency} = ${portfolio.cash[currency]}`);
                    
                    // ◊®◊©◊ï◊ù ◊ëdeposits (◊ú◊î◊ô◊°◊ò◊ï◊®◊ô◊î)
                    if (!Array.isArray(portfolio.deposits)) {
                        portfolio.deposits = [];
                    }
                    portfolio.deposits.push({
                        id: Date.now(),
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `◊î◊§◊ß◊ì◊î ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊ú◊ß◊†◊ô◊ô◊™ ${symbol}`
                    });
                    
                    // ◊®◊©◊ï◊ù ◊ëcashFlows (◊ú-MWR)
                    if (!Array.isArray(portfolio.cashFlows)) {
                        portfolio.cashFlows = [];
                    }
                    portfolio.cashFlows.push({
                        id: Date.now() + 1,
                        type: 'deposit',
                        amount: shortage,
                        date: purchaseDate,
                        currency: currency,
                        note: `◊î◊§◊ß◊ì◊î ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊ú◊ß◊†◊ô◊ô◊™ ${symbol}`
                    });
                    
                    notify(`‚úÖ ◊î◊ï◊§◊ß◊ì◊ï ${currSymbol}${shortage.toFixed(2)}`, 'success');
                } else {
                    notify('‚ùå ◊î◊ß◊†◊ô◊ô◊î ◊ë◊ï◊ò◊ú◊î - ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü', 'error');
                    return;
                }
            }
            
            const bond = {
                id: Date.now(),
                symbol: symbol,
                altTicker: altTicker,
                units: units,
                costBasis: actualCostBasis,  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                currentPrice: actualCostBasis,  // ‚Üê ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î
                purchaseDate: purchaseDate,
                currency: currency,
                isManualPrice: false
            };
            
            if (!Array.isArray(portfolio.bonds)) {
                portfolio.bonds = [];
            }
            
            portfolio.bonds.push(bond);
            
            // ◊®◊©◊ï◊ù ◊¢◊°◊ß◊™ ◊ß◊†◊ô◊ô◊î ◊ë-transactions (◊ú◊™◊¶◊ï◊í◊î)
            if (!Array.isArray(portfolio.transactions)) {
                portfolio.transactions = [];
            }
            
            portfolio.transactions.push({
                id: Date.now() + 1,
                type: 'buy',
                assetType: 'bond',
                symbol: symbol,
                shares: units,
                price: costBasis,
                date: purchaseDate,
                currency: currency
            });
            
            // ‚úÖ ◊®◊©◊ï◊ù ◊í◊ù ◊ë-purchases (◊ú◊ó◊ô◊©◊ï◊ë getImplicitCash)
            if (!Array.isArray(portfolio.purchases)) {
                portfolio.purchases = [];
            }
            
            const purchaseAmountILS = convertToILS(totalCost, currency);
            portfolio.purchases.push({
                id: Date.now() + 2,
                date: purchaseDate,
                amount: purchaseAmountILS,
                assetType: 'bonds',
                assetId: bond.id,
                symbol: symbol,
                note: `◊ß◊†◊ô◊ô◊î: ${units} √ó ${currency}${costBasis}`
            });
            
            // ◊î◊§◊ó◊™ ◊û◊û◊ñ◊ï◊û◊ü - ◊ï◊ï◊ì◊ê ◊©◊ñ◊î ◊ß◊ï◊®◊î!
            const currentCash = portfolio.cash[currency] || 0;
            const newCash = currentCash - totalCost;
            portfolio.cash[currency] = newCash;
            console.log(`üí∞ Cash after purchase: ${currency} = ${newCash} (was ${currentCash}, spent ${totalCost})`);
            
            // ‚úÖ ◊ê◊ù ◊î◊ô◊ô◊™◊î ◊î◊§◊ß◊ì◊î - ◊¶◊ï◊® snapshot ◊õ◊ì◊ô ◊©◊ó◊ô◊©◊ï◊ë ◊î◊™◊©◊ï◊ê◊î ◊ô◊î◊ô◊î ◊†◊õ◊ï◊ü
            if (hadDeposit) {
                const shortage = totalCost - availableCash;
                const valueBeforeDeposit = getTotalPortfolioValue() - convertToILS(totalCost, currency); // ◊©◊ï◊ï◊ô ◊ú◊§◊†◊ô ◊î◊ß◊†◊ô◊ô◊î ◊ï◊î◊§◊ß◊ì◊î
                
                // ◊ô◊¶◊ô◊®◊™ snapshot ◊ì◊®◊ö Modal
                openSnapshotDataModal('deposit', convertToILS(shortage, currency), purchaseDate, `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${symbol}`, (snapshot) => {
                    console.log('üì∏ Snapshot created for bond deposit:', snapshot);
                    saveData();
                    updateOverview();
                });
            };
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            hideAddBondForm();
            updateOverview();
            renderCashFlow();
            notify('‚úÖ ◊ß◊®◊ü ◊ê◊í"◊ó ◊†◊ï◊°◊§◊î ◊ë◊î◊¶◊ú◊ó◊î', 'success');
        }

        async function refreshBondPrices() {
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                notify('◊ê◊ô◊ü ◊ß◊®◊†◊ï◊™ ◊ê◊í"◊ó ◊ú◊®◊¢◊†◊ï◊ü', 'info');
                return;
            }
            
            notify('üîÑ ◊û◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô ◊ê◊í"◊ó...', 'info');
            
            let updated = 0;
            let failed = 0;
            let skipped = 0;
            const total = portfolio.bonds.length;
            
            for (let i = 0; i < portfolio.bonds.length; i++) {
                const bond = portfolio.bonds[i];
                
                if (bond.isManualPrice) {
                    console.log(`üîí Skipping ${bond.symbol} - manual price`);
                    skipped++;
                    continue;
                }
                
                try {
                    let price = null;
                    
                    // Try Israeli TASE first if applicable
                    if (isIsraeliSecurity(bond.symbol)) {
                        try {
                            price = await fetchStockPrice(bond.symbol);
                            console.log(`‚úÖ ${bond.symbol}: ‚Ç™${price} (from TASE)`);
                        } catch (e) {
                            // Try alternative ticker
                            if (bond.altTicker) {
                                price = await fetchStockPrice(bond.altTicker);
                                console.log(`‚úÖ ${bond.symbol}: ${price} (from ${bond.altTicker})`);
                            } else {
                                throw e;
                            }
                        }
                    } else {
                        const ticker = bond.altTicker || bond.symbol;
                        price = await fetchStockPrice(ticker);
                        console.log(`‚úÖ ${bond.symbol}: ${price} (from ${ticker})`);
                    }
                    
                    if (price && price > 0) {
                        bond.currentPrice = price;
                        bond.lastUpdate = new Date().toISOString();
                        delete bond.isManualPrice;
                        updated++;
                    }
                } catch (error) {
                    console.error(`‚ùå Failed: ${bond.symbol}`, error);
                    failed++;
                }
                
                // ◊î◊û◊™◊†◊î ◊ß◊¶◊®◊î ◊ë◊ô◊ü ◊ë◊ß◊©◊ï◊™
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            renderBondsList();
            updateOverview();
            
            let msg = '';
            if (skipped > 0) msg += `üîí ${skipped} ◊ì◊ï◊ú◊í◊ï (◊û◊ó◊ô◊® ◊û◊ï◊í◊ü)
`;
            if (failed === 0) {
                notify(`‚úÖ ${updated} ◊û◊ó◊ô◊®◊ô ◊ê◊í"◊ó ◊¢◊ï◊ì◊õ◊†◊ï!
${msg}`, 'success');
            } else {
                notify(`‚ö†Ô∏è ${updated} ◊î◊¶◊ú◊ô◊ó◊ï, ${failed} ◊†◊õ◊©◊ú◊ï
${msg}`, 'warning');
            }
        }

        
        function editBond(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            editingBondId = id;
            document.getElementById('bond-symbol').value = bond.symbol;
            document.getElementById('bond-alt-ticker').value = bond.altTicker || '';
            document.getElementById('bond-units').value = bond.units;
            document.getElementById('bond-cost').value = bond.costBasis;
            document.getElementById('bond-purchase-date').value = bond.purchaseDate ? bond.purchaseDate.split('T')[0] : '';
            document.getElementById('bond-currency').value = bond.currency || 'ILS';
            
            document.getElementById('add-bond-form').style.display = 'block';
            document.getElementById('add-bond-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        window.deleteBond = function(bondId) {
            if (!confirm('◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊û◊ó◊ï◊ß ◊ß◊®◊ü ◊ê◊í"◊ó ◊ñ◊ï?')) return;
            
            if (!Array.isArray(portfolio.bonds)) {
                notify('‚ùå ◊ê◊ô◊ü ◊ß◊®◊†◊ï◊™ ◊ê◊í"◊ó', 'error');
                return;
            }
            
            const bondIndex = portfolio.bonds.findIndex(b => b.id === bondId);
            if (bondIndex === -1) {
                notify('‚ùå ◊ß◊®◊ü ◊ê◊í"◊ó ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            const bond = portfolio.bonds[bondIndex];
            
            // ◊î◊ï◊°◊£ ◊ë◊ó◊ñ◊®◊î ◊ú◊û◊ñ◊ï◊û◊ü (◊î◊ó◊ñ◊® ◊ê◊™ ◊î◊ß◊†◊ô◊ô◊î ◊î◊û◊ß◊ï◊®◊ô◊™)
            const totalCost = bond.units * bond.costBasis;
            const currency = bond.currency || 'ILS';
            portfolio.cash[currency] = (portfolio.cash[currency] || 0) + totalCost;
            
            console.log(`üí∞ Refunded ${totalCost} ${currency} after deleting bond`);
            
            // ◊û◊ó◊ß ◊¢◊°◊ß◊ê◊ï◊™ ◊ß◊©◊ï◊®◊ï◊™ (transactions)
            if (Array.isArray(portfolio.transactions)) {
                portfolio.transactions = portfolio.transactions.filter(t => 
                    !(t.assetType === 'bond' && t.symbol === bond.symbol)
                );
            }
            
            // ‚úÖ ◊û◊ó◊ß ◊í◊ù purchases ◊ß◊©◊ï◊®◊ï◊™
            if (Array.isArray(portfolio.purchases)) {
                portfolio.purchases = portfolio.purchases.filter(p => 
                    !(p.assetType === 'bonds' && p.assetId === bondId)
                );
            }
            
            // ◊û◊ó◊ß ◊ê◊™ ◊î◊ê◊í"◊ó
            portfolio.bonds.splice(bondIndex, 1);
            
            console.log('Cash after deletion:', JSON.stringify(portfolio.cash));
            console.log('Transactions left:', portfolio.transactions ? portfolio.transactions.length : 0);
            
            saveData();
            renderBondsList();
            updateOverview();
            renderCashFlow();
            notify('‚úÖ ◊ß◊®◊ü ◊ê◊í"◊ó ◊†◊û◊ó◊ß◊î ◊ï◊î◊õ◊°◊£ ◊î◊ï◊ó◊ñ◊®', 'success');
        }

        window.updateBondPriceManually = function(bondId) {
            if (!Array.isArray(portfolio.bonds)) {
                notify('‚ùå ◊ê◊ô◊ü ◊ß◊®◊†◊ï◊™ ◊ê◊í"◊ó', 'error');
                return;
            }
            
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) {
                notify('‚ùå ◊ß◊®◊ü ◊ê◊í"◊ó ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            const newPrice = prompt(`◊¢◊ì◊õ◊ü ◊û◊ó◊ô◊® ◊¢◊ë◊ï◊® ${bond.symbol}:`, bond.currentPrice);
            if (newPrice === null) return;
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            bond.currentPrice = price;
            bond.isManualPrice = true;
            bond.lastUpdate = new Date().toISOString();
            
            console.log(`üí∞ Manual price update: ${bond.symbol} = ${price}`);
            
            saveData();
            renderBondsList();
            updateOverview();
            notify(`‚úÖ ◊û◊ó◊ô◊® ◊¢◊ï◊ì◊õ◊ü ◊ú-${getCurrencySymbol(bond.currency)}${price.toFixed(2)}`, 'success');
        }
        
        window.unlockBondPrice = function(bondId) {
            const bond = portfolio.bonds.find(b => b.id === bondId);
            if (!bond) return;
            
            bond.isManualPrice = false;
            
            console.log('Cash after all operations:', JSON.stringify(portfolio.cash));
            console.log('Transactions:', portfolio.transactions.length);
            console.log('=== END saveBond ===');
            saveData();
            renderBondsList();
            notify('üîì ◊î◊í◊†◊™ ◊û◊ó◊ô◊® ◊ë◊ï◊ò◊ú◊î - ◊®◊ô◊¢◊†◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊û◊ï◊§◊¢◊ú', 'success');
        }
        


        

        // ===========================================
        // BOND UNITS - ADD (MODAL)
        // ===========================================
        let addingToBondId = null;
        
        function addBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            addingToBondId = id;
            
            document.getElementById('add-bond-symbol').textContent = bond.symbol;
            document.getElementById('add-bond-current').textContent = `${bond.units} ◊ô◊ó◊ô◊ì◊ï◊™`;
            document.getElementById('add-bond-price').value = bond.currentPrice;
            document.getElementById('add-bond-quantity').value = '';
            document.getElementById('add-bond-commission').value = '0';
            document.getElementById('add-bond-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('add-bond-units-modal').style.display = 'flex';
        }
        
        function hideAddBondUnitsModal() {
            document.getElementById('add-bond-units-modal').style.display = 'none';
            addingToBondId = null;
        }
        
        function submitAddBondUnits() {
            const bond = portfolio.bonds.find(b => b.id === addingToBondId);
            if (!bond) return notify('‚ùå ◊ê◊í"◊ó ◊ú◊ê ◊†◊û◊¶◊ê', 'error');
            
            const unitsNum = parseFloat(document.getElementById('add-bond-quantity').value);
            const priceNum = parseFloat(document.getElementById('add-bond-price').value);
            const commission = parseFloat(document.getElementById('add-bond-commission').value) || 0;
            const dateInput = document.getElementById('add-bond-date').value;
            
            if (isNaN(unitsNum) || unitsNum <= 0) return notify('‚ùå ◊õ◊û◊ï◊™ ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
            if (isNaN(priceNum) || priceNum <= 0) return notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
            if (isNaN(commission) || commission < 0) return notify('‚ùå ◊¢◊û◊ú◊î ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
            if (!dateInput) return notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
            
            const purchaseDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            const actualPriceNum = (unitsNum * priceNum + commission) / unitsNum;
            const purchaseAmount = unitsNum * priceNum + commission;
            const availableCash = getImplicitCash('bonds');
            
            let fundingSource = 'cash';
            if (availableCash < purchaseAmount) {
                const needDeposit = purchaseAmount - availableCash;
                if (!confirm(`◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü (◊ñ◊û◊ô◊ü: ‚Ç™${Math.round(availableCash).toLocaleString()}).\n◊î◊ê◊ù ◊ú◊î◊§◊ß◊ô◊ì ‚Ç™${Math.round(needDeposit).toLocaleString()}?`)) {
                    return notify('‚ùå ◊ë◊ï◊ò◊ú', 'error');
                }
                fundingSource = 'deposit';
            } else if (availableCash > 0) {
                fundingSource = confirm(`◊ú◊û◊û◊ü ◊û◊î◊û◊ñ◊ï◊û◊ü ◊î◊ß◊ô◊ô◊ù (‚Ç™${Math.round(availableCash).toLocaleString()})?\n\n◊ê◊ô◊©◊ï◊®=◊û◊ñ◊ï◊û◊ü, ◊ë◊ô◊ò◊ï◊ú=◊î◊§◊ß◊ì◊î.`) ? 'cash' : 'deposit';
            } else {
                fundingSource = 'deposit';
            }
            
            const oldCost = bond.units * bond.costBasis;
            const newCost = unitsNum * actualPriceNum;
            const totalUnits = bond.units + unitsNum;
            const newAvgCost = (oldCost + newCost) / totalUnits;
            const valueBeforeUpdate = getTotalPortfolioValueAtCost();
            
            bond.units = totalUnits;
            bond.costBasis = newAvgCost;
            bond.lastUpdate = new Date().toISOString();
            
            portfolio.purchases.push({
                id: Date.now(),
                date: purchaseDate,
                symbol: bond.symbol,
                shares: unitsNum,
                
                // ◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô (◊ê◊í"◊ó = ◊©◊ß◊ú◊ô◊ù)
                original_currency: bond.currency || 'ILS',
                original_price: priceNum,
                original_amount: unitsNum * priceNum,
                
                // ◊¢◊û◊ú◊î
                fee: commission,
                fee_currency: bond.currency || 'ILS',
                
                // ◊©◊ï◊ï◊ô ◊ë◊©◊ß◊ú◊ô◊ù
                amount: purchaseAmount,
                originalAmount: purchaseAmountInCurrency || purchaseAmount,  // ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                currency: currency || 'ILS',  // ◊î◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                assetType: 'bonds',
                assetId: bond.id,
                note: `◊ß◊†◊ô◊ô◊î: ${unitsNum} √ó ‚Ç™${priceNum.toFixed(2)}` + (commission > 0 ? ` + ‚Ç™${commission.toFixed(2)} ◊¢◊û◊ú◊î` : '')
            });
            
            if (fundingSource === 'deposit') {
                const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                portfolio.deposits.push({
                    id: Date.now() + 1,
                    date: purchaseDate,
                    amount: depositAmount,
                    assetType: 'bonds',
                    note: `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${bond.symbol}`
                });
                
                portfolio.snapshots.push({
                    id: Date.now() + 2,
                    date: purchaseDate,
                    value_before_flow: valueBeforeUpdate,
                    cash_flow: depositAmount,
                    stocksValue: getTotalValueILS(),
                    bondsValue: portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0),
                    implicitCash: getImplicitCash('all'),
                    totalValue: getTotalPortfolioValue(),
                    triggerType: 'deposit',
                    triggerNote: `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${bond.symbol}`
                });
            }
            
            saveData();
            renderBondsList();
            renderCashFlow();
            updateOverview();
            
            hideAddBondUnitsModal();
            notify(`‚úÖ ◊†◊ï◊°◊§◊ï ${unitsNum} ◊ô◊ó◊ô◊ì◊ï◊™ ◊ú-${bond.symbol}\n◊û◊ó◊ô◊® ◊û◊û◊ï◊¶◊¢ ◊ó◊ì◊©: ‚Ç™${newAvgCost.toFixed(2)}`, 'success');
        }
        
        // ===========================================
        // BOND UNITS - SELL (MODAL)
        // ===========================================
        let sellingFromBondId = null;
        
        function sellBondUnits(id) {
            const bond = portfolio.bonds.find(b => b.id === id);
            if (!bond) return;
            
            sellingFromBondId = id;
            
            document.getElementById('sell-bond-symbol').textContent = bond.symbol;
            document.getElementById('sell-bond-current').textContent = `${bond.units} ◊ô◊ó◊ô◊ì◊ï◊™`;
            document.getElementById('sell-bond-price').value = bond.currentPrice;
            document.getElementById('sell-bond-quantity').value = '';
            document.getElementById('sell-bond-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('sell-bond-units-modal').style.display = 'flex';
        }
        
        function hideSellBondUnitsModal() {
            document.getElementById('sell-bond-units-modal').style.display = 'none';
            sellingFromBondId = null;
        }
        
        function submitSellBondUnits() {
            const bond = portfolio.bonds.find(b => b.id === sellingFromBondId);
            if (!bond) return notify('‚ùå ◊ê◊í"◊ó ◊ú◊ê ◊†◊û◊¶◊ê', 'error');
            
            const unitsNum = parseFloat(document.getElementById('sell-bond-quantity').value);
            const priceNum = parseFloat(document.getElementById('sell-bond-price').value);
            const dateInput = document.getElementById('sell-bond-date').value;
            
            if (isNaN(unitsNum) || unitsNum <= 0) return notify('‚ùå ◊õ◊û◊ï◊™ ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
            if (unitsNum > bond.units) return notify('‚ùå ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊ô◊ó◊ô◊ì◊ï◊™ ◊ú◊û◊õ◊ô◊®◊î', 'error');
            if (isNaN(priceNum) || priceNum <= 0) return notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
            if (!dateInput) return notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
            
            const saleDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            const saleAmount = unitsNum * priceNum;
            const profit = (priceNum - bond.costBasis) * unitsNum;
            
            const keepInPortfolio = confirm(`◊™◊û◊ï◊®◊™ ◊î◊û◊õ◊ô◊®◊î: ‚Ç™${saleAmount.toLocaleString()}\n\n◊î◊ê◊ù ◊ú◊î◊©◊ê◊ô◊® ◊ë◊™◊ô◊ß ◊õ◊û◊ñ◊ï◊û◊ü?\n\n◊ú◊ó◊• ◊ê◊ô◊©◊ï◊® ◊ú◊î◊©◊ê◊ô◊® ◊ë◊™◊ô◊ß, ◊ë◊ô◊ò◊ï◊ú ◊ú◊û◊©◊ï◊ö ◊û◊ô◊ô◊ì.`);
            
            portfolio.sales.push({
                id: Date.now(),
                date: saleDate,
                amount: saleAmount,  // ◊ë◊©◊ß◊ú◊ô◊ù
                originalAmount: saleAmount,  // ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                currency: bond.currency || 'ILS',
                profit: profit,
                assetType: 'bonds',
                assetId: bond.id,
                fundName: bond.symbol,
                units: unitsNum,
                salePrice: priceNum,
                costBasis: bond.costBasis
            });
            
            if (!keepInPortfolio) {
                portfolio.withdrawals.push({
                    id: Date.now() + 1,
                    date: saleDate,
                    amount: saleAmount,
                    assetType: 'bonds',
                    note: `◊û◊©◊ô◊õ◊î ◊û◊û◊õ◊ô◊®◊™ ${unitsNum} ◊ô◊ó◊ô◊ì◊ï◊™ ${bond.symbol}`
                });
                (() => {
                openSnapshotDataModal('withdrawal', -saleAmount, saleDate, `◊û◊©◊ô◊õ◊î ◊û◊û◊õ◊ô◊®◊™ ${bond.symbol}`, (snapshot) => {
                    saveData();
                    updateOverview();
                });
            })();
            }
            
            bond.units -= unitsNum;
            
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash.ILS = (portfolio.cash.ILS || 0) + saleAmount;
            }
            
            bond.lastUpdate = new Date().toISOString();
            
            if (bond.units === 0) {
                if (confirm(`◊û◊õ◊®◊™ ◊ê◊™ ◊õ◊ú ◊î◊ô◊ó◊ô◊ì◊ï◊™ ◊©◊ú ${bond.symbol}. ◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊î◊ß◊®◊ü ◊û◊î◊®◊©◊ô◊û◊î?`)) {
                    portfolio.bonds = portfolio.bonds.filter(b => b.id !== sellingFromBondId);
                }
            }
            
            saveData();
            renderBondsList();
            renderCashFlow();
            updateOverview();
            
            hideSellBondUnitsModal();
            
            const profitText = profit >= 0 ? `+‚Ç™${profit.toFixed(2)}` : `‚Ç™${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '◊†◊©◊ê◊® ◊ë◊™◊ô◊ß' : '◊†◊û◊©◊ö';
            notify(`‚úÖ ◊†◊û◊õ◊®◊ï ${unitsNum} ◊ô◊ó◊ô◊ì◊ï◊™ ◊û-${bond.symbol}\n◊®◊ï◊ï◊ó: ${profitText}\n${actionText}`, 'success');
        }
        
        // ===========================================
        // NEW: BONDS CAPITAL MOVEMENTS
        // ===========================================
        function addBondsCapitalMovement() {
            const amount = prompt('◊î◊ñ◊ü ◊°◊õ◊ï◊ù:\n\n(◊ó◊ô◊ï◊ë◊ô = ◊î◊§◊ß◊ì◊î, ◊©◊ú◊ô◊ú◊ô = ◊û◊©◊ô◊õ◊î)');
            if (amount === null) return;
            
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum === 0) {
                notify('‚ùå ◊°◊õ◊ï◊ù ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            const note = prompt('◊î◊¢◊®◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô):', '') || '';
            
            // üì∏ Create snapshot BEFORE adding the capital movement
            const typeText = amountNum > 0 ? '◊î◊§◊ß◊ì◊î' : '◊û◊©◊ô◊õ◊î';
            createPortfolioSnapshot(amountNum > 0 ? 'bonds-deposit' : 'bonds-withdrawal', `◊ê◊í"◊ó: ${typeText} ‚Ç™${Math.abs(amountNum).toLocaleString()}`);
            
            if (!portfolio.bondsCapitalMovements) portfolio.bondsCapitalMovements = [];
            portfolio.bondsCapitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amountNum,
                type: amountNum > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            
            notify(`‚úÖ ${typeText} ◊©◊ú ‚Ç™${Math.abs(amountNum).toLocaleString()} ◊†◊®◊©◊û◊î ◊ú◊ê◊í"◊ó`);
        }
        
        function deleteBondsCapitalMovement(id) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊™◊†◊ï◊¢◊î ◊ñ◊ï?')) return;
            
            portfolio.bondsCapitalMovements = portfolio.bondsCapitalMovements.filter(m => m.id !== id);
            saveData();
            renderBondsCapitalMovements();
            updateCapitalSummary();
            notify('‚úÖ ◊™◊†◊ï◊¢◊î ◊†◊û◊ó◊ß◊î');
        }
        
        function renderBondsCapitalMovements() {
            const container = document.getElementById('bonds-capital-movements-list');
            if (!container) return;
            
            if (!portfolio.bondsCapitalMovements || portfolio.bondsCapitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #92400e;">◊ê◊ô◊ü ◊™◊†◊ï◊¢◊ï◊™ ◊î◊ï◊ü ◊ú◊ê◊í"◊ó</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #fde68a;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊õ◊ï◊ù</th><th>◊°◊ï◊í</th><th>◊î◊¢◊®◊î</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.bondsCapitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+‚Ç™${m.amount.toLocaleString()}` : `-‚Ç™${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? 'üí∞ ◊î◊§◊ß◊ì◊î' : 'üí∏ ◊û◊©◊ô◊õ◊î';
                
                html += `<tr style="border-bottom: 1px solid #fde68a;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #92400e;">${m.note || '-'}</td>
                    <td><button onclick="deleteBondsCapitalMovement(${m.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            const totalBondsCapital = portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                <strong style="color: #92400e;">◊°◊î"◊õ ◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô ◊ê◊í"◊ó: ‚Ç™${totalBondsCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderBondsList() {
            const container = document.getElementById('bonds-list');
            if (!container) return;
            
            if (!Array.isArray(portfolio.bonds) || portfolio.bonds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">◊ê◊ô◊ü ◊ß◊®◊†◊ï◊™ ◊ê◊í"◊ó ◊¢◊ì◊ô◊ô◊ü</p>
                        <p>◊ú◊ó◊• ◊¢◊ú "◊î◊ï◊°◊£ ◊ß◊®◊ü ◊ê◊í"◊ó" ◊õ◊ì◊ô ◊ú◊î◊™◊ó◊ô◊ú</p>
                    </div>
                `;
                return;
            }
            
            // ◊ò◊ë◊ú◊î ◊®◊ï◊ó◊ë◊ô◊™
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 700;">◊°◊ô◊û◊ï◊ú / ◊†.◊¢.</th>
                    <th style="padding: 15px; text-align: center;">◊ô◊ó◊ô◊ì◊ï◊™</th>
                    <th style="padding: 15px; text-align: center;">◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î</th>
                    <th style="padding: 15px; text-align: center;">◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô</th>
                    <th style="padding: 15px; text-align: center;">◊©◊ï◊ï◊ô</th>
                    <th style="padding: 15px; text-align: center;">◊®◊ï◊ï◊ó/◊î◊§◊°◊ì</th>
                    <th style="padding: 15px; text-align: center;">◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î</th>
                    <th style="padding: 15px; text-align: center;">◊§◊¢◊ï◊ú◊ï◊™</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.bonds.forEach(bond => {
                const currentValue = bond.units * bond.currentPrice;
                const costValue = bond.units * bond.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
                const currSymbol = getCurrencySymbol(bond.currency);
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 15px; font-weight: 700; color: var(--text-primary);">
                        ${bond.symbol}
                        ${bond.altTicker ? `<br><span style="font-size: 0.75rem; color: var(--warning);">‚Üí ${bond.altTicker}</span>` : ''}
                        ${bond.isManualPrice ? '<span style="font-size: 0.75rem; color: var(--warning); margin-right: 5px;" title="◊û◊ó◊ô◊® ◊ô◊ì◊†◊ô">üîí</span>' : ''}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${bond.units}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${currSymbol}${bond.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600;">
                        ${currSymbol}${bond.currentPrice.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: var(--text-primary);">
                        ${currSymbol}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${currSymbol}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        ${new Date(bond.purchaseDate).toLocaleDateString('he-IL')}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="addBondUnits(${bond.id})" class="btn btn-sm" title="◊î◊ï◊°◊£ ◊ô◊ó◊ô◊ì◊ï◊™" style="background: var(--profit); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ‚ûï
                            </button>
                            <button onclick="sellBondUnits(${bond.id})" class="btn btn-sm" title="◊û◊õ◊ï◊® ◊ô◊ó◊ô◊ì◊ï◊™" style="background: var(--warning); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                üí∏
                            </button>
                            <button onclick="editBond(${bond.id})" class="btn btn-sm" title="◊¢◊®◊ï◊ö" style="background: var(--info); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="updateBondPriceManually(${bond.id})" class="btn btn-sm" title="${bond.isManualPrice ? '◊û◊ó◊ô◊® ◊û◊ï◊í◊ü' : '◊¢◊ì◊õ◊ü ◊û◊ó◊ô◊®'}" style="background: var(--accent); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${bond.isManualPrice ? 'üîí' : 'üí∞'}
                            </button>
                            <button onclick="console.log('Deleting bond:', ${bond.id}); deleteBond(${bond.id}); return false;" class="btn btn-sm" title="◊û◊ó◊ß" style="background: var(--loss); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // ===========================================
        // NEW: ADD SHARES TO EXISTING POSITION (MODAL)
        // ===========================================
        let addingToHoldingId = null;
        
        function showAddSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            addingToHoldingId = id;
            
            // Set modal content
            document.getElementById('add-shares-symbol').textContent = holding.symbol;
            document.getElementById('add-shares-current').textContent = `${holding.shares} ◊û◊†◊ô◊ï◊™`;
            document.getElementById('add-shares-avg-cost').textContent = `${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}`;
            
            // Pre-fill with current price
            document.getElementById('add-shares-price').value = holding.currentPrice;
            document.getElementById('add-shares-quantity').value = '';
            document.getElementById('add-shares-commission').value = '0';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('add-shares-date').value = today;
            
            // Show modal
            document.getElementById('add-shares-modal').style.display = 'flex';
        }
        
        function hideAddSharesModal() {
            document.getElementById('add-shares-modal').style.display = 'none';
            addingToHoldingId = null;
        }
        
        function submitAddShares() {
            const holding = portfolio.holdings.find(h => h.id === addingToHoldingId);
            if (!holding) {
                notify('‚ùå ◊î◊ó◊ñ◊ß◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            // Get form values
            const sharesToAdd = parseFloat(document.getElementById('add-shares-quantity').value);
            const purchasePrice = parseFloat(document.getElementById('add-shares-price').value);
            const commission = parseFloat(document.getElementById('add-shares-commission').value) || 0;
            const dateInput = document.getElementById('add-shares-date').value;
            
            // Validation
            if (isNaN(sharesToAdd) || sharesToAdd <= 0) {
                notify('‚ùå ◊õ◊û◊ï◊™ ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
                return;
            }
            
            if (isNaN(purchasePrice) || purchasePrice <= 0) {
                notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            if (isNaN(commission) || commission < 0) {
                notify('‚ùå ◊¢◊û◊ú◊î ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
                return;
            }
            
            // Convert date to ISO format
            const purchaseDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë ◊û◊ó◊ô◊® ◊ê◊û◊ô◊™◊ô ◊¢◊ù ◊¢◊û◊ú◊î
            const actualPurchasePrice = (sharesToAdd * purchasePrice + commission) / sharesToAdd;
            console.log(`üí∞ Cost calculation: (${sharesToAdd} √ó ${purchasePrice} + ${commission}) / ${sharesToAdd} = ${actualPurchasePrice.toFixed(4)}`);
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë ◊°◊õ◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î (◊õ◊ï◊ú◊ú ◊¢◊û◊ú◊î!)
            const purchaseAmountInCurrency = sharesToAdd * purchasePrice + commission;
            const purchaseAmount = convertToILS(purchaseAmountInCurrency, holding.currency);
            const availableCash = getImplicitCash('stocks');
            
            // ‚úÖ ◊©◊ê◊ú◊î: ◊û◊ê◊ô◊§◊î ◊î◊õ◊°◊£?
            let fundingSource = 'cash';
            
            if (availableCash < purchaseAmount) {
                const needDeposit = purchaseAmount - availableCash;
                if (!confirm(`◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü ◊ë◊™◊ô◊ß (◊ñ◊û◊ô◊ü: ‚Ç™${Math.round(availableCash).toLocaleString()}).\n◊î◊ê◊ù ◊ú◊î◊§◊ß◊ô◊ì ‚Ç™${Math.round(needDeposit).toLocaleString()} ◊†◊ï◊°◊§◊ô◊ù?`)) {
                    notify('‚ùå ◊ë◊ï◊ò◊ú - ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü', 'error');
                    return;
                }
                fundingSource = 'deposit';
            } else if (availableCash > 0) {
                fundingSource = confirm(`◊ú◊û◊û◊ü ◊û◊î◊û◊ñ◊ï◊û◊ü ◊î◊ß◊ô◊ô◊ù ◊ë◊™◊ô◊ß (‚Ç™${Math.round(availableCash).toLocaleString()})?\n\n◊ú◊ó◊• ◊ê◊ô◊©◊ï◊® ◊ú◊û◊ñ◊ï◊û◊ü ◊ß◊ô◊ô◊ù, ◊ë◊ô◊ò◊ï◊ú ◊ú◊î◊§◊ß◊ì◊î ◊ó◊ì◊©◊î.`) ? 'cash' : 'deposit';
            } else {
                fundingSource = 'deposit';
            }
            
            // ◊©◊û◊ô◊®◊™ ◊©◊ï◊ï◊ô ◊î◊™◊ô◊ß ◊ú◊§◊†◊ô ◊î◊ß◊†◊ô◊ô◊î
            const valueBeforeUpdate = getTotalPortfolioValueAtCost();
            
            // ‚úÖ Calculate new average cost
            const oldTotal = holding.shares * holding.costBasis;
            const newTotal = sharesToAdd * actualPurchasePrice;
            const newShares = holding.shares + sharesToAdd;
            const newAvgCost = (oldTotal + newTotal) / newShares;
            
            // Update holding
            holding.shares = newShares;
            holding.costBasis = newAvgCost;
            holding.lastUpdate = new Date().toISOString();
            
            // ‚úÖ ◊®◊ô◊©◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î - ◊¢◊ù ◊û◊ô◊ì◊¢ ◊û◊ú◊ê
            const purchase = {
                id: Date.now(),
                date: purchaseDate,
                symbol: holding.symbol,
                shares: sharesToAdd,
                
                // ◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
                original_currency: holding.currency,
                original_price: purchasePrice,  // ◊û◊ó◊ô◊® ◊û◊ß◊ï◊®◊ô ◊ú◊û◊†◊ô◊î (◊ú◊§◊†◊ô ◊¢◊û◊ú◊î)
                original_amount: sharesToAdd * purchasePrice,  // ◊°◊õ◊ï◊ù ◊û◊ß◊ï◊®◊ô (◊ú◊§◊†◊ô ◊¢◊û◊ú◊î)
                
                // ◊¢◊û◊ú◊î
                fee: commission,
                fee_currency: holding.currency,
                
                // ◊©◊ï◊ï◊ô ◊ë◊©◊ß◊ú◊ô◊ù
                amount: purchaseAmount,
                originalAmount: purchaseAmountInCurrency || purchaseAmount,  // ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                currency: holding.currency || 'ILS',  // ◊î◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                assetType: 'stocks',
                assetId: holding.id,
                note: `◊ß◊†◊ô◊ô◊î: ${sharesToAdd} √ó ${getCurrencySymbol(holding.currency)}${purchasePrice.toFixed(2)}` + (commission > 0 ? ` + ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)} ◊¢◊û◊ú◊î` : '')
            };
            portfolio.purchases.push(purchase);
            
            // ‚úÖ ◊ê◊™◊ó◊ú portfolio.cash
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            // ‚úÖ ◊ê◊ù ◊¶◊®◊ô◊ö ◊î◊§◊ß◊ì◊î
            if (fundingSource === 'deposit') {
                const depositAmount = availableCash < 0 ? purchaseAmount : (purchaseAmount - availableCash);
                const deposit = {
                    id: Date.now() + 1,
                    date: purchaseDate,
                    amount: depositAmount,
                    assetType: 'stocks',
                    note: `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${holding.symbol}`
                };
                portfolio.deposits.push(deposit);
                
                portfolio.cash.ILS = (portfolio.cash.ILS || 0) + depositAmount;
                console.log(`üí∞ ◊î◊ï◊§◊ß◊ì: ‚Ç™${depositAmount.toFixed(2)}`);
                
                // ◊ô◊¶◊ô◊®◊™ snapshot ◊¢◊ù Modal ◊ú◊ß◊ë◊ú◊™ ◊†◊™◊ï◊†◊ô◊ù ◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊ù
                openSnapshotDataModal('deposit', depositAmount, purchaseDate, `◊î◊§◊ß◊ì◊î ◊ú◊ß◊†◊ô◊ô◊î: ${holding.symbol}`, (snapshot) => {
                    console.log('üì∏ Snapshot created for existing holding deposit:', snapshot);
                    saveData();
                    updateOverview();
                });
            }
            
            // ‚úÖ ◊î◊§◊ó◊™ ◊ê◊™ ◊°◊õ◊ï◊ù ◊î◊ß◊†◊ô◊ô◊î ◊û◊î◊û◊ñ◊ï◊û◊ü (◊ë◊û◊ò◊ë◊¢ ◊î◊û◊™◊ê◊ô◊ù)
            portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) - purchaseAmountInCurrency;
            console.log(`üí∞ ◊†◊ó◊°◊® ${purchaseAmountInCurrency.toFixed(2)} ${holding.currency} ◊û◊î◊û◊ñ◊ï◊û◊ü`);
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            updateOverview();
            
            hideAddSharesModal();
            notify(`‚úÖ ◊†◊ï◊°◊§◊ï ${sharesToAdd} ◊û◊†◊ô◊ï◊™ ◊©◊ú ${holding.symbol}\n◊û◊ó◊ô◊® ◊û◊û◊ï◊¶◊¢ ◊ó◊ì◊©: ${getCurrencySymbol(holding.currency)}${newAvgCost.toFixed(2)}`, 'success');
        }
        
        // ===========================================
        // NEW: SELL PARTIAL POSITION (MODAL)
        // ===========================================
        let sellingFromHoldingId = null;
        
        function showSellSharesForm(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            sellingFromHoldingId = id;
            
            // Set modal content
            document.getElementById('sell-shares-symbol').textContent = holding.symbol;
            document.getElementById('sell-shares-current').textContent = `${holding.shares} ◊û◊†◊ô◊ï◊™`;
            document.getElementById('sell-shares-avg-cost').textContent = `${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}`;
            document.getElementById('sell-shares-current-price').textContent = `${getCurrencySymbol(holding.currency)}${holding.currentPrice.toFixed(2)}`;
            
            // Pre-fill with current price
            document.getElementById('sell-shares-price').value = holding.currentPrice;
            document.getElementById('sell-shares-quantity').value = '';
            document.getElementById('sell-shares-commission').value = '0';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sell-shares-date').value = today;
            
            // Show modal
            document.getElementById('sell-shares-modal').style.display = 'flex';
        }
        
        function hideSellSharesModal() {
            document.getElementById('sell-shares-modal').style.display = 'none';
            sellingFromHoldingId = null;
        }
        
        function submitSellShares() {
            const holding = portfolio.holdings.find(h => h.id === sellingFromHoldingId);
            if (!holding) {
                notify('‚ùå ◊î◊ó◊ñ◊ß◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            // Get form values
            const sharesToSell = parseFloat(document.getElementById('sell-shares-quantity').value);
            const salePrice = parseFloat(document.getElementById('sell-shares-price').value);
            const dateInput = document.getElementById('sell-shares-date').value;
            const commission = parseFloat(document.getElementById('sell-shares-commission').value) || 0;
            
            // Validation
            if (isNaN(sharesToSell) || sharesToSell <= 0) {
                notify('‚ùå ◊õ◊û◊ï◊™ ◊ú◊ê ◊™◊ß◊ô◊†◊î', 'error');
                return;
            }
            
            if (sharesToSell > holding.shares) {
                notify('‚ùå ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊†◊ô◊ï◊™ ◊ú◊û◊õ◊ô◊®◊î', 'error');
                return;
            }
            
            if (isNaN(salePrice) || salePrice <= 0) {
                notify('‚ùå ◊û◊ó◊ô◊® ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
                return;
            }
            
            // Convert date to ISO format
            const saleDate = new Date(dateInput + 'T12:00:00.000Z').toISOString();
            
            // Calculate amounts - ◊¢◊û◊ú◊î ◊û◊ï◊§◊ó◊™◊™ ◊û◊î◊™◊û◊ï◊®◊î
            const grossAmount = sharesToSell * salePrice;  // ◊°◊õ◊ï◊ù ◊ë◊®◊ï◊ò◊ï
            const saleAmountForeign = grossAmount - commission;  // ◊°◊õ◊ï◊ù ◊†◊ò◊ï (◊ê◊ó◊®◊ô ◊¢◊û◊ú◊î)
            const netPricePerShare = saleAmountForeign / sharesToSell;  // ◊û◊ó◊ô◊® ◊†◊ò◊ï ◊ú◊û◊†◊ô◊î
            const saleAmountILS = convertToILS(saleAmountForeign, holding.currency);
            const profit = (netPricePerShare - holding.costBasis) * sharesToSell;  // ◊®◊ï◊ï◊ó ◊ú◊§◊ô ◊û◊ó◊ô◊® ◊†◊ò◊ï
            const profitILS = convertToILS(profit, holding.currency);
            
            // ◊©◊ê◊ú◊î: ◊û◊î ◊ú◊¢◊©◊ï◊™ ◊¢◊ù ◊î◊™◊û◊ï◊®◊î?
            const commissionText = commission > 0 ? `\n◊¢◊û◊ú◊î: ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)}` : '';
            const keepInPortfolio = confirm(`◊™◊û◊ï◊®◊™ ◊î◊û◊õ◊ô◊®◊î (◊†◊ò◊ï): ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)} (‚Ç™${Math.round(saleAmountILS).toLocaleString()})${commissionText}\n\n◊î◊ê◊ù ◊ú◊î◊©◊ê◊ô◊® ◊ë◊™◊ô◊ß ◊õ◊û◊ñ◊ï◊û◊ü?\n\n◊ú◊ó◊• ◊ê◊ô◊©◊ï◊® ◊ú◊î◊©◊ê◊ô◊® ◊ë◊™◊ô◊ß, ◊ë◊ô◊ò◊ï◊ú ◊ú◊û◊©◊ï◊ö ◊û◊ô◊ô◊ì.`);
            
            // ◊®◊ô◊©◊ï◊ù ◊î◊û◊õ◊ô◊®◊î - ◊¢◊ù ◊û◊ô◊ì◊¢ ◊û◊ú◊ê
            const noteText = commission > 0 
                ? `◊û◊õ◊ô◊®◊î: ${sharesToSell} √ó ${getCurrencySymbol(holding.currency)}${salePrice.toFixed(2)} - ◊¢◊û◊ú◊î ${getCurrencySymbol(holding.currency)}${commission.toFixed(2)} = ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)}`
                : `◊û◊õ◊ô◊®◊î: ${sharesToSell} √ó ${getCurrencySymbol(holding.currency)}${salePrice.toFixed(2)} = ${getCurrencySymbol(holding.currency)}${saleAmountForeign.toFixed(2)}`;
            
            const sale = {
                id: Date.now(),
                date: saleDate,
                symbol: holding.symbol,
                shares: sharesToSell,
                
                // ◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
                original_currency: holding.currency,
                original_price: salePrice,  // ◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î ◊ú◊û◊†◊ô◊î (◊ë◊®◊ï◊ò◊ï)
                net_price: netPricePerShare,  // ◊û◊ó◊ô◊® ◊†◊ò◊ï ◊ú◊û◊†◊ô◊î (◊ê◊ó◊®◊ô ◊¢◊û◊ú◊î)
                original_amount: saleAmountForeign,  // ◊°◊õ◊ï◊ù ◊†◊ò◊ï ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô
                gross_amount: grossAmount,  // ◊°◊õ◊ï◊ù ◊ë◊®◊ï◊ò◊ï ◊ú◊§◊†◊ô ◊¢◊û◊ú◊î
                commission: commission,  // ◊¢◊û◊ú◊™ ◊û◊õ◊ô◊®◊î
                
                // ◊¢◊ú◊ï◊™ ◊ï◊®◊ï◊ï◊ó
                costBasis: holding.costBasis,
                profit: profit,  // ◊®◊ï◊ï◊ó ◊ë◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®◊ô (◊û◊ó◊ï◊©◊ë ◊ú◊§◊ô ◊†◊ò◊ï)
                
                // ◊©◊ï◊ï◊ô ◊ë◊©◊ß◊ú◊ô◊ù (◊ú◊™◊ê◊ô◊û◊ï◊™)
                amount: saleAmountILS,
                originalAmount: saleAmountForeign,  // ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                profitILS: profitILS,
                originalProfit: profit,  // ◊î◊®◊ï◊ï◊ó ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô
                assetType: 'stocks',
                assetId: holding.id,
                currency: holding.currency,  // ◊ú◊™◊ê◊ô◊û◊ï◊™ ◊ê◊ó◊ï◊®◊î
                salePrice: salePrice,  // ◊ú◊™◊ê◊ô◊û◊ï◊™ ◊ê◊ó◊ï◊®◊î
                note: noteText
            };
            portfolio.sales.push(sale);
            
            // ◊ê◊ù ◊ë◊ó◊® ◊ú◊û◊©◊ï◊ö - ◊ô◊¶◊ô◊®◊™ ◊û◊©◊ô◊õ◊î ◊ï-snapshot
            if (!keepInPortfolio) {
                const withdrawal = {
                    id: Date.now() + 1,
                    date: saleDate,
                    amount: saleAmountILS,
                    assetType: 'stocks',
                    note: `◊û◊©◊ô◊õ◊î ◊û◊û◊õ◊ô◊®◊™ ${sharesToSell} ${holding.symbol}`
                };
                portfolio.withdrawals.push(withdrawal);
                (() => {
                    openSnapshotDataModal('withdrawal', -saleAmountILS, saleDate, `◊û◊©◊ô◊õ◊î ◊û◊û◊õ◊ô◊®◊™ ${holding.symbol}`, (snapshot) => {
                        saveData();
                        updateOverview();
                    });
                })();
            }
            
            // ◊¢◊ì◊õ◊ü portfolio.cash - ◊î◊ï◊°◊£ ◊ê◊™ ◊™◊û◊ï◊®◊™ ◊î◊û◊õ◊ô◊®◊î ◊î◊†◊ò◊ï (◊ê◊ù ◊†◊©◊ê◊® ◊ë◊™◊ô◊ß)
            if (keepInPortfolio) {
                if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
                portfolio.cash[holding.currency] = (portfolio.cash[holding.currency] || 0) + saleAmountForeign;
                console.log(`üí∞ ◊û◊õ◊ô◊®◊î: ◊†◊ï◊°◊£ ${saleAmountForeign.toFixed(2)} ${holding.currency} ◊ú◊ô◊™◊®◊™ ◊î◊û◊ñ◊ï◊û◊ü (◊†◊ò◊ï ◊ê◊ó◊®◊ô ◊¢◊û◊ú◊î)`);
            }
            
            // Update holding
            holding.shares -= sharesToSell;
            holding.lastUpdate = new Date().toISOString();
            
            // If sold all shares, remove holding
            if (holding.shares === 0) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== sellingFromHoldingId);
            }
            
            saveData();
            renderHoldingsList();
            renderCashFlow();
            updateOverview();
            
            hideSellSharesModal();
            
            const profitText = profit >= 0 ? `◊®◊ï◊ï◊ó: +${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}` : `◊î◊§◊°◊ì: ${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}`;
            const actionText = keepInPortfolio ? '◊†◊©◊ê◊® ◊ë◊™◊ô◊ß' : '◊†◊û◊©◊ö';
            notify(`‚úÖ ◊†◊û◊õ◊®◊ï ${sharesToSell} ${holding.symbol}\n${profitText}\n${actionText}`, 'success');
        }
        
        // ===========================================
        // CASHFLOW UI FUNCTIONS
        // ===========================================
        
        function showDepositModal() {
            document.getElementById('deposit-modal').style.display = 'flex';
            document.getElementById('deposit-amount').value = '';
            document.getElementById('deposit-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deposit-date').value = today;
        }
        
        function hideDepositModal() {
            document.getElementById('deposit-modal').style.display = 'none';
        }
        
        function submitDeposit() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const dateInput = document.getElementById('deposit-date').value;
            const note = document.getElementById('deposit-note').value || '';
            
            if (isNaN(amount) || amount <= 0) {
                notify('‚ùå ◊°◊õ◊ï◊ù ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
                return;
            }
            
            // Hide deposit modal first
            hideDepositModal();
            
            // Open snapshot data modal
            handleDepositWithSnapshot(amount, dateInput, note);
        }

                function showWithdrawalModal() {
            const availableCash = getImplicitCash('all');
            document.getElementById('withdrawal-max').textContent = Math.round(availableCash).toLocaleString();
            document.getElementById('withdrawal-modal').style.display = 'flex';
            document.getElementById('withdrawal-amount').value = '';
            document.getElementById('withdrawal-note').value = '';
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('withdrawal-date').value = today;
        }
        
        function hideWithdrawalModal() {
            document.getElementById('withdrawal-modal').style.display = 'none';
        }
        
        function submitWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const dateInput = document.getElementById('withdrawal-date').value;
            const note = document.getElementById('withdrawal-note').value || '';
            const availableCash = getImplicitCash('all');
            
            if (isNaN(amount) || amount <= 0) {
                notify('‚ùå ◊°◊õ◊ï◊ù ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            if (!dateInput) {
                notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
                return;
            }
            
            if (amount > availableCash) {
                notify(`‚ùå ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊û◊ñ◊ï◊û◊ü. ◊ñ◊û◊ô◊ü: ‚Ç™${Math.round(availableCash).toLocaleString()}`, 'error');
                return;
            }
            
            // Hide withdrawal modal first
            hideWithdrawalModal();
            
            // Open snapshot data modal
            handleWithdrawalWithSnapshot(amount, dateInput, note);
        }

                function deleteDeposit(id) {
            if (!confirm('◊ú◊û◊ó◊ï◊ß ◊î◊§◊ß◊ì◊î ◊ñ◊ï?')) return;
            
            portfolio.deposits = portfolio.deposits.filter(d => d.id !== id);
            // Remove associated snapshot
            const deposit = portfolio.deposits.find(d => d.id === id);
            if (deposit) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify('‚úÖ ◊î◊§◊ß◊ì◊î ◊†◊û◊ó◊ß◊î');
        }
        
        function deleteWithdrawal(id) {
            if (!confirm('◊ú◊û◊ó◊ï◊ß ◊û◊©◊ô◊õ◊î ◊ñ◊ï?')) return;
            
            portfolio.withdrawals = portfolio.withdrawals.filter(w => w.id !== id);
            // Remove associated snapshot
            const withdrawal = portfolio.withdrawals.find(w => w.id === id);
            if (withdrawal) {
                portfolio.snapshots = portfolio.snapshots.filter(s => 
                    !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                );
            }
            
            saveData();
            renderCashFlow();
            
            updateOverview();
            notify('‚úÖ ◊û◊©◊ô◊õ◊î ◊†◊û◊ó◊ß◊î');
        }
        
                function renderCashFlow() {
            // ============================================
            // ◊™◊¶◊ï◊í◊™ ◊ô◊™◊®◊ï◊™ ◊û◊ñ◊ï◊û◊ü (3 ◊û◊ò◊ë◊¢◊ï◊™)
            // ============================================
            // ◊û◊©◊™◊û◊©◊ô◊ù ◊ë-portfolio.cash ◊©◊û◊õ◊ô◊ú ◊ê◊™ ◊õ◊ú ◊î◊ô◊™◊®◊ï◊™ ◊õ◊ï◊ú◊ú ◊î◊û◊®◊ï◊™ ◊û◊ò◊ë◊¢
            
            // ◊ê◊™◊ó◊ú portfolio.cash ◊ê◊ù ◊ú◊ê ◊ß◊ô◊ô◊ù
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            
            console.log('üí∞ Cash balances by currency:', cashBalances);
            
            const cashHtml = `
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <h3 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        üí∞ ◊ô◊™◊®◊ï◊™ ◊û◊ñ◊ï◊û◊ü ◊ñ◊û◊ô◊ü
                        <button onclick="showCurrencyExchange()" style="margin-right: auto; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üîÑ ◊î◊û◊®◊™ ◊û◊ò◊ë◊¢
                        </button>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">◊©◊ß◊ú◊ô◊ù (‚Ç™)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">‚Ç™${Math.round(cashBalances.ILS).toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">◊ì◊ï◊ú◊® ($)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">$${cashBalances.USD.toFixed(2)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">◊ô◊ï◊®◊ï (‚Ç¨)</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">‚Ç¨${cashBalances.EUR.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            const cashContainer = document.getElementById('cash-balances-container');
            if (cashContainer) {
                cashContainer.innerHTML = cashHtml;
            }
            
            // ============================================
            // ◊ò◊ë◊ú◊™ ◊î◊§◊ß◊ì◊ï◊™
            // ============================================
            const depositsContainer = document.getElementById('deposits-list');
            if (portfolio.deposits.length === 0) {
                depositsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">◊ê◊ô◊ü ◊î◊§◊ß◊ì◊ï◊™ ◊¢◊ì◊ô◊ô◊ü</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #d1fae5;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊õ◊ï◊ù</th><th>◊°◊ï◊í</th><th>◊î◊¢◊®◊î</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.deposits].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalDep = 0;
                sorted.forEach(d => {
                    const amount = parseFloat(d.amount);
                    if (!d.amount || isNaN(amount) || amount <= 0) return;
                    totalDep += amount;
                    
                    const date = new Date(d.date).toLocaleDateString('he-IL');
                    const typeText = d.assetType === 'bonds' ? '◊ê◊í\"◊ó' : '◊û◊†◊ô◊ï◊™';
                    html += `<tr style="border-bottom: 1px solid #d1fae5;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: var(--profit); font-weight: bold;">+‚Ç™${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: var(--text-secondary);">${d.note || '-'}</td>
                        <td><button onclick="deleteDeposit(${d.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">◊û◊ó◊ß</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #a7f3d0; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">◊°◊î\"◊õ ◊î◊§◊ß◊ì◊ï◊™</td>
                    <td style="color: #059669;">+‚Ç™${Math.round(totalDep).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                depositsContainer.innerHTML = html;
            }
            
            // ============================================
            // ◊ò◊ë◊ú◊™ ◊û◊©◊ô◊õ◊ï◊™
            // ============================================
            const withdrawalsContainer = document.getElementById('withdrawals-list');
            if (portfolio.withdrawals.length === 0) {
                withdrawalsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">◊ê◊ô◊ü ◊û◊©◊ô◊õ◊ï◊™ ◊¢◊ì◊ô◊ô◊ü</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #fee2e2;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊õ◊ï◊ù</th><th>◊°◊ï◊í</th><th>◊î◊¢◊®◊î</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead><tbody>';
                
                const sorted = [...portfolio.withdrawals].sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalWith = 0;
                sorted.forEach(w => {
                    const amount = parseFloat(w.amount);
                    if (!w.amount || isNaN(amount) || amount <= 0) return;
                    totalWith += amount;
                    
                    const date = new Date(w.date).toLocaleDateString('he-IL');
                    const typeText = w.assetType === 'bonds' ? '◊ê◊í\"◊ó' : '◊û◊†◊ô◊ï◊™';
                    html += `<tr style="border-bottom: 1px solid #fee2e2;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="color: var(--loss); font-weight: bold;">-‚Ç™${Math.round(amount).toLocaleString()}</td>
                        <td>${typeText}</td>
                        <td style="color: var(--text-secondary);">${w.note || '-'}</td>
                        <td><button onclick="deleteWithdrawal(${w.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">◊û◊ó◊ß</button></td>
                    </tr>`;
                });
                html += `<tfoot><tr style="background: #fecaca; font-weight: bold; font-size: 1.1rem;">
                    <td style="padding: 12px;">◊°◊î\"◊õ ◊û◊©◊ô◊õ◊ï◊™</td>
                    <td style="color: #dc2626;">-‚Ç™${Math.round(totalWith).toLocaleString()}</td>
                    <td colspan="3"></td>
                </tr></tfoot>`;
                html += '</tbody></table>';
                withdrawalsContainer.innerHTML = html;
            }
            
            // Summary
            const totalDeposits = portfolio.deposits.reduce((sum, d) => {
                const amount = parseFloat(d.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => {
                const amount = parseFloat(w.amount);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            const netCapital = totalDeposits - totalWithdrawals;
            const availableCash = getImplicitCash('all');
            
            // ◊¢◊ì◊õ◊ü ◊ê◊™ ◊î◊°◊ô◊õ◊ï◊ù ◊ë◊ò◊ê◊ë ◊™◊ñ◊®◊ô◊ù ◊õ◊°◊§◊ô
            const el1 = document.getElementById('total-deposits');
            if (el1) el1.textContent = Math.round(totalDeposits).toLocaleString();
            
            const el2 = document.getElementById('total-withdrawals');
            if (el2) el2.textContent = Math.round(totalWithdrawals).toLocaleString();
            
            // ◊¢◊ì◊õ◊ü ◊í◊ù ◊ê◊™ ◊î◊°◊ß◊ô◊®◊î ◊î◊õ◊ú◊ú◊ô◊™
            const el1b = document.getElementById('overview-total-deposits');
            if (el1b) el1b.textContent = `‚Ç™${Math.round(totalDeposits).toLocaleString()}`;
            
            const el2b = document.getElementById('overview-total-withdrawals');
            if (el2b) el2b.textContent = `‚Ç™${Math.round(totalWithdrawals).toLocaleString()}`;
            
            const el3 = document.getElementById('net-capital');
            if (el3) el3.textContent = Math.round(netCapital).toLocaleString();
            
            const el4 = document.getElementById('available-cash');
            if (el4) el4.textContent = Math.round(availableCash).toLocaleString();
        }
        
        let currentTransactionFilter = 'all';
        
        function filterTransactions(type) {
            currentTransactionFilter = type;
            
            // Update button styles
            ['all', 'deposits', 'withdrawals', 'purchases', 'sales'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (btn) {
                    btn.className = t === type ? 'btn btn-primary' : 'btn';
                }
            });
            
            renderTransactions();
        }
        
        function renderTransactions() {
            const container = document.getElementById('transactions-list');
            
            // Collect all transactions
            let transactions = [];
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'deposits') {
                portfolio.deposits.forEach(d => {
                    transactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        amount: d.amount,
                        note: d.note || '-',
                        assetType: d.assetType,
                        icon: 'üì•',
                        color: '#10b981'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'withdrawals') {
                portfolio.withdrawals.forEach(w => {
                    transactions.push({
                        id: w.id,
                        date: w.date,
                        type: 'withdrawal',
                        amount: -w.amount,
                        note: w.note || '-',
                        assetType: w.assetType,
                        icon: 'üì§',
                        color: '#ef4444'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'purchases') {
                portfolio.purchases.forEach(p => {
                    transactions.push({
                        id: p.id,
                        date: p.date,
                        type: 'purchase',
                        amount: -p.amount,
                        note: p.note || p.symbol || '-',
                        assetType: p.assetType,
                        icon: 'üõí',
                        color: '#3b82f6'
                    });
                });
            }
            
            if (currentTransactionFilter === 'all' || currentTransactionFilter === 'sales') {
                portfolio.sales.forEach(s => {
                    transactions.push({
                        id: s.id,
                        date: s.date,
                        type: 'sale',
                        amount: s.amount,
                        profit: s.profit,
                        note: `${s.symbol || s.fundName} (◊®◊ï◊ï◊ó: ${s.profit >= 0 ? '+' : ''}‚Ç™${Math.round(s.profit).toLocaleString()})`,
                        assetType: s.assetType,
                        icon: 'üí∏',
                        color: '#f59e0b'
                    });
                });
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">◊ê◊ô◊ü ◊¢◊°◊ß◊ê◊ï◊™ ◊ú◊î◊¶◊í◊î</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f3f4f6;"><th style="padding: 10px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊ï◊í</th><th>◊†◊õ◊°</th><th>◊™◊ô◊ê◊ï◊®</th><th>◊°◊õ◊ï◊ù</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead>';
            html += '<tbody>';
            
            transactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const typeText = {
                    'deposit': '◊î◊§◊ß◊ì◊î',
                    'withdrawal': '◊û◊©◊ô◊õ◊î',
                    'purchase': '◊ß◊†◊ô◊ô◊î',
                    'sale': '◊û◊õ◊ô◊®◊î'
                }[t.type];
                const assetText = t.assetType === 'bonds' ? '◊ê◊í"◊ó' : '◊û◊†◊ô◊ï◊™';
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px;">${date}</td>
                    <td style="color: ${t.color};">${t.icon} ${typeText}</td>
                    <td>${assetText}</td>
                    <td style="color: var(--text-secondary);">${t.note}</td>
                    <td style="font-weight: bold; color: ${t.amount >= 0 ? '#10b981' : '#ef4444'};">
                        ${t.amount >= 0 ? '+' : ''}‚Ç™${Math.round(Math.abs(t.amount)).toLocaleString()}
                    </td>
                    <td>
                        ${t.type === 'purchase' || t.type === 'sale' ? 
                            `<button onclick="showEditTransactionDate('${t.type}', ${t.id})" 
                                style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px;">
                                ‚úèÔ∏è ◊¢◊®◊ï◊ö ◊™◊ê◊®◊ô◊ö
                            </button>
                            <span style="color: #9ca3af; font-size: 0.85rem;">◊™◊ß◊ü ◊§◊®◊ò◊ô◊ù ◊ë◊ò◊ê◊ë ◊î◊ó◊ñ◊ß◊ï◊™</span>` :
                            `<button onclick="showEditTransactionDate('${t.type}', ${t.id})" 
                                style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTransaction('${t.type}', ${t.id})" 
                                style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            ◊û◊ó◊ß
                        </button>`}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function deleteTransaction(type, id) {
            // ‚ö†Ô∏è SAFETY: Only allow deleting deposits and withdrawals
            // Purchases and sales are too complex to safely delete
            if (type === 'purchase' || type === 'sale') {
                notify('‚ö†Ô∏è ◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊û◊ó◊ï◊ß ◊ß◊†◊ô◊ï◊™ ◊ê◊ï ◊û◊õ◊ô◊®◊ï◊™ ◊û◊î◊ò◊ë◊ú◊î\n\n◊ê◊ù ◊¶◊®◊ô◊ö ◊ú◊™◊ß◊ü, ◊î◊©◊™◊û◊© ◊ë◊õ◊§◊™◊ï◊® ‚úèÔ∏è ◊¢◊®◊ï◊ö ◊ë◊ò◊ê◊ë ◊î◊ó◊ñ◊ß◊ï◊™', 'error');
                return;
            }
            
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊¢◊°◊ß◊î ◊ñ◊ï?')) return;
            
            let found = false;
            
            switch(type) {
                case 'deposit':
                    const depositIndex = portfolio.deposits.findIndex(d => d.id === id);
                    if (depositIndex !== -1) {
                        const deposit = portfolio.deposits[depositIndex];
                        
                        portfolio.deposits.splice(depositIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'deposit' && Math.abs(new Date(s.date) - new Date(deposit.date)) < 1000)
                        );
                        
                        console.log(`‚úÖ ◊î◊§◊ß◊ì◊î ◊†◊û◊ó◊ß◊î: ‚Ç™${deposit.amount.toFixed(2)}`);
                        found = true;
                    }
                    break;
                    
                case 'withdrawal':
                    const withdrawalIndex = portfolio.withdrawals.findIndex(w => w.id === id);
                    if (withdrawalIndex !== -1) {
                        const withdrawal = portfolio.withdrawals[withdrawalIndex];
                        
                        portfolio.withdrawals.splice(withdrawalIndex, 1);
                        
                        // Remove associated snapshot
                        portfolio.snapshots = portfolio.snapshots.filter(s => 
                            !(s.triggerType === 'withdrawal' && Math.abs(new Date(s.date) - new Date(withdrawal.date)) < 1000)
                        );
                        
                        console.log(`‚úÖ ◊û◊©◊ô◊õ◊î ◊†◊û◊ó◊ß◊î: ‚Ç™${withdrawal.amount.toFixed(2)}`);
                        found = true;
                    }
                    break;
            }
            
            if (found) {
                saveData();
                renderCashFlow();
                renderTransactions();
                updateOverview();
                notify('‚úÖ ◊î◊¢◊°◊ß◊î ◊†◊û◊ó◊ß◊î ◊ë◊î◊¶◊ú◊ó◊î', 'success');
            } else {
                notify('‚ùå ◊î◊¢◊°◊ß◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
            }
        }
        
        // ===========================================
        // EDIT TRANSACTION DATE
        // ===========================================
        let editingTransaction = { type: null, id: null };
        
        function showEditTransactionDate(type, id) {
            editingTransaction = { type, id };
            
            // Find the transaction
            let transaction = null;
            let typeText = '';
            
            switch(type) {
                case 'deposit':
                    transaction = portfolio.deposits.find(d => d.id === id);
                    typeText = '◊î◊§◊ß◊ì◊î';
                    break;
                case 'withdrawal':
                    transaction = portfolio.withdrawals.find(w => w.id === id);
                    typeText = '◊û◊©◊ô◊õ◊î';
                    break;
                case 'purchase':
                    transaction = portfolio.purchases.find(p => p.id === id);
                    typeText = '◊ß◊†◊ô◊ô◊î';
                    break;
                case 'sale':
                    transaction = portfolio.sales.find(s => s.id === id);
                    typeText = '◊û◊õ◊ô◊®◊î';
                    break;
            }
            
            if (!transaction) {
                notify('‚ùå ◊¢◊°◊ß◊î ◊ú◊ê ◊†◊û◊¶◊ê◊î', 'error');
                return;
            }
            
            // Set modal content
            document.getElementById('edit-date-type').textContent = typeText;
            const currentDate = new Date(transaction.date).toLocaleDateString('he-IL');
            document.getElementById('edit-date-current').textContent = currentDate;
            document.getElementById('edit-date-new').value = new Date(transaction.date).toISOString().split('T')[0];
            
            // Show modal
            document.getElementById('edit-date-modal').style.display = 'flex';
        }
        
        function hideEditDateModal() {
            document.getElementById('edit-date-modal').style.display = 'none';
            editingTransaction = { type: null, id: null };
        }
        
        function submitEditDate() {
            const newDate = document.getElementById('edit-date-new').value;
            
            if (!newDate) {
                notify('‚ùå ◊ê◊†◊ê ◊ë◊ó◊® ◊™◊ê◊®◊ô◊ö', 'error');
                return;
            }
            
            // Find and update the transaction
            let transaction = null;
            const { type, id } = editingTransaction;
            
            switch(type) {
                case 'deposit':
                    transaction = portfolio.deposits.find(d => d.id === id);
                    break;
                case 'withdrawal':
                    transaction = portfolio.withdrawals.find(w => w.id === id);
                    break;
                case 'purchase':
                    transaction = portfolio.purchases.find(p => p.id === id);
                    break;
                case 'sale':
                    transaction = portfolio.sales.find(s => s.id === id);
                    break;
            }
            
            if (transaction) {
                // Convert date to ISO format
                const isoDate = new Date(newDate + 'T12:00:00.000Z').toISOString();
                transaction.date = isoDate;
                
                // Also update associated snapshot if exists
                if (type === 'deposit' || type === 'withdrawal') {
                    const snapshot = portfolio.snapshots.find(s => 
                        s.triggerType === type && Math.abs(new Date(s.date) - new Date(transaction.date)) < 86400000 // 1 day tolerance
                    );
                    if (snapshot) {
                        snapshot.date = isoDate;
                    }
                }
                
                saveData();
                renderTransactions();
                renderCashFlow();
                updateOverview();
                
                notify('‚úÖ ◊™◊ê◊®◊ô◊ö ◊¢◊ï◊ì◊õ◊ü ◊ë◊î◊¶◊ú◊ó◊î', 'success');
                hideEditDateModal();
            } else {
                notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü ◊î◊™◊ê◊®◊ô◊ö', 'error');
            }
        }
        
        // ===========================================
        // ===========================================
        // DATA MIGRATION
        // ===========================================
        
        function migrateOldData() {
            let migrated = false;
            
            // Migrate capitalMovements to deposits/withdrawals
            if (portfolio.capitalMovements && portfolio.capitalMovements.length > 0) {
                console.log('üîÑ Migrating capitalMovements...');
                
                portfolio.capitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id,
                            date: m.date,
                            amount: m.amount,
                            assetType: 'stocks',
                            note: m.note || '◊û◊ô◊í◊®◊¶◊ô◊î'
                        });
                        createSnapshot('deposit', m.note || '◊û◊ô◊í◊®◊¶◊ô◊î');
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id,
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'stocks',
                            note: m.note || '◊û◊ô◊í◊®◊¶◊ô◊î'
                        });
                        createSnapshot('withdrawal', m.note || '◊û◊ô◊í◊®◊¶◊ô◊î');
                    }
                });
                
                delete portfolio.capitalMovements;
                migrated = true;
            }
            
            // Migrate bondsCapitalMovements
            if (portfolio.bondsCapitalMovements && portfolio.bondsCapitalMovements.length > 0) {
                portfolio.bondsCapitalMovements.forEach(m => {
                    if (m.amount > 0) {
                        portfolio.deposits.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: m.amount,
                            assetType: 'bonds',
                            note: m.note || '◊û◊ô◊í◊®◊¶◊ô◊î'
                        });
                    } else if (m.amount < 0) {
                        portfolio.withdrawals.push({
                            id: m.id || Date.now(),
                            date: m.date,
                            amount: Math.abs(m.amount),
                            assetType: 'bonds',
                            note: m.note || '◊û◊ô◊í◊®◊¶◊ô◊î'
                        });
                    }
                });
                
                delete portfolio.bondsCapitalMovements;
                migrated = true;
            }
            
            // Migrate bondsSales
            if (portfolio.bondsSales && portfolio.bondsSales.length > 0) {
                portfolio.bondsSales.forEach(bs => {
                    portfolio.sales.push({
                        id: bs.id,
                        date: bs.date,
                        amount: bs.units * bs.salePrice,
                        profit: bs.profit,
                        assetType: 'bonds',
                        fundName: bs.fundName,
                        units: bs.units,
                        salePrice: bs.salePrice,
                        costBasis: bs.costBasis
                    });
                });
                
                delete portfolio.bondsSales;
                migrated = true;
            }
            
            // Migrate portfolioSnapshots
            if (portfolio.portfolioSnapshots && portfolio.portfolioSnapshots.length > 0) {
                portfolio.portfolioSnapshots.forEach(ps => {
                    portfolio.snapshots.push({
                        id: ps.id,
                        date: ps.date,
                        stocksValue: ps.stocksValue || 0,
                        bondsValue: ps.bondsValue || 0,
                        implicitCash: 0,
                        totalValue: ps.totalValue,
                        triggerType: ps.triggerType,
                        triggerNote: ps.triggerNote || ''
                    });
                });
                
                delete portfolio.portfolioSnapshots;
                migrated = true;
            }
            
            if (migrated) {
                saveData();
                console.log('‚úÖ Migration completed');
                notify('üîÑ ◊†◊™◊ï◊†◊ô◊ù ◊î◊ï◊û◊®◊ï');
            }
        }
        
        function addCapitalMovement() {
            const amountStr = prompt('◊î◊õ◊†◊° ◊°◊õ◊ï◊ù:\n(◊ó◊ô◊ï◊ë◊ô ◊ú◊î◊§◊ß◊ì◊î, ◊©◊ú◊ô◊ú◊ô ◊ú◊û◊©◊ô◊õ◊î)');
            if (!amountStr) return;
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount === 0) {
                notify('‚ùå ◊°◊õ◊ï◊ù ◊ú◊ê ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            const note = prompt('◊î◊¢◊®◊î (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô):') || '';
            
            // üì∏ Create snapshot BEFORE adding the capital movement
            const typeText = amount > 0 ? '◊î◊§◊ß◊ì◊î' : '◊û◊©◊ô◊õ◊î';
            createPortfolioSnapshot(amount > 0 ? 'deposit' : 'withdrawal', `◊û◊†◊ô◊ï◊™: ${typeText} ‚Ç™${Math.abs(amount).toLocaleString()}`);
            
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: amount,
                type: amount > 0 ? 'deposit' : 'withdrawal',
                note: note
            });
            
            saveData();
            renderCapitalMovements();
            updateOverview();
            
            notify(`‚úÖ ${typeText} ◊©◊ú ‚Ç™${Math.abs(amount).toLocaleString()} ◊†◊®◊©◊û◊î`);
        }
        
        function deleteCapitalMovement(id) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊™◊†◊ï◊¢◊î ◊ñ◊ï?')) return;
            
            portfolio.capitalMovements = portfolio.capitalMovements.filter(m => m.id !== id);
            saveData();
            renderCapitalMovements();
            updateOverview();
            notify('‚úÖ ◊™◊†◊ï◊¢◊î ◊†◊û◊ó◊ß◊î');
        }
        
        function renderCapitalMovements() {
            const container = document.getElementById('capital-movements-list');
            if (!container) return;
            
            if (!portfolio.capitalMovements || portfolio.capitalMovements.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">◊ê◊ô◊ü ◊™◊†◊ï◊¢◊ï◊™ ◊î◊ï◊ü</p>';
                return;
            }
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f0f0f0;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊õ◊ï◊ù</th><th>◊°◊ï◊í</th><th>◊î◊¢◊®◊î</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead>';
            html += '<tbody>';
            
            const sorted = [...portfolio.capitalMovements].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(m => {
                const date = new Date(m.date).toLocaleDateString('he-IL');
                const amount = m.amount >= 0 ? `+‚Ç™${m.amount.toLocaleString()}` : `-‚Ç™${Math.abs(m.amount).toLocaleString()}`;
                const color = m.amount >= 0 ? 'green' : 'red';
                const typeText = m.type === 'deposit' ? '◊î◊§◊ß◊ì◊î' : '◊û◊©◊ô◊õ◊î';
                
                html += `<tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${date}</td>
                    <td style="color: ${color}; font-weight: bold;">${amount}</td>
                    <td>${typeText}</td>
                    <td style="color: #666;">${m.note || '-'}</td>
                    <td><button onclick="deleteCapitalMovement(${m.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">◊û◊ó◊ß</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Add summary
            const totalCapital = portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0);
            html += `<div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center;">
                <strong>◊°◊î"◊õ ◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô: ‚Ç™${totalCapital.toLocaleString()}</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderSalesHistory() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            const hasStockSales = portfolio.sales && portfolio.sales.length > 0;
            const hasBondSales = portfolio.bondsSales && portfolio.bondsSales.length > 0;
            
            if (!hasStockSales && !hasBondSales) {
                container.innerHTML = '<p style="text-align: center; color: #999;">◊ê◊ô◊ü ◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊û◊õ◊ô◊®◊ï◊™</p>';
                return;
            }
            
            let html = '';
            
            // ◊û◊õ◊ô◊®◊ï◊™ ◊û◊†◊ô◊ï◊™
            if (hasStockSales) {
                html += '<h4 style="margin-bottom: 15px; color: #3b82f6;">üìà ◊û◊õ◊ô◊®◊ï◊™ ◊û◊†◊ô◊ï◊™</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊ô◊û◊ï◊ú</th><th>◊õ◊û◊ï◊™</th><th>◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î</th><th>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î</th><th>◊®◊ï◊ï◊ó/◊î◊§◊°◊ì</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead>';
                html += '<tbody>';
                
                const sortedStocks = [...portfolio.sales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedStocks = 0;
                sortedStocks.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitText = `${getCurrencySymbol(s.currency)}${s.profit.toFixed(2)} (${s.profitPercent}%)`;
                    
                    // Convert to ILS for total
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    totalRealizedStocks += s.profit * rate;
                    
                    html += `<tr style="border-bottom: 1px solid #dbeafe;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.symbol}</strong></td>
                        <td>${s.shares}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.salePrice.toFixed(2)}</td>
                        <td>${getCurrencySymbol(s.currency)}${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteSale(${s.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #eff6ff; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                    <strong style="color: #1e40af;">◊°◊î"◊õ ◊®◊ï◊ï◊ó ◊û◊û◊ï◊û◊© ◊û◊û◊†◊ô◊ï◊™: ‚Ç™${Math.round(totalRealizedStocks).toLocaleString()}</strong>
                </div>`;
            }
            
            // ◊û◊õ◊ô◊®◊ï◊™ ◊ê◊í"◊ó
            if (hasBondSales) {
                html += '<h4 style="margin-bottom: 15px; color: var(--warning);">üíº ◊û◊õ◊ô◊®◊ï◊™ ◊ê◊í"◊ó</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
                html += '<thead><tr style="background: #fef3c7;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊©◊ù ◊ß◊®◊ü</th><th>◊ô◊ó◊ô◊ì◊ï◊™</th><th>◊û◊ó◊ô◊® ◊û◊õ◊ô◊®◊î</th><th>◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î</th><th>◊®◊ï◊ï◊ó/◊î◊§◊°◊ì</th><th>◊§◊¢◊ï◊ú◊ï◊™</th></tr></thead>';
                html += '<tbody>';
                
                const sortedBonds = [...portfolio.bondsSales].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let totalRealizedBonds = 0;
                sortedBonds.forEach(s => {
                    const date = new Date(s.date).toLocaleDateString('he-IL');
                    const color = s.profit >= 0 ? 'green' : 'red';
                    const profitPercent = ((s.salePrice - s.costBasis) / s.costBasis * 100).toFixed(2);
                    const profitText = `‚Ç™${s.profit.toFixed(2)} (${profitPercent}%)`;
                    
                    totalRealizedBonds += s.profit;
                    
                    html += `<tr style="border-bottom: 1px solid #fde68a;">
                        <td style="padding: 8px;">${date}</td>
                        <td><strong>${s.fundName}</strong></td>
                        <td>${s.units}</td>
                        <td>‚Ç™${s.salePrice.toFixed(2)}</td>
                        <td>‚Ç™${s.costBasis.toFixed(2)}</td>
                        <td style="color: ${color}; font-weight: bold;">${profitText}</td>
                        <td><button onclick="deleteBondSale(${s.id})" style="background: var(--loss); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-bottom: 20px; padding: 10px; background: #fef3c7; border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                    <strong style="color: #92400e;">◊°◊î"◊õ ◊®◊ï◊ï◊ó ◊û◊û◊ï◊û◊© ◊û◊ê◊í"◊ó: ‚Ç™${Math.round(totalRealizedBonds).toLocaleString()}</strong>
                </div>`;
            }
            
            // ◊°◊ô◊õ◊ï◊ù ◊õ◊ï◊ú◊ú
            if (hasStockSales && hasBondSales) {
                const totalStocks = portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0);
                const totalBonds = portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0);
                const grandTotal = totalStocks + totalBonds;
                
                html += `<div style="padding: 15px; background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-radius: 8px; text-align: center; border: 2px solid #8b5cf6;">
                    <strong style="color: #5b21b6; font-size: 1.2rem;">üí∞ ◊°◊î"◊õ ◊®◊ï◊ï◊ó ◊û◊û◊ï◊û◊© ◊õ◊ï◊ú◊ú: ‚Ç™${Math.round(grandTotal).toLocaleString()}</strong>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        function renderAllTransactions() {
            const container = document.getElementById('sales-history-list');
            if (!container) return;
            
            // ◊ê◊°◊ï◊£ ◊ê◊™ ◊õ◊ú ◊î◊¢◊°◊ß◊ê◊ï◊™
            const allTransactions = [];
            
            console.log('üìä Transactions:', portfolio.transactions);
            
            // ◊î◊ï◊°◊£ ◊ß◊†◊ô◊ï◊™ ◊û◊†◊ô◊ï◊™ ◊ï◊ê◊í"◊ó
            if (portfolio.transactions && portfolio.transactions.length > 0) {
                portfolio.transactions.forEach(t => {
                    // ◊õ◊ú ◊¢◊°◊ß◊î - ◊í◊ù ◊û◊†◊ô◊ï◊™ ◊ï◊í◊ù ◊ê◊í"◊ó
                    allTransactions.push({
                        ...t,
                        displayType: t.assetType === 'bond' ? 'üíº ◊ê◊í"◊ó' : 'üìà ◊û◊†◊ô◊î',
                        displayAction: t.type === 'buy' ? 'üü¢ ◊ß◊†◊ô◊ô◊î' : 'üî¥ ◊û◊õ◊ô◊®◊î'
                    });
                });
            }
            
            // ◊î◊ï◊°◊£ ◊í◊ù deposits
            if (portfolio.deposits && portfolio.deposits.length > 0) {
                portfolio.deposits.forEach(d => {
                    allTransactions.push({
                        id: d.id,
                        date: d.date,
                        type: 'deposit',
                        assetType: 'cash',
                        symbol: d.note || '◊î◊§◊ß◊ì◊î',
                        shares: d.amount,
                        price: 1,
                        currency: d.currency || 'ILS',
                        displayType: 'üí∞ ◊î◊§◊ß◊ì◊î',
                        displayAction: '‚ûï ◊î◊§◊ß◊ì◊î'
                    });
                });
            }
            
            // ◊û◊ô◊ï◊ü ◊ú◊§◊ô ◊™◊ê◊®◊ô◊ö
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">◊ê◊ô◊ü ◊¢◊°◊ß◊ê◊ï◊™</p>';
                return;
            }
            
            let html = '<h4 style="margin-bottom: 15px;">üìä ◊õ◊ú ◊î◊¢◊°◊ß◊ê◊ï◊™</h4>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">';
            html += '<thead><tr style="background: #eff6ff;"><th style="padding: 8px;">◊™◊ê◊®◊ô◊ö</th><th>◊°◊ï◊í</th><th>◊§◊¢◊ï◊ú◊î</th><th>◊°◊ô◊û◊ï◊ú</th><th>◊õ◊û◊ï◊™</th><th>◊û◊ó◊ô◊®</th><th>◊°◊î"◊õ</th></tr></thead>';
            html += '<tbody>';
            
            allTransactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString('he-IL');
                const currSymbol = getCurrencySymbol(t.currency || 'ILS');
                const total = (t.shares * t.price).toFixed(2);
                const actionColor = t.type === 'buy' ? '#10b981' : '#ef4444';
                
                html += `<tr style="border-bottom: 1px solid #dbeafe;">
                    <td style="padding: 8px;">${date}</td>
                    <td>${t.displayType}</td>
                    <td style="color: ${actionColor}; font-weight: bold;">${t.displayAction}</td>
                    <td><strong>${t.symbol}</strong></td>
                    <td>${t.shares}</td>
                    <td>${currSymbol}${t.price.toFixed(2)}</td>
                    <td>${currSymbol}${total}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
        
        function deleteSale(id) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊û◊õ◊ô◊®◊î ◊ñ◊ï ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î?')) return;
            
            portfolio.sales = portfolio.sales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify('‚úÖ ◊û◊õ◊ô◊®◊î ◊†◊û◊ó◊ß◊î ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î');
        }
        
        function deleteBondSale(id) {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊û◊õ◊ô◊®◊™ ◊ê◊í"◊ó ◊ñ◊ï ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î?')) return;
            
            portfolio.bondsSales = portfolio.bondsSales.filter(s => s.id !== id);
            saveData();
            renderSalesHistory();
            updateCapitalSummary();
            notify('‚úÖ ◊û◊õ◊ô◊®◊™ ◊ê◊í"◊ó ◊†◊û◊ó◊ß◊î ◊û◊î◊î◊ô◊°◊ò◊ï◊®◊ô◊î');
        }
        
        function updateCapitalSummary() {
            const container = document.getElementById('capital-summary');
            if (!container) return;
            
            // === ◊û◊†◊ô◊ï◊™ ===
            const stocksCapital = portfolio.capitalMovements ? 
                portfolio.capitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const stocksValue = getTotalValueILS();
            const stocksRealizedProfit = portfolio.sales ?
                portfolio.sales.reduce((sum, s) => {
                    const rate = s.currency === 'ILS' ? 1 : (portfolio.rates[s.currency] || 1);
                    return sum + (s.profit * rate);
                }, 0) : 0;
            const stocksCost = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            const stocksUnrealizedProfit = stocksValue - stocksCost;
            const stocksTotalProfit = stocksValue - stocksCapital;
            const stocksProfitPercent = stocksCapital > 0 ? (stocksTotalProfit / stocksCapital * 100) : 0;
            
            // === ◊ê◊í"◊ó ===
            const bondsCapital = portfolio.bondsCapitalMovements ?
                portfolio.bondsCapitalMovements.reduce((sum, m) => sum + m.amount, 0) : 0;
            const bondsValue = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0);
            const bondsCost = portfolio.bonds.reduce((sum, b) => sum + (b.units * b.costBasis), 0);
            const bondsRealizedProfit = portfolio.bondsSales ?
                portfolio.bondsSales.reduce((sum, s) => sum + s.profit, 0) : 0;
            const bondsUnrealizedProfit = bondsValue - bondsCost;
            const bondsTotalProfit = bondsValue - bondsCapital;
            const bondsProfitPercent = bondsCapital > 0 ? (bondsTotalProfit / bondsCapital * 100) : 0;
            
            // === ◊°◊î"◊õ ===
            const totalCapital = stocksCapital + bondsCapital;
            const totalValue = stocksValue + bondsValue;
            const totalProfit = totalValue - totalCapital;
            const totalProfitPercent = totalCapital > 0 ? (totalProfit / totalCapital * 100) : 0;
            
            let html = '';
            
            // ◊û◊†◊ô◊ï◊™
            html += `
                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #3b82f6;">
                    <h4 style="margin-bottom: 15px; color: #1e40af;">üìà ◊û◊†◊ô◊ï◊™</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">‚Ç™${stocksCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #1e40af;">‚Ç™${Math.round(stocksValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">◊®◊ï◊ï◊ó ◊û◊û◊ï◊û◊©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">‚Ç™${Math.round(stocksRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">◊®◊ï◊ï◊ó ◊ú◊ê ◊û◊û◊ï◊û◊©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #1e40af;">‚Ç™${Math.round(stocksUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #1e40af; font-size: 0.8rem; margin-bottom: 3px;">üí∞ ◊®◊ï◊ï◊ó ◊õ◊ï◊ú◊ú</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${stocksTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${stocksTotalProfit >= 0 ? '+' : ''}‚Ç™${Math.round(stocksTotalProfit).toLocaleString()} (${stocksProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ◊ê◊í"◊ó
            html += `
                <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 15px; color: #92400e;">üíº ◊ê◊í"◊ó</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">‚Ç™${bondsCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e;">‚Ç™${Math.round(bondsValue).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">◊®◊ï◊ï◊ó ◊û◊û◊ï◊û◊©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">‚Ç™${Math.round(bondsRealizedProfit).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">◊®◊ï◊ï◊ó ◊ú◊ê ◊û◊û◊ï◊û◊©</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e;">‚Ç™${Math.round(bondsUnrealizedProfit).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #92400e; font-size: 0.8rem; margin-bottom: 3px;">üí∞ ◊®◊ï◊ï◊ó ◊õ◊ï◊ú◊ú</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${bondsTotalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${bondsTotalProfit >= 0 ? '+' : ''}‚Ç™${Math.round(bondsTotalProfit).toLocaleString()} (${bondsProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ◊°◊î"◊õ
            html += `
                <div style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); padding: 20px; border-radius: 12px; border: 2px solid #8b5cf6;">
                    <h4 style="margin-bottom: 15px; color: #5b21b6;">üí∞ ◊°◊î"◊õ ◊™◊ô◊ß ◊î◊©◊ß◊¢◊ï◊™</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô ◊õ◊ï◊ú◊ú</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">‚Ç™${totalCapital.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">◊©◊ï◊ï◊ô ◊õ◊ï◊ú◊ú</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #5b21b6;">‚Ç™${Math.round(totalValue).toLocaleString()}</div>
                        </div>
                        <div style="grid-column: span 2;">
                            <div style="color: #5b21b6; font-size: 0.8rem; margin-bottom: 3px;">üíé ◊®◊ï◊ï◊ó ◊õ◊ï◊ú◊ú</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${totalProfit >= 0 ? '#10b981' : '#ef4444'};">
                                ${totalProfit >= 0 ? '+' : ''}‚Ç™${Math.round(totalProfit).toLocaleString()} (${totalProfitPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ◊î◊°◊ë◊®
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.95rem;">üìä ◊î◊°◊ë◊® ◊ó◊ô◊©◊ï◊ë:</h4>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                        <strong>◊®◊ï◊ï◊ó ◊õ◊ï◊ú◊ú = ◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô - ◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô</strong><br>
                        <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; border-right: 3px solid #f59e0b;">
                            üí° <strong>◊ó◊©◊ï◊ë:</strong> ◊î◊ó◊ô◊©◊ï◊ë ◊ú◊ï◊ß◊ó ◊ë◊ó◊©◊ë◊ï◊ü ◊ê◊™ ◊™◊†◊ï◊¢◊ï◊™ ◊î◊î◊ï◊ü (◊î◊§◊ß◊ì◊ï◊™ ◊ï◊û◊©◊ô◊õ◊ï◊™) ◊ï◊ú◊ê ◊ê◊™ ◊¢◊ú◊ï◊™ ◊î◊®◊õ◊ô◊©◊î ◊î◊û◊û◊ï◊¶◊¢◊™.
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // ===========================================
        // CALCULATE CAPITAL FROM HOLDINGS
        // ===========================================
        let selectedHoldings = new Set();
        
        function showCalculateCapitalFromHoldings() {
            if (portfolio.holdings.length === 0) {
                notify('‚ùå ◊ê◊ô◊ü ◊î◊ó◊ñ◊ß◊ï◊™ ◊ë◊™◊ô◊ß', 'error');
                return;
            }
            
            // Reset selection
            selectedHoldings = new Set(portfolio.holdings.map(h => h.id));
            
            // Render checkboxes
            renderHoldingsCheckboxes();
            
            // Show modal
            const modal = document.getElementById('calculate-capital-modal');
            modal.style.display = 'flex';
        }
        
        function hideCalculateCapitalModal() {
            document.getElementById('calculate-capital-modal').style.display = 'none';
        }
        
        function renderHoldingsCheckboxes() {
            const container = document.getElementById('holdings-checkboxes');
            if (!container) return;
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            portfolio.holdings.forEach(h => {
                const cost = h.shares * h.costBasis;
                const costILS = convertToILS(cost, h.currency);
                const checked = selectedHoldings.has(h.id) ? 'checked' : '';
                
                html += `
                    <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid ${checked ? '#3b82f6' : '#e5e7eb'};">
                        <input type="checkbox" ${checked} onchange="toggleHoldingSelection(${h.id})" style="width: 20px; height: 20px; margin-left: 10px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 3px;">${h.symbol}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${h.shares} ◊û◊†◊ô◊ï◊™ √ó ${getCurrencySymbol(h.currency)}${h.costBasis.toFixed(2)} = 
                                <strong>${getCurrencySymbol(h.currency)}${cost.toFixed(2)}</strong>
                                ${h.currency !== 'ILS' ? ` (‚Ç™${Math.round(costILS).toLocaleString()})` : ''}
                            </div>
                        </div>
                    </label>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            updateSelectedCapitalTotal();
        }
        
        function toggleHoldingSelection(id) {
            if (selectedHoldings.has(id)) {
                selectedHoldings.delete(id);
            } else {
                selectedHoldings.add(id);
            }
            renderHoldingsCheckboxes();
        }
        
        function updateSelectedCapitalTotal() {
            let total = 0;
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                }
            });
            
            const display = document.getElementById('selected-capital-total');
            if (display) {
                display.textContent = `‚Ç™${Math.round(total).toLocaleString()}`;
            }
        }
        
        function addCalculatedCapital() {
            if (selectedHoldings.size === 0) {
                notify('‚ùå ◊ë◊ó◊® ◊ú◊§◊ó◊ï◊™ ◊î◊ó◊ñ◊ß◊î ◊ê◊ó◊™', 'error');
                return;
            }
            
            let total = 0;
            const selectedSymbols = [];
            
            selectedHoldings.forEach(id => {
                const holding = portfolio.holdings.find(h => h.id === id);
                if (holding) {
                    const cost = holding.shares * holding.costBasis;
                    total += convertToILS(cost, holding.currency);
                    selectedSymbols.push(holding.symbol);
                }
            });
            
            // Add as capital movement
            if (!portfolio.capitalMovements) portfolio.capitalMovements = [];
            portfolio.capitalMovements.push({
                id: Date.now(),
                date: new Date().toISOString(),
                amount: Math.round(total),
                type: 'deposit',
                note: `◊ó◊ô◊©◊ï◊ë ◊ê◊ï◊ò◊ï◊û◊ò◊ô: ${selectedSymbols.join(', ')}`
            });
            
            saveData();
            renderCapitalMovements();
            updateCapitalSummary();
            hideCalculateCapitalModal();
            
            notify(`‚úÖ ◊†◊ï◊°◊£ ◊î◊ï◊ü ◊û◊ß◊ï◊®◊ô: ‚Ç™${Math.round(total).toLocaleString()}`);
        }
        
        function renderHoldingsList() {
            const container = document.getElementById('holdings-list');
            
            if (!container) {
                console.error('‚ùå Holdings list container not found');
                return;
            }
            
            console.log('üìä Rendering holdings list (Table view). Total:', portfolio.holdings.length);
            
            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">◊ê◊ô◊ü ◊î◊ó◊ñ◊ß◊ï◊™ ◊¢◊ì◊ô◊ô◊ü</p>
                        <p>◊ú◊ó◊• ◊¢◊ú "◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î" ◊õ◊ì◊ô ◊ú◊î◊™◊ó◊ô◊ú</p>
                    </div>
                `;
                return;
            }
            
            // ◊ò◊ë◊ú◊î ◊®◊ï◊ó◊ë◊ô◊™ ◊†◊ß◊ô◊ô◊î
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: var(--bg-surface); border-radius: 12px; overflow: hidden;">';
            html += `<thead style="background: var(--bg-elevated);">
                <tr>
                    <th style="padding: 15px; text-align: right; font-weight: 600; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">◊°◊ô◊û◊ï◊ú</th>
                    <th style="padding: 15px; text-align: right; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊ß◊ë◊ï◊¶◊î</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊û◊†◊ô◊ï◊™</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊û◊ó◊ô◊® ◊ß◊†◊ô◊ô◊î</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊û◊ó◊ô◊® ◊†◊ï◊õ◊ó◊ô</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊©◊ï◊ï◊ô</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊®◊ï◊ï◊ó/◊î◊§◊°◊ì</th>
                    <th style="padding: 15px; text-align: center; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">◊§◊¢◊ï◊ú◊ï◊™</th>
                </tr>
            </thead><tbody>`;
            
            portfolio.holdings.forEach(holding => {
                const holdingGroupId = parseInt(holding.groupId);
                const group = portfolio.groups.find(g => g.id === holdingGroupId);
                
                const currentValue = holding.shares * (holding.currentPrice || holding.costBasis);
                const costValue = holding.shares * holding.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                const profitColor = profit >= 0 ? 'var(--profit)' : 'var(--loss)';
                
                html += `<tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 15px; font-weight: 700; color: var(--text-primary);">
                        ${holding.symbol}
                        ${holding.altTicker ? `<br><span style="font-size: 0.75rem; color: var(--accent);">‚Üí ${holding.altTicker}</span>` : ''}
                        ${holding.isManualPrice ? '<span style="font-size: 0.75rem; color: var(--warning); margin-right: 5px;" title="◊û◊ó◊ô◊® ◊ô◊ì◊†◊ô - ◊û◊ï◊í◊ü">üîí</span>' : ''}
                    </td>
                    <td style="padding: 15px; color: var(--text-secondary);">
                        ${group ? group.name : '◊ú◊ê ◊ô◊ì◊ï◊¢'}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-primary);">
                        ${holding.shares}
                    </td>
                    <td style="padding: 15px; text-align: center; color: var(--text-secondary);">
                        ${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 600; color: var(--text-primary);">
                        ${getCurrencySymbol(holding.currency)}${(holding.currentPrice || holding.costBasis).toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: var(--text-primary);">
                        ${getCurrencySymbol(holding.currency)}${currentValue.toFixed(2)}
                    </td>
                    <td style="padding: 15px; text-align: center; font-weight: 700; color: ${profitColor};">
                        ${profit >= 0 ? '+' : ''}${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}
                        <br>
                        <span style="font-size: 0.85rem;">(${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showAddSharesForm(${holding.id})" class="btn btn-sm" title="◊î◊ï◊°◊£ ◊û◊†◊ô◊ï◊™" style="background: var(--profit); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ‚ûï
                            </button>
                            <button onclick="showSellSharesForm(${holding.id})" class="btn btn-sm" title="◊û◊õ◊ï◊®" style="background: var(--warning); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                üí∏
                            </button>
                            <button onclick="editHolding(${holding.id})" class="btn btn-sm" title="◊¢◊®◊ï◊ö" style="background: var(--info); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="updatePriceManually(${holding.id})" class="btn btn-sm" title="${holding.isManualPrice ? '◊û◊ó◊ô◊® ◊û◊ï◊í◊ü' : '◊¢◊ì◊õ◊ü ◊û◊ó◊ô◊®'}" style="background: var(--accent); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                ${holding.isManualPrice ? 'üîí' : 'üí∞'}
                            </button>
                            <button onclick="deleteHolding(${holding.id})" class="btn btn-sm" title="◊û◊ó◊ß" style="background: var(--loss); color: white; padding: 6px 10px; font-size: 0.8rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ===========================================
        // OVERVIEW
        // ===========================================
        
        function updateOverview() {
            console.log('üîÑ Starting updateOverview...');
            
            // =============================================
            // CALCULATE EVERYTHING FIRST
            // =============================================
            const stocksValue = getTotalValueILS();
            const bondsValue = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => sum + (b.units * b.currentPrice), 0) : 0;
            const bondsCount = Array.isArray(portfolio.bonds) ? portfolio.bonds.length : 0;
            const totalValue = getTotalPortfolioValue();
            
            // ‚úÖ FIX: Calculate available cash from portfolio.cash (includes currency exchanges!)
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            const availableCash = 
                (portfolio.cash.ILS || 0) + 
                convertToILS(portfolio.cash.USD || 0, 'USD') + 
                convertToILS(portfolio.cash.EUR || 0, 'EUR');
            
            console.log('üí∞ Available cash calculation:', {
                ILS: portfolio.cash.ILS,
                USD: portfolio.cash.USD,
                EUR: portfolio.cash.EUR,
                totalILS: availableCash.toFixed(2)
            });
            
            // Deposits & Withdrawals
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            
            // ‚úÖ FIX: Calculate invested amounts from cost basis, not deposits
            const stocksInvested = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            
            const bondsInvested = Array.isArray(portfolio.bonds) ? 
                portfolio.bonds.reduce((sum, b) => {
                    const cost = b.units * b.costBasis;
                    return sum + convertToILS(cost, b.currency || 'ILS');
                }, 0) : 0;
            
            // TWR Calculation
            const totalTWR = calculateTWR('total');
            
            // =============================================
            // UPDATE MAIN TWR HERO
            // =============================================
            if (totalTWR !== null) {
                const color = totalTWR.total >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('main-twr-display').textContent = 
                    `${totalTWR.total >= 0 ? '+' : ''}${totalTWR.total.toFixed(1)}%`;
                document.getElementById('main-twr-display').style.color = color;
                
                // TWR Breakdown (Base + Live)
                if (totalTWR.base !== undefined && totalTWR.live !== undefined) {
                    document.getElementById('twr-breakdown').textContent = 
                        `Base: ${totalTWR.base >= 0 ? '+' : ''}${totalTWR.base.toFixed(1)}% | Live: ${totalTWR.live >= 0 ? '+' : ''}${totalTWR.live.toFixed(1)}%`;
                } else {
                    document.getElementById('twr-breakdown').textContent = '';
                }
                
                // Absolute Profit
                const profit = totalValue - totalDeposits + totalWithdrawals;
                document.getElementById('main-profit-display').textContent = 
                    `${profit >= 0 ? '+' : ''}‚Ç™${Math.round(profit).toLocaleString()}`;
                document.getElementById('main-profit-display').style.color = profit >= 0 ? '#10b981' : '#ef4444';
                
                // Period Info
                if (totalTWR.years !== undefined) {
                    const days = Math.round(totalTWR.years * 365);
                    document.getElementById('twr-period-info').textContent = 
                        `üìÖ ◊û◊™◊ó◊ô◊ú◊™ ◊î◊™◊ô◊ß: ${totalTWR.years.toFixed(1)} ◊©◊†◊ô◊ù (${days} ◊ô◊û◊ô◊ù)`;
                }
            } else {
                document.getElementById('main-twr-display').textContent = '--';
                document.getElementById('twr-breakdown').textContent = '◊¶◊ë◊ï◊® ◊†◊™◊ï◊†◊ô◊ù...';
                document.getElementById('main-profit-display').textContent = '‚Ç™0';
                document.getElementById('twr-period-info').textContent = 'üìÖ ◊î◊ï◊°◊£ ◊î◊§◊ß◊ì◊î ◊ê◊ï ◊û◊©◊ô◊õ◊î ◊ú◊ó◊ô◊©◊ï◊ë TWR';
            }
            
            // =============================================
            // UPDATE STOCKS CARD
            // =============================================
            document.getElementById('stocks-value').textContent = `‚Ç™${Math.round(stocksValue).toLocaleString()}`;
            
            const usdTotal = portfolio.holdings.filter(h => h.currency === 'USD')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            const eurTotal = portfolio.holdings.filter(h => h.currency === 'EUR')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            
            document.getElementById('stocks-value-original').textContent = 
                `$${Math.round(usdTotal).toLocaleString()} + ‚Ç¨${Math.round(eurTotal).toLocaleString()}`;
            
            document.getElementById('stocks-count').textContent = `${portfolio.holdings.length} ◊î◊ó◊ñ◊ß◊ï◊™`;
            document.getElementById('stocks-capital').textContent = `‚Ç™${Math.round(stocksInvested).toLocaleString()}`;
            
            // =============================================
            // UPDATE BONDS CARD
            // =============================================
            document.getElementById('bonds-value').textContent = `‚Ç™${Math.round(bondsValue).toLocaleString()}`;
            document.getElementById('bonds-count').textContent = `${bondsCount} ◊ß◊®◊†◊ï◊™`;
            document.getElementById('bonds-count-num').textContent = `${bondsCount}`;
            document.getElementById('bonds-cost').textContent = `‚Ç™${Math.round(bondsInvested).toLocaleString()}`;
            
            // =============================================
            // UPDATE TOTAL CARD
            // =============================================
            const totalValueEl = document.getElementById('total-value');
            const totalValue2El = document.getElementById('total-value-2');
            const overviewTotalDepositsEl = document.getElementById('overview-total-deposits');
            
            if (totalValueEl) totalValueEl.textContent = `‚Ç™${Math.round(totalValue).toLocaleString()}`;
            if (totalValue2El) totalValue2El.textContent = `‚Ç™${Math.round(totalValue).toLocaleString()}`;
            if (overviewTotalDepositsEl) overviewTotalDepositsEl.textContent = `◊î◊ï◊©◊ß◊¢: ‚Ç™${Math.round(totalDeposits).toLocaleString()}`;
            
            const availableCashOverviewEl = document.getElementById('available-cash-overview');
            if (availableCashOverviewEl) availableCashOverviewEl.textContent = `‚Ç™${Math.round(availableCash).toLocaleString()}`;
            
            // Update last update time
            const now = new Date();
            const lastUpdateTimeEl = document.getElementById('last-update-time');
            if (lastUpdateTimeEl) lastUpdateTimeEl.textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            
            // =============================================
            // UPDATE CASH FLOW SUMMARY
            // =============================================
            const totalDepositsEl = document.getElementById('total-deposits');
            const totalWithdrawalsEl = document.getElementById('total-withdrawals');
            const availableCashSummaryEl = document.getElementById('available-cash-summary');
            
            if (totalDepositsEl) totalDepositsEl.textContent = `‚Ç™${Math.round(totalDeposits).toLocaleString()}`;
            if (totalWithdrawalsEl) totalWithdrawalsEl.textContent = `‚Ç™${Math.round(totalWithdrawals).toLocaleString()}`;
            if (availableCashSummaryEl) availableCashSummaryEl.textContent = `‚Ç™${Math.round(availableCash).toLocaleString()}`;
            
            // =============================================
            // RENDER OTHER SECTIONS
            // =============================================
            renderAllocationComparison();
            renderPortfolioChart();
            updateAnalysisTab();
        }
        
        function renderAllocationComparison() {
            const container = document.getElementById('allocation-comparison');
            const totalValue = getTotalValueILS();
            
            console.log('üìä renderAllocationComparison - Total value:', totalValue);
            console.log('üìä All holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId, groupIdType: typeof h.groupId })));
            
            const html = `<div class="allocation-grid">` + portfolio.groups.map(group => {
                // Handle both string and number groupId
                const groupHoldings = portfolio.holdings.filter(h => {
                    const holdingGroupId = parseInt(h.groupId);
                    return holdingGroupId === group.id;
                });
                
                console.log(`üìÇ Group ${group.name} (ID: ${group.id}):`, {
                    holdings: groupHoldings.length,
                    symbols: groupHoldings.map(h => h.symbol)
                });
                
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    const ilsValue = convertToILS(value, h.currency);
                    console.log(`  - ${h.symbol}: ${h.shares} √ó ${h.currentPrice || h.costBasis} ${h.currency} = ‚Ç™${ilsValue.toFixed(2)}`);
                    return sum + ilsValue;
                }, 0);
                
                console.log(`  Total group value: ‚Ç™${groupValue.toFixed(2)}`);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = actualPercent - group.target;
                
                let statusClass = '';
                let statusIcon = '';
                let statusText = '';
                let diffText = '';
                
                if (Math.abs(diff) < 2) {
                    statusClass = 'balanced';
                    statusIcon = '‚úì';
                    statusText = '◊û◊ê◊ï◊ñ◊ü';
                    diffText = '';
                } else if (diff < 0) {
                    statusClass = 'under';
                    statusIcon = '‚Üì';
                    statusText = '◊ó◊°◊®';
                    diffText = `${Math.abs(diff).toFixed(1)}%`;
                } else {
                    statusClass = 'over';
                    statusIcon = '‚Üë';
                    statusText = '◊¢◊ï◊ì◊£';
                    diffText = `${diff.toFixed(1)}%`;
                }
                
                return `
                    <div class="allocation-row">
                        <div class="allocation-main">
                            <div class="allocation-header">
                                <span class="allocation-name">${group.name}</span>
                                <div class="allocation-numbers">
                                    <span class="allocation-target">
                                        ◊ô◊¢◊ì: <strong>${group.target}%</strong>
                                    </span>
                                    <span class="allocation-actual ${statusClass}">
                                        ${actualPercent.toFixed(1)}%
                                    </span>
                                    <span class="allocation-value">
                                        ‚Ç™${Math.round(groupValue).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <div class="allocation-progress">
                                <div class="allocation-progress-fill ${statusClass}" 
                                     style="width: ${Math.min(actualPercent, 100)}%"></div>
                                <div class="allocation-target-marker" 
                                     style="left: ${group.target}%"></div>
                            </div>
                        </div>
                        <div class="allocation-status ${statusClass}">
                            <div class="allocation-status-icon">${statusIcon}</div>
                            <div class="allocation-status-text">${statusText}</div>
                            ${diffText ? `<div class="allocation-diff">${diffText}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('') + `</div>`;
            
            container.innerHTML = html;
        }
        
        function renderPortfolioChart() {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            const totalValue = getTotalValueILS();
            const data = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                return groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
            });
            
            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: portfolio.groups.map(g => g.name),
                    datasets: [{
                        data: data,
                        backgroundColor: portfolio.groups.map(g => g.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `${context.label}: ‚Ç™${Math.round(value).toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===========================================
        // GROUPS
        // ===========================================
        
        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            const totalValue = getTotalValueILS();
            
            const html = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="group-target">◊ô◊¢◊ì: ${group.target}% | ◊ë◊§◊ï◊¢◊ú: ${actualPercent.toFixed(1)}%</div>
                                <button onclick="editGroup(${group.id})" class="btn btn-primary btn-sm" title="◊¢◊®◊ï◊ö ◊ß◊ë◊ï◊¶◊î">
                                    ‚úèÔ∏è ◊¢◊®◊ï◊ö
                                </button>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%; background: ${group.color}">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="group-holdings" style="margin-top: 15px; display: grid; gap: 10px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const valueILS = convertToILS(value, h.currency);
                                const holdingPercentOfTotal = totalValue > 0 ? (valueILS / totalValue * 100) : 0;
                                const holdingPercentOfGroup = groupValue > 0 ? (valueILS / groupValue * 100) : 0;
                                const positionTarget = group.positionTargets && group.positionTargets[h.symbol];
                                const targetDiff = positionTarget ? (holdingPercentOfGroup - positionTarget) : null;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg-surface); border-radius: 8px; align-items: center; flex-wrap: wrap; gap: 5px;">
                                        <span style="font-weight: 600;">${h.symbol}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                            ‚Ç™${Math.round(valueILS).toLocaleString()} 
                                            <span style="color: ${group.color}; font-weight: 600;">(${holdingPercentOfGroup.toFixed(0)}% ◊û◊î◊ß◊ë◊ï◊¶◊î)</span>
                                            ${positionTarget ? `<span style="color: ${targetDiff >= 0 ? '#10b981' : '#f59e0b'}; font-size: 0.8rem;"> ◊ô◊¢◊ì: ${positionTarget}%</span>` : ''}
                                            <span style="color: #9ca3af;"> | ${holdingPercentOfTotal.toFixed(1)}% ◊û◊î◊™◊ô◊ß</span>
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // RECOMMENDATIONS
        // ===========================================
        
        function editGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // ◊©◊ù ◊î◊ß◊ë◊ï◊¶◊î
            const newName = prompt(`◊¢◊®◊ï◊ö ◊©◊ù ◊ß◊ë◊ï◊¶◊î\n\n◊©◊ù ◊†◊ï◊õ◊ó◊ô: ${group.name}\n\n◊î◊ñ◊ü ◊©◊ù ◊ó◊ì◊©:`, group.name);
            if (newName === null) return;
            if (newName.trim()) group.name = newName.trim();
            
            // ◊ê◊ó◊ï◊ñ ◊ô◊¢◊ì
            const newTarget = prompt(`◊¢◊®◊ï◊ö ◊ê◊ó◊ï◊ñ ◊ô◊¢◊ì\n\n◊ô◊¢◊ì ◊†◊ï◊õ◊ó◊ô: ${group.target}%\n\n◊î◊ñ◊ü ◊ô◊¢◊ì ◊ó◊ì◊© (0-100):`, group.target);
            if (newTarget === null) return;
            const targetNum = parseFloat(newTarget);
            if (!isNaN(targetNum) && targetNum >= 0 && targetNum <= 100) {
                group.target = targetNum;
            }
            
            // ◊¶◊ë◊¢
            const newColor = prompt(`◊¢◊®◊ï◊ö ◊¶◊ë◊¢ ◊ß◊ë◊ï◊¶◊î\n\n◊¶◊ë◊¢ ◊†◊ï◊õ◊ó◊ô: ${group.color}\n\n◊î◊ñ◊ü ◊ß◊ï◊ì ◊¶◊ë◊¢ (HEX):`, group.color);
            if (newColor === null) return;
            if (newColor.trim()) group.color = newColor.trim();
            
            // ◊ô◊¢◊ì◊ô ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™
            const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
            if (groupHoldings.length > 0) {
                const editPositionTargets = confirm(`◊î◊ê◊ù ◊ë◊®◊¶◊ï◊†◊ö ◊ú◊î◊í◊ì◊ô◊® ◊ô◊¢◊ì◊ô◊ù ◊ú◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊ë◊ß◊ë◊ï◊¶◊î ◊ñ◊ï?\n\n◊ô◊¢◊ì◊ô◊ù ◊û◊ê◊§◊©◊®◊ô◊ù ◊ú◊ö ◊ú◊ß◊ë◊ï◊¢ ◊ê◊ô◊ñ◊î ◊ê◊ó◊ï◊ñ ◊õ◊ú ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊¶◊®◊ô◊õ◊î ◊ú◊î◊ï◊ï◊™ ◊û◊™◊ï◊ö ◊î◊ß◊ë◊ï◊¶◊î.\n\n◊ú◊ó◊• ◊ê◊ô◊©◊ï◊® ◊ú◊î◊í◊ì◊ô◊® ◊ô◊¢◊ì◊ô◊ù, ◊ë◊ô◊ò◊ï◊ú ◊ú◊ì◊ú◊í.`);
                
                if (editPositionTargets) {
                    // ◊ê◊™◊ó◊ï◊ú ◊û◊ë◊†◊î ◊ô◊¢◊ì◊ô ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊ê◊ù ◊ú◊ê ◊ß◊ô◊ô◊ù
                    if (!group.positionTargets) {
                        group.positionTargets = {};
                    }
                    
                    // ◊¢◊ë◊ï◊® ◊¢◊ú ◊õ◊ú ◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊ï◊ë◊ß◊© ◊ô◊¢◊ì
                    for (const holding of groupHoldings) {
                        const currentTarget = group.positionTargets[holding.symbol] || '';
                        const targetPrompt = prompt(
                            `◊î◊í◊ì◊® ◊ô◊¢◊ì ◊ú-${holding.symbol}\n\n` +
                            `(◊î◊©◊ê◊® ◊®◊ô◊ß ◊ê◊ù ◊ê◊ô◊ü ◊ô◊¢◊ì ◊°◊§◊¶◊ô◊§◊ô)\n` +
                            `◊î◊ô◊¢◊ì ◊ë◊ê◊ó◊ï◊ñ◊ô◊ù ◊û◊™◊ï◊ö ◊î◊ß◊ë◊ï◊¶◊î (0-100):`,
                            currentTarget
                        );
                        
                        if (targetPrompt === null) {
                            // ◊î◊û◊©◊™◊û◊© ◊ú◊ó◊• Cancel - ◊¢◊¶◊ï◊® ◊ê◊™ ◊õ◊ú ◊î◊™◊î◊ú◊ô◊ö
                            break;
                        }
                        
                        if (targetPrompt.trim() === '') {
                            // ◊ê◊ù ◊®◊ô◊ß, ◊û◊ó◊ß ◊ê◊™ ◊î◊ô◊¢◊ì
                            delete group.positionTargets[holding.symbol];
                        } else {
                            const posTarget = parseFloat(targetPrompt);
                            if (!isNaN(posTarget) && posTarget >= 0 && posTarget <= 100) {
                                group.positionTargets[holding.symbol] = posTarget;
                            }
                        }
                    }
                    
                    // ◊ë◊ì◊ô◊ß◊™ ◊°◊î"◊õ ◊ô◊¢◊ì◊ô◊ù
                    const totalTargets = Object.values(group.positionTargets).reduce((sum, t) => sum + t, 0);
                    if (totalTargets > 100) {
                        notify(`‚ö†Ô∏è ◊©◊ô◊ù ◊ú◊ë: ◊°◊î"◊õ ◊ô◊¢◊ì◊ô ◊î◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ (${totalTargets.toFixed(0)}%) ◊¢◊ï◊ú◊î ◊¢◊ú 100%`, 'warning');
                    }
                }
            }
            
            saveData();
            renderGroupsList();
            updateOverview();
            notify(`‚úÖ ◊ß◊ë◊ï◊¶◊î "${group.name}" ◊¢◊ï◊ì◊õ◊†◊î`);
        }
        
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            const totalValue = getTotalValueILS();
            
            const recommendations = [];
            
            portfolio.groups.forEach(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = group.target - actualPercent;
                
                if (Math.abs(diff) > 2) {
                    recommendations.push({
                        group: group.name,
                        diff: diff,
                        action: diff > 0 ? 'buy' : 'sell'
                    });
                }
            });
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üéâ</div>
                        <h3 style="color: var(--profit); margin-bottom: 10px;">◊î◊™◊ô◊ß ◊û◊ê◊ï◊ñ◊ü ◊û◊¶◊ï◊ô◊ü!</h3>
                        <p style="color: var(--text-secondary);">◊õ◊ú ◊î◊ß◊ë◊ï◊¶◊ï◊™ ◊ß◊®◊ï◊ë◊ï◊™ ◊ú◊ô◊¢◊ì ◊©◊ú◊î◊ü</p>
                    </div>
                `;
                return;
            }
            
            const html = recommendations.map(rec => {
                const color = rec.action === 'buy' ? '#fef3c7' : '#fee2e2';
                const textColor = rec.action === 'buy' ? '#92400e' : '#991b1b';
                const icon = rec.action === 'buy' ? 'üí∞' : 'üìâ';
                const actionText = rec.action === 'buy' ? '◊ß◊†◊î' : '◊û◊õ◊ï◊®';
                
                return `
                    <div class="glass" style="background: ${color}; border: 2px solid ${textColor}40; margin-bottom: 15px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2rem;">${icon}</span>
                            <h4 style="color: ${textColor};">${actionText} ${rec.group}</h4>
                        </div>
                        <p style="color: ${textColor};">
                            ${rec.action === 'buy' 
                                ? `◊î◊ß◊ë◊ï◊¶◊î ◊ó◊°◊®◊î ${Math.abs(rec.diff).toFixed(1)}% ◊û◊î◊ô◊¢◊ì. ◊ë◊ß◊†◊ô◊î ◊î◊ë◊ê◊î, ◊î◊™◊û◊ß◊ì ◊ë◊ß◊ë◊ï◊¶◊î ◊ñ◊ï.`
                                : `◊î◊ß◊ë◊ï◊¶◊î ◊¢◊ï◊ì◊§◊™ ◊ë-${Math.abs(rec.diff).toFixed(1)}%. ◊©◊ß◊ï◊ú ◊ú◊î◊§◊°◊ô◊ß ◊ú◊î◊©◊ß◊ô◊¢ ◊ë◊î ◊ñ◊û◊†◊ô◊™.`
                            }
                        </p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        
        function saveBonds() {
            portfolio.bonds = parseFloat(document.getElementById('bonds-amount').value) || 0;
            saveData();
            updateOverview();
            notify('‚úÖ ◊ê◊í"◊ó ◊†◊©◊û◊®');
        }
        
        function exportData() {
            const json = JSON.stringify(portfolio, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify('‚úÖ ◊†◊™◊ï◊†◊ô◊ù ◊ô◊ï◊¶◊ê◊ï');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    portfolio = JSON.parse(e.target.result);
                    saveData();
                    updateOverview();
                    renderGroupsList();
                    renderHoldingsList();
                    renderCashFlow();
                    renderTransactions();
                    notify('‚úÖ ◊†◊™◊ï◊†◊ô◊ù ◊ô◊ï◊ë◊ê◊ï');
                } catch (error) {
                    notify('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ß◊®◊ô◊ê◊™ ◊î◊ß◊ï◊ë◊•', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
        
        function deleteAllData() {
            const confirmation = confirm('‚ö†Ô∏è ◊î◊ê◊ù ◊ê◊™◊î ◊ë◊ò◊ï◊ó ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù?\n\n◊§◊¢◊ï◊ú◊î ◊ñ◊ï ◊™◊û◊ó◊ß ◊ú◊¶◊û◊ô◊™◊ï◊™:\n‚Ä¢ ◊õ◊ú ◊î◊û◊†◊ô◊ï◊™\n‚Ä¢ ◊õ◊ú ◊î◊ê◊í"◊ó\n‚Ä¢ ◊õ◊ú ◊î◊î◊§◊ß◊ì◊ï◊™ ◊ï◊î◊û◊©◊ô◊õ◊ï◊™\n‚Ä¢ ◊õ◊ú ◊î◊¢◊°◊ß◊ê◊ï◊™\n‚Ä¢ ◊õ◊ú ◊î-Snapshots\n\n◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊©◊ó◊ñ◊® ◊ê◊™ ◊î◊†◊™◊ï◊†◊ô◊ù!\n\n◊î◊ß◊ú◊ì "◊û◊ó◊ß ◊î◊õ◊ú" ◊õ◊ì◊ô ◊ú◊ê◊©◊®.');
            
            if (!confirmation) return;
            
            const secondConfirmation = prompt('◊î◊ß◊ú◊ì "◊û◊ó◊ß ◊î◊õ◊ú" ◊ë◊ì◊ô◊ï◊ß ◊õ◊ì◊ô ◊ú◊ê◊©◊® ◊û◊ó◊ô◊ß◊î:');
            
            if (secondConfirmation !== '◊û◊ó◊ß ◊î◊õ◊ú') {
                notify('‚ùå ◊û◊ó◊ô◊ß◊î ◊ë◊ï◊ò◊ú◊î', 'warning');
                return;
            }
            
            // Reset portfolio to empty state
            portfolio = {
                holdings: [],
                groups: [
                    { id: 1, name: '◊û◊ì◊ì◊ô◊ù ◊¢◊ï◊ú◊û◊ô◊ô◊ù', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: '◊ê◊ß◊ò◊ô◊ë◊ô/◊°◊ô◊õ◊ï◊†◊ô', target: 10, color: '#ef4444' }
                ],
                rates: {
                    USD: 3.75,
                    EUR: 4.05
                },
                bonds: [],
                deposits: [],
                withdrawals: [],
                purchases: [],
                sales: [],
                snapshots: []
            };
            
            // Save to localStorage
            saveData();
            
            // Refresh all views
            updateOverview();
            renderHoldingsList();
            renderBondsList();
            renderCashFlow();
            
            renderTransactions();
            
            notify('‚úÖ ◊õ◊ú ◊î◊†◊™◊ï◊†◊ô◊ù ◊†◊û◊ó◊ß◊ï', 'success');
        }
        
        function fixSnapshots() {
            if (!confirm('üîß ◊§◊¢◊ï◊ú◊î ◊ñ◊ï ◊™◊û◊ó◊ß ◊ê◊™ ◊õ◊ú ◊î-Snapshots ◊î◊ô◊©◊†◊ô◊ù ◊ï◊™◊ô◊¶◊ï◊® snapshot ◊ê◊ó◊ì ◊ó◊ì◊© ◊¢◊ù ◊î◊§◊ï◊®◊û◊ò ◊î◊û◊¢◊ï◊ì◊õ◊ü.\n\n◊î◊û◊©◊ö?')) {
                return;
            }
            
            // Delete all old snapshots
            portfolio.snapshots = [];
            
            // Create one new snapshot with current portfolio value
            const currentValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + (d.amount || 0), 0);
            
            createSnapshot('fix', '◊™◊ô◊ß◊ï◊ü ◊§◊ï◊®◊û◊ò', 0);
            
            // Update the snapshot to have proper value_before_flow
            if (portfolio.snapshots.length > 0) {
                const newSnapshot = portfolio.snapshots[0];
                newSnapshot.value_before_flow = 0;
                newSnapshot.cash_flow = totalDeposits;
            }
            
            saveData();
            
            updateOverview();
            
            notify('‚úÖ Snapshots ◊™◊ï◊ß◊†◊ï! TWR ◊ô◊™◊ó◊ô◊ú ◊ú◊î◊™◊¢◊ì◊õ◊ü ◊û◊¢◊õ◊©◊ô◊ï.', 'success');
        }

        // ===========================================
        // REBUILD SNAPSHOTS FROM HISTORY
        // ===========================================
        
        function rebuildSnapshotsFromHistory() {
            if (!confirm('üîÑ ◊§◊¢◊ï◊ú◊î ◊ñ◊ï ◊™◊ë◊†◊î ◊û◊ó◊ì◊© ◊ê◊™ ◊õ◊ú ◊î-Snapshots ◊û◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊§◊¢◊ï◊ú◊ï◊™.\n\n◊î◊§◊ï◊†◊ß◊¶◊ô◊î ◊™◊¢◊ë◊ï◊® ◊¢◊ú ◊õ◊ú ◊î◊î◊§◊ß◊ì◊ï◊™ ◊ï◊î◊û◊©◊ô◊õ◊ï◊™ ◊ë◊°◊ì◊® ◊õ◊®◊ï◊†◊ï◊ú◊ï◊í◊ô ◊ï◊™◊ó◊©◊ë ◊û◊ó◊ì◊© ◊ê◊™ ◊©◊ï◊ï◊ô ◊î◊™◊ô◊ß ◊ë◊õ◊ú ◊†◊ß◊ï◊ì◊î.\n\n◊î◊û◊©◊ö?')) {
                return;
            }
            
            console.log('üîÑ Starting rebuildSnapshotsFromHistory...');
            
            // Step 1: Collect all cash flow events (deposits and withdrawals only)
            const allCashFlows = [];
            
            // Add deposits
            if (Array.isArray(portfolio.deposits)) {
                portfolio.deposits.forEach(d => {
                    allCashFlows.push({
                        type: 'deposit',
                        date: new Date(d.date),
                        amount: d.amount || 0,
                        note: d.note || '◊î◊§◊ß◊ì◊î',
                        id: d.id
                    });
                });
            }
            
            // Add withdrawals (as negative amounts)
            if (Array.isArray(portfolio.withdrawals)) {
                portfolio.withdrawals.forEach(w => {
                    allCashFlows.push({
                        type: 'withdrawal',
                        date: new Date(w.date),
                        amount: -(w.amount || 0),
                        note: w.note || '◊û◊©◊ô◊õ◊î',
                        id: w.id
                    });
                });
            }
            
            // Sort chronologically
            allCashFlows.sort((a, b) => a.date - b.date);
            
            console.log(`üìã Found ${allCashFlows.length} cash flow events to process`);
            
            if (allCashFlows.length === 0) {
                notify('‚ùå ◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊î◊§◊ß◊ì◊ï◊™ ◊ê◊ï ◊û◊©◊ô◊õ◊ï◊™ ◊ë◊î◊ô◊°◊ò◊ï◊®◊ô◊î', 'error');
                return;
            }
            
            // Step 2: Collect all purchases and sales to calculate portfolio value at each point
            const allPurchases = [];
            const allSales = [];
            
            // Stock purchases from holdings
            if (Array.isArray(portfolio.holdings)) {
                portfolio.holdings.forEach(h => {
                    if (h.purchaseDate) {
                        allPurchases.push({
                            type: 'stock',
                            date: new Date(h.purchaseDate),
                            amount: convertToILS(h.shares * h.costBasis, h.currency),
                            symbol: h.symbol
                        });
                    }
                });
            }
            
            // Also check transactions for additional purchases
            if (Array.isArray(portfolio.transactions)) {
                portfolio.transactions.forEach(t => {
                    if (t.type === 'buy' && t.date) {
                        allPurchases.push({
                            type: t.assetType || 'stock',
                            date: new Date(t.date),
                            amount: convertToILS(t.shares * t.price, t.currency || 'ILS'),
                            symbol: t.symbol
                        });
                    } else if (t.type === 'sell' && t.date) {
                        allSales.push({
                            type: t.assetType || 'stock',
                            date: new Date(t.date),
                            amount: convertToILS(t.shares * t.price, t.currency || 'ILS'),
                            symbol: t.symbol
                        });
                    }
                });
            }
            
            // Bond purchases
            if (Array.isArray(portfolio.bonds)) {
                portfolio.bonds.forEach(b => {
                    if (b.purchaseDate) {
                        allPurchases.push({
                            type: 'bond',
                            date: new Date(b.purchaseDate),
                            amount: convertToILS(b.units * b.costBasis, b.currency || 'ILS'),
                            symbol: b.symbol
                        });
                    }
                });
            }
            
            // Sales from portfolio.sales
            if (Array.isArray(portfolio.sales)) {
                portfolio.sales.forEach(s => {
                    allSales.push({
                        type: s.assetType || 'stock',
                        date: new Date(s.date),
                        amount: s.amount || 0,
                        symbol: s.symbol
                    });
                });
            }
            
            // Bond sales
            if (Array.isArray(portfolio.bondsSales)) {
                portfolio.bondsSales.forEach(s => {
                    allSales.push({
                        type: 'bond',
                        date: new Date(s.date),
                        amount: s.amount || 0,
                        symbol: s.symbol
                    });
                });
            }
            
            // Sort purchases and sales
            allPurchases.sort((a, b) => a.date - b.date);
            allSales.sort((a, b) => a.date - b.date);
            
            console.log(`üìã Found ${allPurchases.length} purchases and ${allSales.length} sales`);
            
            // Step 3: Calculate portfolio value at each cash flow event
            // Using cost basis approach (since we don't have historical prices)
            
            function getPortfolioValueAtDate(targetDate) {
                let stocksValue = 0;
                let bondsValue = 0;
                
                // Calculate stocks value at target date using cost basis
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings.forEach(h => {
                        const purchaseDate = h.purchaseDate ? new Date(h.purchaseDate) : new Date(0);
                        if (purchaseDate <= targetDate) {
                            // Use cost basis for historical value
                            stocksValue += convertToILS(h.shares * h.costBasis, h.currency);
                        }
                    });
                }
                
                // Calculate bonds value at target date using cost basis
                if (Array.isArray(portfolio.bonds)) {
                    portfolio.bonds.forEach(b => {
                        const purchaseDate = b.purchaseDate ? new Date(b.purchaseDate) : new Date(0);
                        if (purchaseDate <= targetDate) {
                            // Use cost basis for historical value
                            bondsValue += convertToILS(b.units * b.costBasis, b.currency || 'ILS');
                        }
                    });
                }
                
                // Calculate cash at target date
                let cashValue = 0;
                
                // Add all deposits before target date
                if (Array.isArray(portfolio.deposits)) {
                    portfolio.deposits.forEach(d => {
                        if (new Date(d.date) <= targetDate) {
                            cashValue += d.amount || 0;
                        }
                    });
                }
                
                // Subtract all withdrawals before target date
                if (Array.isArray(portfolio.withdrawals)) {
                    portfolio.withdrawals.forEach(w => {
                        if (new Date(w.date) <= targetDate) {
                            cashValue -= w.amount || 0;
                        }
                    });
                }
                
                // Subtract purchases before target date
                allPurchases.forEach(p => {
                    if (p.date <= targetDate) {
                        cashValue -= p.amount;
                    }
                });
                
                // Add sales before target date
                allSales.forEach(s => {
                    if (s.date <= targetDate) {
                        cashValue += s.amount;
                    }
                });
                
                // Cash can be negative if there were manual adjustments
                cashValue = Math.max(0, cashValue);
                
                return {
                    stocks: stocksValue,
                    bonds: bondsValue,
                    cash: cashValue,
                    total: stocksValue + bondsValue + cashValue
                };
            }
            
            // Step 4: Clear old snapshots and build new ones
            portfolio.snapshots = [];
            
            allCashFlows.forEach((event, index) => {
                // Get portfolio value BEFORE this cash flow
                // To do this, we look at the state just before this event's date
                const valueBeforeDate = new Date(event.date.getTime() - 1000); // 1 second before
                const valueBefore = getPortfolioValueAtDate(valueBeforeDate);
                
                // Create snapshot
                const snapshot = {
                    id: Date.now() + index,
                    date: event.date.toISOString(),
                    value_before_flow: valueBefore.total,
                    cash_flow: event.amount, // positive for deposit, negative for withdrawal
                    stocksValue: valueBefore.stocks,
                    bondsValue: valueBefore.bonds,
                    implicitCash: valueBefore.cash,
                    totalValue: valueBefore.total,
                    triggerType: event.type,
                    triggerNote: event.note
                };
                
                portfolio.snapshots.push(snapshot);
                
                console.log(`üì∏ Snapshot ${index + 1}:`, {
                    date: event.date.toLocaleDateString('he-IL'),
                    type: event.type,
                    cashFlow: event.amount,
                    valueBefore: valueBefore.total
                });
            });
            
            // Sort snapshots by date
            portfolio.snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            console.log(`‚úÖ Created ${portfolio.snapshots.length} snapshots from history`);
            
            // Save and update UI
            saveData();
            updateOverview();
            renderCashFlow();
            
            notify(`‚úÖ ◊†◊ë◊†◊ï ◊û◊ó◊ì◊© ${portfolio.snapshots.length} snapshots ◊û◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊§◊¢◊ï◊ú◊ï◊™!`, 'success');
        }

        // ===========================================
        // ANALYSIS TAB - METRICS & TREEMAP
        // ===========================================
        
        // ========================================
        // MWR (Money-Weighted Return) Calculation
        // ========================================
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        /**
         * Calculate XNPV (Net Present Value with dates)
         * Similar to Excel's XNPV function
         */
        function XNPV(rate, values, dates) {
            if (values.length !== dates.length) {
                return null;
            }
            
            const firstDate = dates[0];
            let npv = 0;
            
            for (let i = 0; i < values.length; i++) {
                const diffDays = (dates[i] - firstDate) / (1000 * 60 * 60 * 24);
                npv += values[i] / Math.pow(1 + rate, diffDays / 365.25);
            }
            
            return npv;
        }
        
        /**
         * Calculate XIRR (Internal Rate of Return with dates)
         * Similar to Excel's XIRR function
         * Returns annualized rate directly
         */
        function XIRR(values, dates, guess = 0.1) {
            if (values.length !== dates.length || values.length < 2) {
                console.log('‚ùå XIRR: Invalid input lengths');
                return null;
            }
            
            // Check that we have both positive and negative values
            const hasPositive = values.some(v => v > 0);
            const hasNegative = values.some(v => v < 0);
            if (!hasPositive || !hasNegative) {
                console.log('‚ùå XIRR: Need both positive and negative values');
                return null;
            }
            
            console.log('üî¢ XIRR starting Newton-Raphson...');
            
            // Newton-Raphson method
            let rate = guess;
            const maxIterations = 100;
            const tolerance = 0.0001;
            
            for (let i = 0; i < maxIterations; i++) {
                const npv = XNPV(rate, values, dates);
                
                if (i % 10 === 0 || i < 5) {
                    console.log(`  Iteration ${i}: rate=${(rate*100).toFixed(4)}%, NPV=${npv.toFixed(2)}`);
                }
                
                if (Math.abs(npv) < tolerance) {
                    console.log(`‚úÖ XIRR converged: ${(rate*100).toFixed(2)}% (${i} iterations)`);
                    return rate; // Already annualized!
                }
                
                // Calculate derivative (dNPV/dRate)
                const firstDate = dates[0];
                let dnpv = 0;
                for (let j = 0; j < values.length; j++) {
                    const diffDays = (dates[j] - firstDate) / (1000 * 60 * 60 * 24);
                    const years = diffDays / 365.25;
                    dnpv -= years * values[j] / Math.pow(1 + rate, years + 1);
                }
                
                if (dnpv === 0) {
                    console.log(`‚ö†Ô∏è XIRR: dnpv=0 at iteration ${i}`);
                    break;
                }
                
                const newRate = rate - npv / dnpv;
                
                if (!isFinite(newRate) || Math.abs(newRate) > 100) {
                    console.log(`‚ö†Ô∏è XIRR: newRate out of bounds at iteration ${i}`);
                    break;
                }
                
                if (Math.abs(newRate - rate) < 1e-10) {
                    console.log(`‚úÖ XIRR converged by delta: ${(newRate*100).toFixed(2)}%`);
                    return newRate;
                }
                
                rate = newRate;
            }
            
            console.log('‚ö†Ô∏è XIRR: Newton-Raphson failed, trying Bisection...');
            
            // If Newton-Raphson fails, try bisection
            let low = -0.99;
            let high = 10.0;
            
            const npvLow = XNPV(low, values, dates);
            const npvHigh = XNPV(high, values, dates);
            
            console.log(`üîç Bisection: NPV(${(low*100).toFixed(0)}%)=${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(0)}%)=${npvHigh.toFixed(2)}`);
            
            if (npvLow * npvHigh > 0) {
                console.log('‚ùå XIRR: No solution (NPV does not cross zero)');
                return null; // No solution
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = XNPV(mid, values, dates);
                
                if (i % 10 === 0) {
                    console.log(`  Bisection ${i}: mid=${(mid*100).toFixed(4)}%, NPV=${npvMid.toFixed(4)}`);
                }
                
                if (Math.abs(npvMid) < tolerance) {
                    console.log(`‚úÖ XIRR (Bisection): ${(mid*100).toFixed(2)}%`);
                    return mid;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log('‚ùå XIRR: Bisection also failed');
            return null;
        }
        
        /**
         * Calculate IRR (Internal Rate of Return) using Newton-Raphson method
         * Returns annualized IRR if period < 1 year
         * @param {Array} cashFlows - Array of {date, amount} objects
         * @returns {number} IRR as decimal (e.g., 0.15 = 15%)
         */
        function calculateIRR(cashFlows) {
            if (!cashFlows || cashFlows.length < 2) {
                console.log('‚ùå IRR: Not enough cash flows');
                return null;
            }
            
            // Sort by date
            const flows = [...cashFlows].sort((a, b) => a.date - b.date);
            
            console.log('üî¢ IRR Input flows:', flows.map(f => ({
                date: f.date.toLocaleDateString('he-IL'),
                amount: f.amount.toFixed(2)
            })));
            
            // Check if all flows are same sign (invalid for IRR)
            const allPositive = flows.every(f => f.amount > 0);
            const allNegative = flows.every(f => f.amount < 0);
            
            if (allPositive || allNegative) {
                console.log('‚ùå IRR: All cash flows have same sign');
                return null;
            }
            
            // Reference date (earliest date)
            const refDate = flows[0].date;
            
            // Convert dates to years from reference
            const flowsWithYears = flows.map(f => ({
                years: (f.date - refDate) / (1000 * 60 * 60 * 24 * 365.25),
                amount: f.amount
            }));
            
            const totalYears = flowsWithYears[flowsWithYears.length - 1].years;
            
            console.log(`üìÖ Period: ${totalYears.toFixed(4)} years (${(totalYears * 365.25).toFixed(1)} days)`);
            
            // Newton-Raphson to find IRR for the period (not annualized)
            // For short periods, IRR will be very small, so we need better starting guesses
            const startingGuesses = [0, 0.0001, 0.001, 0.005, 0.01, -0.0001, -0.001, 0.05, 0.1, 0.02];
            
            for (let guess of startingGuesses) {
                let rate = guess;
                const maxIterations = 3000;
                const tolerance = 1e-12; // Tighter tolerance for better accuracy
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let dnpv = 0;
                    
                    flowsWithYears.forEach(f => {
                        const factor = Math.pow(1 + rate, f.years);
                        if (!isFinite(factor) || factor === 0) return;
                        
                        npv += f.amount / factor;
                        dnpv -= f.years * f.amount / (factor * (1 + rate));
                    });
                    
                    // Check both absolute and relative error
                    const absError = Math.abs(npv);
                    const sumAbsFlows = flowsWithYears.reduce((sum, f) => sum + Math.abs(f.amount), 0);
                    const relError = absError / (sumAbsFlows + 1);
                    
                    if (absError < 0.01 || relError < 1e-10) {
                        // Found period IRR, now annualize if needed
                        let annualizedRate = rate;
                        
                        if (totalYears > 0 && totalYears < 1) {
                            // Annualize: (1 + period_rate)^(1/years) - 1
                            annualizedRate = Math.pow(1 + rate, 1 / totalYears) - 1;
                            console.log(`‚úÖ IRR: Period=${(rate*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        } else {
                            console.log(`‚úÖ IRR: ${(rate*100).toFixed(2)}% (${i} iterations, NPV=${npv.toFixed(4)})`);
                        }
                        
                        return annualizedRate;
                    }
                    
                    if (!isFinite(dnpv) || dnpv === 0) break;
                    
                    // Newton step with damping to prevent overshooting
                    const rawStep = -npv / dnpv;
                    const dampingFactor = 0.5; // Use half-steps for stability
                    const newRate = rate + dampingFactor * rawStep;
                    
                    if (!isFinite(newRate) || newRate < -0.99 || newRate > 1000) break;
                    
                    // Check if we're converging
                    if (i > 10 && Math.abs(newRate - rate) < 1e-12) {
                        // Converged in delta, check NPV one more time
                        break;
                    }
                    
                    rate = newRate;
                }
            }
            
            console.log('‚ö†Ô∏è IRR: Newton-Raphson failed, trying Secant method');
            
            // Secant method as fallback - more stable for difficult cases
            const calcNPV = (rate) => {
                let npv = 0;
                flowsWithYears.forEach(f => {
                    const factor = Math.pow(1 + rate, f.years);
                    if (isFinite(factor) && factor !== 0) {
                        npv += f.amount / factor;
                    }
                });
                return npv;
            };
            
            // Try multiple starting pairs for Secant method
            const secantStarts = [
                [0, 0.001],
                [0, 0.01],
                [-0.001, 0.001],
                [0.001, 0.005],
                [0, 0.0001]
            ];
            
            for (let [r0, r1] of secantStarts) {
                let rate0 = r0;
                let rate1 = r1;
                
                for (let i = 0; i < 2000; i++) {
                    const npv0 = calcNPV(rate0);
                    const npv1 = calcNPV(rate1);
                    
                    if (Math.abs(npv1) < 0.01) {
                        let annualizedRate = rate1;
                        if (totalYears > 0 && totalYears < 1) {
                            annualizedRate = Math.pow(1 + rate1, 1 / totalYears) - 1;
                        }
                        console.log(`‚úÖ IRR (Secant): Period=${(rate1*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}%`);
                        return annualizedRate;
                    }
                    
                    if (Math.abs(npv1 - npv0) < 1e-14) break; // Too close, try next pair
                    
                    const rate2 = rate1 - npv1 * (rate1 - rate0) / (npv1 - npv0);
                    
                    if (!isFinite(rate2) || rate2 < -0.99 || rate2 > 1000) break;
                    
                    rate0 = rate1;
                    rate1 = rate2;
                }
            }
            
            // Last resort: Bisection method (slowest but most reliable)
            console.log('‚ö†Ô∏è IRR: Secant failed, trying Bisection method');
            
            let low = -0.5;
            let high = 2.0;
            const npvLow = calcNPV(low);
            const npvHigh = calcNPV(high);
            
            console.log(`üîç Bisection: NPV(${(low*100).toFixed(2)}%) = ${npvLow.toFixed(2)}, NPV(${(high*100).toFixed(2)}%) = ${npvHigh.toFixed(2)}`);
            
            // Check if solution is in range
            if (npvLow * npvHigh > 0) {
                console.log('‚ùå IRR: No solution found in range (NPV does not cross zero)');
                return null;
            }
            
            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                const npvMid = calcNPV(mid);
                
                if (Math.abs(npvMid) < 0.01 || Math.abs(high - low) < 1e-10) {
                    let annualizedRate = mid;
                    if (totalYears > 0 && totalYears < 1) {
                        annualizedRate = Math.pow(1 + mid, 1 / totalYears) - 1;
                    }
                    console.log(`‚úÖ IRR (Bisection): Period=${(mid*100).toFixed(4)}%, Annualized=${(annualizedRate*100).toFixed(2)}% (${i} iterations)`);
                    return annualizedRate;
                }
                
                if (npvMid * npvLow < 0) {
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            console.log('‚ùå IRR: Could not calculate');
            return null;
        }

        
        /**
         * Calculate MWR (Money-Weighted Return) for the entire portfolio
         * MWR = IRR that considers timing of cash flows
         * @returns {number} MWR as percentage (e.g., 15.5 = 15.5%)
         */
        /**
         * Combine cash flows that occur on the same date
         * This is necessary for XIRR to work correctly
         */
        function combineCashFlows(values, dates) {
            const flowMap = new Map();
            
            // Group by date
            for (let i = 0; i < values.length; i++) {
                const dateKey = dates[i].toISOString().split('T')[0]; // Use date only (YYYY-MM-DD)
                if (flowMap.has(dateKey)) {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: flowMap.get(dateKey).value + values[i]
                    });
                } else {
                    flowMap.set(dateKey, {
                        date: dates[i],
                        value: values[i]
                    });
                }
            }
            
            // Convert back to arrays
            const combinedValues = [];
            const combinedDates = [];
            
            // Sort by date
            const sortedEntries = Array.from(flowMap.entries()).sort((a, b) => 
                new Date(a[0]) - new Date(b[0])
            );
            
            sortedEntries.forEach(([dateKey, flow]) => {
                combinedValues.push(flow.value);
                combinedDates.push(flow.date);
            });
            
            return { values: combinedValues, dates: combinedDates };
        }
        
        /**
         * Calculate annualized returns when IRR is undefined
         * Returns both 365.25-day and 360-day conventions
         */
        function calculateFallbackReturns(values, dates) {
            const totalInvested = values.filter(v => v < 0).reduce((sum, v) => sum + Math.abs(v), 0);
            const totalReceived = values.filter(v => v > 0).reduce((sum, v) => sum + v, 0);
            const profit = totalReceived - totalInvested;
            
            const firstDate = dates[0];
            const lastDate = dates[dates.length - 1];
            const periodDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
            
            // Period return
            const periodReturn = profit / totalInvested;
            
            // Simple annualized
            const simpleAnnualized = periodReturn * (365.25 / periodDays);
            
            // Compound annualized - Standard (365.25 days/year)
            const compoundAnnualized365 = Math.pow(1 + periodReturn, 365.25 / periodDays) - 1;
            
            // Compound annualized - Financial (360 days/year)
            const compoundAnnualized360 = Math.pow(1 + periodReturn, 360 / periodDays) - 1;
            
            return {
                periodReturn,
                periodDays,
                simpleAnnualized,
                compoundAnnualized365,
                compoundAnnualized360
            };
        }
        
        function calculateMWR() {
            try {
                // ‚úÖ CORRECT XIRR convention (from INVESTOR perspective):
                // Negative = Money OUT of investor (deposits)
                // Positive = Money INTO investor (withdrawals + final value)
                
                const values = [];
                const dates = [];
                
                // Deposits: Money OUT of investor = NEGATIVE
                console.log('üîç Deposits:', portfolio.deposits?.length || 0);
                if (portfolio.deposits && portfolio.deposits.length > 0) {
                    portfolio.deposits.forEach((d, idx) => {
                        const amount = d.amount || 0;
                        values.push(-Math.abs(amount)); // NEGATIVE (money leaving investor)
                        dates.push(new Date(d.date));
                        console.log(`  Deposit ${idx}: ${d.date} = -${amount}`);
                    });
                }
                
                // Withdrawals: Money INTO investor = POSITIVE
                console.log('üîç Withdrawals:', portfolio.withdrawals?.length || 0);
                if (portfolio.withdrawals && portfolio.withdrawals.length > 0) {
                    portfolio.withdrawals.forEach((w, idx) => {
                        const amount = w.amount || 0;
                        values.push(Math.abs(amount)); // POSITIVE (money returning to investor)
                        dates.push(new Date(w.date));
                        console.log(`  Withdrawal ${idx}: ${w.date} = +${amount} (note: ${w.note})`);
                    });
                }
                
                // Current Value: What investor gets back today = POSITIVE
                const currentValue = getTotalPortfolioValue();
                console.log('üîç Current Value:', currentValue);
                values.push(currentValue); // POSITIVE (as if selling everything)
                dates.push(new Date());
                
                console.log('üîç Total cash flows (before combining):', values.length);
                console.log('üîç Sum of flows:', values.reduce((a,b) => a+b, 0).toFixed(2));
                
                if (values.length < 2) {
                    console.log('‚ö†Ô∏è MWR: Not enough cash flows');
                    return null;
                }
                
                // ‚≠ê COMBINE flows on the same date
                const { values: combinedValues, dates: combinedDates } = combineCashFlows(values, dates);
                
                console.log('üîÄ After combining same-date flows:', combinedValues.length);
                console.log('üí∞ MWR Cash Flows (combined):', combinedValues.map((v, i) => ({
                    date: combinedDates[i].toLocaleDateString('he-IL'),
                    amount: v.toFixed(2)
                })));
                
                // Calculate XIRR (already returns annualized rate!)
                const xirr = XIRR(combinedValues, combinedDates);
                
                if (xirr === null || !isFinite(xirr)) {
                    console.log('‚ö†Ô∏è MWR: IRR is mathematically undefined (NPV does not cross zero)');
                    console.log('   ‚Üí Using compound annualized return instead...');
                    
                    // Fallback: Calculate compound annualized return
                    const returns = calculateFallbackReturns(combinedValues, combinedDates);
                    
                    console.log(`üìä Fallback Returns:`);
                    console.log(`   Period: ${returns.periodDays.toFixed(0)} days`);
                    console.log(`   Period Return: ${(returns.periodReturn * 100).toFixed(2)}%`);
                    console.log(`   Simple Annualized: ${(returns.simpleAnnualized * 100).toFixed(2)}%`);
                    console.log(`   Compound (365.25 days/year): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    console.log(`   Compound (360 days/year):    ${(returns.compoundAnnualized360 * 100).toFixed(2)}%`);
                    console.log(`üí∞ Using Compound (365.25): ${(returns.compoundAnnualized365 * 100).toFixed(2)}%`);
                    
                    // Return the standard 365.25-day calculation
                    return returns.compoundAnnualized365 * 100;
                }
                
                // XIRR already returns annualized rate - NO double annualization!
                console.log(`üí∞ MWR calculated: ${(xirr * 100).toFixed(2)}%`);
                return xirr * 100; // Return as percentage
                
            } catch (error) {
                console.error('‚ùå Error calculating MWR:', error);
                return null;
            }
        }
        
        // ========================================
        // Portfolio Metrics (Sharpe, Volatility, etc.)
        // ========================================
        
        function calculatePortfolioMetrics() {
            const holdings = portfolio.holdings || [];
            
            if (holdings.length === 0) {
                return {
                    sharpeRatio: 0,
                    maxDrawdown: 0,
                    volatility: 0,
                    winRate: 0,
                    mwr: null
                };
            }
            
            // Calculate returns array (simplified - based on current profit/loss)
            let returns = [];
            let totalInvested = 0;
            let totalCurrent = 0;
            let winners = 0;
            
            holdings.forEach(h => {
                const invested = h.shares * h.costBasis;
                const current = h.shares * (h.currentPrice || h.costBasis);
                const returnPct = ((current - invested) / invested) * 100;
                
                returns.push(returnPct);
                totalInvested += invested;
                totalCurrent += current;
                
                if (returnPct > 0) winners++;
            });
            
            // Win Rate
            const winRate = holdings.length > 0 ? (winners / holdings.length) * 100 : 0;
            
            // Volatility (Standard Deviation of Returns)
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const squaredDiffs = returns.map(r => Math.pow(r - avgReturn, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / returns.length;
            const volatility = Math.sqrt(variance);
            
            // Sharpe Ratio (simplified: avg return / volatility)
            // Assuming risk-free rate = 0 for simplicity
            const sharpeRatio = volatility > 0 ? avgReturn / volatility : 0;
            
            // Max Drawdown (simplified: worst single holding performance)
            const maxDrawdown = returns.length > 0 ? Math.min(...returns) : 0;
            
            // Calculate MWR (Money-Weighted Return)
            const mwr = calculateMWR();
            
            return {
                sharpeRatio: sharpeRatio.toFixed(2),
                maxDrawdown: maxDrawdown.toFixed(2) + '%',
                volatility: volatility.toFixed(2) + '%',
                winRate: winRate.toFixed(1) + '%',
                mwr: mwr !== null ? mwr.toFixed(2) + '%' : 'N/A'
            };
        }
        
        function updateAnalysisTab() {
            const metrics = calculatePortfolioMetrics();
            
            // Update KPI cards - with null safety
            const sharpeEl = document.getElementById('sharpe-ratio');
            const drawdownEl = document.getElementById('max-drawdown');
            const volatilityEl = document.getElementById('volatility');
            const winRateEl = document.getElementById('win-rate');
            const mwrEl = document.getElementById('mwr-value');
            
            if (sharpeEl) sharpeEl.textContent = metrics.sharpeRatio;
            if (drawdownEl) drawdownEl.textContent = metrics.maxDrawdown;
            if (volatilityEl) volatilityEl.textContent = metrics.volatility;
            if (winRateEl) winRateEl.textContent = metrics.winRate;
            if (mwrEl) mwrEl.textContent = metrics.mwr;
            
            // Draw Treemap
            drawTreemap();
        }
        
        function drawTreemap() {
            const container = document.getElementById('treemap-container');
            if (!container) return;
            
            const holdings = portfolio.holdings || [];
            if (holdings.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 1.2rem;">◊ê◊ô◊ü ◊û◊†◊ô◊ï◊™ ◊ë◊™◊ô◊ß</div>';
                return;
            }
            
            // Calculate total value
            let totalValue = 0;
            holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                totalValue += convertToILS(value, h.currency);
            });
            
            // Create treemap data
            const treemapData = holdings.map(h => {
                const currentValue = h.shares * (h.currentPrice || h.costBasis);
                const invested = h.shares * h.costBasis;
                const valueILS = convertToILS(currentValue, h.currency);
                const profit = convertToILS(currentValue - invested, h.currency);
                const profitPct = ((currentValue - invested) / invested) * 100;
                const percentage = (valueILS / totalValue) * 100;
                
                return {
                    symbol: h.symbol,
                    value: valueILS,
                    percentage: percentage,
                    profit: profit,
                    profitPct: profitPct
                };
            });
            
            // Sort by value (largest first)
            treemapData.sort((a, b) => b.value - a.value);
            
            // Clear container
            container.innerHTML = '';
            
            // Draw rectangles
            let remainingWidth = 100;
            let remainingHeight = 100;
            let currentX = 0;
            let currentY = 0;
            let rowHeight = 0;
            
            treemapData.forEach((item, index) => {
                // Calculate size based on percentage
                const itemPercentage = item.percentage;
                
                // Simple treemap layout (can be improved)
                let width, height;
                
                if (itemPercentage >= 20) {
                    // Large items get full width
                    width = 100;
                    height = itemPercentage;
                    currentX = 0;
                    currentY += rowHeight;
                    rowHeight = height;
                } else {
                    // Smaller items share rows
                    width = Math.max(itemPercentage * 3, 10);
                    height = 20;
                    
                    if (currentX + width > 100) {
                        currentX = 0;
                        currentY += rowHeight;
                        rowHeight = height;
                    }
                }
                
                // Determine color based on profit
                let color;
                if (item.profitPct > 0) {
                    color = `rgba(16, 185, 129, ${Math.min(item.profitPct / 50, 1)})`; // Green
                } else if (item.profitPct < 0) {
                    color = `rgba(239, 68, 68, ${Math.min(Math.abs(item.profitPct) / 50, 1)})`; // Red
                } else {
                    color = '#9ca3af'; // Gray
                }
                
                // Create rectangle
                const rect = document.createElement('div');
                rect.style.position = 'absolute';
                rect.style.left = currentX + '%';
                rect.style.top = currentY + '%';
                rect.style.width = width + '%';
                rect.style.height = height + '%';
                rect.style.background = color;
                rect.style.border = '1px solid white';
                rect.style.padding = '8px';
                rect.style.boxSizing = 'border-box';
                rect.style.cursor = 'pointer';
                rect.style.transition = 'all 0.3s';
                rect.style.overflow = 'hidden';
                
                // Add content
                const fontSize = width > 15 ? '0.9rem' : '0.7rem';
                rect.innerHTML = `
                    <div style="color: white; font-weight: bold; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.symbol}</div>
                    <div style="color: white; font-size: ${fontSize}; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.percentage.toFixed(1)}%</div>
                    <div style="color: white; font-size: calc(${fontSize} * 0.85); text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${item.profitPct > 0 ? '+' : ''}${item.profitPct.toFixed(1)}%</div>
                `;
                
                // Hover effect
                rect.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.zIndex = '10';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                });
                
                rect.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.zIndex = '1';
                    this.style.boxShadow = 'none';
                });
                
                container.appendChild(rect);
                
                currentX += width;
                rowHeight = Math.max(rowHeight, height);
            });
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        

        function fixTWR() {
            if (!confirm('◊î◊ê◊ù ◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊õ◊ú ◊î-snapshots ◊î◊ô◊©◊†◊ô◊ù ◊ï◊ú◊ô◊¶◊ï◊® ◊ê◊ó◊ì ◊ó◊ì◊©?\n\n◊ñ◊î ◊ô◊ê◊§◊° ◊ê◊™ ◊ó◊ô◊©◊ï◊ë TWR ◊ê◊ë◊ú ◊ú◊ê ◊ô◊©◊§◊ô◊¢ ◊¢◊ú ◊î◊†◊™◊ï◊†◊ô◊ù ◊î◊ê◊ó◊®◊ô◊ù.')) {
                return;
            }
            
            // ◊û◊ó◊ß snapshots ◊ô◊©◊†◊ô◊ù
            portfolio.snapshots = [];
            
            // ◊¶◊ï◊® snapshot ◊ó◊ì◊©
            createSnapshot('fix', '◊™◊ô◊ß◊ï◊ü ◊§◊ï◊®◊û◊ò', 0);
            
            saveData();
            updateOverview();
            
            notify('‚úÖ TWR ◊™◊ï◊ß◊ü! snapshot ◊ó◊ì◊© ◊†◊ï◊¶◊®.', 'success');
        }

        // ============================================
        // CURRENCY EXCHANGE
        // ============================================
        
        function showCurrencyExchange() {
            const modal = document.createElement('div');
            modal.id = 'exchange-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            // ◊ó◊©◊ë ◊ô◊™◊®◊ï◊™ ◊û◊ñ◊ï◊û◊ü:
            // portfolio.cash = ◊õ◊ú ◊î◊ô◊™◊®◊ï◊™ (ILS, USD, EUR)
            // getImplicitCash = ◊®◊ß ◊ú◊ë◊ì◊ô◊ß◊î ◊©◊ú deposits-withdrawals-purchases+sales
            
            // ◊ê◊™◊ó◊ú portfolio.cash ◊ê◊ù ◊ú◊ê ◊ß◊ô◊ô◊ù
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            
            modal.innerHTML = `
                <div style="background: var(--bg-surface); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0;">üîÑ ◊î◊û◊®◊™ ◊û◊ò◊ë◊¢</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">◊û◊ò◊ë◊¢ ◊û◊ß◊ï◊®:</label>
                        <select id="exchange-from" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="ILS">◊©◊ß◊ú (‚Ç™) - ◊ô◊™◊®◊î: ‚Ç™${Math.round(cashBalances.ILS).toLocaleString()}</option>
                            <option value="USD">◊ì◊ï◊ú◊® ($) - ◊ô◊™◊®◊î: $${cashBalances.USD.toFixed(2)}</option>
                            <option value="EUR">◊ô◊ï◊®◊ï (‚Ç¨) - ◊ô◊™◊®◊î: ‚Ç¨${cashBalances.EUR.toFixed(2)}</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">◊û◊ò◊ë◊¢ ◊ô◊¢◊ì:</label>
                        <select id="exchange-to" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="USD">◊ì◊ï◊ú◊® ($)</option>
                            <option value="ILS">◊©◊ß◊ú (‚Ç™)</option>
                            <option value="EUR">◊ô◊ï◊®◊ï (‚Ç¨)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">◊°◊õ◊ï◊ù ◊ú◊î◊û◊®◊î:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="exchange-amount-from" placeholder="◊°◊õ◊ï◊ù ◊û◊ß◊ï◊®" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <span style="padding: 10px; font-size: 24px;">‚áÑ</span>
                            <input type="number" id="exchange-amount-to" placeholder="◊°◊õ◊ï◊ù ◊ô◊¢◊ì" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">◊©◊¢◊® ◊î◊û◊®◊î:</label>
                        <input type="number" id="exchange-rate" step="0.0001" placeholder="◊©◊¢◊®" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">◊î◊©◊¢◊® ◊û◊¢◊ï◊ì◊õ◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊û◊î◊î◊í◊ì◊®◊ï◊™, ◊ê◊§◊©◊® ◊ú◊©◊†◊ï◊™ ◊ô◊ì◊†◊ô◊™</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="executeCurrencyExchange()" style="flex: 1; padding: 12px; background: var(--profit); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            ‚úÖ ◊ë◊¶◊¢ ◊î◊û◊®◊î
                        </button>
                        <button onclick="closeExchangeModal()" style="flex: 1; padding: 12px; background: var(--text-muted); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            ◊ë◊ô◊ò◊ï◊ú
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set up event listeners
            const fromSelect = document.getElementById('exchange-from');
            const toSelect = document.getElementById('exchange-to');
            const rateInput = document.getElementById('exchange-rate');
            const amountFromInput = document.getElementById('exchange-amount-from');
            const amountToInput = document.getElementById('exchange-amount-to');
            
            // Update rate when currencies change
            function updateRate() {
                const from = fromSelect.value;
                const to = toSelect.value;
                
                if (from === to) {
                    rateInput.value = '1';
                    return;
                }
                
                // ◊™◊û◊ô◊ì ◊ú◊î◊¶◊ô◊í ◊ê◊™ ◊î◊©◊¢◊® ◊î◊ò◊ë◊¢◊ô (USD=3.75, EUR=4.05)
                // ◊î◊û◊¢◊®◊õ◊™ ◊™◊ì◊¢ ◊û◊™◊ô ◊ú◊õ◊§◊ï◊ú ◊ï◊û◊™◊ô ◊ú◊ó◊ú◊ß ◊ë◊ó◊ô◊©◊ï◊ë
                let rate = 1;
                if (from === 'ILS' && to === 'USD') {
                    rate = portfolio.rates.USD;  // ◊î◊¶◊í 3.75 (◊†◊ó◊ú◊ß ◊ë◊ñ◊î)
                } else if (from === 'USD' && to === 'ILS') {
                    rate = portfolio.rates.USD;  // ◊î◊¶◊í 3.75 (◊†◊õ◊§◊ï◊ú ◊ë◊ñ◊î)
                } else if (from === 'ILS' && to === 'EUR') {
                    rate = portfolio.rates.EUR;  // ◊î◊¶◊í 4.05 (◊†◊ó◊ú◊ß ◊ë◊ñ◊î)
                } else if (from === 'EUR' && to === 'ILS') {
                    rate = portfolio.rates.EUR;  // ◊î◊¶◊í 4.05 (◊†◊õ◊§◊ï◊ú ◊ë◊ñ◊î)
                } else if (from === 'USD' && to === 'EUR') {
                    rate = portfolio.rates.EUR / portfolio.rates.USD;  // ◊©◊¢◊® ◊ô◊ï◊®◊ï/◊ì◊ï◊ú◊®
                } else if (from === 'EUR' && to === 'USD') {
                    rate = portfolio.rates.USD / portfolio.rates.EUR;  // ◊©◊¢◊® ◊ì◊ï◊ú◊®/◊ô◊ï◊®◊ï
                }
                
                rateInput.value = rate.toFixed(4);
            }
            
            // Update amount when rate or amount changes
            function updateAmountTo() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountFrom = parseFloat(amountFromInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountFrom) && !isNaN(rate)) {
                    let amountTo;
                    // ◊ß◊ë◊¢ ◊î◊ê◊ù ◊ú◊õ◊§◊ï◊ú ◊ê◊ï ◊ú◊ó◊ú◊ß
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // ◊û-ILS ◊ú◊û◊ò◊ë◊¢ ◊ñ◊® - ◊ó◊ú◊ß
                        amountTo = amountFrom / rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // ◊û◊û◊ò◊ë◊¢ ◊ñ◊® ◊ú-ILS - ◊õ◊§◊ï◊ú
                        amountTo = amountFrom * rate;
                    } else {
                        // ◊ë◊ô◊ü ◊û◊ò◊ë◊¢◊ï◊™ ◊ñ◊®◊ô◊ù - ◊õ◊§◊ï◊ú ◊ë◊©◊¢◊®
                        amountTo = amountFrom * rate;
                    }
                    amountToInput.value = amountTo.toFixed(2);
                }
            }
            
            function updateAmountFrom() {
                const from = fromSelect.value;
                const to = toSelect.value;
                const amountTo = parseFloat(amountToInput.value);
                const rate = parseFloat(rateInput.value);
                
                if (!isNaN(amountTo) && !isNaN(rate) && rate !== 0) {
                    let amountFrom;
                    // ◊î◊§◊ï◊ö ◊ê◊™ ◊î◊§◊¢◊ï◊ú◊î
                    if (from === 'ILS' && (to === 'USD' || to === 'EUR')) {
                        // ◊û-ILS ◊ú◊û◊ò◊ë◊¢ ◊ñ◊® - ◊î◊ô◊ô◊†◊ï ◊û◊ó◊ú◊ß◊ô◊ù, ◊¢◊õ◊©◊ô◊ï ◊†◊õ◊§◊ï◊ú
                        amountFrom = amountTo * rate;
                    } else if ((from === 'USD' || from === 'EUR') && to === 'ILS') {
                        // ◊û◊û◊ò◊ë◊¢ ◊ñ◊® ◊ú-ILS - ◊î◊ô◊ô◊†◊ï ◊û◊õ◊§◊ô◊ú◊ô◊ù, ◊¢◊õ◊©◊ô◊ï ◊†◊ó◊ú◊ß
                        amountFrom = amountTo / rate;
                    } else {
                        // ◊ë◊ô◊ü ◊û◊ò◊ë◊¢◊ï◊™ ◊ñ◊®◊ô◊ù - ◊ó◊ú◊ß
                        amountFrom = amountTo / rate;
                    }
                    amountFromInput.value = amountFrom.toFixed(2);
                }
            }
            
            fromSelect.addEventListener('change', updateRate);
            toSelect.addEventListener('change', updateRate);
            rateInput.addEventListener('input', updateAmountTo);
            amountFromInput.addEventListener('input', updateAmountTo);
            amountToInput.addEventListener('input', updateAmountFrom);
            
            // Initialize rate
            updateRate();
        }
        
        function closeExchangeModal() {
            const modal = document.getElementById('exchange-modal');
            if (modal) modal.remove();
        }
        
        function executeCurrencyExchange() {
            const from = document.getElementById('exchange-from').value;
            const to = document.getElementById('exchange-to').value;
            const amountFrom = parseFloat(document.getElementById('exchange-amount-from').value);
            const amountTo = parseFloat(document.getElementById('exchange-amount-to').value);
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            
            // Validation
            if (!from || !to || from === to) {
                notify('‚ùå ◊ë◊ó◊® ◊û◊ò◊ë◊¢◊ï◊™ ◊©◊ï◊†◊ô◊ù', 'error');
                return;
            }
            
            if (isNaN(amountFrom) || amountFrom <= 0) {
                notify('‚ùå ◊î◊ñ◊ü ◊°◊õ◊ï◊ù ◊™◊ß◊ô◊ü ◊ú◊î◊û◊®◊î', 'error');
                return;
            }
            
            if (isNaN(rate) || rate <= 0) {
                notify('‚ùå ◊î◊ñ◊ü ◊©◊¢◊® ◊î◊û◊®◊î ◊™◊ß◊ô◊ü', 'error');
                return;
            }
            
            // Check balance
            // ◊ó◊©◊ë ◊ô◊™◊®◊ï◊™ ◊û◊ñ◊ï◊û◊ü:
            // portfolio.cash = ◊õ◊ú ◊î◊ô◊™◊®◊ï◊™ (ILS, USD, EUR)
            // getImplicitCash = ◊®◊ß ◊ú◊ë◊ì◊ô◊ß◊î ◊©◊ú deposits-withdrawals-purchases+sales
            
            // ◊ê◊™◊ó◊ú portfolio.cash ◊ê◊ù ◊ú◊ê ◊ß◊ô◊ô◊ù
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            const cashBalances = {
                ILS: portfolio.cash.ILS || 0,
                USD: portfolio.cash.USD || 0,
                EUR: portfolio.cash.EUR || 0
            };
            if (cashBalances[from] < amountFrom) {
                notify(`‚ùå ◊ê◊ô◊ü ◊û◊°◊§◊ô◊ß ◊ô◊™◊®◊î ◊ë-${from}. ◊ô◊™◊®◊î ◊†◊ï◊õ◊ó◊ô◊™: ${cashBalances[from].toFixed(2)}`, 'error');
                return;
            }
            
            // Execute exchange - ◊ú◊ú◊ê ◊û◊©◊ô◊õ◊ï◊™/◊î◊§◊ß◊ì◊ï◊™!
            // ◊î◊û◊®◊î = ◊û◊©◊ó◊ß ◊°◊õ◊ï◊ù 0, ◊ú◊ê ◊¶◊®◊ô◊õ◊î ◊ú◊î◊©◊§◊ô◊¢ ◊¢◊ú TWR
            if (!portfolio.cash) portfolio.cash = { ILS: 0, USD: 0, EUR: 0 };
            
            // ◊§◊©◊ï◊ò ◊¢◊ì◊õ◊ü ◊ê◊™ portfolio.cash ◊ô◊©◊ô◊®◊ï◊™
            portfolio.cash[from] -= amountFrom;
            portfolio.cash[to] += amountTo;
            
            console.log(`‚úÖ ◊î◊û◊®◊î: ${amountFrom} ${from} ‚Üí ${amountTo} ${to}`);
            console.log(`   ◊ô◊™◊®◊ï◊™: ILS=${portfolio.cash.ILS}, USD=${portfolio.cash.USD}, EUR=${portfolio.cash.EUR}`);
            
            // Record transaction (for history)
            if (!portfolio.currencyExchanges) portfolio.currencyExchanges = [];
            portfolio.currencyExchanges.push({
                id: Date.now() + 2,
                date: new Date().toISOString(),
                from: from,
                to: to,
                amountFrom: amountFrom,
                amountTo: amountTo,
                rate: rate
            });
            
            saveData();
            renderCashFlow();
            updateOverview();
            
            notify(`‚úÖ ◊î◊û◊®◊î ◊ë◊ï◊¶◊¢◊î: ${amountFrom.toFixed(2)} ${from} ‚Üí ${amountTo.toFixed(2)} ${to}`, 'success');
            
            closeExchangeModal();
        }
        // ==================== ADVANCED CHARTS (NEW!) ====================
        // üìä ◊§◊ï◊†◊ß◊¶◊ô◊ï◊™ ◊ú◊ô◊¶◊ô◊®◊™ ◊î◊í◊®◊§◊ô◊ù ◊î◊û◊™◊ß◊ì◊û◊ô◊ù
        
        let advancedCharts = {};
        
        async function createAdvancedCharts() {
            console.log('üìä Creating advanced charts...');
            
            // Destroy existing charts
            Object.values(advancedCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            advancedCharts = {};
            
            // Get theme colors (dark is default, light is with data-theme="light")
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            const textColor = isLight ? '#1f2937' : '#f9fafb';
            const gridColor = isLight ? '#e5e7eb' : '#374151';
            
            createValueOverTimeChart(textColor, gridColor);
            createGainLossChart(textColor, gridColor);
            createCurrencyDistributionChart(textColor, gridColor);
            await createPerformanceComparisonChart(textColor, gridColor);  // ‚úÖ await
            
            console.log('‚úÖ Advanced charts created successfully!');
        }
        
        function createValueOverTimeChart(textColor, gridColor) {
            const canvas = document.getElementById('value-over-time-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ◊ë◊†◊ô◊ô◊™ ◊†◊™◊ï◊†◊ô◊ù: ◊û◊ô◊ñ◊ï◊í ◊î◊§◊ß◊ì◊ï◊™, ◊û◊©◊ô◊õ◊ï◊™ ◊ï◊©◊ï◊ï◊ô ◊†◊ï◊õ◊ó◊ô
            const dataPoints = [];
            
            // ◊î◊ï◊°◊£ ◊†◊ß◊ï◊ì◊ï◊™ ◊û◊î◊î◊§◊ß◊ì◊ï◊™
            portfolio.deposits.forEach(d => {
                dataPoints.push({
                    date: new Date(d.date),
                    type: 'deposit',
                    amount: d.amount,
                    cumulative: 0 // ◊†◊ó◊©◊ë ◊ê◊ó◊® ◊õ◊ö
                });
            });
            
            // ◊î◊ï◊°◊£ ◊†◊ß◊ï◊ì◊ï◊™ ◊û◊î◊û◊©◊ô◊õ◊ï◊™
            portfolio.withdrawals.forEach(w => {
                dataPoints.push({
                    date: new Date(w.date),
                    type: 'withdrawal',
                    amount: -w.amount,
                    cumulative: 0
                });
            });
            
            // ◊û◊ô◊ï◊ü ◊ú◊§◊ô ◊™◊ê◊®◊ô◊ö
            dataPoints.sort((a, b) => a.date - b.date);
            
            // ◊ó◊ô◊©◊ï◊ë ◊û◊¶◊ò◊ë◊® ◊©◊ú ◊î◊§◊ß◊ì◊ï◊™
            let cumulativeDeposits = 0;
            const depositsLine = [];
            const portfolioValueLine = [];
            const labels = [];
            
            dataPoints.forEach(point => {
                cumulativeDeposits += point.amount;
                const label = point.date.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' });
                labels.push(label);
                depositsLine.push(cumulativeDeposits);
            });
            
            // ◊î◊ï◊°◊£ ◊†◊ß◊ï◊ì◊î ◊†◊ï◊õ◊ó◊ô◊™
            const now = new Date();
            const currentValue = getTotalPortfolioValue();
            const nowLabel = now.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' });
            labels.push(nowLabel);
            depositsLine.push(cumulativeDeposits);
            
            // ◊ë◊†◊î ◊ß◊ï ◊©◊ï◊ï◊ô ◊î◊™◊ô◊ß (◊§◊©◊ï◊ò: ◊û◊î◊î◊§◊ß◊ì◊î ◊î◊®◊ê◊©◊ï◊†◊î ◊ï◊¢◊ì ◊¢◊õ◊©◊ô◊ï)
            if (dataPoints.length > 0) {
                // ◊û◊ú◊ê ◊ë◊¢◊®◊õ◊ô◊ù ◊ú◊ô◊†◊ê◊®◊ô◊ô◊ù
                for (let i = 0; i < labels.length - 1; i++) {
                    const progress = i / (labels.length - 2);
                    portfolioValueLine.push(dataPoints[0].amount + (currentValue - dataPoints[0].amount) * progress);
                }
                portfolioValueLine.push(currentValue);
            }
            
            advancedCharts.valueOverTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '◊©◊ï◊ï◊ô ◊™◊ô◊ß ◊ë◊§◊ï◊¢◊ú',
                            data: portfolioValueLine,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '◊°◊ö ◊î◊§◊ß◊ì◊ï◊™ ◊û◊¶◊ò◊ë◊®',
                            data: depositsLine,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ‚Ç™' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '◊™◊ê◊®◊ô◊ö',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '◊¢◊®◊ö (‚Ç™)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '‚Ç™' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        function createGainLossChart(textColor, gridColor) {
            const canvas = document.getElementById('gain-loss-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ◊ó◊ô◊©◊ï◊ë ◊®◊ï◊ï◊ó/◊î◊§◊°◊ì ◊ú◊ê◊ï◊®◊ö ◊ñ◊û◊ü
            const totalValue = getTotalPortfolioValue();
            const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + d.amount, 0);
            const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + w.amount, 0);
            const netGain = totalValue - totalDeposits + totalWithdrawals;
            const gainPercent = totalDeposits > 0 ? (netGain / totalDeposits * 100) : 0;
            
            // ‚úÖ ◊ë◊†◊î ◊†◊™◊ï◊†◊ô◊ù ◊ó◊ï◊ì◊©◊ô◊ô◊ù ◊û◊î◊î◊§◊ß◊ì◊î ◊î◊®◊ê◊©◊ï◊†◊î
            const monthLabels = [];
            const gains = [];
            const today = new Date();
            
            // ◊û◊¶◊ê ◊™◊ê◊®◊ô◊ö ◊î◊™◊ó◊ú◊î (◊î◊§◊ß◊ì◊î ◊®◊ê◊©◊ï◊†◊î ◊ê◊ï ◊ß◊†◊ô◊ô◊î ◊®◊ê◊©◊ï◊†◊î)
            let startDate = today;
            if (portfolio.deposits.length > 0) {
                const firstDeposit = new Date(portfolio.deposits[0].date);
                if (firstDeposit < startDate) startDate = firstDeposit;
            }
            if (portfolio.holdings.length > 0) {
                portfolio.holdings.forEach(h => {
                    const purchaseDate = new Date(h.purchaseDate);
                    if (purchaseDate < startDate) startDate = purchaseDate;
                });
            }
            if (portfolio.bonds && portfolio.bonds.length > 0) {
                portfolio.bonds.forEach(b => {
                    const purchaseDate = new Date(b.purchaseDate);
                    if (purchaseDate < startDate) startDate = purchaseDate;
                });
            }
            
            // ◊ó◊©◊ë ◊õ◊û◊î ◊ó◊ï◊ì◊©◊ô◊ù ◊¢◊ë◊®◊ï
            const monthsElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24 * 30)) + 1;
            const monthsToShow = Math.min(monthsElapsed, 12); // ◊û◊ß◊°◊ô◊û◊ï◊ù 12 ◊ó◊ï◊ì◊©◊ô◊ù
            
            for (let i = monthsToShow - 1; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                // ◊ë◊ì◊ï◊ß ◊ê◊ù ◊î◊ó◊ï◊ì◊© ◊î◊ñ◊î ◊ê◊ó◊®◊ô ◊™◊ê◊®◊ô◊ö ◊î◊î◊™◊ó◊ú◊î
                if (date >= new Date(startDate.getFullYear(), startDate.getMonth(), 1)) {
                    const label = date.toLocaleDateString('he-IL', { month: 'short', year: '2-digit' });
                    monthLabels.push(label);
                    // ◊ß◊ô◊®◊ï◊ë: ◊†◊†◊ô◊ó ◊¶◊û◊ô◊ó◊î ◊ú◊ô◊†◊ê◊®◊ô◊™
                    const progress = (monthsToShow - 1 - i) / Math.max(monthsToShow - 1, 1);
                    gains.push(netGain * progress);
                }
            }
            
            // ◊ê◊ù ◊ê◊ô◊ü ◊†◊™◊ï◊†◊ô◊ù, ◊î◊¶◊í ◊ú◊§◊ó◊ï◊™ ◊ó◊ï◊ì◊© ◊†◊ï◊õ◊ó◊ô
            if (monthLabels.length === 0) {
                monthLabels.push(today.toLocaleDateString('he-IL', { month: 'short' }));
                gains.push(netGain);
            }
            
            advancedCharts.gainLoss = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: '◊®◊ï◊ï◊ó/◊î◊§◊°◊ì ◊û◊¶◊ò◊ë◊®',
                        data: gains,
                        backgroundColor: gains.map(g => g >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderColor: gains.map(g => g >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const sign = value >= 0 ? '+' : '';
                                    return '◊®◊ï◊ï◊ó/◊î◊§◊°◊ì: ' + sign + '‚Ç™' + Math.round(value).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '◊ó◊ï◊ì◊©',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '◊®◊ï◊ï◊ó/◊î◊§◊°◊ì (‚Ç™)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + '‚Ç™' + (value / 1000).toFixed(1) + 'K';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        function createCurrencyDistributionChart(textColor, gridColor) {
            const canvas = document.getElementById('currency-distribution-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ◊ó◊ô◊©◊ï◊ë ◊ó◊ú◊ï◊ß◊î ◊ú◊û◊ò◊ë◊¢◊ï◊™ - ◊™◊ô◊ß◊ï◊ü ◊ó◊©◊ï◊ë!
            let ilsTotal = 0;
            let usdTotal = 0;
            let eurTotal = 0;
            
            // ◊û◊†◊ô◊ï◊™
            portfolio.holdings.forEach(h => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                if (h.currency === 'ILS') {
                    ilsTotal += value;
                } else if (h.currency === 'USD') {
                    // ◊©◊û◊ï◊® ◊ê◊™ ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô (◊ì◊ï◊ú◊®◊ô◊ù)
                    usdTotal += value;
                } else if (h.currency === 'EUR') {
                    // ◊©◊û◊ï◊® ◊ê◊™ ◊î◊°◊õ◊ï◊ù ◊ë◊û◊ò◊ë◊¢ ◊î◊û◊ß◊ï◊®◊ô (◊ô◊ï◊®◊ï)
                    eurTotal += value;
                }
            });
            
            // ◊ê◊í"◊ó (◊ë◊ì◊®◊ö ◊õ◊ú◊ú ◊ë◊©◊ß◊ú◊ô◊ù)
            if (portfolio.bonds) {
                portfolio.bonds.forEach(b => {
                    ilsTotal += b.units * b.currentPrice;
                });
            }
            
            // ◊û◊ñ◊ï◊û◊ü
            if (portfolio.cash) {
                ilsTotal += portfolio.cash.ILS || 0;
                usdTotal += portfolio.cash.USD || 0;
                eurTotal += portfolio.cash.EUR || 0;
            }
            
            // ◊î◊û◊®◊î ◊ú◊©◊ß◊ú◊ô◊ù ◊ú◊¶◊ï◊®◊ö ◊ó◊ô◊©◊ï◊ë ◊ê◊ó◊ï◊ñ◊ô◊ù
            const ilsTotalInILS = ilsTotal;
            const usdTotalInILS = usdTotal * portfolio.rates.USD;
            const eurTotalInILS = eurTotal * portfolio.rates.EUR;
            const grandTotal = ilsTotalInILS + usdTotalInILS + eurTotalInILS;
            
            console.log('üí± Currency Distribution:');
            console.log(`   ILS: ‚Ç™${ilsTotal.toFixed(2)} (${(ilsTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   USD: $${usdTotal.toFixed(2)} = ‚Ç™${usdTotalInILS.toFixed(2)} (${(usdTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   EUR: ‚Ç¨${eurTotal.toFixed(2)} = ‚Ç™${eurTotalInILS.toFixed(2)} (${(eurTotalInILS / grandTotal * 100).toFixed(1)}%)`);
            console.log(`   Total: ‚Ç™${grandTotal.toFixed(2)}`);
            
            advancedCharts.currencyDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['◊©◊ß◊ú (‚Ç™)', '◊ì◊ï◊ú◊® ($)', '◊ô◊ï◊®◊ï (‚Ç¨)'],
                    datasets: [{
                        data: [ilsTotalInILS, usdTotalInILS, eurTotalInILS],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b'
                        ],
                        borderWidth: 3,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = grandTotal > 0 ? (value / grandTotal * 100).toFixed(1) : 0;
                                    return context.label + ': ‚Ç™' + Math.round(value).toLocaleString() + ' (' + percent + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function createPerformanceComparisonChart(textColor, gridColor) {
            const canvas = document.getElementById('performance-comparison-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë TWR ◊©◊ú ◊î◊™◊ô◊ß (◊™◊©◊ï◊ê◊î ◊û◊©◊ï◊ß◊ú◊ú◊™ ◊ñ◊û◊ü - ◊î◊î◊©◊ï◊ï◊ê◊î ◊î◊î◊ï◊í◊†◊™ ◊ë◊ô◊ï◊™◊®!)
            let portfolioReturn = 0;
            let comparisonNote = '';
            
            const twrResult = calculateTWRv3();
            if (twrResult && twrResult.total !== undefined) {
                portfolioReturn = twrResult.total;  // ◊õ◊ë◊® ◊ë◊ê◊ó◊ï◊ñ◊ô◊ù
                comparisonNote = 'TWR';
                console.log('üìä Using TWR for comparison:', portfolioReturn.toFixed(2) + '%');
            } else {
                // Fallback ◊ú◊ó◊ô◊©◊ï◊ë ◊§◊©◊ï◊ò ◊ê◊ù ◊ê◊ô◊ü snapshots
                const totalValue = getTotalPortfolioValue();
                const totalDeposits = portfolio.deposits.reduce((sum, d) => sum + d.amount, 0);
                const totalWithdrawals = portfolio.withdrawals.reduce((sum, w) => sum + w.amount, 0);
                
                if (totalDeposits > 0) {
                    const netProfit = totalValue - totalDeposits + totalWithdrawals;
                    portfolioReturn = (netProfit / totalDeposits) * 100;
                }
                comparisonNote = '◊§◊©◊ï◊ò◊î';
                console.log('üìä Using simple return for comparison:', portfolioReturn.toFixed(2) + '%');
            }
            
            // ‚úÖ ◊û◊¶◊ê ◊™◊ê◊®◊ô◊ö ◊ß◊†◊ô◊ô◊î ◊®◊ê◊©◊ï◊ü
            const firstDate = getFirstPurchaseDate();
            console.log('üìÖ First purchase date:', firstDate.toISOString().split('T')[0]);
            
            // ‚úÖ ◊ó◊ô◊©◊ï◊ë ◊™◊©◊ï◊ê◊™ ◊ê◊ô◊†◊ì◊ß◊°◊ô◊ù "◊ï◊ô◊®◊ò◊ï◊ê◊ú◊ô◊™" - ◊õ◊ê◊ô◊ú◊ï ◊î◊©◊ß◊¢◊™ ◊ë◊ê◊ô◊†◊ì◊ß◊° ◊ë◊ê◊ï◊™◊ù ◊™◊ê◊®◊ô◊õ◊ô◊ù ◊ï◊°◊õ◊ï◊û◊ô◊ù
            let acwiReturn = 10;   // fallback - MSCI ACWI
            let spyReturn = 12;    // fallback - S&P 500
            let qqqReturn = 15;    // fallback - NASDAQ
            let dataSource = '◊û◊û◊ï◊¶◊¢ 2020-2024';
            let useVirtualCalc = false;
            
            try {
                const deposits = portfolio.deposits || [];
                
                if (deposits.length > 0) {
                    console.log('üåê Calculating virtual index returns based on', deposits.length, 'deposits...');
                    
                    // ◊ó◊ô◊©◊ï◊ë ◊ï◊ô◊®◊ò◊ï◊ê◊ú◊ô - ◊î◊©◊ï◊ï◊ê◊î ◊î◊ï◊í◊†◊™!
                    const [acwiResult, spyResult, qqqResult] = await Promise.allSettled([
                        calculateVirtualIndexReturn('ACWI', deposits),   // iShares MSCI ACWI
                        calculateVirtualIndexReturn('SPY', deposits),    // SPDR S&P 500
                        calculateVirtualIndexReturn('QQQ', deposits)     // Invesco QQQ
                    ]);
                    
                    if (acwiResult.status === 'fulfilled' && acwiResult.value !== null) {
                        acwiReturn = acwiResult.value;
                        useVirtualCalc = true;
                        console.log('‚úÖ ACWI virtual:', acwiReturn.toFixed(2) + '%');
                    } else {
                        console.log('‚ö†Ô∏è ACWI virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('ACWI', firstDate);
                        if (simple !== null) acwiReturn = simple;
                    }
                    
                    if (spyResult.status === 'fulfilled' && spyResult.value !== null) {
                        spyReturn = spyResult.value;
                        console.log('‚úÖ SPY virtual:', spyReturn.toFixed(2) + '%');
                    } else {
                        console.log('‚ö†Ô∏è SPY virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('SPY', firstDate);
                        if (simple !== null) spyReturn = simple;
                    }
                    
                    if (qqqResult.status === 'fulfilled' && qqqResult.value !== null) {
                        qqqReturn = qqqResult.value;
                        console.log('‚úÖ QQQ virtual:', qqqReturn.toFixed(2) + '%');
                    } else {
                        console.log('‚ö†Ô∏è QQQ virtual failed, trying simple...');
                        const simple = await fetchHistoricalReturn('QQQ', firstDate);
                        if (simple !== null) qqqReturn = simple;
                    }
                    
                    dataSource = useVirtualCalc ? '◊î◊©◊ï◊ï◊ê◊î ◊î◊ï◊í◊†◊™' : `◊û-${firstDate.toLocaleDateString('he-IL')}`;
                } else {
                    // ◊ê◊ô◊ü ◊î◊§◊ß◊ì◊ï◊™ - ◊î◊©◊™◊û◊© ◊ë◊ó◊ô◊©◊ï◊ë ◊§◊©◊ï◊ò
                    console.log('üåê No deposits, using simple return calculation');
                    const [acwiResult, spyResult, qqqResult] = await Promise.allSettled([
                        fetchHistoricalReturn('ACWI', firstDate),
                        fetchHistoricalReturn('SPY', firstDate),
                        fetchHistoricalReturn('QQQ', firstDate)
                    ]);
                    
                    if (acwiResult.status === 'fulfilled' && acwiResult.value !== null) acwiReturn = acwiResult.value;
                    if (spyResult.status === 'fulfilled' && spyResult.value !== null) spyReturn = spyResult.value;
                    if (qqqResult.status === 'fulfilled' && qqqResult.value !== null) qqqReturn = qqqResult.value;
                    
                    dataSource = `◊û-${firstDate.toLocaleDateString('he-IL')}`;
                }
                
            } catch (error) {
                console.error('‚ùå Using averages:', error.message);
            }
            
            console.log('üìä Performance:', portfolioReturn.toFixed(1) + '% | ACWI:', acwiReturn.toFixed(1) + '% | SPY:', spyReturn.toFixed(1) + '% | QQQ:', qqqReturn.toFixed(1) + '%');
            
            advancedCharts.performanceComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [`◊î◊™◊ô◊ß ◊©◊ú◊ö (${comparisonNote})`, 'MSCI ACWI', 'S&P 500', 'NASDAQ'],
                    datasets: [{
                        label: `◊™◊©◊ï◊ê◊î (${dataSource})`,
                        data: [portfolioReturn, acwiReturn, spyReturn, qqqReturn],
                        backgroundColor: [
                            portfolioReturn >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            portfolioReturn >= 0 ? '#10b981' : '#ef4444',
                            '#3b82f6',
                            '#667eea',
                            '#f59e0b'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return '◊™◊©◊ï◊ê◊î: ' + (context.parsed.y >= 0 ? '+' : '') + context.parsed.y.toFixed(1) + '%';
                                },
                                afterLabel: function(context) {
                                    if (context.dataIndex === 0) {
                                        return '◊ë◊ô◊¶◊ï◊¢◊ô ◊î◊™◊ô◊ß ◊©◊ú◊ö';
                                    } else {
                                        return dataSource;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '◊ê◊ô◊†◊ì◊ß◊°',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '◊™◊©◊ï◊ê◊î (%)',
                                color: textColor,
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value + '%';
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== END ADVANCED CHARTS ====================
        
        window.onload = function() {
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('‚ú® VERSION: v49 - Smart TWR (Auto/Manual)');
            console.log('   ‚úÖ Multi-currency cash tracking');
            console.log('   ‚úÖ Enhanced TWR calculation');
            console.log('   ‚úÖ Fee configuration by symbol');
            console.log('   ‚úÖ Proper bond pricing (% of face value)');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üöÄ Initializing portfolio with bonds actions...');
            console.log('üì¶ Portfolio data structure:', portfolio);
            
            // ◊ß◊®◊ô◊ê◊î ◊ú-init ◊õ◊ì◊ô ◊ú◊ò◊¢◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù
            init();
        }
        
        async function init() {
            await loadData();  // Load from localStorage
            console.log('üìä Loaded holdings:', portfolio.holdings.length);
            
            updateOverview();
            updateGroupSelect();
            renderHoldingsList();
            renderCashFlow();
            
            
            renderTransactions();
            
            // ◊ò◊¢◊ô◊†◊™ ◊¢◊®◊õ◊ô◊ù ◊ú◊î◊í◊ì◊®◊ï◊™
            document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
            document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
            
            // Hide loading screen with animation
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    if (mainContent) mainContent.style.display = 'block';
                    
                    // Initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    // Create advanced charts after content is visible
                    setTimeout(() => {
                        createAdvancedCharts();
                    }, 300);
                }, 300);
            }
            
            // ◊†◊ô◊°◊ô◊ï◊ü ◊¢◊ì◊õ◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô (◊®◊ß◊¢ - ◊ú◊ê ◊ó◊ï◊°◊ù)
            autoUpdateExchangeRates().then(success => {
                if (success) {
                    updateOverview();
                    console.log('‚úÖ Auto-update successful');
                } else {
                    console.log('‚ÑπÔ∏è Using manual rates');
                }
            });
            
            notify('üíº ◊û◊¢◊®◊õ◊™ ◊û◊ï◊õ◊†◊î ◊¢◊ù ◊í◊®◊§◊ô◊ù ◊û◊™◊ß◊ì◊û◊ô◊ù!', 'success');
            console.log('‚úÖ Portfolio initialized successfully');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üìã Debug Info:');
            console.log('  - Holdings:', portfolio.holdings.length);
            console.log('  - Groups:', portfolio.groups.length);
            console.log('  - USD Rate:', portfolio.rates.USD);
            console.log('  - EUR Rate:', portfolio.rates.EUR);
            console.log('  - Bonds:', portfolio.bonds);
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('‚úÖ To add a holding, click "◊î◊ï◊°◊£ ◊î◊ó◊ñ◊ß◊î" and fill the form');
            console.log('‚úÖ To refresh prices, click "◊®◊¢◊†◊ü ◊û◊ó◊ô◊®◊ô◊ù"');
            console.log('‚úÖ To view advanced charts, click on "◊í◊®◊§◊ô◊ù" tab');
            console.log('‚úÖ To toggle dark mode, click the moon/sun icon');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            
            // ◊©◊û◊ï◊® ◊ê◊™ ◊î◊†◊™◊ï◊†◊ô◊ù ◊ê◊ó◊®◊ô ◊ò◊¢◊ô◊†◊î
            saveData();
        };
        
        // Expose functions to window for HTML onclick handlers
        window.showTab = showTab;
        window.addHolding = addHolding;
        window.editHolding = editHolding;
        window.deleteHolding = deleteHolding;
        window.updatePriceManually = updatePriceManually;
        window.showAddSharesForm = showAddSharesForm;
        window.hideAddSharesModal = hideAddSharesModal;
        window.submitAddShares = submitAddShares;
        window.showSellSharesForm = showSellSharesForm;
        window.hideSellSharesModal = hideSellSharesModal;
        window.submitSellShares = submitSellShares;
        window.addCapitalMovement = addCapitalMovement;
        window.deleteCapitalMovement = deleteCapitalMovement;
        window.deleteSale = deleteSale;
        window.filterTransactions = filterTransactions;
        window.deleteTransaction = deleteTransaction;
        window.showEditTransactionDate = showEditTransactionDate;
        window.hideEditDateModal = hideEditDateModal;
        window.submitEditDate = submitEditDate;
        window.deleteDeposit = deleteDeposit;
        window.deleteWithdrawal = deleteWithdrawal;
        window.showCalculateCapitalFromHoldings = showCalculateCapitalFromHoldings;
        window.hideCalculateCapitalModal = hideCalculateCapitalModal;
        window.toggleHoldingSelection = toggleHoldingSelection;
        window.addCalculatedCapital = addCalculatedCapital;
        window.showAddBondForm = showAddBondForm;
        window.hideAddBondForm = hideAddBondForm;
        window.saveBond = saveBond;
        window.addBondUnits = addBondUnits;
        window.hideAddBondUnitsModal = hideAddBondUnitsModal;
        window.submitAddBondUnits = submitAddBondUnits;
        window.sellBondUnits = sellBondUnits;
        window.hideSellBondUnitsModal = hideSellBondUnitsModal;
        window.submitSellBondUnits = submitSellBondUnits;
        window.editBond = editBond;
        window.deleteBond = deleteBond;
        window.refreshBondPrices = refreshBondPrices;
        window.refreshPrices = refreshPrices;
        window.showCurrencyExchange = showCurrencyExchange;
        window.closeExchangeModal = closeExchangeModal;
        window.executeCurrencyExchange = executeCurrencyExchange;
        window.fixTWR = fixTWR;
        window.showAddHoldingForm = showAddHoldingForm;
        window.hideAddHoldingForm = hideAddHoldingForm;
        window.calculateInvestment = calculateInvestment;
        window.editGroup = editGroup;
        window.fixGroupIds = fixGroupIds;
        window.updateExchangeRates = updateExchangeRates;
        window.tryAutoUpdateRates = tryAutoUpdateRates;
        window.exportData = exportData;
        window.importData = importData;
        window.showDepositModal = showDepositModal;
        window.hideDepositModal = hideDepositModal;
        window.submitDeposit = submitDeposit;
        window.showWithdrawalModal = showWithdrawalModal;
        window.hideWithdrawalModal = hideWithdrawalModal;
        window.submitWithdrawal = submitWithdrawal;
        window.toggleTheme = toggleTheme;
        window.deleteAllData = deleteAllData;
        window.fixSnapshots = fixSnapshots;
        window.rebuildSnapshotsFromHistory = rebuildSnapshotsFromHistory;
        
        // TWR Enhancement v45 exports
        window.calculateTWREnhanced = calculateTWREnhanced;
        window.getTotalPortfolioValueEnhanced = getTotalPortfolioValueEnhanced;
        window.rebuildCashFromHistory = rebuildCashFromHistory;
        window.portfolio = portfolio;
        window.saveData = saveData;
        window.getAssetCurrency = getAssetCurrency;
        window.calculateFeeForTransaction = calculateFeeForTransaction;
        window.getTotalCashILS = getTotalCashILS;
        window.calculateStocksValueILS = calculateStocksValueILS;
        window.calculateBondsValueILS = calculateBondsValueILS;
        window.initializeCash = initializeCash;
        
        console.log('‚úÖ All functions exposed to window');

    
        // Initialize theme from localStorage on load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
        });

    </script>
</body>
</html>