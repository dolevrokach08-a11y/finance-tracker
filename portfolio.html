<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💼 תיק ההשקעות שלי</title>
    <style>
        /* Basic Reset & RTL */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 { 
            font-size: 3rem; 
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header p { 
            font-size: 1.2rem; 
            opacity: 0.9; 
        }
        
        /* Navigation Links */
        .nav-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .tab-btn:hover { background: #f3f4f6; }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
            transition: transform 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
        }
        
        .summary-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .summary-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .summary-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .summary-card h3 { 
            font-size: 0.9rem; 
            opacity: 0.9; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .value { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 5px;
        }
        .summary-card .sub { 
            font-size: 0.85rem; 
            opacity: 0.8; 
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102,126,234,0.4); 
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(16,185,129,0.4); 
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        /* Holdings */
        .holdings-grid {
            display: grid;
            gap: 15px;
        }
        
        .holding-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .holding-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.1);
            transform: translateY(-2px);
        }
        
        .holding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .holding-header h4 {
            font-size: 1.2rem;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .holding-actions {
            display: flex;
            gap: 10px;
        }
        
        .holding-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 3px;
        }
        
        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }
        
        .detail-value.positive { color: #10b981; }
        .detail-value.negative { color: #ef4444; }
        
        /* Groups */
        .groups-list {
            display: grid;
            gap: 20px;
        }
        
        .group-card {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .group-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102,126,234,0.2);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .group-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }
        
        .group-target {
            font-size: 0.9rem;
            color: #6b7280;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Progress Bars */
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 28px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.ok {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.under {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.over {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Investment Calculator */
        .calculator-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .calculator-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .calculator-header h3 {
            font-size: 1.5rem;
            color: #92400e;
        }
        
        .calc-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .calc-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }
        
        .calc-results.show {
            display: block;
        }
        
        .calc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calc-item:last-child {
            border-bottom: none;
        }
        
        .calc-symbol {
            font-weight: 600;
            color: #111827;
        }
        
        .calc-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999;
            font-weight: 600;
        }
        
        .notification.show { opacity: 1; }
        .notification.error { background: #ef4444; }
        .notification.warning { background: #f59e0b; }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .summary-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .calc-input-group { flex-direction: column; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 20px;">
        <div style="font-size: 4em;">💼</div>
        <div style="color: white; font-size: 1.5em; font-weight: 600;">טוען תיק השקעות...</div>
        <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <div id="mainContent" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>💼 תיק ההשקעות שלי</h1>
            <p>מעקב חכם אחר התיק ומערכת המלצות אוטומטית</p>
        </div>

        <!-- Navigation Links -->
        <div class="nav-links">
            <a href="מעקב_כספי_FINAL.html" class="nav-link">💰 למעקב כספי</a>
            <a href="#" class="nav-link">📊 תיק השקעות</a>
        </div>

        <div class="glass">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview', event)">📊 סקירה</button>
                <button class="tab-btn" onclick="showTab('calculator', event)">🧮 מחשבון השקעה</button>
                <button class="tab-btn" onclick="showTab('holdings', event)">📈 החזקות</button>
                <button class="tab-btn" onclick="showTab('groups', event)">🎯 קבוצות</button>
                <button class="tab-btn" onclick="showTab('recommendations', event)">💡 המלצות</button>
                <button class="tab-btn" onclick="showTab('settings', event)">⚙️ הגדרות</button>
            </div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>שווי כולל (₪)</h3>
                        <div class="value" id="total-value-ils">₪0</div>
                        <div class="sub" id="total-value-original">$0 + €0</div>
                    </div>
                    
                    <div class="summary-card green">
                        <h3>תשואה כוללת</h3>
                        <div class="value" id="total-return">+0%</div>
                        <div class="sub" id="total-return-amount">₪0</div>
                    </div>
                    
                    <div class="summary-card purple">
                        <h3>אג"ח ממשלתי</h3>
                        <div class="value" id="bonds-value">₪0</div>
                        <div class="sub">מחוץ לתיק המנייתי</div>
                    </div>

                    <div class="summary-card blue">
                        <h3>עדכון אחרון</h3>
                        <div class="value" id="last-update-time">--:--</div>
                        <div class="sub" id="last-update-date">--/--/----</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">התפלגות התיק (יעד vs בפועל)</h3>
                <div id="allocation-comparison"></div>

                <div class="chart-container">
                    <canvas id="portfolio-chart"></canvas>
                </div>

                <button onclick="refreshPrices()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    🔄 רענן מחירי מניות
                </button>
                
                <button onclick="fixGroupIds()" class="btn btn-warning" style="width: 100%; margin-top: 10px;">
                    🔧 תקן קבוצות (במידה ומוצג "לא ידוע")
                </button>
            </div>

            <!-- Calculator Tab -->
            <div id="tab-calculator" class="tab-content">
                <div class="calculator-card">
                    <div class="calculator-header">
                        <span style="font-size: 2rem;">🧮</span>
                        <h3>מחשבון חלוקת השקעה</h3>
                    </div>
                    
                    <p style="color: #92400e; margin-bottom: 20px;">
                        הזן סכום שאתה רוצה להשקיע והמערכת תחשב לך איך לחלק אותו בין המניות על פי הפערים מהיעד
                    </p>

                    <div class="calc-input-group">
                        <div class="form-group" style="flex: 1;">
                            <label>סכום להשקעה (₪)</label>
                            <input type="number" id="invest-amount" placeholder="10000" step="100">
                        </div>
                        <button onclick="calculateInvestment()" class="btn btn-success">
                            ✨ חשב חלוקה
                        </button>
                    </div>

                    <div id="calc-results" class="calc-results">
                        <h4 style="margin-bottom: 15px; color: #111827;">💡 המלצת חלוקה:</h4>
                        <div id="calc-items"></div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>סה"כ:</span>
                                <span id="calc-total" style="color: #667eea; font-size: 1.2rem;">₪0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                    <h4 style="margin-bottom: 10px; color: #1e40af;">ℹ️ איך זה עובד?</h4>
                    <ul style="color: #1e3a8a; line-height: 1.8;">
                        <li>המערכת מחשבת את הפער של כל קבוצה מהיעד שלה</li>
                        <li>הקבוצות עם הפער הגדול ביותר מקבלות יותר כסף</li>
                        <li>בתוך כל קבוצה, ההשקעה מתחלקת באופן שווה בין המניות</li>
                        <li>זה עוזר לך לשמור על התמהיל הרצוי לאורך זמן</li>
                    </ul>
                </div>
            </div>

            <!-- Holdings Tab -->
            <div id="tab-holdings" class="tab-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="showAddHoldingForm()" class="btn btn-success">➕ הוסף החזקה</button>
                    <button onclick="refreshPrices()" class="btn btn-primary">🔄 רענן מחירים</button>
                </div>

                <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <span style="font-size: 1.5rem;">🇮🇱</span>
                        <div>
                            <strong style="color: #1e40af;">ניירות ערך ישראליים:</strong>
                            <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 0.9rem;">
                                למספרי ניירות ערך ישראליים (7 ספרות, לדוגמא: 1209220), <strong>הזן את המספר</strong>. המערכת תנסה לשאוב מחירים מהבורסה.
                            </p>
                            <div style="margin: 8px 0 0 0; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <p style="margin: 0; color: #92400e; font-size: 0.85rem;">
                                    ⚠️ <strong>חשוב:</strong> שאיבת מחירים אוטומטית מהבורסה הישראלית לא תמיד עובדת (בגלל מגבלות טכניות).
                                </p>
                            </div>
                            <p style="margin: 8px 0 0 0; color: #1e3a8a; font-size: 0.85rem;">
                                💡 <strong>המלצה:</strong> 
                            </p>
                            <ol style="margin: 5px 0 0 20px; color: #1e3a8a; font-size: 0.85rem; line-height: 1.6;">
                                <li>הגדר <strong>"טיקר חלופי"</strong> (אם יש - לדוגמא: VWRL.L לתעודת סל)</li>
                                <li>או השתמש בכפתור <strong>"💰 מחיר"</strong> לעדכן ידנית</li>
                                <li>עדכן מחירים ידנית מ<a href="https://www.tase.co.il" target="_blank" style="color: #667eea;">אתר הבורסה</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="add-holding-form" style="display: none; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 12px;">
                    <h3 style="margin-bottom: 20px;">הוסף החזקה חדשה</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>סימול / מס' נייר ערך (למשל: AAPL, 1209220)</label>
                            <input type="text" id="new-symbol" placeholder="AAPL">
                            <small style="color: #6b7280; font-size: 0.8rem;">ניירות ישראליים: הזן מספר נייר ערך בן 7 ספרות</small>
                        </div>
                        <div class="form-group">
                            <label>טיקר חלופי (גיבוי - אופציונלי)</label>
                            <input type="text" id="new-alt-ticker" placeholder="VWRL.L">
                            <small style="color: #6b7280; font-size: 0.8rem;">גיבוי אם השאיבה מהבורסה הישראלית לא עובדת</small>
                        </div>
                        <div class="form-group">
                            <label>מספר מניות</label>
                            <input type="number" id="new-shares" placeholder="10" step="0.001">
                        </div>
                        <div class="form-group">
                            <label>מחיר קנייה ממוצע</label>
                            <input type="number" id="new-cost" placeholder="150.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>מטבע</label>
                            <select id="new-currency">
                                <option value="ILS">₪ שקל</option>
                                <option value="USD">$ דולר</option>
                                <option value="EUR">€ יורו</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>קבוצה</label>
                            <select id="new-group"></select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addHolding()" class="btn btn-success">✅ שמור</button>
                        <button onclick="hideAddHoldingForm()" class="btn" style="background: #6b7280; color: white;">❌ ביטול</button>
                    </div>
                </div>

                <div id="holdings-list" class="holdings-grid"></div>
            </div>

            <!-- Groups Tab -->
            <div id="tab-groups" class="tab-content">
                <h3 style="margin-bottom: 20px;">קבוצות ההשקעה שלך</h3>
                <div id="groups-list" class="groups-list"></div>
            </div>

            <!-- Recommendations Tab -->
            <div id="tab-recommendations" class="tab-content">
                <h3 style="margin-bottom: 20px;">💡 המלצות לאיזון תיק</h3>
                <div id="recommendations-list"></div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <h3 style="margin-bottom: 20px;">⚙️ הגדרות</h3>
                
                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">💱 שערי המרה</h4>
                    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                        📝 <strong>ערוך את השערים ידנית</strong> או נסה רענון אוטומטי
                    </p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>דולר ($) לשקל</label>
                            <input type="number" id="rate-usd" step="0.0001" value="3.7500" 
                                   placeholder="3.7500" 
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                        <div class="form-group">
                            <label>יורו (€) לשקל</label>
                            <input type="number" id="rate-eur" step="0.0001" value="4.0500" 
                                   placeholder="4.0500"
                                   style="background: #fffbeb; border: 2px solid #f59e0b;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="tryAutoUpdateRates()" class="btn btn-primary">
                            🔄 רענן אוטומטית
                        </button>
                        <button onclick="updateExchangeRates()" class="btn btn-success">
                            💾 שמור שערים
                        </button>
                    </div>
                    <p style="color: #6b7280; margin-top: 10px; font-size: 0.8rem;">
                        💡 רענון אוטומטי מנסה למשוך שערים מהאינטרנט. אם זה לא עובד, ערוך ידנית מ-<a href="https://www.boi.org.il/he/markets/exchangerates/" target="_blank" style="color: #667eea;">בנק ישראל</a>
                    </p>
                </div>

                <div class="glass" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">💰 אג"ח ממשלתי</h4>
                    <div class="form-group">
                        <label>סכום באג"ח (בשקלים)</label>
                        <input type="number" id="bonds-amount" step="100" value="0">
                    </div>
                    <button onclick="saveBonds()" class="btn btn-primary" style="margin-top: 15px;">💾 שמור</button>
                </div>

                <div class="glass">
                    <h4 style="margin-bottom: 15px;">💾 גיבוי ושחזור</h4>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportData()" class="btn btn-primary">📤 ייצוא נתונים</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            📥 ייבוא נתונים
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End mainContent -->

    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase Import
        import { auth, db, onAuthStateChanged, doc, setDoc, getDoc } from './firebase-config.js';

        // Check authentication
        let currentUser = null;
        let authChecked = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                if (!authChecked) {
                    authChecked = true;
                    init();
                }
            } else {
                console.log('No user, redirecting to login...');
                window.location.href = 'login.html';
            }
        });

        // ===========================================
        // DATA STRUCTURE
        // ===========================================
        
        let editingHoldingId = null; // Track which holding is being edited
        
        let portfolio = {
            holdings: [
                {
                    id: 1760608097331,
                    symbol: "USSC.L",
                    shares: 154,
                    costBasis: 61.55,
                    currentPrice: 73.92,
                    currency: "USD",
                    groupId: 1,
                    altTicker: "",
                    lastUpdate: "2025-10-18T19:33:43.765Z"
                },
                {
                    id: 1760646969798,
                    symbol: "1209220",
                    shares: 1868,
                    costBasis: 24.4045,
                    currentPrice: 119.56,
                    currency: "ILS",
                    groupId: 1,
                    altTicker: "VWRL.L",
                    lastUpdate: "2025-10-18T19:33:46.020Z"
                },
                {
                    id: 1760815197550,
                    symbol: "AVGS.L",
                    shares: 215,
                    costBasis: 22.146,
                    currentPrice: 22.345,
                    currency: "USD",
                    groupId: 1,
                    altTicker: "",
                    lastUpdate: "2025-10-18T19:33:46.239Z"
                }
            ],
            groups: [
                { id: 1, name: 'מדדים עולמיים', target: 60, color: '#3b82f6' },
                { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                { id: 3, name: 'אקטיבי/סיכוני', target: 10, color: '#ef4444' }
            ],
            rates: { USD: 3.3062, EUR: 3.8619, GBP: 1.27 },
            bonds: 0
        };

        let charts = {};

        // ===========================================
        // EXCHANGE RATES - AUTO UPDATE
        // ===========================================
        
        async function updateExchangeRates() {
            // עדכון מהשדות בממשק (עדכון ידני)
            const usdInput = document.getElementById('rate-usd');
            const eurInput = document.getElementById('rate-eur');
            
            const usdValue = parseFloat(usdInput.value);
            const eurValue = parseFloat(eurInput.value);
            
            if (!isNaN(usdValue) && usdValue > 0) {
                portfolio.rates.USD = usdValue;
            }
            if (!isNaN(eurValue) && eurValue > 0) {
                portfolio.rates.EUR = eurValue;
            }
            
            saveData();
            updateOverview();
            notify(`✅ שערים נשמרו! $1 = ₪${portfolio.rates.USD.toFixed(2)} | €1 = ₪${portfolio.rates.EUR.toFixed(2)}`);
        }
        
        async function tryAutoUpdateRates() {
            const notif = document.getElementById('notification');
            notif.textContent = '🔄 מושך שערים מהאינטרנט...';
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🔄 Starting automatic exchange rate update...');
            console.log('Current rates before update:', { 
                USD: portfolio.rates.USD, 
                EUR: portfolio.rates.EUR 
            });
            
            try {
                const success = await autoUpdateExchangeRates();
                
                // Always hide the loading message
                notif.classList.remove('show');
                
                if (success) {
                    console.log('New rates after update:', { 
                        USD: portfolio.rates.USD, 
                        EUR: portfolio.rates.EUR 
                    });
                    console.log('✅ Exchange rates updated successfully!');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    
                    updateOverview();
                    notify(`✅ שערים עודכנו!\n💵 $1 = ₪${portfolio.rates.USD.toFixed(4)}\n💶 €1 = ₪${portfolio.rates.EUR.toFixed(4)}`);
                } else {
                    console.log('❌ All API methods failed');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    notify('⚠️ עדכון אוטומטי נכשל. ערוך ידנית או נסה שוב מאוחר יותר', 'warning');
                }
            } catch (error) {
                console.error('❌ Error during exchange rate update:', error);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                notif.classList.remove('show');
                notify('❌ שגיאה בעדכון שערים. נסה שוב מאוחר יותר', 'error');
            }
        }
        
        async function autoUpdateExchangeRates() {
            // ניסיון עדכון אוטומטי עם מספר APIs (אופציונלי - לא כשלון אם נכשל)
            console.log('🔄 Trying to auto-update exchange rates...');
            
            // ניסיון 1: Frankfurter API
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS,EUR');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Frankfurter API response:', data);
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: 1 USD = X ILS and 1 USD = Y EUR
                        // We need: USD to ILS and EUR to ILS
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`💵 USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // If 1 USD = 3.75 ILS and 1 USD = 0.92 EUR
                        // Then 1 EUR = (1/0.92) USD = 1.087 USD
                        // So 1 EUR = 1.087 × 3.75 = 4.08 ILS
                        // Formula: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`💶 EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('✅ Exchange rates updated via Frankfurter API');
                        console.log(`   Final rates: $1 = ₪${portfolio.rates.USD.toFixed(4)}, €1 = ₪${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('⚠️ Frankfurter API failed:', error.message);
            }
            
            // ניסיון 2: ExchangeRate-API
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 ExchangeRate-API response (first 5 rates):', {
                        ILS: data.rates?.ILS,
                        EUR: data.rates?.EUR,
                        GBP: data.rates?.GBP,
                        JPY: data.rates?.JPY,
                        CNY: data.rates?.CNY
                    });
                    
                    if (data.rates && data.rates.ILS) {
                        // API returns: all rates relative to 1 USD
                        // 1 USD = X ILS, 1 USD = Y EUR
                        
                        // USD to ILS (direct from API)
                        portfolio.rates.USD = data.rates.ILS;
                        console.log(`💵 USD to ILS: ${portfolio.rates.USD}`);
                        
                        // EUR to ILS calculation:
                        // Same logic as above: EUR_to_ILS = USD_to_ILS / USD_to_EUR
                        if (data.rates.EUR) {
                            portfolio.rates.EUR = data.rates.ILS / data.rates.EUR;
                            console.log(`💶 EUR to ILS: ${portfolio.rates.EUR} (calculated from USD_to_ILS=${data.rates.ILS} / USD_to_EUR=${data.rates.EUR})`);
                        }
                        
                        // Update UI
                        document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
                        document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
                        
                        saveData();
                        console.log('✅ Exchange rates updated via ExchangeRate-API');
                        console.log(`   Final rates: $1 = ₪${portfolio.rates.USD.toFixed(4)}, €1 = ₪${portfolio.rates.EUR.toFixed(4)}`);
                        return true;
                    }
                }
            } catch (error) {
                console.log('⚠️ ExchangeRate-API failed:', error.message);
            }
            
            // ניסיון 3: הוסף Bank of Israel API אם אפשרי
            try {
                // Note: BOI API usually requires CORS proxy or backend
                // This is a fallback attempt
                const response = await fetch('https://www.boi.org.il/currency.xml');
                if (response.ok) {
                    const text = await response.text();
                    console.log('📊 BOI XML received, parsing...');
                    // Parse XML for USD and EUR rates
                    // This is complex and might not work due to CORS
                }
            } catch (error) {
                console.log('⚠️ BOI API not accessible (CORS or network issue)');
            }
            
            console.log('ℹ️ All auto-update methods failed - using manual rates');
            console.log('💡 You can update manually from: https://www.boi.org.il/he/markets/exchangerates/');
            return false;
        }

        // ===========================================
        // ISRAELI TASE (BORSE) API
        // ===========================================
        
        async function fetchTASEPrice(securityNumber) {
            console.log(`🇮🇱 Israeli security detected: ${securityNumber}`);
            console.log(`⚠️ Due to CORS restrictions, automatic price fetching for Israeli securities is not possible from browser`);
            console.log(`💡 Please use the "💰 מחיר" button to update price manually`);
            
            // We can't fetch Israeli securities automatically due to CORS
            // All proxy services are blocked or unreliable
            // The only reliable way is manual update
            
            throw new Error(`🇮🇱 ניירות ערך ישראליים דורשים עדכון ידני. לחץ על "💰 מחיר" ליד המניה.`);
        }
        
        function isIsraeliSecurity(symbol) {
            // Israeli security numbers are 7 digits
            return /^\d{7}$/.test(symbol);
        }

        // ===========================================
        // ENHANCED API - WITH MULTIPLE FALLBACKS
        // ===========================================
        
        async function fetchStockPrice(symbol) {
            console.log(`🔍 Fetching price for: ${symbol}`);
            
            // First, check if this is an Israeli security
            if (isIsraeliSecurity(symbol)) {
                console.log('🇮🇱 Detected Israeli security number, trying TASE first...');
                try {
                    const price = await fetchTASEPrice(symbol);
                    return price;
                } catch (e) {
                    console.log('⚠️ TASE fetch failed, will try alternatives if available');
                }
            }
            
            // ניסוי 3 שיטות שונות
            const methods = [
                () => fetchYahooChart(symbol),
                () => fetchYahooQuote(symbol),
                () => fetchYahooV10(symbol)
            ];
            
            // ניסיון עם הסימול המקורי
            for (const method of methods) {
                try {
                    const price = await method();
                    if (price && price > 0) {
                        console.log(`✅ Success: ${price}`);
                        return price;
                    }
                } catch (e) {
                    console.log(`❌ Method failed: ${e.message}`);
                }
            }
            
            // ניסיון עם סימולים חלופיים
            const alternatives = getAlternativeSymbols(symbol);
            for (const alt of alternatives) {
                console.log(`🔄 Trying alternative: ${alt}`);
                for (const method of methods) {
                    try {
                        const price = await method.call(null, alt);
                        if (price && price > 0) {
                            console.log(`✅ Success with alternative: ${price}`);
                            return price;
                        }
                    } catch (e) {
                        // שקט, ממשיכים הלאה
                    }
                }
            }
            
            throw new Error(`Could not fetch price for ${symbol}`);
        }
        
        async function fetchYahooChart(symbol) {
            // Using CORS proxy to bypass CORS restrictions
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.chart?.result?.[0]?.meta?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooQuote(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteResponse?.result?.[0]?.regularMarketPrice;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        async function fetchYahooV10(symbol) {
            const proxies = [
                `https://api.allorigins.win/raw?url=`,
                `https://corsproxy.io/?`
            ];
            
            for (const proxy of proxies) {
                try {
                    const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    if (!response.ok) continue;
                    const data = await response.json();
                    const price = data.quoteSummary?.result?.[0]?.price?.regularMarketPrice?.raw;
                    if (price && price > 0) return price;
                } catch (e) {
                    console.log(`Proxy ${proxy} failed:`, e.message);
                }
            }
            throw new Error('All proxies failed');
        }
        
        function getAlternativeSymbols(symbol) {
            const alternatives = [];
            if (symbol.endsWith('.L')) {
                alternatives.push(symbol.replace('.L', '.AS'));
            }
            if (symbol.endsWith('.AS')) {
                alternatives.push(symbol.replace('.AS', '.L'));
            }
            if (symbol.endsWith('.DE')) {
                alternatives.push(symbol.replace('.DE', '.AS'));
            }
            if (symbol.includes('.')) {
                alternatives.push(symbol.split('.')[0]);
            }
            return alternatives;
        }
        
        // ===========================================
        // FIX EXISTING DATA
        // ===========================================
        
        function fixGroupIds() {
            console.log('🔧 Starting to fix groupIds...');
            console.log('📊 Holdings before fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            let fixedCount = 0;
            
            portfolio.holdings.forEach(holding => {
                const originalGroupId = holding.groupId;
                
                // If groupId is missing, undefined, null, or NaN
                if (!holding.groupId || isNaN(parseInt(holding.groupId))) {
                    console.log(`⚠️ ${holding.symbol}: Invalid groupId (${holding.groupId}), setting to 1`);
                    holding.groupId = 1;
                    fixedCount++;
                } else {
                    // Parse to ensure it's a number
                    const parsed = parseInt(holding.groupId);
                    if (parsed !== holding.groupId) {
                        console.log(`🔧 ${holding.symbol}: Converting groupId from ${holding.groupId} (${typeof holding.groupId}) to ${parsed}`);
                        holding.groupId = parsed;
                        fixedCount++;
                    }
                }
            });
            
            console.log('📊 Holdings after fix:', portfolio.holdings.map(h => ({ 
                symbol: h.symbol, 
                groupId: h.groupId, 
                type: typeof h.groupId 
            })));
            
            // Save the fixed data
            saveData();
            
            // Update displays
            updateOverview();
            renderHoldingsList();
            renderGroupsList();
            
            if (fixedCount > 0) {
                notify(`✅ תוקנו ${fixedCount} מניות. רענן את הדף אם עדיין יש בעיות.`);
            } else {
                notify(`ℹ️ כל המניות כבר תקינות`);
            }
            
            console.log(`✅ Fixed ${fixedCount} holdings`);
        }
        
        // ===========================================
        // REFRESH PRICES
        // ===========================================
        
        async function refreshPrices() {
            const notif = document.getElementById('notification');
            notif.textContent = '🔄 מרענן מחירים... 0/' + portfolio.holdings.length;
            notif.className = 'notification show';
            notif.style.background = '#3b82f6';
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            const manualUpdateNeeded = [];
            
            for (let i = 0; i < portfolio.holdings.length; i++) {
                const holding = portfolio.holdings[i];
                
                // Update progress
                notif.textContent = `🔄 מרענן מחירים... ${i + 1}/${portfolio.holdings.length} (${holding.symbol})`;
                
                try {
                    let price = null;
                    
                    // Strategy: Try Israeli TASE first if applicable, then altTicker, then main symbol
                    if (isIsraeliSecurity(holding.symbol)) {
                        // Try TASE for Israeli securities
                        try {
                            price = await fetchStockPrice(holding.symbol);
                            console.log(`✅ ${holding.symbol}: ₪${price} (from TASE)`);
                        } catch (e) {
                            console.log(`⚠️ TASE failed for ${holding.symbol}: ${e.message}`);
                            // If TASE fails and there's an alternative ticker, try it
                            if (holding.altTicker) {
                                try {
                                    price = await fetchStockPrice(holding.altTicker);
                                    console.log(`✅ ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${holding.altTicker})`);
                                } catch (e2) {
                                    console.log(`⚠️ Alt ticker also failed for ${holding.symbol}`);
                                    manualUpdateNeeded.push(holding.symbol);
                                    throw new Error('עדכן ידנית');
                                }
                            } else {
                                manualUpdateNeeded.push(holding.symbol);
                                throw e; // Re-throw if no alternative
                            }
                        }
                    } else {
                        // For non-Israeli securities, use altTicker if available, otherwise main symbol
                        const tickerToUse = holding.altTicker || holding.symbol;
                        price = await fetchStockPrice(tickerToUse);
                        console.log(`✅ ${holding.symbol}: ${getCurrencySymbol(holding.currency)}${price} (from ${tickerToUse})`);
                    }
                    
                    holding.currentPrice = price;
                    holding.lastUpdate = new Date().toISOString();
                    successCount++;
                } catch (error) {
                    console.error(`❌ Failed: ${holding.symbol}${holding.altTicker ? ` (alt: ${holding.altTicker})` : ''}`, error);
                    errorCount++;
                    errors.push(holding.symbol);
                }
                
                // המתנה קצרה בין בקשות
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            saveData();
            updateOverview();
            renderHoldingsList();
            
            // Hide loading notification
            notif.classList.remove('show');
            
            // Show final result
            if (errorCount === 0) {
                notify(`✅ ${successCount} מחירים עודכנו בהצלחה!`);
            } else if (successCount === 0) {
                notify(`❌ כל הניסיונות נכשלו. בדוק את החיבור לאינטרנט`, 'error');
            } else {
                let msg = `⚠️ ${successCount} הצליחו, ${errorCount} נכשלו`;
                if (manualUpdateNeeded.length > 0) {
                    msg += `\n\n🇮🇱 ניירות ישראליים שדורשים עדכון ידני:\n${manualUpdateNeeded.join(', ')}\n\nלחץ על כפתור "💰 מחיר" ליד המניה לעדכן ידנית`;
                }
                notify(msg, 'warning');
            }
        }

        // ===========================================
        // INVESTMENT CALCULATOR
        // ===========================================
        
        function calculateInvestment() {
            const amount = parseFloat(document.getElementById('invest-amount').value);
            
            if (!amount || amount <= 0) {
                notify('❌ הזן סכום תקין', 'error');
                return;
            }
            
            // חישוב סטטוס נוכחי
            const totalValue = getTotalValueILS();
            const groupsStatus = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const currentPercent = (groupValue / totalValue) * 100;
                const gap = group.target - currentPercent;
                
                return {
                    group,
                    currentPercent,
                    gap,
                    value: groupValue
                };
            });
            
            // מיון לפי פער (הכי חסר קודם)
            groupsStatus.sort((a, b) => b.gap - a.gap);
            
            // חלוקה פרופורציונלית לפי פערים
            const totalGap = groupsStatus.reduce((sum, g) => sum + Math.max(0, g.gap), 0);
            
            const allocations = groupsStatus.map(status => {
                const proportion = totalGap > 0 ? Math.max(0, status.gap) / totalGap : 1 / groupsStatus.length;
                const allocatedAmount = amount * proportion;
                
                // חלוקה שווה בתוך הקבוצה
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === status.group.id);
                const perHolding = groupHoldings.length > 0 ? allocatedAmount / groupHoldings.length : 0;
                
                return {
                    group: status.group.name,
                    amount: allocatedAmount,
                    holdings: groupHoldings.map(h => ({
                        symbol: h.symbol,
                        amount: perHolding
                    }))
                };
            });
            
            // הצגת תוצאות
            displayCalculatorResults(allocations, amount);
        }
        
        function displayCalculatorResults(allocations, totalAmount) {
            const container = document.getElementById('calc-items');
            const resultsDiv = document.getElementById('calc-results');
            
            let html = '';
            let displayedTotal = 0;
            
            allocations.forEach(alloc => {
                if (alloc.amount > 0) {
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${alloc.group} - ₪${Math.round(alloc.amount).toLocaleString()}</div>`;
                    
                    alloc.holdings.forEach(holding => {
                        if (holding.amount > 0) {
                            html += `<div class="calc-item">`;
                            html += `<span class="calc-symbol">${holding.symbol}</span>`;
                            html += `<span class="calc-amount">₪${Math.round(holding.amount).toLocaleString()}</span>`;
                            html += `</div>`;
                            displayedTotal += holding.amount;
                        }
                    });
                    
                    html += `</div>`;
                }
            });
            
            container.innerHTML = html;
            document.getElementById('calc-total').textContent = `₪${Math.round(displayedTotal).toLocaleString()}`;
            resultsDiv.classList.add('show');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function notify(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = 'notification show';
            
            // Remove all type classes first
            notif.classList.remove('error', 'warning');
            
            if (type === 'error') notif.classList.add('error');
            if (type === 'warning') notif.classList.add('warning');
            
            // Don't auto-hide for loading messages
            if (type === 'loading') {
                notif.style.background = '#3b82f6';
                return; // Stay visible
            }
            
            setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find and activate the clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find the button by tab name
                const buttons = document.querySelectorAll('.tab-btn');
                buttons.forEach((btn, index) => {
                    if (btn.textContent.includes('סקירה') && tabName === 'overview') btn.classList.add('active');
                    if (btn.textContent.includes('מחשבון') && tabName === 'calculator') btn.classList.add('active');
                    if (btn.textContent.includes('החזקות') && tabName === 'holdings') btn.classList.add('active');
                    if (btn.textContent.includes('קבוצות') && tabName === 'groups') btn.classList.add('active');
                    if (btn.textContent.includes('המלצות') && tabName === 'recommendations') btn.classList.add('active');
                    if (btn.textContent.includes('הגדרות') && tabName === 'settings') btn.classList.add('active');
                });
            }
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'overview') updateOverview();
            if (tabName === 'holdings') renderHoldingsList();
            if (tabName === 'groups') renderGroupsList();
            if (tabName === 'recommendations') renderRecommendations();
        }
        
        function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            if (currency === 'USD') return amount * portfolio.rates.USD;
            if (currency === 'EUR') return amount * portfolio.rates.EUR;
            return amount;
        }
        
        function getTotalValueILS() {
            return portfolio.holdings.reduce((sum, h) => {
                const value = h.shares * (h.currentPrice || h.costBasis);
                return sum + convertToILS(value, h.currency);
            }, 0);
        }
        
        function getCurrencySymbol(currency) {
            const symbols = { ILS: '₪', USD: '$', EUR: '€' };
            return symbols[currency] || currency;
        }

        // ===========================================
        // DATA MANAGEMENT - FIREBASE
        // ===========================================
        
        async function saveData() {
            if (!currentUser) {
                console.warn('No user logged in, cannot save');
                return;
            }
            
            try {
                // CRITICAL FIX: Always save with default groups
                const defaultGroups = [
                    { id: 1, name: 'מדדים עולמיים', target: 60, color: '#3b82f6' },
                    { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                    { id: 3, name: 'אקטיבי/סיכוני', target: 10, color: '#ef4444' }
                ];
                
                // Validate all holdings have valid groupId
                if (Array.isArray(portfolio.holdings)) {
                    portfolio.holdings = portfolio.holdings.map(h => {
                        const groupId = parseInt(h.groupId);
                        if (isNaN(groupId) || groupId <= 0) {
                            console.warn(`⚠️ Invalid groupId for ${h.symbol}, setting to 1`);
                            return { ...h, groupId: 1 };
                        }
                        return h;
                    });
                }
                
                // Always save with default groups
                const dataToSave = {
                    holdings: portfolio.holdings,
                    groups: defaultGroups,
                    rates: portfolio.rates,
                    bonds: portfolio.bonds,
                    lastModified: new Date().toISOString()
                };
                
                // Save to Firebase
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                await setDoc(userDocRef, dataToSave);
                console.log('✅ Data saved to Firebase');
                
                // Also save to localStorage as backup
                localStorage.setItem('portfolio', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('❌ Error saving data:', error);
                notify('⚠️ שגיאה בשמירת נתונים', 'error');
                
                // Fallback to localStorage
                try {
                    const defaultGroups = [
                        { id: 1, name: 'מדדים עולמיים', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: 'אקטיבי/סיכוני', target: 10, color: '#ef4444' }
                    ];
                    const dataToSave = {
                        holdings: portfolio.holdings,
                        groups: defaultGroups,
                        rates: portfolio.rates,
                        bonds: portfolio.bonds
                    };
                    localStorage.setItem('portfolio', JSON.stringify(dataToSave));
                } catch (e) {
                    console.error('❌ localStorage fallback failed:', e);
                }
            }
        }
        
        async function loadData() {
            if (!currentUser) {
                console.warn('No user logged in, cannot load');
                return false;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid, 'portfolio', 'data');
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const loaded = docSnap.data();
                    
                    const defaultGroups = [
                        { id: 1, name: 'מדדים עולמיים', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: 'אקטיבי/סיכוני', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            
                            const holding = {
                                ...h,
                                groupId: validGroupId
                            };
                            console.log(`📦 Loaded: ${holding.symbol}, groupId: ${holding.groupId}`);
                            return holding;
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        bonds: typeof loaded.bonds === 'number' ? loaded.bonds : 0
                    };
                    
                    console.log('✅ Data loaded from Firebase');
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('portfolio', JSON.stringify({
                        holdings: portfolio.holdings,
                        groups: defaultGroups,
                        rates: portfolio.rates,
                        bonds: portfolio.bonds
                    }));
                    
                    console.log('📊 Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('No Firebase data, trying localStorage...');
                    return loadFromLocalStorage();
                }
            } catch (error) {
                console.error('❌ Firebase load failed:', error);
                return loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('portfolio');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    const defaultGroups = [
                        { id: 1, name: 'מדדים עולמיים', target: 60, color: '#3b82f6' },
                        { id: 2, name: 'Small Cap Value', target: 30, color: '#10b981' },
                        { id: 3, name: 'אקטיבי/סיכוני', target: 10, color: '#ef4444' }
                    ];
                    
                    portfolio = {
                        holdings: Array.isArray(loaded.holdings) ? loaded.holdings.map(h => {
                            const groupId = parseInt(h.groupId);
                            const validGroupId = isNaN(groupId) ? 1 : groupId;
                            
                            const holding = {
                                ...h,
                                groupId: validGroupId
                            };
                            return holding;
                        }) : [],
                        groups: defaultGroups,
                        rates: loaded.rates && typeof loaded.rates === 'object' ? loaded.rates : portfolio.rates,
                        bonds: typeof loaded.bonds === 'number' ? loaded.bonds : 0
                    };
                    
                    console.log('✅ Data loaded from localStorage');
                    console.log('📊 Holdings loaded:', portfolio.holdings.length);
                    return true;
                } else {
                    console.log('ℹ️ No saved data, using defaults');
                    if (!Array.isArray(portfolio.holdings)) {
                        portfolio.holdings = [];
                    }
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading data:', error);
                notify('⚠️ שגיאה בטעינת נתונים', 'error');
                portfolio.holdings = [];
                return false;
            }
        }

        // ===========================================
        // HOLDINGS MANAGEMENT - FIXED
        // ===========================================
        
        function showAddHoldingForm() {
            editingHoldingId = null; // Reset editing mode
            document.getElementById('add-holding-form').style.display = 'block';
            updateGroupSelect();
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = 'הוסף החזקה חדשה';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('add-holding-form').style.display = 'none';
            editingHoldingId = null;
            
            // Clear form
            document.getElementById('new-symbol').value = '';
            document.getElementById('new-shares').value = '';
            document.getElementById('new-cost').value = '';
            document.getElementById('new-alt-ticker').value = '';
            
            // Reset form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = 'הוסף החזקה חדשה';
        }
        
        function updateGroupSelect() {
            const select = document.getElementById('new-group');
            if (!select) {
                console.error('❌ Group select element not found');
                return;
            }
            select.innerHTML = portfolio.groups.map(g => 
                `<option value="${g.id}">${g.name}</option>`
            ).join('');
        }
        
        function addHolding() {
            console.log('🔍 Starting addHolding function...');
            console.log('📍 Step 1: Getting form elements');
            
            const symbolInput = document.getElementById('new-symbol');
            const sharesInput = document.getElementById('new-shares');
            const costInput = document.getElementById('new-cost');
            const currencySelect = document.getElementById('new-currency');
            const groupSelect = document.getElementById('new-group');
            
            // בדיקה שכל האלמנטים קיימים
            console.log('📍 Step 2: Checking if elements exist', {
                symbolInput: !!symbolInput,
                sharesInput: !!sharesInput,
                costInput: !!costInput,
                currencySelect: !!currencySelect,
                groupSelect: !!groupSelect
            });
            
            if (!symbolInput || !sharesInput || !costInput || !currencySelect || !groupSelect) {
                console.error('❌ One or more form elements not found');
                notify('❌ שגיאה בטופס - אלמנט לא נמצא', 'error');
                return;
            }
            
            console.log('📍 Step 3: Reading form values');
            const symbol = symbolInput.value.trim().toUpperCase();
            const sharesStr = sharesInput.value.trim();
            const costStr = costInput.value.trim();
            const currency = currencySelect.value;
            const groupId = parseInt(groupSelect.value);
            const altTicker = document.getElementById('new-alt-ticker')?.value.trim().toUpperCase() || '';
            
            console.log('📋 Form values:', { 
                symbol, 
                shares: sharesStr, 
                cost: costStr, 
                currency, 
                groupId,
                altTicker,
                raw: {
                    symbolRaw: symbolInput.value,
                    sharesRaw: sharesInput.value,
                    costRaw: costInput.value
                }
            });
            
            // בדיקת תקינות - שדות ריקים
            console.log('📍 Step 4: Validating empty fields');
            if (!symbol || !sharesStr || !costStr) {
                console.error('❌ Empty fields detected:', { symbol, sharesStr, costStr });
                notify('❌ מלא את כל השדות', 'error');
                return;
            }
            
            // המרה למספרים
            console.log('📍 Step 5: Converting to numbers');
            const shares = parseFloat(sharesStr);
            const cost = parseFloat(costStr);
            
            console.log('🔢 Parsed numbers:', { shares, cost, isNaN_shares: isNaN(shares), isNaN_cost: isNaN(cost) });
            
            // בדיקה שהמרה הצליחה
            if (isNaN(shares) || isNaN(cost)) {
                console.error('❌ NaN detected after parsing');
                notify('❌ הכמות והמחיר חייבים להיות מספרים', 'error');
                return;
            }
            
            // בדיקה שהערכים חיוביים
            console.log('📍 Step 6: Validating positive numbers');
            if (shares <= 0 || cost <= 0) {
                console.error('❌ Non-positive numbers:', { shares, cost });
                notify('❌ הכמות והמחיר חייבים להיות גדולים מאפס', 'error');
                return;
            }
            
            // בדיקה אם אנחנו במצב עריכה או הוספה
            if (editingHoldingId !== null) {
                // מצב עריכה - עדכן החזקה קיימת
                console.log('📍 Step 7: Updating existing holding:', editingHoldingId);
                const holding = portfolio.holdings.find(h => h.id === editingHoldingId);
                if (holding) {
                    holding.symbol = symbol;
                    holding.shares = shares;
                    holding.costBasis = cost;
                    holding.currency = currency;
                    holding.groupId = groupId;
                    holding.altTicker = altTicker;
                    holding.lastUpdate = new Date().toISOString();
                    console.log('✅ Holding updated:', holding);
                }
            } else {
                // מצב הוספה - צור החזקה חדשה
                console.log('📍 Step 7: Creating new holding object');
                const newHolding = {
                    id: Date.now(),
                    symbol,
                    shares,
                    costBasis: cost,
                    currentPrice: cost,
                    currency,
                    groupId,
                    altTicker: altTicker || '',
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('➕ Adding holding:', newHolding);
                console.log('📊 Current holdings before add:', portfolio.holdings.length);
                
                portfolio.holdings.push(newHolding);
                
                console.log('📊 Current holdings after add:', portfolio.holdings.length);
            }
            
            console.log('📍 Step 8: Saving data');
            
            // שמירה
            saveData();
            
            console.log('📍 Step 9: Closing form and clearing inputs');
            
            // סגירת הטופס וניקוי
            hideAddHoldingForm();
            symbolInput.value = '';
            sharesInput.value = '';
            costInput.value = '';
            
            console.log('📍 Step 10: Updating UI');
            
            // עדכון התצוגה
            renderHoldingsList();
            updateOverview();
            
            const actionText = editingHoldingId ? 'עודכן' : 'נוסף';
            notify(`✅ ${symbol} ${actionText} בהצלחה!`);
            console.log('✅ Holding saved successfully. Total holdings:', portfolio.holdings.length);
            console.log('✅ addHolding function completed successfully');
        }
        
        function deleteHolding(id) {
            if (confirm('האם למחוק החזקה זו?')) {
                portfolio.holdings = portfolio.holdings.filter(h => h.id !== id);
                saveData();
                renderHoldingsList();
                updateOverview();
                notify('✅ החזקה נמחקה');
            }
        }
        
        function editHolding(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            // Set editing mode
            editingHoldingId = id;
            
            // Fill form with holding data
            document.getElementById('new-symbol').value = holding.symbol;
            document.getElementById('new-shares').value = holding.shares;
            document.getElementById('new-cost').value = holding.costBasis;
            document.getElementById('new-currency').value = holding.currency;
            document.getElementById('new-group').value = holding.groupId;
            document.getElementById('new-alt-ticker').value = holding.altTicker || '';
            
            // Change form title
            const formTitle = document.querySelector('#add-holding-form h3');
            if (formTitle) formTitle.textContent = `ערוך החזקה: ${holding.symbol}`;
            
            // Show form
            document.getElementById('add-holding-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('add-holding-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function updatePriceManually(id) {
            const holding = portfolio.holdings.find(h => h.id === id);
            if (!holding) return;
            
            const newPrice = prompt(`עדכן מחיר עבור ${holding.symbol}\n\nמחיר נוכחי: ${getCurrencySymbol(holding.currency)}${holding.currentPrice}\n\nהזן מחיר חדש:`, holding.currentPrice);
            
            if (newPrice === null) return; // User cancelled
            
            const price = parseFloat(newPrice);
            if (isNaN(price) || price <= 0) {
                notify('❌ מחיר לא תקין', 'error');
                return;
            }
            
            holding.currentPrice = price;
            holding.lastUpdate = new Date().toISOString();
            saveData();
            renderHoldingsList();
            updateOverview();
            notify(`✅ מחיר ${holding.symbol} עודכן ל-${getCurrencySymbol(holding.currency)}${price}`);
        }
        
        function renderHoldingsList() {
            const container = document.getElementById('holdings-list');
            
            if (!container) {
                console.error('❌ Holdings list container not found');
                return;
            }
            
            console.log('📊 Rendering holdings list. Total:', portfolio.holdings.length);
            
            if (portfolio.holdings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">אין החזקות עדיין</p>
                        <p>לחץ על "הוסף החזקה" כדי להתחיל</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = portfolio.holdings.map(holding => {
                // CRITICAL: Ensure groupId comparison works with both string and number
                const holdingGroupId = parseInt(holding.groupId);
                const group = portfolio.groups.find(g => g.id === holdingGroupId);
                
                const currentValue = holding.shares * (holding.currentPrice || holding.costBasis);
                const costValue = holding.shares * holding.costBasis;
                const profit = currentValue - costValue;
                const profitPercent = (profit / costValue) * 100;
                
                return `
                    <div class="holding-card">
                        <div class="holding-header">
                            <h4>
                                ${holding.symbol}
                                ${holding.altTicker ? `<span style="font-size: 0.75rem; color: #667eea; font-weight: normal;">→ ${holding.altTicker}</span>` : ''}
                                <span style="font-size: 0.8rem; color: #6b7280; font-weight: normal;">
                                    • ${group ? group.name : 'לא ידוע'}
                                </span>
                            </h4>
                            <div class="holding-actions">
                                <button onclick="editHolding(${holding.id})" class="btn btn-primary btn-sm" title="ערוך החזקה">
                                    ✏️ ערוך
                                </button>
                                <button onclick="updatePriceManually(${holding.id})" class="btn btn-success btn-sm" title="עדכן מחיר ידנית">
                                    💰 מחיר
                                </button>
                                <button onclick="deleteHolding(${holding.id})" class="btn btn-danger btn-sm">
                                    🗑️ מחק
                                </button>
                            </div>
                        </div>
                        <div class="holding-details">
                            <div class="detail-item">
                                <div class="detail-label">מניות</div>
                                <div class="detail-value">${holding.shares}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">מחיר קנייה</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${holding.costBasis.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">מחיר נוכחי</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${(holding.currentPrice || holding.costBasis).toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">שווי</div>
                                <div class="detail-value">${getCurrencySymbol(holding.currency)}${currentValue.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">רווח/הפסד</div>
                                <div class="detail-value ${profit >= 0 ? 'positive' : 'negative'}">
                                    ${profit >= 0 ? '+' : ''}${getCurrencySymbol(holding.currency)}${profit.toFixed(2)}
                                    (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===========================================
        // OVERVIEW
        // ===========================================
        
        function updateOverview() {
            console.log('🔄 Starting updateOverview...');
            console.log('📊 Total holdings:', portfolio.holdings.length);
            console.log('📋 Holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId })));
            
            const totalValue = getTotalValueILS();
            console.log('💰 Total value ILS:', totalValue);
            
            const totalCost = portfolio.holdings.reduce((sum, h) => {
                const cost = h.shares * h.costBasis;
                return sum + convertToILS(cost, h.currency);
            }, 0);
            const totalProfit = totalValue - totalCost;
            const profitPercent = totalCost > 0 ? (totalProfit / totalCost) * 100 : 0;
            
            // Update summary cards
            document.getElementById('total-value-ils').textContent = `₪${Math.round(totalValue).toLocaleString()}`;
            
            const usdTotal = portfolio.holdings.filter(h => h.currency === 'USD')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            const eurTotal = portfolio.holdings.filter(h => h.currency === 'EUR')
                .reduce((sum, h) => sum + (h.shares * (h.currentPrice || h.costBasis)), 0);
            
            document.getElementById('total-value-original').textContent = 
                `$${Math.round(usdTotal).toLocaleString()} + €${Math.round(eurTotal).toLocaleString()}`;
            
            document.getElementById('total-return').textContent = 
                `${totalProfit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%`;
            document.getElementById('total-return-amount').textContent = 
                `${totalProfit >= 0 ? '+' : ''}₪${Math.round(totalProfit).toLocaleString()}`;
            
            document.getElementById('bonds-value').textContent = `₪${portfolio.bonds.toLocaleString()}`;
            
            // Update last update time
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('last-update-date').textContent = now.toLocaleDateString('he-IL');
            
            // Render allocation comparison
            renderAllocationComparison();
            
            // Render chart
            renderPortfolioChart();
        }
        
        function renderAllocationComparison() {
            const container = document.getElementById('allocation-comparison');
            const totalValue = getTotalValueILS();
            
            console.log('📊 renderAllocationComparison - Total value:', totalValue);
            console.log('📊 All holdings:', portfolio.holdings.map(h => ({ symbol: h.symbol, groupId: h.groupId, groupIdType: typeof h.groupId })));
            
            const html = portfolio.groups.map(group => {
                // Handle both string and number groupId
                const groupHoldings = portfolio.holdings.filter(h => {
                    const holdingGroupId = parseInt(h.groupId);
                    return holdingGroupId === group.id;
                });
                
                console.log(`📂 Group ${group.name} (ID: ${group.id}):`, {
                    holdings: groupHoldings.length,
                    symbols: groupHoldings.map(h => h.symbol)
                });
                
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    const ilsValue = convertToILS(value, h.currency);
                    console.log(`  - ${h.symbol}: ${h.shares} × ${h.currentPrice || h.costBasis} ${h.currency} = ₪${ilsValue.toFixed(2)}`);
                    return sum + ilsValue;
                }, 0);
                
                console.log(`  Total group value: ₪${groupValue.toFixed(2)}`);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = actualPercent - group.target;
                
                let statusBadge = '';
                let statusClass = '';
                if (Math.abs(diff) < 2) {
                    statusBadge = '🟢 מאוזן';
                    statusClass = 'ok';
                } else if (diff < 0) {
                    statusBadge = `🟡 חסר ${Math.abs(diff).toFixed(1)}%`;
                    statusClass = 'under';
                } else {
                    statusBadge = `🔴 יתר ${diff.toFixed(1)}%`;
                    statusClass = 'over';
                }
                
                // Build holdings breakdown HTML
                const holdingsHTML = groupHoldings.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #6b7280; margin-bottom: 10px;">
                            📋 מניות בקבוצה (${groupHoldings.length}):
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const ilsValue = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (ilsValue / totalValue * 100) : 0;
                                const profit = value - (h.shares * h.costBasis);
                                const profitPercent = (profit / (h.shares * h.costBasis)) * 100;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                                padding: 8px 12px; background: white; border-radius: 6px; font-size: 0.85rem;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: #111827;">${h.symbol}</span>
                                            ${h.altTicker ? `<span style="font-size: 0.7rem; color: #667eea;">→ ${h.altTicker}</span>` : ''}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="color: #6b7280;">
                                                ₪${Math.round(ilsValue).toLocaleString()}
                                            </span>
                                            <span style="color: ${profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600; font-size: 0.8rem;">
                                                ${profit >= 0 ? '+' : ''}${profitPercent.toFixed(1)}%
                                            </span>
                                            <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: #6b7280;">
                                                ${holdingPercent.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; text-align: center; font-size: 0.85rem; color: #92400e;">
                        ⚠️ אין מניות בקבוצה זו
                    </div>
                `;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div class="group-target">יעד: ${group.target}%</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-header">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>בפועל: ${actualPercent.toFixed(1)}%</span>
                                    <span style="color: #6b7280; font-size: 0.85rem;">
                                        (₪${Math.round(groupValue).toLocaleString()})
                                    </span>
                                </div>
                                <span class="status-badge ${statusClass}">${statusBadge}</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        ${holdingsHTML}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function renderPortfolioChart() {
            const canvas = document.getElementById('portfolio-chart');
            if (!canvas) return;
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            const totalValue = getTotalValueILS();
            const data = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                return groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
            });
            
            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: portfolio.groups.map(g => g.name),
                    datasets: [{
                        data: data,
                        backgroundColor: portfolio.groups.map(g => g.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = totalValue > 0 ? (value / totalValue * 100).toFixed(1) : 0;
                                    return `${context.label}: ₪${Math.round(value).toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===========================================
        // GROUPS
        // ===========================================
        
        function renderGroupsList() {
            const container = document.getElementById('groups-list');
            const totalValue = getTotalValueILS();
            
            const html = portfolio.groups.map(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                
                return `
                    <div class="group-card">
                        <div class="group-header">
                            <div class="group-title">${group.name}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="group-target">יעד: ${group.target}% | בפועל: ${actualPercent.toFixed(1)}%</div>
                                <button onclick="editGroup(${group.id})" class="btn btn-primary btn-sm" title="ערוך קבוצה">
                                    ✏️ ערוך
                                </button>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${Math.min(actualPercent, 100)}%; background: ${group.color}">
                                    ${actualPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="group-holdings" style="margin-top: 15px; display: grid; gap: 10px;">
                            ${groupHoldings.map(h => {
                                const value = h.shares * (h.currentPrice || h.costBasis);
                                const valueILS = convertToILS(value, h.currency);
                                const holdingPercent = totalValue > 0 ? (valueILS / totalValue * 100) : 0;
                                
                                return `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                                        <span style="font-weight: 600;">${h.symbol}</span>
                                        <span style="color: #6b7280;">
                                            ₪${Math.round(valueILS).toLocaleString()} (${holdingPercent.toFixed(1)}%)
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // RECOMMENDATIONS
        // ===========================================
        
        function editGroup(groupId) {
            const group = portfolio.groups.find(g => g.id === groupId);
            if (!group) return;
            
            // שם הקבוצה
            const newName = prompt(`ערוך שם קבוצה\n\nשם נוכחי: ${group.name}\n\nהזן שם חדש:`, group.name);
            if (newName === null) return;
            if (newName.trim()) group.name = newName.trim();
            
            // אחוז יעד
            const newTarget = prompt(`ערוך אחוז יעד\n\nיעד נוכחי: ${group.target}%\n\nהזן יעד חדש (0-100):`, group.target);
            if (newTarget === null) return;
            const targetNum = parseFloat(newTarget);
            if (!isNaN(targetNum) && targetNum >= 0 && targetNum <= 100) {
                group.target = targetNum;
            }
            
            // צבע
            const newColor = prompt(`ערוך צבע קבוצה\n\nצבע נוכחי: ${group.color}\n\nהזן קוד צבע (HEX):`, group.color);
            if (newColor === null) return;
            if (newColor.trim()) group.color = newColor.trim();
            
            saveData();
            renderGroupsList();
            updateOverview();
            notify(`✅ קבוצה "${group.name}" עודכנה`);
        }
        
        function renderRecommendations() {
            const container = document.getElementById('recommendations-list');
            const totalValue = getTotalValueILS();
            
            const recommendations = [];
            
            portfolio.groups.forEach(group => {
                const groupHoldings = portfolio.holdings.filter(h => parseInt(h.groupId) === group.id);
                const groupValue = groupHoldings.reduce((sum, h) => {
                    const value = h.shares * (h.currentPrice || h.costBasis);
                    return sum + convertToILS(value, h.currency);
                }, 0);
                
                const actualPercent = totalValue > 0 ? (groupValue / totalValue) * 100 : 0;
                const diff = group.target - actualPercent;
                
                if (Math.abs(diff) > 2) {
                    recommendations.push({
                        group: group.name,
                        diff: diff,
                        action: diff > 0 ? 'buy' : 'sell'
                    });
                }
            });
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🎉</div>
                        <h3 style="color: #10b981; margin-bottom: 10px;">התיק מאוזן מצוין!</h3>
                        <p style="color: #6b7280;">כל הקבוצות קרובות ליעד שלהן</p>
                    </div>
                `;
                return;
            }
            
            const html = recommendations.map(rec => {
                const color = rec.action === 'buy' ? '#fef3c7' : '#fee2e2';
                const textColor = rec.action === 'buy' ? '#92400e' : '#991b1b';
                const icon = rec.action === 'buy' ? '💰' : '📉';
                const actionText = rec.action === 'buy' ? 'קנה' : 'מכור';
                
                return `
                    <div class="glass" style="background: ${color}; border: 2px solid ${textColor}40; margin-bottom: 15px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2rem;">${icon}</span>
                            <h4 style="color: ${textColor};">${actionText} ${rec.group}</h4>
                        </div>
                        <p style="color: ${textColor};">
                            ${rec.action === 'buy' 
                                ? `הקבוצה חסרה ${Math.abs(rec.diff).toFixed(1)}% מהיעד. בקניה הבאה, התמקד בקבוצה זו.`
                                : `הקבוצה עודפת ב-${Math.abs(rec.diff).toFixed(1)}%. שקול להפסיק להשקיע בה זמנית.`
                            }
                        </p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        
        function saveBonds() {
            portfolio.bonds = parseFloat(document.getElementById('bonds-amount').value) || 0;
            saveData();
            updateOverview();
            notify('✅ אג"ח נשמר');
        }
        
        function exportData() {
            const json = JSON.stringify(portfolio, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            notify('✅ נתונים יוצאו');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    portfolio = JSON.parse(e.target.result);
                    saveData();
                    updateOverview();
                    renderGroupsList();
                    renderHoldingsList();
                    notify('✅ נתונים יובאו');
                } catch (error) {
                    notify('❌ שגיאה בקריאת הקובץ', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        window.onload = function() {
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🔧 VERSION: localStorage RE-ENABLED + Groups Fixed');
            console.log('   ✅ Fixed: localStorage now saves and loads correctly');
            console.log('   ✅ Fixed: Groups are ALWAYS default - never corrupted');
            console.log('   ✅ Fixed: All holdings now have valid groupId');
            console.log('   ✅ Fixed: "No group found" error eliminated');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🚀 Initializing portfolio...');
            console.log('📦 Portfolio data structure:', portfolio);
        }
        
        async function init() {
            await loadData();  // Load from Firebase/localStorage
            console.log('📊 Loaded holdings:', portfolio.holdings.length);
            console.log('📊 Groups:', portfolio.groups);
            
            updateOverview();
            updateGroupSelect();
            renderHoldingsList();
            
            // טעינת ערכים להגדרות
            document.getElementById('rate-usd').value = portfolio.rates.USD.toFixed(4);
            document.getElementById('rate-eur').value = portfolio.rates.EUR.toFixed(4);
            document.getElementById('bonds-amount').value = portfolio.bonds;
            
            // Hide loading screen
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            // ניסיון עדכון אוטומטי (רקע - לא חוסם)
            autoUpdateExchangeRates().then(success => {
                if (success) {
                    updateOverview();
                    console.log('✅ Auto-update successful');
                } else {
                    console.log('ℹ️ Using manual rates');
                }
            });
            
            notify('💼 מערכת מוכנה');
            console.log('✅ Portfolio initialized successfully');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('📋 Debug Info:');
            console.log('  - Holdings:', portfolio.holdings.length);
            console.log('  - Groups:', portfolio.groups.length);
            console.log('  - USD Rate:', portfolio.rates.USD);
            console.log('  - EUR Rate:', portfolio.rates.EUR);
            console.log('  - Bonds:', portfolio.bonds);
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('✅ To add a holding, click "הוסף החזקה" and fill the form');
            console.log('✅ To refresh prices, click "רענן מחירים"');
            console.log('✅ To auto-update exchange rates, go to Settings and click "רענן אוטומטית"');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        };
        
        // Expose functions to window for HTML onclick handlers
        window.showTab = showTab;
        window.addHolding = addHolding;
        window.editHolding = editHolding;
        window.deleteHolding = deleteHolding;
        window.updatePriceManually = updatePriceManually;
        window.refreshPrices = refreshPrices;
        window.showAddHoldingForm = showAddHoldingForm;
        window.hideAddHoldingForm = hideAddHoldingForm;
        window.calculateInvestment = calculateInvestment;
        window.editGroup = editGroup;
        window.fixGroupIds = fixGroupIds;
        window.updateExchangeRates = updateExchangeRates;
        window.tryAutoUpdateRates = tryAutoUpdateRates;
        window.saveBonds = saveBonds;
        window.exportData = exportData;
        window.importData = importData;
    </script>
</body>
</html>
