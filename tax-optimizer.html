<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ§® ××•×¤×˜×™××™×–×¦×™×™×ª ××¡</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#c4944a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans Hebrew', 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(170deg, #0e0e1f 0%, #161630 40%, #0c1825 100%); color: #e0dcd0; min-height: 100vh; }
input[type="range"] { width: 100%; height: 4px; -webkit-appearance: none; appearance: none; background: rgba(255,255,255,0.1); border-radius: 4px; outline: none; cursor: pointer; accent-color: #c4944a; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #c4944a; cursor: pointer; }
a { color: #c4944a; }

/* Navigation Bar */
.nav-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}
.nav-links { display: flex; gap: 8px; align-items: center; }
.nav-links a {
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  color: #a0a0b8;
  border: 1px solid rgba(255,255,255,0.08);
  transition: all 0.2s;
}
.nav-links a:hover { background: rgba(255,255,255,0.05); color: #e0dcd0; }
.nav-user {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #7a7a9a;
}
.nav-user img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 1px solid rgba(196,148,74,0.4);
}

/* Auth loading */
#auth-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  font-size: 16px;
  color: #7a7a9a;
}

/* Data banner */
.data-banner {
  margin: 12px 14px;
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.data-banner.success { background: rgba(30,120,30,0.1); border: 1px solid rgba(30,120,30,0.3); color: #a8cca8; }
.data-banner.warning { background: rgba(196,148,74,0.1); border: 1px solid rgba(196,148,74,0.3); color: #c4944a; }
.data-banner.info { background: rgba(77,171,247,0.1); border: 1px solid rgba(77,171,247,0.3); color: #7ab8e0; }

/* Year selector */
.year-selector {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 6px 12px;
}
.year-selector select {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.15);
  color: #e0dcd0;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 13px;
  font-family: inherit;
  cursor: pointer;
}
.year-selector select option { background: #1a1a2e; }
</style>
</head>
<body>

<!-- Navigation -->
<nav class="nav-bar">
  <div class="nav-links">
    <a href="index.html">ğŸ  ×¨××©×™</a>
    <a href="finance.html">ğŸ’° ×”×›× ×¡×•×ª/×”×•×¦××•×ª</a>
    <a href="portfolio.html">ğŸ“ˆ ×ª×™×§ ×”×©×§×¢×•×ª</a>
  </div>
  <div class="nav-user" id="nav-user"></div>
</nav>

<div id="auth-loading">×˜×•×¢×Ÿ...</div>
<div id="root" style="display:none;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

<!-- Firebase Auth & Data Loading -->
<script type="module">
  import { auth, db, onAuthStateChanged, doc, getDoc, setDoc } from './firebase-config.js';

  window.__taxData = { loaded: false, years: {}, availableYears: [] };
  window.__taxSettings = null;
  window.__payslipData = { payslips: [], loaded: false };
  window.__financeDocRef = null;
  window.__financeData = null;

  // Save settings to Firebase
  window.__saveTaxSettings = async (settings) => {
    const user = auth.currentUser;
    if (!user) return;
    try {
      const ref = doc(db, 'users', user.uid, 'finance', 'taxSettings');
      await setDoc(ref, { ...settings, lastModified: new Date().toISOString() });
    } catch (e) {
      console.error('Failed to save tax settings:', e);
    }
  };

  // Save payslip to Firebase (into finance/data document)
  window.__savePayslip = async (payslip) => {
    if (!window.__financeDocRef) return false;
    try {
      const data = window.__financeData || { transactions: [], fixedIncomes: [], fixedExpenses: [], donations: [], payslips: [], incomeCategories: [], expenseCategories: [], categoryRules: [], budgets: {} };
      if (!data.payslips) data.payslips = [];

      // For form106: only replace entries with same month+earner+fileName (allows multiple employers)
      // For regular payslips: replace entries with same month+earner (excluding form106 entries)
      if (payslip.source === 'form106') {
        data.payslips = data.payslips.filter(p =>
          !(p.month === payslip.month && p.earner === payslip.earner && p.fileName === payslip.fileName)
        );
      } else {
        data.payslips = data.payslips.filter(p =>
          !(p.month === payslip.month && p.earner === payslip.earner && p.source !== 'form106')
        );
      }
      data.payslips.push(payslip);

      await setDoc(window.__financeDocRef, { ...data, lastModified: new Date().toISOString() });
      window.__financeData = data;
      window.__payslipData = { payslips: data.payslips, loaded: true };
      return true;
    } catch (e) {
      console.error('Failed to save payslip:', e);
      return false;
    }
  };

  // Delete payslip from Firebase
  window.__deletePayslip = async (payslipId) => {
    if (!window.__financeDocRef || !window.__financeData) return false;
    try {
      const data = window.__financeData;
      data.payslips = (data.payslips || []).filter(p => p.id !== payslipId);
      await setDoc(window.__financeDocRef, { ...data, lastModified: new Date().toISOString() });
      window.__financeData = data;
      window.__payslipData = { payslips: data.payslips, loaded: true };
      return true;
    } catch (e) {
      console.error('Failed to delete payslip:', e);
      return false;
    }
  };

  onAuthStateChanged(auth, async (user) => {
    const loading = document.getElementById('auth-loading');
    const root = document.getElementById('root');

    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    // Show user in nav
    document.getElementById('nav-user').innerHTML = `
      ${user.photoURL ? `<img src="${user.photoURL}" alt="">` : ''}
      <span>${user.displayName || user.email}</span>
    `;

    // Load finance data from Firebase
    try {
      const userDocRef = doc(db, 'users', user.uid, 'finance', 'data');
      window.__financeDocRef = userDocRef;
      const docSnap = await getDoc(userDocRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        window.__financeData = data;
        window.__payslipData = { payslips: data.payslips || [], loaded: true };
        document.dispatchEvent(new CustomEvent('payslipDataLoaded'));
        const transactions = data.transactions || [];
        const fixedIncomes = data.fixedIncomes || [];

        // Analyze income by year and earner
        // IMPORTANT: Month offset - the tracker runs 15th-to-15th,
        // so salary entering on the 10th is logged in the tracker's "current" month
        // but belongs to the PREVIOUS month for tax purposes.
        // e.g. tracker "January 2025" = tax "December 2024"
        const yearMap = {};

        function shiftMonthBack(trackerMonth) {
          // trackerMonth is "YYYY-MM", shift back 1 month for tax purposes
          const [y, m] = trackerMonth.split('-').map(Number);
          if (m === 1) return `${y - 1}-12`;
          return `${y}-${String(m - 1).padStart(2, '0')}`;
        }

        function addToYearMap(taxMonth, amt, earner) {
          const taxYear = taxMonth.substring(0, 4);
          const taxMM = taxMonth.substring(5, 7);
          if (!yearMap[taxYear]) yearMap[taxYear] = { months: new Set(), father: 0, mother: 0, untagged: 0, total: 0, monthlyFather: {}, monthlyMother: {}, monthlyUntagged: {} };
          yearMap[taxYear].months.add(taxMM);
          yearMap[taxYear].total += amt;
          if (earner === 'father') {
            yearMap[taxYear].father += amt;
            yearMap[taxYear].monthlyFather[taxMM] = (yearMap[taxYear].monthlyFather[taxMM] || 0) + amt;
          } else if (earner === 'mother') {
            yearMap[taxYear].mother += amt;
            yearMap[taxYear].monthlyMother[taxMM] = (yearMap[taxYear].monthlyMother[taxMM] || 0) + amt;
          } else {
            yearMap[taxYear].untagged += amt;
            yearMap[taxYear].monthlyUntagged[taxMM] = (yearMap[taxYear].monthlyUntagged[taxMM] || 0) + amt;
          }
        }

        // Process regular transactions
        transactions.forEach(t => {
          if (t.type !== 'income' || !t.month) return;
          const taxMonth = shiftMonthBack(t.month);
          addToYearMap(taxMonth, t.amt || 0, t.earner || null);
        });

        // Process fixed incomes (expand into months)
        fixedIncomes.forEach(f => {
          if (!f.start || !f.end) return;
          let cur = f.start;
          while (cur <= f.end) {
            const taxMonth = shiftMonthBack(cur);
            addToYearMap(taxMonth, f.amount || 0, f.earner || null);

            // Advance to next month
            const [y, m] = cur.split('-').map(Number);
            const nextMonth = m === 12 ? `${y + 1}-01` : `${y}-${String(m + 1).padStart(2, '0')}`;
            cur = nextMonth;
          }
        });

        // Calculate averages and completeness
        const years = {};
        for (const [year, info] of Object.entries(yearMap)) {
          const monthCount = info.months.size;
          const isComplete = monthCount === 12;
          const fatherMonthly = monthCount > 0 ? Math.round(info.father / monthCount) : 0;
          const motherMonthly = monthCount > 0 ? Math.round(info.mother / monthCount) : 0;
          const untaggedMonthly = monthCount > 0 ? Math.round(info.untagged / monthCount) : 0;

          years[year] = {
            monthCount,
            isComplete,
            fatherMonthly,
            motherMonthly,
            untaggedMonthly,
            totalAnnual: info.total,
            fatherAnnual: info.father,
            motherAnnual: info.mother,
            untaggedAnnual: info.untagged
          };
        }

        const availableYears = Object.keys(years).sort().reverse();

        window.__taxData = { loaded: true, years, availableYears };
      }
    } catch (e) {
      console.error('Failed to load finance data:', e);
    }

    // Load saved tax optimizer settings
    try {
      const settingsRef = doc(db, 'users', user.uid, 'finance', 'taxSettings');
      const settingsSnap = await getDoc(settingsRef);
      if (settingsSnap.exists()) {
        window.__taxSettings = settingsSnap.data();
      }
    } catch (e) {
      console.error('Failed to load tax settings:', e);
    }

    // Show app
    loading.style.display = 'none';
    root.style.display = 'block';

    // Trigger React render
    if (window.__renderApp) window.__renderApp();
  });
</script>

<script type="text/babel">
const { useState, useMemo, useEffect, useCallback } = React;

const CREDIT_POINT_VALUE_2026 = 2904;
const CG_TAX_RATE = 0.25;
const SETTLEMENT_RATE = 0.12;
const SETTLEMENT_CEILING = 213240;

function fatherChildPoints(age) {
  if (age < 0) return 0;
  if (age === 0) return 2.5;
  if (age <= 2) return 4.5;
  if (age === 3) return 3.5;
  if (age <= 5) return 2.5;
  return 0;
}

function motherChildPoints(age) {
  if (age < 0) return 0;
  if (age === 0) return 2.5;
  if (age <= 2) return 4.5;
  if (age === 3) return 3.5;
  if (age <= 5) return 2.5;
  if (age <= 17) return 1;
  if (age === 18) return 0.5;
  return 0;
}

const TAX_BRACKETS = [
  { limit: 84120, rate: 0.10 },
  { limit: 120720, rate: 0.14 },
  { limit: 193800, rate: 0.20 },
  { limit: 269280, rate: 0.31 },
  { limit: 560280, rate: 0.35 },
  { limit: 698280, rate: 0.47 },
  { limit: Infinity, rate: 0.50 },
];

function calcTax(annual) {
  let tax = 0, prev = 0;
  for (const b of TAX_BRACKETS) {
    if (annual <= prev) break;
    const t = Math.min(annual, b.limit) - prev;
    if (t > 0) tax += t * b.rate;
    prev = b.limit;
  }
  return Math.round(tax);
}

function calcGrant(monthly, nKids) {
  const min = 2390, max = nKids >= 3 ? 7910 : 7220;
  if (monthly < min || monthly > max) return { grant: 0, ok: false };
  let base = 0;
  if (nKids >= 3) {
    if (monthly <= 4340) base = Math.min(420, (monthly - min) * 0.215);
    else if (monthly <= 5410) base = 420;
    else base = Math.max(0, 420 - (monthly - 5410) * 0.168);
  } else {
    if (monthly <= 4340) base = Math.min(290, (monthly - min) * 0.149);
    else if (monthly <= 5140) base = 290;
    else base = Math.max(0, 290 - (monthly - 5140) * 0.139);
  }
  const m = base * 1.5;
  return { grant: Math.round(m * 12), ok: m > 2 };
}

function calcToddler(monthly, nToddlers, nKids) {
  if (!nToddlers) return 0;
  const max = nKids >= 3 ? 9243 : 8582;
  if (monthly < 2400 || monthly > max) return 0;
  let g = nToddlers * 500;
  if (monthly > 6000) g *= Math.max(0, 1 - (monthly - 6000) / (max - 6000));
  return Math.max(0, Math.round(g * 12));
}

function InfoTip({ text }) {
  const [s, setS] = useState(false);
  return (
    <span style={{ position: "relative", display: "inline-block", marginRight: 4, cursor: "pointer" }}
      onMouseEnter={() => setS(true)} onMouseLeave={() => setS(false)} onClick={() => setS(!s)}>
      <span style={{ display: "inline-flex", alignItems: "center", justifyContent: "center", width: 16, height: 16, borderRadius: "50%", backgroundColor: "rgba(180,140,60,0.6)", color: "#1a1a2e", fontSize: 10, fontWeight: 700 }}>?</span>
      {s && <span style={{ position: "absolute", bottom: "130%", right: "50%", transform: "translateX(50%)", backgroundColor: "#2a2a4a", color: "#e0dcd0", padding: "10px 14px", borderRadius: 10, fontSize: 12, lineHeight: 1.6, width: 270, zIndex: 999, boxShadow: "0 6px 24px rgba(0,0,0,0.5)", border: "1px solid #3a3a5a" }}>{text}</span>}
    </span>
  );
}

function Sl({ label, value, onChange, min, max, step, suf, tip, wide }) {
  return (
    <div style={{ gridColumn: wide ? "1 / -1" : undefined }}>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
        <label style={{ fontSize: 12, color: "#a0a0b8", display: "flex", alignItems: "center", gap: 4 }}>{label}{tip && <InfoTip text={tip} />}</label>
        <span style={{ fontSize: 13, fontWeight: 700, color: "#e0dcd0" }}>{value < 0 ? "\u2014" : value.toLocaleString("he-IL")} {value >= 0 ? suf : ""}</span>
      </div>
      <input type="range" min={min} max={max} step={step} value={value} onChange={e => onChange(+e.target.value)} />
    </div>
  );
}

function Tog({ label, active, onClick }) {
  return (
    <button onClick={onClick} style={{
      padding: "6px 14px", borderRadius: 20, cursor: "pointer", fontSize: 12,
      border: `1px solid ${active ? "#c4944a" : "rgba(255,255,255,0.1)"}`,
      background: active ? "rgba(196,148,74,0.15)" : "transparent",
      color: active ? "#c4944a" : "#7a7a9a", fontWeight: active ? 600 : 400
    }}>{active ? "\u2713 " : ""}{label}</button>
  );
}

function R({ label, amount, color, bold }) {
  return (
    <div style={{ display: "flex", justifyContent: "space-between", fontSize: bold ? 14 : 12, fontWeight: bold ? 700 : 400, marginBottom: bold ? 0 : 4, paddingTop: bold ? 6 : 0, borderTop: bold ? "1px solid rgba(255,255,255,0.1)" : "none" }}>
      <span>{label}</span><span style={{ color: color || "#e0dcd0" }}>{amount}</span>
    </div>
  );
}

// PDF parsing helper â€” amount pattern that handles â‚ª sign and whitespace
// Negative lookahead (?![.\d]*\s*%) prevents matching percentages like "4.00%"
// e.g. "×‘×™×˜×•×— ×œ××•××™ 4.00% 68.00" â†’ skips "4.00" (percentage), captures "68.00"
const AMT = 'â‚ª?\\s*([0-9,]+(?:\\.\\d+)?)(?![.\\d]*\\s*%)';
const QUO = '["\u05F4×´\']{0,2}'; // Hebrew geresh/gershayim variants (handles '' double-apostrophe too)
// Flexible gap: allows extra words between label and amount (handles "×‘×™×˜×•×— ×œ××•××™ ×¢×•×‘×“ 250")
const GAP = '[^\\n]{0,25}?';

function parsePayslipPDF(text) {
  const result = { month: null, year: null, gross: null, net: null, deductions: {}, totalDeductions: null };
  const lines = text.split('\n');
  const hebrewMonths = { '×™× ×•××¨':'01','×¤×‘×¨×•××¨':'02','××¨×¥':'03','××¨×¡':'03','××¤×¨×™×œ':'04','×××™':'05','×™×•× ×™':'06','×™×•×œ×™':'07','××•×’×•×¡×˜':'08','×¡×¤×˜××‘×¨':'09','××•×§×˜×•×‘×¨':'10','× ×•×‘××‘×¨':'11','×“×¦××‘×¨':'12' };

  for (const line of lines) {
    // Try YYYY/MM and MM/YYYY formats
    const mmyyyy = line.match(/(\d{1,2})[\/\-.](\d{4})/) || line.match(/(\d{4})[\/\-.](\d{1,2})/);
    if (mmyyyy && !result.month) {
      let m, y;
      if (parseInt(mmyyyy[1]) > 31) { y = parseInt(mmyyyy[1]); m = parseInt(mmyyyy[2]); }
      else { m = parseInt(mmyyyy[1]); y = parseInt(mmyyyy[2]); }
      if (m >= 1 && m <= 12 && y >= 2020 && y <= 2030) {
        result.month = String(m).padStart(2, '0');
        result.year = String(y);
      }
    }
    // Try "×—×•×“×© 01 ×©× ×” 2025" or "×©× ×ª 2025" patterns
    const periodMatch = line.match(/×—×•×“×©\s*:?\s*(\d{1,2})\s.*?×©× [×”×ª]\s*:?\s*(\d{4})/);
    if (periodMatch && !result.month) {
      const m = parseInt(periodMatch[1]), y = parseInt(periodMatch[2]);
      if (m >= 1 && m <= 12 && y >= 2020 && y <= 2030) {
        result.month = String(m).padStart(2, '0'); result.year = String(y);
      }
    }
    for (const [name, num] of Object.entries(hebrewMonths)) {
      if (line.includes(name)) {
        const ym = line.match(/20\d{2}/);
        if (ym && !result.month) { result.month = num; result.year = ym[0]; }
      }
    }
  }

  const tryMatch = (patterns) => {
    for (const p of patterns) {
      const m = text.match(p);
      if (m) { const v = parseFloat(m[1].replace(/,/g, '')); if (v > 500 && v < 200000) return v; }
    }
    return null;
  };

  // tryMatchDed â€” for deductions (lower range: 1-100,000)
  // Extra safety: skip values followed by % (percentage rates, not amounts)
  const tryMatchDed = (patterns) => {
    for (const p of patterns) {
      const m = text.match(p);
      if (!m) continue;
      const v = parseFloat(m[1].replace(/,/g, ''));
      if (v <= 0 || v >= 100000) continue;
      // Belt-and-suspenders: verify this isn't a percentage (AMT lookahead should catch it, but just in case)
      const afterPos = m.index + m[0].length;
      const after = text.substring(afterPos, afterPos + 5);
      if (/^[.\d]*\s*%/.test(after)) continue;
      return v;
    }
    return null;
  };

  const SHK = `×¡×”${QUO}×›`;

  result.gross = tryMatch([
    // Label â†’ Amount (Hebrew reading order)
    new RegExp(`${SHK}\\s*×ª×©×œ×•××™×${GAP}${AMT}`),
    new RegExp(`${SHK}\\s*×‘×¨×•×˜×•${GAP}${AMT}`),
    new RegExp(`×©×›×¨\\s*×‘×¨×•×˜×•${GAP}${AMT}`),
    new RegExp(`×‘×¨×•×˜×•${GAP}${AMT}`),
    new RegExp(`×ª×©×œ×•××™×${GAP}${AMT}`),
    // Amount â†’ Label (RTL PDF text extraction order)
    new RegExp(`${AMT}\\s*${SHK}\\s*×ª×©×œ×•××™×`),
    new RegExp(`${AMT}\\s*${SHK}\\s*×‘×¨×•×˜×•`),
    new RegExp(`${AMT}\\s*×©×›×¨\\s*×‘×¨×•×˜×•`),
    new RegExp(`${AMT}\\s*×‘×¨×•×˜×•`),
  ]);

  result.net = tryMatch([
    // Label â†’ Amount
    new RegExp(`× ×˜×•\\s*×œ×ª×©×œ×•×${GAP}${AMT}`),
    new RegExp(`${SHK}\\s*× ×˜×•${GAP}${AMT}`),
    new RegExp(`×©×›×¨\\s*× ×˜×•${GAP}${AMT}`),
    new RegExp(`${SHK}\\s*×œ×ª×©×œ×•×${GAP}${AMT}`),
    new RegExp(`×”×¢×‘×¨×”\\s*×œ×‘× ×§${GAP}${AMT}`),
    new RegExp(`×¡×›×•×\\s*×œ×ª×©×œ×•×${GAP}${AMT}`),
    new RegExp(`× ×˜×•\\s*×œ×”×¢×‘×¨×”${GAP}${AMT}`),
    new RegExp(`×œ×ª×©×œ×•×${GAP}${AMT}`),
    new RegExp(`× ×˜×•${GAP}${AMT}`),
    // Amount â†’ Label
    new RegExp(`${AMT}\\s*× ×˜×•\\s*×œ×ª×©×œ×•×`),
    new RegExp(`${AMT}\\s*${SHK}\\s*× ×˜×•`),
    new RegExp(`${AMT}\\s*×©×›×¨\\s*× ×˜×•`),
    new RegExp(`${AMT}\\s*${SHK}\\s*×œ×ª×©×œ×•×`),
    new RegExp(`${AMT}\\s*×”×¢×‘×¨×”\\s*×œ×‘× ×§`),
    new RegExp(`${AMT}\\s*×¡×›×•×\\s*×œ×ª×©×œ×•×`),
    new RegExp(`${AMT}\\s*× ×˜×•\\s*×œ×”×¢×‘×¨×”`),
    new RegExp(`${AMT}\\s*× ×˜×•`),
  ]);

  // Deduction definitions â€” GAP allows extra words between label and amount
  // (e.g. "×‘×™×˜×•×— ×œ××•××™ ×¢×•×‘×“ 250", "××¡ ×”×›× ×¡×” ××¦×˜×‘×¨ 1,200")
  const A = `â‚ª?\\s*([0-9,]+\\.?\\d*)`; // inline AMT for deductions
  const G = `[^\\n]{0,20}?`; // short gap for deductions
  const dedDefs = [
    { key:'incomeTax', label:'××¡ ×”×›× ×¡×”', patterns:[
      new RegExp(`××¡\\s*×”×›× ×¡×”${G}${A}`), new RegExp(`${A}\\s*××¡\\s*×”×›× ×¡×”`),
      new RegExp(`× ×™×›×•×™\\s*××¡${G}${A}`), new RegExp(`${A}\\s*× ×™×›×•×™\\s*××¡`),
    ]},
    { key:'nationalInsurance', label:'×‘×™×˜×•×— ×œ××•××™', patterns:[
      // Full name with flexible gap (handles "×‘×™×˜×•×— ×œ××•××™ ×¢×•×‘×“", "×“××™ ×‘×™×˜×•×— ×œ××•××™", etc.)
      new RegExp(`×‘×™×˜×•×—\\s*×œ××•××™${G}${A}`), new RegExp(`${A}\\s*×‘×™×˜×•×—\\s*×œ××•××™`),
      new RegExp(`×“××™\\s*×‘×™×˜×•×—\\s*×œ××•××™${G}${A}`),
      // Abbreviations: ×‘×˜"×œ, ×‘.×œ××•××™, ×‘"×œ
      new RegExp(`×‘×˜${QUO}×œ${G}${A}`), new RegExp(`${A}\\s*×‘×˜${QUO}×œ`),
      new RegExp(`×‘\\.\\s*×œ××•××™${G}${A}`),
      new RegExp(`×‘${QUO}×œ[:\\s]*${A}`),
    ]},
    { key:'healthTax', label:'××¡ ×‘×¨×™××•×ª', patterns:[
      new RegExp(`××¡\\s*×‘×¨×™××•×ª${G}${A}`), new RegExp(`${A}\\s*××¡\\s*×‘×¨×™××•×ª`),
      new RegExp(`×“××™\\s*×‘×¨×™××•×ª${G}${A}`),
      new RegExp(`×‘×¨×™××•×ª${G}${A}`), new RegExp(`${A}\\s*×‘×¨×™××•×ª`),
    ]},
    { key:'pension', label:'×¤× ×¡×™×”', patterns:[
      new RegExp(`×¤× ×¡×™[×”×ª]${G}${A}`), new RegExp(`${A}\\s*×¤× ×¡×™[×”×ª]`),
      new RegExp(`×”×¤×¨×©×”\\s*×œ×¤× ×¡×™×”${G}${A}`),
      /×× ×•×¨×”[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /××‘×˜×—×™×[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /×’××œ[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /×”×¨××œ[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /××’×“×œ[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /×›×œ×œ\s*×‘×™×˜×•×—[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
      /××œ×˜×©×•×œ×¨[^\\n]{0,15}?â‚ª?\s*([0-9,]+\.?\d*)/,
    ]},
    { key:'hishtalmut', label:'×§×¨×Ÿ ×”×©×ª×œ××•×ª', patterns:[
      new RegExp(`×§×¨[× ×Ÿ]\\s*×”×©×ª×œ××•×ª${G}${A}`), new RegExp(`${A}\\s*×§×¨[× ×Ÿ]\\s*×”×©×ª×œ××•×ª`),
      new RegExp(`×§×¨×”${QUO}×©${G}${A}`), new RegExp(`${A}\\s*×§×¨×”${QUO}×©`),
      new RegExp(`×”×©×ª×œ××•×ª${G}${A}`),
    ]}
  ];
  for (const d of dedDefs) {
    const v = tryMatchDed(d.patterns);
    if (v) result.deductions[d.key] = { label: d.label, amount: v };
  }

  if (result.gross && result.net) result.totalDeductions = Math.round((result.gross - result.net) * 100) / 100;
  if (result.gross && !result.net) { const td = Object.values(result.deductions).reduce((s,d)=>s+d.amount,0); if (td > 0) result.net = Math.round((result.gross-td)*100)/100; }
  if (result.net && !result.gross) { const td = Object.values(result.deductions).reduce((s,d)=>s+d.amount,0); if (td > 0) result.gross = Math.round((result.net+td)*100)/100; }

  return result;
}

// Parse Israeli Form 106 (×˜×•×¤×¡ 106) â€” annual tax summary from employer
function parseForm106(text) {
  // Detect if this is a 106 form (handles 106, 0106, Tax Authority portal, various Hebrew titles)
  const is106 = /×˜×•×¤×¡\s*0?106|0?106\s*×œ×©× ×ª|××™×©×•×¨\s*×©× ×ª×™|×¨×™×›×•×–\s*×©× ×ª×™|×¡×™×›×•×\s*×©× ×ª×™|××™×©×•×¨\s*(?:×¢×œ\s*)?(?:× ×™×›×•×™|×”×›× ×¡×”|×œ×¢×•×‘×“)|×“×•.?×—?\s*×©× ×ª×™|×¨×™×›×•×–\s*× ×ª×•× ×™\s*×©×›×¨|×¡×¢×™×£\s*106|× ×™×›×•×™×™×\s*×(?:××©×›×•×¨×ª|×©×›×¨\s*×¢×‘×•×“×”)|××™×“×¢\s*×¢×œ\s*×”×›× ×¡×•×ª|×”×›× ×¡×•×ª\s*×œ×©× ×ª\s*×”××¡|×”×•×¤×§\s*×(?:×”)?××–×•×¨\s*××™×©×™/.test(text);
  if (!is106) return null;

  const result = { year: null, annualGross: null, annualNet: null, monthlyGross: null, monthlyNet: null, months: 12 };

  // Extract year: "×©× ×ª ××¡ 2025", "×œ×©× ×ª ×”××¡ 2024", "×œ×©× ×ª 2025", "×©× ×ª 2025"
  const yearMatch = text.match(/×©× [×ª×”]\s*(?:×”?××¡\s*)?:?\s*(20\d{2})/) || text.match(/×œ×©× [×ª×”]\s*(?:×”?××¡\s*)?:?\s*(20\d{2})/) || text.match(/×”×›× ×¡×•×ª\s*×œ×©× [×ª×”]\s*(?:×”?××¡\s*)?(20\d{2})/) || text.match(/(20\d{2})\s*×©× [×ª×”]\s*(?:×”?××¡)/);
  if (yearMatch) result.year = yearMatch[1];

  // If no year from label, try to find a standalone year
  if (!result.year) {
    const fallbackYear = text.match(/\b(202[0-9])\b/);
    if (fallbackYear) result.year = fallbackYear[1];
  }

  const SHK = `×¡×”${QUO}×›`;
  // Annual amounts are typically 30,000â€“2,000,000
  const AMT106 = 'â‚ª?\\s*([0-9,]+(?:\\.\\d+)?)';
  const GAP106 = '[^\\n]{0,30}?';

  const tryMatch106 = (patterns) => {
    for (const p of patterns) {
      const m = text.match(p);
      if (m) { const v = parseFloat(m[1].replace(/,/g, '')); if (v > 100 && v < 2000000) return v; }
    }
    return null;
  };

  // Gross patterns for 106
  const SKH = `×¡×š\\s*(?:×”×›×œ|×”×›×•×œ)`;  // "×¡×š ×”×›×œ" / "×¡×š ×”×›×•×œ" alternative to ×¡×”"×›
  result.annualGross = tryMatch106([
    new RegExp(`${SHK}\\s*×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*×©×›×¨\\s*×‘×¨×•×˜×•${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*×ª×©×œ×•××™×${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*×ª×©×œ×•××™×${GAP106}${AMT106}`),
    new RegExp(`×”×›× ×¡×”\\s*(?:×—×™×™×‘×ª|×‘×¨×•×˜×•|×××©×›×•×¨×ª)${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*×‘×¨×•×˜×•${GAP106}${AMT106}`),
    new RegExp(`×©×›×¨\\s*×‘×¨×•×˜×•\\s*×©× ×ª×™${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*×©×›×¨\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*×©×›×¨\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`×©×›×¨\\s*×¢×‘×•×“×”${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*×‘×¨×•×˜×•${GAP106}${AMT106}`),
    // Tax Authority portal format: "××©×›×•×¨×ª ×•×ª×©×œ×•××™× 1,874", "×¡×”''×› (158/172) 1,874"
    new RegExp(`××©×›×•×¨×ª\\s*×•×ª×©×œ×•××™×${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*\\(158\\/172\\)${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*\\(158${GAP106}${AMT106}`),
    // RTL order
    new RegExp(`${AMT106}\\s*${SHK}\\s*×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”`),
    new RegExp(`${AMT106}\\s*${SKH}\\s*×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”`),
    new RegExp(`${AMT106}\\s*×”×›× ×¡[×ª×”]\\s*×¢×‘×•×“×”`),
    new RegExp(`${AMT106}\\s*${SHK}\\s*×©×›×¨\\s*×‘×¨×•×˜×•`),
    new RegExp(`${AMT106}\\s*${SHK}\\s*×ª×©×œ×•××™×`),
    new RegExp(`${AMT106}\\s*×”×›× ×¡×”\\s*(?:×—×™×™×‘×ª|×‘×¨×•×˜×•|×××©×›×•×¨×ª)`),
    new RegExp(`${AMT106}\\s*×©×›×¨\\s*×¢×‘×•×“×”`),
    new RegExp(`${AMT106}\\s*××©×›×•×¨×ª\\s*×•×ª×©×œ×•××™×`),
  ]);

  // Net patterns for 106
  result.annualNet = tryMatch106([
    new RegExp(`${SHK}\\s*× ×˜×•${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*× ×˜×•${GAP106}${AMT106}`),
    new RegExp(`× ×˜×•\\s*×œ×ª×©×œ×•×${GAP106}${AMT106}`),
    new RegExp(`${SHK}\\s*×œ×ª×©×œ×•×${GAP106}${AMT106}`),
    new RegExp(`${SKH}\\s*×œ×ª×©×œ×•×${GAP106}${AMT106}`),
    new RegExp(`×©×›×¨\\s*× ×˜×•\\s*×©× ×ª×™${GAP106}${AMT106}`),
    new RegExp(`×©×›×¨\\s*× ×˜×•${GAP106}${AMT106}`),
    // RTL order
    new RegExp(`${AMT106}\\s*${SHK}\\s*× ×˜×•`),
    new RegExp(`${AMT106}\\s*${SKH}\\s*× ×˜×•`),
    new RegExp(`${AMT106}\\s*× ×˜×•\\s*×œ×ª×©×œ×•×`),
    new RegExp(`${AMT106}\\s*×©×›×¨\\s*× ×˜×•`),
  ]);

  // Number of months worked (if specified): "××¡×¤×¨ ×—×•×“×©×™ ×¢×‘×•×“×”: 10", "×—×“×©×™ ×¢×‘×•×“×” ×‘×©× ×ª ×”××¡"
  // Also count V marks from Tax Authority portal format: "V V V V 4"
  const monthsMatch = text.match(/(?:××¡×¤×¨\s*)?×—×•?×“×©[×™×”]\s*(?:×¢×‘×•×“×”)?[:\s]*(\d{1,2})/)
    || text.match(/(\d{1,2})\s*×—×•?×“×©[×™×”]\s*×¢×‘×•×“×”/)
    || text.match(/×—×•?×“×©[×™×”]\s*×¢×‘×•×“×”[^]*?(?:V\s*)+(\d{1,2})\b/);
  if (monthsMatch) {
    const mo = parseInt(monthsMatch[1]);
    if (mo >= 1 && mo <= 12) result.months = mo;
  }

  if (!result.annualGross && !result.annualNet) return null;

  // Calculate monthly averages
  if (result.annualGross) result.monthlyGross = Math.round(result.annualGross / result.months);
  if (result.annualNet) result.monthlyNet = Math.round(result.annualNet / result.months);

  return result;
}

async function extractPDFText(arrayBuffer) {
  if (typeof pdfjsLib === 'undefined') throw new Error('×¡×¤×¨×™×™×ª PDF ×œ× × ×˜×¢× ×”');
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let ltrText = '';
  let rtlText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const lines = {};
    content.items.forEach(item => {
      const y = Math.round(item.transform[5]);
      if (!lines[y]) lines[y] = [];
      lines[y].push({ text: item.str, x: item.transform[4] });
    });
    Object.keys(lines).map(Number).sort((a,b)=>b-a).forEach(y => {
      const sorted = lines[y].sort((a,b)=>a.x-b.x);
      ltrText += sorted.map(i=>i.text).join(' ') + '\n';
      rtlText += sorted.slice().reverse().map(i=>i.text).join(' ') + '\n';
    });
  }
  // Return both orderings â€” try LTR first, if parsing fails caller can try RTL
  return { ltrText, rtlText, hasText: ltrText.replace(/\s/g, '').length > 20 };
}

function App() {
  const taxData = window.__taxData || { loaded: false, years: {}, availableYears: [] };
  const saved = window.__taxSettings;

  const [selectedYear, setSelectedYear] = useState('');
  const [autoApplied, setAutoApplied] = useState(!!saved);
  const [payslips, setPayslips] = useState((window.__payslipData || {}).payslips || []);
  const [pendingPayslip, setPendingPayslip] = useState(null);
  const [payslipEarner, setPayslipEarner] = useState('');
  const [payslipStatus, setPayslipStatus] = useState('');
  const [fM, setFM] = useState(saved?.fM ?? 6000);
  const [mM, setMM] = useState(saved?.mM ?? 5000);
  const [children, setChildren] = useState(saved?.children ?? [
    { id: 1, age: 3 },
    { id: 2, age: 2 },
    { id: 3, age: 0 },
  ]);
  const [nextId, setNextId] = useState(saved?.nextId ?? 4);
  const [stl, setStl] = useState(saved?.stl ?? true);
  const [jnt, setJnt] = useState(saved?.jnt ?? true);
  const [cg, setCg] = useState(saved?.cg ?? 80000);
  const [fRatio, setFRatio] = useState(saved?.fRatio ?? 1.0);
  const [mRatio, setMRatio] = useState(saved?.mRatio ?? 1.0);
  const [det, setDet] = useState(false);

  // Sync payslips from Firebase when data loads after component mount
  useEffect(() => {
    const handler = () => {
      const loaded = window.__payslipData?.payslips || [];
      if (loaded.length > 0) setPayslips([...loaded]);
    };
    if (window.__payslipData?.loaded) handler();
    document.addEventListener('payslipDataLoaded', handler);
    return () => document.removeEventListener('payslipDataLoaded', handler);
  }, []);

  // Auto-save settings on change (debounced)
  const saveTimerRef = React.useRef(null);
  useEffect(() => {
    if (!window.__saveTaxSettings) return;
    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
    saveTimerRef.current = setTimeout(() => {
      window.__saveTaxSettings({ fM, mM, children, nextId, stl, jnt, cg, fRatio, mRatio });
    }, 1500);
    return () => { if (saveTimerRef.current) clearTimeout(saveTimerRef.current); };
  }, [fM, mM, children, nextId, stl, jnt, cg, fRatio, mRatio]);

  // Auto-select best year on load
  useEffect(() => {
    if (taxData.loaded && taxData.availableYears.length > 0 && !selectedYear) {
      // Prefer most recent complete year, otherwise most recent
      const complete = taxData.availableYears.find(y => taxData.years[y]?.isComplete);
      setSelectedYear(complete || taxData.availableYears[0]);
    }
  }, [taxData.loaded, taxData.availableYears]);

  // Apply year data to sliders (net from finance Ã— ratio = estimated gross)
  const applyYearData = useCallback((year) => {
    const info = taxData.years[year];
    if (!info) return;
    const fatherGross = Math.round(info.fatherMonthly * fRatio);
    const motherGross = Math.round(info.motherMonthly * mRatio);

    // Round to nearest 250 for slider steps
    if (fatherGross > 0) setFM(Math.round(fatherGross / 250) * 250);
    if (motherGross > 0) setMM(Math.round(motherGross / 250) * 250);
    setAutoApplied(true);
  }, [taxData.years, fRatio, mRatio]);

  // Auto-apply on first year selection
  useEffect(() => {
    if (selectedYear && taxData.loaded && !autoApplied) {
      applyYearData(selectedYear);
    }
  }, [selectedYear, taxData.loaded, autoApplied]);

  const yearInfo = selectedYear ? taxData.years[selectedYear] : null;

  // --- Payslip handlers ---
  const fileInputRef = React.useRef(null);

  const handlePayslipFile = useCallback(async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
    const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|webp|heic)$/i.test(file.name);

    if (!isPDF && !isImage) {
      setPayslipStatus('×™×© ×œ×”×¢×œ×•×ª ×§×•×‘×¥ PDF ××• ×ª××•× ×” (JPG/PNG)');
      setTimeout(() => setPayslipStatus(''), 4000);
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }

    if (isImage) {
      // Show manual entry form for images since we can't OCR client-side
      setPendingPayslip({ _manualEntry: true, fileName: file.name });
      setPayslipStatus('');
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }

    setPayslipStatus('×§×•×¨× ×ª×œ×•×©...');
    try {
      const ab = await file.arrayBuffer();
      const extracted = await extractPDFText(ab);
      console.log('PDF text (LTR):', extracted.ltrText);
      console.log('PDF text (RTL):', extracted.rtlText);

      if (!extracted.hasText) {
        // PDF is likely a scanned image â€” offer manual entry
        setPendingPayslip({ _manualEntry: true, fileName: file.name, _scanned: true });
        setPayslipStatus('');
        if (fileInputRef.current) fileInputRef.current.value = '';
        return;
      }

      // Try Form 106 detection first (annual tax summary)
      const form106 = parseForm106(extracted.ltrText) || parseForm106(extracted.rtlText);
      if (form106 && form106.year) {
        form106.earner = payslipEarner;
        form106.fileName = file.name;
        form106._isForm106 = true;
        setPendingPayslip(form106);
        setPayslipStatus('');
        if (fileInputRef.current) fileInputRef.current.value = '';
        return;
      }

      // Try LTR text first, then RTL
      let parsed = parsePayslipPDF(extracted.ltrText);
      if (!parsed.net && !parsed.gross) {
        parsed = parsePayslipPDF(extracted.rtlText);
      }

      if (!parsed.net && !parsed.gross) {
        // Couldn't auto-parse â€” offer manual entry
        setPendingPayslip({ _manualEntry: true, fileName: file.name, _parseHint: true });
        setPayslipStatus('');
        if (fileInputRef.current) fileInputRef.current.value = '';
        return;
      }
      parsed.earner = payslipEarner;
      parsed.fileName = file.name;
      setPendingPayslip(parsed);
      setPayslipStatus('');
    } catch (err) {
      console.error('PDF error:', err);
      setPayslipStatus('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ' + err.message);
      setTimeout(() => setPayslipStatus(''), 4000);
    }
    if (fileInputRef.current) fileInputRef.current.value = '';
  }, [payslipEarner]);

  const confirmForm106Upload = useCallback(async () => {
    if (!pendingPayslip || !pendingPayslip._isForm106) return;
    const earner = pendingPayslip.earner || payslipEarner;
    if (!earner) { setPayslipStatus('×™×© ×œ×‘×—×•×¨ ×‘×Ÿ ×–×•×’'); setTimeout(() => setPayslipStatus(''), 3000); return; }
    const year = pendingPayslip.year;
    const months = pendingPayslip.months || 12;
    const monthlyGross = pendingPayslip.monthlyGross;
    const monthlyNet = pendingPayslip.monthlyNet;
    if (!monthlyGross && !monthlyNet) { setPayslipStatus('×œ× ×–×•×”×• × ×ª×•× ×™ ×”×›× ×¡×” ×‘×˜×•×¤×¡'); setTimeout(() => setPayslipStatus(''), 3000); return; }

    setPayslipStatus('×©×•××¨ × ×ª×•× ×™ 106...');
    let savedCount = 0;
    for (let m = 1; m <= months; m++) {
      const monthKey = `${year}-${String(m).padStart(2, '0')}`;
      const payslip = {
        id: Date.now() + m,
        month: monthKey,
        gross: monthlyGross,
        net: monthlyNet,
        totalDeductions: monthlyGross && monthlyNet ? Math.round((monthlyGross - monthlyNet) * 100) / 100 : 0,
        deductions: {},
        earner,
        fileName: pendingPayslip.fileName,
        source: 'form106',
        time: new Date().toISOString()
      };
      const ok = await window.__savePayslip(payslip);
      if (ok) savedCount++;
    }
    if (savedCount > 0) {
      setPayslips([...window.__payslipData.payslips]);
      setPendingPayslip(null);
      setPayslipStatus(`×˜×•×¤×¡ 106 × ×©××¨ â€” ${savedCount} ×—×•×“×©×™×`);
      // Auto-update slider: calculate total average across ALL payslips for this earner+year
      const allSlips = (window.__payslipData.payslips || []).filter(p =>
        p.earner === earner && p.month && p.month.startsWith(year + '-') && p.gross
      );
      if (allSlips.length > 0) {
        const byMonth = {};
        for (const p of allSlips) byMonth[p.month] = (byMonth[p.month] || 0) + p.gross;
        const monthTotals = Object.values(byMonth);
        const avgGross = Math.round(monthTotals.reduce((s, v) => s + v, 0) / monthTotals.length);
        const rounded = Math.round(avgGross / 250) * 250;
        if (earner === 'father') setFM(rounded);
        else if (earner === 'mother') setMM(rounded);
      }
      setTimeout(() => setPayslipStatus(''), 3000);
    } else {
      setPayslipStatus('×©×’×™××” ×‘×©××™×¨×”');
      setTimeout(() => setPayslipStatus(''), 3000);
    }
  }, [pendingPayslip, payslipEarner]);

  const confirmPayslipUpload = useCallback(async () => {
    if (!pendingPayslip) return;
    if (!pendingPayslip.gross && !pendingPayslip.net) { setPayslipStatus('×™×© ×œ×”×–×™×Ÿ ×‘×¨×•×˜×• ××• × ×˜×•'); return; }
    const monthKey = pendingPayslip.month && pendingPayslip.year
      ? `${pendingPayslip.year}-${pendingPayslip.month}`
      : null;
    if (!monthKey) { setPayslipStatus('×™×© ×œ×‘×—×•×¨ ×—×•×“×©'); setTimeout(() => setPayslipStatus(''), 3000); return; }

    // Compute totalDeductions for manual entries
    const gross = pendingPayslip.gross || 0;
    const net = pendingPayslip.net || 0;
    const totalDed = gross && net ? Math.round((gross - net) * 100) / 100 : (pendingPayslip.totalDeductions || 0);

    const payslip = {
      id: Date.now(),
      month: monthKey,
      gross: pendingPayslip.gross,
      net: pendingPayslip.net,
      totalDeductions: totalDed,
      deductions: pendingPayslip.deductions || {},
      earner: pendingPayslip.earner || payslipEarner || '',
      fileName: pendingPayslip.fileName,
      time: new Date().toISOString()
    };

    setPayslipStatus('×©×•××¨...');
    const ok = await window.__savePayslip(payslip);
    if (ok) {
      setPayslips([...window.__payslipData.payslips]);
      setPendingPayslip(null);
      setPayslipStatus('× ×©××¨ ×‘×”×¦×œ×—×”');
      // Auto-update gross slider from payslip data
      if (payslip.gross) {
        const rounded = Math.round(payslip.gross / 250) * 250;
        if (payslip.earner === 'father') setFM(rounded);
        else if (payslip.earner === 'mother') setMM(rounded);
      }
      setTimeout(() => setPayslipStatus(''), 2000);
    } else {
      setPayslipStatus('×©×’×™××” ×‘×©××™×¨×”');
      setTimeout(() => setPayslipStatus(''), 3000);
    }
  }, [pendingPayslip]);

  const handleDeletePayslip = useCallback(async (id) => {
    if (!confirm('×œ××—×•×§ ××ª ×”×ª×œ×•×©?')) return;
    const ok = await window.__deletePayslip(id);
    if (ok) setPayslips([...window.__payslipData.payslips]);
  }, []);

  // Compute average gross from payslips per earner for the selected year
  // Groups by month first (sums multiple employers per month), then averages across months
  const payslipAverages = useMemo(() => {
    const yearPayslips = payslips.filter(p => p.month && p.month.startsWith(selectedYear + '-'));

    const calcAvg = (earner) => {
      const slips = yearPayslips.filter(p => p.earner === earner && p.gross);
      if (slips.length === 0) return { avg: null, count: slips.length, months: 0 };
      // Group by month: sum gross from multiple employers in the same month
      const byMonth = {};
      for (const p of slips) {
        byMonth[p.month] = (byMonth[p.month] || 0) + p.gross;
      }
      const monthTotals = Object.values(byMonth);
      const avg = Math.round(monthTotals.reduce((s, v) => s + v, 0) / monthTotals.length);
      return { avg, count: slips.length, months: monthTotals.length };
    };

    const f = calcAvg('father'), m = calcAvg('mother');
    return {
      fatherAvg: f.avg, motherAvg: m.avg,
      fatherCount: f.count, motherCount: m.count,
      fatherMonths: f.months, motherMonths: m.months
    };
  }, [payslips, selectedYear]);

  const addChild = () => {
    setChildren(prev => [...prev, { id: nextId, age: 0 }]);
    setNextId(prev => prev + 1);
  };
  const removeChild = (id) => setChildren(prev => prev.filter(c => c.id !== id));
  const updateChildAge = (id, age) => setChildren(prev => prev.map(c => c.id === id ? { ...c, age } : c));

  const r = useMemo(() => {
    const ages = children.map(c => c.age);
    const nK = ages.length, nT = ages.filter(a => a >= 0 && a < 3).length;

    const calc = (monthly, isMother) => {
      const annual = monthly * 12;
      const baseP = isMother ? 2.75 : 2.25;
      const childP = ages.reduce((s, a) => s + (isMother ? motherChildPoints(a) : fatherChildPoints(a)), 0);
      const totalP = baseP + childP;
      const pVal = Math.round(totalP * CREDIT_POINT_VALUE_2026);
      const sCredit = stl ? Math.round(Math.min(annual, SETTLEMENT_CEILING) * SETTLEMENT_RATE) : 0;
      const totalCr = pVal + sCredit;
      const tax = calcTax(annual);
      const unused = Math.max(0, totalCr - tax);
      const wg = calcGrant(monthly, nK);
      const tg = calcToddler(monthly, nT, nK);
      return { annual, baseP, childP, totalP, pVal, sCredit, totalCr, tax, unused, wg, tg };
    };

    const f = calc(fM, false), m = calc(mM, true);
    const fShare = jnt ? cg / 2 : cg, mShare = jnt ? cg / 2 : 0;
    const fCGTax = Math.round(fShare * CG_TAX_RATE), mCGTax = Math.round(mShare * CG_TAX_RATE);
    const fSaved = Math.min(fCGTax, f.unused), mSaved = Math.min(mCGTax, m.unused);
    const fOpt = f.unused > 0 ? Math.round(f.unused / CG_TAX_RATE) : 0;
    const mOpt = m.unused > 0 ? Math.round(m.unused / CG_TAX_RATE) : 0;
    const hUnused = f.unused + m.unused;
    const hGrant = f.wg.grant + m.wg.grant + f.tg + m.tg;
    const hOpt = jnt ? fOpt + mOpt : fOpt;

    return { f, m, fShare, mShare, fCGTax, mCGTax, fSaved, mSaved, fOpt, mOpt, hUnused, hGrant, hOpt, nK, nT, ages };
  }, [fM, mM, children, stl, jnt, cg]);

  const fm = n => n.toLocaleString("he-IL");

  return (
    <div style={{ minHeight: "100vh", color: "#e0dcd0", padding: 0 }}>
      <div style={{ background: "linear-gradient(135deg,#181835,#251838)", borderBottom: "2px solid #c4944a", padding: "24px 20px 20px", textAlign: "center" }}>
        <div style={{ fontSize: 12, color: "#c4944a", letterSpacing: 3, marginBottom: 4, fontWeight: 600 }}>××—×©×‘×•×Ÿ ××•×¤×˜×™××™×–×¦×™×” ×‘×™×ª×™</div>
        <h1 style={{ fontSize: 22, fontWeight: 800, margin: "0 0 6px", background: "linear-gradient(90deg,#c4944a,#e8c878,#c4944a)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>
          × ×§×•×“×•×ª ×–×™×›×•×™ Ã— ××¢× ×§ ×¢×‘×•×“×” Ã— ×¨×•×•×—×™ ×”×•×Ÿ
        </h1>
        <p style={{ fontSize: 12, color: "#7a7a9a", margin: 0 }}>×—×™×©×•×‘ ××©×•×œ×‘ ×œ×©× ×™ ×‘× ×™ ×”×–×•×’ â€” ×›×•×œ×œ ×¨×¤×•×¨××ª 2024 ×•××¢× ×§ ×¤×¢×•×˜×•×ª 2025</p>
      </div>

      {/* Data Integration Banner */}
      {taxData.loaded && taxData.availableYears.length > 0 && (
        <div style={{ margin: "12px 14px", padding: "14px 16px", background: "rgba(77,171,247,0.08)", border: "1px solid rgba(77,171,247,0.25)", borderRadius: 12 }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 8 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 16 }}>ğŸ“Š</span>
              <span style={{ fontSize: 13, fontWeight: 600, color: "#7ab8e0" }}>× ×ª×•× ×™× ××”××¢×¨×›×ª ×”×¤×™× × ×¡×™×ª</span>
            </div>
            <div className="year-selector" style={{ display: "inline-flex", alignItems: "center", gap: 8, background: "rgba(255,255,255,0.04)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 10, padding: "4px 10px" }}>
              <label style={{ fontSize: 11, color: "#a0a0b8" }}>×©× ×”:</label>
              <select value={selectedYear} onChange={e => { setSelectedYear(e.target.value); setAutoApplied(false); }}
                style={{ background: "rgba(0,0,0,0.3)", border: "1px solid rgba(255,255,255,0.15)", color: "#e0dcd0", borderRadius: 6, padding: "4px 8px", fontSize: 13, fontFamily: "inherit", cursor: "pointer" }}>
                {taxData.availableYears.map(y => (
                  <option key={y} value={y} style={{ background: "#1a1a2e" }}>
                    {y} {taxData.years[y]?.isComplete ? "(12 ×—×•×“×©×™×)" : `(${taxData.years[y]?.monthCount} ×—×•×“×©×™×)`}
                  </option>
                ))}
              </select>
              <button onClick={() => applyYearData(selectedYear)} style={{
                padding: "4px 10px", borderRadius: 6, cursor: "pointer", fontSize: 11, fontWeight: 600,
                border: "1px solid rgba(196,148,74,0.4)", background: "rgba(196,148,74,0.15)", color: "#c4944a", fontFamily: "inherit"
              }}>×”×—×œ</button>
            </div>
          </div>

          {yearInfo && (
            <div style={{ marginTop: 10, display: "flex", flexWrap: "wrap", gap: 8, fontSize: 11 }}>
              {yearInfo.fatherMonthly > 0 && (
                <span style={{ background: "rgba(122,184,224,0.1)", border: "1px solid rgba(122,184,224,0.25)", padding: "3px 10px", borderRadius: 6, color: "#7ab8e0" }}>
                  ğŸ‘¨ ××‘: {fm(yearInfo.fatherMonthly)} × ×˜×•
                  {fRatio > 1.0 && <span style={{ color: "#5ab85a" }}> â†’ {fm(Math.round(yearInfo.fatherMonthly * fRatio))} ×‘×¨×•×˜×•</span>}
                  {fRatio === 1.0 && " â‚ª/×—×•×“×©"}
                </span>
              )}
              {yearInfo.motherMonthly > 0 && (
                <span style={{ background: "rgba(216,152,200,0.1)", border: "1px solid rgba(216,152,200,0.25)", padding: "3px 10px", borderRadius: 6, color: "#d898c8" }}>
                  ğŸ‘© ××: {fm(yearInfo.motherMonthly)} × ×˜×•
                  {mRatio > 1.0 && <span style={{ color: "#5ab85a" }}> â†’ {fm(Math.round(yearInfo.motherMonthly * mRatio))} ×‘×¨×•×˜×•</span>}
                  {mRatio === 1.0 && " â‚ª/×—×•×“×©"}
                </span>
              )}
              {yearInfo.untaggedMonthly > 0 && (
                <span style={{ background: "rgba(196,148,74,0.1)", border: "1px solid rgba(196,148,74,0.25)", padding: "3px 10px", borderRadius: 6, color: "#c4944a" }}>
                  âš ï¸ ×œ× ××©×•×™×š: {fm(yearInfo.untaggedMonthly)} â‚ª/×—×•×“×©
                </span>
              )}
              {!yearInfo.isComplete && (
                <span style={{ background: "rgba(224,112,112,0.1)", border: "1px solid rgba(224,112,112,0.25)", padding: "3px 10px", borderRadius: 6, color: "#e07070" }}>
                  ×—×œ×§×™ â€” {yearInfo.monthCount}/12 ×—×•×“×©×™× (×××•×¦×¢ ××•×ª××)
                </span>
              )}
            </div>
          )}

          {yearInfo && yearInfo.untaggedMonthly > 0 && (
            <div style={{ marginTop: 8, fontSize: 11, color: "#c4944a", lineHeight: 1.5 }}>
              ğŸ’¡ ×™×© ×”×›× ×¡×•×ª ×©×œ× ×©×•×™×›×• ×œ××‘/××. <a href="finance.html" style={{ color: "#c4944a", textDecoration: "underline" }}>×©×™×™×š ××•×ª×Ÿ ×‘××¢×¨×›×ª ×”×¤×™× × ×¡×™×ª</a> ×œ×—×™×©×•×‘ ××“×•×™×§ ×™×•×ª×¨.
            </div>
          )}
          <div style={{ marginTop: 8, fontSize: 10, color: "#6a6a8a", lineHeight: 1.5 }}>
            ğŸ“… ×”×™×¡×˜ ×—×•×“×©: ×”××©×›×•×¨×ª ×‘××¢×§×‘ (15-15) ××•×¡×˜×ª ×—×•×“×© ××—×•×¨×” ×œ×©× ×ª ××¡ (×œ××©×œ: "×™× ×•××¨" ×‘××¢×§×‘ = ×“×¦××‘×¨ ×œ×¦×•×¨×š ××¡)
          </div>
        </div>
      )}

      {taxData.loaded && taxData.availableYears.length === 0 && (
        <div style={{ margin: "12px 14px", padding: "14px 16px", background: "rgba(196,148,74,0.08)", border: "1px solid rgba(196,148,74,0.25)", borderRadius: 12, fontSize: 12, color: "#c4944a" }}>
          <span style={{ fontSize: 16 }}>ğŸ’¡</span> ××™×Ÿ × ×ª×•× ×™ ×”×›× ×¡×” ×‘××¢×¨×›×ª. <a href="finance.html" style={{ color: "#c4944a", textDecoration: "underline" }}>×”×•×¡×£ ×”×›× ×¡×•×ª</a> ×›×“×™ ×œ××œ× ××ª ×”×¡×œ×™×™×“×¨×™× ××•×˜×•××˜×™×ª.
        </div>
      )}

      <div style={{ margin: "16px 14px", padding: "14px 16px", background: "rgba(30,120,30,0.1)", border: "1px solid rgba(30,120,30,0.35)", borderRadius: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
          <span style={{ fontSize: 20 }}>âœ…</span>
          <span style={{ fontSize: 14, fontWeight: 700, color: "#5ab85a" }}>××™×Ÿ ×§×•× ×¤×œ×™×§×˜ â€” ×¨×•×•×—×™ ×”×•×Ÿ ×œ× ×¤×•×’×¢×™× ×‘××¢× ×§</span>
        </div>
        <p style={{ fontSize: 12, lineHeight: 1.7, margin: 0, color: "#a8cca8" }}>
          ×”×—×•×§ ××’×“×™×¨ "×”×›× ×¡×” ×—×™×™×‘×ª" <strong>×œ××¢×˜ ×¨×•×•×— ×”×•×Ÿ</strong>. ××™××•×© ×¨×•×•×—×™ ×”×•×Ÿ ×œ× ××©× ×” ××ª ×”×”×›× ×¡×” ×œ×¦×•×¨×š ×–×›××•×ª ×œ××¢× ×§ ×¢×‘×•×“×”.
        </p>
      </div>

      <div style={{ padding: "0 14px 32px", maxWidth: 720, margin: "0 auto" }}>
        {/* INPUTS */}
        <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.07)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 14px" }}>âš™ï¸ × ×ª×•× ×™ ××©×§ ×”×‘×™×ª</h2>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <div>
              <Sl label="×”×›× ×¡×ª ×”××‘ (×—×•×“×©×™ ×‘×¨×•×˜×•)" value={fM} onChange={v => { setFM(v); }} min={0} max={15000} step={250} suf="â‚ª" tip="×”×›× ×¡×ª ×¢×‘×•×“×” ×‘×¨×•×˜×• ×‘×œ×‘×“" />
              {payslipAverages.fatherAvg && fM !== Math.round(payslipAverages.fatherAvg / 250) * 250 && (
                <div style={{ display: "flex", alignItems: "center", gap: 4, marginTop: 2 }}>
                  <span style={{ fontSize: 10, color: "#c0a0d8" }}>×ª×œ×•×©×™×: â‚ª{payslipAverages.fatherAvg.toLocaleString()}</span>
                  <button onClick={() => setFM(Math.round(payslipAverages.fatherAvg / 250) * 250)} style={{
                    padding: "1px 8px", borderRadius: 4, cursor: "pointer", fontSize: 10, fontWeight: 600,
                    border: "1px solid rgba(140,80,200,0.4)", background: "rgba(140,80,200,0.12)", color: "#c0a0d8"
                  }}>×”×—×–×¨ ×œ×ª×œ×•×©×™×</button>
                </div>
              )}
            </div>
            <div>
              <Sl label="×”×›× ×¡×ª ×”×× (×—×•×“×©×™ ×‘×¨×•×˜×•)" value={mM} onChange={v => { setMM(v); }} min={0} max={15000} step={250} suf="â‚ª" />
              {payslipAverages.motherAvg && mM !== Math.round(payslipAverages.motherAvg / 250) * 250 && (
                <div style={{ display: "flex", alignItems: "center", gap: 4, marginTop: 2 }}>
                  <span style={{ fontSize: 10, color: "#c0a0d8" }}>×ª×œ×•×©×™×: â‚ª{payslipAverages.motherAvg.toLocaleString()}</span>
                  <button onClick={() => setMM(Math.round(payslipAverages.motherAvg / 250) * 250)} style={{
                    padding: "1px 8px", borderRadius: 4, cursor: "pointer", fontSize: 10, fontWeight: 600,
                    border: "1px solid rgba(140,80,200,0.4)", background: "rgba(140,80,200,0.12)", color: "#c0a0d8"
                  }}>×”×—×–×¨ ×œ×ª×œ×•×©×™×</button>
                </div>
              )}
            </div>
          </div>

          {/* Payslip Upload */}
          <div style={{ marginTop: 10, padding: "12px 14px", background: "rgba(140,80,200,0.08)", borderRadius: 10, border: "1px solid rgba(140,80,200,0.2)" }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 8, marginBottom: 8 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                <span style={{ fontSize: 14 }}>ğŸ“„</span>
                <span style={{ fontSize: 12, fontWeight: 600, color: "#c0a0d8" }}>×”×¢×œ××ª ×ª×œ×•×© ××©×›×•×¨×ª</span>
                <InfoTip text={"×”×¢×œ×” ×ª×œ×•×© ××©×›×•×¨×ª (PDF ××• ×ª××•× ×”).\n×”××¢×¨×›×ª ×ª× ×¡×” ×œ×—×œ×¥ ××•×˜×•××˜×™×ª: ×‘×¨×•×˜×•, × ×˜×•, × ×™×›×•×™×™× ×•×—×•×“×©.\n×× ×œ× ××¦×œ×™×—×” â€” × ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×™×“× ×™×ª.\n×”×‘×¨×•×˜×• ×™×¢×“×›×Ÿ ××ª ×”×¡×œ×™×™×“×¨ ××•×˜×•××˜×™×ª."} />
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <select value={payslipEarner} onChange={e => setPayslipEarner(e.target.value)}
                  style={{ background: "rgba(0,0,0,0.3)", border: "1px solid rgba(255,255,255,0.15)", color: "#e0dcd0", borderRadius: 6, padding: "4px 8px", fontSize: 11, fontFamily: "inherit" }}>
                  <option value="">×‘×¢×œ/×ª ×”×›× ×¡×”</option>
                  <option value="father">××‘</option>
                  <option value="mother">××</option>
                </select>
                <label style={{
                  padding: "5px 14px", borderRadius: 8, cursor: "pointer", fontSize: 11, fontWeight: 600,
                  border: "1px solid rgba(140,80,200,0.4)", background: "rgba(140,80,200,0.2)", color: "#c0a0d8"
                }}>
                  ×”×¢×œ×” ×§×•×‘×¥
                  <input ref={fileInputRef} type="file" accept=".pdf,.jpg,.jpeg,.png,.webp,.heic" onChange={handlePayslipFile} style={{ display: "none" }} />
                </label>
                <button onClick={() => setPendingPayslip({ _manualEntry: true, fileName: '×”×–× ×” ×™×“× ×™×ª', deductions: {} })} style={{
                  padding: "5px 10px", borderRadius: 8, cursor: "pointer", fontSize: 11, fontWeight: 600,
                  border: "1px solid rgba(255,255,255,0.12)", background: "rgba(255,255,255,0.05)", color: "#a0a0b8"
                }}>×”×–× ×” ×™×“× ×™×ª</button>
              </div>
            </div>

            {payslipStatus && (
              <div style={{ fontSize: 11, color: "#c0a0d8", marginBottom: 8 }}>{payslipStatus}</div>
            )}

            {/* Preview â€” auto-parsed or manual entry */}
            {pendingPayslip && (
              <div style={{ background: pendingPayslip._isForm106 ? "rgba(196,148,74,0.08)" : "rgba(77,171,247,0.08)", border: `1px solid ${pendingPayslip._isForm106 ? "rgba(196,148,74,0.25)" : "rgba(77,171,247,0.2)"}`, borderRadius: 8, padding: "10px 12px", marginBottom: 8 }}>
                {pendingPayslip._isForm106 ? (
                  <>
                    <div style={{ fontSize: 12, fontWeight: 700, color: "#c4944a", marginBottom: 8, display: "flex", alignItems: "center", gap: 6 }}>
                      <span>×˜×•×¤×¡ 106 ×–×•×”×” â€” ×¡×™×›×•× ×©× ×ª×™</span>
                      <input type="number" min="2020" max="2030" value={pendingPayslip.year || ''}
                        onChange={e => setPendingPayslip(p => ({...p, year: e.target.value || null}))}
                        style={{ width: 60, background: "rgba(0,0,0,0.3)", border: "1px solid rgba(196,148,74,0.4)", color: "#c4944a", borderRadius: 4, padding: "2px 4px", fontSize: 12, fontWeight: 700, fontFamily: "inherit", textAlign: "center" }}
                      />
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, fontSize: 11 }}>
                      <div style={{ background: "rgba(0,0,0,0.15)", borderRadius: 6, padding: "8px 10px" }}>
                        <div style={{ color: "#7a7a9a", marginBottom: 4 }}>× ×ª×•× ×™× ×©× ×ª×™×™×</div>
                        {pendingPayslip.annualGross && <div><span style={{ color: "#7a7a9a" }}>×‘×¨×•×˜×• ×©× ×ª×™: </span><strong style={{ color: "#5ab85a" }}>â‚ª{pendingPayslip.annualGross.toLocaleString()}</strong></div>}
                        {pendingPayslip.annualNet && <div><span style={{ color: "#7a7a9a" }}>× ×˜×• ×©× ×ª×™: </span><strong style={{ color: "#5ab85a" }}>â‚ª{pendingPayslip.annualNet.toLocaleString()}</strong></div>}
                        <div style={{ color: "#7a7a9a", marginTop: 2 }}>×—×•×“×©×™ ×¢×‘×•×“×”: {pendingPayslip.months}</div>
                      </div>
                      <div style={{ background: "rgba(0,0,0,0.15)", borderRadius: 6, padding: "8px 10px" }}>
                        <div style={{ color: "#7a7a9a", marginBottom: 4 }}>×××•×¦×¢ ×—×•×“×©×™ (×—×™×©×•×‘)</div>
                        {pendingPayslip.monthlyGross && <div><span style={{ color: "#7a7a9a" }}>×‘×¨×•×˜×•: </span><strong style={{ color: "#c4944a" }}>â‚ª{pendingPayslip.monthlyGross.toLocaleString()}</strong></div>}
                        {pendingPayslip.monthlyNet && <div><span style={{ color: "#7a7a9a" }}>× ×˜×•: </span><strong style={{ color: "#c4944a" }}>â‚ª{pendingPayslip.monthlyNet.toLocaleString()}</strong></div>}
                      </div>
                    </div>
                    {!pendingPayslip.earner && !payslipEarner && (
                      <div style={{ color: "#e07070", fontSize: 10, marginTop: 6 }}>×™×© ×œ×‘×—×•×¨ ×‘×Ÿ ×–×•×’ (××‘/××) ×œ××¢×œ×” ×œ×¤× ×™ ×”××™×©×•×¨</div>
                    )}
                    <div style={{ fontSize: 10, color: "#a0a0b8", marginTop: 6 }}>
                      ×™×™×•×•×¦×¨×• {pendingPayslip.months} ×¨×©×•××•×ª ×—×•×“×©×™×•×ª ×¢×‘×•×¨ ×©× ×ª {pendingPayslip.year}
                    </div>
                    <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                      <button onClick={confirmForm106Upload}
                        disabled={!pendingPayslip.earner && !payslipEarner}
                        style={{
                          padding: "5px 16px", borderRadius: 6, cursor: (!pendingPayslip.earner && !payslipEarner) ? "default" : "pointer", fontSize: 11, fontWeight: 600,
                          border: "1px solid rgba(196,148,74,0.4)", background: "rgba(196,148,74,0.15)", color: "#c4944a",
                          opacity: (!pendingPayslip.earner && !payslipEarner) ? 0.4 : 1
                      }}>××©×¨ ×˜×•×¤×¡ 106</button>
                      <button onClick={() => setPendingPayslip(null)} style={{
                        padding: "5px 12px", borderRadius: 6, cursor: "pointer", fontSize: 11,
                        border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "#7a7a9a"
                      }}>×‘×˜×œ</button>
                    </div>
                  </>
                ) : pendingPayslip._manualEntry ? (
                  <>
                    <div style={{ fontSize: 11, fontWeight: 600, color: "#7ab8e0", marginBottom: 6 }}>
                      {pendingPayslip._scanned ? '×”×ª×œ×•×© × ×¨××” ×›×ª××•× ×” ×¡×¨×•×§×” â€” ×™×© ×œ×”×–×™×Ÿ ×™×“× ×™×ª:'
                        : pendingPayslip._parseHint ? '×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ××•×˜×•××˜×™×ª â€” ×”×–×Ÿ ×™×“× ×™×ª:'
                        : '×”×–× ×” ×™×“× ×™×ª:'}
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, fontSize: 11 }}>
                      <div>
                        <label style={{ color: "#7a7a9a", display: "block", marginBottom: 2 }}>×—×•×“×©</label>
                        <input type="month" value={pendingPayslip.year && pendingPayslip.month ? `${pendingPayslip.year}-${pendingPayslip.month}` : ''}
                          onChange={e => { const [y,m]=(e.target.value||'').split('-'); setPendingPayslip(p=>({...p,month:m||null,year:y||null})); }}
                          style={{ background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",color:"#e0dcd0",borderRadius:4,padding:"4px 6px",fontSize:11,fontFamily:"inherit",width:"100%" }}
                        />
                      </div>
                      <div>
                        <label style={{ color: "#7a7a9a", display: "block", marginBottom: 2 }}>×‘×¨×•×˜×• (â‚ª)</label>
                        <input type="number" placeholder="15,000" value={pendingPayslip.gross||''}
                          onChange={e => setPendingPayslip(p=>({...p,gross:e.target.value?parseFloat(e.target.value):null}))}
                          style={{ background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",color:"#e0dcd0",borderRadius:4,padding:"4px 6px",fontSize:11,fontFamily:"inherit",width:"100%" }}
                        />
                      </div>
                      <div>
                        <label style={{ color: "#7a7a9a", display: "block", marginBottom: 2 }}>× ×˜×• (â‚ª)</label>
                        <input type="number" placeholder="11,000" value={pendingPayslip.net||''}
                          onChange={e => setPendingPayslip(p=>({...p,net:e.target.value?parseFloat(e.target.value):null}))}
                          style={{ background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",color:"#e0dcd0",borderRadius:4,padding:"4px 6px",fontSize:11,fontFamily:"inherit",width:"100%" }}
                        />
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    <div style={{ fontSize: 11, fontWeight: 600, color: "#7ab8e0", marginBottom: 6 }}>× ×ª×•× ×™× ×©×—×•×œ×¦×•:</div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 6, fontSize: 11, alignItems: "center" }}>
                      <div>
                        <span style={{ color: "#7a7a9a" }}>×—×•×“×©: </span>
                        <input type="month" value={pendingPayslip.year && pendingPayslip.month ? `${pendingPayslip.year}-${pendingPayslip.month}` : ''}
                          onChange={e => {
                            const [y, m] = (e.target.value || '').split('-');
                            setPendingPayslip(prev => ({ ...prev, month: m || null, year: y || null }));
                          }}
                          style={{ background: "rgba(0,0,0,0.3)", border: "1px solid rgba(255,255,255,0.15)", color: "#e0dcd0", borderRadius: 4, padding: "2px 4px", fontSize: 11, fontFamily: "inherit", width: 110 }}
                        />
                        {!pendingPayslip.month && <div style={{ color: "#e07070", fontSize: 10, marginTop: 2 }}>×‘×—×¨ ×—×•×“×©</div>}
                      </div>
                      <div><span style={{ color: "#7a7a9a" }}>×‘×¨×•×˜×•: </span><strong style={{ color: "#5ab85a" }}>{pendingPayslip.gross ? `â‚ª${pendingPayslip.gross.toLocaleString()}` : '?'}</strong></div>
                      <div><span style={{ color: "#7a7a9a" }}>× ×˜×•: </span><strong style={{ color: "#5ab85a" }}>{pendingPayslip.net ? `â‚ª${pendingPayslip.net.toLocaleString()}` : '?'}</strong></div>
                      <div><span style={{ color: "#7a7a9a" }}>× ×™×›×•×™×™×: </span><strong style={{ color: "#e07070" }}>{pendingPayslip.totalDeductions ? `â‚ª${pendingPayslip.totalDeductions.toLocaleString()}` : '?'}</strong></div>
                    </div>
                    {Object.keys(pendingPayslip.deductions || {}).length > 0 && (
                      <div style={{ fontSize: 10, color: "#7a7a9a", marginTop: 4 }}>
                        {Object.values(pendingPayslip.deductions).map(d => `${d.label}: â‚ª${d.amount.toLocaleString()}`).join(' | ')}
                      </div>
                    )}
                  </>
                )}
                {!pendingPayslip._isForm106 && (
                  <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                    <button onClick={confirmPayslipUpload}
                      disabled={!pendingPayslip.gross && !pendingPayslip.net}
                      style={{
                        padding: "5px 16px", borderRadius: 6, cursor: (!pendingPayslip.gross && !pendingPayslip.net) ? "default" : "pointer", fontSize: 11, fontWeight: 600,
                        border: "1px solid rgba(90,184,90,0.4)", background: "rgba(90,184,90,0.15)", color: "#5ab85a",
                        opacity: (!pendingPayslip.gross && !pendingPayslip.net) ? 0.4 : 1
                    }}>××©×¨ ×•×©××•×¨</button>
                    <button onClick={() => setPendingPayslip(null)} style={{
                      padding: "5px 12px", borderRadius: 6, cursor: "pointer", fontSize: 11,
                      border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "#7a7a9a"
                    }}>×‘×˜×œ</button>
                  </div>
                )}
              </div>
            )}

            {/* Payslip averages for selected year */}
            {(payslipAverages.fatherAvg || payslipAverages.motherAvg) && (
              <div style={{ display: "flex", flexWrap: "wrap", gap: 6, fontSize: 11, marginBottom: 8 }}>
                {payslipAverages.fatherAvg && (
                  <span style={{ background: "rgba(122,184,224,0.1)", border: "1px solid rgba(122,184,224,0.2)", padding: "3px 8px", borderRadius: 6, color: "#7ab8e0" }}>
                    ğŸ‘¨ ×‘×¨×•×˜×• ×××•×¦×¢: â‚ª{payslipAverages.fatherAvg.toLocaleString()} ({payslipAverages.fatherMonths} ×—×•×“×©×™×{payslipAverages.fatherCount > payslipAverages.fatherMonths ? `, ${payslipAverages.fatherCount} ×ª×œ×•×©×™×` : ''})
                    <button onClick={() => setFM(Math.round(payslipAverages.fatherAvg / 250) * 250)} style={{
                      marginRight: 4, padding: "1px 6px", borderRadius: 4, cursor: "pointer", fontSize: 10, fontWeight: 600,
                      border: "1px solid rgba(90,184,90,0.4)", background: "rgba(90,184,90,0.1)", color: "#5ab85a"
                    }}>×”×—×œ</button>
                  </span>
                )}
                {payslipAverages.motherAvg && (
                  <span style={{ background: "rgba(216,152,200,0.1)", border: "1px solid rgba(216,152,200,0.2)", padding: "3px 8px", borderRadius: 6, color: "#d898c8" }}>
                    ğŸ‘© ×‘×¨×•×˜×• ×××•×¦×¢: â‚ª{payslipAverages.motherAvg.toLocaleString()} ({payslipAverages.motherMonths} ×—×•×“×©×™×{payslipAverages.motherCount > payslipAverages.motherMonths ? `, ${payslipAverages.motherCount} ×ª×œ×•×©×™×` : ''})
                    <button onClick={() => setMM(Math.round(payslipAverages.motherAvg / 250) * 250)} style={{
                      marginRight: 4, padding: "1px 6px", borderRadius: 4, cursor: "pointer", fontSize: 10, fontWeight: 600,
                      border: "1px solid rgba(90,184,90,0.4)", background: "rgba(90,184,90,0.1)", color: "#5ab85a"
                    }}>×”×—×œ</button>
                  </span>
                )}
              </div>
            )}

            {/* Payslip History */}
            {payslips.length > 0 && (
              <div>
                <div style={{ fontSize: 11, fontWeight: 600, color: "#a0a0b8", marginBottom: 4 }}>×ª×œ×•×©×™× ({payslips.length}):</div>
                <div style={{ display: "flex", flexDirection: "column", gap: 4, maxHeight: 150, overflowY: "auto" }}>
                  {payslips.sort((a,b) => (b.month||'').localeCompare(a.month||'')).map(p => (
                    <div key={p.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", background: "rgba(0,0,0,0.15)", borderRadius: 6, padding: "4px 10px", fontSize: 11 }}>
                      <span style={{ color: "#a0a0b8" }}>
                        {p.month} {p.earner === 'father' ? 'ğŸ‘¨' : p.earner === 'mother' ? 'ğŸ‘©' : ''}
                      </span>
                      <span>
                        <span style={{ color: "#7a7a9a" }}>×‘×¨×•×˜×•: </span><strong style={{ color: "#5ab85a" }}>â‚ª{p.gross?.toLocaleString() || '?'}</strong>
                        <span style={{ color: "#7a7a9a", marginRight: 8 }}> × ×˜×•: </span><strong>â‚ª{p.net?.toLocaleString() || '?'}</strong>
                      </span>
                      <button onClick={() => handleDeletePayslip(p.id)} style={{
                        width: 18, height: 18, borderRadius: "50%", cursor: "pointer", fontSize: 11,
                        border: "1px solid rgba(224,112,112,0.3)", background: "rgba(224,112,112,0.1)",
                        color: "#e07070", display: "flex", alignItems: "center", justifyContent: "center",
                        lineHeight: 1, padding: 0
                      }}>Ã—</button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Gross/Net Ratio (fallback when no payslips) */}
          {payslips.length === 0 && (
          <div style={{ marginTop: 10, padding: "10px 14px", background: "rgba(0,0,0,0.15)", borderRadius: 10, border: "1px solid rgba(255,255,255,0.05)" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}>
              <span style={{ fontSize: 12, fontWeight: 600, color: "#a0a0b8" }}>×™×—×¡ ×‘×¨×•×˜×•/× ×˜×•</span>
              <InfoTip text={"×”× ×ª×•× ×™× ××”××¢×§×‘ ×”×¤×™× × ×¡×™ ×”× × ×˜×• (××” ×©× ×›× ×¡ ×œ×—×©×‘×•×Ÿ). ×™×—×¡ ×–×” ××›×¤×™×œ ××ª ×”× ×˜×• ×œ×‘×¨×•×˜×• ××©×•×¢×¨.\n\n×œ×—×œ×•×¤×™×Ÿ â€” ×”×¢×œ×” ×ª×œ×•×©×™ ××©×›×•×¨×ª ×œ××¢×œ×” ×œ×—×™×©×•×‘ ××“×•×™×§.\n\nâ€¢ 1.00 = ×›×‘×¨ ×‘×¨×•×˜×•\nâ€¢ 1.07 = ×œ×œ× ××¡ (×¨×§ ×‘×™×˜×•×— ×œ××•××™+×‘×¨×™××•×ª)\nâ€¢ 1.20 = ××“×¨×’×ª 10%\nâ€¢ 1.26 = ××“×¨×’×ª 14%"} />
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
              <div>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
                  <label style={{ fontSize: 11, color: "#7ab8e0" }}>ğŸ‘¨ ××‘</label>
                  <span style={{ fontSize: 12, fontWeight: 700, color: "#e0dcd0" }}>Ã—{fRatio.toFixed(2)}</span>
                </div>
                <input type="range" min={1.0} max={1.5} step={0.01} value={fRatio} onChange={e => setFRatio(+e.target.value)} />
              </div>
              <div>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
                  <label style={{ fontSize: 11, color: "#d898c8" }}>ğŸ‘© ××</label>
                  <span style={{ fontSize: 12, fontWeight: 700, color: "#e0dcd0" }}>Ã—{mRatio.toFixed(2)}</span>
                </div>
                <input type="range" min={1.0} max={1.5} step={0.01} value={mRatio} onChange={e => setMRatio(+e.target.value)} />
              </div>
            </div>
          </div>
          )}

          {/* CHILDREN */}
          <div style={{ marginTop: 14 }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 10 }}>
              <label style={{ fontSize: 13, fontWeight: 700, color: "#a0a0b8" }}>ğŸ‘¶ ×™×œ×“×™× ({children.length})</label>
              <button onClick={addChild} style={{
                padding: "5px 14px", borderRadius: 20, cursor: "pointer", fontSize: 12, fontWeight: 600,
                border: "1px solid rgba(196,148,74,0.4)", background: "rgba(196,148,74,0.1)", color: "#c4944a"
              }}>+ ×”×•×¡×£ ×™×œ×“</button>
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {children.map((child, i) => (
                <div key={child.id} style={{ display: "flex", alignItems: "center", gap: 10, background: "rgba(0,0,0,0.15)", borderRadius: 10, padding: "8px 12px" }}>
                  <span style={{ fontSize: 12, color: "#7a7a9a", minWidth: 50 }}>×™×œ×“ {i + 1}</span>
                  <input type="range" min={0} max={18} step={1} value={child.age}
                    onChange={e => updateChildAge(child.id, +e.target.value)}
                    style={{ flex: 1 }} />
                  <span style={{ fontSize: 13, fontWeight: 700, color: "#e0dcd0", minWidth: 55, textAlign: "center" }}>
                    {child.age === 0 ? "×œ×™×“×”" : `${child.age} ${child.age === 1 ? "×©× ×”" : "×©× ×™×"}`}
                  </span>
                  <button onClick={() => removeChild(child.id)} style={{
                    width: 24, height: 24, borderRadius: "50%", cursor: "pointer", fontSize: 14,
                    border: "1px solid rgba(224,112,112,0.3)", background: "rgba(224,112,112,0.1)",
                    color: "#e07070", display: "flex", alignItems: "center", justifyContent: "center",
                    lineHeight: 1, padding: 0
                  }}>Ã—</button>
                </div>
              ))}
              {children.length === 0 && (
                <div style={{ fontSize: 12, color: "#6a6a8a", textAlign: "center", padding: 10 }}>
                  ××™×Ÿ ×™×œ×“×™×. ×œ×—×¥ "×”×•×¡×£ ×™×œ×“" ×›×“×™ ×œ×”×ª×—×™×œ.
                </div>
              )}
            </div>
          </div>

          <div style={{ display: "flex", flexWrap: "wrap", gap: 10, marginTop: 12 }}>
            <Tog label="×™×©×•×‘ ××–×›×”" active={stl} onClick={() => setStl(!stl)} />
            <Tog label="×—×©×‘×•×Ÿ ××©×•×ª×£" active={jnt} onClick={() => setJnt(!jnt)} />
          </div>
          <div style={{ marginTop: 12 }}>
            <Sl label="×¨×•×•×—×™ ×”×•×Ÿ ×¦×‘×•×¨×™× ×œ×××©" value={cg} onChange={setCg} min={0} max={500000} step={5000} suf="â‚ª" tip="×‘×—×©×‘×•×Ÿ ××©×•×ª×£ ××ª×—×œ×§ 50/50" wide />
          </div>
        </div>

        {/* CREDIT POINTS */}
        <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.07)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 12px" }}>ğŸ“Š × ×§×•×“×•×ª ×–×™×›×•×™</h2>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            {[{ d: r.f, icon: "ğŸ‘¨", clr: "#7ab8e0", lbl: "×”××‘", base: "2.25 (×ª×•×©×‘)" },
              { d: r.m, icon: "ğŸ‘©", clr: "#d898c8", lbl: "×”××", base: "2.75 (×ª×•×©×‘×ª+××™×©×”)" }].map(({ d, icon, clr, lbl, base }) => (
              <div key={lbl} style={{ background: "rgba(0,0,0,0.2)", borderRadius: 10, padding: 14 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: clr, marginBottom: 8 }}>{icon} {lbl}</div>
                <R label="×‘×¡×™×¡" amount={base} />
                <R label="×™×œ×“×™×" amount={d.childP.toFixed(1)} />
                <R label="×¡×”×´×› × ×§×•×“×•×ª" amount={d.totalP.toFixed(2)} bold />
                <div style={{ marginTop: 8 }}>
                  <R label="×©×•×•×™ × ×§×•×“×•×ª" amount={`${fm(d.pVal)} â‚ª`} />
                  {stl && <R label="×–×™×›×•×™ ×™×©×•×‘" amount={`${fm(d.sCredit)} â‚ª`} />}
                  <R label="×¡×”×´×› ×–×™×›×•×™×™×" amount={`${fm(d.totalCr)} â‚ª`} color="#c4944a" bold />
                </div>
                <div style={{ marginTop: 8 }}>
                  <R label="××¡ ×”×›× ×¡×” ×©× ×ª×™" amount={`${fm(d.tax)} â‚ª`} color="#e07070" />
                  <R label="×¢×•×“×¤×™×" amount={`${fm(d.unused)} â‚ª`} color="#c4944a" bold />
                </div>
              </div>
            ))}
          </div>
          <div style={{ marginTop: 12, padding: "12px 16px", background: "rgba(196,148,74,0.08)", borderRadius: 10, textAlign: "center" }}>
            <div style={{ fontSize: 12, color: "#a0a0b8" }}>×¡×”×´×› ×–×™×›×•×™×™× ×¢×•×“×¤×™× ×œ××©×§ ×”×‘×™×ª</div>
            <div style={{ fontSize: 26, fontWeight: 800, color: "#c4944a" }}>{fm(r.hUnused)} â‚ª</div>
            <div style={{ fontSize: 11, color: "#7a7a9a" }}>×”×•×œ×›×™× ×œ××™×‘×•×“ â€” ××œ× ×× ××××©×™× ×¨×•×•×—×™ ×”×•×Ÿ</div>
          </div>
        </div>

        {/* WORK GRANT */}
        <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.07)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 12px" }}>ğŸ ××¢× ×§ ×¢×‘×•×“×”</h2>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            {[{ d: r.f, m: fM, icon: "ğŸ‘¨", clr: "#7ab8e0", lbl: "×”××‘" },
              { d: r.m, m: mM, icon: "ğŸ‘©", clr: "#d898c8", lbl: "×”××" }].map(({ d, m: mo, icon, clr, lbl }) => (
              <div key={lbl} style={{ background: "rgba(0,0,0,0.2)", borderRadius: 10, padding: 14 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: clr, marginBottom: 8 }}>{icon} {lbl}</div>
                {d.wg.ok ? (
                  <>
                    <R label="××¢× ×§ ×›×œ×œ×™" amount={`${fm(d.wg.grant)} â‚ª`} />
                    <R label="××¢× ×§ ×¤×¢×•×˜×•×ª" amount={`${fm(d.tg)} â‚ª`} />
                    <R label="×¡×”×´×›" amount={`${fm(d.wg.grant + d.tg)} â‚ª`} color="#5ab85a" bold />
                  </>
                ) : (
                  <div style={{ fontSize: 12, color: "#c08080" }}>
                    âš ï¸ ×”×›× ×¡×” {mo < 2390 ? "××ª×—×ª" : "××¢×œ"} ×œ×˜×•×•×—
                    {d.tg > 0 && <div style={{ color: "#a8cca8", marginTop: 4 }}>âœ“ ××¢× ×§ ×¤×¢×•×˜×•×ª: {fm(d.tg)} â‚ª</div>}
                  </div>
                )}
              </div>
            ))}
          </div>
          <div style={{ marginTop: 10, padding: "8px 14px", background: "rgba(30,120,30,0.08)", borderRadius: 8, fontSize: 12, color: "#a8cca8" }}>
            ×¡×”×´×› ××¢× ×§×™×: <strong>{fm(r.hGrant)} â‚ª/×©× ×”</strong> (×”×¢×¨×›×”. <a href="https://www.misim.gov.il/gmmhszakaut/" target="_blank">×¡×™××•×œ×˜×•×¨</a> ×œ×—×™×©×•×‘ ××“×•×™×§)
          </div>
        </div>

        {/* CAPITAL GAINS */}
        <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(196,148,74,0.3)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 12px" }}>ğŸ¯ ××™××•×© ×¨×•×•×—×™ ×”×•×Ÿ</h2>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 14 }}>
            {[{ lbl: "ğŸ‘¨ ×—×œ×§ ×”××‘", sh: r.fShare, tx: r.fCGTax, sv: r.fSaved, clr: "#7ab8e0" },
              { lbl: "ğŸ‘© ×—×œ×§ ×”××", sh: r.mShare, tx: r.mCGTax, sv: r.mSaved, clr: "#d898c8" }].map(x => (
              <div key={x.lbl} style={{ background: "rgba(0,0,0,0.2)", borderRadius: 10, padding: 14 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: x.clr, marginBottom: 8 }}>{x.lbl}</div>
                <R label="×¨×•×•×— ×”×•×Ÿ" amount={`${fm(x.sh)} â‚ª`} />
                <R label="××¡ 25%" amount={`${fm(x.tx)} â‚ª`} color="#e07070" />
                <R label="×§×™×–×•×– ××–×™×›×•×™×™×" amount={`-${fm(x.sv)} â‚ª`} color="#5ab85a" />
                <R label="××¡ × ×•×ª×¨" amount={`${fm(x.tx - x.sv)} â‚ª`} bold />
              </div>
            ))}
          </div>
          <div style={{ padding: "14px 16px", borderRadius: 10, background: "linear-gradient(135deg,rgba(196,148,74,0.1),rgba(196,148,74,0.03))", border: "1px solid rgba(196,148,74,0.25)" }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: "#c4944a", marginBottom: 6 }}>ğŸ’° ×¡×›×•× ××™××•×© ××•×¤×˜×™××œ×™</div>
            <p style={{ fontSize: 13, lineHeight: 1.7, margin: "0 0 4px" }}>
              ×œ× ×™×¦×•×œ ××œ×•× ×”×–×™×›×•×™×™× ({fm(r.hUnused)} â‚ª): ×××© <strong>{fm(r.hOpt)} â‚ª</strong>
              {jnt && ` (${fm(r.fOpt)} ××‘ + ${fm(r.mOpt)} ××)`}
            </p>
            <p style={{ fontSize: 13, margin: 0 }}>×”×—×–×¨ ××¡ ×¦×¤×•×™: <strong>{fm(r.hUnused)} â‚ª</strong> â€” ××¡ ××¤×§×˜×™×‘×™ 0%.</p>
          </div>
        </div>

        {/* BOTTOM LINE */}
        <div style={{ background: "linear-gradient(135deg,rgba(196,148,74,0.06),rgba(196,148,74,0.02))", borderRadius: 14, border: "1px solid rgba(196,148,74,0.2)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 14px" }}>âš–ï¸ ×©×•×¨×” ×ª×—×ª×•× ×” â€” ×©× ×ª×™</h2>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
            <div style={{ padding: 14, borderRadius: 10, background: "rgba(0,0,0,0.2)", border: "1px solid rgba(255,255,255,0.05)" }}>
              <div style={{ fontSize: 12, color: "#8a8aaa", marginBottom: 6 }}>×œ×œ× ××™××•×©</div>
              <R label="××¢× ×§×™×" amount={`${fm(r.hGrant)} â‚ª`} />
              <R label="×—×™×¡×›×•×Ÿ ××¡" amount="0 â‚ª" />
              <R label="×¡×”×´×›" amount={`${fm(r.hGrant)} â‚ª`} bold />
            </div>
            <div style={{ padding: 14, borderRadius: 10, background: "rgba(77,171,247,0.06)", border: "1px solid rgba(77,171,247,0.25)" }}>
              <div style={{ fontSize: 12, color: "#7ab8e0", marginBottom: 6, fontWeight: 600 }}>ğŸ“Œ ××™××•×© ×‘×¤×•×¢×œ ({fm(cg)} â‚ª)</div>
              <R label="××¢× ×§×™×" amount={`${fm(r.hGrant)} â‚ª`} />
              <R label="×—×™×¡×›×•×Ÿ ××¡" amount={`${fm(r.fSaved + r.mSaved)} â‚ª`} color="#5ab85a" />
              <R label="×¡×”×´×›" amount={`${fm(r.hGrant + r.fSaved + r.mSaved)} â‚ª`} color="#7ab8e0" bold />
            </div>
            <div style={{ padding: 14, borderRadius: 10, background: "rgba(30,120,30,0.06)", border: "1px solid rgba(30,120,30,0.25)" }}>
              <div style={{ fontSize: 12, color: "#5ab85a", marginBottom: 6, fontWeight: 600 }}>âœ¨ ××™××•×© ××•×¤×˜×™××œ×™ ({fm(r.hOpt)} â‚ª)</div>
              <R label="××¢× ×§×™×" amount={`${fm(r.hGrant)} â‚ª`} />
              <R label="×—×™×¡×›×•×Ÿ ××¡" amount={`${fm(r.hUnused)} â‚ª`} color="#5ab85a" />
              <R label="×¡×”×´×›" amount={`${fm(r.hGrant + r.hUnused)} â‚ª`} color="#5ab85a" bold />
            </div>
          </div>
          <div style={{ marginTop: 14, padding: "14px", borderRadius: 10, background: "rgba(196,148,74,0.1)", textAlign: "center" }}>
            <div style={{ fontSize: 12, color: "#a0a0b8" }}>×¨×•×•×— × ×•×¡×£ ×××™××•×© ×‘×¤×•×¢×œ</div>
            <div style={{ fontSize: 30, fontWeight: 800, color: "#c4944a" }}>+{fm(r.fSaved + r.mSaved)} â‚ª</div>
            <div style={{ fontSize: 12, color: "#7a7a9a" }}>
              {r.fSaved + r.mSaved < r.hUnused
                ? `× ×™×ª×Ÿ ×œ×—×¡×•×š ×¢×•×“ ${fm(r.hUnused - r.fSaved - r.mSaved)} â‚ª ×¢×´×™ ××™××•×© ${fm(r.hOpt - cg)} â‚ª × ×•×¡×¤×™×`
                : "× ×™×¦×•×œ ××œ×•× ×”×–×™×›×•×™×™×! ğŸ¯"}
            </div>
          </div>
        </div>

        {/* DETAIL TABLE */}
        <button onClick={() => setDet(!det)} style={{ width: "100%", padding: "12px", borderRadius: 10, cursor: "pointer", fontSize: 13, background: "rgba(255,255,255,0.035)", border: "1px solid rgba(255,255,255,0.07)", color: "#a0a0b8", fontWeight: 600, marginBottom: 16 }}>
          {det ? "â–² ×”×¡×ª×¨" : "â–¼ ×”×¦×’"} ×˜×‘×œ×ª × ×§×•×“×•×ª ×–×™×›×•×™ ×œ×¤×™ ×’×™×œ (×¨×¤×•×¨××ª 2024)
        </button>
        {det && (
          <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.07)", padding: "18px", marginBottom: 16, overflowX: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: "1px solid rgba(255,255,255,0.15)" }}>
                  {["×’×™×œ", "××‘ ×‘×¡×™×¡", "×¨×¤×•×¨××”", "××‘ ×¡×”×´×›", "×× ×‘×¡×™×¡", "×¨×¤×•×¨××”", "×× ×¡×”×´×›"].map(h => (
                    <th key={h} style={{ padding: "8px 4px", textAlign: "center", color: "#a0a0b8", fontSize: 11 }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {[
                  ["×œ×™×“×”", 1.5, 1, 2.5, 1.5, 1, 2.5],
                  ["1-2", 2.5, 2, 4.5, 2.5, 2, 4.5],
                  ["3", 2.5, 1, 3.5, 2.5, 1, 3.5],
                  ["4-5", 2.5, 0, 2.5, 2.5, 0, 2.5],
                  ["6-17", 0, 0, 0, 1, 0, 1],
                  ["18", 0, 0, 0, 0.5, 0, 0.5],
                ].map(row => (
                  <tr key={row[0]} style={{ borderBottom: "1px solid rgba(255,255,255,0.05)" }}>
                    <td style={{ padding: "6px 4px", fontWeight: 600, textAlign: "center" }}>{row[0]}</td>
                    <td style={{ textAlign: "center", color: "#7ab8e0" }}>{row[1]}</td>
                    <td style={{ textAlign: "center", color: row[2] ? "#5ab85a" : "#4a4a5a" }}>{row[2] ? `+${row[2]}` : "\u2014"}</td>
                    <td style={{ textAlign: "center", color: "#7ab8e0", fontWeight: 700 }}>{row[3]}</td>
                    <td style={{ textAlign: "center", color: "#d898c8" }}>{row[4]}</td>
                    <td style={{ textAlign: "center", color: row[5] ? "#5ab85a" : "#4a4a5a" }}>{row[5] ? `+${row[5]}` : "\u2014"}</td>
                    <td style={{ textAlign: "center", color: "#d898c8", fontWeight: 700 }}>{row[6]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
            <p style={{ fontSize: 11, color: "#6a6a8a", marginTop: 10, marginBottom: 0 }}>
              * ×¢×“ ×’×™×œ 5 ×¡×”×´×› ×–×”×” ×œ×©× ×™ ×”×”×•×¨×™× (××¡×¢×™×¤×™× ×©×•× ×™×). ××’×™×œ 6 ×¨×§ ×”×× ××§×‘×œ×ª.
            </p>
          </div>
        )}

        {/* STEPS */}
        <div style={{ background: "rgba(255,255,255,0.035)", borderRadius: 14, border: "1px solid rgba(255,255,255,0.07)", padding: "18px", marginBottom: 16 }}>
          <h2 style={{ fontSize: 15, fontWeight: 700, color: "#c4944a", margin: "0 0 12px" }}>ğŸ—‚ï¸ ×¦×¢×“×™×</h2>
          {[
            ["1", "×”×’×©×ª ×‘×§×©×” ×œ××¢× ×§ ×¢×‘×•×“×”", "×©× ×™ ×‘× ×™ ×”×–×•×’ ×‘× ×¤×¨×“, ×œ×©× ×ª 2024 (×¢×“ 31.12.26) ×•-2025 (×¢×“ 31.12.27)"],
            ["2", "×‘×“×™×§×ª ×¨×•×•×—×™× ×¦×‘×•×¨×™×", "×‘×§×© ×˜×•×¤×¡ 867 ××”×‘× ×§/×‘×¨×•×§×¨"],
            ["3", `××™××•×© ×¢×“ ${fm(r.hOpt)} â‚ª`, "×œ×¤× ×™ 30.12 (××™×¨×•×¤×”) / 31.12 (××¨×”×´×‘) â€” ×§× ×” ××—×“×© ××™×“"],
            ["4", "×”×’×©×ª ×“×•×— ×©× ×ª×™", "×¢× ×¨×•×´×—, ×›×œ×•×œ 867 + ×›×œ ×”×”×›× ×¡×•×ª â†’ ×”×—×–×¨ ××¡"],
            ["5", "×¢×“×›×•×Ÿ ×˜×•×¤×¡ 101", "×¤×¨×˜×™ ×™×œ×“×™× + ×™×©×•×‘ ××–×›×”"],
          ].map(([n, t, d]) => (
            <div key={n} style={{ display: "flex", gap: 10, marginBottom: 10 }}>
              <div style={{ width: 24, height: 24, borderRadius: "50%", background: "#c4944a", color: "#1a1a2e", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 800, flexShrink: 0 }}>{n}</div>
              <div><div style={{ fontSize: 13, fontWeight: 700 }}>{t}</div><div style={{ fontSize: 11, color: "#7a7a9a" }}>{d}</div></div>
            </div>
          ))}
        </div>

        <div style={{ padding: "12px", borderRadius: 10, background: "rgba(200,140,80,0.05)", border: "1px solid rgba(200,140,80,0.12)", fontSize: 11, color: "#908070", lineHeight: 1.7 }}>
          <strong>âš ï¸</strong> ×¡×›×•××™ ×”××¢× ×§ ×”× ×”×¢×¨×›×”. ×”×›× ×¡×ª ×‘×Ÿ/×‘×ª ×”×–×•×’ ××©×¤×™×¢×” ×¢×œ ×”××¢× ×§. × ×§×•×“×•×ª ×”×–×™×›×•×™ ××“×•×™×§×•×ª ×œ×¤×™ ×¨×¤×•×¨××ª 2024.
          ××“×¨×’×•×ª ×”××¡ ×•×©×•×•×™ × ×§×•×“×ª ×–×™×›×•×™ ×¢×©×•×™×™× ×œ×”×©×ª× ×•×ª ××©× ×” ×œ×©× ×” â€” ×¢×“×›×Ÿ ×‘×”×ª××. ××™×Ÿ ×œ×¨××•×ª ×‘×–×” ×™×™×¢×•×¥ ××¡ â€” ×”×ª×™×™×¢×¦×• ×¢× ×¨×•×´×—.
        </div>
      </div>
    </div>
  );
}

// Render function that can be called after auth
window.__renderApp = () => {
  ReactDOM.render(<App />, document.getElementById('root'));
};

// Initial render (will show defaults until data loads)
window.__renderApp();
</script>
</body>
</html>
